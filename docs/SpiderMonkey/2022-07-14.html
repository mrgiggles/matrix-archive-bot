<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-07-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-07-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-07-12" class="nav-link"><span>prev</span></a>
<a href="2022-07-16" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Jul 14 2022 06:20:06 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: 1.8.5 uses the 1.7-era-style JS_AddRoot() API and post-dates the Tamarin-derived conservative collector</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jul 14 2022 06:20:34 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell">It does not have a moving GC, but it does have fatvals</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jul 14 2022 06:21:02 GMT-0700 (Pacific Daylight Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell">(note - going by memory but memory is pretty good, I released that version)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jul 14 2022 06:22:30 GMT-0700 (Pacific Daylight Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">dheitbrink</span>: exactly what do you mean by "the function gets undefined"?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jul 14 2022 06:24:56 GMT-0700 (Pacific Daylight Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">dheitbrink</span>: it sounds to me like you're doing something "bad" during finalization of one of your custom classes, and this is somehow mutating the symbol which is your function.  In a case like this, back when I was using 1.8.5 regularly, I would reach for valgrind after exhausting the debugger</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jul 14 2022 06:26:32 GMT-0700 (Pacific Daylight Time)">13:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">dheitbrink</span>: also, enable gc zeal = 2, get that collector busy, it will draw out your problems earlier.  Save to assume you have a root for your global object?  (I think cx-&gt;global is a root but it's been awhile)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jul 14 2022 06:32:42 GMT-0700 (Pacific Daylight Time)">13:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Are you able to explain "exact rooting" in a few words?  Reading bug 753203, it sounds like you guys just made every GCThing a root - but that doesn't make sense??</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jul 14 2022 06:32:44 GMT-0700 (Pacific Daylight Time)">13:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/753203">https://bugzil.la/753203</a> — RESOLVED (terrence) — [meta] GC: Exact Stack Rooting</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jul 14 2022 06:42:26 GMT-0700 (Pacific Daylight Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">wes</span>: Rooted is used for gc things on the stack that are live across a call that might GC</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jul 14 2022 06:43:38 GMT-0700 (Pacific Daylight Time)">13:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">see also the rooting guide <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr91/docs/GC%20Rooting%20Guide.md">here</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jul 14 2022 10:43:12 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">wes</span>: yeah, it's "exact" as opposed to "conservative". Rather than scanning the stack to find roots, we require the user to register all GC pointers on the stack with the GC, and then pass around pointers to those (possibly changing) pointers. The usual mechanism is the <code>Rooted&lt;T&gt;</code> template that can be used as a regular pointer but inserts itself into a linked list of roots in its constructor.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jul 14 2022 12:22:16 GMT-0700 (Pacific Daylight Time)">19:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@serg:mozilla.org">serg</span>&gt;</div></td><td class="msg-cell"><p>There was an <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1775759">intermittent bug</a> which we "fixed" by doing something that doesn't make sense to us.<br>It failed at this <a href="https://searchfox.org/mozilla-central/rev/a8bd595d93203a7e836f4160a458c976b1232143/browser/components/aboutlogins/tests/browser/browser_sessionRestore.js#12-15">piece of code</a> with error message</p>
<blockquote>
<p>TypeError: can't access property "length", loginList._loginGuidsSortedOrder is undefined</p>
</blockquote>
<p>but the only times _loginGuidsSortedOrder was undefined is inside constructor <a href="https://searchfox.org/mozilla-central/rev/ea0c957e8d91b9c934125926e681df903c4b33de/browser/components/aboutlogins/content/components/login-list.mjs#102">prior to call to super()</a> . All other references was either reading this property or assigning a non-empty value to it.</p>
<pre><code>constructor() {
    super();
    // An array of login GUIDs, stored in sorted order.
    this._loginGuidsSortedOrder = [];
</code></pre>
<p>because constructor is not done yet, we do not expect an object to be available anywhere. So nothing should be able to call .addEventListener() on it and execute something before it's initialized.</p>
<p>Can anyone help us figure out what was going on there?</p>
</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jul 14 2022 13:01:08 GMT-0700 (Pacific Daylight Time)">20:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span> &amp; <span class="nick-12">sfink</span>: Thanks! That makes perfect sense.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jul 14 2022 13:21:17 GMT-0700 (Pacific Daylight Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-11">serg</span>: that certainly seems strange, particularly since your fix doesn't really shuffle a lot around. The field you added is still executed from your constructor right after the super call and isn't really any sooner than the "before" code</p>
<pre><code class="language-js">            class Base
            {
                field = console.log("Base.field");

                constructor() {
                    console.log("Base.constructor");
                }
            }

            class Derive extends Base
            {
                field = console.log("Derive.field");

                constructor() {
                    console.log("Derive.constructorPre");
                    super();
                    console.log("Derive.constructorPost");
                }
            }

            new Derive;
</code></pre>
<pre><code>Derive.constructorPre
Base.field
Base.constructor
Derive.field
Derive.constructorPost
</code></pre>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jul 14 2022 13:27:15 GMT-0700 (Pacific Daylight Time)">20:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@serg:mozilla.org">serg</span>&gt;</div></td><td class="msg-cell">That's what puzzles me. We do not understand why it was intermittently failing, why fix helped.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jul 14 2022 13:32:10 GMT-0700 (Pacific Daylight Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@serg:mozilla.org">serg</span>&gt;</div></td><td class="msg-cell"><p>Perhaps fix was because of the last 2 changed lines - we waited for the browser to finish loading before accessing that object.</p>
<p>But we do not understand how we could access <code>loginList</code> with uninitialized <code>_loginGuidsSortedOrder</code> property.</p>
</td></tr>

</tbody></table></div></div></div>
</body></html>