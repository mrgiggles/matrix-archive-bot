<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-12-10</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-12-10<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-12-09" class="nav-link"><span>prev</span></a>
<a href="2024-12-11" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Dec 09 2024 16:41:10 GMT-0800 (Pacific Standard Time)">00:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://phabricator.services.mozilla.com/D230951#inline-1287192">I was X years old when I learned</a> about atomics.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Dec 09 2024 20:50:26 GMT-0800 (Pacific Standard Time)">04:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@pbone:mozilla.org">pbone (he/him)</span>&gt;</div></td><td class="msg-cell">it could be made easier to understand for code readers by using a function name rather than an overloaded operator.  I didn't know about this before either.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Dec 09 2024 20:51:05 GMT-0800 (Pacific Standard Time)">04:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, it's kind of weird that it changes the semantics of an existing operator</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Dec 10 2024 05:12:38 GMT-0800 (Pacific Standard Time)">13:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Yeah this is fairly surprising, but it is useful in this case. </td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Dec 10 2024 08:04:11 GMT-0800 (Pacific Standard Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">.... it's early morning and I'm slow... but doesn't that match the semantics of the regular operator? <a href="https://godbolt.org/z/WGrh14nYv">https://godbolt.org/z/WGrh14nYv</a> </td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Dec 10 2024 08:04:34 GMT-0800 (Pacific Standard Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(more specifically, I don't really see how it's returning the before value) </td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Dec 10 2024 08:20:15 GMT-0800 (Pacific Standard Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">I agree that it doesn't look like it's returning the before value</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Dec 10 2024 08:21:13 GMT-0800 (Pacific Standard Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">In the patch it's using mozilla::Atomic, not std::atomic, but the behavior is the same: <a href="https://searchfox.org/mozilla-central/rev/5b93d2870ab36ba9cfa144fa7518d54e5439caa9/mfbt/Atomics.h#407">https://searchfox.org/mozilla-central/rev/5b93d2870ab36ba9cfa144fa7518d54e5439caa9/mfbt/Atomics.h#407</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Dec 10 2024 09:34:58 GMT-0800 (Pacific Standard Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">oh, looks like operator|= does return the final value after all</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Dec 10 2024 09:35:10 GMT-0800 (Pacific Standard Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I must say that makes more sense that it would be defined that way</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Dec 10 2024 10:50:23 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, it seems like <code>operator|=</code> returns the new value, and you have to explicitly use <code>fetch_or</code> to get the old: <a href="https://godbolt.org/z/Ex13YK8P8">https://godbolt.org/z/Ex13YK8P8</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Dec 10 2024 10:50:32 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, my world has shifted back into focus now</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Dec 10 2024 10:54:12 GMT-0800 (Pacific Standard Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Thanks for all your review comments. I'll update the patches for the ones I've done so far which is about 2/3 of them.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Dec 10 2024 10:56:22 GMT-0800 (Pacific Standard Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">implementing that stuff was a big chunk of work</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Dec 10 2024 10:56:43 GMT-0800 (Pacific Standard Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">congrats, you've now written a general-purpose allocator üòÅ</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Dec 10 2024 12:32:22 GMT-0800 (Pacific Standard Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: to implement <a href="https://wicg.github.io/scheduling-apis/#sec-patches-html-hostcalljobcallback">https://wicg.github.io/scheduling-apis/#sec-patches-html-hostcalljobcallback</a>, is it <code>FinalizationRegistryCleanup::QueueCallback</code> and <code>CycleCollectedJSContext::enqueuePromiseJob</code>?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Dec 10 2024 12:33:56 GMT-0800 (Pacific Standard Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">basically I need to set <code>event loop</code>‚Äôs <code>current scheduling state</code>, can I do it at the same location as <code>INCUMBENT_SETTING_SLOT</code>.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Dec 10 2024 12:38:31 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>HostCallJobCallback is performed in the following:</p>
<ul>
<li><a href="https://tc39.es/ecma262/#sec-cleanup-finalization-registry">CleanupFinalizationRegistry</a> step 3.c, where CleanupFinalizationRegistry is performed in <a href="https://tc39.es/ecma262/#sec-host-cleanup-finalization-registry">HostEnqueueFinalizationRegistryCleanupJob</a> cleanupJob's step 1, which is Job Abstract Closure</li>
<li><a href="https://tc39.es/ecma262/#sec-newpromisereactionjob">NewPromiseReactionJob</a> step 1.e.i, which is a part of Job Abstract Closure</li>
<li><a href="https://tc39.es/ecma262/#sec-newpromiseresolvethenablejob">NewPromiseResolveThenableJob</a> step 1.b, which is also a part of Job Abstract Closure</li>
</ul>
</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Dec 10 2024 12:38:50 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">The job abstract closure the body of the function called by the job queue</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Dec 10 2024 12:40:01 GMT-0800 (Pacific Standard Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>FinalizationRegistryCleanup::QueueCallback</code> and <code>CycleCollectedJSContext::enqueuePromiseJob</code> are for the steps that enqueues jobs and callbacks, which is different step than actually calling the job, which happens later.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Dec 10 2024 12:41:01 GMT-0800 (Pacific Standard Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">The actual promise job call is happening in <a href="https://searchfox.org/mozilla-central/rev/9783996dbd86f999cab50ea426079a7b10f28a2f/xpcom/base/CycleCollectedJSContext.cpp#209">mozilla::PromiseJobRunnable::Run</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Dec 10 2024 12:42:11 GMT-0800 (Pacific Standard Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and I suppose it needs a kind of reordering</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Dec 10 2024 12:44:48 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there are 2 things "called", one is the job and the other one is the handler</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Dec 10 2024 12:46:28 GMT-0800 (Pacific Standard Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">iiuc, what the gecko side calls is the job.  and SpiderMonkey internally calls the handler in <a href="https://searchfox.org/mozilla-central/rev/9783996dbd86f999cab50ea426079a7b10f28a2f/js/src/builtin/Promise.cpp#2249-2258">PromiseReactionJob</a></td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Dec 10 2024 12:47:06 GMT-0800 (Pacific Standard Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but the <code>HostCallJobCallback</code> isn't actually performed in the latter</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Dec 10 2024 12:48:11 GMT-0800 (Pacific Standard Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">so I can only care about <code>PromiseJobRunnable::Run</code>, that should be enough?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Dec 10 2024 12:48:51 GMT-0800 (Pacific Standard Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I guess you first need to see the additional steps there fits the gecko's callback handling</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Dec 10 2024 12:49:19 GMT-0800 (Pacific Standard Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(just to make sure, I'm talking about promise case just as an example. I'm not checking the finalization callback case)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Dec 10 2024 12:50:42 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">sorry..what additional steps? in the spec?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Dec 10 2024 12:50:43 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I suppose the callback handling that I mean is somewhere in <a href="https://searchfox.org/mozilla-central/rev/9783996dbd86f999cab50ea426079a7b10f28a2f/dom/bindings/CallbackObject.cpp">CallbackObject.cpp</a></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Dec 10 2024 12:51:06 GMT-0800 (Pacific Standard Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the additional steps I mean is things added by <a href="https://wicg.github.io/scheduling-apis/#sec-patches-html-hostcalljobcallback">https://wicg.github.io/scheduling-apis/#sec-patches-html-hostcalljobcallback</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Dec 10 2024 12:52:04 GMT-0800 (Pacific Standard Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">oh I see, so I should see if I can just do it on the gecko side? </td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Dec 10 2024 12:52:39 GMT-0800 (Pacific Standard Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, and if it doesn't fit, then we'll need to refactor <code>HostCallJobCallback</code> implementation</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Dec 10 2024 12:54:32 GMT-0800 (Pacific Standard Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">okay, I'll look into it, thanks! </td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Dec 10 2024 12:57:15 GMT-0800 (Pacific Standard Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>Here's my understanding of what the spec says:</p>
<ul>
<li>a. JobQueue calls the job</li>
<li>b. the job performs some steps 1</li>
<li>c. the job performs HostCallJobCallback</li>
<li>d. HostCallJobCallback performs some steps 1</li>
<li>e. call the handler</li>
<li>f. HostCallJobCallback performs some steps 2</li>
<li>g. the job performs some steps 2</li>
</ul>
</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Dec 10 2024 12:57:23 GMT-0800 (Pacific Standard Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but we do a-d-b-e-g-f</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Dec 10 2024 12:59:58 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: <span class="nick-4">jonco</span> <a href="https://share.firefox.dev/4gsSSXx">https://share.firefox.dev/4gsSSXx</a> looks like surprising. Look at the number of minorGCs. That is from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1898545#c8">https://bugzilla.mozilla.org/show_bug.cgi?id=1898545#c8</a></td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Dec 10 2024 13:45:12 GMT-0800 (Pacific Standard Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">That's interesting. The nursery size is miniscule, between 256KB and 640KB for the most part, and usually 256KB. But given that the promotion rate is very close to 0%, that actually seems fine. It's a large number of minor GCs, but each one only takes 20-40 microseconds and discards between 99%-100% of the data.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Dec 10 2024 13:46:14 GMT-0800 (Pacific Standard Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">unless there's some reason to believe that each minor GC is incurring problematic overhead, it does not seem responsible for much of the time here.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Dec 10 2024 13:48:12 GMT-0800 (Pacific Standard Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">then again, we're spending 11.8x the time in minor GC as Chrome does, so perhaps there is evidence after all</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Dec 10 2024 13:48:32 GMT-0800 (Pacific Standard Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm, is there some way to compare cumulative allocations, or allocation rates?</td></tr>

</tbody></table></div></div></div>
</body></html>