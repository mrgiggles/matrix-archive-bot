<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-08-25</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-08-25<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-08-24" class="nav-link"><span>prev</span></a>
<a href="2022-08-26" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Aug 25 2022 07:16:35 GMT-0700 (Pacific Daylight Time)">14:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">for <code>static bool BindableFunc(JSContext* cx, unsigned argc, JS::Value* vp) {</code><br>How do you construct an args array? Could I just pass a <code>JS::RootedVector&lt;JS::Value&gt;</code>?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Aug 25 2022 07:17:27 GMT-0700 (Pacific Daylight Time)">14:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">do you mean you want to call the function directly from C++ ?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Aug 25 2022 07:17:44 GMT-0700 (Pacific Daylight Time)">14:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(without going through JS API?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Aug 25 2022 07:19:02 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">yeah, just want to pass a <code>null, "functionName"</code> as vp in BindableFunc from C++</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Aug 25 2022 07:19:16 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the parameter array there expects some specific layout for input and output, and I think it's better avoid doing that manually unless that's really necessary</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Aug 25 2022 07:19:24 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, usually, it's better having 2 functions</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Aug 25 2022 07:19:47 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">one with <code>(JSContext* cx, unsigned argc, JS::Value* vp)</code> parameters, for providing to JSAPI</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Aug 25 2022 07:20:16 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">i wanted to avoid code duplication for some illustrative examples, but it doesn't matter I suppose</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Aug 25 2022 07:20:19 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and other receives each actual parameter separately, and call it from <code>(JSContext* cx, unsigned argc, JS::Value* vp)</code>-variant and anywhere you want to call directly</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Aug 25 2022 07:20:26 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, no code duplication</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Aug 25 2022 07:20:33 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">just add a wrapper for JSAPI</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Aug 25 2022 07:20:52 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">let me look for example</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Aug 25 2022 07:22:10 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">here <a href="https://searchfox.org/mozilla-central/rev/30ac44262374be08ccd4262ee36f0716152868d3/js/src/builtin/String.cpp#1614-1666">js::str_charCodeAt_impl</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Aug 25 2022 07:22:20 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>str_charCodeAt</code> is the function that's callable from JSAPI</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Aug 25 2022 07:22:26 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that follows the calling convension</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Aug 25 2022 07:22:41 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and <code>str_charCodeAt_impl</code> is the implementation</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Aug 25 2022 07:23:12 GMT-0700 (Pacific Daylight Time)">14:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(you can ignore the most part of <code>str_charCodeAt</code>'s special handling,</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Aug 25 2022 07:24:04 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">anyway, <code>str_charCodeAt</code> receives the parameter as <code>argc+vp</code>, and convert it to <code>CallArgs</code>, and extract each parameter from it, and call <code>str_charCodeAt_impl</code></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Aug 25 2022 07:24:50 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>str_charCodeAt_impl</code> receives each parameter separately, with more specialized types, and performs the actual operation, and returns the value as out-parameter</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Aug 25 2022 07:25:54 GMT-0700 (Pacific Daylight Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if you want to call the function from C++, you can call <code>str_charCodeAt_impl</code>, passing each parameter separately</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Aug 25 2022 07:27:26 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">i'm confused, I just wanted to construct a <code>vp</code> manually to pass <code>null</code> and <code>"myString"</code></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Aug 25 2022 07:28:24 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">ah it doesn't matter, i'll just code duplicate for now to use the same code logic from the <code>BindableFunc</code></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Aug 25 2022 07:28:36 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">don't try to construct <code>vp</code> manually</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Aug 25 2022 07:28:58 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">yeah, i'll avoid it. thank you for the help</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Aug 25 2022 07:30:52 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what you need is to move the actual operation of <code>BindableFunc</code> into separate function, and let it receive the actual parameters, and call it from <code>BindableFunc</code>, and anywhere you want to call the function directly from C++</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Aug 25 2022 07:31:14 GMT-0700 (Pacific Daylight Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">yeah i see what you're saying, use a helper free function. I wasn't sure what you meant until now</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Aug 25 2022 12:23:33 GMT-0700 (Pacific Daylight Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Hi folks, is it appropriate to ask here about GNOME's gjs that is based on spidermonkey? I don't think my questions are necessarily specific to GJS but to spidermonkey. Though GJS does wrap spidermonkey and that may be relevant.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Aug 25 2022 12:23:39 GMT-0700 (Pacific Daylight Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I'd like to do something a bit funky;</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Aug 25 2022 12:23:59 GMT-0700 (Pacific Daylight Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I want to attach to gnome-shell with gdb, and then dispatch some javascript code to the js engine, and since I'm not familiar with js engine internals, I hope it's not that hard, and I'd like some help with this.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Aug 25 2022 12:24:56 GMT-0700 (Pacific Daylight Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">The normal way to call gjs is described here: <a href="http://helgo.net/simon/introspection-tutorial/stepthree.xhtml">http://helgo.net/simon/introspection-tutorial/stepthree.xhtml</a></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Aug 25 2022 12:25:14 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">It seems to be two function invocations; one to get a context, and another that you pass your code to.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Aug 25 2022 12:26:01 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I'm somewhat familiar with low level things like this, but not very  - I don't know if there will be reentrancy issues, or if there is a thread safe way to just queue up some js code to run.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Aug 25 2022 12:26:22 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">this is probably not the place where you'll get the most help with GJS's API, but I can answer that</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Aug 25 2022 12:26:47 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Thanks! Ideally I want to do the minimum amount of work to just flip a single boolean in this case.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Aug 25 2022 12:27:33 GMT-0700 (Pacific Daylight Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">It may be sufficient to actually do something with the GObject introspection API in that case, but thats an alternative path that I havent looked too deeply into yet.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Aug 25 2022 12:27:50 GMT-0700 (Pacific Daylight Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">If it's not hard to inject JS, than this approach would be a lot more flexible.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Aug 25 2022 12:30:29 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">nobody has tried this that I know of, but I'd guess that <code>call gjs_context_eval(gjs_context_get_current(), "myBoolean = true;", -1, "&lt;injected&gt;", NULL, NULL)</code> might work</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Aug 25 2022 12:30:52 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Haha yeah I mean it's normally a weird thing to do with modern systems.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Aug 25 2022 12:31:46 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">(not sure about old systems, but something something lisp)</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Aug 25 2022 12:31:58 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">What I'm actually trying to work around it this <a href="https://askubuntu.com/questions/1412130/dbus-calls-to-gnome-shell-dont-work-under-ubuntu-22-04">https://askubuntu.com/questions/1412130/dbus-calls-to-gnome-shell-dont-work-under-ubuntu-22-04</a></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Aug 25 2022 12:32:19 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I want to toggle that <code>global.context.unsafe_mode</code>  mode variable.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Aug 25 2022 12:32:29 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">After that I can pass code to their Eval thing over dbus</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Aug 25 2022 12:33:02 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">It seems kind of dumb to do this given that the security context doesn't change but idk. Maybe it's designed for systems where you cant ptrace your own processes? :P</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Aug 25 2022 12:33:15 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">(I just find it frustrating)</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Aug 25 2022 12:33:37 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> nobody has tried this that I know of, but I'd guess that <code>call gjs_context_eval(gjs_context_get_current(), "myBoolean = true;", -1, "&lt;injected&gt;", NULL, NULL)</code> might work</blockquote></mx-reply>Do I need to worry about calling this on the right thread or something?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Aug 25 2022 12:33:54 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Aug 25 2022 12:34:03 GMT-0700 (Pacific Daylight Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (I just find it frustrating)</blockquote></mx-reply>There doesnt seem to be any way to talk to gnome-shell over the cli anymore.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Aug 25 2022 12:34:21 GMT-0700 (Pacific Daylight Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Do I need to worry about calling this on the right thread or something?</blockquote></mx-reply>You have to tell me about these things :) I'm not /that/ good.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Aug 25 2022 12:34:46 GMT-0700 (Pacific Daylight Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><p>This is what I can see:</p>
<pre><code>(gdb) i th
  Id   Target Id                                             Frame 
* 1    Thread 0x7fe90452c2c0 (LWP 3671771) ".gnome-shell-wr" 0x00007fe90bd71c89 in __GI___poll (fds=0x5f42d40, nfds=14, timeout=15552) at ../sysdeps/unix/sysv/linux/poll.c:29
  2    Thread 0x7fe904528640 (LWP 3671794) "gmain"           0x00007fe90bd71c89 in __GI___poll (fds=0x1a93bc0, nfds=2, timeout=3996) at ../sysdeps/unix/sysv/linux/poll.c:29
  3    Thread 0x7fe903cde640 (LWP 3671795) "dconf worker"    0x00007fe90bd71c89 in __GI___poll (fds=0x1b699b0, nfds=1, timeout=-1) at ../sysdeps/unix/sysv/linux/poll.c:29
  4    Thread 0x7fe903431640 (LWP 3671796) "gdbus"           0x00007fe90bd71c89 in __GI___poll (fds=0x7fe8e80122b0, nfds=3, timeout=-1) at ../sysdeps/unix/sysv/linux/poll.c:29
  5    Thread 0x7fe901278640 (LWP 3671802) "gnome-s:disk$0"  0x00007fe90b245cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0x1af0898, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, 
    private=private@entry=0, cancel=cancel@entry=true) at ../sysdeps/nptl/futex-internal.c:74
  6    Thread 0x7fe900a77640 (LWP 3671803) "gnome-shel:sh0"  0x00007fe90b245cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0x1c18e08, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, 
    private=private@entry=0, cancel=cancel@entry=true) at ../sysdeps/nptl/futex-internal.c:74
  7    Thread 0x7fe8ece05640 (LWP 3671804) "gnome-shel:sh1"  0x00007fe90b245cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0x1c18e08, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, 
    private=private@entry=0, cancel=cancel@entry=true) at ../sysdeps/nptl/futex-internal.c:74
  8    Thread 0x7fe8d159b640 (LWP 3671805) "gnome-shel:sh2"  0x00007fe90b245cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0x1c18e08, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, 
    private=private@entry=0, cancel=cancel@entry=true) at ../sysdeps/nptl/futex-internal.c:74
  9    Thread 0x7fe8d0d9a640 (LWP 3671808) "gnome-sh:gdrv0"  0x00007fe90b245cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0x1c73458, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, 
    private=private@entry=0, cancel=cancel@entry=true) at ../sysdeps/nptl/futex-internal.c:74
  10   Thread 0x7fe8ec204640 (LWP 3671826) "JS Helper"       0x00007fe90b245cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0x1ab5fb8, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, 
    private=private@entry=0, cancel=cancel@entry=true) at ../sysdeps/nptl/futex-internal.c:74
  11   Thread 0x7fe8d0319640 (LWP 3671827) "JS Helper"       0x00007fe90b245cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0x1ab5fb8, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, 
    private=private@entry=0, cancel=cancel@entry=true) at ../sysdeps/nptl/futex-internal.c:74
  12   Thread 0x7fe8bb7fe640 (LWP 3671828) "JS Helper"       0x00007fe90b245cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0x1ab5fb8, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, 
    private=private@entry=0, cancel=cancel@entry=true) at ../sysdeps/nptl/futex-internal.c:74
  13   Thread 0x7fe8bb5ff640 (LWP 3671829) "JS Helper"       0x00007fe90b245cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0x1ab5fb8, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, 
    private=private@entry=0, cancel=cancel@entry=true) at ../sysdeps/nptl/futex-internal.c:74

</code></pre>
</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Aug 25 2022 12:36:15 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">it's probably "gmain", but it's hard to tell from that output</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Aug 25 2022 12:36:33 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Is there any info I can get that will help?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Aug 25 2022 12:36:46 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I don't have debug symbols but I will see if I can get some backtraces.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Aug 25 2022 12:39:21 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><pre><code>(gdb) thr 10                                                                                                                                                                                                                                  
[Switching to thread 10 (Thread 0x7f54a4319640 (LWP 3745835))]                                                                                                                                                                                                  
(gdb) bt                                                                                                               
#0  0x00007f54e4024cf5 in __futex_abstimed_wait_common64 (futex_word=futex_word@entry=0xc46fbc, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, private=private@entry=0, cancel=cancel@entry=true)
    at ../sysdeps/nptl/futex-internal.c:74
#1  0x00007f54e4024d4b in __GI___futex_abstimed_wait_cancelable64 (futex_word=futex_word@entry=0xc46fbc, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, private=private@entry=0)
    at ../sysdeps/nptl/futex-internal.c:123                                                                                                                                                                                                   
#2  0x00007f54e401ec22 in __pthread_cond_wait_common (abstime=0x0, clockid=0, mutex=0xc46f38, cond=0xc46f90) at pthread_cond_wait.c:504
#3  __pthread_cond_wait (cond=0xc46f90, mutex=0xc46f38) at pthread_cond_wait.c:619
#4  0x00007f54e36c5f27 in mozilla::detail::ConditionVariableImpl::wait(mozilla::detail::MutexImpl&amp;) () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so
#5  0x00007f54e36c6108 in mozilla::detail::ConditionVariableImpl::wait_for(mozilla::detail::MutexImpl&amp;, mozilla::BaseTimeDuration&lt;mozilla::TimeDurationValueCalculator&gt; const&amp;) ()                                               
   from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so
#6  0x00007f54e2f40495 in js::HelperThread::threadLoop() () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so                                                            
#7  0x00007f54e2f40534 in js::HelperThread::ThreadMain(void*) () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so
#8  0x00007f54e2f3c055 in js::detail::ThreadTrampoline&lt;void (&amp;)(void*), js::HelperThread*&gt;::Start(void*) () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so
#9  0x00007f54e4018d40 in start_thread (arg=0x7f54a4319640) at pthread_create.c:481
#10 0x00007f54e4b5c03f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95
</code></pre>
</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Aug 25 2022 12:39:55 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><pre><code>(gdb) thr 2                                                                                                            
[Switching to thread 2 (Thread 0x7f54dd307640 (LWP 3745803))]                                                                                           
(gdb) bt                                                                                                                                                                                                                                      
#0  0x00007f54e4b50c89 in __GI___poll (fds=0xc24bc0, nfds=2, timeout=3996) at ../sysdeps/unix/sysv/linux/poll.c:29
#1  0x00007f54e5966d4e in g_main_context_poll (priority=&lt;optimized out&gt;, n_fds=2, fds=0xc24bc0, timeout=&lt;optimized out&gt;, context=0xc4f710) at ../glib/gmain.c:4478
#2  g_main_context_iterate (context=context@entry=0xc4f710, block=block@entry=1, dispatch=dispatch@entry=1, self=&lt;optimized out&gt;) at ../glib/gmain.c:4170
#3  0x00007f54e5966e6f in g_main_context_iteration (context=0xc4f710, may_block=may_block@entry=1) at ../glib/gmain.c:4240                                                                                                       
#4  0x00007f54e5966ec1 in glib_worker_main (data=&lt;optimized out&gt;) at ../glib/gmain.c:6140
#5  0x00007f54e5990e0d in g_thread_proxy (data=0xc35f60) at ../glib/gthread.c:827                                                                                                                                                             
#6  0x00007f54e4018d40 in start_thread (arg=0x7f54dd307640) at pthread_create.c:481
#7  0x00007f54e4b5c03f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95     
</code></pre>
</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Aug 25 2022 12:39:55 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">well it's definitely not any of the ones labeled "JS Helper", those are created by spidermonkey</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Aug 25 2022 12:40:02 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Ah ok</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Aug 25 2022 12:40:33 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">I mean it's likely just easier to try the "gmain" thread and see what happens 🤷</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Aug 25 2022 12:41:00 GMT-0700 (Pacific Daylight Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Ok, I think when I was on thread 1 I crashed it, but I don't know if thats an issue with what I was trying to call, or with the call method to start with</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Aug 25 2022 12:41:24 GMT-0700 (Pacific Daylight Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">#gnome-shell:<a href="http://gnome.org">gnome.org</a> would be a good place to get more info on what the threads are for</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Aug 25 2022 12:42:15 GMT-0700 (Pacific Daylight Time)">19:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">it's either 1 or 2 and so if 1 didn't work, I'd guess 2</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Aug 25 2022 12:43:56 GMT-0700 (Pacific Daylight Time)">19:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><pre><code>(gdb) call (void*)gjs_context_eval((void*)gjs_context_get_current(), "global.context.unsafe_mode = true", -1, "&lt;injected&gt;", 0, 0)

Thread 2 "gmain" received signal SIGSEGV, Segmentation fault.
0x00007ff43bcc4bc3 in js::AutoClearTypeInferenceStateOnOOM::AutoClearTypeInferenceStateOnOOM(JS::Zone*) [clone .cold] () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so
The program being debugged was signaled while in a function called from GDB.
GDB remains in the frame where the signal was received.
To change this behavior use "set unwindonsignal on".
Evaluation of the expression containing the function
(gjs_context_eval) will be abandoned.
When the function is done executing, GDB will silently stop.

</code></pre>
</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Aug 25 2022 12:44:30 GMT-0700 (Pacific Daylight Time)">19:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I don't know if those void* casts are safe, I did it because it was complaining about not knowing return types (no debug symbols).</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Aug 25 2022 12:45:00 GMT-0700 (Pacific Daylight Time)">19:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">those should be no problem</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Aug 25 2022 12:46:10 GMT-0700 (Pacific Daylight Time)">19:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">yeah, no guarantees that this will work in the first place</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Aug 25 2022 12:46:31 GMT-0700 (Pacific Daylight Time)">19:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">It might need some massaging, problem is I'm not sure what I need to massage.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Aug 25 2022 12:46:51 GMT-0700 (Pacific Daylight Time)">19:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Can I start a new ("clean") thread and dispatch via a thread safe api or something?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Aug 25 2022 12:47:44 GMT-0700 (Pacific Daylight Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Not sure about the terminology but I imagine if we use it like this we are expecting something that is reentrant.</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Aug 25 2022 12:50:23 GMT-0700 (Pacific Daylight Time)">19:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">*we expect to be running is code that is reentrant</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Aug 25 2022 12:50:48 GMT-0700 (Pacific Daylight Time)">19:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">If the symols are accessible and it makes sense we could also call some spidermonkey api directly.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Aug 25 2022 12:51:14 GMT-0700 (Pacific Daylight Time)">19:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">no, there isn't an API that lets you mess with JSContext from an arbitrary thread</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Aug 25 2022 12:51:51 GMT-0700 (Pacific Daylight Time)">19:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">you could call JS::Evaluate directly, but it'll be much harder to set up from a GDB prompt</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Aug 25 2022 12:52:05 GMT-0700 (Pacific Daylight Time)">19:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">that's why I suggested <code>gjs_context_eval</code></td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Aug 25 2022 12:52:40 GMT-0700 (Pacific Daylight Time)">19:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">gjs_context_new seems to be just doing some gobject magic
<a href="https://gitlab.gnome.org/GNOME/gjs/-/blob/master/gjs/context.cpp#L818">https://gitlab.gnome.org/GNOME/gjs/-/blob/master/gjs/context.cpp#L818</a>
<a href="https://gitlab.gnome.org/GNOME/gjs/-/blob/master/gjs/context.h#L40">https://gitlab.gnome.org/GNOME/gjs/-/blob/master/gjs/context.h#L40</a></td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Aug 25 2022 12:54:17 GMT-0700 (Pacific Daylight Time)">19:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Err no I think I totally misread that.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Aug 25 2022 13:16:15 GMT-0700 (Pacific Daylight Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">gjs_context_new is not what you want; it'll create a new JSContext which won't even have this variable that you want to manipulate</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Aug 25 2022 13:17:04 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">yeah Im slowly learning stuff, I just figured that out while typing this;</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Aug 25 2022 13:18:44 GMT-0700 (Pacific Daylight Time)">20:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><p>Ok so getting the current context does work</p>
<pre><code>(gdb) call (void*)gjs_context_get_current()
[Thread 0x7f133a814640 (LWP 3802134) exited]
$2 = (void *) 0x14fc1f0
</code></pre>
<p>but creating a new one does not (not sure if this is something I should do, i just noticed above that you get the current context instead of a new one)</p>
<pre><code>(gdb) call (void*)gjs_context_new()
[New Thread 0x7f133a814640 (LWP 3807920)]

Thread 2 "gmain" received signal SIGABRT, Aborted.
__GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:49
49      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.
The program being debugged was signaled while in a function called from GDB.
GDB remains in the frame where the signal was received.

To change this behavior use "set unwindonsignal on".
Evaluation of the expression containing the function
(gjs_context_new) will be abandoned.
When the function is done executing, GDB will silently stop.
(gdb) bt
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:49
#1  0x00007f13b2c36533 in __GI_abort () at abort.c:79
#2  0x00007f13b3ae0ddc in g_assertion_message (domain=&lt;optimized out&gt;, file=0x7f13b322eef4 "../gjs/context.cpp", line=&lt;optimized out&gt;, func=&lt;optimized out&gt;, message=&lt;optimized out&gt;) at ../glib/gtestutils.c:3223
#3  0x00007f13b3b3ff3b in g_assertion_message_expr (domain=0x7f13b32240cb "Gjs", file=0x7f13b322eef4 "../gjs/context.cpp", line=1566, func=0x7f13b322f668 "void gjs_context_make_current(GjsContext*)", expr=&lt;optimized out&gt;)
    at ../glib/gtestutils.c:3249
#4  0x00007f13b31e783e in gjs_context_init(_GjsContext*) () from /nix/store/m9y268hk5l5gsla39w8n26sv6kjlb60n-gjs-1.70.1/lib/libgjs.so.0
#5  0x00007f13b3c2e61a in g_type_create_instance (type=&lt;optimized out&gt;) at ../gobject/gtype.c:1929
#6  0x00007f13b3c14ca5 in g_object_new_internal (class=class@entry=0x14fb6e0, params=params@entry=0x0, n_params=n_params@entry=0) at ../gobject/gobject.c:1939
#7  0x00007f13b3c1622d in g_object_new_with_properties (object_type=22001136, n_properties=0, names=names@entry=0x0, values=values@entry=0x0) at ../gobject/gobject.c:2108
#8  0x00007f13b3c16be1 in g_object_new (object_type=&lt;optimized out&gt;, first_property_name=&lt;optimized out&gt;) at ../gobject/gobject.c:1779
#9  &lt;function called from gdb&gt;
#10 0x00007f13b2d00c89 in __GI___poll (fds=0x123ebc0, nfds=2, timeout=3872) at ../sysdeps/unix/sysv/linux/poll.c:29
#11 0x00007f13b3b16d4e in g_main_context_poll (priority=&lt;optimized out&gt;, n_fds=2, fds=0x123ebc0, timeout=&lt;optimized out&gt;, context=0x1269710) at ../glib/gmain.c:4478
#12 g_main_context_iterate (context=context@entry=0x1269710, block=block@entry=1, dispatch=dispatch@entry=1, self=&lt;optimized out&gt;) at ../glib/gmain.c:4170
#13 0x00007f13b3b16e6f in g_main_context_iteration (context=0x1269710, may_block=may_block@entry=1) at ../glib/gmain.c:4240
#14 0x00007f13b3b16ec1 in glib_worker_main (data=&lt;optimized out&gt;) at ../glib/gmain.c:6140
#15 0x00007f13b3b40e0d in g_thread_proxy (data=0x124ff60) at ../glib/gthread.c:827
#16 0x00007f13b21c8d40 in start_thread (arg=0x7f13ab4b7640) at pthread_create.c:481
#17 0x00007f13b2d0c03f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95

(gdb) fr 4
#4  0x00007f13b31e783e in gjs_context_init(_GjsContext*) () from /nix/store/m9y268hk5l5gsla39w8n26sv6kjlb60n-gjs-1.70.1/lib/libgjs.so.0
(gdb) disas
Dump of assembler code for function _ZL16gjs_context_initP11_GjsContext:
   0x00007f13b31e7800 &lt;+0&gt;:     push   %rbx
   0x00007f13b31e7801 &lt;+1&gt;:     mov    %rdi,%rbx
   0x00007f13b31e7804 &lt;+4&gt;:     call   0x7f13b3222ea0 &lt;_Z12gjs_log_initv&gt;
   0x00007f13b31e7809 &lt;+9&gt;:     test   %rbx,%rbx
   0x00007f13b31e780c &lt;+12&gt;:    je     0x7f13b31e7840 &lt;_ZL16gjs_context_initP11_GjsContext+64&gt;
   0x00007f13b31e780e &lt;+14&gt;:    cmpq   $0x0,0xbe3d2(%rip)        # 0x7f13b32a5be8 &lt;_ZL15current_context&gt;
   0x00007f13b31e7816 &lt;+22&gt;:    je     0x7f13b31e7840 &lt;_ZL16gjs_context_initP11_GjsContext+64&gt;
   0x00007f13b31e7818 &lt;+24&gt;:    lea    0x47e19(%rip),%r8        # 0x7f13b322f638
   0x00007f13b31e781f &lt;+31&gt;:    lea    0x47e42(%rip),%rcx        # 0x7f13b322f668
   0x00007f13b31e7826 &lt;+38&gt;:    mov    $0x61e,%edx
   0x00007f13b31e782b &lt;+43&gt;:    lea    0x476c2(%rip),%rsi        # 0x7f13b322eef4
   0x00007f13b31e7832 &lt;+50&gt;:    lea    0x3c892(%rip),%rdi        # 0x7f13b32240cb
   0x00007f13b31e7839 &lt;+57&gt;:    call   0x7f13b3193430 &lt;g_assertion_message_expr@plt&gt;
=&gt; 0x00007f13b31e783e &lt;+62&gt;:    xchg   %ax,%ax
   0x00007f13b31e7840 &lt;+64&gt;:    mov    %rbx,0xbe3a1(%rip)        # 0x7f13b32a5be8 &lt;_ZL15current_context&gt;
   0x00007f13b31e7847 &lt;+71&gt;:    pop    %rbx
   0x00007f13b31e7848 &lt;+72&gt;:    ret
End of assembler dump.

</code></pre>
<p><a href="https://gitlab.gnome.org/GNOME/gjs/-/blob/master/gjs/context.cpp#L1674">https://gitlab.gnome.org/GNOME/gjs/-/blob/master/gjs/context.cpp#L1674</a></p>
</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Aug 25 2022 13:20:07 GMT-0700 (Pacific Daylight Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">That seems like an odd place to segfault. - or am I misunderstanding what's happening?</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Aug 25 2022 13:20:26 GMT-0700 (Pacific Daylight Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Its segfaulting inside an assertion function?</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Aug 25 2022 13:21:21 GMT-0700 (Pacific Daylight Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">(sidenote, testing this is rather obnoxious, I'm not using a vm and the nested gnome-shell session I'm running as recommended by the docs , is capturing the keyboard from some applications...)</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Aug 25 2022 13:24:44 GMT-0700 (Pacific Daylight Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><p>That...doesn't look right?:</p>
<pre><code>(gdb) call (void*)gjs_context_eval((void*)gjs_context_get_current(), "global.context.unsafe_mode = true", -1, "&lt;injected&gt;", 0, 0)                                                                                                    [13/1471]
[Thread 0x7f2b0ffff640 (LWP 3826132) exited]                                                                                                                                                                                                  
                                                                                                                                                                                                                                              
Thread 2 "gmain" received signal SIGSEGV, Segmentation fault.                                                                                                                                                                                 
0x00007f2b627c2bc3 in js::AutoClearTypeInferenceStateOnOOM::AutoClearTypeInferenceStateOnOOM(JS::Zone*) [clone .cold] () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so                             
The program being debugged was signaled while in a function called from GDB.                                                                                                                                                                  
GDB remains in the frame where the signal was received.                                                                                                                                                                                       
To change this behavior use "set unwindonsignal on".
Evaluation of the expression containing the function
(gjs_context_eval) will be abandoned.
When the function is done executing, GDB will silently stop.
(gdb) bt
#0  0x00007f2b627c2bc3 in js::AutoClearTypeInferenceStateOnOOM::AutoClearTypeInferenceStateOnOOM(JS::Zone*) [clone .cold] () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so
#1  0x00007f2b62a27068 in js::ObjectGroup::defaultNewGroup(JSContext*, JSClass const*, js::TaggedProto, JSObject*) () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so
#2  0x00007f2b629e3451 in js::NewObjectWithClassProto(JSContext*, JSClass const*, JS::Handle&lt;JSObject*&gt;, js::gc::AllocKind, js::NewObjectKind) [clone .part.0] ()
   from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so
#3  0x00007f2b64a3fd79 in GjsContextPrivate::eval_with_scope(JS::Handle&lt;JSObject*&gt;, char const*, long, char const*, JS::MutableHandle&lt;JS::Value&gt;) [clone .localalias] ()
   from /nix/store/m9y268hk5l5gsla39w8n26sv6kjlb60n-gjs-1.70.1/lib/libgjs.so.0
#4  0x00007f2b64a3fefa in GjsContextPrivate::eval(char const*, long, char const*, int*, _GError**) [clone .localalias] () from /nix/store/m9y268hk5l5gsla39w8n26sv6kjlb60n-gjs-1.70.1/lib/libgjs.so.0
#5  0x00007f2b64a400a9 in gjs_context_eval () from /nix/store/m9y268hk5l5gsla39w8n26sv6kjlb60n-gjs-1.70.1/lib/libgjs.so.0
#6  &lt;function called from gdb&gt;
#7  0x00007f2b64554c89 in __GI___poll (fds=0x21d9bc0, nfds=2, timeout=3996) at ../sysdeps/unix/sysv/linux/poll.c:29
#8  0x00007f2b6536ad4e in g_main_context_poll (priority=&lt;optimized out&gt;, n_fds=2, fds=0x21d9bc0, timeout=&lt;optimized out&gt;, context=0x2204710) at ../glib/gmain.c:4478
#9  g_main_context_iterate (context=context@entry=0x2204710, block=block@entry=1, dispatch=dispatch@entry=1, self=&lt;optimized out&gt;) at ../glib/gmain.c:4170
#10 0x00007f2b6536ae6f in g_main_context_iteration (context=0x2204710, may_block=may_block@entry=1) at ../glib/gmain.c:4240
#11 0x00007f2b6536aec1 in glib_worker_main (data=&lt;optimized out&gt;) at ../glib/gmain.c:6140
#12 0x00007f2b65394e0d in g_thread_proxy (data=0x21eaf60) at ../glib/gthread.c:827
#13 0x00007f2b63a1cd40 in start_thread (arg=0x7f2b5cd0b640) at pthread_create.c:481
#14 0x00007f2b6456003f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95
(gdb) disas
Dump of assembler code for function _ZN2js32AutoClearTypeInferenceStateOnOOMC2EPN2JS4ZoneE.cold:
   0x00007f2b627c2bb2 &lt;+0&gt;:     mov    0xbf819f(%rip),%rax        # 0x7f2b633bad58
   0x00007f2b627c2bb9 &lt;+7&gt;:     lea    0xa08560(%rip),%rdx        # 0x7f2b631cb120
   0x00007f2b627c2bc0 &lt;+14&gt;:    mov    %rdx,(%rax)
=&gt; 0x00007f2b627c2bc3 &lt;+17&gt;:    movl   $0x0,0x0
   0x00007f2b627c2bce &lt;+28&gt;:    ud2    
   0x00007f2b627c2bd0 &lt;+30&gt;:    mov    0xbf8181(%rip),%rax        # 0x7f2b633bad58
   0x00007f2b627c2bd7 &lt;+37&gt;:    lea    0xa0857a(%rip),%rcx        # 0x7f2b631cb158
   0x00007f2b627c2bde &lt;+44&gt;:    mov    %rcx,(%rax)
   0x00007f2b627c2be1 &lt;+47&gt;:    movl   $0x0,0x0
   0x00007f2b627c2bec &lt;+58&gt;:    ud2    
End of assembler dump.

```
</code></pre>
</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Aug 25 2022 13:24:59 GMT-0700 (Pacific Daylight Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><code>movl $0x0,0x0</code>?</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Aug 25 2022 13:38:00 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Is that getting disassembled wrong? I dont think this involved any JIT? did it?</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Aug 25 2022 13:38:16 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">(Im not sure what a .cold is) - edit: apparently its a gcc annotation for functions unlikely to be executed, and are optimized for size</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Thu Aug 25 2022 13:39:29 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Why would there be an instruction that is basically equal to a segfault with no branches?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Thu Aug 25 2022 13:40:04 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">apparently ud2 "generates an invalid opcode"</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Thu Aug 25 2022 13:40:21 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">debug? hardening?</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Thu Aug 25 2022 13:44:19 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's generally what you use for a controlled crash</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Thu Aug 25 2022 13:44:23 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Like if an assertion fails</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Thu Aug 25 2022 13:45:18 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">right, thats what I meant. Hm.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Thu Aug 25 2022 13:45:22 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I'm having trouble finding the source of this function.</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Thu Aug 25 2022 13:45:31 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-esr78/source/js/src/vm/TypeInference.cpp#4597-4602">https://searchfox.org/mozilla-esr78/source/js/src/vm/TypeInference.cpp#4597-4602</a></td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Thu Aug 25 2022 13:45:39 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Oh thanks.</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Thu Aug 25 2022 13:45:47 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I tried searching central but I failed.</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Thu Aug 25 2022 13:46:02 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">TypeInference was removed when we moved from IonBuilder to WarpBuilder</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Thu Aug 25 2022 13:46:16 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Oh.</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Thu Aug 25 2022 13:46:19 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://hacks.mozilla.org/2020/11/warp-improved-js-performance-in-firefox-83/">https://hacks.mozilla.org/2020/11/warp-improved-js-performance-in-firefox-83/</a></td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Thu Aug 25 2022 13:46:29 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><pre><code>AutoClearTypeInferenceStateOnOOM::AutoClearTypeInferenceStateOnOOM(Zone* zone)
    : zone(zone) {
  MOZ_RELEASE_ASSERT(CurrentThreadCanAccessZone(zone));
  MOZ_ASSERT(!TlsContext.get()-&gt;inUnsafeCallWithABI);
  zone-&gt;types.setSweepingTypes(true);
}
</code></pre>
</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Thu Aug 25 2022 13:46:37 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Well that's starting to make more sense.</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Thu Aug 25 2022 13:47:26 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Now I'm just not sure what to do about it. That heavily implies wrong thread?</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Thu Aug 25 2022 13:47:46 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Is w+x settable per thread?</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Thu Aug 25 2022 13:48:01 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">No thats a memory region thing isn't it.</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Thu Aug 25 2022 13:48:12 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Thu Aug 25 2022 13:49:05 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Is it possible that there isn't even a thread running that I need to hijack and I actually need to start something else first?</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Thu Aug 25 2022 13:49:05 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Generally speaking, a JSContext belongs to a single thread</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Thu Aug 25 2022 13:49:22 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">That makes sense I think, given that js engines are (uh?) single threaded.</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Thu Aug 25 2022 13:49:32 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">- or at least the user facing side is.</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Thu Aug 25 2022 13:49:52 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">or is this more of a "python GIL" type of thing?</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Thu Aug 25 2022 13:50:24 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">JS execution is semantically single-threaded</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Thu Aug 25 2022 13:50:29 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">yes that</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Thu Aug 25 2022 13:50:32 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You can have worker threads that communicate via message passing</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Thu Aug 25 2022 13:50:47 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">right. (I've never used that myself)</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Thu Aug 25 2022 13:50:48 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And we have some helper threads to do things like background compilation</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Thu Aug 25 2022 13:50:56 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><em>nod</em></td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Thu Aug 25 2022 13:52:16 GMT-0700 (Pacific Daylight Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/vm/JSContext.h#159-162">https://searchfox.org/mozilla-central/source/js/src/vm/JSContext.h#159-162</a></td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Thu Aug 25 2022 13:52:53 GMT-0700 (Pacific Daylight Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">"A JSContext encapsulates the thread local state used when using the JS runtime."</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Thu Aug 25 2022 13:53:30 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So you can't just reach in and grab the context from another thread</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Thu Aug 25 2022 13:53:49 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Most of the time we pass it around explicitly, but there are definitely <a href="https://searchfox.org/mozilla-central/search?q=symbol:_ZN2js10TlsContextE&amp;redirect=false">some cases</a> where we use thread-local storage to retrieve the context</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Thu Aug 25 2022 13:54:56 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ptomato</span>: The thing is, I think <em>none</em> of these looks like the right thread...</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Thu Aug 25 2022 13:55:05 GMT-0700 (Pacific Daylight Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I feel like I'm missing something</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Thu Aug 25 2022 13:56:03 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Hm. What would be a good question to ask the system?</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Thu Aug 25 2022 13:56:22 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Maybe I can set a breakpoint on some gjs / spidermonkey function and check what thread it's running on?</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Thu Aug 25 2022 13:57:31 GMT-0700 (Pacific Daylight Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Something like <code>Interpret</code> could work: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Interpreter.cpp#356">https://searchfox.org/mozilla-central/source/js/src/vm/Interpreter.cpp#356</a></td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Thu Aug 25 2022 13:57:41 GMT-0700 (Pacific Daylight Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That will only be executed on the main JS thread</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Thu Aug 25 2022 13:57:43 GMT-0700 (Pacific Daylight Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Is the engine in the helper threads?</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Thu Aug 25 2022 13:58:23 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">because it would make <em>some</em> sense architecturally if what's actually happening is that a new thread is spawned whenever some js code is run, and then dies afterwards</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Thu Aug 25 2022 13:58:31 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">and thats why I can't hijack anything.</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Thu Aug 25 2022 13:58:57 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Well, that doesn1t make sense. - a thread must be able to spawn those, and that's what we are trying to hijack.</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Thu Aug 25 2022 13:59:19 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The helper threads don't run JS code</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Thu Aug 25 2022 13:59:26 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Though they could be spawning the spawner :/ . IDK. This might be the point to ask upstream.</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Thu Aug 25 2022 13:59:56 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">I havent figured out yet how they invoke gjs.</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Thu Aug 25 2022 14:46:40 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: <span class="nick-13">ptomato</span> OMG I think I got it! :D</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Thu Aug 25 2022 14:47:42 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">more info in a sec.</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Thu Aug 25 2022 14:50:00 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">Uh. OK this is really dumb. I may have neglected to try it on the only other thread that would have made sense, which is thread 1...</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Thu Aug 25 2022 14:50:53 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-4">iain</span>: your breakpoint suggestion helped, I basically confirmed that only thread 1 seemed to be running js:</p>
<pre><code>(gdb) b Interpret                                                                                                      
Breakpoint 1 at 0x7f3337fb1840 (2 locations)       
Thread 1 ".gnome-shell-wr" hit Breakpoint 1, 0x00007f336dacbac0 in Interpret(JSContext*, js::RunState&amp;) () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so       
                                    
(gdb) c                                                                                                                                                                                                                                       
Continuing.                                                                                                            
                                                                                                                                                                                                                                              
Thread 1 ".gnome-shell-wr" hit Breakpoint 1, 0x00007f336dacbac0 in Interpret(JSContext*, js::RunState&amp;) () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so                                           
(gdb) c 100                                                                                                                                                                                                                                   
Will ignore next 99 crossings of breakpoint 1.  Continuing.                                  
                                                                                                                                                                                                                                              
Thread 1 ".gnome-shell-wr" hit Breakpoint 1, 0x00007f336dacbac0 in Interpret(JSContext*, js::RunState&amp;) () from /nix/store/jbd1lfwfac40qcxvxfz1k2bc925r3qmw-spidermonkey-78.15.0/lib/libmozjs-78.so                                           
(gdb) cond 1  $_thread != 1                                                                                                                                                                                                                   
(gdb) c                                                                                                                                                                                                                                       
Continuing.                                                                                                                                                                                                                                   
^C                           
</code></pre>
</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Thu Aug 25 2022 14:51:54 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">before that, I was trying to look around the code and figure out how they were running the js stuff, but I guess it was all just running on the main thread.</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Thu Aug 25 2022 14:54:14 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><p>This is the first thing I got working:</p>
<pre><code>(gdb) call (void*)gjs_context_eval((void*)_shell_global_get_gjs_context((void*)the_object), "global.context.unsafe_mode = true", -1, "&lt;injected&gt;", 0, 0)                                                                                      
[New Thread 0x7f33656ce640 (LWP 3962544)]                                                                                                                                                                                                     
$5 = (void *) 0x1       
</code></pre>
<p>at first I though the solution was that we were getting the wrong object, because they have some code that keeps a singleton around<br><a href="https://github.com/GNOME/gnome-shell/blob/4a0cfbc5d6711cfce592d79cc62b89de8b86cb08/src/main.c#L179">https://github.com/GNOME/gnome-shell/blob/4a0cfbc5d6711cfce592d79cc62b89de8b86cb08/src/main.c#L179</a></p>
<p>but turns out ptomato's suggestion works just fine.</p>
</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Thu Aug 25 2022 14:54:32 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell"><pre><code>(gdb) call (void*)gjs_context_eval((void*)gjs_context_get_current(), "global.context.unsafe_mode = true", -1, "&lt;injected&gt;", 0, 0)                                                                                                             
[Thread 0x7f1e57fff640 (LWP 3968069) exited]                                                                                                                                                                                                  
[New Thread 0x7f1e57fff640 (LWP 3968968)]                                                                                                                                                                                                     
$6 = (void *) 0x1
</code></pre>
</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Thu Aug 25 2022 14:54:45 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jcie74:matrix.org">pie_</span>&gt;</div></td><td class="msg-cell">So I think I just did a bunch of digging for the dumb reason of not trying it on the main thread I guess.</td></tr>

</tbody></table></div></div></div>
</body></html>