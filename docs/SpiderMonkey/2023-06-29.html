<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-06-29</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-06-29<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-06-28" class="nav-link"><span>prev</span></a>
<a href="2023-06-30" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Jun 28 2023 19:35:51 GMT-0700 (Pacific Daylight Time)">02:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> which version of SpiderMonkey is the question about?</blockquote></mx-reply>Current SpiderMonkey. I'm trying to get up to speed on the internals after being away for nearly a decade. Holy moly things have changed, I'm still trying to wrap my head around exactly what the GC is doing under the hood.  My question and Jandem's answer show that I have more reading to do.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Jun 28 2023 22:05:23 GMT-0700 (Pacific Daylight Time)">05:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I see :)</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jun 29 2023 00:52:37 GMT-0700 (Pacific Daylight Time)">07:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">dbezhetskov</span>: code is either writable and executable or one of writable/executable. In the latter case we reprotect if needed with the <code>Maybe&lt;AutoWritableJitCode&gt;</code> in <code>TraceDataRelocations</code></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jun 29 2023 00:57:24 GMT-0700 (Pacific Daylight Time)">07:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">wes</span>: <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr102/docs/GC%20Rooting%20Guide.md">this</a> might help</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jun 29 2023 04:58:13 GMT-0700 (Pacific Daylight Time)">11:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">Can I borrow a few minutes of someone's time to help me diagnose a rooting hazard that we go while landing something we'd like to reland asap ?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jun 29 2023 05:02:43 GMT-0700 (Pacific Daylight Time)">12:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">padenot</span>: do you have a link to a try/autoland push with failures?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jun 29 2023 05:03:27 GMT-0700 (Pacific Daylight Time)">12:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><a href="https://treeherder.mozilla.org/logviewer?job_id=421052163&amp;repo=autoland&amp;lineNumber=77945">https://treeherder.mozilla.org/logviewer?job_id=421052163&amp;repo=autoland&amp;lineNumber=77945</a></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jun 29 2023 05:03:42 GMT-0700 (Pacific Daylight Time)">12:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I think it's just a matter of sprinkling <code>Rooted&lt;&gt;</code> a bit everywhere on those lines</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jun 29 2023 05:13:16 GMT-0700 (Pacific Daylight Time)">12:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">ok so <code>VideoDecoderConfig</code> is a WebIDL dictionary</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jun 29 2023 05:15:55 GMT-0700 (Pacific Daylight Time)">12:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">indeed</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jun 29 2023 05:19:33 GMT-0700 (Pacific Daylight Time)">12:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><code>RootedDictionary&lt;VideoDecoderConfig&gt; config(cx)</code> seems to be the right incantation to root those</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jun 29 2023 05:20:35 GMT-0700 (Pacific Daylight Time)">12:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">and then <code>Handle&lt;&gt;</code> in the param of functions ?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jun 29 2023 05:20:37 GMT-0700 (Pacific Daylight Time)">12:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, looks like <code>VideoDecoderConfig</code> is placed both on stack and heap.  the stack case can use <code>RootedDictionary</code> as jandem says, but the heap case in <code>ConfigureMessage.mConfig</code> may need extra tracing I think</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jun 29 2023 05:21:52 GMT-0700 (Pacific Daylight Time)">12:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">maybe we should just copy that to a normal struct</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jun 29 2023 05:23:41 GMT-0700 (Pacific Daylight Time)">12:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">to my understanding, the hazard comes from the <code>ArrayBuffer</code> (<code>VideoDecoderConfig.description</code>), and the buffer is passed through the message?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jun 29 2023 05:23:59 GMT-0700 (Pacific Daylight Time)">12:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">yeah we should copy that</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Jun 29 2023 05:24:03 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">it's copied anyway</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Jun 29 2023 05:24:51 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, if it can be copied, the not using <code>ArrayBuffer</code> would be the simplest way. as the comment in the <code>dictionary VideoDecoderConfig</code> declaration says</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Jun 29 2023 05:24:55 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">what's the method to go from a JS::Handle to the type that it refers to?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Jun 29 2023 05:25:23 GMT-0700 (Pacific Daylight Time)">12:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><code>.get()</code> or implicit conversion</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Jun 29 2023 05:25:51 GMT-0700 (Pacific Daylight Time)">12:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">there's no <code>HandleDictionary</code> as far as I can tell. Other code seems to pass <code>RootedDictionary&amp;</code>?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Jun 29 2023 05:26:49 GMT-0700 (Pacific Daylight Time)">12:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">ah ok</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Jun 29 2023 05:27:20 GMT-0700 (Pacific Daylight Time)">12:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I agree with arai that not using the array buffer would be nice</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Jun 29 2023 07:28:21 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">ok it's a big patch now, but it should do the trick</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Jun 29 2023 07:29:05 GMT-0700 (Pacific Daylight Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>, <span class="nick-15">arai</span>, thanks! I opted to convert those DOM objects into regular objects, and so this effectively sidesteps the whole issue</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Jun 29 2023 07:30:11 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">instead of doing a bunch of things with the dom objects, and then later converting them to regular objects</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Jun 29 2023 07:30:18 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">we generally use WebIDL dictionaries only on the stack</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Jun 29 2023 07:31:07 GMT-0700 (Pacific Daylight Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">yeah it felt a bit weird to see them deep in the media code, so I got us more or less the same objects, but they use gecko types you'd find then such as Maybe instead of Optional, etc.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Jun 29 2023 07:31:31 GMT-0700 (Pacific Daylight Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">and the arraybuffer is converted to our MediaByteBuffer that we use for this purpose as well</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Jun 29 2023 07:31:38 GMT-0700 (Pacific Daylight Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">you can use a union with arraybuffers on the heap with a RootedUnion I think, but you really need to hook it up to the cyclec collector then</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Jun 29 2023 07:32:12 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">the API is designed in such a way that you need to copy this small buffer anyways</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Jun 29 2023 07:32:27 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">(because it's used internally on other threads)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Jun 29 2023 07:32:28 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">ok, seems safer in general</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Jun 29 2023 07:33:03 GMT-0700 (Pacific Daylight Time)">14:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">good thing we have static analysis, though I really would like reviewers to have caught this too</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Jun 29 2023 07:33:53 GMT-0700 (Pacific Daylight Time)">14:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Jun 29 2023 07:36:59 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">ideally we'd have an easy way to run it locally, short of that I'm going to add this job to our media try preset</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Jun 29 2023 08:45:06 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><p>I'm having trouble understanding why <code>js::jit::StackValue</code> isn't a fully defined debug symbol. I'm compiling with --enable-debug and --disable-optimize, and haven't had any trouble with any other debug symbols, but when I run the JS shell in gdb or rr:</p>
<pre><code>Thread 1 hit Breakpoint 1, js::jit::CompilerFrameInfo::sync (this=0x7ffee6416138, val=0x7fcfb13b6378) at /home/bryan/src/mozilla-unified/js/src/jit/BaselineFrameInfo.cpp:39
39	  switch (val-&gt;kind()) {
(rr) p js::jit::StackValue::Stack
No type "StackValue" within class or namespace "js::jit".
(rr) whatis val
type = js::jit::StackValue *
(rr) p *val
$4 = &lt;incomplete type&gt;

</code></pre>
<p>The process is breakpointed in <code>CompilerFrameInfo::sync()</code> which calls functions on <code>StackValue</code>, so the type <em>must</em> be defined. But why isn't rr finding it?</p>
</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Jun 29 2023 08:48:19 GMT-0700 (Pacific Daylight Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: That all seems like it should work. Normally when I have that sort of problem it's because I'm using an optimized build, so if that's not your problem, nothing leaps out to me.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Jun 29 2023 08:59:31 GMT-0700 (Pacific Daylight Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I do not know if this would help, but in the past I added: <code>--enable-debug-symbols=-ggdb2</code> and <code>--enable-debug=-ggdb2</code> to my mozconfig generator.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Jun 29 2023 09:00:15 GMT-0700 (Pacific Daylight Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">the first one being used only in profiled / optimized builds.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Jun 29 2023 09:00:55 GMT-0700 (Pacific Daylight Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">as well as the following comment: <code>TODO: Use -ggdb3 when not building firefox, as -ggdb3 still output macro definitions after pre-processing.</code></td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Jun 29 2023 09:32:46 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Thanks! Unfortunately, <code>--enable-debug=-ggdb3</code> doesn't seem to help</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Jun 29 2023 09:40:29 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> look at <code>StableCellHasher</code>, eg <code>GetOrCreateUniqueId</code>.</blockquote></mx-reply><p>I can find something called MovableCellHasher in my RootingAPI.h.  I'm working with mozjs-102.</p>
<p>From what I can tell, it looks like almost the exact same thing as the StableCellHasher.</p>
</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Jun 29 2023 09:41:32 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: It was renamed <a href="https://phabricator.services.mozilla.com/D177525">here</a></td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Jun 29 2023 09:42:02 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">kfjvj</span>: It was renamed <a href="https://phabricator.services.mozilla.com/D177525">here</a></blockquote></mx-reply>OK.  As long as it's basically the same functionality, I should be fine.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Jun 29 2023 10:18:28 GMT-0700 (Pacific Daylight Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I'm having trouble understanding why <code>js::jit::StackValue</code> isn't a fully defined debug symbol. I'm compiling with --enable-debug and --disable-optimize, and haven't had any trouble with any other debug symbols, but when I run the JS shell in gdb or rr:</p>
<pre><code>Thread 1 hit Breakpoint 1, js::jit::CompilerFrameInfo::sync (this=0x7ffee6416138, val=0x7fcfb13b6378) at /home/bryan/src/mozilla-unified/js/src/jit/BaselineFrameInfo.cpp:39
39	  switch (val-&gt;kind()) {
(rr) p js::jit::StackValue::Stack
No type "StackValue" within class or namespace "js::jit".
(rr) whatis val
type = js::jit::StackValue *
(rr) p *val
$4 = &lt;incomplete type&gt;

</code></pre>
<p>The process is breakpointed in <code>CompilerFrameInfo::sync()</code> which calls functions on <code>StackValue</code>, so the type <em>must</em> be defined. But why isn't rr finding it?</p>
</blockquote></mx-reply>This sounds very similar to what we ran into with JSString (and many others) not being defined. I'm guessing it's the same underlying cause. For a quick fix, try adding <code>-fstandalone-debug</code> to the compiler flags.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Jun 29 2023 10:19:44 GMT-0700 (Pacific Daylight Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the problem is that a recent clang enabled an optimization to stop emitting debuginfo for all known types in all of the object files, but instead picking an object file to put class's debuginfo into. It dramatically reduces the amount of debuginfo produced.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Jun 29 2023 10:20:19 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: do you think it's worth trying to run your rooting hazard stuff on debian-based distros? There's a comment that says it doesn't work, but I don't know how current it is</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Jun 29 2023 10:21:27 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but the compiler has to choose a compilation unit to emit it for. Its heuristic depends on a call to the class's constructor, and sometimes we cheat and don't have one (we cast a pointer and just start using it, which violates the C++ spec but works.)</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Jun 29 2023 10:21:35 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I'm referring to this: <a href="https://wiki.mozilla.org/Javascript:Hazard_Builds#Running_locally">https://wiki.mozilla.org/Javascript:Hazard_Builds#Running_locally</a></td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Jun 29 2023 10:22:57 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">padenot</span>: I'm pretty sure it won't work out of the box, and I doubt <code>mach hazards bootstrap</code> will help much on Debian. That said, people have run it on Debian in the past. And the automation setup for running it locally is vastly better than it used to be.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Jun 29 2023 10:23:58 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if you wanted to try to beat it into submission, I could help out. I don't have time at the moment to find a debian-derived VM and get it properly working myself right now, though.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Jun 29 2023 10:24:38 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">maybe I should try to make it work then. We're going to do lots of code in which I suspect this analysis is going to help us, and I'd like to have shorter round-trip time when developing</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Jun 29 2023 10:24:58 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">(the implementation of the Web Codecs API)</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Jun 29 2023 10:25:35 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I need to ping peterv about bug 1690111. I suspect you'll be touching overlapping stuff.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Jun 29 2023 10:25:36 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1690111">https://bugzil.la/1690111</a></td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Jun 29 2023 10:26:11 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I'll give it a go and report back my findings, there's two debian developers in the paris office that can maybe help</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Jun 29 2023 10:28:14 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">there are really two parts to the analysis which will require very different things. First is <code>mach hazards gather</code>, which is the hard part -- that's where it compiles the whole tree with a gcc plugin. The second part is analyzing the result (<code>mach hazards analyze</code>), which may just work and should definitely be much easier to get working if not.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Jun 29 2023 10:29:08 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">oh but the job on treeherder is a debian</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Jun 29 2023 10:29:15 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">or am I misreading</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Jun 29 2023 10:29:24 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: the more principled fix would be to add a call to the <code>js::jit::StackValue</code> constructor, probably via placement new, somewhere.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Jun 29 2023 10:29:42 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><a href="https://firefox-ci-tc.services.mozilla.com/tasks/TNzhwpe4QxS3Gj_Rf07iXg">https://firefox-ci-tc.services.mozilla.com/tasks/TNzhwpe4QxS3Gj_Rf07iXg</a> is the task that ran it</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Jun 29 2023 10:29:42 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh wait, you must be right.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Jun 29 2023 10:29:52 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(re: debian)</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Jun 29 2023 10:30:13 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so... it doesn't already work by any chance, does it? :-)</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Jun 29 2023 10:30:26 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">ok well I'll peek into what's in the image and maybe it's just going to work</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Jun 29 2023 10:30:39 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(I run it locally on Fedora all the time, but I think all of the CI builders <em>are</em> debian)</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Jun 29 2023 10:30:52 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I haven't tried, but I'll give it a go tomorrow and report back / update the docs</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Jun 29 2023 10:31:25 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, it should pretty much be <code>mach hazards bootstrap; mach hazards build-shell; mach hazards gather; mach hazards analyze; mach hazards view</code></td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Jun 29 2023 10:32:19 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">oh but I was reading the wrong docs, that's the issue</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Jun 29 2023 10:32:44 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oops I should've clicked your docs link</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Jun 29 2023 10:32:44 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><a href="https://firefox-source-docs.mozilla.org/js/HazardAnalysis/running.html#running-the-rooting-hazard-analysis">https://firefox-source-docs.mozilla.org/js/HazardAnalysis/running.html#running-the-rooting-hazard-analysis</a> looks current, <a href="https://wiki.mozilla.org/Javascript:Hazard_Builds#Running_locally">https://wiki.mozilla.org/Javascript:Hazard_Builds#Running_locally</a> looks ancient</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Jun 29 2023 10:32:59 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">the problem being that the second link is what is written to the log in case of failure</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Jun 29 2023 10:33:36 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><a href="https://treeherder.mozilla.org/logviewer?job_id=421092008&amp;repo=try&amp;lineNumber=77948">https://treeherder.mozilla.org/logviewer?job_id=421092008&amp;repo=try&amp;lineNumber=77948</a>, it even mentions TinderBox, I should have known that it wasn't exactly up-to-date</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Jun 29 2023 10:35:05 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah! Yes, it has a nice obsolete banner, but that doesn't help much if the job is pointing to it anyway. Sorry about that, I'll update it.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Jun 29 2023 10:35:49 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">cool, thanks! happy that this just works then, and cool that we have this analysis in the first place</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Jun 29 2023 10:37:25 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I also need to add <code>mach hazards view</code> to the instructions...</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Jun 29 2023 10:38:06 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so other people can suffer through my horrible CSS</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Jun 29 2023 10:41:01 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">...and I should write up something about incremental analyses...</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Jun 29 2023 11:07:30 GMT-0700 (Pacific Daylight Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-7">Bryan Thrall [:bthrall]</span>: the more principled fix would be to add a call to the <code>js::jit::StackValue</code> constructor, probably via placement new, somewhere.</blockquote></mx-reply>Interestingly, <code>-fstandalone-debug</code> didn't seem to help, but calling the <code>StackValue</code> constructor did force clang to store the debuginfo so rr can find it. Thanks!</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Jun 29 2023 11:13:08 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@twisniewski:mozilla.org">twisniewski</span>&gt;</div></td><td class="msg-cell">Just FYI, Webkit 173 just added four more perf optimizations (and 172 had one as well). I've updated our platform gap spreadsheets.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Jun 29 2023 11:18:40 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: <a href="https://github.com/WebKit/WebKit/commit/0e3fcb9531e248c468366393fd4f2127ea5dcb56">this patch</a> might be relevant to the string replace code you're looking at.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Jun 29 2023 12:08:03 GMT-0700 (Pacific Daylight Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><p>a bit offtopic, but my google-foo failed me: is anyone here knowledgeable about module best-practices? :)<br>wondering what would be the better way to handle custom js objects that act as module.</p>
<p>e.g. let's say I have <code>myObj</code> custom object that is acting as a <code>playback-control</code> module. It has methods like <code>play</code>, <code>pause</code> and etc.<br>This lines up pretty good with module structure:</p>
<pre><code>export function play() { return myObj.play(); };
//...
export default myObj;
</code></pre>
<p>But this object also has RW properties like <code>currentTime</code> or <code>volume</code>, which makes it not a "pure" and stateless object, thus requires user to use default export to access properties, i.e.:</p>
<pre><code>import playback from `playback-control`;
import {pause} from `playback-control`;

pause(); // can be used via named import
playback.volume = 0.7; // can only be used from default import
</code></pre>
<p>So, the question: would that be considered fine, or should these properties be 'methodified' (e.g. getVolume(), setVolume()), or maybe the whole <code>myObj</code> should be wrapped in accessor method (thus would be the only exported thing in the module)?</p>
</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Jun 29 2023 12:29:09 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I guess, it mostly depends on whether the consumer of the module wants to call the function with <code>pause()</code> style or <code>playback.pause()</code> style.  and it would be brevity vs readability(?) problem?</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Thu Jun 29 2023 12:30:40 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in Firefox internal, derived from JSM-style, most things are written in <code>playback.pause()</code> style</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Thu Jun 29 2023 12:35:07 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and to my understanding, exporting a function with side-effect is not much common there</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Thu Jun 29 2023 12:35:58 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it could be very different in other projects tho</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Thu Jun 29 2023 12:44:25 GMT-0700 (Pacific Daylight Time)">19:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">thanks, this means that my current way of things (i.e. default exporting object with properties) is at the very least not entirely wrong :D</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Thu Jun 29 2023 13:31:31 GMT-0700 (Pacific Daylight Time)">20:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>Can I get a quick sanity check?</p>
<p>I am using the following type signature to correlate jsobjects with std::type_index:</p>
<pre><code>js::HashMap&lt;JSObject*, std::type_index, js::MovableCellHasher&lt;JSObject*&gt;&gt;
</code></pre>
<p>Because it's using the movable cell hasher, I think the keys should be relatively stable.  However, it doesn't feel right to have JSObject* directly in the map signature like that.</p>
<p><span class="nick-4">iain</span> , <span class="nick-12">sfink</span> , any advice?</p>
</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Thu Jun 29 2023 13:39:40 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: Not my area of expertise, but looking at searchfox, I see that WeakMap (which <a href="https://searchfox.org/mozilla-central/source/js/src/gc/WeakMap.h#178-180">uses</a> StableCellHasher&lt;Key&gt;) generally uses HeapPtr&lt;T&gt; for its keys (<a href="https://searchfox.org/mozilla-central/source/js/src/gc/WeakMap.h#323">example</a>). Intuitively, all StableCellHasher is doing is giving you a hash value that won't change when the object is moved; it can't ensure that the key you store inside your hashtable is updated, so you still need to trace your keys.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Thu Jun 29 2023 13:47:40 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">kfjvj</span>: Not my area of expertise, but looking at searchfox, I see that WeakMap (which <a href="https://searchfox.org/mozilla-central/source/js/src/gc/WeakMap.h#178-180">uses</a> StableCellHasher&lt;Key&gt;) generally uses HeapPtr&lt;T&gt; for its keys (<a href="https://searchfox.org/mozilla-central/source/js/src/gc/WeakMap.h#323">example</a>). Intuitively, all StableCellHasher is doing is giving you a hash value that won't change when the object is moved; it can't ensure that the key you store inside your hashtable is updated, so you still need to trace your keys.</blockquote></mx-reply><p>I was originally using a <code>std::unordered_map&lt;HashNumber, std::type_index&gt;</code>, but then I realized that I wasn't sure if the hashes generated by MovableCellHasher would be unique.</p>
<p>There's that function you mentioned, something like GetOrCreateUniqueId, but I don't think I have it in my mozjs version.</p>
</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Thu Jun 29 2023 13:48:35 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The hashes are not guaranteed to be unique.</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Thu Jun 29 2023 13:49:03 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Actually, let me double-check that</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Thu Jun 29 2023 13:49:20 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Okay, yeah</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Thu Jun 29 2023 13:49:23 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">it's not guaranteed in std::map</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Thu Jun 29 2023 13:49:47 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">or any std associative container</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Thu Jun 29 2023 13:50:12 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We use GetOrCreateUniqueId inside StableCellHasher to get a unique id for each object, but then we hash that unique id, which can potentially lead to hash collisions</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Thu Jun 29 2023 13:52:36 GMT-0700 (Pacific Daylight Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Maybe I need to try a different approach.  Do the prototype objects created with JS_InitClass have any extra slots where I could put some custom data?</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Thu Jun 29 2023 13:56:19 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">you can specify js class with additional reserved slot</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Thu Jun 29 2023 13:56:48 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> you can specify js class with additional reserved slot</blockquote></mx-reply>The class can have a reserved slot, but can the /prototype/ have a reserved slot?</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Thu Jun 29 2023 13:58:56 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">iirc, there is no difference between prototype and any other custom js object in that sense. I've never tried doing that though</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Thu Jun 29 2023 13:59:29 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, I need to brush up on my prototype knowledge.</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Thu Jun 29 2023 14:00:58 GMT-0700 (Pacific Daylight Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">what are you trying to achieve?</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Thu Jun 29 2023 14:02:01 GMT-0700 (Pacific Daylight Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Basically, I need to have a 2-way lookup that can associate std::type_index with a JS prototype, and can do the reverse association as well.</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Thu Jun 29 2023 14:02:21 GMT-0700 (Pacific Daylight Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">It's all part of an effort to map c++ classes onto JS</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Thu Jun 29 2023 14:03:09 GMT-0700 (Pacific Daylight Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">do you have a fixed amount of prototypes or arbitrary?</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Thu Jun 29 2023 14:03:24 GMT-0700 (Pacific Daylight Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">any number</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Thu Jun 29 2023 14:05:12 GMT-0700 (Pacific Daylight Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">one way would be to use JSClass::name for reverse lookup</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Thu Jun 29 2023 14:05:37 GMT-0700 (Pacific Daylight Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">is it unique an unchanging?</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Thu Jun 29 2023 14:06:17 GMT-0700 (Pacific Daylight Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">well, it's the same as the one you pass in JS_InitClass =)</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Thu Jun 29 2023 14:06:47 GMT-0700 (Pacific Daylight Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">oh right.  There could potentially be multiple classes with the same name.  There's a huge nested hierarchy.</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Thu Jun 29 2023 14:07:20 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">hm, I don't think you can have multiple prototypes with the same name tho</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Thu Jun 29 2023 14:07:36 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">registered on the same object at least (e.g. global object)</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Thu Jun 29 2023 14:08:23 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Yeah, the global object has a tree structure of multiple levels where the prototypes will be</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Thu Jun 29 2023 14:08:24 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">because otherwise there would be no way to invoke constructor <code>new MyClassName()</code></td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Thu Jun 29 2023 14:08:51 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">so, in global, we could have <a href="http://a.b.c.Foo">a.b.c.Foo</a> as well as <a href="http://a.b.e.Foo">a.b.e.Foo</a>, etc.</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Thu Jun 29 2023 14:09:22 GMT-0700 (Pacific Daylight Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">where a,b,c are other objects/prototypes?</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Thu Jun 29 2023 14:09:59 GMT-0700 (Pacific Daylight Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">They're just plain objects.  The c++ namespace hierarchy is mapped onto a set of plain JS objects</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Thu Jun 29 2023 14:11:15 GMT-0700 (Pacific Daylight Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">dunno why would you want that, but sounds exciting :D</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Thu Jun 29 2023 14:12:06 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> dunno why would you want that, but sounds exciting :D</blockquote></mx-reply>I'm not sure how else to mirror the structure of namespaces.</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Thu Jun 29 2023 14:12:50 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">It sounds to me like you could have prototype objects with either a reserved slot storing the std::type_index, or a non-enumerable property, or a Symbol-keyed property, or just a plain property with a funky name. For the other way, it depends a bit on what you want the lifetime to be, but it sounds like these could live for as long as the runtime does?</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Thu Jun 29 2023 14:13:43 GMT-0700 (Pacific Daylight Time)">21:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">I mean, I can't imagine what you need the mapping of arbitrary c++ types to JS for =)</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Thu Jun 29 2023 14:15:03 GMT-0700 (Pacific Daylight Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I mean, I can't imagine what you need the mapping of arbitrary c++ types to JS for =)</blockquote></mx-reply>We're auto-generating JS bindings for a massive C++ api.</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Thu Jun 29 2023 14:15:48 GMT-0700 (Pacific Daylight Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Using the boost::describe library, and the maddening black sorcery of template metaprogramming.</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Thu Jun 29 2023 14:16:45 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">hope you don't forget about performance overhead though (JS &lt;&gt; nativeland boundary transition might be quite expensive)</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Thu Jun 29 2023 14:16:47 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">anyway, it seems like you could do a <code>GCHashMap&lt;std::type_index, JS::Heap&lt;JSObject*&gt;&gt;</code>. You would need to put that in something that gets traced, but if it's really the full runtime's lifetime, then it could be a <code>PersistentRooted&lt;GCHashMap&lt;...&gt;&gt;</code></td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Thu Jun 29 2023 14:17:29 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> hope you don't forget about performance overhead though (JS &lt;&gt; nativeland boundary transition might be quite expensive)</blockquote></mx-reply>learned that the hard way xD</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Thu Jun 29 2023 14:17:39 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> learned that the hard way xD</blockquote></mx-reply>Oh yes, we are well aware.</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Thu Jun 29 2023 14:18:02 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that wouldn't require the <code>StableCellHasher</code>/<code>MovableCellHasher</code> thing, since the moving weirdness doesn't impact the values.</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Thu Jun 29 2023 14:18:37 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">std::unordered_map&lt;&gt; can be used for even more c++ compat (additional tracing will be required though)</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Thu Jun 29 2023 14:19:15 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, you'd have to arrange for the values to be traced or swept.</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Thu Jun 29 2023 14:19:41 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Thanks for the help.  There's certainly a lot to think about for this.</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Thu Jun 29 2023 14:20:13 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> yeah, you'd have to arrange for the values to be traced or swept.</blockquote></mx-reply>wdym by "swept"?</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Thu Jun 29 2023 14:20:48 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">(I've only ever traced GC things =))</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Thu Jun 29 2023 14:21:31 GMT-0700 (Pacific Daylight Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if you need them to always stay alive, then you have to trace them. Otherwise, you need to have them updated on a moving GC or nulled out if nothing else is keeping them alive. That happens during sweeping.</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Thu Jun 29 2023 14:23:05 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">they're similar, but sweeping tends to work by looking at a collection of some sort and iterating over all the entries to find the ones that have either moved or need to be nulled out or removed, and the collection often needs to do something (unlink nodes or whatever) when contained items are removed.</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Thu Jun 29 2023 14:24:19 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">hm... But I thought that I can just stop tracing GC things if I don't need them anymore?</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Thu Jun 29 2023 14:24:55 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that'll work if you never ever look at them again</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Thu Jun 29 2023 14:25:22 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but if there's any way to find them, eg by iterating over a collection or whatever, then you'll have a bad time</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Thu Jun 29 2023 14:26:29 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and things that you trace tend to need barriers, which will probably fire if you're destroying something, at which time they'll look at them</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Thu Jun 29 2023 14:26:34 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">ah, so sweeping is like marking GC things as dead, while it's still accessible through something like GC container (e.g. GCHashMap)?</td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Thu Jun 29 2023 14:27:29 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, though maybe it'd be better to say that it's visiting <em>edges</em> to dead (or moved) GC things</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Thu Jun 29 2023 14:27:54 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">I think I understand now, thanks :)</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Thu Jun 29 2023 14:29:27 GMT-0700 (Pacific Daylight Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">hopefully my usage scenarios won't be ever so complex, that I will need this knowledge though :D</td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Thu Jun 29 2023 14:29:42 GMT-0700 (Pacific Daylight Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(since GC is all about marking things as live, never marking things as dead. Reference counting marks things as dead. But that's beside the point.)</td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Thu Jun 29 2023 14:30:42 GMT-0700 (Pacific Daylight Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> hopefully my usage scenarios won't be ever so complex, that I will need this knowledge though :D</blockquote></mx-reply>barriers are the part that really make my head hurt, and you can start to need those without realizing it ;-)</td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Thu Jun 29 2023 14:31:11 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">any simple example scenario when one would need those?</td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Thu Jun 29 2023 14:31:50 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(1) if you use generational GC and you ever store something that might be in the nursery / young generation</td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Thu Jun 29 2023 14:32:17 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(2) if you use incremental GC and you ever change something that you've stored</td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Thu Jun 29 2023 14:33:17 GMT-0700 (Pacific Daylight Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">those aren't the only times (with generational GC, you also need them when you're deleting stuff that might have been in the nursery at some point, for example) but they're the main ones</td></tr>
  <tr class="msg" id="L150"><td class="ts-cell"><a class="ts" href="#L150" alt="Thu Jun 29 2023 14:34:35 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">Whew, glad that I didn't have enough patience to implement whole GC by myself :D (just using built-in things like IncrementalGCSlice/JS_GC/NonIncrementalGC)</td></tr>
  <tr class="msg" id="L151"><td class="ts-cell"><a class="ts" href="#L151" alt="Thu Jun 29 2023 14:34:43 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we also have a 3rd kind of barrier, a read barrier, that we've inflicted upon ourselves because we're interfacing with a different automatic memory management system (specifically, a cycle collector)</td></tr>
  <tr class="msg" id="L152"><td class="ts-cell"><a class="ts" href="#L152" alt="Thu Jun 29 2023 14:35:54 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">A basic GC can be implemented fairly easily in an afternoon. A not so basic GC can be implemented in... a decade or so, I guess? ;-)</td></tr>
  <tr class="msg" id="L153"><td class="ts-cell"><a class="ts" href="#L153" alt="Thu Jun 29 2023 14:37:24 GMT-0700 (Pacific Daylight Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Whew, glad that I didn't have enough patience to implement whole GC by myself :D (just using built-in things like IncrementalGCSlice/JS_GC/NonIncrementalGC)</blockquote></mx-reply><p>I mean, I'm 99% sure that my implementation (using those built-in facilities) is really sub-optimal.<br>But:</p>
<ul>
<li>it works</li>
<li>I don't have enough expertise to make it better anyway xD</li>
</ul>
</td></tr>
  <tr class="msg" id="L154"><td class="ts-cell"><a class="ts" href="#L154" alt="Thu Jun 29 2023 14:38:45 GMT-0700 (Pacific Daylight Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">I think it took a "bit" more though? How old was Firefox again? :D</td></tr>
  <tr class="msg" id="L155"><td class="ts-cell"><a class="ts" href="#L155" alt="Thu Jun 29 2023 14:38:52 GMT-0700 (Pacific Daylight Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if you're using incremental, then you'll probably need to be using <code>Heap&lt;JSObject*&gt;</code> and not bare <code>JSObject*</code> in most places.</td></tr>
  <tr class="msg" id="L156"><td class="ts-cell"><a class="ts" href="#L156" alt="Thu Jun 29 2023 14:39:54 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think it took a "bit" more though? How old was Firefox again? :D</blockquote></mx-reply>Not quite old enough to drink in the US, I believe.</td></tr>
  <tr class="msg" id="L157"><td class="ts-cell"><a class="ts" href="#L157" alt="Thu Jun 29 2023 14:40:02 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">er, drink legally, that is</td></tr>
  <tr class="msg" id="L158"><td class="ts-cell"><a class="ts" href="#L158" alt="Thu Jun 29 2023 14:40:14 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it has been observed acting drunk plenty of times</td></tr>
  <tr class="msg" id="L159"><td class="ts-cell"><a class="ts" href="#L159" alt="Thu Jun 29 2023 14:41:51 GMT-0700 (Pacific Daylight Time)">21:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Ugh. I hate performance work. I realized the results I've been looking at have been Linux-specific. When I looked at Windows, it had some of the same improvements, plus some really major regressions. So I retested, and now Windows is showing no regressions and a whole bunch more improvements.</td></tr>
  <tr class="msg" id="L160"><td class="ts-cell"><a class="ts" href="#L160" alt="Thu Jun 29 2023 14:41:56 GMT-0700 (Pacific Daylight Time)">21:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">There Is No Truth</td></tr>
  <tr class="msg" id="L161"><td class="ts-cell"><a class="ts" href="#L161" alt="Thu Jun 29 2023 14:42:04 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">the problem with my use of GC is mostly in tuning: allocation thresholds, memory pressure and etc.
browser SM usage scenario is totally different, so I can't reuse values and have to guess everything...</td></tr>
  <tr class="msg" id="L162"><td class="ts-cell"><a class="ts" href="#L162" alt="Thu Jun 29 2023 14:43:56 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">well, was it the same test stand? :D<br>don't forget those sneaky "small" windows updates that change "small" things, that totally break performance in unexpected places</td></tr>
  <tr class="msg" id="L163"><td class="ts-cell"><a class="ts" href="#L163" alt="Thu Jun 29 2023 14:44:49 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, tuning is a dark art, and one that we're not very rigorous about. We mostly just back our way into accidentally overfitting to the benchmark of the day.</td></tr>
  <tr class="msg" id="L164"><td class="ts-cell"><a class="ts" href="#L164" alt="Thu Jun 29 2023 14:45:37 GMT-0700 (Pacific Daylight Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">another thing that makes it difficult is that there is no way to limit max heap alloc in SM GC</td></tr>
  <tr class="msg" id="L165"><td class="ts-cell"><a class="ts" href="#L165" alt="Thu Jun 29 2023 14:45:59 GMT-0700 (Pacific Daylight Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">sure there is, as long as the limit you want happens to be 4GB</td></tr>
  <tr class="msg" id="L166"><td class="ts-cell"><a class="ts" href="#L166" alt="Thu Jun 29 2023 14:46:12 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">&gt;_&lt;</td></tr>
  <tr class="msg" id="L167"><td class="ts-cell"><a class="ts" href="#L167" alt="Thu Jun 29 2023 14:47:19 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">PS: Would it be possible to bribe someone for that limit to be implemented though? 
(it would allow me to throw away hundreds of LoC probably)</td></tr>
  <tr class="msg" id="L168"><td class="ts-cell"><a class="ts" href="#L168" alt="Thu Jun 29 2023 14:49:28 GMT-0700 (Pacific Daylight Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm actually not sure what would be involved. I know that we've had a lot of trouble in the past where when you start to get closer to the limit, we start GC-thrashing, when it would be better for Firefox to just crash. So it's not quite as simple as setting a number.</td></tr>
  <tr class="msg" id="L169"><td class="ts-cell"><a class="ts" href="#L169" alt="Thu Jun 29 2023 14:50:15 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">GC thrashing gets ugly. Hangs your browser, sometimes hangs your system.</td></tr>
  <tr class="msg" id="L170"><td class="ts-cell"><a class="ts" href="#L170" alt="Thu Jun 29 2023 14:51:11 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">makes sense</td></tr>
  <tr class="msg" id="L171"><td class="ts-cell"><a class="ts" href="#L171" alt="Thu Jun 29 2023 14:52:09 GMT-0700 (Pacific Daylight Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">and now I realize, that it wouldn't help me much anyway, since I need per zone(realm? global?) heap limit as well...</td></tr>
  <tr class="msg" id="L172"><td class="ts-cell"><a class="ts" href="#L172" alt="Thu Jun 29 2023 14:54:31 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">on our side, per Zone probably wouldn't be any more work</td></tr>
  <tr class="msg" id="L173"><td class="ts-cell"><a class="ts" href="#L173" alt="Thu Jun 29 2023 14:55:00 GMT-0700 (Pacific Daylight Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">per-Realm or per-compartment would be much harder</td></tr>
  <tr class="msg" id="L174"><td class="ts-cell"><a class="ts" href="#L174" alt="Thu Jun 29 2023 15:02:19 GMT-0700 (Pacific Daylight Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">checked the code: it's per realm (of course :D)</td></tr>
  <tr class="msg" id="L175"><td class="ts-cell"><a class="ts" href="#L175" alt="Thu Jun 29 2023 15:03:32 GMT-0700 (Pacific Daylight Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">hm...</td></tr>
  <tr class="msg" id="L176"><td class="ts-cell"><a class="ts" href="#L176" alt="Thu Jun 29 2023 15:04:22 GMT-0700 (Pacific Daylight Time)">22:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">but each realm is associated with a single zone, right? so it actually doesnt really matter much if it's zone or realm for allocation counting</td></tr>
  <tr class="msg" id="L177"><td class="ts-cell"><a class="ts" href="#L177" alt="Thu Jun 29 2023 15:05:29 GMT-0700 (Pacific Daylight Time)">22:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">(during GC I iterate through realms to counts my heap allocs, but in the end they are GC'd via PrepareZoneForGC(js::GetRealmZone()))</td></tr>
  <tr class="msg" id="L178"><td class="ts-cell"><a class="ts" href="#L178" alt="Thu Jun 29 2023 15:19:15 GMT-0700 (Pacific Daylight Time)">22:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">It's up to your embedding. A Zone can have many Realms, but you could also create a new Zone for every Realm you create.</td></tr>
  <tr class="msg" id="L179"><td class="ts-cell"><a class="ts" href="#L179" alt="Thu Jun 29 2023 15:20:39 GMT-0700 (Pacific Daylight Time)">22:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">The full picture: JSRuntime contains some number of Zones, each containing some number of compartments, each containing some number of Realms, and a Realm is 1-1 with a JS global object.</td></tr>
  <tr class="msg" id="L180"><td class="ts-cell"><a class="ts" href="#L180" alt="Thu Jun 29 2023 15:22:51 GMT-0700 (Pacific Daylight Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">JSRuntime is a thread that can run JS. Zone is the unit of GC collection. A compartment is a security boundary (not Spectre-proof security or anything strong like that, just a place to apply security rules and be assured that objects don't leak across compartment boundaries.) A Realm is a global and all of its constructor functions and properties etc.</td></tr>

</tbody></table></div></div></div>
</body></html>