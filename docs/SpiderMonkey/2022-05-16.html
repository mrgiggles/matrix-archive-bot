<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-05-16</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-05-16<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-05-15" class="nav-link"><span>prev</span></a>
<a href="2022-05-17" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sun May 15 2022 20:44:11 GMT-0700 (Pacific Daylight Time)">03:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I have a C++ class called Node that forms a tree structure:

class Node
{
    std::vector&lt;std::shared_ptr&lt;Node&gt;&gt; children;
};</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sun May 15 2022 20:44:20 GMT-0700 (Pacific Daylight Time)">03:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I want JS to mirror that tree structure, so I'm adding a JS::Object to the Node:

class Node
{
    std::vector&lt;std::shared_ptr&lt;Node&gt;&gt; children;
    JS::RootedObject jsObj, globalObj;
};</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sun May 15 2022 20:44:35 GMT-0700 (Pacific Daylight Time)">03:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">But JS::Rooted crashes pretty quickly here, I think because the tree violates the FIFO ordering, so I have to use JS::Heap instead. I've read through the documents on how to do this, and I think I have a basic grasp of how to do tracing. I've written a small prototype, and I'd really appreciate if someone could take a look at it and see if it make sense. The main idea is to store a C++ heap-allocated weak_ptr&lt;Node&gt;* in the reserve slot of jsObj. Once the Node class expires, the weak_ptr will return null. I can then use this logic to help with tracing (and clean up the heap-allocation in the finalize callback). I think this works in theory, but I'm not sure if I've gotten the trace functions right.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sun May 15 2022 20:45:52 GMT-0700 (Pacific Daylight Time)">03:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Here is the code. It would be great if someone could give me feedback. <a href="https://paste.mozilla.org/NinVCjxX">https://paste.mozilla.org/NinVCjxX</a></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon May 16 2022 00:21:49 GMT-0700 (Pacific Daylight Time)">07:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: the paste expired.  by default the paste expires in one hour,  you can change when posting</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon May 16 2022 00:55:24 GMT-0700 (Pacific Daylight Time)">07:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">That's weird, I thought I set it to a week. Here it is again: <a href="https://paste.mozilla.org/F4C2Efea">https://paste.mozilla.org/F4C2Efea</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon May 16 2022 00:58:21 GMT-0700 (Pacific Daylight Time)">07:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">BTW, I realize that the normal way to trace a tree structure would be to do it recursively, where each node traces its children. But this is a lot of work. I was hoping that the weak_ptr method avoids having to do this, but it's quite likely that I'm not thinking about it in the right way. </td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon May 16 2022 01:12:30 GMT-0700 (Pacific Daylight Time)">08:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Assuming many <code>Node</code> instances are created, <code>JS_InitClass</code> isn't what you need</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon May 16 2022 01:13:11 GMT-0700 (Pacific Daylight Time)">08:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's a function to create the prototype and constructor (e.g. JS <code>Map</code> itself), and not for creating instance (e.g. <code>new Map(...)</code>)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon May 16 2022 01:14:28 GMT-0700 (Pacific Daylight Time)">08:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS_InitClass</code> should be created once, and for each instance, you want <code>JS_NewObjectWithGivenProto</code></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon May 16 2022 01:14:52 GMT-0700 (Pacific Daylight Time)">08:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">passing the prototype object created by <code>JS_InitClass</code></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon May 16 2022 01:24:09 GMT-0700 (Pacific Daylight Time)">08:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Thanks for pointing this out. In the real code, I was using JS_InitClass() to specify native functions also. But I didn't realize that it should only be called once.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon May 16 2022 01:24:20 GMT-0700 (Pacific Daylight Time)">08:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I suppose the word "init" makes that obvious.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon May 16 2022 01:31:05 GMT-0700 (Pacific Daylight Time)">08:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">What about the tracing using weak_ptrs? Will this work or not?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon May 16 2022 01:40:03 GMT-0700 (Pacific Daylight Time)">08:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sorry, I'll slowly go through the code</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon May 16 2022 01:42:58 GMT-0700 (Pacific Daylight Time)">08:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the trace part looks good</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon May 16 2022 01:43:47 GMT-0700 (Pacific Daylight Time)">08:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Now you need to "root" the root node, by storing it in <code>JS::Rooted</code></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon May 16 2022 01:43:57 GMT-0700 (Pacific Daylight Time)">08:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so that <code>trace</code> method is called for the root node</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon May 16 2022 01:44:13 GMT-0700 (Pacific Daylight Time)">08:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and the tree is recursively traced automatically</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon May 16 2022 01:44:50 GMT-0700 (Pacific Daylight Time)">08:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS::Rooted&lt;Node&gt; rootNode(cx, std::make_shared&lt;Node&gt;(cx, glob));</code> or something</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon May 16 2022 01:45:05 GMT-0700 (Pacific Daylight Time)">08:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">instead of <code>auto rootNode = ...</code></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon May 16 2022 01:46:41 GMT-0700 (Pacific Daylight Time)">08:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">You're right, I haven't though the root node through properly yet. It's stored as a Rooted&lt;&gt; in the main() scope, but then as a Heap&lt;&gt; in the Node class. I'll need to sort this out.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon May 16 2022 01:48:27 GMT-0700 (Pacific Daylight Time)">08:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Also, if you have a <code>JSObject*</code>, you can get the corresponding global object by <a href="https://searchfox.org/mozilla-central/rev/da6a85e615827d353e5ca0e05770d8d346b761a9/js/public/GlobalObject.h#32-37"><code>JS::GetNonCCWObjectGlobal</code></a></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon May 16 2022 01:48:33 GMT-0700 (Pacific Daylight Time)">08:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, no need to store it separately</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon May 16 2022 01:48:55 GMT-0700 (Pacific Daylight Time)">08:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Right, that will make it much simpler.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon May 16 2022 01:50:06 GMT-0700 (Pacific Daylight Time)">08:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, if the Node isn't going to be touched by multiple globals, <a href="https://searchfox.org/mozilla-central/rev/da6a85e615827d353e5ca0e05770d8d346b761a9/js/public/GlobalObject.h#30"><code>JS::CurrentGlobalOrNull</code></a> on the <code>JSContext*</code> will return the same thing</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon May 16 2022 01:50:08 GMT-0700 (Pacific Daylight Time)">08:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Just to be clear, I haven't written this to trace the tree recursively. Instead, I'm just having each Node's jsObj to check it's reserve-slot weak_ptr is valid, and if so, to trace that node. As far as I can tell, this should work, but it's entirely possible that  I'm thinking about it in the wrong way.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon May 16 2022 01:51:21 GMT-0700 (Pacific Daylight Time)">08:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that works.  you don't need to manually trace recursively</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon May 16 2022 01:52:06 GMT-0700 (Pacific Daylight Time)">08:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">each object's <code>trace</code> method just needs to call <code>JS::TraceEdge</code> for its edges</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon May 16 2022 01:52:54 GMT-0700 (Pacific Daylight Time)">08:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, wait</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon May 16 2022 01:53:12 GMT-0700 (Pacific Daylight Time)">08:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that's not really true here</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon May 16 2022 01:53:31 GMT-0700 (Pacific Daylight Time)">08:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">how is the tree represented?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon May 16 2022 01:54:57 GMT-0700 (Pacific Daylight Time)">08:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you need to call trace for <code>children</code> elements</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon May 16 2022 01:55:39 GMT-0700 (Pacific Daylight Time)">08:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><del>unless the tree edge is also represented in JS object's side</del></td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon May 16 2022 01:59:31 GMT-0700 (Pacific Daylight Time)">08:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">So when any single node is traced, you have to TraceEdge() it and all of its children also?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon May 16 2022 02:07:45 GMT-0700 (Pacific Daylight Time)">09:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what you need to do is, make the GC system aware of all objects you want them to be alive</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon May 16 2022 02:08:38 GMT-0700 (Pacific Daylight Time)">09:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, make it so that leaf node is traced when root node is traced</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon May 16 2022 02:09:49 GMT-0700 (Pacific Daylight Time)">09:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I was assuming that the GC would query an (through tracing) object before it marks it for deletion. But it sounds like this is not the case?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon May 16 2022 02:10:16 GMT-0700 (Pacific Daylight Time)">09:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">let me describe</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon May 16 2022 02:11:29 GMT-0700 (Pacific Daylight Time)">09:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if leaf node's JS Object is reachable by walking JS properties from root node's JS Object, then the leaf node'S JS Object is kept alive as long as root node's JS Object is kept alive by <code>JS::Rooted</code></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon May 16 2022 02:12:14 GMT-0700 (Pacific Daylight Time)">09:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the connection between them is represented only by C++ side, then GC cannot reach the leaf node</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon May 16 2022 02:12:51 GMT-0700 (Pacific Daylight Time)">09:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, it really depends on how and where the structure is represented</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon May 16 2022 02:17:17 GMT-0700 (Pacific Daylight Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">So the root note, which is stored in JS::Rooted, is the only one that the GC is going to query, and it's up to me to notify the GC of all the rest. Is that right?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Mon May 16 2022 02:26:30 GMT-0700 (Pacific Daylight Time)">09:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so there are 2 cases (assuming the edge in the C++ side is always there)</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Mon May 16 2022 02:27:21 GMT-0700 (Pacific Daylight Time)">09:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the current <code>trace</code> works only when there's edge also in JS side</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Mon May 16 2022 02:27:47 GMT-0700 (Pacific Daylight Time)">09:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if there isn't, you need to trace children, to make sure the leaf node is reachable</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Mon May 16 2022 02:29:09 GMT-0700 (Pacific Daylight Time)">09:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I see. It looks like "edge" means more than I thought it did.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Mon May 16 2022 02:41:30 GMT-0700 (Pacific Daylight Time)">09:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">So that recursive function is going to be expensive if the tree gets big. I'm now thinking that it might be better to have an array which stores a pointer to every JSObject from the tree. I'll keep it outside of the Node class, pass it in as a reference, and then add and remove elements in the Node constructors / destructors. Then  I'll use JS_AddExtraGCRootsTracer() to trace all elements at once. Will this work?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Mon May 16 2022 02:46:29 GMT-0700 (Pacific Daylight Time)">09:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, I guess my understanding about <code>JS::Heap</code> was wrong</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Mon May 16 2022 02:46:50 GMT-0700 (Pacific Daylight Time)">09:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/da6a85e615827d353e5ca0e05770d8d346b761a9/js/public/RootingAPI.h#292-293">https://searchfox.org/mozilla-central/rev/da6a85e615827d353e5ca0e05770d8d346b761a9/js/public/RootingAPI.h#292-293</a></td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Mon May 16 2022 02:48:41 GMT-0700 (Pacific Daylight Time)">09:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if <code>JS::Heap</code> itself needs trace call, then you always need to trace children in C++ side</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Mon May 16 2022 02:49:08 GMT-0700 (Pacific Daylight Time)">09:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">GC people: please correct me ^</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Mon May 16 2022 03:03:35 GMT-0700 (Pacific Daylight Time)">10:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I'm a bit confused now, since I'm not sure how the last thing you said is different than the thing before...</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Mon May 16 2022 03:06:42 GMT-0700 (Pacific Daylight Time)">10:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">GC can move the object during compaction (am I correct?), and in that case all pointers that point the object need to be rewritten to point the new one</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Mon May 16 2022 03:07:43 GMT-0700 (Pacific Daylight Time)">10:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">for raw pointer, calling <code>Trace*</code> function on the pointer (the pointer to the pointer) takes care the rewrite</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Mon May 16 2022 03:07:51 GMT-0700 (Pacific Daylight Time)">10:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm not sure what's the case for <code>JS::Heap</code></td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Mon May 16 2022 03:08:24 GMT-0700 (Pacific Daylight Time)">10:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(I haven't used it until now :P</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Mon May 16 2022 03:09:17 GMT-0700 (Pacific Daylight Time)">10:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, let's wait for GC people</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Mon May 16 2022 03:25:34 GMT-0700 (Pacific Daylight Time)">10:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">OK. It might be that I don't have to understand all the details of GC, so long as I know what is the best way of tracing a tree structure like the one I've outlined. My weak_ptr idea obviously didn't work. So I can either trace the tree recursively, or I can try my idea of storing all JSObjects in one big vector and tracing them from there. This seems easier, but it wouldn't preserve the "shape" of the tree (i.e. the right order of the nodes). I'm wondering if this would work or not?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Mon May 16 2022 03:29:20 GMT-0700 (Pacific Daylight Time)">10:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think, simpler way is to store the <code>JSObject</code> pointer to each node and recursively <code>trace</code>, as a first step. And once the recursive <code>trace</code> call becomes performance problem, optimize away the recursive call</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Mon May 16 2022 03:29:31 GMT-0700 (Pacific Daylight Time)">10:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">by converting it into a loop</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Mon May 16 2022 03:30:15 GMT-0700 (Pacific Daylight Time)">10:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">given it's tree, not random graph, the loop won't be too much complicated</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Mon May 16 2022 06:23:36 GMT-0700 (Pacific Daylight Time)">13:23</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-2" title="@nbp:mozilla.org">nbp</span></div></td><td class="msg-cell">attempts to figure out how a set of patches, adding disabled code, unrelated to the enclosing scope, can cause the enclosing scope to be null.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Mon May 16 2022 06:41:41 GMT-0700 (Pacific Daylight Time)">13:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">uh, <code>JSAtom.h</code> doesn't define <code>JSAtom</code>... :/</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Mon May 16 2022 06:44:32 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger 💉💉</span>&gt;</div></td><td class="msg-cell">I'm guessing it's in JSString.h</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Mon May 16 2022 06:44:42 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Does not even include the header which is declaring it :P</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Mon May 16 2022 06:44:57 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger 💉💉</span>&gt;</div></td><td class="msg-cell">Only include what you use! :)</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Mon May 16 2022 06:47:40 GMT-0700 (Pacific Daylight Time)">13:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Sounds like a C code base :P</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Mon May 16 2022 06:48:11 GMT-0700 (Pacific Daylight Time)">13:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">where the methods are not defined with the type.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Mon May 16 2022 07:04:47 GMT-0700 (Pacific Daylight Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">any opinion about removing <code>NamespaceImports.h</code> ?  I'm not sure if those aliases really help.  and during checking IWYU, the existence of that alias is confusing</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Mon May 16 2022 07:40:12 GMT-0700 (Pacific Daylight Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I guess this makes sense if this is to plan a renaming.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Mon May 16 2022 07:40:47 GMT-0700 (Pacific Daylight Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what's renaming?</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Mon May 16 2022 08:10:29 GMT-0700 (Pacific Daylight Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">the JS namespace into js namespace, or the opposite.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Mon May 16 2022 08:11:00 GMT-0700 (Pacific Daylight Time)">15:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I never understood why we had both, and I guess most people are confused by it.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Mon May 16 2022 08:11:26 GMT-0700 (Pacific Daylight Time)">15:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">If this was to have a public/private interface, I think this is a bad naming choice.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Mon May 16 2022 08:11:40 GMT-0700 (Pacific Daylight Time)">15:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, is it about renaming <code>js</code> to <code>JS::details</code> or something ?  I think I saw similar discussion</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Mon May 16 2022 08:12:23 GMT-0700 (Pacific Daylight Time)">15:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">That would be my guess, that this file is a migration in-progress.</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Mon May 16 2022 08:19:08 GMT-0700 (Pacific Daylight Time)">15:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, I'll think about it</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Mon May 16 2022 12:01:15 GMT-0700 (Pacific Daylight Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: I'm not totally following. What ownership model do you want? Does a <code>Node</code> always keep its <code>JSObject*</code> alive? Does a <code>JSObject*</code> always keep its <code>Node</code> alive?</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Mon May 16 2022 12:03:21 GMT-0700 (Pacific Daylight Time)">19:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm skeptical that a <code>weak_ptr</code> based approach is going to be any easier than just having a node trace all of its children. As <span class="nick-15">arai</span> said, you need to trace GC pointers anyway to handle compaction, even if they're weak.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Mon May 16 2022 12:05:43 GMT-0700 (Pacific Daylight Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and optimizing by putting things into an array won't work if they're direct pointers, since you'd still have to update the pointer in the <code>Node</code>. A layer of indirection would work (eg if the actual pointers are in an array and the <code>Node</code> stores an index into the array, or the address of an array slot. Or maybe shared_ptr provides this indirection; I don't know how they work. Can you update the pointer in one <code>shared_ptr</code> and another <code>shared_ptr</code> will see the update?)</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Mon May 16 2022 12:06:29 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but I would expect tracing to happen far less often than accessing these things, so for performance it seems like it'd be better to have as little indirection as possible, which means tracing all children (and hence, the whole tree).</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Mon May 16 2022 12:06:37 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it's also the most straightforward to implement</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Mon May 16 2022 12:07:49 GMT-0700 (Pacific Daylight Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but JS reflectors are always going to be somewhat messy, unfortunately. As <span class="nick-15">arai</span> said, you have pointers between the C++ and JS heaps, and you have to tell the GC what's going on <em>somehow</em>.</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Mon May 16 2022 12:11:31 GMT-0700 (Pacific Daylight Time)">19:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sfink: in term of tracing and compaction, does JS::Heap do something special compared to raw pointer?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Mon May 16 2022 12:12:53 GMT-0700 (Pacific Daylight Time)">19:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the type system kind of makes you use <code>JS::Heap</code> in order to be able to trace things, and <code>JS::Heap</code> implements post-write barriers and read barriers (for the CC).</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Mon May 16 2022 12:13:11 GMT-0700 (Pacific Daylight Time)">19:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm wondering why I haven't touched JS::Heap class until now.  is it for embedding?</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Mon May 16 2022 12:13:27 GMT-0700 (Pacific Daylight Time)">19:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, but that includes Gecko</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Mon May 16 2022 12:14:50 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it used to be called <code>HeapPtr</code>, I think? We swapped names around in a confusing way. Inside SpiderMonkey you normally don't need or want the read barrier.</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Mon May 16 2022 12:15:12 GMT-0700 (Pacific Daylight Time)">19:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in non-Gecko embedding without CC, does JS::Heap help something compared to raw pointer?</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Mon May 16 2022 12:15:41 GMT-0700 (Pacific Daylight Time)">19:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it gives you the post-write barrier that is needed for generational GC</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Mon May 16 2022 12:16:20 GMT-0700 (Pacific Daylight Time)">19:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">as in, if you store a pointer to the nursery, it registers it in a store buffer so it can be updated during a minor GC (nursery collection)</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Mon May 16 2022 12:18:07 GMT-0700 (Pacific Daylight Time)">19:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>JS::Heap</code> does not have a pre-write barrier, which ordinarily is necessary for incremental GC. But that's just because the read barrier is "stronger"; it maintains a stronger invariant than the pre-write barrier would, and you can't really write something somewhere unless you've read it first.</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Mon May 16 2022 12:19:14 GMT-0700 (Pacific Daylight Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is post-write barrier also necessary for SpiderMonkey internal that uses raw pointer instead? or the situation is different for embedding?</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Mon May 16 2022 12:19:22 GMT-0700 (Pacific Daylight Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/e567185fa464270f94430e7cf62d134f4df9a69f/js/public/RootingAPI.h#269-299">This</a> should probably be an SMDOC.</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Mon May 16 2022 12:19:37 GMT-0700 (Pacific Daylight Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, the post-write barrier is needed internally.</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Mon May 16 2022 12:20:14 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">within SpiderMonkey, you'd probably use <code>GCPtr</code> for that (which doesn't have the read barrier)</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Mon May 16 2022 12:20:38 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">er, actually, the docs say <code>HeapPtr</code> is more common.</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Mon May 16 2022 12:21:00 GMT-0700 (Pacific Daylight Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it's certainly safer; you're not restricted to pointers whose lifetime is fully controlled by the GC like <code>GCPtr</code> requires</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Mon May 16 2022 12:21:25 GMT-0700 (Pacific Daylight Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/e567185fa464270f94430e7cf62d134f4df9a69f/js/src/gc/Barrier.h#56-60,78-80">https://searchfox.org/mozilla-central/rev/e567185fa464270f94430e7cf62d134f4df9a69f/js/src/gc/Barrier.h#56-60,78-80</a></td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Mon May 16 2022 12:21:44 GMT-0700 (Pacific Daylight Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that sounds like I missed the necessary post-write barrier in some case...</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Mon May 16 2022 12:22:19 GMT-0700 (Pacific Daylight Time)">19:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">how and where? Usually you can't miss it, because the <code>Trace*</code> APIs require a barriered pointer</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Mon May 16 2022 12:24:13 GMT-0700 (Pacific Daylight Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">maybe I'm mixing up with the raw pointer of non-GC struct with trace method</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Mon May 16 2022 12:24:37 GMT-0700 (Pacific Daylight Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I will check</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Mon May 16 2022 12:25:56 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that is exactly where I always get confused when I'm looking at this stuff</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Mon May 16 2022 12:25:57 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: speaking of post barriers, could you take a look at the needinfo I left for you at some point? 😀</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Mon May 16 2022 12:26:12 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-12" title="@sfink:mozilla.org">sfink</span></div></td><td class="msg-cell">looks guiltily to the side</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Mon May 16 2022 12:29:51 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/e567185fa464270f94430e7cf62d134f4df9a69f/js/src/builtin/Promise.cpp#141-161">https://searchfox.org/mozilla-central/rev/e567185fa464270f94430e7cf62d134f4df9a69f/js/src/builtin/Promise.cpp#141-161</a></td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Mon May 16 2022 12:30:12 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(...reading...) I really ought to be better about mccr8 needinfos. He usually does the bulk of the hard investigation work up front!</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Mon May 16 2022 12:30:26 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Hah.</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Mon May 16 2022 12:31:17 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, it looks like the difference is <code>TraceRoot</code> vs <code>TraceEdge</code></td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Mon May 16 2022 12:32:10 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">where are these <code>PromiseCapability</code>s used? If they're only used as roots, this is fine.</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Mon May 16 2022 12:33:41 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, it's stored only in <code>Rooted</code></td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Mon May 16 2022 12:35:42 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess while they're in a reaction record, the pointer values are in separate slots, not a <code>PromiseCapability</code> struct.</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Mon May 16 2022 12:39:24 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">would something break the compile if there were a <code>JS::Heap&lt;PromiseCapability*&gt;</code> field somewhere? I should know, but I'm wondering if this a hole in our type-based protection. Though you'd get a dynamic assert pretty quickly, so that's probably enough.</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Mon May 16 2022 12:39:24 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, reaction record doesn't store the capability object, but stores the promise and handler separately</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Mon May 16 2022 12:39:40 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">let me check</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Mon May 16 2022 12:40:08 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>TraceRoot</code> calls <code>AssertRootMarkingPhase</code>, so it would assert</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Mon May 16 2022 12:40:41 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: <a href="https://github.com/firefox-devtools/profiler/issues/3713">https://github.com/firefox-devtools/profiler/issues/3713</a></td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Mon May 16 2022 12:44:20 GMT-0700 (Pacific Daylight Time)">19:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: it hits <a href="https://searchfox.org/mozilla-central/rev/e567185fa464270f94430e7cf62d134f4df9a69f/js/public/RootingAPI.h#304-305">https://searchfox.org/mozilla-central/rev/e567185fa464270f94430e7cf62d134f4df9a69f/js/public/RootingAPI.h#304-305</a></td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Mon May 16 2022 12:45:13 GMT-0700 (Pacific Daylight Time)">19:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah, right. It's even further from working. Ok, that's fine then.</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Mon May 16 2022 12:45:16 GMT-0700 (Pacific Daylight Time)">19:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">thanks for checking!</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Mon May 16 2022 12:45:32 GMT-0700 (Pacific Daylight Time)">19:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">thank you for the explanation :)</td></tr>

</tbody></table></div></div></div>
</body></html>