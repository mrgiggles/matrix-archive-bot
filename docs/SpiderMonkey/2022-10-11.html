<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-10-11</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-10-11<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-10-10" class="nav-link"><span>prev</span></a>
<a href="2022-10-12" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Oct 11 2022 00:43:19 GMT-0700 (Pacific Daylight Time)">07:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@big-r81:mozilla.org">big-r</span>&gt;</div></td><td class="msg-cell">Hi, is there a way to get the used spidermonkey version? Something like MAJOR.MINOR.PATCH version?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Oct 11 2022 00:52:21 GMT-0700 (Pacific Daylight Time)">07:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">big-r</span>: see <code>JS_GetImplementationVersion</code>, it returns a string</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Oct 11 2022 01:08:15 GMT-0700 (Pacific Daylight Time)">08:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@big-r81:mozilla.org">big-r</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-4">big-r</span>: see <code>JS_GetImplementationVersion</code>, it returns a string</blockquote></mx-reply>thank you üôè</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Oct 11 2022 04:44:43 GMT-0700 (Pacific Daylight Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">yulia | sick</span>: (too bad that you're sick). Ah, so the CSP issue was resolved in a reasonable way.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Oct 11 2022 05:08:05 GMT-0700 (Pacific Daylight Time)">12:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-5">yulia | sick</span>: (too bad that you're sick). Ah, so the CSP issue was resolved in a reasonable way.</blockquote></mx-reply>So who is going to take on changing the spec and tests?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Oct 11 2022 05:13:04 GMT-0700 (Pacific Daylight Time)">12:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Hmm, actually, I'm not sure what <a href="https://github.com/w3c/webappsec-csp/issues/336#issuecomment-1273072329">https://github.com/w3c/webappsec-csp/issues/336#issuecomment-1273072329</a> is trying to say.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Oct 11 2022 05:15:46 GMT-0700 (Pacific Daylight Time)">12:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Yeah, I am also a bit confused. The first sentence seems to contradict the rest and they just closed the issue.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Oct 11 2022 06:21:10 GMT-0700 (Pacific Daylight Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@yulia:mozilla.org">yulia | sick</span>&gt;</div></td><td class="msg-cell">hm. I thought it might be clear</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Oct 11 2022 06:22:04 GMT-0700 (Pacific Daylight Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@yulia:mozilla.org">yulia | sick</span>&gt;</div></td><td class="msg-cell">@smaug @evilpie or at least, I understood it as follows: this is related to the fetch client settings object, which includes the policy container, and this comes from the window. All child modules are fetched with the same one as the initial module</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Oct 11 2022 06:22:43 GMT-0700 (Pacific Daylight Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@yulia:mozilla.org">yulia | sick</span>&gt;</div></td><td class="msg-cell">if it isn't clear, lets reopen</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Oct 11 2022 06:23:26 GMT-0700 (Pacific Daylight Time)">13:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@yulia:mozilla.org">yulia | sick</span>&gt;</div></td><td class="msg-cell">I was about to start work on our client source object to make it possible to fetch with the window settings object, while having the client work correctly as before. It looks like it will be a non-insignificant amount of work</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Oct 11 2022 06:25:35 GMT-0700 (Pacific Daylight Time)">13:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Frankly I am not convinced we should be blocking es6 modules in workers on this. </td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Oct 11 2022 06:28:26 GMT-0700 (Pacific Daylight Time)">13:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@yulia:mozilla.org">yulia | sick</span>&gt;</div></td><td class="msg-cell">Anne's response makes sense in terms of spec expectation, but in terms of what we have -- we <em>do</em> have the csp from the worker response in the channel</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Oct 11 2022 06:28:43 GMT-0700 (Pacific Daylight Time)">13:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@yulia:mozilla.org">yulia | sick</span>&gt;</div></td><td class="msg-cell">and if i change the test in question to rely on the worker csp, it passes</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Oct 11 2022 06:29:49 GMT-0700 (Pacific Daylight Time)">13:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@yulia:mozilla.org">yulia | sick</span>&gt;</div></td><td class="msg-cell">(that is, have that test apply the same requirements to static imports as it does to dynamic imports)</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Oct 11 2022 06:57:52 GMT-0700 (Pacific Daylight Time)">13:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@yulia:mozilla.org">yulia | sick</span>&gt;</div></td><td class="msg-cell">honestly I don't understand the justification for it, but i agree that this is what the spec currently says</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Oct 11 2022 07:08:20 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>Hey, does anyone happen to know how to clone a OwningArrayBufferViewOrArrayBuffer, or what is the best practice? I am implementing a Web API that needs to copy a OwningArrayBufferViewOrArrayBuffer from one to another. I have some code that can be compiled and run. But I am not sure if it really works. I am not sure if the ownership of an allocated memory is set correctly (I have no idea how JSObject and its friends work). TBH, I don't really know what I am doing üòÖ:</p>
<pre><code class="language-cpp">/* The following are helpers for CloneBuffer */
template &lt;class T&gt;
static Result&lt;Tuple&lt;RangedPtr&lt;uint8_t&gt;, size_t&gt;, nsresult&gt; GetArrayBufferData(
    const T&amp; aBuffer) {
  // Get buffer's data and length before using it.
  aBuffer.ComputeState();

  CheckedInt&lt;size_t&gt; byteLength(sizeof(typename T::element_type));
  byteLength *= aBuffer.Length();
  if (NS_WARN_IF(!byteLength.isValid())) {
    return Err(NS_ERROR_INVALID_ARG);
  }

  return MakeTuple(RangedPtr(aBuffer.Data(), byteLength.value()),
                   byteLength.value());
}

static Result&lt;Tuple&lt;RangedPtr&lt;uint8_t&gt;, size_t&gt;, nsresult&gt; GetArrayBufferData(
    const dom::OwningArrayBufferViewOrArrayBuffer&amp; aBuffer) {
  if (aBuffer.IsArrayBufferView()) {
    return GetArrayBufferData(aBuffer.GetAsArrayBufferView());
  }

  MOZ_ASSERT(aBuffer.IsArrayBuffer());
  return GetArrayBufferData(aBuffer.GetAsArrayBuffer());
}

/* The core part to clone a  OwningArrayBufferViewOrArrayBuffer */
static Result&lt;OwningArrayBufferViewOrArrayBuffer, nsresult&gt; CloneBuffer(
    const GlobalObject&amp; aGlobal,
    const OwningArrayBufferViewOrArrayBuffer&amp; aBuffer) {
  auto r = GetArrayBufferData(aBuffer);
  if (r.isErr()) {
    return Err(r.unwrapErr());
  }

  Tuple&lt;RangedPtr&lt;uint8_t&gt;, size_t&gt; bufInfo = r.unwrap();
  RangedPtr&lt;uint8_t&gt; ptr(Get&lt;0&gt;(bufInfo));
  CheckedUint32 length(Get&lt;1&gt;(bufInfo) / sizeof(uint8_t));
  if (!length.isValid()) {
    return Err(NS_ERROR_UNEXPECTED);
  }

  JSObject* obj =
      ArrayBuffer::Create(aGlobal.Context(), length.value(), ptr.get());
  if (NS_WARN_IF(!obj)) {
    return Err(NS_ERROR_OUT_OF_MEMORY);
  }

  JS::Rooted&lt;JS::Value&gt; value(aGlobal.Context());
  value.setObject(*obj);

  OwningArrayBufferViewOrArrayBuffer buffer;
  if (!buffer.Init(aGlobal.Context(), value)) {
    return Err(NS_ERROR_UNEXPECTED);
  }

  return buffer;
}
</code></pre>
</blockquote></mx-reply>When you say clone... I guess I'm curious what the spec text you're trying to implement looks like</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Oct 11 2022 07:16:24 GMT-0700 (Pacific Daylight Time)">14:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I assume something in Web Codecs: <a href="https://w3c.github.io/webcodecs/">https://w3c.github.io/webcodecs/</a>, probably something on the <code>VideoFrame</code>, <code>clone()</code> maybe? <span class="nick-13">chunmin</span> is west coast so will wake up soon</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Oct 11 2022 07:17:34 GMT-0700 (Pacific Daylight Time)">14:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Ok. I don't want to leave them hanging, but also want to make sure what gets built it fit-for-purpose. Depending on on the text, we may want to build the support into the platform rather than have a one-of implementation</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Oct 11 2022 09:33:18 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Are all test262 JavaScript related?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Oct 11 2022 09:39:54 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: The 262 is from ECMA-262, which is the JS spec, so it would be weird if there was something non-JS-related in there</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Oct 11 2022 09:53:52 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@chunmin:mozilla.org">chunmin</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span> , <span class="nick-2">padenot</span>: The web API is WebCodecs. The clone from one <code>OwningArrayBufferViewOrArrayBuffer</code> to another happens at the  <a href="https://w3c.github.io/webcodecs/#clone-configuration"><code>clone-configuration</code></a>  step (4-1-1) in <a href="https://w3c.github.io/webcodecs/#dom-videodecoder-isconfigsupported"><code>VideoDecoder::isConfigSupported</code></a>. <a href="https://w3c.github.io/webcodecs/#dictdef-videodecoderconfig"><code>VideoDecoderConfig</code></a> has a <code>BufferSource</code> member, which is translated to <code>OwningArrayBufferViewOrArrayBuffer</code> in gecko, so I am trying to figure out how to clone a <code>OwningArrayBufferViewOrArrayBuffer</code>.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Oct 11 2022 10:35:13 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">mgaudet</span> , <span class="nick-2">padenot</span>: The web API is WebCodecs. The clone from one <code>OwningArrayBufferViewOrArrayBuffer</code> to another happens at the  <a href="https://w3c.github.io/webcodecs/#clone-configuration"><code>clone-configuration</code></a>  step (4-1-1) in <a href="https://w3c.github.io/webcodecs/#dom-videodecoder-isconfigsupported"><code>VideoDecoder::isConfigSupported</code></a>. <a href="https://w3c.github.io/webcodecs/#dictdef-videodecoderconfig"><code>VideoDecoderConfig</code></a> has a <code>BufferSource</code> member, which is translated to <code>OwningArrayBufferViewOrArrayBuffer</code> in gecko, so I am trying to figure out how to clone a <code>OwningArrayBufferViewOrArrayBuffer</code>.</blockquote></mx-reply>(I have to run for a bit, but to help unblock you a bit: two things to  consider: We have a couple of <a href="https://searchfox.org/mozilla-central/source/js/public/ArrayBuffer.h#273-302">clone functions for ArrayBuffers</a>; not quite sure what the appropriate way to handle views is. Probably need to convert a view to a new array buffer would be my guess, but this isn't quite my area of expertise... sfink?)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Oct 11 2022 10:56:04 GMT-0700 (Pacific Daylight Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>Would someone be able to help me understand exactly what's being described in the comment for JS_IsArrayObject?  What does it mean to return false on "failure" in this case?</p>
<pre><code>/**
 * On success, returns true, setting |*isArray| to true if |value| is an Array
 * object or a wrapper around one, or to false if not.  Returns false on
 * failure.
 *
 * This method returns true with |*isArray == false| when passed an ES6 proxy
 * whose target is an Array, or when passed a revoked proxy.
 */
extern JS_PUBLIC_API bool JS_IsArrayObject(JSContext* cx, JS::HandleValue value,
                                           bool* isArray);
</code></pre>
</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Oct 11 2022 10:58:28 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: there are 3 outcomes</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Oct 11 2022 10:59:39 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><ul>
<li>return true, <code>*isArray = true</code> -&gt; the object is an array (roughly)</li>
<li>return true, <code>*isArray = false</code> -&gt; the object is not an array (roughly)</li>
<li>return false ‚Üí the check caused an exception, or the engine ran out of memory, etc</li>
</ul>
</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Oct 11 2022 11:00:17 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Oh, OK.  It's strange, because JS_IsInt32Array and related methods only have the single return value.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Oct 11 2022 11:01:08 GMT-0700 (Pacific Daylight Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">I would guess that's because those don't allocate any memory or have any opportunity to cause an exception to be thrown</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Oct 11 2022 11:03:26 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Btw, regarding this recurring pattern of JS-related C++ functions returning bool to indicate errors, is there some helper function or macro to avoid the tedious repetition of if statements?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Oct 11 2022 11:04:33 GMT-0700 (Pacific Daylight Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">here's where Rust's <code>?</code> operator is really nice, eh</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Oct 11 2022 11:05:08 GMT-0700 (Pacific Daylight Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Yeah. I mean, I suppose we have short-circuit operators.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Oct 11 2022 11:07:00 GMT-0700 (Pacific Daylight Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><p>my code ends up looking like this usually:</p>
<pre><code class="language-c++">DoSomething1();
if (!JS_Operation1(cx, ...))
  return false;
DoSomething2();
return JS_Operation2(cx, ...) &amp;&amp; JS_Operation3(cx, ...);
</code></pre>
</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Oct 11 2022 11:07:41 GMT-0700 (Pacific Daylight Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Yeah, mine too, more or less.  I tried using some macros to clean things up, but my team mates seem to think that they make code look "like it's from 1997"</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Oct 11 2022 11:07:47 GMT-0700 (Pacific Daylight Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">I make all my functions return bool as well (or null/non-null pointer) and "catch" the exceptions as little as possible</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Oct 11 2022 11:14:59 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">FWIW js/src/jsapi-tests does use such a macro, <code>CHECK(JS_Operation(cx, ...))</code> to make the test fail if the operation returns false</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Oct 11 2022 11:59:22 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">chunmin</span>: hm, there isn't a great answer to this right now. <span class="nick-2">mgaudet</span>' s suggestion of <code>JS::ArrayBufferClone</code> definitely seems like the best thing for the ArrayBuffer case. In your code, it looks like any ArrayBufferView (Uint8Array or whatever) would get "cloned" into an ArrayBuffer, which seems like strange behavior for something called "clone". But it might be ok from the spec language? I couldn't tell.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Oct 11 2022 12:00:59 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the implementation that would make sense to me is probably something like: if it's an ArrayBuffer, use <code>JS::ArrayBufferClone</code>. Otherwise, get the ArrayBuffer from the view and then use <code>JS::ArrayBufferClone</code>. But I'm still looking to find a decent way of retrieving the buffer from an arbitrary view from outside of SpiderMonkey.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Oct 11 2022 12:02:34 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">peterv</span>: what would your recommendation be on cloning a BufferSource object? (Which I guess ends up being <code>OwningArrayBufferViewOrArrayBuffer</code>.) Do we have decent APIs for that yet?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Oct 11 2022 12:03:00 GMT-0700 (Pacific Daylight Time)">19:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'll need to run for a bit. I'll keep looking for something when I get back.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Oct 11 2022 13:05:42 GMT-0700 (Pacific Daylight Time)">20:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">How can I get indexed elements from an array I created with JS_NewArrayObject?</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Oct 11 2022 13:07:35 GMT-0700 (Pacific Daylight Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">oh... I just found "GetElement".  Is that it?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Oct 11 2022 13:41:54 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: yes. although GetPropertyById would work as well, since jsid can be an integer property key</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Oct 11 2022 16:27:27 GMT-0700 (Pacific Daylight Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@chunmin:mozilla.org">chunmin</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">chunmin</span>: hm, there isn't a great answer to this right now. <span class="nick-2">mgaudet</span>' s suggestion of <code>JS::ArrayBufferClone</code> definitely seems like the best thing for the ArrayBuffer case. In your code, it looks like any ArrayBufferView (Uint8Array or whatever) would get "cloned" into an ArrayBuffer, which seems like strange behavior for something called "clone". But it might be ok from the spec language? I couldn't tell.</blockquote></mx-reply><p>Does something like this make more sense?</p>
<pre><code class="language-cpp">static JSObject* GetTypedArrayObject(
    const OwningArrayBufferViewOrArrayBuffer&amp; aBuffer) {
  return aBuffer.IsArrayBuffer() ? aBuffer.GetAsArrayBuffer().Obj()
                                 : aBuffer.GetAsArrayBufferView().Obj();
}

static JSObject* GetArrayBufferObject(
    JSContext* aCx, const OwningArrayBufferViewOrArrayBuffer&amp; aBuffer) {
  if (aBuffer.IsArrayBuffer()) {
    return aBuffer.GetAsArrayBuffer().Obj();
  }

  MOZ_ASSERT(aBuffer.IsArrayBufferView());
  bool isSharedMemory;
  JS::Rooted&lt;JSObject*&gt; obj(aCx, aBuffer.GetAsArrayBufferView().Obj());
  return JS_GetArrayBufferViewBuffer(aCx, obj, &amp;isSharedMemory);
}

static Result&lt;OwningArrayBufferViewOrArrayBuffer, nsresult&gt; CloneBuffer(
    JSContext* aCx, const OwningArrayBufferViewOrArrayBuffer&amp; aBuffer) {
  JSObject* typedArrayObj = GetTypedArrayObject(aBuffer);
  if (NS_WARN_IF(!typedArrayObj)) {
    return Err(NS_ERROR_UNEXPECTED);
  }

  JS::Rooted&lt;JSObject*&gt; arrayBufferObj(aCx, GetArrayBufferObject(aCx, aBuffer));
  if (NS_WARN_IF(!arrayBufferObj)) {
    return Err(NS_ERROR_UNEXPECTED);
  }

  size_t byteOffset = JS_GetTypedArrayByteOffset(typedArrayObj);
  size_t byteLength = JS_GetTypedArrayByteLength(typedArrayObj);
  JS::Rooted&lt;JSObject*&gt; cloned(
      aCx, JS::ArrayBufferClone(aCx, arrayBufferObj, byteOffset, byteLength));
  if (NS_WARN_IF(!cloned)) {
    return Err(NS_ERROR_OUT_OF_MEMORY);
  }

  JS::Rooted&lt;JS::Value&gt; value(aCx, JS::ObjectValue(*cloned));
  OwningArrayBufferViewOrArrayBuffer buffer;
  if (NS_WARN_IF(!buffer.Init(aCx, value))) {
    return Err(NS_ERROR_UNEXPECTED);
  }

  return buffer;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Oct 11 2022 16:47:46 GMT-0700 (Pacific Daylight Time)">23:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">chunmin</span>: Yes! That looks good. I somehow couldn't find <code>JS_GetArrayBufferViewBuffer</code> earlier; that was the missing piece. Note that your offset/length retrieval isn't quite right, since the main function has a <code>typedArrayObj</code> variable that might actually be an <code>ArrayBufferObject</code>. But I think that just means that your <code>GetArrayBufferObject</code> will need outvars for the offset and length (with offset=0 if you already have an ArrrayBuffer).</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Oct 11 2022 16:52:42 GMT-0700 (Pacific Daylight Time)">23:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">generally speaking, it's not a good idea to extract out the data pointer until just before you need it, because it might actually give you a pointer into movable GC memory. So it's better to do what your new code is doing, and leave the data pointer safely held in a <code>JSObject*</code> (or perhaps a <code>JS::ArrayBufferOrView</code> or a subclass from <code>#include "js/experimental/TypedData.h"</code> which just wraps the <code>JSObject*</code>) that will get automatically updated if you happen to do something that GCs. (Or said otherwise: the rooting hazard static analysis will yell at you and our APIs will fight you if you extract the data pointer too early.)</td></tr>

</tbody></table></div></div></div>
</body></html>