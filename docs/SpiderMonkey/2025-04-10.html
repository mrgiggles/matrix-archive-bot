<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-04-10</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-04-10<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-04-09" class="nav-link"><span>prev</span></a>
<a href="2025-04-11" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Apr 09 2025 17:11:58 GMT-0700 (Pacific Daylight Time)">00:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Are you talking about the mozilla::WeakPtr from mfbt? I don't really understand how that works. It's in mfbt, but it uses a bunch of XPCOM stuff, which I didn't think was possible/allowed? I guess it kind of cheats by making it <code>#ifdef MOZILLA_INTERNAL_API</code>, which will be defined for Gecko but not SpiderMonkey.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Apr 09 2025 17:12:18 GMT-0700 (Pacific Daylight Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in short: I'm not sure that will work from within SpiderMonkey, if that's where you were trying to use it from.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Apr 10 2025 08:51:40 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jcristau:mozilla.org">jcristau</span>&gt;</div></td><td class="msg-cell">hi, i'm looking to update the linux worker image in CI, and hitting an almost permanent failure of one of the jit-tests: <a href="https://treeherder.mozilla.org/jobs?repo=try&amp;resultStatus=testfailed%2Cbusted%2Cexception%2Cretry%2Cusercancel%2Crunning%2Cpending%2Crunnable&amp;revision=b36e2770fb2a125aeb7e204e804984f217c10f22&amp;searchStr=jit">https://treeherder.mozilla.org/jobs?repo=try&amp;resultStatus=testfailed%2Cbusted%2Cexception%2Cretry%2Cusercancel%2Crunning%2Cpending%2Crunnable&amp;revision=b36e2770fb2a125aeb7e204e804984f217c10f22&amp;searchStr=jit</a>
on ccov, js/src/jit-test/tests/large-arraybuffers/arraybuffer-transfer.js looks like it uses up ~16g and gets killed by the kernel.
this behaviour also exists to an extent on the current worker, although it doesn't quite get to OOM.
is there an easy way to reduce the memory usage a bit for that test?  if not, would it be ok to skip it on the code coverage build?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Apr 10 2025 09:01:44 GMT-0700 (Pacific Daylight Time)">16:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jcristau:mozilla.org">jcristau</span>&gt;</div></td><td class="msg-cell">cc <span class="nick-12">anba</span>, looks like you wrote this?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Apr 10 2025 09:02:32 GMT-0700 (Pacific Daylight Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it definitely seems like it would be fine to skip it</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Apr 10 2025 09:03:35 GMT-0700 (Pacific Daylight Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I believe adding a line <code>// |jit-test| slow</code> at the beginning of the test file would do it.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Apr 10 2025 10:58:08 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>Regarding ubi::Node, can someone explain how to use the size function?</p>
<p>I'm not sure what the mallocSizeof parameter is supposed to be.</p>
<pre><code>using Size = Base::Size;
  Size size(mozilla::MallocSizeOf mallocSizeof) const {
    auto size = base()-&gt;size(mallocSizeof);
    MOZ_ASSERT(
        size &gt; 0,
        "C++ does not have zero-sized types! Choose 1 if you just need a "
        "conservative default.");
    return size;
  }
</code></pre>
</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Apr 10 2025 10:59:10 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">At the top level you need to do something like this <code>MOZ_DEFINE_MALLOC_SIZE_OF(MyMallocSizeOf)</code>, which will define <code>MyMallocSizeOf</code>.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Apr 10 2025 10:59:23 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">This is basically a hook into the allocator that will return the size of a particular memory block.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Apr 10 2025 11:17:52 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jcristau:mozilla.org">jcristau</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Apr 10 2025 11:28:18 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">When you say "at the top level", what do you mean?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Apr 10 2025 11:30:18 GMT-0700 (Pacific Daylight Time)">18:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">at the top of the file somewhere. You can look at how the macro is used in Firefox if that helps. <a href="https://searchfox.org/mozilla-central/search?q=MOZ_DEFINE_MALLOC_SIZE_OF&amp;path=">https://searchfox.org/mozilla-central/search?q=MOZ_DEFINE_MALLOC_SIZE_OF&amp;path=</a></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Apr 10 2025 11:32:51 GMT-0700 (Pacific Daylight Time)">18:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">So, if I pass in a name to the macro, does it define a malloc sizeof function with the name I pass in?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Apr 10 2025 11:32:59 GMT-0700 (Pacific Daylight Time)">18:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Apr 10 2025 11:33:24 GMT-0700 (Pacific Daylight Time)">18:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">And then I pass in that function as a parameter to the Node's size function?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Apr 10 2025 11:33:45 GMT-0700 (Pacific Daylight Time)">18:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Apr 10 2025 11:52:59 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Also, what header should I include to get MOZ_DEFINE_MALLOC_SIZE_OF?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Apr 10 2025 11:53:38 GMT-0700 (Pacific Daylight Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">You can use SearchFox to find where the declaration is.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Apr 10 2025 11:54:12 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">If you aren't using jemalloc then I don't know if it'll work.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Apr 10 2025 11:54:25 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">It's in some generated file called nsIMemoryReporter.h.

I'm not sure if that's the kind of file I'm supposed to be including directly in my source...</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Apr 10 2025 11:55:19 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Lots of places include it. <a href="https://searchfox.org/mozilla-central/search?q=nsIMemoryReporter.h&amp;path=">https://searchfox.org/mozilla-central/search?q=nsIMemoryReporter.h&amp;path=</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Apr 10 2025 11:55:43 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Not in SpiderMonkey so I dunno if that'll work if you are in a shell build.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Apr 10 2025 11:56:46 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This is in the context of an external embedder</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Apr 10 2025 11:57:25 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Ah. You'll probably need to copy the macro then.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Apr 10 2025 11:58:07 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Looks like the shell does do <code>#include "mozilla/mozalloc.h"</code> in one place</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Apr 10 2025 11:59:05 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think the key code is <a href="https://searchfox.org/mozilla-central/source/xpcom/base/nsIMemoryReporter.idl#558-563">here</a> and <a href="https://searchfox.org/mozilla-central/source/memory/mozalloc/mozalloc.cpp#124-140">here</a></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Apr 10 2025 11:59:42 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I guess the important thing is that I can just define it myself as long as I have access to moz_malloc_size_of</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Apr 10 2025 12:00:48 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">yep</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Apr 10 2025 12:01:39 GMT-0700 (Pacific Daylight Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Honestly, you can probably just pass in moz_malloc_size_of. The MOZ_REPORT stuff isn't relevant unless you are worrying about DMD.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Apr 10 2025 12:02:24 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">DMD isn't really relevant to UbiNode. It is more useful for the way memory reporting works in Firefox.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Apr 10 2025 12:02:31 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OH yeah I guess it just forwards the pointer</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Apr 10 2025 12:06:34 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"> And to be extra clear: Are these sizes in bytes?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Apr 10 2025 12:07:30 GMT-0700 (Pacific Daylight Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Apr 10 2025 12:08:56 GMT-0700 (Pacific Daylight Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Uh, probably not actually: I think we run slow tests in CI now</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Apr 10 2025 12:09:12 GMT-0700 (Pacific Daylight Time)">19:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(At least, that was the status quo when I tried to get that working a year or so ago) </td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Apr 10 2025 12:09:40 GMT-0700 (Pacific Daylight Time)">19:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK.  Good to know you're not using some system of "blocks" like some old playstation memory card or something</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Apr 10 2025 12:09:51 GMT-0700 (Pacific Daylight Time)">19:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">but it would be worth trying <code>|jit-test| heavy</code></td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Apr 10 2025 12:10:09 GMT-0700 (Pacific Daylight Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">which aimed squarely at this sort of test </td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Apr 10 2025 12:10:30 GMT-0700 (Pacific Daylight Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">jemalloc does round up allocation values for smaller blocks so maybe if you alloc 100 bytes you'll get 128, say.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Apr 10 2025 12:12:35 GMT-0700 (Pacific Daylight Time)">19:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">As long as it's still in bytes</td></tr>

</tbody></table></div></div></div>
</body></html>