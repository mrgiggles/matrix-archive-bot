<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-08-23</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-08-23<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-08-22" class="nav-link"><span>prev</span></a>
<a href="2022-08-24" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Aug 23 2022 02:28:01 GMT-0700 (Pacific Daylight Time)">09:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-7">ewang21</span>: From what I can see with Nix, unless we install headers I guess, there is only:</p>
<pre><code>/nix/store/dyiz4qsgp1k4d7h3r47b54m6c5xh7i51-spidermonkey-78.15.0
/nix/store/dyiz4qsgp1k4d7h3r47b54m6c5xh7i51-spidermonkey-78.15.0/lib
/nix/store/dyiz4qsgp1k4d7h3r47b54m6c5xh7i51-spidermonkey-78.15.0/lib/libmozjs-78.so
/nix/store/dyiz4qsgp1k4d7h3r47b54m6c5xh7i51-spidermonkey-78.15.0/bin
/nix/store/dyiz4qsgp1k4d7h3r47b54m6c5xh7i51-spidermonkey-78.15.0/bin/js78
/nix/store/dyiz4qsgp1k4d7h3r47b54m6c5xh7i51-spidermonkey-78.15.0/bin/js
</code></pre>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Aug 23 2022 02:41:51 GMT-0700 (Pacific Daylight Time)">09:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>for me, here's the list of installed files, on esr91, on macOS</p>
<pre><code>bin/js91-config
bin/js91
include/mozjs-91/*
lib/pkgconfig/mozjs-91.pc
lib/libmozjs-91.dylib
lib/libjs_static.ajs
</code></pre>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Aug 23 2022 11:37:25 GMT-0700 (Pacific Daylight Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">do we have usage data for <a href="https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/src/vm/Runtime.cpp#658">JSRuntime::onOutOfMemory</a> ?  such as, how frequently it's used, and how frequently and in what case it successfully allocate after GC ?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Aug 23 2022 11:38:32 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm trying to decouple frontend and GC, and wondering if removing the allocate-after-GC path during compilation can affect any case</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Aug 23 2022 11:40:19 GMT-0700 (Pacific Daylight Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">anyone interested in taking a look at the ESR102 migration guide for embedders? <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/60">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/60</a></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Aug 23 2022 11:42:09 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(the context for the allocate-after-GC is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1786512">bug 1786512</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Aug 23 2022 11:42:11 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1786512">https://bugzil.la/1786512</a> — ASSIGNED (arai) — Factor out JSRuntime::onOutOfMemory into multiple steps</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Aug 23 2022 11:42:42 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ptomato</span>: I'll look into it</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Aug 23 2022 11:42:49 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Aug 23 2022 11:53:12 GMT-0700 (Pacific Daylight Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I believe there was a recent work in Bug 1716727 to how oom recovery worked for allocations beyond just JS.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Aug 23 2022 11:53:14 GMT-0700 (Pacific Daylight Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1716727">https://bugzil.la/1716727</a> — RESOLVED (rkraesig) — Delay crashing the main process when running out of memory</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Aug 23 2022 11:53:59 GMT-0700 (Pacific Daylight Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">In a multi-process environment, it stalls the process that is having an oom and hopes that the OS can get things in better shape, and the telemetry showed that it does make a real impact</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Aug 23 2022 11:54:33 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span></div></td><td class="msg-cell">tries to think about how these different systems might interact..</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Aug 23 2022 11:57:02 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">according to the patch, "stall" here means "sleep" ?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Aug 23 2022 11:57:28 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yeah, I think that was the implementation</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Aug 23 2022 11:57:52 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">and I guess it might only be on windows now</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Aug 23 2022 11:58:04 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">that would give a chance for <em>other</em> processes to GC first</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Aug 23 2022 11:58:40 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">makes sense</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Aug 23 2022 12:00:28 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">so your proposed change would regress a theoretical case where the current process has all the garbage and we are using up a lot of memory in a single parse. Since the DOM would typically just crash in a similar case, and we can imagine the JS and HTML document parsing as roughly similar, I think I think your  change is probably reasonable</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Aug 23 2022 12:02:01 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">and since we are thinking about parsing scripts referenced by &lt;script&gt; tags from gecko directly (instead of spidermonkey threads), then I think it isn't surprising that we wouldn't do additional last-ditch-gc that the DOM stuff isn't doing</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Aug 23 2022 12:02:31 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(unless I'm completely mistaken about what an OOM during HTML parse / DOM construction looks like..)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Aug 23 2022 12:04:31 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, sounds good :)   I'll look into removing the GC during the frontend allocation</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Aug 23 2022 12:04:48 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that will reduce the difference between off-thread compilation and main-thread compilation</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Aug 23 2022 12:06:23 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: does gecko ever request a last-ditch GC?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Aug 23 2022 12:08:12 GMT-0700 (Pacific Daylight Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you mean where the request comes from Gecko, as opposed to being generated internally by an allocation failure?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Aug 23 2022 12:08:51 GMT-0700 (Pacific Daylight Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe I need to read backscroll</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Aug 23 2022 12:09:55 GMT-0700 (Pacific Daylight Time)">19:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Aug 23 2022 12:10:34 GMT-0700 (Pacific Daylight Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(eg, when gecko is parsing a HTML)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Aug 23 2022 12:11:32 GMT-0700 (Pacific Daylight Time)">19:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I believe last ditch GCs only result from a failure allocating a GC thing, when it tres to mmap a new chunk and gets OOM. I'll  look closuer in 5 minutes, sory.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Aug 23 2022 12:11:39 GMT-0700 (Pacific Daylight Time)">19:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">we want to be able to parse JS without needing a JSContext, and that means detaching from the last-ditch gc</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Aug 23 2022 12:11:55 GMT-0700 (Pacific Daylight Time)">19:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">no worries, I have to step out for a bit too</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Aug 23 2022 12:22:05 GMT-0700 (Pacific Daylight Time)">19:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if you're not creating any GC things, then you won't get any last ditch GCs. It looks like the <a href="https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/src/gc/Allocator.cpp#383-399">one and only path</a> to the LAST_DITCH reason is when <a href="https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/src/gc/Allocator.cpp#383-399">allocation fails</a></td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Aug 23 2022 12:26:43 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: <span class="nick-15">tcampbell</span>: the recent change to stall on OOM was <em>intended</em> to keep the parent process alive at the cost of the content processes: when the parent OOMed, it would sleep and then retry, on the theory that a content process would attempt to allocate enough to OOM itself and just immediately die. So we'd trade an entire browser crash for just a tab crashing, very possibly for reasons that were its own fault. And the change <em>did</em> help, but it turned out to not be for that reason.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Aug 23 2022 12:26:51 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>it sounds like "last ditch GC" is not what I'm going to remove.  the code that I want to remove from frontend allocation is <a href="https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/src/vm/Runtime.cpp#669-673">https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/src/vm/Runtime.cpp#669-673</a></p>
<pre><code class="language-cpp">/*
 * Retry when we are done with the background sweeping and have stopped
 * all the allocations and released the empty GC chunks.
 */
gc.onOutOfMallocMemory();
</code></pre>
</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Aug 23 2022 12:27:57 GMT-0700 (Pacific Daylight Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">apparently on Windows, you can get an OOM based on the current size of the swap file. Windows will automatically increase its size, but not synchronously. So sleeping after an OOM gives the OS enough time to grow the swap.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Aug 23 2022 12:29:20 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(perhaps the above line does not perform GC?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Aug 23 2022 12:29:58 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, I don't think that will GC.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Aug 23 2022 12:30:20 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it just waits for various things that might be in progress, because they may free up some memory.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Aug 23 2022 12:30:35 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, sorry, my question was wrong then</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Aug 23 2022 12:31:34 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, it looks like it also aggressively frees some additional things. But still nothing that could GC.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Aug 23 2022 12:38:40 GMT-0700 (Pacific Daylight Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, so, what could get affected if I remove that path from OOM during compilation?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Aug 23 2022 12:38:52 GMT-0700 (Pacific Daylight Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">on main thread</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Aug 23 2022 12:39:14 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">off-thread compilation already skips it</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Aug 23 2022 12:55:49 GMT-0700 (Pacific Daylight Time)">19:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">My guess is that it wouldn't change very much. Probably if we're OOMing during compilation, then those attempts to free up memory are only going to postpone when we hit an OOM. But we don't have solid data on that. It's kind of the same with all OOMs. We just don't know.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Aug 23 2022 12:57:35 GMT-0700 (Pacific Daylight Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I see. thanks :)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Aug 23 2022 13:03:55 GMT-0700 (Pacific Daylight Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">what part would be useful to remove? I added 2 comments to the bug.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Aug 23 2022 13:06:10 GMT-0700 (Pacific Daylight Time)">20:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">thanks!  the thing that I want to remove is the interaction with <code>JSContext</code> or <code>GCRuntime</code>, so that the script compilation becomes completely <code>JSContext</code>-free, and can be invoked from any thread</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Aug 23 2022 13:07:12 GMT-0700 (Pacific Daylight Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">currently, the allocation and error reporting inside frontend is wrapped by <a href="https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/src/vm/ErrorContext.h#38">js::ErrorContext</a></td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Aug 23 2022 13:07:32 GMT-0700 (Pacific Daylight Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that has 2 subclasses for main-thread and off-main-thread, to keep the current behavior</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Aug 23 2022 13:08:22 GMT-0700 (Pacific Daylight Time)">20:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">How do I properly call a JavaScript function in embedded C++ in a dynamic manner? I assume I could have some C++ binded function to JavaScript where I pass a JavaScript function as an argument to it then call that passed argument in C++ after checking it's a function?</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Aug 23 2022 13:08:25 GMT-0700 (Pacific Daylight Time)">20:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and what I want to do is to drop main-thread variant and use the off-main-thread compilation's way for all cases, such as, deferring the error reporting until the end of compilation, etc</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Aug 23 2022 13:09:04 GMT-0700 (Pacific Daylight Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, now I'm trying to reduce the difference between <code> MainThreadErrorContext</code> and <code>OffThreadErrorContext</code></td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Aug 23 2022 13:09:22 GMT-0700 (Pacific Daylight Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and one of the main difference is the <code>onOutOfMemory</code></td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Aug 23 2022 13:09:40 GMT-0700 (Pacific Daylight Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if <code>JSContext</code> dependency can be removed from there, things becomes very simple</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Aug 23 2022 13:15:30 GMT-0700 (Pacific Daylight Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: there are multiple <code>JS::Call</code> functions that takes function, etc</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Aug 23 2022 13:15:47 GMT-0700 (Pacific Daylight Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>for example, this variant can take the function as <code>JS::Handle&lt;JS::Value&gt;</code> <a href="https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/public/CallAndConstruct.h#101-103">https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/public/CallAndConstruct.h#101-103</a></p>
<pre><code class="language-cpp">extern JS_PUBLIC_API bool Call(JSContext* cx, Handle&lt;Value&gt; thisv,
                               Handle&lt;Value&gt; fun, const HandleValueArray&amp; args,
                               MutableHandle&lt;Value&gt; rval);
</code></pre>
</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Aug 23 2022 13:16:35 GMT-0700 (Pacific Daylight Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if you have the function as <code>JS::Value</code>, root it and pass it to the function's <code>fun</code> parameter</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Aug 23 2022 13:17:04 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>thisv</code> is the <code>this</code> value in the function.  if you don't need it, you can pass <code>JS::UndefinedHandleValue</code></td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Aug 23 2022 13:17:34 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>args</code> is an array of arguments.  if there's no arguments, you can pass <code>JS::HandleValueArray::empty()</code></td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Aug 23 2022 13:17:55 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and <code>rval</code> is out parameter that receives the return value of the function</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Aug 23 2022 13:18:00 GMT-0700 (Pacific Daylight Time)">20:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>here's example <a href="https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/src/jsapi-tests/testFunctionNonSyntactic.cpp#60-61">https://searchfox.org/mozilla-central/rev/d01591796d5faccf762adb09a311d8ee12f7ca7f/js/src/jsapi-tests/testFunctionNonSyntactic.cpp#60-61</a></p>
<pre><code class="language-cpp">CHECK(JS::Call(cx, JS::UndefinedHandleValue, funVal,
               JS::HandleValueArray::empty(), &amp;rval));
</code></pre>
</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Aug 23 2022 13:22:49 GMT-0700 (Pacific Daylight Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>if you want to pass arguments, you can construct the vector and pass it</p>
<pre><code class="language-cpp">JS::RootedVector&lt;JS::Value&gt; args(cx);
if (!args.append(arg0)) {
  return false;
}
if (!args.append(arg1)) {
  return false;
}
...
</code></pre>
</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Aug 23 2022 14:12:45 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell">If I want to build the arm64 version of esr68 on a 64-bit linux system,  is the following command correct to generate the make file?
CC=/usr/bin/clang CXX=/usr/bin/clang++ ../configure --disable-jemalloc --enable-posix-nspr-emulation --enable-unaligned-private-values --with-system-zlib --with-intl-api --enable-optimize --disable-debug-symbols --with-libclang-path=/usr/lib/llvm-10/lib --with-clang-path=/usr/bin/clang --target=aarch64-pc-linux</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Aug 23 2022 14:27:21 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">That looks approximately like what I would expect. I don't remember what sort of non-android arm64 targets were being used back when 68 was current, so I'm not sure if the target-triple needs to be tweaked at all</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue Aug 23 2022 14:32:01 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> That looks approximately like what I would expect. I don't remember what sort of non-android arm64 targets were being used back when 68 was current, so I'm not sure if the target-triple needs to be tweaked at all</blockquote></mx-reply>If there is no option "--target=aarch64-pc-linux", it can generate the make file, but after i add it, there is a ERROR: Failed to find a linker.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue Aug 23 2022 14:32:56 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">are you building on arm64 or cross compiling?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue Aug 23 2022 14:33:12 GMT-0700 (Pacific Daylight Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">if building on same system, I'd try dropping the '--target'</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue Aug 23 2022 14:34:42 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell">cross compiling. The host system type is x86_64-pc-linux-gnu. So it can generate the make file without "--target=aarch64-pc-linux"</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue Aug 23 2022 14:35:53 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">ewang21</span>: are you able to compile a simple C++ file using /usr/bin/clang++ to the right target?</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue Aug 23 2022 14:38:02 GMT-0700 (Pacific Daylight Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-7">ewang21</span>: are you able to compile a simple C++ file using /usr/bin/clang++ to the right target?</blockquote></mx-reply>Yes, I built a x64 lib</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue Aug 23 2022 14:38:26 GMT-0700 (Pacific Daylight Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Can you build an arm64 binary though?</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue Aug 23 2022 14:39:03 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell">Sure, I build an arm64 v8 lib</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue Aug 23 2022 14:41:44 GMT-0700 (Pacific Daylight Time)">21:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I'd watch the configure output and see where it is looking for the linker. Maybe you need to set LD=... as well</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Tue Aug 23 2022 14:47:26 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@mohamed_atef:matrix.org">Mohamed Atef</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: To pass an <code>ErrorContext*</code> parameter here: <a href="https://searchfox.org/mozilla-central/source/js/src/frontend/Stencil.cpp#2240">https://searchfox.org/mozilla-central/source/js/src/frontend/Stencil.cpp#2240</a></td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Tue Aug 23 2022 14:47:45 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@mohamed_atef:matrix.org">Mohamed Atef</span>&gt;</div></td><td class="msg-cell">should I use <code>MainThreadErrorContext ec(cx)</code></td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Tue Aug 23 2022 14:47:50 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@mohamed_atef:matrix.org">Mohamed Atef</span>&gt;</div></td><td class="msg-cell">and pass &amp;ec?</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Tue Aug 23 2022 14:48:31 GMT-0700 (Pacific Daylight Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, exactly</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Tue Aug 23 2022 14:50:27 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">whether it's <code>MainThreadErrorContext</code> or <code>OffThreadErrorContext</code> depends on the where the function is called. if a function is called by both main thread and helper threads, the function needs to receive <code>ErrorContext*</code> parameter and let the caller decide which one to use.  for <code>CompilationStencil::serializeStencils</code>'s case, it's used by main thread, and you can use <code>MainThreadErrorContext</code></td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Tue Aug 23 2022 14:51:10 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, actually, the distinction is going to be removed shortly, in bug 1786494, but until then, please use one of them depending on each case</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Tue Aug 23 2022 14:51:11 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1786494">https://bugzil.la/1786494</a> — ASSIGNED (arai) — Rewrite MainThreadErrorContext with OffThreadErrorContext + a step to convert to runtime error</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Tue Aug 23 2022 16:31:59 GMT-0700 (Pacific Daylight Time)">23:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'd watch the configure output and see where it is looking for the linker. Maybe you need to set LD=... as well</blockquote></mx-reply>../configure --help             You will see        LD                        Deprecated             😅</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Tue Aug 23 2022 16:38:16 GMT-0700 (Pacific Daylight Time)">23:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I tried --target=aarch64-linux-pc on my esr68 directory, and see the same linker error. Looks like it in our weird python build stuff instead of normal configure script.. sigh. <a href="https://searchfox.org/mozilla-esr68/source/build/moz.configure/toolchain.configure#2088">https://searchfox.org/mozilla-esr68/source/build/moz.configure/toolchain.configure#2088</a></td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Tue Aug 23 2022 16:39:11 GMT-0700 (Pacific Daylight Time)">23:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">ewang21</span>: adding <code>--enable-gold</code> seems to get me through</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Tue Aug 23 2022 16:54:17 GMT-0700 (Pacific Daylight Time)">23:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">it looks like it uses <code>clang --target=aarch64-linux-gnu -Wl,--version</code> which finds system <code>ld</code> that for me doesn't have the right support</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Tue Aug 23 2022 16:57:21 GMT-0700 (Pacific Daylight Time)">23:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">or also <code>--enable-linker=lld</code> works too</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Tue Aug 23 2022 16:59:59 GMT-0700 (Pacific Daylight Time)">23:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">although that might hit some cross-compile issues later on.. sigh.. build systems</td></tr>

</tbody></table></div></div></div>
</body></html>