<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-04-25</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-04-25<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-04-24" class="nav-link"><span>prev</span></a>
<a href="2025-04-28" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Apr 25 2025 09:20:25 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">this shows register allocation time for backtracking vs my simple allocator for a large number of Wasm functions of different sizes (single-threaded compilations, Wasm because it's easier to compare the exact same workloads)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Apr 25 2025 09:20:43 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">(I left out larger functions because backtracking time blows up more for those, so you'd see just a few points)</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Apr 25 2025 09:21:37 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's interesting that both allocators seem ~linear</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Apr 25 2025 09:27:12 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">also to be clear: the simple allocator is a much simpler allocator that produces slower code than backtracking so they're not doing the same thing, but it's still interesting to look at</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Apr 25 2025 09:30:30 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">and for JS code the numbers would be worse for both because that has snapshots and safepoints that add extra work..</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Apr 25 2025 10:18:33 GMT-0700 (Pacific Daylight Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This might potentially be interesting for JetStream which has way higher results from Ion, if we could make use of Ion sooner with a faster compilation time, the simpler allocation might be beneficial. (adding a new Ion tier)
But this might not be for Speedometer</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Apr 25 2025 10:26:22 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">IIRC the perf numbers actually show that SP3 maybe gets a small win (especially on Android where background compilation is relatively more expensive) and JS hates it, because there are more hot loops where bad regalloc hurts us</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Apr 25 2025 10:27:21 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So I think we may want two tiers, but the low tier would be for Speedometer and the high tier would be for Jetstream</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Apr 25 2025 10:29:39 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Weird because the speedup reported by <span class="nick-10">yulia</span>  were kind of small for Ion vs Baseline on Speedometer, but this was desktop.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Apr 25 2025 10:32:52 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right, I think the distinction is that Jetstream subtests are mostly dominated by a few hot loops (so there are a few functions where we <em>really</em> care about code quality), whereas Speedometer profiles are flatter (so we care less about hyper-optimizing any individual function).</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Apr 25 2025 10:33:22 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We get less of a boost from Ion on SP3, so if we can get our Ion compilation over and done with faster, we can free up background threads for eg layout.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Apr 25 2025 10:34:42 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">One thing I'm not entirely clear on is how two Ion tiers would interact with OSR.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Apr 25 2025 10:35:00 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I assume we would just not do Ion-to-Ion OSR</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Apr 25 2025 10:35:33 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But maybe we could quickly bail out to baseline and then tier up from there?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Apr 25 2025 10:36:21 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I guess we could just invalidate the existing Ion script, and it would all work out</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Apr 25 2025 10:38:34 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah invalidating is what I was thinking, at least for an initial prototype (bug 1962470 has some details)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Apr 25 2025 10:38:35 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1962470">https://bugzil.la/1962470</a> — NEW (nobody) — Experiment with two Ion compilation tiers</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Apr 25 2025 10:39:27 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">if we're going to do more inlining for the higher tier (we probably should) then spending some time in Baseline again for trial inlining might be nice anyway</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Apr 25 2025 10:40:31 GMT-0700 (Pacific Daylight Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">although running the initial Ion code until the compilation is finished would be nice too</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Apr 25 2025 10:43:01 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We could also just assume that the first round of trial inlining will catch the cases where trial inlining is valuable, and then do a more aggressive round of monomorphic inlining for the higher tier.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Apr 25 2025 10:44:03 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah. I think extra inlining would be very beneficial for JetStream style code</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Apr 25 2025 10:47:03 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right now DoTrialInlining marks things as inlining candidates and then WarpOracle just follows those decisions, but in the monomorphic case all it does is mark the fallback stub as MonomorphicInlined. If we just let calls past <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpOracle.cpp#986-988">this check</a> and <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpOracle.cpp#1022-1023">this assert</a> in the higher tier, I think it might all just work out.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Apr 25 2025 10:47:42 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We already have a few safeguards in place to ensure we don't blow our budget with monomorphic inlining; we could tweak the heuristics some more too.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Apr 25 2025 10:51:01 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">we could also try doing less (monomorphic) inlining for the initial compilation, although it's not like we inline much today anyway. Having two tiers would let us experiment with these things pretty easily</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Apr 25 2025 10:51:22 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Another way would be to let the first Ion tier collect the inlining information. I think there is a way to make it somewhat cheaply if we can spare one register dedicated to that. In which case, in most frequent cases we would have a compare and swap with the register value.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Apr 25 2025 10:51:56 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I would have to experiment this thing one day …</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Apr 25 2025 10:59:21 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right now I think our inlining heuristics are already kind of tuned for the initial compilation, in the sense that we targeted them at SP3 instead of Jetstream. We could try bringing them down a little more, but we're already very conservative.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Apr 25 2025 11:01:33 GMT-0700 (Pacific Daylight Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it's been hard to keep both SP3 and JetStream happy with just the one Ion tier</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Apr 25 2025 11:01:46 GMT-0700 (Pacific Daylight Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think two tiers might be a generally good thing, really</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Apr 25 2025 11:13:39 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: We already get most relevant inlining information from baseline (and the way it interacts with Ion). If the call is monomorphic, then we will attach a CallSpecificFunction IC. Even if we don't decide to inline it in the first Ion compilation, we will transpile a GuardSpecificFunction guard to MIR. If the target ever changes, we'll bail out and update the CacheIR in baseline. So we know with confidence who we're calling. We also know how often we've made the call from Baseline by looking at the entry counters on the stub. We don't have that information in Ion by default, although I guess we could add counters at calls in the initial Ion tier if we really felt we needed it.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Apr 25 2025 11:17:31 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">oh, that's right, we have entry counters now.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Apr 25 2025 11:20:01 GMT-0700 (Pacific Daylight Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I recall the day when adding an increment in a tight loop was slowing down on ""important"" benchmarks :P</td></tr>

</tbody></table></div></div></div>
</body></html>