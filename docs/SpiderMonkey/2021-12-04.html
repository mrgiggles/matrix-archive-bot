<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-12-04</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-12-04<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-12-03" class="nav-link"><span>prev</span></a>
<a href="2021-12-05" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sat Dec 04 2021 06:04:47 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Job Queue (Default and GJS Implementation) Question:<br>Let's say you have a promise that gets queued and then executed. Within the promise, there's an await for some other promise, which would then get queued. If the queue tries to run the job again, it can't because of its draining. However, I don't think the outer promise run can complete since its waiting for the inner one to complete. Thus, it can't progress to the next job to run the promise either. How is it possible for the inner promise to be completed, and then the outer promise as well?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sat Dec 04 2021 07:26:17 GMT-0800 (Pacific Standard Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Redfire</span>: can you provide example?  I don't get what you mean by "Within the promise, there's an await for some other promise" part</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sat Dec 04 2021 07:28:04 GMT-0800 (Pacific Standard Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">to my understanding, "await" cannot be "within a promise"</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sat Dec 04 2021 07:28:44 GMT-0800 (Pacific Standard Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-js">async function async_fn() {
	return await other_async_function();
}

await async_fn();
</code></pre></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sat Dec 04 2021 07:29:55 GMT-0800 (Pacific Standard Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, <code>other_async_function</code> returns a promise that doesn't resolve?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sat Dec 04 2021 07:32:01 GMT-0800 (Pacific Standard Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, I think I have some more questions about terminology used there.  what do you mean by "draining", "complete", "progress to the next job" ?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sat Dec 04 2021 07:32:20 GMT-0800 (Pacific Standard Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I guess, there's some confusion about promise vs async function vs job</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sat Dec 04 2021 07:35:04 GMT-0800 (Pacific Standard Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">meanwhile, I'll try explaining how the above code is supposed to work.  give me some time</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sat Dec 04 2021 07:56:17 GMT-0800 (Pacific Standard Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(maybe 30 minutes more...)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sat Dec 04 2021 08:06:36 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Redfire: Async function's evaluation is specified as <a href="https://tc39.es/ecma262/#sec-runtime-semantics-evaluateasyncfunctionbody">EvaluateAsyncFunctionBody</a>.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sat Dec 04 2021 08:06:41 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">So, it creates a promise at step 1, handles arguments at step 2, and then performs <a href="https://tc39.es/ecma262/#sec-async-functions-abstract-operations-async-function-start">AsyncFunctionStart</a> at step 3.a, that performs <a href="https://tc39.es/ecma262/#sec-asyncblockstart">AsyncBlockStart</a> in step 4.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sat Dec 04 2021 08:06:44 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">It's somewhat complicated, but there are 2 important parts: it pushes a copy of running context (as <code>asyncContext</code>) onto the execution context stack at step 6, and then evaluates the body at step 3.a.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sat Dec 04 2021 08:06:47 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Then, when evaluating the async function's body, if there's <a href="https://tc39.es/ecma262/#prod-AwaitExpression"><code>await</code></a>, it <a href="https://tc39.es/ecma262/#sec-async-function-definitions-runtime-semantics-evaluation">performs</a> <a href="https://tc39.es/ecma262/#await">Await</a>. This is part would be what you need.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sat Dec 04 2021 08:06:52 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>what it does can be explained by desugaring the async/await from</p>
<pre><code>let v = await x;
console.log(v);
...
</code></pre>
<p>to</p>
<pre><code>Promise.resolve(x).then(v =&gt; {
  console.log(v);
  ...
}, e =&gt; {
  // exception handling
});
</code></pre>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sat Dec 04 2021 08:06:58 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and removes the <code>asyncContext</code> from the execution context stack.<br>So, the execution goes back to <a href="https://tc39.es/ecma262/#sec-asyncblockstart">AsyncBlockStart</a> step 6, and <a href="https://tc39.es/ecma262/#sec-runtime-semantics-evaluateasyncfunctionbody">EvaluateAsyncFunctionBody</a> step 5, so the promise is returned to the caller.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sat Dec 04 2021 08:07:03 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Then, if a promise is pending (not resolved), <a href="https://tc39.es/ecma262/#sec-performpromisethen">PerformPromiseThen</a> (performed at Await step 7) appends the reaction to the promise object's internal list at step 9.a-b, and doesn't create/enqueue a job.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sat Dec 04 2021 08:07:06 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">So, in your example, <code>await async_fn();</code> creates a promise, then evaluates the body of <code>async_fn</code>, and there's <code>await</code>, so it performs <code>other_async_functio().then(v =&gt; { performs "return v" }, ...)</code>.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sat Dec 04 2021 08:07:11 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">If <code>other_async_function()</code> returns a pending promise, <code>then(...)</code> above doesn't create a job, and also the promise returned by <code>async_fn</code> is also pending, and <code>await async_fn()</code> also doesn't create a job.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sat Dec 04 2021 08:07:21 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(sorry for spamming :P</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sat Dec 04 2021 08:08:22 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">anyway, if it's waiting, there's no job</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Sat Dec 04 2021 08:08:51 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the waiting thing is inside the Promise's [PromiseFulfillReactions]]/[[PromiseRejectReactions]] list</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Sat Dec 04 2021 08:09:03 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and job is created only when the promise is resolved</td></tr>

</tbody></table></div></div></div>
</body></html>