<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-06-24</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-06-24<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-06-20" class="nav-link"><span>prev</span></a>
<a href="2025-06-25" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jun 24 2025 00:58:29 GMT-0700 (Pacific Daylight Time)">07:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Do we have any up-to-date script corpus to analyze the popular website's scripts usage?  I want to look into the use of certain characteristics of ECMAScript built-ins and WebIDL semantics, in order to minimize the difference between them.  I thought we had some, but I cannot remember where it is</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jun 24 2025 06:51:51 GMT-0700 (Pacific Daylight Time)">13:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dminor:mozilla.org">dminor</span>&gt;</div></td><td class="msg-cell">Henri Sivonen has been using internet archive to do analyses like this, but I'm not sure what tools he's using, and he's away for the next few weeks.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jun 24 2025 07:04:47 GMT-0700 (Pacific Daylight Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">thanks!  I'll see if there's any public tools around that</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jun 24 2025 07:05:39 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jjaschke:mozilla.org">jjaschke</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: Ask <span class="nick-14">zcorpan</span> about httparchive :)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jun 24 2025 07:08:04 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ah, thank you!</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jun 24 2025 07:10:05 GMT-0700 (Pacific Daylight Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@zcorpan:mozilla.org">zcorpan</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: <a href="https://docs.google.com/document/d/1-pAmOC-WFbEVjb2rE0VtMrlOHgcl4Bn7lqmgW3u1rtk/edit?usp=sharing">https://docs.google.com/document/d/1-pAmOC-WFbEVjb2rE0VtMrlOHgcl4Bn7lqmgW3u1rtk/edit?usp=sharing</a> but the examples are out of date. <a href="https://har.fyi/">https://har.fyi/</a> should be up to date with the current table structure</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jun 24 2025 07:12:01 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@zcorpan:mozilla.org">zcorpan</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: happy to help running a query or have a call if you want to get it running yourself</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jun 24 2025 07:13:46 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">great!  I'll look into the document and I'll ping you later with more details and concrete plan</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jun 24 2025 07:14:40 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@zcorpan:mozilla.org">zcorpan</span>&gt;</div></td><td class="msg-cell">I'm here this week, then PTO until 4 Aug</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jun 24 2025 13:28:23 GMT-0700 (Pacific Daylight Time)">20:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-12">sfink</span>: So, I've gotten to (mostly) the bottom of a mysterious performance gap I had between a prototype patch I built and a real patch I built. Colour me deeply surprised when I discovered that a huge part of the gap in performance is barriers. I mean, I knew that I had failed to get the barriers right in my prototype, but it ran the benchmark and only crashed sometimes so I (foolishly) ignored it thinking "there's no way it's barriers"</p>
<p>As is tradition: It's barriers. I spend way too much time doing barrier code now. Which brings me to my actual question: When barriers are your problem, what kind of tips and tricks should I be looking at beyond: Hey, try and have less writes (which is my next task: It's clear in the profiles that I'm doing copies I did not expect, where the copies are <em>way</em> more costly as a result of the barriers)</p>
<p>I see we have <code>JS::TenuredHeap&lt;&gt;</code> which certainly would avoid some barriers if I could prove I'm not writing a nursery object in (not sure yet), but I'd be curious about other things-- bulk barrier options etc</p>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jun 24 2025 13:30:51 GMT-0700 (Pacific Daylight Time)">20:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Right now the core structure, because I wanted to avoid overheads (ha) is a <code>JS::Heap&lt;JS::Value&gt; arguments[ARGUMENT_MAX];</code></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jun 24 2025 13:53:13 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: do you happen to know which barriers are expensive? As in, pre, post, or read barriers?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jun 24 2025 13:53:52 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><a href="https://profiler.firefox.com/public/16m2aj2xch4qf8vx2sxfvrk4yeehzac2nyxc6hg/flame-graph/?globalTrackOrder=0wj&amp;hiddenGlobalTracks=0wbdwj&amp;hiddenLocalTracksByPid=3915693.2-0w6~3915693.1-0wAu~3915709.1-0~3915719.1-0w8~3915782.1-0w8~3915825-0wx0~3915832-0w7~3915881-0wt~3915940-0w6~3915953-0wx1~3915980-0ws~3915982-0ws~3915990-0ws&amp;profileName=Patch%20Checksum.%20barrier-proto&amp;range=4129m24714&amp;symbolServer=http%3A%2F%2F127.0.0.1%3A3000%2F131l5rq2a3qn5h2fwqriv7jf710jkhn8zj2x90r&amp;thread=C5&amp;transforms=ff-2788~rec-2788&amp;v=10">the post barrier seems worst for sure</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jun 24 2025 13:54:44 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">also, <code>arguments</code>... this must be some sort of stored arguments thing, like in a Promise reaction or something? (Because normally I'd expect something called <code>arguments</code> to be on the stack.)</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jun 24 2025 13:55:27 GMT-0700 (Pacific Daylight Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, yep</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jun 24 2025 13:59:48 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">yeah (i'm realizing that C++ needs you to write a heck of a lot more move constructors than you think as I try to eliminate copying) </td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jun 24 2025 14:07:15 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">wow, you have a lot of samples. How did it manage to get 145 samples in Value.isGCThing()? (Yes, the profile says it's optimized.)</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jun 24 2025 14:07:28 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://profiler.firefox.com/public/16m2aj2xch4qf8vx2sxfvrk4yeehzac2nyxc6hg/flame-graph/?globalTrackOrder=0wj&amp;hiddenGlobalTracks=0wbdwj&amp;hiddenLocalTracksByPid=3915693.2-0w6~3915693.1-0wAu~3915709.1-0~3915719.1-0w8~3915782.1-0w8~3915825-0wx0~3915832-0w7~3915881-0wt~3915940-0w6~3915953-0wx1~3915980-0ws~3915982-0ws~3915990-0ws&amp;profileName=Patch%20Checksum.%20barrier-proto&amp;range=4129m24714&amp;symbolServer=http%3A%2F%2F127.0.0.1%3A3000%2F131l5rq2a3qn5h2fwqriv7jf710jkhn8zj2x90r&amp;thread=C5&amp;transforms=ff-2788~rec-2788~ff-2945&amp;v=10">the profile</a> says a fair amount of time in read barriers and pre barriers, too</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jun 24 2025 14:09:20 GMT-0700 (Pacific Daylight Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The most likely explanation for Value.isGCThing is that it's (at least sometimes) the first place we look at the contents of the Value, so if it's not currently in L1, it pays the cost of the cache miss</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jun 24 2025 14:09:32 GMT-0700 (Pacific Daylight Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(Doxbee promise runs for a good chunk of time, and <code>samply -r 1000</code>)</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jun 24 2025 14:10:16 GMT-0700 (Pacific Daylight Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Actually that's another fix I should make if I can get this to stop copying; I am pretty sure I actually don't need value args, just objects. </td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jun 24 2025 14:17:01 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I wonder if we could have some sort of deferred barrier (for post and read barriers): kind of like a PersistentMinorRooted that does only pre barriers in the common case, but if it runs a minor GC (or CC?) while it's live, it does post barriers and read barriers for everything in the array/vector. If it dies before anything happens or it was never looked at (requiring a simple "observed" boolean flag barrier), then it wouldn't do any barriers at all. Hm... that's probably not sound.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jun 24 2025 14:17:19 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(if you read something out, then change it, you'd lose the read barrier on the original value)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jun 24 2025 14:17:32 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm overcomplicating this, I bet.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jun 24 2025 14:17:51 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I mean possibly so am I -- currently trying to just stop copying by deleting copy constructors and seeing what I can do </td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jun 24 2025 14:18:37 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(std::move + JS::Handle&lt;&gt; == ow ow ow) </td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jun 24 2025 14:18:58 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This doesn't necessarily work well with your current minimalist plan, but it occurs to me that you wouldn't need barriers to store arguments in a promise reaction if the promise reaction were also a nursery object</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jun 24 2025 14:19:03 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">do you ever update the values? If not, I'm thinking at least the pre-barrier should be avoidable. I think it's triggered because of the copying.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jun 24 2025 14:19:30 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">That's the other thing; no. These things are pretty much write once, read once. </td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Jun 24 2025 14:19:48 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">once constructed and initialized, they never get mutated. </td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Jun 24 2025 14:20:14 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">But I do <em>need</em> the barriers to make sure nursery pointers get updated</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Jun 24 2025 14:20:20 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">if their referent gets tenured</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Jun 24 2025 14:20:27 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, that's the post barrier</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Jun 24 2025 14:24:57 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we sort of need a magic object in the nursery that holds the arguments objects, like <span class="nick-4">iain</span> is saying, and make it pinky swear that it will have a single owner so we can recurse into it during a minor GC. Which essentially makes it part of the store buffer. Then it would be barriered, but it's a single barrier for all of the arguments.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Jun 24 2025 14:25:52 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Why does it need a single owner?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Jun 24 2025 14:26:55 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm not sure if that's the right constraint. We just want to recurse into it without having any possibility of blowing the stack.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Jun 24 2025 14:28:05 GMT-0700 (Pacific Daylight Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe all that's needed is that when it's visited, it appends all of its nursery contents onto the fixup list. No recursion needed.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Jun 24 2025 14:28:49 GMT-0700 (Pacific Daylight Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(this may ultimately be moot -- I think there's other design constraints we'll eventually have to deal with, so making this perfect probably isn't necessary) </td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Jun 24 2025 14:31:06 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Just for the sake of sharpening my own intuition: suppose we had a nursery-allocated ListObject containing the arguments, and the promise reaction had a normally-barriered edge to that ListObject. Then we would have a barrier for the edge to the List, but no barriers for initializing the list, because nursery-&gt;nursery edges don't need post-barriers, right?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Jun 24 2025 14:33:42 GMT-0700 (Pacific Daylight Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Hopefully I don't get this wrong... I think that's correct, but you sort of have to guarantee that the ListObject <em>is</em> in the nursery. A normal ListObject would check that in the post-barrier itself. "Is owner in the nursery? Done, nothing to do."</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Jun 24 2025 14:34:11 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the per-entry post-barrier, I mean.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Jun 24 2025 14:35:02 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Jun 24 2025 14:36:19 GMT-0700 (Pacific Daylight Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So in a hypothetical future world, we could have a PromiseReactionObject with a fast jit-code path to bump-allocate it in the nursery and store the arguments internally with no barriers?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Jun 24 2025 14:36:55 GMT-0700 (Pacific Daylight Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh yes, from the JIT that's something that already happens in some places</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Jun 24 2025 14:37:21 GMT-0700 (Pacific Daylight Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(eg creating a regexp result with capture strings)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Jun 24 2025 14:37:32 GMT-0700 (Pacific Daylight Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, that's what I thought</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Jun 24 2025 14:43:13 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess the non-JIT "IC" equivalent is what <span class="nick-2">mgaudet</span> was saying in the first place: when assigning into the arguments array, do one check for the owner being in the nursery, and if it is, do unbarriered writes.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Jun 24 2025 14:43:25 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">With some complexity if a minor GC happens in the middle of this, but as long as you're not creating new argument objects, it's still not a problem: now you know you're doing a tenured-&gt;tenured write.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Jun 24 2025 14:43:36 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Unless! you have a semi-space nursery :-(</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Jun 24 2025 14:45:02 GMT-0700 (Pacific Daylight Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(the <span class="nick-2">mgaudet</span> thing I was referring to was batching the barriers; this would be a form of that)</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Jun 24 2025 15:10:42 GMT-0700 (Pacific Daylight Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: do you know if the <a href="https://searchfox.org/mozilla-central/rev/ba8d4b59f46a820fc3c2f0a55c638e4f8b29bfda/js/src/gc/Barrier.h#597-599">requirements</a> for using GCPtr are met? That would be cheaper, at least.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Jun 24 2025 15:15:51 GMT-0700 (Pacific Daylight Time)">22:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Uhh. Methinks no; but I'm past EOD now so I'll think more tomorrow. </td></tr>

</tbody></table></div></div></div>
</body></html>