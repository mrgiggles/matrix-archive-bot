<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-06-23</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-06-23<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-06-22" class="nav-link"><span>prev</span></a>
<a href="2022-06-24" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Jun 22 2022 23:53:31 GMT-0700 (Pacific Daylight Time)">06:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">note that TraceLogger is not maintained, and you might hit issue, and also not sure if it can directly generate the data you want.  but still, you could modify the code to output related data and process it manually to generate the data you want</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jun 23 2022 02:08:28 GMT-0700 (Pacific Daylight Time)">09:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">r3st</span>: I'm wondering if that prototype could help you:
<a href="https://phabricator.services.mozilla.com/D129035">https://phabricator.services.mozilla.com/D129035</a>
(You would have to apply the two patches)

We have been wondering in Devtools team if such feature could be helpful.
That's something we can land and actively maintain as that's based on the API used to debug JavaScript.

<span class="nick-15">arai</span>: I was also wondering if this could possibly help remove unaintained tracing code. But may be the tracing code exposes more information?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jun 23 2022 02:16:46 GMT-0700 (Pacific Daylight Time)">09:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't know what tracelogger provides.  here's related repository <a href="https://github.com/h4writer/tracelogger">https://github.com/h4writer/tracelogger</a> if it helps</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jun 23 2022 02:18:46 GMT-0700 (Pacific Daylight Time)">09:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but yeah, having an devtools integration for the trace logging sounds nice.  I guess it can help investigating issue, e.g. webcompat issue, by showing what function is executed on specific action on webpage, and how it's different between good/bad cases, etc</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jun 23 2022 02:19:52 GMT-0700 (Pacific Daylight Time)">09:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's often difficult and/or time consuming task to investigate how website is working, and figure out how and where the issue is caused</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jun 23 2022 04:32:48 GMT-0700 (Pacific Daylight Time)">11:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Oh wait, TraceLogger goes much beyond Javascript. It also exposes native calls and spidermonkey internals. I though it was a javascript-only tracer. We used to have such API in spidermonkey, used by DevTools a long time ago. But may be it was removed.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jun 23 2022 06:00:32 GMT-0700 (Pacific Daylight Time)">13:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">TIL, the macro list trick has a name: <a href="https://en.wikipedia.org/wiki/X_Macro">https://en.wikipedia.org/wiki/X_Macro</a></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jun 23 2022 09:08:31 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">“but remains relatively unknown.” — the name of it, yes. The feature, well …</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jun 23 2022 10:32:34 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I'm experimenting with cleaning up our telemetry to be slightly less annoying to add. One aspect of that is experimenting with replacing <code>rt-&gt;addTelemetry(JS_TELEMETRY_GC_MINOR_REASON, uint32_t(reason)</code> with <code>rt-&gt;metrics().gc_minor_reason(uint32_t(reason))</code>. This gets us in the general direction of where Glean/FOG is going. V8 also uses a very similar approach and it seems to work well enough there.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jun 23 2022 10:34:57 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell">When running scripts in parallel in different contexts under the same runtime is it guaranteed they will not interfere with each other?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jun 23 2022 10:38:48 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">To run in parallel, you'd need multiple runtimes, which is how Web Workers are implemented.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jun 23 2022 10:40:02 GMT-0700 (Pacific Daylight Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The JSContext these days is a little weird. It is usually 1:1 with a JSRuntime, but there are also a handful of JSContext used on other things for things like off-main-thread JIT compile though you largely can ignore them.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jun 23 2022 10:41:18 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">If you are talking about <code>JS_NewContext</code>, then yes those create their private JSRuntime internally that might itself reference a "parent runtime", but that is all thread safe.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jun 23 2022 10:43:38 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">You'd need to parse the script into the correct runtime though. The <code>JSScript*</code> can't be handed between threads. There are some optimizations you could do using <code>JS::Stencil</code> which is shareable between threads and then each thread can call something like <code>InstantiateGlobalStencil</code></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jun 23 2022 10:44:35 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-14">pastah</span>: here's example with multithread <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/55">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/55</a></blockquote></mx-reply>What about this?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jun 23 2022 10:44:55 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell">ah yes <code>JSRuntime</code></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Jun 23 2022 10:45:27 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">Pastah</span>: yeah, that example is good. You'll note that it uses <code>ExecuteCode</code> which takes a string, then internally parses and executes it</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Jun 23 2022 10:46:20 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">roughly, you can imagine that each thread/worker has it's own GC heap, so things like JSObject / JSScript cannot be shared</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Jun 23 2022 10:47:22 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(In a web browser, sending a JS object to a Worker would use <code>postMessage</code> and then would serialize and deserialize to make a <em>copy</em> of the object in the worker that is <em>mostly</em> the same)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Jun 23 2022 10:51:35 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">So, going back to your original question, I believe the simple answer is probably that yes, they are independant.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Jun 23 2022 10:52:20 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell">Thank you</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Jun 23 2022 10:57:50 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: don't we already have something like that for the telemetry. I recall adding some JS shell interface where one could add telemetry like any other, but it does not necessarily require it to be implemented as part of Firefox.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Jun 23 2022 10:58:34 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> When running scripts in parallel in different contexts under the same runtime is it guaranteed they will not interfere with each other?</blockquote></mx-reply>We have UseCounter for that, which are aggregated by document, within Firefox.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Jun 23 2022 11:02:41 GMT-0700 (Pacific Daylight Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Right now we always use <code>addTelemetry</code> and then an enum value. Part of the motivation people have for the generated structure approach is that you can build in better typing instead of just uint32_t raw values.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Jun 23 2022 11:10:02 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(I believe the parallel scripts question is unrelated to telemetery discussion)</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Jun 23 2022 12:40:18 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <a href="https://searchfox.org/mozilla-central/rev/cc98a15c7327d742d283cddddde712a8a3165006/js/src/vm/Initialization.cpp#341">JS::DisableJitBackend</a>, and <a href="https://searchfox.org/mozilla-central/source/js/moz.configure#172">--disable-jit</a></blockquote></mx-reply>I don't think I have <code>JS::DisableJitBackend()</code> in libmozjs 68.0</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Jun 23 2022 12:41:26 GMT-0700 (Pacific Daylight Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell">yeah, I don't see it in searchfox</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Jun 23 2022 13:07:51 GMT-0700 (Pacific Daylight Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell">Where is the ScriptSourceObject's methods/fields/interface defined?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Jun 23 2022 13:08:32 GMT-0700 (Pacific Daylight Time)">20:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell">Want to add a js-exposed method to hash the contents with a fast hash without extracting a jsstring, then utf8-converting it, then hashing it.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Jun 23 2022 13:17:11 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj2</span>: Hey!</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Jun 23 2022 13:17:21 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I think there just are not any methods on it right now</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Jun 23 2022 13:18:34 GMT-0700 (Pacific Daylight Time)">20:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(I don't think there is a prototype either to shove it on unfortunately. <a href="https://searchfox.org/mozilla-central/rev/45ecfdfaa2f74083b11c1414ddb4c1a640b0d19d/js/src/vm/JSScript.cpp#725">https://searchfox.org/mozilla-central/rev/45ecfdfaa2f74083b11c1414ddb4c1a640b0d19d/js/src/vm/JSScript.cpp#725</a>)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Jun 23 2022 13:44:05 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: I'm willing to do some minor violence here.  I can gate on whether recording is on and precompute a hash to store on the script source object.  Need to get my hands on that source in a relatively pure form for hashing though.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Jun 23 2022 13:46:34 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell">Our fork is running into this major perf issue where we spend multiple seconds hashing some js source files of around 15mb or so.  Just converting that <em>to</em> a JSString, then utf8-encoding that into a byte array, then hashing that byte array..</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Jun 23 2022 13:49:42 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell">15mb is too much javascript</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Jun 23 2022 13:53:10 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell">I can't figure out how the fields are mapped either.  ScriptSourceObject sets a bunch of inner slots, but where's the property map and shape definition done?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Jun 23 2022 14:23:30 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj2</span>: ScriptSourceObject has no exposed properties so it is just a default empty-shape-with-a-couple-reserved-slots</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Jun 23 2022 14:24:00 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">We generally are using C++ / self-hosting that knows the concrete type and the slot-index enum</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Jun 23 2022 14:25:02 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Does having the hash on ScriptSource (the non-object, C++ type) make it easier?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Jun 23 2022 14:25:47 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">For example, if you were using Debugger API for this stuff, you'd have a DebuggerScript instead of a raw ScriptSourceObject, and that would be a good place to shove the hash function</td></tr>

</tbody></table></div></div></div>
</body></html>