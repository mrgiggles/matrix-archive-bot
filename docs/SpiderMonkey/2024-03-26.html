<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-03-26</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-03-26<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-03-25" class="nav-link"><span>prev</span></a>
<a href="2024-03-27" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Mar 26 2024 06:56:59 GMT-0700 (Pacific Daylight Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@julienw:mozilla.org">julienw</span>&gt;</div></td><td class="msg-cell">hey folks,
I'm looking at this profile: <a href="https://profiler.firefox.com/public/2472k1k8y08jzryrcj1f60jsntaae0br7dax5ag/flame-graph/?globalTrackOrder=0w3&amp;thread=3&amp;v=10">https://profiler.firefox.com/public/2472k1k8y08jzryrcj1f60jsntaae0br7dax5ag/flame-graph/?globalTrackOrder=0w3&amp;thread=3&amp;v=10</a> 
It looks like that the same JS stack has various occurrences of "js::RunScript", which makes the profiler show different stacks. Do you know why this happens and do you think this could be avoided?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Mar 26 2024 07:09:52 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">julienw</span>: it's likely because we call into the c++ interpreter from JIT code a few times before the function can be baseline interpreted and JIT compiled</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Mar 26 2024 07:10:25 GMT-0700 (Pacific Daylight Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I wonder why there's just the RunScript frame and not other C++ frames for the call. Do we filter those somewhere?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Mar 26 2024 07:24:49 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">oh those RunScript frames probably are the special profiler stack frames pushed <a href="https://searchfox.org/mozilla-central/rev/47a0a01e1f7ad0451c6ba6c790d5c6855df512c1/js/src/vm/GeckoProfiler-inl.h#67-68">here</a></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Mar 26 2024 07:35:31 GMT-0700 (Pacific Daylight Time)">14:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@julienw:mozilla.org">julienw</span>&gt;</div></td><td class="msg-cell">mmm yeah this makes sense</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Mar 26 2024 09:37:23 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">In JavaScript numbers are numbers, but on the C++ end, they can be either int32 or double. This makes it easy to miss numeric values inside a native function. How do you all deal with this? I cast to std::variant&lt;int32_t, double&gt;, but it's a bit annoying and I keep running into edge cases I hadn't thought of. I wonder if there's a better way?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Mar 26 2024 09:46:04 GMT-0700 (Pacific Daylight Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">all int32s are exactly representable as doubles, so if you don't need to remember which one was in the JS::Value, you may as well just use double in your native function. if you <em>do</em> need to distinguish them, then you may as well use JS::Value directly</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Mar 26 2024 09:54:21 GMT-0700 (Pacific Daylight Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yes you can use <code>value.isNumber()</code>/<code>value.toNumber()</code> if you want to handle both int32 and double values</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Mar 26 2024 10:08:46 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Ah, I'd forgotten about toNumber(). This makes much more sense than what I'm doing.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Mar 26 2024 11:38:53 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">Hi all, I'm trying to build ESR115 on macos aarch64, but I get the error "Failed to find an adequate linker"

This happens when I run the following:

../configure --disable-jemalloc --with-system-zlib  --without-intl-api  --enable-optimize  --disable-js-shell  --disable-tests  --disable-new-pass-manager</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Mar 26 2024 11:40:48 GMT-0700 (Pacific Daylight Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">When executing the script it finds the clang/clang++ but fails when trying to resolve the linker.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Mar 26 2024 11:41:33 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">try checking  <code>config.log</code> file to see how it fails</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Mar 26 2024 11:43:31 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell"><pre><code>INFO: checking for target linker...
DEBUG: Executing: `/usr/bin/clang -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX14.sdk -mmacosx-version-min=11.0 -std=gnu99 --target=arm64-apple-darwin -Wl,--version`
ERROR: Failed to find an adequate linker
</code></pre>
</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Mar 26 2024 11:46:29 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@saladin:n8pjl.ca">Saladin</span>&gt;</div></td><td class="msg-cell">What does <code>clang -Wl,--version</code> give you?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Mar 26 2024 11:46:53 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell"><pre><code>Apple clang version 15.0.0 (clang-1500.3.9.4)
Target: arm64-apple-darwin23.4.0
Thread model: posix
InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin
</code></pre>
</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Mar 26 2024 11:48:07 GMT-0700 (Pacific Daylight Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@saladin:n8pjl.ca">Saladin</span>&gt;</div></td><td class="msg-cell">Without a space in <code>-Wl,--version</code>.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Mar 26 2024 11:48:44 GMT-0700 (Pacific Daylight Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">ah it gives me an error</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Mar 26 2024 11:56:21 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">fwiw, the clang downloaded by the build system is 17.0.6</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Mar 26 2024 11:58:18 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: can linear string data move? (My guess is yes, if some of that can be stored inline)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Mar 26 2024 11:58:44 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Heh, I recently wrote a comment listing out the ways.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Mar 26 2024 11:59:00 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, inline strings can move. So can nursery strings with nursery-allocated data.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Mar 26 2024 11:59:18 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">aha</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Mar 26 2024 11:59:25 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">is there some way to prevent that?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Mar 26 2024 11:59:29 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">also nursery strings with malloced data that get deduplicated during tenuring</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Mar 26 2024 11:59:30 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">temporarily </td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Mar 26 2024 11:59:36 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>AutoStableStringChars</code></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Mar 26 2024 11:59:47 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">one just puts that on stack?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Mar 26 2024 12:00:06 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it holds a string, and copies out the chars if they might move</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Mar 26 2024 12:00:13 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(and does things to prevent other reasons for moving)</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Mar 26 2024 12:00:29 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">but doesn't keep the chars in the original place?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Mar 26 2024 12:00:31 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so you have to access the chars through the ASSC</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Mar 26 2024 12:00:41 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">right, it does not actually pin the chars</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Mar 26 2024 12:00:53 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(it kinda does in certain cases, but not for everything)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Mar 26 2024 12:01:09 GMT-0700 (Pacific Daylight Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">I was able to get past this error by changing the script <code>toolchain.configure</code>  from <code>version_check=["-Wl, --version"]</code> to two lists each with <code>["-Wl"]</code> and <code>[" --version"]</code> separately.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Mar 26 2024 12:01:56 GMT-0700 (Pacific Daylight Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell"><p>Now gets a little further to</p>
<pre><code>INFO: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/llvm-otool
DEBUG: Executing: `/usr/bin/clang --print-prog-name=llvm-install-name-tool`
INFO: checking for install_name_tool...
DEBUG: install_name_tool: Looking for llvm-install-name-tool
DEBUG: install_name_tool: Looking for install-name-tool
INFO: not found
ERROR: Cannot find install_name_tool
</code></pre>
</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Mar 26 2024 12:02:40 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><p>The comment, fwiw:</p>
<pre><code>// String characters are movable in the following cases:
//
// 1. Inline nursery strings (moved during promotion)
// 2. Nursery strings with nursery chars (moved during promotion)
// 3. Nursery strings that are deduplicated (moved during promotion)
// 4. Inline tenured strings (moved during compaction)
</code></pre>
</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Mar 26 2024 12:03:49 GMT-0700 (Pacific Daylight Time)">19:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">also, you can <a href="https://searchfox.org/mozilla-central/rev/fb2ad9ca7150890da5cadc458acdd10c87fd9a12/js/public/String.h#83-86">atomize and pin strings</a>, and then use the chars of the newly created atom</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Mar 26 2024 12:05:21 GMT-0700 (Pacific Daylight Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">er wait, that's making an atom from a <code>char*</code>, that's not what I wanted...</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Mar 26 2024 12:06:55 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but it sounds like you're looking to pin a string's chars, and the short answer is no we don't support that</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Mar 26 2024 12:23:10 GMT-0700 (Pacific Daylight Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">this is about passing the raw chars to DOM</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Mar 26 2024 12:23:26 GMT-0700 (Pacific Daylight Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">since converting to nsString is slow</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Mar 26 2024 12:24:42 GMT-0700 (Pacific Daylight Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if it's slow because of the copying, then only copying inline strings and fixing up the rest might work</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Mar 26 2024 12:25:09 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">fixing up the rest?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Mar 26 2024 12:25:19 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">marking them as immobile</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Mar 26 2024 12:25:42 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">but yes, I think the problematic case is when the string is quite long</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Mar 26 2024 12:25:43 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">there's still the nursery chars case</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Mar 26 2024 12:26:17 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">long strings will only get moved if they're deduplicated or if they were nursery-allocated (the chars, not the string)</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Mar 26 2024 12:26:44 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we can mark them as nondeduplicatable at any time (though I was hoping to remove that bit...)</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Mar 26 2024 12:27:44 GMT-0700 (Pacific Daylight Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and maybe hope that nursery-allocated chars are rare enough to not matter (though note that we'll likely to increasing the frequency soon)</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Mar 26 2024 12:29:09 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it could be eg an infallible <code>bool JS::PinStringCharacters(JSString* str)</code> that returns false if it can't pin, in which case you'd fall back to copying</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Mar 26 2024 12:30:42 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">optimally, you'd know in advance when you create the <code>JSString</code> that you'll be pinning it, in order to avoid nursery-allocating the chars</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Mar 26 2024 12:31:12 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but that's not necessary</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Mar 26 2024 13:27:11 GMT-0700 (Pacific Daylight Time)">20:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">peterv</span>: at least locally your patch seems to make significant change to profiles. But given above, something might need to be tweaked. I'm pushing <del>a variant of</del> the patch to try. Hopefully it is stable enough to get some numbers</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Mar 26 2024 13:40:30 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">ok, sounds good</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Mar 26 2024 13:54:43 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it should be a single list element (and it is), <code>["-Wl,--version"]</code>. It doesn't seem like your compiler/linker install is correct. Can you compile and link anything successfully with <code>clang</code>? Eg make a <code>dummy.cpp</code> file with <code>int main() {}</code> and run <code>clang -o dummy dummy.cpp</code>?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Mar 26 2024 15:14:20 GMT-0700 (Pacific Daylight Time)">22:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">I can compile with clang without issues.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Mar 26 2024 15:16:07 GMT-0700 (Pacific Daylight Time)">22:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell"><p>I was able to get around the install_name_tool issue by changing a line in moz.configure:</p>
<p><code>plain_llvm_or_prefixed("install_name_tool"),</code> instead of<br>
<code>plain_llvm_or_prefixed("install-name-tool"),</code></p>
</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Mar 26 2024 15:38:59 GMT-0700 (Pacific Daylight Time)">22:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell"><p>I've been having a lot of issues with the python environment. In particular, I was getting errors saying: <code>ModuleNotFoundError: No module named 'six.moves'</code></p>
<p>I was able to work around these but running into them once again.</p>
<p>The latest issue was when checking for zlib, the configure script was not able to find "pkg-config" even though it was installed. I tried passing in the PKG_CONFIG_PATH but no luck. Finally I was able to get past this step by changing the following:</p>
<pre><code>pkg_config = check_prog(
    "PKG_CONFIG",
    pkg_config,
  bootstrap=depends(when=target_sysroot.bootstrapped)(lambda: "pkgconf"),
    allow_missing=True,
    when=compile_environment
    &amp; depends(target.os)(lambda os: os not in ("WINNT",  "Android")),
)
</code></pre>
<p>to not check for "OSX". Now I'm getting the same error when running "Make" regarding "six.moves"</p>
</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Mar 26 2024 15:39:07 GMT-0700 (Pacific Daylight Time)">22:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell"><code>ModuleNotFoundError: No module named 'six.moves'</code></td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Mar 26 2024 15:39:39 GMT-0700 (Pacific Daylight Time)">22:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">Could this all be related to my python environment? I have python3 installed, and definitely have "six" module installed.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Mar 26 2024 16:04:05 GMT-0700 (Pacific Daylight Time)">23:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">the pkg-config problem is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1776255">https://bugzilla.mozilla.org/show_bug.cgi?id=1776255</a>. unfortunately the answer was "nobody should ever do that on macOS", so I think your only option is to patch it</td></tr>

</tbody></table></div></div></div>
</body></html>