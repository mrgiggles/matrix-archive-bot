<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-09-18</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-09-18<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-09-15" class="nav-link"><span>prev</span></a>
<a href="2023-09-21" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Sep 18 2023 02:50:44 GMT-0700 (Pacific Daylight Time)">09:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><p>Is there any way in Spidermonkey of getting a callback when <em>any</em> property on the entire tree changes? Like:</p>
<pre><code>/*JS*/ any.old.property = 5

/*C++*/ void callback(JSObject* ob, PropertyKey k, JSValue v)
{
// ob == any.old
// k == "property"
// value == 5
}
</code></pre>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Sep 18 2023 03:20:00 GMT-0700 (Pacific Daylight Time)">10:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what I can think of is to use Proxy for <code>any</code> and <code>any.old</code></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Sep 18 2023 03:20:20 GMT-0700 (Pacific Daylight Time)">10:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is there any restriction about <code>any</code> and <code>any.old</code> ?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Sep 18 2023 03:20:27 GMT-0700 (Pacific Daylight Time)">10:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what are they supposed to be?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Sep 18 2023 05:30:33 GMT-0700 (Pacific Daylight Time)">12:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Yeah I'm using Proxies already in some places, but I was wondering if there were any other options. My idea here is that any.old is user code which is just a regular object, but I'd like to be able to "listen" to it for changes.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Sep 18 2023 05:32:00 GMT-0700 (Pacific Daylight Time)">12:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">It would make things much easier for me if there were some sort of universal property change listener. But I'm guessing that there is no such thing.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Sep 18 2023 05:37:38 GMT-0700 (Pacific Daylight Time)">12:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">If both object and the assignment are from user-side (so, same global), I think there's no way to listen to the modification.  if they come from different global, there might be some chance with CCW or similar thing to intercept the operation</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Sep 18 2023 05:38:00 GMT-0700 (Pacific Daylight Time)">12:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">example: <a href="https://searchfox.org/mozilla-central/rev/431bcb0e88e49b92c6913c0916c7ad15e8a4875c/js/xpconnect/wrappers/XrayWrapper.h#379">xpc::XrayWrapper</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Sep 18 2023 05:46:17 GMT-0700 (Pacific Daylight Time)">12:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Both the object and the assignment are from the user side, and I currently have only one global. I could look at having two globals for this purpose, but it looks like it would get complicated </td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Sep 18 2023 05:51:06 GMT-0700 (Pacific Daylight Time)">12:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Some context here: the user types in some code which is interpreted in the "scope" of my custom JS::Proxy class. The Proxy class keeps track of property changes to itself. This works fine, but if there are sub-property changes, the Proxy doesn't pick them up.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Sep 18 2023 05:52:15 GMT-0700 (Pacific Daylight Time)">12:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">So it's not actually global property changes that I want to track, but sub-property changes, like `<a href="http://myProxy.userObject.property">myProxy.userObject.property</a> = 6`</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Sep 18 2023 06:13:56 GMT-0700 (Pacific Daylight Time)">13:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you can achieve it by returning a new proxy for property access</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Sep 18 2023 06:15:03 GMT-0700 (Pacific Daylight Time)">13:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">I'm not sure I understand...</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Sep 18 2023 06:15:29 GMT-0700 (Pacific Daylight Time)">13:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Do you mean that I replace normal objects with Proxies?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Sep 18 2023 06:15:39 GMT-0700 (Pacific Daylight Time)">13:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">let me create an example</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Sep 18 2023 06:20:22 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-js">function wrap(obj) {
  return new Proxy(obj, {
    get(that, key) {
      console.log("get", key);
      const value = that[key];
      if (value !== null &amp;&amp; typeof value === "object") {
        return wrap(value);
      }
      return value;
    },

    set(that, key, value) {
      console.log("set", key, value);
      that[key] = value;
    }
  });
}

var any = { old: {} };

any = wrap(any);

any.old.property = 5;
</code></pre>
</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Sep 18 2023 06:22:36 GMT-0700 (Pacific Daylight Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, the Proxy returns yet another proxy when "get" operation is performed and the value is an object.  so that any operation on the object can also be tracked</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Sep 18 2023 06:30:05 GMT-0700 (Pacific Daylight Time)">13:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Interesting, so this essentially converts the whole thing into Proxies, without the user knowing it. </td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Sep 18 2023 06:31:17 GMT-0700 (Pacific Daylight Time)">13:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Is this a normal thing to do in Javascript? It strikes me that there might be unintended consequences or complications down the line.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Sep 18 2023 06:39:04 GMT-0700 (Pacific Daylight Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">some operation might not work well with Proxy, such as when the proxy is used as base class of other class <code>class C extends proxied_object {...}</code></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Sep 18 2023 06:42:26 GMT-0700 (Pacific Daylight Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, in simple cases, it's almost transparent, but it's still observable from user code in some edge case</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Sep 18 2023 06:44:00 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Ok, worth trying out then. I'm not worried about extends.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Sep 18 2023 06:44:21 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Thanks for the novel suggestion, I'll see how it goes.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Sep 18 2023 06:44:22 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm not sure if this is something usually done in JS tho, we've considered it when refactoring internal module system's laziness.  and the <code>extends</code> was problematic in that case and we decided not to do it</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Sep 18 2023 08:23:57 GMT-0700 (Pacific Daylight Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I've done it for a side project, though I was wrapping in <code>set</code> rather than <code>get</code>. It worked well enough for the very limited thing I was using it for (a state object), though even there I ended up wanting it to work for <code>Map</code> and <code>Set</code> as well. (Mine maintained a <code>dirty</code> bit that was set on all ancestors in the DAG whenever a property was modified.)</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Sep 18 2023 08:53:16 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">if I'd do a <code>loadtypedarrayelementhole</code> two times on the same bigint64 array, would I get two times the very same value? no other instruction is in between and the index ist the same. in particular, would the <code>valueReg()</code> be the same at runtime?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Sep 18 2023 09:15:08 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">l11d</span>: If the nodes are the same, I would normally expect GVN to common them up into a single copy. If you've turned GVN off, though, it looks like we allocate a fresh bigint every time: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#15952-15993">https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#15952-15993</a></td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Sep 18 2023 09:34:35 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>:  that makes sense, thanks. I'm cloning a MIR instruction like this <code>clone = ins-&gt;clone()</code>. can I somehow determine whether their <code>valueReg()</code> will be the same? I guess at least <code>congruentTo()</code> should be true but that might not be sufficient</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Sep 18 2023 09:45:20 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, <code>congruentTo</code> would be true in the case you've described.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Sep 18 2023 09:48:19 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't think there's an easy way to make that determination. Strings and bigints are heap-allocated but compare by-value, so whether two copies of the same string/bigint are pointing to the same memory is an optimization choice, not a correctness issue.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Sep 18 2023 09:49:09 GMT-0700 (Pacific Daylight Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I suspect that it will probably be true in practice for anything that doesn't allocate memory</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Sep 18 2023 09:49:38 GMT-0700 (Pacific Daylight Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But I don't think we expose whether an op could allocate memory in any easy-to-access way either</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Sep 18 2023 09:53:45 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">MNewObject can be cloned but it would not be congruent to it-self.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Sep 18 2023 10:01:47 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">so if an instruction is congruent to itself there is a chance that the <code>valueReg()</code> is the same, but it might differ for string/bigint (and maybe other).<br>thanks for the support :)</td></tr>

</tbody></table></div></div></div>
</body></html>