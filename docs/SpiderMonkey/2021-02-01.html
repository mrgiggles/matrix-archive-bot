<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-02-01</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-02-01<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-01-31" class="nav-link"><span>prev</span></a>
<a href="2021-02-03" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sun Jan 31 2021 16:49:51 GMT-0800 (Pacific Standard Time)">00:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jarred:mozilla.org">jarred</span>&gt;</div></td><td class="msg-cell">@jandem there're some usages of WASM in other JS contexts, but these SABs are not part of it and the worker loading the map data doesn't use any WASM. On Chrome, it shows 145,646 SharedArrayBuffer objects totaling 163 MB after everything loads. This includes mesh geometry data and other stuff. I will try to make a simple way to reproduce this
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sun Jan 31 2021 17:07:30 GMT-0800 (Pacific Standard Time)">01:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jarred:mozilla.org">jarred</span>&gt;</div></td><td class="msg-cell"><p>@jandem I'm able to reproduce the issue. <code>MaximumLiveMappedBuffers</code> seems to apply to all <code>SharedArrayBuffer</code> objects, regardless of whether or not WASM is in use. In other words, Firefox currently has a limit of <code>MaximumLiveMappedBuffers</code> allocated shared array buffer objects regardless of the amount of memory they use.</p>
<p>If you paste this code into the console of any site with <code>crossOriginIsolated</code> set to <code>true</code>, it will throw an error while creating the <code>SharedArrayBuffer</code> objects (but not while creating the <code>ArrayBuffer</code> objects):</p>
<pre><code class="language-js">const ab = [];
for (let i = 0; i &lt; 1000; i++) { ab.push(new Uint8Array(new ArrayBuffer(1))) }
console.log("Created ", ab.length, "ArrayBuffer objects")

const sab = [];
for (let i = 0; i &lt; 1000; i++) { sab.push(new Uint8Array(new SharedArrayBuffer(1))) }
console.log("Created ", sab.length, "SharedArrayBuffer objects")
</code></pre>
<p>For testing, I just clicked the first site that showed up when googling crossOriginIsolation (<a href="https://labs.jxck.io/site-isolation/crossOriginIsolated/index.html">https://labs.jxck.io/site-isolation/crossOriginIsolated/index.html</a>)</p>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sun Jan 31 2021 17:09:29 GMT-0800 (Pacific Standard Time)">01:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jarred:mozilla.org">jarred</span>&gt;</div></td><td class="msg-cell">It does not happen if the SABs are created but have no more references (so if you don't push them onto the array, it won't throw) </td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sun Jan 31 2021 17:21:43 GMT-0800 (Pacific Standard Time)">01:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jarred:mozilla.org">jarred</span>&gt;</div></td><td class="msg-cell"><p>A unit test might look something like this:</p>
<pre><code class="language-js">
 // Not sure how you expose cpp constants in js
import {MaximumLiveMappedBuffers} from './ArrayBufferObject.constants';

it("can create more than `MaximumLiveMappedBuffers` SharedArrayBuffer objects", () =&gt; {
   let strong = new Array(MaximumLiveMappedBuffers + 2)

   expect(() =&gt; {
    for (let i = 0; i &lt; strong.length; i++) {
      strong[i] = new SharedArrayBuffer(1);
    }
   }).not.toThrow()
  
})

</code></pre>
<p>but with another test for memory usage instead of buffer count? Maybe <code>MaximumLiveMappedBuffers</code> should be based on <code>byteLength</code> of the SharedArrayBuffer objects instead of the count of the instances?</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Feb 01 2021 00:18:40 GMT-0800 (Pacific Standard Time)">08:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">jarred</span>: I filed bug 1689948, thanks for reporting this!</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Feb 01 2021 00:18:42 GMT-0800 (Pacific Standard Time)">08:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1689948">https://bugzil.la/1689948</a> â€” NEW (nobody) â€” Creating many small SharedArrayBuffers can easily exceed MaximumLiveMappedBuffers</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Feb 01 2021 01:17:20 GMT-0800 (Pacific Standard Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@jarred:mozilla.org">jarred</span>&gt;</div></td><td class="msg-cell">np! thanks for filing and for being open to receiving bug reports from random people on the internet </td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Feb 01 2021 01:30:38 GMT-0800 (Pacific Standard Time)">09:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">we depend on these bug reports :) </td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Feb 01 2021 05:24:22 GMT-0800 (Pacific Standard Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">Hello folks, I hope you're doing well. I've got a question regarding SM's optimizing JIT. I think I understood the code pipeline that goes from the interpreter, to baseline, to CacheIR, to the transpiler and so on. I'm now interested in understanding the various compiler optimizations of the engine. It seems that everything takes place in <code>OptimizeMIR</code> inside <code>Ion.cpp</code>. I thought maybe the way to learn is to step through each optimization pass in the code and try to understand what and why it does it (while also staring at the iongraph output). However, I have no compiler engineering background and I'm afraid it may not be so approachable. Any tips on how to approach all these JIT optimizations?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Feb 01 2021 05:35:27 GMT-0800 (Pacific Standard Time)">13:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the optimization passes where it's easiest to see the effect on the graph are probably LICM (hoisting things before loops if possible), GVN (eliminating 'duplicate' instructions) and DCE (dead code elimination)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Feb 01 2021 05:37:14 GMT-0800 (Pacific Standard Time)">13:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">to see information about LICM for example you can use <code>IONFLAGS=licm</code> (requires a debug build)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Feb 01 2021 07:07:16 GMT-0800 (Pacific Standard Time)">15:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">confession: Prototyping the removal of self-hosting Global/Zone entirely. (Bug 1688794)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Feb 01 2021 07:07:18 GMT-0800 (Pacific Standard Time)">15:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Feb 01 2021 07:09:19 GMT-0800 (Pacific Standard Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1688794">https://bugzil.la/1688794</a> â€” NEW (tcampbell) â€” Consider replacing self-hosted cloning with stencil-instantiate</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Feb 01 2021 08:55:53 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">when I grow up, I want to learn to write code like the fuzzer does. <code>function main() { new main; }; try { main() } catch(e) {}; ...</code></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Feb 01 2021 08:56:08 GMT-0800 (Pacific Standard Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">just needs a helpful comment at the beginning: <code>// pre-warm the stack</code></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Feb 01 2021 10:23:00 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: I don't think we have a description of all our MIR passes anywhere, so I wrote up a <a href="https://docs.google.com/document/d/1t1K6Y2KJuAsugsVTarpQsk2ztHeD3nxTcItxE63zqHE/edit?usp=sharing">very quick summary</a>. Seems like a useful thing to have lying around.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Feb 01 2021 10:26:27 GMT-0800 (Pacific Standard Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: perfect, add it to the source-docs ðŸš€</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Feb 01 2021 10:34:51 GMT-0800 (Pacific Standard Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">No rest for the wicked</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Feb 01 2021 10:36:49 GMT-0800 (Pacific Standard Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: cheers <a href="https://paste.mozilla.org/4rJFzhF7">https://paste.mozilla.org/4rJFzhF7</a></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Feb 01 2021 10:37:47 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">No worries, I'm already polishing it up with a bit more of an intro / etc</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Feb 01 2021 10:48:16 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">iain: thank you so much! Much appreciated :)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Feb 01 2021 11:56:52 GMT-0800 (Pacific Standard Time)">19:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Does anybody know how I can build the source-docs locally?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Feb 01 2021 11:57:31 GMT-0800 (Pacific Standard Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>mach doc</code> does something. Dunno what.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Feb 01 2021 12:03:18 GMT-0800 (Pacific Standard Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">there is some python/pip finagling  that needs to be done, but then it does nice auto-refresh-on-save</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Feb 01 2021 12:03:47 GMT-0800 (Pacific Standard Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Sweet, thanks, that works</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Feb 01 2021 12:07:20 GMT-0800 (Pacific Standard Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Anybody want to volunteer to review?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Feb 01 2021 12:09:36 GMT-0800 (Pacific Standard Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I would be a crappy reviewer, because just about everything you wrote was new to me. Or in other words: it was <em>awesome</em>, thanks!</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Feb 01 2021 12:19:53 GMT-0800 (Pacific Standard Time)">20:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Okay, I've arbitrarily picked Ted as a reviewer to ensure that I didn't do anything stupid with source-docs, but if anybody else wants to read through and point out any glaring errors, the phabricator revision is here: <a href="https://phabricator.services.mozilla.com/D103707">https://phabricator.services.mozilla.com/D103707</a></td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Feb 01 2021 12:22:47 GMT-0800 (Pacific Standard Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: I think you attached the wrong patch</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Feb 01 2021 12:23:48 GMT-0800 (Pacific Standard Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: the lint-bots will post a rendered version in a few minutes to tell you about formatting</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Feb 01 2021 12:24:09 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">but also what Tom said. lol</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Feb 01 2021 12:24:32 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">"glaring error" indeed</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Feb 01 2021 12:39:39 GMT-0800 (Pacific Standard Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">hahaha oops</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Feb 01 2021 12:39:54 GMT-0800 (Pacific Standard Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I split my current diff into two patches but got the names swapped</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Feb 01 2021 12:50:59 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Should be better now</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Feb 01 2021 15:25:57 GMT-0800 (Pacific Standard Time)">23:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: I've rebased onto m-c and repushed. Not sure if something is broken with the preview generation.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Feb 01 2021 15:27:54 GMT-0800 (Pacific Standard Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I think it is running now? the rebase warning seem to be gone</td></tr>

</tbody></table></div></div></div>
</body></html>