<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-06-21</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-06-21<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-06-20" class="nav-link"><span>prev</span></a>
<a href="2022-06-22" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jun 21 2022 02:22:34 GMT-0700 (Pacific Daylight Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">The circular buffer case is a way to avoid the memory-consistency + prefetching issue like I mentioned, such that the producer can produce without blocking the consumer. When the producer generate content, the core running it will prefect memory, taking the ownership of the memory. If this memory is being read by the consumer, when looping back, then the consumer has to re-take the ownership of the memory before reading it, which adds extra core synchronizations.  Using multiple virtual addresses for the same memory region is a way to avoid this aliasing and let the producer owns the prefetched virtual addresses, while the consumer owns its space of virtual addresses. locks are then used to either swap memory regions between the cores.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jun 21 2022 06:06:51 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">Wow. that seems. like I can't beleive that works.  First I just always assumed caching cared about physical addresses.  But then I'm still finding it hard to see why the consumer won't read something inconsistent. I'd have to spend some time staring at it.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jun 21 2022 06:08:46 GMT-0700 (Pacific Daylight Time)">13:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">What I was imagining was a case where according to the instruction cache some line of memory is in one state, and according to the data cache it's in another.  But I suppose there's cache flushes/etc that we'd have to do even if both are using the same virtual addresses.  (the kind of thing you answer for yourself when you go to ask the question.)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jun 21 2022 07:29:48 GMT-0700 (Pacific Daylight Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">pbone</span>: the consumer will read inconsistent state, unless you swap the pages between the consumer and producer.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jun 21 2022 07:46:59 GMT-0700 (Pacific Daylight Time)">14:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">I'm exploring adding an interface to <code>JSContext</code> but it looks like it doesn't like having a vtable (see <a href="https://searchfox.org/mozilla-central/source/js/src/vm/JSContext.cpp#1023">here</a>). Does anyone know the reasoning behind this assertion?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jun 21 2022 07:54:23 GMT-0700 (Pacific Daylight Time)">14:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">outside the engine, <code>JSContext</code> is an opaque type that's reinterpret-casted to/from <code>RootingContext</code> (a base class)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jun 21 2022 07:59:47 GMT-0700 (Pacific Daylight Time)">14:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">ok. Thanks!</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jun 21 2022 08:00:30 GMT-0700 (Pacific Daylight Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I was hoping the frontend could be separate. Does that get annoying with error handling or alloc policies?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jun 21 2022 08:02:06 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">I think it could be separate at the end, but during the transition, I was trying to reuse JSContext</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jun 21 2022 08:02:12 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: could this be solved with a <code>final</code> keyword on the <code>JSContext</code> class definition?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jun 21 2022 08:10:46 GMT-0700 (Pacific Daylight Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Even if <code>JSContext</code> is <code>final</code>, it would still have a vtable if I make it subclass an interface, so <code>reinterpret_cast&lt;&gt;()</code> won't <del>work</del> return the correct pointer to the object</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jun 21 2022 08:11:47 GMT-0700 (Pacific Daylight Time)">15:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">(I just verified <code>JSContext final</code> still segfaults on the first test in jsapi-tests)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jun 21 2022 08:51:56 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Another option is to have a class which can be derived, and have a derived class which forward calls to the JSContext. This way you can extend the derived class, the JScontext can own the an instance of the forwarding derived class.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jun 21 2022 13:30:37 GMT-0700 (Pacific Daylight Time)">20:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">is the pointer identity of a string value ever exposed to JS code? e.g. can JS ever determine if two JS string values are backed by different JSString pointers?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jun 21 2022 13:33:45 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">No</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jun 21 2022 13:35:35 GMT-0700 (Pacific Daylight Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">String comparison bottoms out here in the spec: <a href="https://tc39.es/ecma262/#sec-samevaluenonnumeric">https://tc39.es/ecma262/#sec-samevaluenonnumeric</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jun 21 2022 13:36:41 GMT-0700 (Pacific Daylight Time)">20:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(I checked ==, ===, and <a href="http://Object.is">Object.is</a>)</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jun 21 2022 13:36:54 GMT-0700 (Pacific Daylight Time)">20:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(If there are other comparison operations I've forgotten, they should have the same behaviour)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jun 21 2022 13:37:06 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">Yeah, that seems reasonable. There's a proposal to add a stringref type to wasm that would be expected to map to a JS string, and it's ambiguous if pointer equality would be an allowed operation. Sounds like it should not be then</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jun 21 2022 13:38:40 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Sounds right</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jun 21 2022 13:39:36 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">Thanks!</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jun 21 2022 13:41:10 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You can compare strings for equality in Rust by casting them to pointers (see the last paragraph here <a href="https://stackoverflow.com/a/70648961">https://stackoverflow.com/a/70648961</a>)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jun 21 2022 13:41:24 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But Rust definitely pushes towards comparing content</td></tr>

</tbody></table></div></div></div>
</body></html>