<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-07-06</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-07-06<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-07-05" class="nav-link"><span>prev</span></a>
<a href="2022-07-07" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Jul 06 2022 04:46:08 GMT-0700 (Pacific Daylight Time)">11:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">Does anyone know why after calling JS::ResetMathRandomSeed(), the next two Math.random() calls have the same first 3 decimal places?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Jul 06 2022 04:52:28 GMT-0700 (Pacific Daylight Time)">11:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">I have a feeling we (Fastly) are not seeding correctly but I can't find a public SpiderMonkey API for seeding the PRNG</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Jul 06 2022 04:54:13 GMT-0700 (Pacific Daylight Time)">11:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">which version of SpiderMonkey are you using?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Jul 06 2022 04:54:33 GMT-0700 (Pacific Daylight Time)">11:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't see <code>JS::ResetMathRandomSeed</code> in latest code or some esrs</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Jul 06 2022 04:58:05 GMT-0700 (Pacific Daylight Time)">11:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">FIREFOX_96_0b8_RELEASE is a tag I can see, commit sha is 250a5c528e5a8438e6366e502512f97c09cf38c0</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Jul 06 2022 05:02:07 GMT-0700 (Pacific Daylight Time)">12:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">which file has the function?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Jul 06 2022 05:05:22 GMT-0700 (Pacific Daylight Time)">12:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I cannot locate it in the commit history</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jul 06 2022 05:11:17 GMT-0700 (Pacific Daylight Time)">12:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">iirc, we don't expose the internal of the RNG</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jul 06 2022 05:12:15 GMT-0700 (Pacific Daylight Time)">12:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">we have <a href="https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/js/src/builtin/TestingFunctions.cpp#6989">SetRNGState</a> function, but it's internal function only for automated testing</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jul 06 2022 05:54:42 GMT-0700 (Pacific Daylight Time)">12:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">ah yes, it looks to be an addition from our fork of spidermonkey, sorry for the confusion <span class="nick-15">arai</span> <a href="https://github.com/bytecodealliance/gecko-dev/commit/696c1839c12cea589e4586fc3898b0bba8248f2f">https://github.com/bytecodealliance/gecko-dev/commit/696c1839c12cea589e4586fc3898b0bba8248f2f</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jul 06 2022 05:56:46 GMT-0700 (Pacific Daylight Time)">12:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the <code>randomNumberGenerator_</code> field gets reset, then the RNG is re-created at the next call in <a href="https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/js/src/jsmath.cpp#506-515">JS::Realm::getOrCreateRandomNumberGenerator</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jul 06 2022 05:58:26 GMT-0700 (Pacific Daylight Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and the seed used there is either the random value read from OS, or the current time</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jul 06 2022 05:58:33 GMT-0700 (Pacific Daylight Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/js/src/jsmath.cpp#488-495">js::GenerateRandomSeed</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jul 06 2022 05:59:46 GMT-0700 (Pacific Daylight Time)">12:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">ah yes that will be it, we are compiling to wasm so i suppose it is using current time</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jul 06 2022 06:02:49 GMT-0700 (Pacific Daylight Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">I'm still not sure how that ends up with the first two calls having the same first 3 decimal places though</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jul 06 2022 06:03:24 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">every time?  also, it's the same value across multiple runs?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Jul 06 2022 06:05:32 GMT-0700 (Pacific Daylight Time)">13:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I wonder if the seed generated there doesn't have sufficient randomness</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Jul 06 2022 06:06:43 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or perhaps <code>mozilla::RandomUint64()</code> returns some fixed value due to unexpected environment</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jul 06 2022 06:07:57 GMT-0700 (Pacific Daylight Time)">13:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">different value across multiple runs but the first two calls always have the same 3 decimal places</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jul 06 2022 06:08:56 GMT-0700 (Pacific Daylight Time)">13:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">out of curiosity, what's the actual value?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jul 06 2022 06:10:19 GMT-0700 (Pacific Daylight Time)">13:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">First 3 math.random results in the last couple runs:
run 1:
0.9797776662407857,
0.9798428630414311,
0.2071120659692286


run 2:
0.026678322792744846,
0.026705225373357178,
0.008078149451921757

run 3:
0.35238053072082076,
0.3524265820935848,
0.8079243272762002
</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jul 06 2022 06:14:02 GMT-0700 (Pacific Daylight Time)">13:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">We have an online 'playground' where you can run a program with the js runtime and see the live results if that is helpful -- <a href="https://fiddle.fastlydemo.net/fiddle/cf455996">https://fiddle.fastlydemo.net/fiddle/cf455996</a></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jul 06 2022 06:14:23 GMT-0700 (Pacific Daylight Time)">13:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>if it's falling back to the timestamp, it might be that because we're using the same value for lower and higher 32bits <a href="https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/js/src/jsmath.cpp#491-494">https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/js/src/jsmath.cpp#491-494</a></p>
<pre><code class="language-cpp">return maybeSeed.valueOrFrom([] {
  // Use PRMJ_Now() in case we couldn't read random bits from the OS.
  uint64_t timestamp = PRMJ_Now();
  return timestamp ^ (timestamp &lt;&lt; 32);
</code></pre>
</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jul 06 2022 06:15:24 GMT-0700 (Pacific Daylight Time)">13:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I do see similar behavior in JS shell with the above testing function</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jul 06 2022 06:15:24 GMT-0700 (Pacific Daylight Time)">13:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><pre><code>js&gt; setRNGState(Date.now(), Date.now()); [Math.random(), Math.random(), Math.random()]
[0.3033315668717934, 0.3033544962984477, 0.006047748318472657]
</code></pre>
</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jul 06 2022 06:19:38 GMT-0700 (Pacific Daylight Time)">13:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>or perhaps it's because the 2 calls have similar enough value <a href="https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/js/src/jsmath.cpp#501-502">https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/js/src/jsmath.cpp#501-502</a></p>
<pre><code class="language-cpp">seed[0] = GenerateRandomSeed();
seed[1] = GenerateRandomSeed();
</code></pre>
</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jul 06 2022 06:20:41 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>the internal state of the RNG is 128 bit <a href="https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/mfbt/XorShift128PlusRNG.h#45">https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/mfbt/XorShift128PlusRNG.h#45</a></p>
<pre><code class="language-cpp">uint64_t mState[2];
</code></pre>
</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jul 06 2022 06:21:56 GMT-0700 (Pacific Daylight Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and if we use the timestamp path, the lower 2 32-bits have same value, and the higher 2 32-bits have the same value, and lower and higher 32-bits values are similar</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Jul 06 2022 06:22:13 GMT-0700 (Pacific Daylight Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that might be very unexpected state</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Jul 06 2022 06:24:05 GMT-0700 (Pacific Daylight Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>the code that generates the value is <a href="https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/mfbt/XorShift128PlusRNG.h#72-77">https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/mfbt/XorShift128PlusRNG.h#72-77</a></p>
<pre><code class="language-cpp">uint64_t s1 = mState[0];
const uint64_t s0 = mState[1];
mState[0] = s0;
s1 ^= s1 &lt;&lt; 23;
mState[1] = s1 ^ s0 ^ (s1 &gt;&gt; 17) ^ (s0 &gt;&gt; 26);
return mState[1] + s0;
</code></pre>
</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Jul 06 2022 06:26:23 GMT-0700 (Pacific Daylight Time)">13:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, the testing function case above doesn't represent the "lower 32bits = higher 32bits" case.  but it represents the "1st and 2nd seeds are similar" case</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Jul 06 2022 06:50:44 GMT-0700 (Pacific Daylight Time)">13:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@leo60228:matrix.org">leo60228</span>&gt;</div></td><td class="msg-cell">was looking at <a href="https://spidermonkey.dev/">https://spidermonkey.dev/</a> and noticed the "stand-alone shell" and "Running tests" links 404</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Jul 06 2022 06:55:05 GMT-0700 (Pacific Daylight Time)">13:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@leo60228:matrix.org">leo60228</span>&gt;</div></td><td class="msg-cell"><a href="https://spidermonkey.dev/contribute/">https://spidermonkey.dev/contribute/</a> has the same "Running tests" link</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Jul 06 2022 06:56:00 GMT-0700 (Pacific Daylight Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@leo60228:matrix.org">leo60228</span>&gt;</div></td><td class="msg-cell">oh, that's on github pages, i'll see if i can find the new links and make a pr</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Jul 06 2022 07:07:11 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the document for building standalone shell is <a href="https://firefox-source-docs.mozilla.org/js/build.html">https://firefox-source-docs.mozilla.org/js/build.html</a></td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Jul 06 2022 07:07:29 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that page also covers the tests</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Jul 06 2022 07:08:22 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@leo60228:matrix.org">leo60228</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/mozilla-spidermonkey/spidermonkey.dev/pull/110">https://github.com/mozilla-spidermonkey/spidermonkey.dev/pull/110</a></td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Jul 06 2022 07:08:33 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@leo60228:matrix.org">leo60228</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> the document for building standalone shell is <a href="https://firefox-source-docs.mozilla.org/js/build.html">https://firefox-source-docs.mozilla.org/js/build.html</a></blockquote></mx-reply>that seems like it's a different page though?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Jul 06 2022 07:09:02 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@leo60228:matrix.org">leo60228</span>&gt;</div></td><td class="msg-cell">the originally linked page (<a href="http://web.archive.org/web/20210515144558/https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Introduction_to_the_JavaScript_shell">http://web.archive.org/web/20210515144558/https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Introduction_to_the_JavaScript_shell</a>) is about usage, not building</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Jul 06 2022 07:09:09 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Jul 06 2022 07:10:46 GMT-0700 (Pacific Daylight Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">thank you for pointing that out.  yeah, I think we don't have a in-tree document that explains usage</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Jul 06 2022 07:11:46 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, just realized I don't have right permission on the repo :P</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Jul 06 2022 07:12:47 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: can you merge the PR ?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Jul 06 2022 07:53:35 GMT-0700 (Pacific Daylight Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: does it work now? I added you to the reviewers group</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Jul 06 2022 07:53:52 GMT-0700 (Pacific Daylight Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, I see the merge button.  thank you :)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Jul 06 2022 07:54:13 GMT-0700 (Pacific Daylight Time)">14:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">great :)</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Jul 06 2022 07:54:44 GMT-0700 (Pacific Daylight Time)">14:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and merged the PR :D</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Jul 06 2022 08:01:46 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: <span class="nick-4">iain</span>: I got an idea yesterday on how to instrument our code generators to generate a profile of which code path matters the most for a benchmark, in terms of potential speed improvement we can bring.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Jul 06 2022 08:04:22 GMT-0700 (Pacific Daylight Time)">15:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: how would it work?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Jul 06 2022 08:04:44 GMT-0700 (Pacific Daylight Time)">15:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Let's discuss that in 1 hour. </td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Jul 06 2022 08:42:35 GMT-0700 (Pacific Daylight Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@allstarschh:mozilla.org">@allstarschh</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: <span class="nick-12">sfink</span> : will the GC meeting start at the original time? or will it start after the AllHands info?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Jul 06 2022 08:43:19 GMT-0700 (Pacific Daylight Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">we can start later if you like, I'm currently watching the all hands meeting</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Jul 06 2022 08:44:07 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, works for me</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Jul 06 2022 08:44:30 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@allstarschh:mozilla.org">@allstarschh</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>, <span class="nick-12">sfink</span> : okay then, we start after the AllHands info</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Jul 06 2022 09:08:28 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: before mentioning how it works I will start with what would be ideal, what we try to answer, and then how we can answer that asking a different question.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Jul 06 2022 09:09:10 GMT-0700 (Pacific Daylight Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: would you prefer a 1-on-1 video call?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Jul 06 2022 09:11:18 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Today, the problem we have when profiling something where the problem is isolated in JIT generated code, is that we have no idea of which part of the code generator should be looked at to fix the performance issue.</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Jul 06 2022 09:11:49 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">One way to get the information would be to instrument the code to report every section of generated code with the section which generated the code.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Jul 06 2022 09:13:02 GMT-0700 (Pacific Daylight Time)">16:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Doing is unfortunately going to be extremely costly as even incrementing a counter can change the profile and no longer be representative of the default profile.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Jul 06 2022 09:14:08 GMT-0700 (Pacific Daylight Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">One of the question we try to answer, is "would optimizing this make the benchmark/website faster?", which is a difficult question, because we have no profile information.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Jul 06 2022 09:15:13 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">However, there is another question we can easily ask, which is “how slowing down one part would make us slower?”. </td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Jul 06 2022 09:15:31 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This is on the other hand way easier to test, and provide the same answer.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Jul 06 2022 09:16:20 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">We could add, on each code generator path, a piece of code which is a no-op, consumes just a few nano-seconds of execution, but stack up when exercised a lot.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Jul 06 2022 09:19:58 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">With some trickery, by instrumenting N code paths to be investigated using multiple runs of the same benchmark/website, we can figure out in log_2(N) runs which generated code has the most impact on the benchmark/website.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Jul 06 2022 09:21:30 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This can be applied to literally everything, such as CodeGenerator functions, CacheIR, Baseline op-codes …</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Jul 06 2022 09:23:36 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">So if you have a log_2(N) gecko profiles, executed with different configurations of the no-op instrumentations, you should be able to recover the code-generator profile of each function reported across the log_2(N) gecko profiles.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Jul 06 2022 09:40:25 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">if incrementing counters is changing the profile in a way that it's no longer representative, don't you have the same issue if you introduce (longer) slowdowns?</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Jul 06 2022 09:41:57 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">also there's no relation between the introduced slowdown and the length or complexity of the generated code? as an extreme example, a very common no-op bytecode could show up as expensive here even though it has no overhead in the baseline jit</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Jul 06 2022 09:44:46 GMT-0700 (Pacific Daylight Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">we've used similar tricks manually (perform some operation N times instead of 1 to see how much slower it makes us), but I'm not sure if it's reliable enough to automate like this</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Jul 06 2022 09:47:04 GMT-0700 (Pacific Daylight Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> However, there is another question we can easily ask, which is “how slowing down one part would make us slower?”. </blockquote></mx-reply>I once read a blog or paper about this approach, but I've <em>never</em> been able to find it again.  Is this a well known approach?  Do you have a reference for it?</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Jul 06 2022 09:49:27 GMT-0700 (Pacific Daylight Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: I recall adding a counter to Ion loop was problematic, and this is part of why we stop counting the use-count once in Ion. Otherwise we might have better bailout strategies.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Jul 06 2022 09:50:16 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: I do not recall seeing that anywhere else. The last time I came up with an idea of slowing things done, was as a mean to advertise JS developer to not use some features such as <code>with</code> statements, about 10 years ago</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Jul 06 2022 09:50:52 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">by adding extra <code>sleep</code> calls in the code.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Jul 06 2022 09:51:19 GMT-0700 (Pacific Daylight Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">that is a well known approach, but maybe not advisable</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Jul 06 2022 09:51:41 GMT-0700 (Pacific Daylight Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I honestly never heard of it before.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Jul 06 2022 11:43:15 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">spidermonkey doesn't play ball with apple's arm64e pointer auth stuff right? (sets some random high bits in pc/fp pointers whenever they get saved to the stack, checks+clears them when it loads them back)</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Jul 06 2022 11:44:37 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Gankra [she/they]</span>: Correct, we don't do any of that stuff</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Jul 06 2022 11:44:44 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">ok cool</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Jul 06 2022 11:45:52 GMT-0700 (Pacific Daylight Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">(my local "fixes" to ptr auth stripping are truncating some of the high bits of your instruction pointers 😬)</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Jul 06 2022 11:46:37 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">assuming these kinds of blocks of "oops no symbols" are indeed the obvious JIT functions they appear to be <a href="https://crash-stats.mozilla.org/report/index/30d9c8a0-7372-4f99-91cf-fe4ef0220701">https://crash-stats.mozilla.org/report/index/30d9c8a0-7372-4f99-91cf-fe4ef0220701</a></td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Jul 06 2022 11:48:22 GMT-0700 (Pacific Daylight Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">They're all allocated in the same memory range and the functions on either side of them are what you'd expect for jitcode, yeah</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Jul 06 2022 11:50:09 GMT-0700 (Pacific Daylight Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(With the exception of the NS_InvokeByIndex stuff, which is AFAIK not SM-related?)</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Jul 06 2022 11:51:54 GMT-0700 (Pacific Daylight Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: is espresso a real jit thing or does this look like hallucinations? <a href="https://crash-stats.mozilla.org/report/index/331f8e98-bf65-4284-ac45-ff08e0220701">https://crash-stats.mozilla.org/report/index/331f8e98-bf65-4284-ac45-ff08e0220701</a></td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Jul 06 2022 11:53:42 GMT-0700 (Pacific Daylight Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Espresso is not a thing inside SM or (according to searchfox) anywhere else in Gecko</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Jul 06 2022 11:54:02 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">cool, hallucination slain locally :)</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Jul 06 2022 11:54:38 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think ANECompilerEngine is maybe "Apple Neural Engine"?</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Wed Jul 06 2022 11:55:06 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell"><em>nods</em> makes sense, machine-learn-you-a-jit</td></tr>

</tbody></table></div></div></div>
</body></html>