<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-06-15</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-06-15<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-06-14" class="nav-link"><span>prev</span></a>
<a href="2024-06-17" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sat Jun 15 2024 07:08:50 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">Hi, I'm trying to better understand rooting. In this <a href="https://github.com/mozilla/gecko-dev/blob/94f839e924ba6c69f3e0d062d4c6cc4fee7cad5b/dom/promise/Promise.cpp#L360-L379">example</a>, if I think of a JS::Rooted as a smart pointer then I would have assumed we're returning a dangling pointer. JS::Rooted is <em>not</em> a smart pointer though, so is the idea here that JS::Rooted is a way of ensuring the value is always registered with the root lists? Like the expectation of this function is that whoever calls the function ensure that the returned JSObject* is immediately placed into another JS::Rooted instance?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sat Jun 15 2024 07:13:14 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Yes, <code>JS::Rooted</code> ensures the target is in the root list.  and returning raw pointer is okay as long as the consumer makes sure the raw pointer doesn't live across GC</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sat Jun 15 2024 07:13:49 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if the consumer immediately returns the raw pointer into Rooted local variable, that's okay</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sat Jun 15 2024 07:14:41 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">OK, and a failure to emplace it into some other Rooted means that the garbage collector is free to reclaim that memory?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sat Jun 15 2024 07:15:25 GMT-0700 (Pacific Daylight Time)">14:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, whenever GC is performed after that</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sat Jun 15 2024 07:16:25 GMT-0700 (Pacific Daylight Time)">14:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">üôè thank you! One last question here, when I call js::SetFunctionNativeReserved (like this <a href="https://github.com/mozilla/gecko-dev/blob/94f839e924ba6c69f3e0d062d4c6cc4fee7cad5b/js/src/ctypes/CTypes.cpp#L2114-L2115">example</a>) with a local RootedObject, does that count as emplacing the underlaying JSObject* into a tracked root list?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sat Jun 15 2024 07:17:59 GMT-0700 (Pacific Daylight Time)">14:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, what you need to do is make sure the object is reachable from root.  Directly putting the object into Rooted variable is one option.  the other option is to put it into other object's slot, where the object is reachable from root</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sat Jun 15 2024 07:19:02 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in the above case, <code>fun</code> is a function defined on <code>ctor</code>, so it's reachable from <code>ctor</code></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sat Jun 15 2024 07:19:41 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and <code>ctor</code> is Rooted.  so, <code>prototype</code> becomes reachable via ctor -&gt; fun -&gt; prototype</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sat Jun 15 2024 07:20:16 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, <code>fun</code> variable itself is not Rooted, which means, while the pointed object is not GCed, the GC can move the object and the <code>fun</code> variable will become dangling pointer after GC</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sat Jun 15 2024 07:21:01 GMT-0700 (Pacific Daylight Time)">14:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in general, you can assume most JSAPI that takes <code>JSContext</code> can GC (there are some exceptions tho)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sat Jun 15 2024 07:21:24 GMT-0700 (Pacific Daylight Time)">14:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">I see. But it seems like there is some flexibility here, for example in <a href="https://github.com/mozilla/gecko-dev/blob/94f839e924ba6c69f3e0d062d4c6cc4fee7cad5b/js/xpconnect/src/XPCWrappedNativeInfo.cpp#L48-L113">XPCWrappedNativeInfo::Resolve</a> it looks to me like functions and objects are not being immediately emplaced into Rooted, but perhaps the out param JS::Value <em>is</em>?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sat Jun 15 2024 07:22:09 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">(I'm just grabbing random examples of SetFunctionNativeReserved, there's no method to my selection!)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sat Jun 15 2024 07:22:12 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you mean line 90 and line 100 ?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sat Jun 15 2024 07:22:18 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sat Jun 15 2024 07:23:49 GMT-0700 (Pacific Daylight Time)">14:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">they're not reachable from root at least until put into <code>vp</code>.  but that's okay because they don't live across GC</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sat Jun 15 2024 07:25:39 GMT-0700 (Pacific Daylight Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">In the above case, the consumer passes the Rooted value's address <a href="https://searchfox.org/mozilla-central/rev/f759310e62ca27edf2e17c95642a21cb201d6084/js/xpconnect/src/XPCWrappedNativeJSOps.cpp#471">XPCWrappedNativeJSOps.cpp</a></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sat Jun 15 2024 07:27:08 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">the implication being that the Value* is actually a RootedValue somewhere else (or we set it to a RootedValue if its a constant). So the rule of thumb here is something like: you can do whatever you want with the raw pointer until you first register it with a root, after that happens you need to ensure its always rooted until you are fine with it being garbage collected?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sat Jun 15 2024 07:29:23 GMT-0700 (Pacific Daylight Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">slightly different.  you can have raw pointer as long as the raw pointer doesn't  live across GC.  so, for example, you can do 1. put into Rooted, 2. return as raw pointer, 3. perform some operation with the raw pointer, 4. put the object into other rooted object's property</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sat Jun 15 2024 07:30:02 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's not necessary to always rooted, but necessary to put it in rooted when GC happens</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Sat Jun 15 2024 07:30:19 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and don't use raw pointer across GC</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Sat Jun 15 2024 07:30:54 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">what ensures the pointer doesn't live across GC in the XPCWrappedNativeInfo example? Is it just that we assume GC can't happen between two adjacent function calls? Or is there some guard in that function that's informing the GC to block until the end of the function call?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Sat Jun 15 2024 07:31:23 GMT-0700 (Pacific Daylight Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">which function calls?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Sat Jun 15 2024 07:33:51 GMT-0700 (Pacific Daylight Time)">14:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">ya sorry I realized that was confusing, let me rephrase.  In that method (XPCWrappedNativeInfo::Resolve) we create a raw pointer on L92 (or L94) but do not immediately emplace it into a Rooted until L110. You said that's okay as long as we ensure the raw pointer isn't used across GC, what is ensuring no GC occurrs in between those lines in this example?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Sat Jun 15 2024 07:34:19 GMT-0700 (Pacific Daylight Time)">14:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>ccx</code> isn't passed anywhere</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Sat Jun 15 2024 07:35:53 GMT-0700 (Pacific Daylight Time)">14:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe that's not accurate</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Sat Jun 15 2024 07:36:32 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">no functions called after line 95 performs GC</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Sat Jun 15 2024 07:37:05 GMT-0700 (Pacific Daylight Time)">14:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">as I mentioned above, in most case, JSAPI that can GC takes <code>JSContext*</code> parameter</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Sat Jun 15 2024 07:37:39 GMT-0700 (Pacific Daylight Time)">14:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">ah, so maybe my mental model is wrong here. I was thinking the GC acted like a background thread that could run at any moment, but maybe its more.. cooperative than that? Like methods in the js api will proactively try to perform GC before performing their intended action?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Sat Jun 15 2024 07:38:26 GMT-0700 (Pacific Daylight Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">(I'm sure I'm oversimplifying things, just trying to cram it all in my head üòÖ)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Sat Jun 15 2024 07:42:07 GMT-0700 (Pacific Daylight Time)">14:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Some GC task is performed in background thread, but my understanding is that the entry point is inside JSAPI function</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Sat Jun 15 2024 07:42:31 GMT-0700 (Pacific Daylight Time)">14:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the details around that is beyond my knowledge.  let's wait for GC devs</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Sat Jun 15 2024 07:46:20 GMT-0700 (Pacific Daylight Time)">14:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">Sounds good. Thank you very much for your explanations to far, it's been very informative! </td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Sat Jun 15 2024 07:47:16 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">here's how GC can happen when allocating an object <a href="https://pastebin.mozilla.org/AcPy39yx">https://pastebin.mozilla.org/AcPy39yx</a> which is taken from the GC hazard analysis output</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Sat Jun 15 2024 08:26:40 GMT-0700 (Pacific Daylight Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Broadly speaking, we only trigger a GC when a function is called that tries to allocate a GC thing. Once a GC is running, we may split the work across threads, but we will never start a GC without calling into JSAPI code.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Sat Jun 15 2024 08:27:24 GMT-0700 (Pacific Daylight Time)">15:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We used to have a bot that you could ask if a given function could trigger GC, but sadly mrgiggles didn't survive the IRC-&gt;Element migration</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Sat Jun 15 2024 08:45:09 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> ah, so maybe my mental model is wrong here. I was thinking the GC acted like a background thread that could run at any moment, but maybe its more.. cooperative than that? Like methods in the js api will proactively try to perform GC before performing their intended action?</blockquote></mx-reply>Yes, your updated mental model is the correct one. You don't need to guard against GC happening at any random moment. Instead, imagine that any JSAPI function call <code>JS::Frobnicate(cx, ...)</code> actually does "frobnicate, then maybe GC before returning". Which potentially blows away any unreachable GC pointer, and rooting makes the contained pointer reachable.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Sat Jun 15 2024 08:48:28 GMT-0700 (Pacific Daylight Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">great, thank you all this makes a lot more sense now</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Sat Jun 15 2024 08:50:04 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">I think perhaps another missing piece for me might be that it's generally pretty lightweight to defensively use Rooted everywhere if you're not exactly sure (or can't future-proof) that an allocation is tracked. </td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Sat Jun 15 2024 08:52:44 GMT-0700 (Pacific Daylight Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">for instance back in the CTypes <a href="https://github.com/mozilla/gecko-dev/blob/94f839e924ba6c69f3e0d062d4c6cc4fee7cad5b/js/src/ctypes/CTypes.cpp#L2077-L2125">example for InitInt64Class</a>, is it technically required that <code>prototype</code> is rooted at the L2082? We eventually are storing it in a private slot on <code>fun</code> which I understand will also root that object</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Sat Jun 15 2024 08:53:59 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">(also applies to <code>RootedObject ctor</code> on L2100?)</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Sat Jun 15 2024 08:55:10 GMT-0700 (Pacific Daylight Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The call to JS_GetConstructor on line 2100 could trigger a GC, and the prototype is used after that call, so the root on line 2082 is necessary</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Sat Jun 15 2024 08:58:08 GMT-0700 (Pacific Daylight Time)">15:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">Ah, because of the internal GetProperty call? Oof, okay maybe I should look into reviving mrgiggles</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Sat Jun 15 2024 09:00:03 GMT-0700 (Pacific Daylight Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">perhaps relatedly, was mrgiggles built on any sort of tooling that could validate rooting at compile-time? </td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Sat Jun 15 2024 09:15:05 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We have a hazard analysis built on a GCC plugin that detects and reports rooting violations. One of its outputs is a file called <code>gcFunctions.txt.gz</code>, which I believe is a list of functions that can trigger GC. It's kind of a pain to run locally, although IIUC slightly less of a pain than it had been in the past. You can see an example from the latest mozilla-central build in the Artifacts and Debugging Tools tab <a href="https://treeherder.mozilla.org/jobs?repo=mozilla-central&amp;searchStr=hazard&amp;selectedTaskRun=FAxy2G51TGy61mKyDvfRMQ.0">here</a></td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Sat Jun 15 2024 09:16:05 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">My understanding is that mrgiggles was built on top of that, although s.fink is the expert here</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Sat Jun 15 2024 09:19:17 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(And yes, the GetProperty call in JS_GetConstructor is what made me conclude it could GC. Pretty much any time you access a property you have to be prepared for a getter or proxy to run arbitrary code, at which point anything can happen.)</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Sat Jun 15 2024 09:38:09 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> We used to have a bot that you could ask if a given function could trigger GC, but sadly mrgiggles didn't survive the IRC-&gt;Element migration</blockquote></mx-reply>so mrgiggles was not able to predict their own GC moment :-(</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Sat Jun 15 2024 13:21:10 GMT-0700 (Pacific Daylight Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">i blame G√∂del</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Sat Jun 15 2024 14:10:53 GMT-0700 (Pacific Daylight Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">Cool! I wonder if some integration with <a href="https://github.com/Microsoft/GSL">GSL</a> would be useful there as well?</td></tr>

</tbody></table></div></div></div>
</body></html>