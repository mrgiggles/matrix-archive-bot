<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-01-19</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-01-19<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-01-18" class="nav-link"><span>prev</span></a>
<a href="2022-01-20" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Jan 19 2022 01:33:24 GMT-0800 (Pacific Standard Time)">09:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gkw:mozilla.org">gkw</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1750935">https://bugzilla.mozilla.org/show_bug.cgi?id=1750935</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Jan 19 2022 04:21:23 GMT-0800 (Pacific Standard Time)">12:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">yulia</span>: that <code>groupBy</code> regression is giving me flashbacks to the smoosh thing...</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Jan 19 2022 04:22:31 GMT-0800 (Pacific Standard Time)">12:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">i am hoping it won't be too bad... but hard to tell, the library is popular</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Jan 19 2022 04:23:05 GMT-0800 (Pacific Standard Time)">12:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">we managed to escape a rename with <code>at()</code></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Jan 19 2022 04:23:59 GMT-0800 (Pacific Standard Time)">12:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah, could go either way..</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Jan 19 2022 04:24:00 GMT-0800 (Pacific Standard Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">in that case i think it was a single site breakage.. i am less confident in this case</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Jan 19 2022 04:25:47 GMT-0800 (Pacific Standard Time)">12:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it has been more than a week already, that's a good sign</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jan 19 2022 04:26:09 GMT-0800 (Pacific Standard Time)">12:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">gkw</span>: thank you!</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jan 19 2022 08:19:49 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Do we have anyone here who knows how/when the debugger uses this hook? <a href="https://searchfox.org/mozilla-central/source/dom/script/ScriptSettings.cpp#54-83">https://searchfox.org/mozilla-central/source/dom/script/ScriptSettings.cpp#54-83</a></td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jan 19 2022 08:20:16 GMT-0800 (Pacific Standard Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I assume it is used for inline scripts for example, but is it used for dynamic imports?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jan 19 2022 08:29:42 GMT-0800 (Pacific Standard Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">yulia</span>: <a href="https://searchfox.org/mozilla-central/source/js/src/debugger/Source.cpp#392">https://searchfox.org/mozilla-central/source/js/src/debugger/Source.cpp#392</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jan 19 2022 08:48:16 GMT-0800 (Pacific Standard Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">I'd like insert profiling counters into code emitted by ion. the counters should be stack-allocated, so they automatically vanish after each function call (+ recursive calls get separate counters). how do I tackle this in general? my current guess is that individual counters should be LAllocation's generated at the end of OptimizeMIR, but I might be entirely wrong. any hints would be much appreciate</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jan 19 2022 08:53:25 GMT-0800 (Pacific Standard Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">l11d</span>: The stack space is handled by the register allocator, it might be easier to create a MIR which is lower to something which require a stack allocation, and add it in the prologue of the function.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jan 19 2022 08:54:23 GMT-0800 (Pacific Standard Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Otherwise, if you were to have a global vector, you could bake in the address of the vector and increment the last element of it.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jan 19 2022 08:54:59 GMT-0800 (Pacific Standard Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">In which case you will only need to change the assembly produced by the prologue of Ion.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jan 19 2022 09:03:35 GMT-0800 (Pacific Standard Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: thanks, I'll give it a try</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Jan 19 2022 09:05:39 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">l11d</span>: A third option, is that we already have some code-coverage counters, which are used by the interpreter and baseline. Maybe adding them to Ion as MIR instructions which are lowered like baseline compile them would work.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Jan 19 2022 09:05:51 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">And you might get an LCov output as well.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jan 19 2022 11:24:18 GMT-0800 (Pacific Standard Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">kinda sick but want to shoot off this before i forget:

last month we deployed the new native crash processing backend for crash-stats (rust-minidump). have y'all noticed any particular quality changes in backtraces involving JS frames? It's not something I put any specific thought into, but I tried to mirror the old implementation pretty close.

also if you have any thoughts on how backtraces through JS could be improved, I'd love to hear

also also if there are any docs on the spidermonkey JS &lt;-&gt; JS and JS &lt;-&gt; native ABIs, I would love to see them</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jan 19 2022 11:26:38 GMT-0800 (Pacific Standard Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell"><p>specifically I am looking at heuristics to improve stack scanning (the worst unwinding scheme, which we use when CFI and frame pointers are missing/seemingly-corrupt), but the big ??? for me is unwinding through JITed code, because presumably heuristics like</p>
<ul>
<li>require the return address to point into a linked in module</li>
<li>require the return address to be preceeded by a native CALL instruction</li>
</ul>
<p>could easily be messed up by JITed code, depending on how it's implemented</p>
</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jan 19 2022 14:20:23 GMT-0800 (Pacific Standard Time)">22:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>: There's a little bit of information in <a href="https://searchfox.org/mozilla-central/source/js/src/jit/JitFrames.h#383">this SMDOC</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jan 19 2022 14:21:28 GMT-0800 (Pacific Standard Time)">22:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">is the JS &lt;-&gt; native boundary always forced to go into ion (as opposed to interpretter stuff?)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jan 19 2022 14:22:03 GMT-0800 (Pacific Standard Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">No, JS &lt;-&gt; native transitions happen in every tier</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jan 19 2022 14:23:01 GMT-0800 (Pacific Standard Time)">22:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Roughly speaking, there's an entry frame whenever we go from C++ into jit code, and an exit frame whenever we go from jit code back into C++</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jan 19 2022 14:23:50 GMT-0800 (Pacific Standard Time)">22:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This comment might also be helpful: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/JSJitFrameIter.h#26">https://searchfox.org/mozilla-central/source/js/src/jit/JSJitFrameIter.h#26</a></td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jan 19 2022 14:25:12 GMT-0800 (Pacific Standard Time)">22:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think in general return addresses will be preceded by call instructions</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jan 19 2022 14:25:25 GMT-0800 (Pacific Standard Time)">22:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But of the top of my head I can't guarantee that there are no exceptions</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jan 19 2022 14:29:47 GMT-0800 (Pacific Standard Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There are definitely places where we monkey around with returns</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Jan 19 2022 14:30:33 GMT-0800 (Pacific Standard Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For example when we resume into a generator, we push a fake return address and then keep going: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/BaselineCodeGen.cpp#5982-5998">https://searchfox.org/mozilla-central/source/js/src/jit/BaselineCodeGen.cpp#5982-5998</a></td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Jan 19 2022 14:30:47 GMT-0800 (Pacific Standard Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But that uses a real call, and we really return there, so maybe that works out</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Jan 19 2022 14:31:00 GMT-0800 (Pacific Standard Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">i think even with TCO it still holds, in my naive mental model of how TCO would be implemented</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Jan 19 2022 14:31:15 GMT-0800 (Pacific Standard Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(We don't do TCO)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Jan 19 2022 14:31:41 GMT-0800 (Pacific Standard Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(It's part of the JS spec, but that is generally held to be a mistake by everybody except JSC, who incidentally are the only people who've implemented it.)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Jan 19 2022 14:32:10 GMT-0800 (Pacific Standard Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">haha</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Jan 19 2022 14:32:27 GMT-0800 (Pacific Standard Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The other example that came to mind was invalidating Ion scripts on the stack, where we have to go in and fix things up so that things don't break when we return there</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Jan 19 2022 14:32:47 GMT-0800 (Pacific Standard Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But it looks like we do that by overwriting the code following the return, so the return address itself is fine</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Jan 19 2022 14:33:24 GMT-0800 (Pacific Standard Time)">22:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">TCO is kinda a mental short-hand i have for "weird tricks that mess with the return pointers" i.e. when objc_messageSend removes itself from the stack, that's basically just TCO</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Jan 19 2022 14:34:38 GMT-0800 (Pacific Standard Time)">22:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There are some places where we make calls using trampolines where we call directly to an unconditional jump, but those shouldn't be visible to stack scanning</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Jan 19 2022 14:35:16 GMT-0800 (Pacific Standard Time)">22:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">shouldn't be visible in what sense? (trampoline is one of those pieces of terminology i can never get to stick in my head)</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Jan 19 2022 14:35:41 GMT-0800 (Pacific Standard Time)">22:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Trampoline might not even be the right word here</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Jan 19 2022 14:36:13 GMT-0800 (Pacific Standard Time)">22:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's literally just a call instruction that calls to a single jmp instruction</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Jan 19 2022 14:36:52 GMT-0800 (Pacific Standard Time)">22:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So the call instruction at point A will push a return address on the stack and jump to point B, which immediately jumps to point C, which will eventually return to point A without revisiting point B</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Jan 19 2022 14:37:07 GMT-0800 (Pacific Standard Time)">22:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">ok, so, basically a TCO</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Jan 19 2022 14:37:24 GMT-0800 (Pacific Standard Time)">22:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">see, it's a good heuristic :)</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Jan 19 2022 14:38:40 GMT-0800 (Pacific Standard Time)">22:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In the same spirit of calling that TCO, you can probably interpret "trampoline" in SM as "well, we use it to bounce from one place to another" and not go far wrong</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Jan 19 2022 14:39:36 GMT-0800 (Pacific Standard Time)">22:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Example: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/x64/Trampoline-x64.cpp#74-77">https://searchfox.org/mozilla-central/source/js/src/jit/x64/Trampoline-x64.cpp#74-77</a></td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Jan 19 2022 14:39:59 GMT-0800 (Pacific Standard Time)">22:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">C++ code calls this to call into jit code</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Jan 19 2022 14:41:07 GMT-0800 (Pacific Standard Time)">22:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">quick sanity check: in minidumps we can have the rwx bits for all the mapped pages of the crashing process. is there <em>any</em> situation where a JIT page would end up as a return address stored on the stack while the page <em>isn't</em> marked as executable?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Jan 19 2022 14:41:58 GMT-0800 (Pacific Standard Time)">22:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">(i can potentially replace "address must be part of a linked in module" with "linked module or known-executable page")</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Jan 19 2022 14:43:10 GMT-0800 (Pacific Standard Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The only case I can think of is if we crashed while writing new executable code to the same page, because we enforce W^X</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Jan 19 2022 14:43:32 GMT-0800 (Pacific Standard Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">oh interesting, hmm</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Jan 19 2022 14:43:44 GMT-0800 (Pacific Standard Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So we would mark the page as W but not X, memcpy in some new code, and then swap the bits back</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Jan 19 2022 14:44:15 GMT-0800 (Pacific Standard Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">and there's no Very Clever system that prevents mutating a page that's part of a current stack?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Jan 19 2022 14:45:08 GMT-0800 (Pacific Standard Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">No, and in fact it can be necessary for correctness: see my example above about overwriting the code in invalidated ion scripts</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Jan 19 2022 14:45:18 GMT-0800 (Pacific Standard Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">ah, dang</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Jan 19 2022 14:46:17 GMT-0800 (Pacific Standard Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/jit/Ion.cpp#2438-2462">https://searchfox.org/mozilla-central/source/js/src/jit/Ion.cpp#2438-2462</a></td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Jan 19 2022 14:46:55 GMT-0800 (Pacific Standard Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">would it be useful/interesting to have that kind of metadata show up in crash-stats? like, hey this instruction pointer was pointing into a freed page, or in a non-executable page, any time an instruction pointer doesn't point into a module?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Jan 19 2022 14:48:19 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">My instinct is that if we crash while we're writing new executable code, we should be able to tell by looking at the top of the stack, and the details of what jit code is on the stack aren't likely to be all that interesting</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Jan 19 2022 14:49:03 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Hypothetically we could track whether we were currently writing jit code, and only enforce the invariant if we weren't</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Jan 19 2022 14:49:22 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And then I think violations would be noteworthy (although it's still possible I'm forgetting something)</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Jan 19 2022 14:50:26 GMT-0800 (Pacific Standard Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">the page being marked as freed would be a huge red flag though, right?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Jan 19 2022 14:50:42 GMT-0800 (Pacific Standard Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, true</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Jan 19 2022 14:50:52 GMT-0800 (Pacific Standard Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">(although I have a feeling you probably pool the pages so don't actually free them much...)</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Jan 19 2022 14:51:08 GMT-0800 (Pacific Standard Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That sounds right, although I would have to go look to verify</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Jan 19 2022 14:52:33 GMT-0800 (Pacific Standard Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Memory for jitcode is allocated here: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/ExecutableAllocator.h#54">https://searchfox.org/mozilla-central/source/js/src/jit/ExecutableAllocator.h#54</a></td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Jan 19 2022 14:52:53 GMT-0800 (Pacific Standard Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">you have given me a lot of useful links which i'll try to look over later, but can I get a tl;dr yes/no/sometimes on whether spidermonkey frames properly use frame pointers?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Jan 19 2022 14:54:31 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think "sometimes"</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Jan 19 2022 14:54:42 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">brutal, reading time it is</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Jan 19 2022 14:55:50 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">IIRC (but there is a good chance I do not) Ion does not use a frame pointer, but baseline does</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Jan 19 2022 14:56:21 GMT-0800 (Pacific Standard Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">if only JS was one of those languages where try/catch is abused as normal path control flow so runtimes need to make it hyper fast to unwind</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Jan 19 2022 14:56:33 GMT-0800 (Pacific Standard Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We don't even optimize catch in Ion</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Jan 19 2022 14:56:38 GMT-0800 (Pacific Standard Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You have to bail out to do a catch</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Jan 19 2022 14:57:06 GMT-0800 (Pacific Standard Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Please please we already suffer enough</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Jan 19 2022 14:57:33 GMT-0800 (Pacific Standard Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">frame pointers make everything <em>simpler</em> they remove the suffering iain</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Jan 19 2022 14:57:45 GMT-0800 (Pacific Standard Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah but then you don't have enough registers</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Jan 19 2022 14:57:51 GMT-0800 (Pacific Standard Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Don't blame me, blame x86</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Jan 19 2022 14:58:09 GMT-0800 (Pacific Standard Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">fair but also x64/arm could be Happiness</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Jan 19 2022 14:59:10 GMT-0800 (Pacific Standard Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">i don't know if the apple mandate that you properly use frame pointers on arm targets applies to M1, probably not</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Jan 19 2022 15:00:28 GMT-0800 (Pacific Standard Time)">23:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell"><p><a href="https://developer.apple.com/documentation/xcode/writing-arm64-code-for-apple-platforms">https://developer.apple.com/documentation/xcode/writing-arm64-code-for-apple-platforms</a></p>
<blockquote>
<p>The frame pointer register (x29) must always address a valid frame record. Some functions — such as leaf functions or tail calls — may opt not to create an entry in this list As a result, stack traces are always meaningful, even without debug information.</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Jan 19 2022 15:01:07 GMT-0800 (Pacific Standard Time)">23:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">say it ain't so that spidermonkey isn't totally compliant with apple's standards 😈</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Jan 19 2022 15:01:55 GMT-0800 (Pacific Standard Time)">23:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Pretty confident we don't, given that we use r23 as our frame pointer in baseline: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/arm64/SharedICRegisters-arm64.h#18">https://searchfox.org/mozilla-central/source/js/src/jit/arm64/SharedICRegisters-arm64.h#18</a></td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Jan 19 2022 15:02:06 GMT-0800 (Pacific Standard Time)">23:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">;-;</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Jan 19 2022 15:03:54 GMT-0800 (Pacific Standard Time)">23:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">if you're not careful firefox could be banned from the app store &lt;/s&gt;</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Jan 19 2022 15:08:04 GMT-0800 (Pacific Standard Time)">23:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">is there a reason to avoid the "conventional" frame pointer register?</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Jan 19 2022 15:20:31 GMT-0800 (Pacific Standard Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">No, I think we just picked an arbitrary callee-saved register</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Jan 19 2022 15:25:15 GMT-0800 (Pacific Standard Time)">23:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Skimmed through the review comments on the patch that added arm64 support, and if we talked about the decision at all it wasn't on bugzilla</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Wed Jan 19 2022 15:27:02 GMT-0800 (Pacific Standard Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gankra:mozilla.org">Aria (Gankra) [she/they] | sick part 2: revenge of the sick</span>&gt;</div></td><td class="msg-cell">well if it's not too hard to change, it would probably be Better to have it be the one the platform natively prefers</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Wed Jan 19 2022 15:34:39 GMT-0800 (Pacific Standard Time)">23:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It might be as easy as just updating the header. I'll run a quick smoke test</td></tr>

</tbody></table></div></div></div>
</body></html>