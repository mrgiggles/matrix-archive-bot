<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-11-05</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-11-05<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-11-04" class="nav-link"><span>prev</span></a>
<a href="2024-11-06" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Nov 04 2024 18:40:59 GMT-0800 (Pacific Standard Time)">02:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Hello, I filed the bug (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1928966">https://bugzilla.mozilla.org/show_bug.cgi?id=1928966</a>) to add JS::ParseInt and JS::ParseFloat, and I believe I have working code for this implementation.

Additionally, I think it would be better to split this task into two parts: first, I’ll add JS::ParseInt and submit it for review, and after a successful review, I’ll add JS::ParseFloat and submit it for review as well.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Nov 05 2024 11:44:04 GMT-0800 (Pacific Standard Time)">19:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Is our weird python dialect for moz.configure actually documented anywhere? It's a mess of decorators and implicit magic, and every time I interact with it I just cargo-cult from something vaguely similar until it looks like it's working.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Nov 05 2024 11:50:35 GMT-0800 (Pacific Standard Time)">19:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p>Right now my question is: suppose I have an option "--disable-foo". If I have another function:</p>
<pre><code>@depends("--disable-foo")
def cares_about_foo(value)
   ...
</code></pre>
<p>If <code>value</code> is True, does that mean that foo is enabled or disabled?</p>
</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Nov 05 2024 11:59:39 GMT-0800 (Pacific Standard Time)">19:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>Right now my question is: suppose I have an option "--disable-foo". If I have another function:</p>
<pre><code>@depends("--disable-foo")
def cares_about_foo(value)
   ...
</code></pre>
<p>If <code>value</code> is True, does that mean that foo is enabled or disabled?</p>
</blockquote></mx-reply>my understanding is that in that case, value == True means that foo is enabled</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Nov 05 2024 12:00:03 GMT-0800 (Pacific Standard Time)">20:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">which seems too magic for it's own good</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Nov 05 2024 12:08:40 GMT-0800 (Pacific Standard Time)">20:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, looking around at other code it seems like that's true because the decorator is <a href="https://searchfox.org/mozilla-central/source/python/mozbuild/mozbuild/configure/options.py#179-183">parsing the name of the option and looking for "enable/disable/with/without"</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Nov 05 2024 12:09:11 GMT-0800 (Pacific Standard Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which is a level of witchcraft that I think could be more obviously documented</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Nov 05 2024 12:15:56 GMT-0800 (Pacific Standard Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">Oh you were able to even find the source for the decorator. I tried for a bit and just gave up and copied what everyone else was doing..</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Nov 05 2024 14:14:52 GMT-0800 (Pacific Standard Time)">22:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@itms:mozilla.org">itms</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Sure, I'll do that. And I'll try and reduce the crash to a minimal reproduction example</blockquote></mx-reply>Hello, I haven't been successful at reducing our crash to a minimal example, but I notice only some of our calls to the deepfreeze function are causing a crash. in both cases, we are assigning a deepfrozen object to a global variable. could that be an issue? could there be a conflict between the global object and the deepfreeze logic?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Nov 05 2024 14:16:17 GMT-0800 (Pacific Standard Time)">22:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@itms:mozilla.org">itms</span>&gt;</div></td><td class="msg-cell">I'll keep trying to reproduce the crash with only a couple lines of JS. In the meantime I'll keep an eye here to see if my issue rings a bell for someone :)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Nov 05 2024 14:25:43 GMT-0800 (Pacific Standard Time)">22:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>I have once again encountered this assert statement, which appears to mean that my rooted objects are being constructed/destructed in the incorrect order:</p>
<pre><code>  ~Rooted() {
    MOZ_ASSERT(*this-&gt;stack == this);
    *this-&gt;stack = this-&gt;prev;
  }

</code></pre>
<p>Does anyone know what situations may cause this?</p>
<p>Also, is this strictly a result of JS::Rooted constructor/destructor misuse, or can misuse of JS::Handle also cause this problem?</p>
</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Nov 05 2024 14:42:50 GMT-0800 (Pacific Standard Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: Are you creating a Rooted anywhere besides the stack? That's the most likely cause.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Nov 05 2024 14:48:00 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">kfjvj</span>: Are you creating a Rooted anywhere besides the stack? That's the most likely cause.</blockquote></mx-reply>I've looked all over for something like that, but I haven't found it.  Any other scenarios you've seen where this might happen?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Nov 05 2024 14:50:50 GMT-0800 (Pacific Standard Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you only create Rooted on the stack, I'm not sure it's possible to trigger that assertion. Are you possibly putting a Rooted in a lambda without noticing?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Nov 05 2024 14:51:17 GMT-0800 (Pacific Standard Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">That was my other thought as well, but I haven't found anything like that.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Nov 05 2024 14:52:39 GMT-0800 (Pacific Standard Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">However, I did notice something just now in a unit test:

I have some JS code that calls back to some C++ code.

If the C++ code being called by JS throws an exception, I can't catch that exception from C++.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Nov 05 2024 14:53:41 GMT-0800 (Pacific Standard Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">SM is not designed to work with exceptions enabled.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Nov 05 2024 14:57:09 GMT-0800 (Pacific Standard Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>Here's an example of my code.  That boost describe and JsDescribedWrapper stuff just wraps the C++ class and methods in JS.</p>
<pre><code>class ErrorConditionTestClass {
public:
    ErrorConditionTestClass() {
        // Nothing special in the constructor
    }

    void ThrowCppException() {
        LOGINFO() &lt;&lt; "Before throwing runtime error";
        throw std::runtime_error("C++ runtime error.");
    }

    static JSContext* staticCtx;
};

BOOST_DESCRIBE_STRUCT(ErrorConditionTestClass, (), (ThrowCppException))

TEST_F(TestDescribedBindings, errorConditions) {
    ASSERT_TRUE(JsDescribedWrapper&lt;ErrorConditionTestClass&gt;::DefineClass(ctx(), global()));

    char testCode[] = R"js(
        let ErrorConditionTestClass = ErrorConditionTestClass;
        var e = new ErrorConditionTestClass();
        e.ThrowCppException();
    )js";

    try {
        LOGINFO() &lt;&lt; "Attempting code execution";
        ExecuteCode(ctx(), testCode);
    } catch (const std::runtime_error&amp; err) {
        LOGINFO() &lt;&lt; "Caught error: " &lt;&lt; err.what();
    } catch (const std::exception&amp; ex) {
        LOGINFO() &lt;&lt; "Received an even different exception: " &lt;&lt; ex.what();
    }
}
</code></pre>
<p>And I'm getting the following assertion error:</p>
<p>Assertion failure: *this-&gt;stack == this, at /home/kwheel28/host_workspace/external-mozjs-102/build/eblinux/Debug/include/mozjs-102/js/RootingAPI.h:1192</p>
</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Nov 05 2024 14:59:31 GMT-0800 (Pacific Standard Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Apparently, exceptions can trigger that same assertion error somehow.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Nov 05 2024 14:59:48 GMT-0800 (Pacific Standard Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">SM is not compatible with C++ exceptions.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Nov 05 2024 15:00:26 GMT-0800 (Pacific Standard Time)">23:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">What exactly does that mean?  Like, if an exception tries to propagate up the stack, and there's SM functions on the stack, things will go wrong?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Nov 05 2024 15:03:19 GMT-0800 (Pacific Standard Time)">23:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We don't build or test with exceptions. The exception-handling mechanism in C++ doesn't know anything about jit code. At the very least, if you throw an exception and you unwind past jit frames, any work that those frames expected to do after returning from the calls (which may be necessary to preserve invariants) won't happen.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Nov 05 2024 15:04:09 GMT-0800 (Pacific Standard Time)">23:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">If we unwind in our own code, but don't unwind JIT frames, should we be OK?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Nov 05 2024 15:04:36 GMT-0800 (Pacific Standard Time)">23:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I do not immediately see how that would go wrong.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Nov 05 2024 15:04:55 GMT-0800 (Pacific Standard Time)">23:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But I can't guarantee anything</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Nov 05 2024 15:05:10 GMT-0800 (Pacific Standard Time)">23:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK.  Thanks for the help.</td></tr>

</tbody></table></div></div></div>
</body></html>