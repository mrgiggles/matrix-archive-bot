<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-10-24</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-10-24<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-10-23" class="nav-link"><span>prev</span></a>
<a href="2024-10-25" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Oct 24 2024 02:06:56 GMT-0700 (Pacific Daylight Time)">09:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Just thinking basically the case when one adds and then almost immediately removes an event listener</blockquote></mx-reply>Yes, this will not be kept alive by minor GC if it has been removed by the time minor GC runs. Setting a nursery pointer in a Heap&lt;T&gt; will add a store buffer entry to trace it but clearing it will remove that entry again.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Oct 24 2024 02:08:07 GMT-0700 (Pacific Daylight Time)">09:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: ok, thanks.  Just trying to figure out yet some more ways to release stuff sooner.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Oct 24 2024 02:16:03 GMT-0700 (Pacific Daylight Time)">09:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: also playing again with the idea to run collector's sooner, since right now especially on a fast machine one can create lots of garbage before it gets collected.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Oct 24 2024 02:22:17 GMT-0700 (Pacific Daylight Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: reducing the max nursery size might also help here</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Oct 24 2024 02:22:29 GMT-0700 (Pacific Daylight Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: also we could experiment with the JSGC_NURSERY_EAGER_COLLECTION_* parameters</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Oct 24 2024 02:23:27 GMT-0700 (Pacific Daylight Time)">09:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">hmm, why would reducing nursery size help in cases like sp3?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Oct 24 2024 02:24:03 GMT-0700 (Pacific Daylight Time)">09:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">not necessarily for sp3, but it limits the amount of garbage that can be created before it gets collected</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Oct 24 2024 02:25:41 GMT-0700 (Pacific Daylight Time)">09:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">ah, right. Yeah, sp3 is the extreme case here. It is all the time (when running a subtest) creating tons of garbage, and we do want to avoid minor GCs while it is doing that, if possible.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Oct 24 2024 03:15:11 GMT-0700 (Pacific Daylight Time)">10:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">How should I think of the performance characteristics of AllocateInlineString? <a href="https://searchfox.org/mozilla-central/source/js/src/vm/StringType-inl.h#31">https://searchfox.org/mozilla-central/source/js/src/vm/StringType-inl.h#31</a> Should I think of it having the cost of a malloc or is it closer to a bump allocation on the GC heap? (I'm trying to understand how bad an idea it would be to write code where the happy path does one or two of these but the worst case ends up with lots of these.)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Oct 24 2024 03:18:07 GMT-0700 (Pacific Daylight Time)">10:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">Specifically, I have two options: allocate a new buffer, write everything in the new buffer, which I might have to grow/shrink vs. creating a rope of dependent strings and inline strings. If there are only a couple of things that need to change relative to the input, I'd end up with a rope with few items and almost no copying at the rope creating time. However, if lots of things need to change, it could become a rope of lots of inline strings.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Oct 24 2024 04:18:38 GMT-0700 (Pacific Daylight Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">hsivonen</span>: the latter, it's a single GC cell allocation which will be a bump allocation if it's in the nursery</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Oct 24 2024 07:30:13 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">hsivonen</span>: the latter, it's a single GC cell allocation which will be a bump allocation if it's in the nursery</blockquote></mx-reply>Thanks</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Oct 24 2024 07:36:34 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jjaschke:mozilla.org">jjaschke</span>&gt;</div></td><td class="msg-cell">There's a bug which is currently in DOM: Core &amp; HTML, which deals with how to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1846606">represent numbers in the console</a>. (Maybe foolishly) I marked this one as good-first-bug a while ago, and there is even activity from two contributors. Their investigation showed that the scope of the bug might be too big for a good-first-bug, but they seem to still want to contribute if the bug were split into smaller tasks. I'm happy to help them out and mentor, but I am not experienced enough to say if their approach is the right one, or if they maybe miss something.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Oct 24 2024 11:52:05 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell"><p>I'm looking in a crash (MOZ_RELEASE_ASSERT) in the profiler that is ultimately happening because a marker is being set way in the future.</p>
<p>I've tracked it back to the PerformanceMeasureOptions created <a href="https://searchfox.org/mozilla-central/source/__GENERATED__/dom/bindings/PerformanceBinding.cpp#1562-1563">here</a> with the following (significantly truncated) call stack (full callstack here: <a href="https://paste.mozilla.org/o00bgAGS/raw">https://paste.mozilla.org/o00bgAGS/raw</a>):</p>
<blockquote>
<p>mozilla::dom::Performance_Binding::measure(JSContext *, JS::Handle&lt;JSObject *&gt;, void *, const JSJitMethodCallArgs &amp;)	C++<br>mozilla::dom::binding_detail::GenericMethod<a href="mozilla::dom::binding_detail::NormalThisPolicy,mozilla::dom::binding_detail::ThrowExceptions">mozilla::dom::binding_detail::NormalThisPolicy,mozilla::dom::binding_detail::ThrowExceptions</a>(JSContext *, unsigned int, JS::Value *)	C++<br>[Inline Frame] CallJSNative(JSContext <em>, bool(</em>)(JSContext *, unsigned int, JS::Value *), js::CallReason, const JS::CallArgs &amp;)	C++<br>js::InternalCallOrConstruct(JSContext *, const JS::CallArgs &amp;, js::MaybeConstruct, js::CallReason)	C++<br>js::Interpret(JSContext *, js::RunState &amp;)	C++<br>[Inline Frame] MaybeEnterInterpreterTrampoline(JSContext *, js::RunState &amp;)	C++<br>js::RunScript(JSContext *, js::RunState &amp;)	C++<br>...</p>
</blockquote>
<p>but this is now way out of my areas of knowledge and the full call stack is crazy long. I'm <em>thinking</em> that this means that there is some JS code somewhere calling performance.measure() with a bad timestamp but I have no idea where to go from there. Does anyone here know how to make sense of this?</p>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Oct 24 2024 11:56:24 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell">Also the whole call stack seems long and convoluted to me - a call to HttpChannelChild::OnStopRequest() seems to have triggered a whole lot of stuff to happen.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Oct 24 2024 12:15:16 GMT-0700 (Pacific Daylight Time)">19:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">does <code>DumpJSStack()</code> give the js call stack?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Oct 24 2024 12:15:46 GMT-0700 (Pacific Daylight Time)">19:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">jlink</span>: ^</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Oct 24 2024 12:33:36 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: curious, have you tried running wasm benchmarks with more TaskController background threads?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Oct 24 2024 12:35:45 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(My guess is that wasm might prefer utilizing as much cpu time as possible, in parallel, but ion might be benefit fewer,  faster cores.)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Oct 24 2024 12:44:27 GMT-0700 (Pacific Daylight Time)">19:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (My guess is that wasm might prefer utilizing as much cpu time as possible, in parallel, but ion might be benefit fewer,  faster cores.)</blockquote></mx-reply>I have not tried this. TBH, Iâ€™m out of date with our whole background thread system. Is there a pref or something I could play around with?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Oct 24 2024 12:46:49 GMT-0700 (Pacific Daylight Time)">19:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, looks like there is an env variable: <a href="https://searchfox.org/mozilla-central/rev/18f09bdf36a62ea7079c018301f1d257f71f655b/xpcom/threads/TaskController.cpp#75-93">https://searchfox.org/mozilla-central/rev/18f09bdf36a62ea7079c018301f1d257f71f655b/xpcom/threads/TaskController.cpp#75-93</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Oct 24 2024 14:44:27 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">jlink</span>: ^</blockquote></mx-reply>Let me try that now ...</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Oct 24 2024 15:37:32 GMT-0700 (Pacific Daylight Time)">22:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@mgaudet:mozilla.org">mgaudet|out-of-office-until-October-28</span>&gt;</div></td><td class="msg-cell"><a href="https://dl.acm.org/doi/10.1145/3689736">Neat fuzzing paper</a> --  Show an LLM the code for an optimization, then get it to generate a test case which should exercise said optimization. Instrument the opt to provide feedback, then keep asking for more test cases like ones which worked</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Oct 24 2024 15:46:40 GMT-0700 (Pacific Daylight Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell"><a href="https://paste.mozilla.org/JzRmPpUr/raw">Here</a> is the call stack that it gave me</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Oct 24 2024 16:06:52 GMT-0700 (Pacific Daylight Time)">23:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell">And that has pointed me to:<br>performance.measure(<code>${e}-${t}</code>,{start:performance.timeOrigin,duration:<a href="http://performance.now">performance.now</a>()})<br>Which doesn't seem right.</td></tr>

</tbody></table></div></div></div>
</body></html>