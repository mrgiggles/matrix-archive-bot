<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-01-09</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-01-09<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-01-08" class="nav-link"><span>prev</span></a>
<a href="2025-01-10" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Jan 09 2025 01:01:05 GMT-0800 (Pacific Standard Time)">09:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">Thanks all, I've added those headers into my Python script, but no luck so far. It's kind of weird because the documentation does not mention any 1000 microsecond precision like what I get. Maybe it's how I am compiling that WASM...</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jan 09 2025 01:02:33 GMT-0800 (Pacific Standard Time)">09:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">trying <code>emscripten_get_now()</code></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jan 09 2025 01:07:09 GMT-0800 (Pacific Standard Time)">09:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span>: if you have a repro page I can make a recording and we can check what causes it</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jan 09 2025 01:54:50 GMT-0800 (Pacific Standard Time)">09:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">the reason I want to do this is to measure the exact overhead of calling Wasm Builtins. I have plugged hardware-specific routines in Firefox to replace wasm ones, and we can't see a gain. Since most of the calls are at the microseconds level in both sides -- lots of calls on small data-- I am starting to suspect that the call to the imported wasm intrisinc might add that small overhead that cancels the gains. It's hard to tell in the profiler, it's not obvious at all. So what I did is implement a builtin that sleeps for 1ms in Firefox and measure how long it takes from the wasm, to measure a precise overhead. But the results are rounded at the ms to it's hard to measure.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jan 09 2025 01:56:26 GMT-0800 (Pacific Standard Time)">09:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I can help</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jan 09 2025 01:57:15 GMT-0800 (Pacific Standard Time)">09:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">When doing performance measurement of that kind, always use profiler markers, never use anything else</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jan 09 2025 02:00:42 GMT-0800 (Pacific Standard Time)">10:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@julienw:mozilla.org">julienw</span>&gt;</div></td><td class="msg-cell">do you need some help to call performance.mark and measure from wasm <span class="nick-13">Tarek</span> ?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jan 09 2025 02:01:16 GMT-0800 (Pacific Standard Time)">10:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">yeah Julien, from our discussion, I would need to add profiler markers on the wasm side, which would mean importing the wasm console or euivalent builtin to reach console.mark etc, but then this might add overhead </td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jan 09 2025 02:03:00 GMT-0800 (Pacific Standard Time)">10:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@julienw:mozilla.org">julienw</span>&gt;</div></td><td class="msg-cell">there's also the option of calling <a href="http://performance.now">performance.now</a>(), that one I know it's influenced by the headers</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jan 09 2025 02:03:05 GMT-0800 (Pacific Standard Time)">10:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@julienw:mozilla.org">julienw</span>&gt;</div></td><td class="msg-cell">(still in the DOM side though)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jan 09 2025 02:05:02 GMT-0800 (Pacific Standard Time)">10:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">I think this is what <code>emscripten_get_now</code> calls</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jan 09 2025 02:05:08 GMT-0800 (Pacific Standard Time)">10:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">will try, thanks</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jan 09 2025 02:33:21 GMT-0800 (Pacific Standard Time)">10:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">woooo. works now :)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jan 09 2025 02:47:38 GMT-0800 (Pacific Standard Time)">10:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">On 205 calls of a builtin that is just sleeping 4ms, I get an average overhead of 1014.92 microseconds.  It feels like there's an issue. It feels extremely large. I am probably doing something wrong cc <span class="nick-2">Ryan Hunt | pto until Jan 8</span></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jan 09 2025 03:00:24 GMT-0800 (Pacific Standard Time)">11:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">gregtatum</span>: have you noticed this issue for Bergamot when using mozIntGemm?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jan 09 2025 03:00:56 GMT-0800 (Pacific Standard Time)">11:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">on 1ms calls done ~200 times I get an average overhead of 305 micros</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Jan 09 2025 03:07:17 GMT-0800 (Pacific Standard Time)">11:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><p>could this be related to the fact that I compiled the wasm in releasedebuginfo mode?</p>
<pre><code>[ 98%] Linking CXX executable ort-wasm-simd-threaded.jsep.mjs
em++: warning: disabling closure because debug info was requested [-Wemcc]
em++: warning: warnings in JS library compilation [-Wjs-compiler]
em++: warning: running limited binaryen optimizations because DWARF info requested (or indirectly required) [-Wlimited-postlink-optimizations]
</code></pre>
</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Jan 09 2025 06:00:29 GMT-0800 (Pacific Standard Time)">14:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dminor:mozilla.org">dminor</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">Ms2ger</span>: Now that we've got non262 tests in <code>staging/sm</code> I was thinking of removing duplicated tests from the local <code>non262</code> tests and just running them from our test262 import. Do you have any concerns about that?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Jan 09 2025 06:00:39 GMT-0800 (Pacific Standard Time)">14:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dminor:mozilla.org">dminor</span>&gt;</div></td><td class="msg-cell">And thanks for all of the working getting the export script running :)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Jan 09 2025 06:02:10 GMT-0800 (Pacific Standard Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dminor:mozilla.org">dminor</span>&gt;</div></td><td class="msg-cell">Eventually, I think we'll move to writing tests for new proposals directly in <code>staging</code>, but for now we'll probably keep <code>non262</code> around so as not to increase the barrier to entry for new contributors.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Jan 09 2025 06:48:32 GMT-0800 (Pacific Standard Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@gregtatum:mozilla.org">gregtatum</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span>: I think this discussion was resolved in Slack, but as was stated in the other room, we operate on larger arrays of data, so the overhead isn't an issue like in your case with smaller arrays.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Jan 09 2025 07:11:31 GMT-0800 (Pacific Standard Time)">15:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">gregtatum</span>: we're currently trying to do a better job at profiling what's going on.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Jan 09 2025 07:40:18 GMT-0800 (Pacific Standard Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@gregtatum:mozilla.org">gregtatum</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span>: if you need profiler marker stacks, you have <code>ChromeUtils.addProfilerMarker</code> available as well as you're running a ChromeWorker.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Jan 09 2025 07:40:54 GMT-0800 (Pacific Standard Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">gregtatum</span>: this is for the c++ code inside onnx we don't have gecko there</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Jan 09 2025 07:43:16 GMT-0800 (Pacific Standard Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@gregtatum:mozilla.org">gregtatum</span>&gt;</div></td><td class="msg-cell"><p>If you're compiling Wasm you can call JS code from C++. Here's where I did it in in the Marian code.</p>
<pre><code>diff --git a/src/common/io_item.h b/src/common/io_item.h
index 24968ec4..e06272c3 100755
--- a/src/common/io_item.h
+++ b/src/common/io_item.h
@@ -3,6 +3,7 @@
 #include "common/shape.h"
 #include "common/types.h"

+#include &lt;emscripten.h&gt;
 #include &lt;string&gt;

 namespace marian {
@@ -27,7 +28,25 @@ struct Item {
         mapped(other.mapped),
         name(other.name),
         shape(other.shape),
-        type(other.type) {}
+        type(other.type) {
+    printf("!!! Item copy constructor %s (count %ld) %p\n",
+           name.c_str(),
+           other.bytes.use_count(),
+           other.bytes.get());
+
+    // clang-format off
+    EM_ASM({
+      const name = UTF8ToString($0);
+      const size = $1;
+      const pointer = $2;
+
+      ChromeUtils.addProfilerMarker(
+        `Item() "${name}" ${size} 0x${pointer.toString(16)}`,
+        { captureStack: true }
+      );
+    }, name.c_str(), bytes-&gt;size(), reinterpret_cast&lt;size_t&gt;(bytes.get()));
+    // clang-format on
+  }

</code></pre>
</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Jan 09 2025 07:46:22 GMT-0800 (Pacific Standard Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">gregtatum</span>: did you measure the average call time when you call gemmology in translation? E.g are we bigger than 20ms per call for example</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Jan 09 2025 07:54:57 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@gregtatum:mozilla.org">gregtatum</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span>: I don't know per call, mostly I profile when translating a full page, and most of the time is spent within a matrix math operation inside of gemmology.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Jan 09 2025 07:55:27 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@gregtatum:mozilla.org">gregtatum</span>&gt;</div></td><td class="msg-cell">e.g. here is a random profile that has symbols that was in my history <a href="https://share.firefox.dev/4278Oe9">https://share.firefox.dev/4278Oe9</a></td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Jan 09 2025 09:33:21 GMT-0800 (Pacific Standard Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: Opened <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1940796">https://bugzilla.mozilla.org/show_bug.cgi?id=1940796</a> -- if you have a pointer to some code that's relevant I'd love to include it for next time we spelunk here</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Jan 09 2025 09:47:46 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I commented my understanding of what's going on here</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Jan 09 2025 09:48:29 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Thank you! </td></tr>

</tbody></table></div></div></div>
</body></html>