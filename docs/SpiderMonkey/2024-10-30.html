<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-10-30</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-10-30<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-10-29" class="nav-link"><span>prev</span></a>
<a href="2024-10-31" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Oct 29 2024 17:11:57 GMT-0700 (Pacific Daylight Time)">00:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Oh, interesting. My usual test GCs have sweep time well under 1% of total GC time. On my sp3 run, sweep time is 97% of the total major GC time.</blockquote></mx-reply>smaug: oops, I looked at this again. That sweep time includes the time spend marking during the sweep phase. If I separate that out, then it's only 9% of time spent sweeping, 91% marking (including marking time during both mark and sweep phases). So it looks like a mark-only GC wouldn't buy us all that much.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Oct 29 2024 17:12:16 GMT-0700 (Pacific Daylight Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm using <a href="https://share.firefox.dev/4hsl2mM">this profile</a> from my laptop.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Oct 30 2024 03:16:47 GMT-0700 (Pacific Daylight Time)">10:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: yeah, I started to see something similar. The garbage we have in this case is mostly full window+document, and several of them. So quite a bit marking for CC</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Oct 30 2024 06:59:42 GMT-0700 (Pacific Daylight Time)">13:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: now all test failures are fixed, I have a warning needs to be fixed <code>missing field 'spec' initializer</code>, is it <a href="https://searchfox.org/mozilla-central/source/toolkit/components/finalizationwitness/FinalizationWitnessService.cpp#161-162">this</a>?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Oct 30 2024 07:01:18 GMT-0700 (Pacific Daylight Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">where's the warning shown?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Oct 30 2024 07:02:31 GMT-0700 (Pacific Daylight Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><code>/builds/worker/workspace/obj-build/dist/include/jsapi.h:115:22: error: missing field 'spec' initializer</code>, that's the last line of my changes in <code>jsapi.h</code></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Oct 30 2024 07:03:02 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><a href="https://paste.mozilla.org/7qa11xGX">https://paste.mozilla.org/7qa11xGX</a></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Oct 30 2024 07:05:22 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I suppose, the definition should be put inside cpp file</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Oct 30 2024 07:05:40 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">both sHostDefinedData and sHostDefinedDataClass</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Oct 30 2024 07:06:24 GMT-0700 (Pacific Daylight Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">otherwise, omitting the field initializers should be fine</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Oct 30 2024 07:06:43 GMT-0700 (Pacific Daylight Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe I'm missing something</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Oct 30 2024 07:07:40 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">I can definitely try to move those around..do you have a suggestion about where I should put them? I've been questioning myself about putting them in <code>jsapi.h</code>...</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Oct 30 2024 07:09:15 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm not sure I follow the intent.  looks like it's shared between the internal queue and gecko</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Oct 30 2024 07:09:26 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">basically they don't have to share the definition</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Oct 30 2024 07:10:49 GMT-0700 (Pacific Daylight Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: so for both <code>InternalJobQueue::getHostDefinedData</code> and <code>CycleCollectedJSContext::getHostDefinedData</code> create it</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Oct 30 2024 07:11:10 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">so I am sharing the definition between JS and the embedding</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Oct 30 2024 07:11:15 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">is it..not correct?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Oct 30 2024 07:11:17 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">InternalJobQueue doesn't actually have to return any object, given it doesn't use the passed value in <code>InternalJobQueue::enqueuePromiseJob</code></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Oct 30 2024 07:12:38 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's "host-defined", and it's completely opaque to SpiderMonkey, right?  if so, the values returned by <code>getHostDefinedData</code> doesn't have to use any specific class, but the embedding can define its own class</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Oct 30 2024 07:13:16 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, even if the InternalJobQueue need to return some value as HostDefined data, it can be different class than Gecko's one</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Oct 30 2024 07:14:42 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">hmm, I though <code>JS_NewObject</code> needs to know the definition, but sounds like it doesn't have to?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Oct 30 2024 07:16:10 GMT-0700 (Pacific Daylight Time)">14:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS_NewObject</code> takes <code>JSClass</code>, yes, but it's only because the consumer wants to use the class</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Oct 30 2024 07:16:31 GMT-0700 (Pacific Daylight Time)">14:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the InternalJobQueue case doesn't need to use the class</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Oct 30 2024 07:17:09 GMT-0700 (Pacific Daylight Time)">14:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">er..but it sets the incumbent global to the slot?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Oct 30 2024 07:17:26 GMT-0700 (Pacific Daylight Time)">14:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but the slot value is unused and just thrown away</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Oct 30 2024 07:17:53 GMT-0700 (Pacific Daylight Time)">14:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the <code>InternalJobQueue::enqueuePromiseJob</code> method doesn't touch the <code>hostDefinedData</code> parameter</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Oct 30 2024 07:17:59 GMT-0700 (Pacific Daylight Time)">14:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">oh I see....</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Oct 30 2024 07:18:54 GMT-0700 (Pacific Daylight Time)">14:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, with the unpatched code, the internal job queue has "incumbentGlobal" things only because that was a part of interface</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Oct 30 2024 07:19:12 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but now that's not longer a part of interface and it's hidden behind "HostDefined" data</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Oct 30 2024 07:21:44 GMT-0700 (Pacific Daylight Time)">14:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">So, the all those definition of the HostDefined data inside jsapi.h should be moved to Gecko side, possibly in <code>CycleCollectedJSContext.{cpp,h}</code> or <code>WebTaskScheduler.{cpp,h}</code></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Oct 30 2024 07:21:58 GMT-0700 (Pacific Daylight Time)">14:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">okay! I think the caller does a null check or something so I implemented it this way..let me check if I did some mistakes in the caller </td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Oct 30 2024 07:26:10 GMT-0700 (Pacific Daylight Time)">14:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Then, I should've clarified.  That path is going to add one more allocation to the job handling, that is the <code>JS_NewObject</code> call inside <code>CycleCollectedJSContext::getHostDefinedData</code>. Once the patch starts working, we'll need to look into the performance impact, and if that affects too much, we'll need to look into different design, or apply a kind of cache or something</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Oct 30 2024 07:26:34 GMT-0700 (Pacific Daylight Time)">14:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(not yet sure how critical the JS_NewObject is tho)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Oct 30 2024 08:29:43 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: so <code>FinalizationQueueObject::create</code> calls <code>js::GetObjectFromHostDefinedData</code> and then <code>InternalJobQueue::getHostDefinedData</code>, so the caller actually uses it?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Oct 30 2024 08:30:11 GMT-0700 (Pacific Daylight Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/5fdbe0d78d61581aa4b37ce82bbf31c2bd7826f1/js/src/builtin/FinalizationRegistryObject.cpp#692,703">this is how it's used today</a></td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Oct 30 2024 08:34:54 GMT-0700 (Pacific Daylight Time)">15:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>The value is <a href="https://searchfox.org/mozilla-central/rev/5fdbe0d78d61581aa4b37ce82bbf31c2bd7826f1/js/src/builtin/FinalizationRegistryObject.cpp#692,703">stored</a> into <code>IncumbentObjectSlot</code> slot of the FinalizationQueueObject`</p>
<p>And the slot value is get by <a href="https://searchfox.org/mozilla-central/rev/5fdbe0d78d61581aa4b37ce82bbf31c2bd7826f1/js/src/builtin/FinalizationRegistryObject.cpp#757-758">FinalizationQueueObject::incumbentObject</a></p>
<p>That incumbentObject object is <a href="https://searchfox.org/mozilla-central/rev/5fdbe0d78d61581aa4b37ce82bbf31c2bd7826f1/js/src/gc/FinalizationObservers.cpp#305,309-310">passed to callHostCleanupFinalizationRegistryCallback</a></p>
<p>and then <a href="https://searchfox.org/mozilla-central/rev/5fdbe0d78d61581aa4b37ce82bbf31c2bd7826f1/js/src/gc/GC.cpp#1649-1650,1654">passed to the callback function specified by the embedding</a><br>that callback is set by <a href="https://searchfox.org/mozilla-central/rev/5fdbe0d78d61581aa4b37ce82bbf31c2bd7826f1/js/public/GCAPI.h#1344">JS::SetHostCleanupFinalizationRegistryCallback</a> API, which is called in <a href="https://searchfox.org/mozilla-central/rev/5fdbe0d78d61581aa4b37ce82bbf31c2bd7826f1/xpcom/base/CycleCollectedJSContext.cpp#890">mozilla::FinalizationRegistryCleanup::Init</a> and the callback is <a href="https://searchfox.org/mozilla-central/rev/5fdbe0d78d61581aa4b37ce82bbf31c2bd7826f1/xpcom/base/CycleCollectedJSContext.cpp#894">mozilla::FinalizationRegistryCleanup::QueueCallback</a></p>
</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Oct 30 2024 08:35:15 GMT-0700 (Pacific Daylight Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">So, SpiderMonkey actually doesn't touch the object (except for wrap/unwrap)</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Oct 30 2024 08:37:03 GMT-0700 (Pacific Daylight Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: but don't I still need to create the hostDefined object in Spidermonky to pass it around? so the definition of it is still needed there?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Oct 30 2024 08:37:43 GMT-0700 (Pacific Daylight Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">where do you need to create it?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Oct 30 2024 08:38:16 GMT-0700 (Pacific Daylight Time)">15:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: In InternalJobQueue::getHostDefinedData?</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Oct 30 2024 08:39:10 GMT-0700 (Pacific Daylight Time)">15:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">InternalJobQueue doesn't need HostDefined data.  and even if it needs, the definition isn't necessarily be same as Gecko</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Oct 30 2024 08:40:12 GMT-0700 (Pacific Daylight Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">okay, why doesn't it need it?</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Oct 30 2024 08:42:00 GMT-0700 (Pacific Daylight Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">[[HostDefined]] data is not part of ECMAScript.  the each field comes from the HTML spec ( <a href="https://html.spec.whatwg.org/#hostmakejobcallback">https://html.spec.whatwg.org/#hostmakejobcallback</a> )</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Oct 30 2024 08:42:58 GMT-0700 (Pacific Daylight Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">InternalJobQueue doesn't implement any of those HTML spec things, and it doesn't touch [[HostDefined]] data</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Oct 30 2024 08:44:49 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: er..okay...that makes sense, so I shouldn't implement <code>InternalJobQueue::getHostDefinedData</code> at all? and keep getIncumbentGlobal?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Oct 30 2024 08:45:21 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you need getHostDefinedData, given it's replacing the getIncumbentGlobal method</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Oct 30 2024 08:45:28 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but getHostDefinedData can just return a nullptr</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Oct 30 2024 08:46:05 GMT-0700 (Pacific Daylight Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">And all remaining part inside SpiderMonkey will pass the nullptr around</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Oct 30 2024 08:47:43 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the nullptr will eventually be passed back to InternalJobQueue, especially InternalJobQueue::enqueuePromiseJob method. and the method doesn't use the parameter</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Oct 30 2024 08:48:26 GMT-0700 (Pacific Daylight Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the nullptr is also eventually passed to the shell's FinalizationRegistryCallback function  <a href="https://searchfox.org/mozilla-central/rev/5fdbe0d78d61581aa4b37ce82bbf31c2bd7826f1/js/src/shell/js.cpp#1336">ShellCleanupFinalizationRegistryCallback</a>, but it doesn't also use the parameter</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Oct 30 2024 08:49:19 GMT-0700 (Pacific Daylight Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">so <code>FinalizationQueueObject::create</code> needs to check the JobQueue, and allow it to be null if it's an InternalJobQueue?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Oct 30 2024 08:50:35 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>FinalizationQueueObject::create</code> is also going to use HostDefined object instead of Incumbent Global</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Oct 30 2024 08:50:53 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and HostDefined object can always be nullptr, regardless of the JobQueue's implementation</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Oct 30 2024 08:52:39 GMT-0700 (Pacific Daylight Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(actually, even in the current code, it should accept incumbentObject being nullptr, and handle nullptr case in the remaining code path)</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Oct 30 2024 08:53:50 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(that case doesn't happen in practice, but there's not much reason to prohibit it)</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Oct 30 2024 08:54:36 GMT-0700 (Pacific Daylight Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Anyway, the current non-null requirement shouldn't be kept if those parts are rewritten with HostDefined object</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Oct 30 2024 08:55:53 GMT-0700 (Pacific Daylight Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">okay, thanks....so if <code>Rooted&lt;JSObject*&gt; hostDefinedData(cx)</code> is null, do I still set the slot?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Oct 30 2024 08:56:24 GMT-0700 (Pacific Daylight Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">FinalizationQueueObjec's slot?</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Oct 30 2024 08:56:39 GMT-0700 (Pacific Daylight Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">If so, yes, you can use JS::ObjectOrNullValue</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Oct 30 2024 08:56:41 GMT-0700 (Pacific Daylight Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">(I think I sortof finally get this, I didn't figure out host defined object can be null)</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Oct 30 2024 08:56:43 GMT-0700 (Pacific Daylight Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Oct 30 2024 08:57:18 GMT-0700 (Pacific Daylight Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and use JS::Value::toObjectOrNull when extracting from the slot</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Oct 30 2024 08:57:43 GMT-0700 (Pacific Daylight Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">okay! thanks </td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Oct 30 2024 09:18:19 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: <span class="nick-10">yulia</span> you may have some opinion on <a href="https://github.com/whatwg/html/pull/10528">https://github.com/whatwg/html/pull/10528</a> (that seems to be in tomorrow's WHATNOT agenda)</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Oct 30 2024 09:36:48 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">What's the deal with <code>./mach try</code> going through lando?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Oct 30 2024 09:39:59 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">Ms2ger</span>: they changed the default in bug 1923647, but you can still <code>--push-to-vcs</code> too. Pushing to try through lando is a lot faster though</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Oct 30 2024 09:43:18 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">Oh, this seems to just be to avoid me waiting on the lock locally? Seems like a lot of effort, but ok</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Oct 30 2024 09:44:19 GMT-0700 (Pacific Daylight Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it also uses SSO instead of SSH for authentication</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Oct 30 2024 09:45:01 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">[old man shakes fist at SSO]</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Oct 30 2024 13:10:58 GMT-0700 (Pacific Daylight Time)">20:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I now have an crash about value not in the same compartment at the <code>JS_SetReservedSlot</code> call in <code>CycleCollectedJSContext::getHostDefinedData</code>, should I wrap the global here?</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Oct 30 2024 13:11:08 GMT-0700 (Pacific Daylight Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">not sure how to do it properly in DOM code</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Oct 30 2024 13:14:58 GMT-0700 (Pacific Daylight Time)">20:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">oh maybe I should do it in JSRuntime::getHostDefinedData</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Oct 30 2024 13:15:40 GMT-0700 (Pacific Daylight Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">err, maybe not, that means we are creating the object in the JS engine..</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Oct 30 2024 14:02:55 GMT-0700 (Pacific Daylight Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you'll need to enter the global's realm and create object there</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Oct 30 2024 14:04:09 GMT-0700 (Pacific Daylight Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/public/Realm.h#193">https://searchfox.org/mozilla-central/source/js/public/Realm.h#193</a></td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Oct 30 2024 14:31:40 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: what does mark_weak mean?</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Oct 30 2024 14:31:45 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Weakreferences?</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Oct 30 2024 14:32:55 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(in sp3 logs there are quite a few weak references.)</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Oct 30 2024 14:36:35 GMT-0700 (Pacific Daylight Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I hadn't started looking into that yet. I think it includes a couple of different things. Looking...</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Oct 30 2024 14:39:27 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(some of) WeakMap marking and jitcode marking are the two things I see.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Oct 30 2024 14:39:35 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">uh oh, the latter might be an artifact of profiling, it looks like?</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Oct 30 2024 14:40:04 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'll look at the profile to see if I can tell what's taking the time</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Oct 30 2024 14:42:06 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, and something I meant to mention but forgot, there's pretty much always a COMPARTMENT_REVIVED GC after every GC.</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Oct 30 2024 14:42:07 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, perhaps we need profiles without any js stuff?</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Oct 30 2024 14:42:50 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">COMPARTMENT_REVIVED is really bad yes. I don't see that often and I have a patch to make the triggered CC incremental </td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Oct 30 2024 14:43:27 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">but perhaps it is just heuristics which need to change for COMPARTMENT_REVIVED</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Wed Oct 30 2024 14:44:34 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">for the slice I'm looking at, it's 2/3 jitcode</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Wed Oct 30 2024 14:45:44 GMT-0700 (Pacific Daylight Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I wonder if profiler is doing that, or is it just that sp3 creates tons of jit code (because we don't reuse )</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Wed Oct 30 2024 14:47:01 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the <a href="https://searchfox.org/mozilla-central/rev/53e8dfd81c32f1ab275516406ec06a68136aaef0/js/src/jit/JitcodeMap.cpp#279-300">comment</a> seems to imply profiler-related stuff</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Wed Oct 30 2024 14:47:32 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">though I notice it <a href="https://searchfox.org/mozilla-central/rev/53e8dfd81c32f1ab275516406ec06a68136aaef0/js/src/jit/JitcodeMap.cpp#304">disables sampling</a>. I'm not sure how it can get so many samples, then??!</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Wed Oct 30 2024 14:47:42 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">There was <a href="https://phabricator.services.mozilla.com/D195575">https://phabricator.services.mozilla.com/D195575</a> for COMPARTMENT_REVIVED</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Wed Oct 30 2024 14:50:41 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">julienw</span>: is it enough to disable js in the profiler's settings to avoid that stuff sfink linked ?</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Wed Oct 30 2024 14:52:15 GMT-0700 (Pacific Daylight Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">er, actually, I'm not seeing JitcodeGlobalTable::markIteratively in the stack. I tihnk I might have gone on the wrong path here.</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Wed Oct 30 2024 14:54:18 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Do we allocate jit code from the nursery heap ?</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Wed Oct 30 2024 14:54:34 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, hm, maybe that's because most of the time is in <code>markUntilBudgetExhausted</code></td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Wed Oct 30 2024 14:55:00 GMT-0700 (Pacific Daylight Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Do we allocate jit code from the nursery heap ?</blockquote></mx-reply>no</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Wed Oct 30 2024 14:57:52 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, it looks like 1/4 of the mark_weak time is in MarkJitcodeGlobalTableIteratively (which seems profiler-related), 1/6 in enterWeakMarkingMode (so WeakMap stuff), and the rest in looping through the mark stack presumably resulting from those first two.</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Wed Oct 30 2024 15:00:02 GMT-0700 (Pacific Daylight Time)">22:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(in this randomly chosen slice; I probably out to zoom out)</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Wed Oct 30 2024 15:00:14 GMT-0700 (Pacific Daylight Time)">22:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I have to run for a bit, though</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Wed Oct 30 2024 15:02:22 GMT-0700 (Pacific Daylight Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, if I aggregate across all calls to markWeakReferences (the thing labeled mark_weak), it's only 2.8% MarkJitcodeGlobalTableIteratively; all the time is in markUntilBudgetExhausted)</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Wed Oct 30 2024 15:03:59 GMT-0700 (Pacific Daylight Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I don't see real difference whether to profile with js on or off</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Wed Oct 30 2024 16:17:34 GMT-0700 (Pacific Daylight Time)">23:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Quite a bit of time in <code>markImplicitEdges</code>, mostly in doing lookups. I could try digging up my patch for speeding that up. I abandoned it originally because it didn't seem to make a difference.</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Wed Oct 30 2024 16:18:10 GMT-0700 (Pacific Daylight Time)">23:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but back then, I never saw much time spent in this stuff in the first place, so it made sense that it wouldn't matter.</td></tr>

</tbody></table></div></div></div>
</body></html>