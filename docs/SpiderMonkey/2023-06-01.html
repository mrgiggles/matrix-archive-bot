<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-06-01</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-06-01<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-05-31" class="nav-link"><span>prev</span></a>
<a href="2023-06-02" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Jun 01 2023 00:16:43 GMT-0700 (Pacific Daylight Time)">07:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">dminor</span>: looks like <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1826574">https://bugzilla.mozilla.org/show_bug.cgi?id=1826574</a> is causing some devtools issue. I'm going to have a look at this</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jun 01 2023 01:38:53 GMT-0700 (Pacific Daylight Time)">08:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">If a JS script constructs a temporary object, and this object gets sent to C++ code, does the C++ code need to re-root it or is it safe to use a Heap&lt;&gt; for that ? Or for that matter even a Handle ? We have fairly common cases of <code>Engine.postMessage({ tempObect: tempValue})</code></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jun 01 2023 01:51:38 GMT-0700 (Pacific Daylight Time)">08:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">you should re-root it. <code>Heap&lt;&gt;</code> doesn't really apply in this case (stack roots) and for <code>Handle&lt;&gt;</code> you need to have an object root to begin with</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jun 01 2023 02:14:00 GMT-0700 (Pacific Daylight Time)">09:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">If you're sending that "temporary object" to a native function and accessing it through <code>CallArgs</code>, I believe it should be rooted, but don't quote me on that.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jun 01 2023 02:14:45 GMT-0700 (Pacific Daylight Time)">09:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> If you're sending that "temporary object" to a native function and accessing it through <code>CallArgs</code>, I believe it should be rooted, but don't quote me on that.</blockquote></mx-reply>Yes that's what I'm doing, to clarify</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jun 01 2023 02:15:56 GMT-0700 (Pacific Daylight Time)">09:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">CallArgs seems to ::fromMarkedLocation on *argv, so it seems like things must be rooted</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jun 01 2023 02:16:02 GMT-0700 (Pacific Daylight Time)">09:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">or the code would be absurdly dangerous</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jun 01 2023 02:34:37 GMT-0700 (Pacific Daylight Time)">09:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yes but you get it as <code>Value</code>. You usually need an object root if you want to work with it</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jun 01 2023 02:41:42 GMT-0700 (Pacific Daylight Time)">09:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">operator[] actually returns a MutableHandleValue, but maybe I'm misunderstanding what you mean</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jun 01 2023 03:36:39 GMT-0700 (Pacific Daylight Time)">10:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I mean if you want to pass it to an API that wants a HandleObject, you have to re-root for that </td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jun 01 2023 03:37:42 GMT-0700 (Pacific Daylight Time)">10:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">but else you're fine without re-rooting</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jun 01 2023 04:24:52 GMT-0700 (Pacific Daylight Time)">11:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Is there reason to expect that code written in Javascript and then executed in Spidermonkey will be significantly faster or slower than equivalent code written in native Spidermonkey C++ code?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jun 01 2023 04:27:16 GMT-0700 (Pacific Daylight Time)">11:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I know that the answer is probably "it depends", and I'm fine with that. The situation is this: now that my embedded system is working well, I'm finding it much easier to write code in Javascript, rather than write embedded code and deal with all of the rooting, etc. And I'm wondering whether this decision is likely to have any implications for the efficiency of my application.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jun 01 2023 04:37:07 GMT-0700 (Pacific Daylight Time)">11:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Is there reason to expect that code written in Javascript and then executed in Spidermonkey will be significantly faster or slower than equivalent code written in native Spidermonkey C++ code?</blockquote></mx-reply>My experience would suggest that, if you're not doing too much js/c++ interop, it's probably faster to use JITted JS code than interact with the JSAPI from C++</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jun 01 2023 04:42:41 GMT-0700 (Pacific Daylight Time)">11:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">What do you mean by interop?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jun 01 2023 04:43:49 GMT-0700 (Pacific Daylight Time)">11:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">just calling js from c++ and vice-versa.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Jun 01 2023 04:44:01 GMT-0700 (Pacific Daylight Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Not that it changes much from the rest, but it's going to lead to overhead from converting values around</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Jun 01 2023 04:44:59 GMT-0700 (Pacific Daylight Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Right, makes sense. I think I'm doing a lot of that, but it can't be helped!</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Jun 01 2023 04:47:04 GMT-0700 (Pacific Daylight Time)">11:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">but basically it's almost surely faster to do things in JS than calling into C++ if what you are doing is 'manipulating JS objects', and it's probably faster to use the JSAPI from c++ instead of going through a script (but I'd temper that in some respect, the JSAPI seems to have quite some overhead)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Jun 01 2023 06:29:59 GMT-0700 (Pacific Daylight Time)">13:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">To give an example: to load a [x, y] value from C++, it's faster to do [GetX(), GetY()] than to Get(arrayRef) and then JS_SetElement both even though the first is entering C++ twice</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Jun 01 2023 09:31:25 GMT-0700 (Pacific Daylight Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">bug 1638045 got double-reviewed. I guess that's a potential problem with spidermonkey-reviewers? Anyway, thanks jonco &amp; mgaudet.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Jun 01 2023 09:31:27 GMT-0700 (Pacific Daylight Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1638045">https://bugzil.la/1638045</a> — ASSIGNED (sfink) — Run Windows jit-tests in parallel again</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Jun 01 2023 09:32:28 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">r++</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Jun 01 2023 09:34:36 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">everyone loves test infra improvements</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Jun 01 2023 09:39:42 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Haha, yeah we mid-aired</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Jun 01 2023 09:43:22 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">i am looking at a case where a promise isn't getting resolved as expected. If I've got a Pernosco trace of this and I wanted to look at how the micro-task queue was being managed in relationship to a set of promises... where am i looking? is there a good "add-task-to-microtask-queue" function I should be looking for?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Jun 01 2023 09:50:55 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: In the shell?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Jun 01 2023 09:52:10 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I would maybe start poking around here: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/JSContext.cpp#809">https://searchfox.org/mozilla-central/source/js/src/vm/JSContext.cpp#809</a></td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Jun 01 2023 09:52:41 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">That sounds promising</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Jun 01 2023 09:52:54 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Excellent -- thank you; job queue is a word that would have been helpful to come to mind. </td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Jun 01 2023 09:53:15 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There are two different job queues. InternalJobQueue is our own implementation for the shell, and the xpcom one lives <a href="https://searchfox.org/mozilla-central/source/xpcom/base/CycleCollectedJSContext.h#134">here</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Jun 01 2023 09:55:00 GMT-0700 (Pacific Daylight Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Thank you :) </td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Jun 01 2023 10:02:11 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I'm a bit confused by the IC stubs logic, specifically I can't really figure out how the baseline checks against existing stubs vs using the fallback. I'm trying to find out why some code becomes megamorphic</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Jun 01 2023 10:02:49 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">What I figured so far is that when the fallback baseline stub is hit, we try to generate a new more specialised stub, but I can't figure out where that 'what stub do I use / do I have a stub here?' logic is, if anywhere</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Jun 01 2023 10:10:18 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">wraitii</span>: The first time we hit an IC, the only stub is the fallback stub, so we call into (eg) <a href="https://searchfox.org/mozilla-central/source/js/src/jit/BaselineIC.cpp#1191">DoGetPropFallback</a> to attach a stub. That calls into <a href="https://searchfox.org/mozilla-central/source/js/src/jit/CacheIR.cpp#369">GetPropIRGenerator::tryAttach</a>, which looks at the inputs and creates a CacheIR sequence that will handle those inputs. For example, a very common pattern for a GetProp is "GuardToObject/GuardShape/LoadFixedSlot", which verifies that the receiver is an object with the right shape and loads the value in a particular slot. We <a href="https://searchfox.org/mozilla-central/source/js/src/jit/CacheIRCompiler.cpp">compile that sequence</a> to create a stub and attach it to the front of the IC chain.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Jun 01 2023 10:11:34 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The next time we hit the IC, we will first try that stub. So long as the input is an object with the right shape, it will succeed. If one of the guards in the stub fails, then we will jump to the next stub, which is the fallback stub, and end up trying to attach a new stub to the chain.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Jun 01 2023 10:12:22 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">New stubs are always attached to the front of the chain. If we hit the fallback with six stubs already in the chain, then we throw them all away and switch to megamorphic mode, which attaches more general stubs.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Jun 01 2023 10:16:00 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">When we do an Ion compilation, we look at all the IC chains. If the first stub in an IC (the most recently added one) has never failed, we assume that it handles all the cases we care about. We take the CacheIR  for that stub and turn it into MIR, which is the input to Ion. If there are multiple active stubs, then we instead use an IC in Ion.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Jun 01 2023 10:20:09 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I guess the part I'm missing is 'If one of the guards in the stub fails, then we will jump to the next stub', couldn't find where that was in the code</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Jun 01 2023 10:20:28 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">But it probably doesn't matter, the point is that if a new stub gets added it's that one of the guards failed</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Jun 01 2023 10:22:38 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It happens in generated jitcode. We generate that code <a href="https://searchfox.org/mozilla-central/source/js/src/jit/BaselineCacheIRCompiler.cpp#204-213">here</a>.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Jun 01 2023 10:23:05 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Specifically: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/x64/SharedICHelpers-x64.h#59-65">here's the jump</a>)</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Jun 01 2023 10:26:50 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Ah, I see, thanks</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Jun 01 2023 10:27:04 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And for example this is how we would generate the GuardToObject: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/CacheIRCompiler.cpp#1506-1519">https://searchfox.org/mozilla-central/source/js/src/jit/CacheIRCompiler.cpp#1506-1519</a></td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Jun 01 2023 10:27:10 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I guess here the reason for the stubs is that I'm trying to assign to a dynamic object property name, and there actually is a guard for that property name</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Jun 01 2023 10:28:36 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Something like <code>obj[propName] = value</code>, with a variety of different prop names?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Jun 01 2023 10:29:29 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">yup exactly</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Jun 01 2023 10:29:47 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">It's probably normal behaviour that that goes megamorphic tbh, just meant to understand how it happened</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Jun 01 2023 10:30:18 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In that case, the first stub we attach will optimistically assume that the prop name will be fixed in practice, and attach a stub targeting that name. We will do that six times, then transition to megamorphic mode and attach a more generic stub that will hash together the shape and the property name and look it up in a cache.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Jun 01 2023 10:30:29 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Going megamorphic in this case is working as designed.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Jun 01 2023 10:30:54 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">yes interesting</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Jun 01 2023 10:31:15 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I suppose this would prevent trial inlining since the caller would then only see a monomorphic megamorphic callee</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Jun 01 2023 10:31:24 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">unlikely to be relevant in a lof of cases tbh</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Jun 01 2023 10:33:00 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We will do trial inlining (as opposed to monomorphic inlining) in this case because the stub is megamorphic, not specialized. See <a href="https://searchfox.org/mozilla-central/source/js/src/jit/TrialInlining.cpp#612">here</a>.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Jun 01 2023 10:36:30 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Ah, nice</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Jun 01 2023 10:36:47 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(I'm not actually convinced that the heuristic is useful in this particular case, but overall it seems to help)</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Jun 01 2023 10:37:42 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It would work if you had a bunch of callers that were each passing in a fixed string, I guess</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Jun 01 2023 10:37:49 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But only if all the objects had the same shape</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Jun 01 2023 10:38:14 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I guess conceptually if you have a function that returns <code> obj[someKey]</code>, but all callers into that pass a (different) constant <code>someKey</code>, you could just inline the atomised-constant at the caller site and skip the atomisation</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Jun 01 2023 10:38:36 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">that doesn't actually seem completely absurd tbh</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Jun 01 2023 10:39:06 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">"Not completely absurd" is what we aspire for in our heuristics</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Jun 01 2023 10:39:52 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(If you're using an object like a map, it may also be worth considering if you should use a Map too -- weirdness abides when you use objects as Maps)</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Jun 01 2023 10:39:57 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I guess conceptually if you have a function that returns <code> obj[someKey]</code>, but all callers into that pass a (different) constant <code>someKey</code>, you could just inline the atomised-constant at the caller site and skip the atomisation</blockquote></mx-reply>well constant-but-not-an-atom-for-some-reason, which is a less likely case, but might still happen with some dynamically constructed things</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Jun 01 2023 10:40:18 GMT-0700 (Pacific Daylight Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (If you're using an object like a map, it may also be worth considering if you should use a Map too -- weirdness abides when you use objects as Maps)</blockquote></mx-reply>Yeah I suppose I should update most of our objects-as-map-code to use proper maps</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Jun 01 2023 10:42:14 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But do test perf; we have optimized property access a lot, but Maps get less use and have had less elbow grease applied.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Jun 01 2023 10:43:10 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">We do use Map() in some very hot code, maybe I could try looking into that specifically. I don't really do any of these things without a profiler anyways, because expectations can be rather deceiving </td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Jun 01 2023 10:43:13 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Thanks again for your answers</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Jun 01 2023 10:46:19 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">To be honest things seem to work rather well right now, and with spectre removed I’m having trouble finding places to optimize </td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Jun 01 2023 11:06:07 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Obects with a null prototype (<code>Object.create(null)</code> are less weird than standard objects with prototype <code>Object.prototype</code>, but yes, <code>Map</code>s are semantically a cleaner match but lack optimization.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Jun 01 2023 11:11:15 GMT-0700 (Pacific Daylight Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I think we tend to go with ‘{}’ so maybe not the best </td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Jun 01 2023 11:13:19 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Part of the reason I was  wondering is that since trial inlining happens once, unles we bailout from ion (and thus reset the counter). So if we end up compiling a metamorphic ion function, we may never get to respecialize it later. Not entirely sure of the interplay here basically</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Jun 01 2023 11:13:57 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><p>I think where I've run into it is</p>
<pre><code>js&gt; "constructor" in {}
true
js&gt; "constructor" in Object.create(null)
false
</code></pre>
</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Jun 01 2023 11:14:03 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">also <code>"length" in []</code></td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Jun 01 2023 11:38:16 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">What is the best strategy for error / exception handling in Spidermonkey? I really don't like the bool return system which forces you to use out params for basic things, and I'm trying to avoid it as much as possible. My current approach is to check every jsapi function and if it fails, log it and throw a c++ exception. If an exception is caught, it resets the Context.  This way my native functions can only return true, and if they fail, the whole system resets. (I'm only talking about jsapi exceptions; regular javascript errors are handled elsewhere and don't reset the system).

Does this seem like a good approach, or are there things that I haven't considered?</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Jun 01 2023 11:40:28 GMT-0700 (Pacific Daylight Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Another option I thought of would be to wrap all returns in std::expected, or something similar. I think this might make the code better, though it sounds like a lot of work, and obviously we have to wait for c++23.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Jun 01 2023 11:43:49 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The bool return system is, in our opinion, the best strategy. That's why we use it. SpiderMonkey is not designed to work with C++ exceptions.</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Jun 01 2023 11:44:49 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Hmm, so embrace the out params then?</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Jun 01 2023 11:45:52 GMT-0700 (Pacific Daylight Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That would be my advice. You get used to it. In a lot of cases, we return object-or-null, where nullptr means that the call failed.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Jun 01 2023 13:01:32 GMT-0700 (Pacific Daylight Time)">20:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">translating that to rust <code>Result</code> is really annoying, which makes me sad</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Jun 01 2023 13:01:56 GMT-0700 (Pacific Daylight Time)">20:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">the bool return system, that is</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Jun 01 2023 14:04:29 GMT-0700 (Pacific Daylight Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in a past non-JS embedding I did, I injected wrappers on both sides of the scripting language's interface. Failures would get converted to C++ exceptions and thrown. Any C++ function or code called from the language would be wrapped in a try block, and exceptions would be converted to the language's equivalent.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Jun 01 2023 14:05:25 GMT-0700 (Pacific Daylight Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">any time a C++ exception unwound frames belonging to the language, it caused problems. I was using an interface generator, so I was able to automate the wrapping on both sides to prevent that from ever happening.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Jun 01 2023 14:07:18 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">We've talked about switching to a Rust-like <code>Result</code>. It's possible it could still happen, but I wouldn't hold my breath.</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Jun 01 2023 14:07:35 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(and it doesn't resolve the tension with C++ exceptions)</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Thu Jun 01 2023 14:09:45 GMT-0700 (Pacific Daylight Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">If I were embedding JSAPI today, I'd probably stick with the bool return stuff for anything close to the JSAPI, especially stuff underneath (called by) it.</td></tr>

</tbody></table></div></div></div>
</body></html>