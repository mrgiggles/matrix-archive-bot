<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-07-12</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-07-12<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-07-11" class="nav-link"><span>prev</span></a>
<a href="2022-07-14" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jul 12 2022 01:46:02 GMT-0700 (Pacific Daylight Time)">08:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: Thank you!  I knew I wasn't imagining it.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jul 12 2022 01:46:46 GMT-0700 (Pacific Daylight Time)">08:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">oh, that is a really interesting approach</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jul 12 2022 02:17:35 GMT-0700 (Pacific Daylight Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: <span class="nick-4">jonco</span>: This paper suggests to look at it for cases where we have multiple threads. Which is not what I had suggested, which looks at the generated code, and slow it down to identify the frequency of usage of each generated code path.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jul 12 2022 02:19:31 GMT-0700 (Pacific Daylight Time)">09:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I guess one thing which would be nice to have for this idea to work reliably is a way to enforce a deterministic JIT, even if this implies to always compile everything on the main thread.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jul 12 2022 07:34:05 GMT-0700 (Pacific Daylight Time)">14:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">TIL that <a href="https://fx-trains.herokuapp.com/">https://fx-trains.herokuapp.com/</a> is the currently supported incarnation of <a href="https://whattrainisitnow.com/">https://whattrainisitnow.com/</a></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jul 12 2022 13:40:49 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">I have been having some issues where I have a function that is in the global namespace, and I run through a large batch process, where it runs a bunch of steps calling JS_ExecuteScript, it gets redefined a bunch of times between the steps.....but always to something.  I am getting an issue where, if I do not put a JS_MaybGC() call in, after each batch "step" may global function gets undefined.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jul 12 2022 14:06:10 GMT-0700 (Pacific Daylight Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">My first thought would be that it isn't rooted, but if it's in the global namespace, then it should be reachable from the global. Are you perhaps storing it as a <code>JSObject*</code> or <code>JSFunction*</code> in C++ somewhere, and that place isn't rooted or traced? (I would expect <code>JS_MaybeGC()</code> to be <em>more</em> likely to trigger a GC that causes it to be corrupted, but maybe that's causing more minor GCs and so it gets tenured sooner or something... &lt;waves hands erratically&gt;)</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jul 12 2022 14:08:10 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">Basically without the Maybe_GC, we start getting this like 1 hour into the process. I am not from the C++ end touching the functions its self. Its all defined in the JS script I am running, and its defined in the global namespace.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jul 12 2022 14:18:35 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">I did create a test - where I had a callback when GC was triggered, and I ask for the particular function....When the GC gets triggered it gets undefined. This is actually normally not an issue because I am pretty sure said function is getting reloaded at the start of the next batch step. What I am suspecting is happening is the periodic calling of JS_MaybeGC(), is just causing the GC behavior to be more consistent, when it runs. Is there a way I can track when the function gets GC'ed? and/or other advice on tracking this down? </td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jul 12 2022 14:36:10 GMT-0700 (Pacific Daylight Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">If you can get this to happen in a debugger (or much better, in rr) then you could set a hardware watchpoint on the function pointer. Then you can go up the stack from there to see why it isn't getting traced. But if you want to stick to JS stuff, then I can think of two options: (1) set the environment variable <code>MOZ_GC_TIMER</code> to the string "stdout" and then you'll get a blob of output for every GC. Or (2) in the JS shell, you can print out <code>performance.mozMemory.gc.gcNumber</code> and see it increment on every GC. But you'd need to have the <code>performance</code> object <a href="https://searchfox.org/mozilla-central/rev/435c4ec4fb9d5b6fe491103f56969492a0038bb6/js/src/shell/js.cpp#10773-10791">added to your global</a>.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jul 12 2022 14:38:33 GMT-0700 (Pacific Daylight Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm trying to think through what could be happening, and I'm not coming up with something. I wonder if you copy it out to another global property and then compare the two, and see if they change together or if the copy stays good or something.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jul 12 2022 14:39:59 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">er, I guess I should check: this is in your own embedding?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jul 12 2022 14:42:14 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">Yes, my own embedding. I think the JS_MaybeGC() is likely keeping the GC happening between - the batch steps, and since the function in question gets reloaded basically about every new step run - its keeping me from hitting the "undefined function" during my batch steps.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jul 12 2022 14:42:36 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">where is it reloaded from?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jul 12 2022 14:46:59 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">Basically I do a JS_CompileScript - with the JS code with the function definition - and then a JS_ExecuteScript</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jul 12 2022 14:48:58 GMT-0700 (Pacific Daylight Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">A bunch of other things maybe get defined and set for each sort batch "step" the function in question is from looking into this defined every batch step.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jul 12 2022 14:49:48 GMT-0700 (Pacific Daylight Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you rerun JS_CompileScript for each batch step?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jul 12 2022 14:49:56 GMT-0700 (Pacific Daylight Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jul 12 2022 14:50:42 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">what version of mozjs? I'm still looking for a version that still has JS_CompileScript</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jul 12 2022 14:50:58 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">1.8.5</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jul 12 2022 14:51:05 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ouch</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jul 12 2022 14:51:19 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">yeah, in process of moving to 78</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jul 12 2022 14:51:36 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm, does it even have generational GC?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jul 12 2022 14:51:47 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or exact rooting, I guess is more to the point</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jul 12 2022 14:52:14 GMT-0700 (Pacific Daylight Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">I am not an expert, but I do not think it has exact rooting.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jul 12 2022 14:54:55 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">exact rooting was 31, it looks like</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jul 12 2022 14:57:20 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess I'm not sure how GC would cause this symptom in 1.8.5. It wasn't moving things around. I guess it would be a problem of it not tracing through the global to the function. But unless the global is getting finalized too, which seems unlikely, I'm not sure how that would happen if the function is a property of the global.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jul 12 2022 14:59:09 GMT-0700 (Pacific Daylight Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it would be nice to catch it in rr so you could dig down to the address that holds the function and set a watchpoint on it to see when it gets wiped. But if it takes an hour to happen, that doesn't seem easy at all. Maybe there's some way to get it to happen faster? You could also identify where it traces the global, verify that the function is a direct property on the global, etc. -- basically, build up a proof of why it should not be getting finalized.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jul 12 2022 15:30:54 GMT-0700 (Pacific Daylight Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">Yeah, I think its basically happening relatively quickly.....I mean this this is getting undefined, like every batch run, it looks like the GC is only running most of the time at the end of our batch runs....its when it happens mid- it blows up our process. It should not be getting undefined at all.......thanks I think I have some place to look tomorrow AM.</td></tr>

</tbody></table></div></div></div>
</body></html>