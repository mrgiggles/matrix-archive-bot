<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-03-30</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-03-30<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-03-29" class="nav-link"><span>prev</span></a>
<a href="2022-03-31" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Mar 29 2022 23:21:09 GMT-0700 (Pacific Daylight Time)">06:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">evilpie</span>: is that patch ready for review or are there more updates coming?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Mar 30 2022 00:49:37 GMT-0700 (Pacific Daylight Time)">07:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">evilpie</span>: is that patch ready for review or are there more updates coming?</blockquote></mx-reply>Yes</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Mar 30 2022 02:16:29 GMT-0700 (Pacific Daylight Time)">09:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">not a yes-or-no question but i'll take it ;-)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Mar 30 2022 06:46:43 GMT-0700 (Pacific Daylight Time)">13:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">lth</span>: indexedDB caching for WASM was removed, right?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Mar 30 2022 06:47:23 GMT-0700 (Pacific Daylight Time)">13:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">evilpie</span>: i believe so, we now use the http cache.  <span class="nick-14">yury</span> would however be authoritative on this.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Mar 30 2022 06:47:46 GMT-0700 (Pacific Daylight Time)">13:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">MDN still has a bunch of references to it</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Mar 30 2022 06:48:03 GMT-0700 (Pacific Daylight Time)">13:48</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@lth:mozilla.org">lth</span></div></td><td class="msg-cell">is not surprised</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Mar 30 2022 06:49:08 GMT-0700 (Pacific Daylight Time)">13:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">so for the instantiate Module overload, wouldn't that be unreachable because we disallow creating Modules?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Mar 30 2022 06:49:21 GMT-0700 (Pacific Daylight Time)">13:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">what is the difference between indexedDB and being serializable?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Mar 30 2022 06:54:38 GMT-0700 (Pacific Daylight Time)">13:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">MDN also points to <a href="https://github.com/WebAssembly/spec/issues/821">https://github.com/WebAssembly/spec/issues/821</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Mar 30 2022 06:55:09 GMT-0700 (Pacific Daylight Time)">13:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Good question. There different scopes (at least that is what we call it) for serialization/de-serialization </td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Mar 30 2022 06:57:53 GMT-0700 (Pacific Daylight Time)">13:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">Wasm HTTP caching is using serialization logic (from past indexedDB stuff afaik). The github issue above points that storing wasm module in indexedDB will be duplication of http caching functionality. </td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Mar 30 2022 06:58:33 GMT-0700 (Pacific Daylight Time)">13:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1469395">https://bugzilla.mozilla.org/show_bug.cgi?id=1469395</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Mar 30 2022 06:59:44 GMT-0700 (Pacific Daylight Time)">13:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Seems like something went wrong "Caching article removed from MDN:" </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Mar 30 2022 08:03:51 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: if you would like to Go Down The CHERI Rabbithole, I <em>just</em> like (2 hours ago) landed this design to rust, and it comes with a lot of discussion of CHERI limitations, with lots of people who Actually Work On It chiming in: <a href="https://github.com/rust-lang/rust/issues/95228">https://github.com/rust-lang/rust/issues/95228</a></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Mar 30 2022 08:04:21 GMT-0700 (Pacific Daylight Time)">15:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">the docs haven't hit nightly but i have them mirrored here: <a href="https://docs.rs/sptr/latest/sptr/index.html#strict-provenance">https://docs.rs/sptr/latest/sptr/index.html#strict-provenance</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Mar 30 2022 08:06:07 GMT-0700 (Pacific Daylight Time)">15:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">(gonna do a proper announcement of all this when it hits nightly)</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Mar 30 2022 08:10:46 GMT-0700 (Pacific Daylight Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">one nice thing about Being A Jit is that it's a lot easier for you to adopt platform-specific idioms. part of why I'm so fuzzy about the special platform-specific ops like high-bit-tagging is that I am thinking of "some random person writing some code that happens to get compiled for CHERI" and so it matters a lot more to me "where in the source code=&gt;cpu stack does this trick get applied". i.e. what patterns can i tell people Automagically Work, and which do I need compiler-analysis/intrinsics/apis/tricks for</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Mar 30 2022 08:12:09 GMT-0700 (Pacific Daylight Time)">15:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">a fun one for you folks: the CHERI "intptr_t is just void*" trick partially relies on the compiler trying to guess which two values in a binary op (lhs + rhs) is the "real" pointer that provenance should derive from :x</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Mar 30 2022 08:30:38 GMT-0700 (Pacific Daylight Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Gankra [she/they]</span>: So pointers on CHERI are necessarily 128 bit? That is definitely an awkward fit with our value representation, which relies on the ability to hide a pointer inside a double</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Mar 30 2022 08:33:17 GMT-0700 (Pacific Daylight Time)">15:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">yes, but it's a 64-bit address space still.  one possible solution is to take the "it's all array indexing" solution to its logical limit and basically have all JIT memory in one big "allocation" that you logically subdivide (gee i wonder if spidermonkey implements its own allocator <em>eye roll</em>) and then have all "pointers" be offsets you apply to a pointer to the Big Allocation</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Mar 30 2022 08:36:04 GMT-0700 (Pacific Daylight Time)">15:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right now we have the ability to hide arbitrary pointers in a Value: <a href="https://searchfox.org/mozilla-central/source/js/public/Value.h#1117">https://searchfox.org/mozilla-central/source/js/public/Value.h#1117</a></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Mar 30 2022 08:37:13 GMT-0700 (Pacific Daylight Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">They don't have to be managed by the GC; for example, if you're implementing Map, it might have a reserved (~hidden) slot containing a pointer to a malloc-allocated buffer</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Mar 30 2022 08:38:33 GMT-0700 (Pacific Daylight Time)">15:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(<a href="https://searchfox.org/mozilla-central/source/js/src/builtin/MapObject.cpp#695">https://searchfox.org/mozilla-central/source/js/src/builtin/MapObject.cpp#695</a>)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Mar 30 2022 08:43:31 GMT-0700 (Pacific Daylight Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">hmm, anything more fancy than what I suggested is definitely "ask the CHERI folks" for now.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Mar 30 2022 08:43:49 GMT-0700 (Pacific Daylight Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There's always the nuclear option of 16-byte Value on CHERI, which would be a lot of work (8-byte Value is pretty heavily baked into the engine) but is at least theoretically possible</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Mar 30 2022 08:45:51 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Slightly less nuclear would be to go with your earlier suggestion, and implement private values as a pointer to a GC allocation that stores the full pointer</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Mar 30 2022 08:47:15 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">I believe CHERI also has a "nuclear winter" option of extending that hack to the whole process</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Mar 30 2022 08:47:56 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">which is basically "why did you bother, but ok it runs"</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Mar 30 2022 08:49:10 GMT-0700 (Pacific Daylight Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Basically my conclusion here is that CherryMonkey is probably possible, but would be Highly Non-Trivial</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Mar 30 2022 08:50:02 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: there's a GC API question for you to weigh in on in <a href="https://phabricator.services.mozilla.com/D142151">https://phabricator.services.mozilla.com/D142151</a> (I did @ you, but ISTR it's not always sufficient to generate an email)</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Mar 30 2022 08:50:46 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">if i'm being honest i am 50% just using CHERI as a forcing function to make "systems" and "hardware" people concede that pointer provenance is real and to push everyone to write more code in a "of course it works, how could it not" way</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Mar 30 2022 08:53:13 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gankra:mozilla.org">Gankra [she/they]</span>&gt;</div></td><td class="msg-cell">JITs however have a defacto license to commit Crimes Most Foul</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Mar 30 2022 08:53:42 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I should put Crimes Most Foul on my business cards</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Mar 30 2022 08:56:45 GMT-0700 (Pacific Daylight Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: ok. In a meeting now, will look after.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Mar 30 2022 08:57:12 GMT-0700 (Pacific Daylight Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">mgaudet</span>: ok. In a meeting now, will look after.</blockquote></mx-reply>Thanks! No rush!</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Mar 30 2022 09:14:01 GMT-0700 (Pacific Daylight Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is there a bug that tracks <code>for-in</code> with deleted/added properties?  the context is bug 1762188, that I think it's not the first time the behavior is reported.  the spec says it's implementation dependent, but the behavior is different against chrome/safari there</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Mar 30 2022 09:14:02 GMT-0700 (Pacific Daylight Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1762188">https://bugzil.la/1762188</a> — UNCONFIRMED (nobody) — Behavior difference between SpiderMonkey and Chrome/Safari with object enumeration with deleted/added property</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Mar 30 2022 09:16:39 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: looking, but I'm going to have to rinse my eyes with habañero juice to make them feel better after reading this template code. Still working out what this stuff is doing.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Mar 30 2022 09:17:37 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Oh yeah; whole new (to me) kinds of template magic in there. At this point I think I can explain most of it, so if you have questions feel free to ask.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Mar 30 2022 09:19:34 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: The real core of the question is: we would like to expand a parameter pack of a set of JS::Heap&lt;T&gt; into a set of Rooted&lt;T&gt; to be arguments to the call; but without changing this to recursive expansion, the best way is to do it in the arguments. However, JS::Rooted doesn't want to be an argument (argument evaluation order concern?)... JS::Persistent rooted doesn't care the same way though.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Mar 30 2022 09:20:57 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I was just writing up the same comment! Yours was more detailed, though</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Mar 30 2022 10:06:57 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: ok, I kind of get what's going on here, though I'm going to request some comments. The main thing I don't understand is whether there's a way to avoid re-rooting in the first place. I guess it's because it wants to pass in Rooted arguments and the template magic prevents the usual autoconversion to Handle or something?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Mar 30 2022 10:08:24 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Inside the object we've got <code>JS::Heap&lt;T&gt;</code>-- IIRC there's no auto-coversion from <code>JS::Heap</code> to <code>Rooted</code></td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Mar 30 2022 10:08:43 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: though... is this maybe a place were <code>fromMarkedLocation</code> makes sense?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Mar 30 2022 10:09:06 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you mean <code>JS::Heap</code> -&gt; <code>JS::Handle</code></td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Mar 30 2022 10:09:15 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(the object is being traced by the GCC) Erm, yes</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Mar 30 2022 10:09:17 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">thinko</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Mar 30 2022 10:11:42 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm... thinking aloud... if we wanted <code>JS::Heap&lt;T&gt;</code> to magically just work, then it would need to be passing pointers to those T on the stack. Which I guess is what's already happening, given that they're getting <code>Handle&lt;T&gt;</code> right now? I need to look to see what's receiving this stuff.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Mar 30 2022 10:13:09 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">if you look at the next patch on the stack, you'll see an example use of this</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Mar 30 2022 10:13:20 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">it's getting passed to a callback lambda </td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Mar 30 2022 10:21:05 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: hrm. It still seems like it's already getting passed as a <code>Handle</code>. I don't see an example (in that patch, at least) of a <code>JS::Heap</code> being passed in.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Mar 30 2022 10:21:43 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">what I'm getting at is that it seems like the usual rule when you want to pass in a <code>JS::Heap&lt;T&gt;</code> is that you stick it in a <code>Rooted</code> before passing it in, and I'm not seeing why that shouldn't be the same thing here.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Mar 30 2022 10:22:10 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><em>unless</em> the template trickery makes that harder than usual because <code>Rooted</code> can't autoconvert to <code>Handle</code> like it usually would.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Mar 30 2022 10:22:13 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">which is believable</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Mar 30 2022 10:24:50 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: So the native handler stores it as a <code>JS::Heap</code> object  and traces it, holding it alive until the callback runs. Then, when the callback runs, it expects a handle. So we need the Heap to be exposed as Handle for calling the callback function. The problem is is that it's unclear how to unfold the compile time list of Heaps into a set of Rooteds and then pass those Rooteds (ideally, without doing recursive template expansion). The original stab at this is to expand that list into a set of Rooteds using the fold operator <code>...</code>  in the parameter list -- but that's blocked by MOZ_RAII</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Mar 30 2022 10:25:38 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">the current patch does the same, but with PersistentRooted</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Mar 30 2022 10:26:00 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I suppose we could use <code>::FromMarkedLocation</code> though, because these are already being traced by the handler though...</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Mar 30 2022 10:26:02 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">right?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Mar 30 2022 10:26:10 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Oh! I understood the latter part, and I believe <code>PersistentRooted</code> is the right answer to that. The first part I guess I didn't follow. Lemme look again.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Mar 30 2022 10:27:14 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, via <code>StorageTypeHelper</code>. Ok.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Mar 30 2022 10:27:41 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(Clarifying slightly: Handler has a <em>list</em> of JS::Heaps, the list being compile time determined type wise and traced)</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Mar 30 2022 10:29:46 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">right. Well, <code>std::tuple&lt;StorageType&lt;JSArgs&gt;...&gt;</code> which is <code>std::tuple&lt;JS::Heap&lt;T&gt;...&gt;</code> or whatever.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Mar 30 2022 10:30:25 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, I'm ok with this using <code>PersistentRooted</code>, but conceptually it would make a little more sense to me if it used <code>fromMarkedLocation</code>.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Mar 30 2022 10:30:51 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Since it goes to the effort of marking those locations, in a way it's a weird form of documentation.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Mar 30 2022 10:32:28 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">unless, that is, I'm still confusing myself and the <code>std::get</code> isn't just getting a <code>Handle</code> back. But I <em>think</em> that's all that's going on.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Mar 30 2022 10:35:30 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">yeah, I think that's the right read. Ok. Thanks! </td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Mar 30 2022 10:36:46 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I have it written up as a comment that I'll post in a minute, but one more question</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Mar 30 2022 10:37:30 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">do you understand why <code>std::index_sequence_for</code> is needed? As in, why there isn't a way to just pass the whole sequence? It might be because it gives some type conversion by extracting one at a time with <code>std::get</code>, but I'm not sure.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Mar 30 2022 10:41:41 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, posted</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Mar 30 2022 10:47:48 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: I thought I understood yesterday... but that was based on having a single list; now that I am not so sure.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Mar 30 2022 10:49:40 GMT-0700 (Pacific Daylight Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. maybe it's not needed; I'll ask </td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Mar 30 2022 10:53:30 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it probably is, I'm mostly just curious</td></tr>

</tbody></table></div></div></div>
</body></html>