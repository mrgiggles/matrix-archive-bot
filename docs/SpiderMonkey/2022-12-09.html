<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-12-09</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-12-09<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-12-08" class="nav-link"><span>prev</span></a>
<a href="2022-12-11" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Dec 08 2022 16:14:17 GMT-0800 (Pacific Standard Time)">00:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: <a href="https://searchfox.org/mozilla-central/source/js/src/jsapi-tests/testGCHeapBarriers.cpp#107">this</a> is the last use of I have of the AutoSuppressNurseryCellAlloc. I'm wondering if you have any good ideas how to get rid of it? For other cases we cared about strings which already had APIs to pass <code>gc::InitialHeap::TenuredHeap</code>, but we don't really have that for typed arrays.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Dec 08 2022 16:16:03 GMT-0800 (Pacific Standard Time)">00:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The only TypedArray creation APIs seem to be going through JSAPI which avoids concept of gc::InitialHeap as well. I could just add an internal API to create a typedarray that takes an InitialHeap but wondering if there is something else that might work</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Dec 08 2022 16:19:29 GMT-0800 (Pacific Standard Time)">00:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I guess there are a few internal APIs already for JITs so maybe it isn't bad to add another one <a href="https://searchfox.org/mozilla-central/rev/9423bbd90c59ef7739c8453c265d04d8cf07ce73/js/src/vm/TypedArrayObject.h#167-175">https://searchfox.org/mozilla-central/rev/9423bbd90c59ef7739c8453c265d04d8cf07ce73/js/src/vm/TypedArrayObject.h#167-175</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Dec 08 2022 16:33:44 GMT-0800 (Pacific Standard Time)">00:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I'll just add the one internal API with a gc::InitialHeap argument. It seems less sketchy than the nursery-suppress mechanism anyways and then I can remove a bunch of junk from string allocation paths</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Dec 08 2022 16:38:32 GMT-0800 (Pacific Standard Time)">00:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">This lets me remove a bunch of mostly dead code from the string allocation code <a href="https://searchfox.org/mozilla-central/rev/9423bbd90c59ef7739c8453c265d04d8cf07ce73/js/src/gc/Allocator.cpp#205-212">https://searchfox.org/mozilla-central/rev/9423bbd90c59ef7739c8453c265d04d8cf07ce73/js/src/gc/Allocator.cpp#205-212</a></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Dec 08 2022 16:44:20 GMT-0800 (Pacific Standard Time)">00:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">There are so many layers from <code>substring</code> through the engine. Trying to finally untangle some of them..</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Dec 09 2022 07:09:15 GMT-0800 (Pacific Standard Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: here's the semispace bug I mentioned in the meeting on Wednesday, maybe something useful in there: bug 1008473</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Dec 09 2022 07:09:17 GMT-0800 (Pacific Standard Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1008473">https://bugzil.la/1008473</a> — RESOLVED (jonco) — Implement a two-generation nursery</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Dec 09 2022 09:12:45 GMT-0800 (Pacific Standard Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: I saw that, thanks. I'll take a look. Though I'm buried pretty deep in hazard-land at the moment.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Dec 09 2022 09:13:51 GMT-0800 (Pacific Standard Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: I feel like we're slowing moving toward plumbing the heap parameter through everything. I'm not sure if that's a good thing or not. <span class="nick-4">jonco</span> ?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Dec 09 2022 09:15:26 GMT-0800 (Pacific Standard Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: what do you mean?  probably not a good idea</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Dec 09 2022 09:16:35 GMT-0800 (Pacific Standard Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">oh you mean gc::InitialHeap?  I thought you meant passing references to Heap&lt;T&gt;.  Yeah, passing InitialHeap is fine as long as it doesn't muddy the APIs and we have something sensible to pass it</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Dec 09 2022 09:19:10 GMT-0800 (Pacific Standard Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: there is the patch <a href="https://phabricator.services.mozilla.com/D164301">https://phabricator.services.mozilla.com/D164301</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Dec 09 2022 09:24:37 GMT-0800 (Pacific Standard Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I don't love passing the extra parameter through everywhere, but it's OK if we need to do this.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Dec 09 2022 09:25:39 GMT-0800 (Pacific Standard Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">The test consumer of the API is there to help fuzzers find problems though.  It would be good to keep that I think.  sfink do you know if JSString::fillWithRepresentatives actaully did catch anything?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Dec 09 2022 09:26:04 GMT-0800 (Pacific Standard Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">heh, I was just contemplating that question in reviewing <a href="https://phabricator.services.mozilla.com/D164299">https://phabricator.services.mozilla.com/D164299</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Dec 09 2022 09:26:45 GMT-0800 (Pacific Standard Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the quick answer to your question is that tcampbell is maintaining that API</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Dec 09 2022 09:27:02 GMT-0800 (Pacific Standard Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I don't actually know whether it has caught anything</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Dec 09 2022 09:27:30 GMT-0800 (Pacific Standard Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I know it was a little bit of a pain to add in the nursery stuff there</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Dec 09 2022 09:28:08 GMT-0800 (Pacific Standard Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">doesn't appear in any test cases, so I guess no</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Dec 09 2022 09:28:10 GMT-0800 (Pacific Standard Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(I think I added the heap parameter to the string stuff later?)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Dec 09 2022 09:28:27 GMT-0800 (Pacific Standard Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">most string creation APIs take InitialHeap already so perhaps could be written to use that</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Dec 09 2022 09:28:47 GMT-0800 (Pacific Standard Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">that would make sense</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Dec 09 2022 09:29:36 GMT-0800 (Pacific Standard Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that's what the patch does</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Dec 09 2022 09:29:44 GMT-0800 (Pacific Standard Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">there are 2 jit-tests that use it</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Dec 09 2022 09:30:16 GMT-0800 (Pacific Standard Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but no regression tests have appeared with it, which argues that it's not that important for fuzzing</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Dec 09 2022 09:31:05 GMT-0800 (Pacific Standard Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I still think it's good to have some way of exposing these things to fuzzers</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Dec 09 2022 09:31:40 GMT-0800 (Pacific Standard Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">What I really want to figure out is if I can avoid JSDependentString::new_ from calling allocation with NoGC and then CanGC versions just to avoid a single root</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Dec 09 2022 09:33:47 GMT-0800 (Pacific Standard Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">oops.. that was definitely supposed to be TenuredHeap. I checked in my test-that-the-wrong-thing-fails-tests version instead :(</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Dec 09 2022 09:35:40 GMT-0800 (Pacific Standard Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Yes it may be better just to root. People were very worried about regressing perf when adding rooting, however it was necessary to avoid roots in some places.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Dec 09 2022 09:40:25 GMT-0800 (Pacific Standard Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh wow, bug 1804936 makes a good point.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Dec 09 2022 09:40:26 GMT-0800 (Pacific Standard Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1804936">https://bugzil.la/1804936</a> — ASSIGNED (jonco) — ZoneData still exists even though we removed the concept of zone exclusive access</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Dec 09 2022 09:41:02 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Rename it to ZombieData then?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Dec 09 2022 09:46:03 GMT-0800 (Pacific Standard Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">off-thread parsing, the feature that can never die</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Dec 09 2022 09:48:39 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">so many vestiges left..</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Dec 09 2022 10:03:53 GMT-0800 (Pacific Standard Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I have a question about the various JS_GetObjectAs***Array functions (<a href="https://searchfox.org/mozilla-esr68/source/js/src/jsfriendapi.h#1709">https://searchfox.org/mozilla-esr68/source/js/src/jsfriendapi.h#1709</a>)</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Dec 09 2022 10:05:04 GMT-0800 (Pacific Standard Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>The documentation isn't completely clear on exactly what it's checking.</p>
<ol>
<li>Does it check whether the object <em>is</em> of the specified type, or if it can be <em>viewed</em> as the specified type, and what's the difference?</li>
<li>On success, is the parameter obj always returned directly, or is there sometimes a conversion?</li>
</ol>
</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Dec 09 2022 10:21:44 GMT-0800 (Pacific Standard Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, the terminology is sloppy. There's no conversion. The only variation allowed is that they will unwrap cross-compartment wrappers. So you have to pass in either an object of exactly the right kind of typed array, or a cross-compartment wrapper to one.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Dec 09 2022 11:55:46 GMT-0800 (Pacific Standard Time)">19:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">woah.. removing the nogc call for strings and directly calling gc version is noticeably faster. I guess stuff really doesn't optimize away as well as we might want</td></tr>

</tbody></table></div></div></div>
</body></html>