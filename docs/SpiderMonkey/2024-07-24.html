<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-07-24</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-07-24<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-07-23" class="nav-link"><span>prev</span></a>
<a href="2024-07-25" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Jul 24 2024 01:17:31 GMT-0700 (Pacific Daylight Time)">08:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">these are likely short strings (probably even inline JS strings) and string buffers are currently only used for long JS strings (&gt; about 512 bytes now but this could be lowered)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Jul 24 2024 01:19:36 GMT-0700 (Pacific Daylight Time)">08:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the bindings code is converting the JS string to a UTF8 string in that profile. Maybe we could optimize this better to avoid the Latin1 =&gt; UTF8 conversion in common cases?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Jul 24 2024 01:21:16 GMT-0700 (Pacific Daylight Time)">08:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">ideally we'd also be able to share the atom representation, or at least have fast conversions between JSAtom and nsAtom</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Jul 24 2024 01:25:17 GMT-0700 (Pacific Daylight Time)">08:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">Is there a correct way to include mozilla::SIMD into libjs_static? I've not done much with <code>MFBT_API</code> before so not sure what I should do here</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Jul 24 2024 01:30:58 GMT-0700 (Pacific Daylight Time)">08:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">which version?  I see<code>mozilla::SIMD::memchr</code> etc defined in <code>libjs_static.a</code> in 115.1.0</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Jul 24 2024 01:35:23 GMT-0700 (Pacific Daylight Time)">08:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">124.0.2</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Jul 24 2024 01:36:18 GMT-0700 (Pacific Daylight Time)">08:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, let me test locally with that version.  btw, how do you observe the issue?  do you get linker error or something?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jul 24 2024 01:36:33 GMT-0700 (Pacific Daylight Time)">08:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">yes linker error is what I see</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jul 24 2024 01:36:45 GMT-0700 (Pacific Daylight Time)">08:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">I'll rebuild and post the error if that would help</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jul 24 2024 01:38:35 GMT-0700 (Pacific Daylight Time)">08:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, it would be better looking into the actual error and see how it goes wrong</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jul 24 2024 02:24:03 GMT-0700 (Pacific Daylight Time)">09:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-15">arai</span>: here is the error i see:</p>
<pre><code>wasm-ld: error: /Users/jakechampion/Code/js-compute-runtime/runtime/spidermonkey/release/lib/libjs_static.a(Unified_cpp_js_src0.o): undefined symbol: mozilla::SIMD::memchr64(unsigned long long const*, unsigned long long, unsigned long)
</code></pre>
</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jul 24 2024 02:24:44 GMT-0700 (Pacific Daylight Time)">09:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><p>If useful, this is the mozconfig used:</p>
<pre><code>ac_add_options --enable-project=js
ac_add_options --enable-application=js
ac_add_options --target=wasm32-unknown-wasi
ac_add_options --without-system-zlib
ac_add_options --without-intl-api
ac_add_options --disable-jit
ac_add_options --disable-shared-js
ac_add_options --disable-shared-memory
ac_add_options --disable-tests
ac_add_options --disable-clang-plugin
ac_add_options --enable-jitspew
ac_add_options --enable-optimize=-O3
ac_add_options --enable-portable-baseline-interp
ac_add_options --prefix=/Users/jakechampion/Code/js-compute-runtime/runtime/spidermonkey/obj-release/dist
mk_add_options MOZ_OBJDIR=/Users/jakechampion/Code/js-compute-runtime/runtime/spidermonkey/obj-release
mk_add_options AUTOCLOBBER=1
ac_add_options --host=aarch64-apple-darwin
ac_add_options --disable-debug
</code></pre>
</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jul 24 2024 02:34:35 GMT-0700 (Pacific Daylight Time)">09:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, so you're targetting wasm?  then the situation would be really different</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jul 24 2024 02:35:39 GMT-0700 (Pacific Daylight Time)">09:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">at least in the m-c, <a href="https://searchfox.org/mozilla-central/source/mozglue/misc/SIMD.cpp#37">it's guarded with MOZILLA_PRESUME_SSE2</a></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jul 24 2024 02:40:26 GMT-0700 (Pacific Daylight Time)">09:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">Thank you, that's a good place for me to start looking into 🙇</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jul 24 2024 02:50:55 GMT-0700 (Pacific Daylight Time)">09:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">I think there is an #else block which also implements them as a fallback 
<a href="https://searchfox.org/mozilla-central/source/mozglue/misc/SIMD.cpp#505-527">https://searchfox.org/mozilla-central/source/mozglue/misc/SIMD.cpp#505-527</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Jul 24 2024 03:02:35 GMT-0700 (Pacific Daylight Time)">10:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, good point</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Jul 24 2024 03:04:26 GMT-0700 (Pacific Daylight Time)">10:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">just to make sure, when (or, for which command) do you hit the error?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jul 24 2024 03:04:37 GMT-0700 (Pacific Daylight Time)">10:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm building locally with the same config</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jul 24 2024 03:06:28 GMT-0700 (Pacific Daylight Time)">10:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><code>./mach build</code> works but then trying to use the built files in an embedding fails</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jul 24 2024 03:07:12 GMT-0700 (Pacific Daylight Time)">10:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">The embedding is Fastly's JS Compute Runtime <a href="https://github.com/fastly/js-compute-runtime/">https://github.com/fastly/js-compute-runtime/</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jul 24 2024 03:09:05 GMT-0700 (Pacific Daylight Time)">10:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, yeah, I don't see these functions defined in <code>libjs_static.a</code> file with the configuration.  let's see what happened</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jul 24 2024 03:11:46 GMT-0700 (Pacific Daylight Time)">10:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">at least defined in <code>OBJDIR/mozglue/misc/SIMD.o</code></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jul 24 2024 03:25:40 GMT-0700 (Pacific Daylight Time)">10:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: If you have a list of bug to revisit for inlining decision, feel free to create a meta-bug for it and mark all other bugs in this list as blockers of this meta bug ;)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jul 24 2024 03:27:07 GMT-0700 (Pacific Daylight Time)">10:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">I think you have just solved it for me, thank you so much <span class="nick-15">arai</span> ✨</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jul 24 2024 03:27:08 GMT-0700 (Pacific Daylight Time)">10:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>OBJDIR/js/src/build/libjs_static.a</code> contains <code>00000001 T _ZN7mozilla4SIMD7memchr8EPKccm</code> etc if I comment out <code>ac_add_options --disable-shared-js</code> option. but then the <code>./mach build</code> fails with <code>wasm-ld: error: cannot open <a href="http://libmozjs-124.so">libmozjs-124.so</a>: No such file or directory</code></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jul 24 2024 03:28:01 GMT-0700 (Pacific Daylight Time)">10:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">We can use the <code>OBJDIR/mozglue/misc/SIMD.o</code> 👍️ I didn't realise it was there</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jul 24 2024 03:28:03 GMT-0700 (Pacific Daylight Time)">10:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think there was some issue around the option, and there's still some issue around which files to include into the library?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Jul 24 2024 03:28:25 GMT-0700 (Pacific Daylight Time)">10:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1588340">https://bugzilla.mozilla.org/show_bug.cgi?id=1588340</a> may have some info</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Jul 24 2024 05:52:26 GMT-0700 (Pacific Daylight Time)">12:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">jakechampion</span>: are you using Intl-enabled builds everywhere now? I wonder if it's time to retire <code>--without-intl-api</code></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Jul 24 2024 05:53:36 GMT-0700 (Pacific Daylight Time)">12:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">@jandem our thinking for the short/near term is to default to without intl, letting customers decide whether to include intl or not with a cli flag 

this is because it increases the min heap memory used</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Jul 24 2024 05:54:31 GMT-0700 (Pacific Daylight Time)">12:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">We're thinking of how to make the intl data go into a data section in wasm and lazy-load it on first use, as a way to mitigate the min heap size increase for customers who don't use intl</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Jul 24 2024 05:58:28 GMT-0700 (Pacific Daylight Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">makes sense. In that case we can keep this configuration :) I'm wondering now how it affects the (compressed) js.wasm file size, I'll check</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Jul 24 2024 05:58:45 GMT-0700 (Pacific Daylight Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">the min heap goes from ~7MB to ~26MB</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Jul 24 2024 05:59:34 GMT-0700 (Pacific Daylight Time)">12:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">that is a significant difference</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Jul 24 2024 06:01:36 GMT-0700 (Pacific Daylight Time)">13:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I wonder, some functions have fallback implementation for without-intl config.  are they used?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Jul 24 2024 06:03:00 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/b3c85ac11d004fdb582577cd8f674efa44b0e253/js/src/builtin/String.cpp#3923-3931">examples</a></td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Jul 24 2024 06:04:55 GMT-0700 (Pacific Daylight Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if without-intl configuration is used with code that doesn't actually handle any locale-sensitive things, we could remove those fallbacks?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Jul 24 2024 08:36:09 GMT-0700 (Pacific Daylight Time)">15:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-4">iain</span>: The design for allocSites for DOM Wrappers you wrote up here sounds fine in broad strokes, Trying to firm up the design in my head: Should we express the 'null out the alloc site' as a CacheIR op that gets slotted after the call but before the returnFromIC (I don't know how often we've done that so not sure this is a well supported CacheIR configuration?</p>
<p>Or should all calls generally remove the cx alloc site on return?</p>
</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Jul 24 2024 08:44:30 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">sorry </td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Jul 24 2024 08:44:33 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">here being <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1892764">https://bugzilla.mozilla.org/show_bug.cgi?id=1892764</a> </td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Jul 24 2024 08:44:34 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I think I was envisioning a separate call op that handled the slot setting/clearing internally. Vaguely similar to what we do <a href="https://searchfox.org/mozilla-central/source/js/src/jit/BaselineCacheIRCompiler.cpp#3659-3662">here</a>, except with a step after we return</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Jul 24 2024 08:44:39 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">as I realize I didn't link :P </td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Jul 24 2024 08:45:12 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In general we don't usually have CacheIR ops other than ReturnFromIC after the effectful op.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Jul 24 2024 08:46:02 GMT-0700 (Pacific Daylight Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(And I kind of think we should eventually just remove ReturnFromIC; it made sense back in the day when some ICs ended with a type barrier, but now it's just repetitive boilerplate)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Jul 24 2024 08:47:07 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">oh! I hadn't spotted callDOMFunction yet... </td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Jul 24 2024 08:47:08 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span></div></td><td class="msg-cell">traces</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Jul 24 2024 08:47:09 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I haven't thought it through clearly, but my intuition is that we want to null the slot out as soon as we return, so that we do the right thing if an exception is thrown</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Jul 24 2024 08:50:41 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">makes sense. Do we -only- want this for 'callDOMFunction', or do we want this for the more general case of <code>callNativeFunction</code>, of which DOM functions will be a more specific subset? (I'm not 100% sure what ends up matching the <a href="https://searchfox.org/mozilla-central/source/js/src/jit/CacheIR.cpp#1029">CanAttachDomCall predicate</a> in practice)</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Jul 24 2024 08:54:19 GMT-0700 (Pacific Daylight Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think we want this in cases where we know we're calling a specific DOM function (among other things because we apparently want to know whether we expect it to return an object), so probably <code>callDOMFunction</code>, or a variant thereof, is the right place to put this?</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Jul 24 2024 08:59:15 GMT-0700 (Pacific Daylight Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. I shall continue to cogitate .</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Jul 24 2024 12:19:33 GMT-0700 (Pacific Daylight Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">the <code>JSJitInfo</code> should mostly allow you to know if the function returns an object</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Jul 24 2024 12:20:21 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Thanks :) I found that a few minutes after asking :P </td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Jul 24 2024 12:20:51 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">it won't catch all cases, unions are one example</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Jul 24 2024 12:22:06 GMT-0700 (Pacific Daylight Time)">19:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">or nullable types</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Jul 24 2024 12:43:32 GMT-0700 (Pacific Daylight Time)">19:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Hello everyone.  I have something interesting: a question that's not about the garbage collector!

I know that code for a JS context will always execute in a single thread, but is there any way to abort the execution of JS code that is currently in progress?

We may have a large number of scripts scheduled to run in our system, and we want to detect if one of them may be stuck, and to cancel it.

Is there a safe way to do that?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Jul 24 2024 12:45:38 GMT-0700 (Pacific Daylight Time)">19:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">yes, firefox has machinery for this, but I don't know how to use it in an embedding off the top of my head</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Jul 24 2024 12:49:07 GMT-0700 (Pacific Daylight Time)">19:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">JS_RequestInterruptCallback and the Interrupt callbacks IIRC</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Jul 24 2024 12:49:53 GMT-0700 (Pacific Daylight Time)">19:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Could this potentially leave the JS context in a bad state?  (I know the script could potentially be in a bad state, but we're cancelling it anyway, so it shouldn't matter)</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Jul 24 2024 12:50:55 GMT-0700 (Pacific Daylight Time)">19:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Interrupts work by effectively throwing an uncatchable exception.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Jul 24 2024 12:52:45 GMT-0700 (Pacific Daylight Time)">19:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">So would that mess up the whole context?  We have a single context with many scripts, and one global per script, and we enter/exit realms for each global.  Would the other scripts also be terminated if this happened?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Jul 24 2024 12:56:37 GMT-0700 (Pacific Daylight Time)">19:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">This is effectively the mechanism used by the slow-script dialog; I would say that while the object graph is still fine, user-code expectations may be violated as code invariants will not have been maintained</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Jul 24 2024 12:56:49 GMT-0700 (Pacific Daylight Time)">19:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(ie, any cleanup in catch blocks will not have run)</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Jul 24 2024 12:57:23 GMT-0700 (Pacific Daylight Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">the impact of this will vary from embedding to embedding. I think if we stop script on a page, I don't think we run any more (but I'm not certain about this) </td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Jul 24 2024 12:57:46 GMT-0700 (Pacific Daylight Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK.  I will look into it further.  Thanks.  I'm not sure we will need it, though.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Jul 24 2024 13:22:12 GMT-0700 (Pacific Daylight Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I know it's about 8 hours too late: But here's a dumb idea: `MMasmLambda::New([](MacroAssembler&amp; masm) { <a href="http://masm.foo">masm.foo</a>(); <a href="http://masm.bar">masm.bar</a>(); }]) -- This avoids all the boilerplate of wiring through a MIR node which is ultimately responsible solely for calling a pair of masm functions.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Jul 24 2024 13:26:48 GMT-0700 (Pacific Daylight Time)">20:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(I say this as a look down the barrel of having to add a full MIR and LIR node to emit two lines of masm) </td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Jul 24 2024 13:56:27 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">confession: Work on <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1892764">adding AllocSites for DOM wrappers</a> is coming along reasonably well thus far -- scaffolding in place; next up <a href="http://codegen.py">codegen.py</a> (I think? We'll see tomorrow)</td></tr>

</tbody></table></div></div></div>
</body></html>