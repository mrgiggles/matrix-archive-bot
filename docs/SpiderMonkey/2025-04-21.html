<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-04-21</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-04-21<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-04-18" class="nav-link"><span>prev</span></a>
<a href="2025-04-22" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Apr 21 2025 04:29:39 GMT-0700 (Pacific Daylight Time)">11:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">Hi, are there examples where embedding are performing background work on a different thread and serializing data back to the main JS thread? I saw the <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr115/examples/worker.cpp">worker</a> example, but that appears to just have multiple threads independently running in different contexts.   I'd like to return a Promise from a method defined in the global scope, and have it resolved based on the result of running a std::thread</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Apr 21 2025 04:43:49 GMT-0700 (Pacific Daylight Time)">11:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">afaik there's no simple example.  similar thing is done inside the engine and also in Gecko.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Apr 21 2025 04:45:18 GMT-0700 (Pacific Daylight Time)">11:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>Basically, you need to do the following:</p>
<ol>
<li>create a promise in the main thread and return it to the caller</li>
<li>spawn a threaded task, with the reference to the promise object</li>
<li>perform the task</li>
<li>notify the main thread, with the promise object's reference and the result value</li>
<li>resolve the promise with the result value <em>in the main thread</em></li>
</ol>
</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Apr 21 2025 04:46:14 GMT-0700 (Pacific Daylight Time)">11:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the important thing is that you need to resolve the promise (<code>JS::ResolvePromise</code>) on the thread where there it has access to the JSContext for the promise object</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Apr 21 2025 04:48:22 GMT-0700 (Pacific Daylight Time)">11:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">yeah, I'm having trouble figuring out that last step (#5).  I can't just call <code>JS::ResolvePromise</code> on the background thread because I can't do things like allocate new values to resolve the promise with.  It's not immediately clear to me how to signal to the main thread that we're ready for it to learn about the result</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Apr 21 2025 04:48:46 GMT-0700 (Pacific Daylight Time)">11:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it totally depends on how your main thread works</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Apr 21 2025 04:48:54 GMT-0700 (Pacific Daylight Time)">11:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and not something specific to SpiderMonkey</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Apr 21 2025 04:49:14 GMT-0700 (Pacific Daylight Time)">11:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if your main thread has a task queue, dispatching a task from the background thread would be the way to go</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Apr 21 2025 04:49:37 GMT-0700 (Pacific Daylight Time)">11:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the main thread has some messaging port, or some kind of communication channel, sending a message there would do</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Apr 21 2025 04:50:08 GMT-0700 (Pacific Daylight Time)">11:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">presently our embedding is using the internal job queue, should I be investigating a custom JobQueue?  Our embedding is basically a synchronous REPL today</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Apr 21 2025 04:50:46 GMT-0700 (Pacific Daylight Time)">11:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">by  "internal job queue", you mean the SpiderMonkey's job queue ?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Apr 21 2025 04:52:07 GMT-0700 (Pacific Daylight Time)">11:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">yes, by calling <code>js::UseInternalJobQueues</code></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Apr 21 2025 04:52:18 GMT-0700 (Pacific Daylight Time)">11:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, you call <code>js::RunJobs</code> ?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Apr 21 2025 04:53:45 GMT-0700 (Pacific Daylight Time)">11:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">yes, but not very robustly. It looks to me like its called effectively after each execution of a REPL entry</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Apr 21 2025 04:55:21 GMT-0700 (Pacific Daylight Time)">11:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">for example you can add communication between the threads after the call</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Apr 21 2025 04:56:05 GMT-0700 (Pacific Daylight Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and if it results in resolving a promise, that can enqueue a job, and then you can run jobs again</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Apr 21 2025 04:56:44 GMT-0700 (Pacific Daylight Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">Is there a better design here though? What if there isn't REPL input for some time after the last call, and the background task completes</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Apr 21 2025 04:57:17 GMT-0700 (Pacific Daylight Time)">11:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what do you want to happen in that case?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Apr 21 2025 04:59:01 GMT-0700 (Pacific Daylight Time)">11:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">For example, in a node repl you might write:</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Apr 21 2025 05:00:59 GMT-0700 (Pacific Daylight Time)">12:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell"><pre><code>function asyncTimeout() { return new Promise((resolve, reject) =&gt; setTimeout(resolve, 10)); }
asyncTimeout().then(res =&gt; console.log(res));
</code></pre>
<p>and it will eventually run the <code>console.log</code> without me writing another line into the repl</p>
</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Apr 21 2025 05:01:48 GMT-0700 (Pacific Daylight Time)">12:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">so maybe the minimal test case here is me trying to implement that in a SpiderMonkey repl?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Apr 21 2025 05:05:44 GMT-0700 (Pacific Daylight Time)">12:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>if that's what you want, then the possible design would be:</p>
<ul>
<li>Split out the REPL's "read" part out of the main thread, or at least make it non-blocking</li>
<li>let the main thread have a task queue</li>
<li>the task queue runs each task one by one, and runs jobs at the end of task (which would map to the HTML's microtask checkpoint)</li>
<li>if user input happens, dispatch a task for "evaluate the user input"</li>
<li>if the background thread finishes, dispatch a task for "resolve the promise"</li>
</ul>
</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Apr 21 2025 05:06:42 GMT-0700 (Pacific Daylight Time)">12:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the task queue could wait on condition variable if the queue becomes empty, and dispatching a task can notify it</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Apr 21 2025 05:11:04 GMT-0700 (Pacific Daylight Time)">12:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">ok, and is the task queue you mention meant to be a <a href="https://searchfox.org/mozilla-central/source/js/public/Promise.h#34">JS::JobQueue</a>? Or is that a separate concept</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Apr 21 2025 05:11:10 GMT-0700 (Pacific Daylight Time)">12:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">see <a href="https://html.spec.whatwg.org/#perform-a-microtask-checkpoint">https://html.spec.whatwg.org/#perform-a-microtask-checkpoint</a> for microtask checkpoint.  the "microtask" mentione there is the almost same thing as "job"</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Apr 21 2025 05:11:19 GMT-0700 (Pacific Daylight Time)">12:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">separate thing than job queue</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Apr 21 2025 05:11:31 GMT-0700 (Pacific Daylight Time)">12:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">job queue maps to the microtask queue</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Apr 21 2025 05:13:15 GMT-0700 (Pacific Daylight Time)">12:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, basically, the main thread will do: run single task, run all microtasks, run single task, run all microtasks, ...</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Apr 21 2025 05:14:15 GMT-0700 (Pacific Daylight Time)">12:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, for "evaluate the user input" task, all promise reaction jobs enqueued there are executed at the end of the task, including the reaction jobs enqueued by reaction jobs</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Apr 21 2025 05:15:08 GMT-0700 (Pacific Daylight Time)">12:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">got it, we'd need to make the main loop an event loop, effectively making the repl asynchronous</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Apr 21 2025 05:15:12 GMT-0700 (Pacific Daylight Time)">12:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">for "resolve the promise" task, the task itself will just resolve the promise, and then all reaction jobs enqueued by that are executed after that</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Apr 21 2025 05:15:18 GMT-0700 (Pacific Daylight Time)">12:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Apr 21 2025 05:16:19 GMT-0700 (Pacific Daylight Time)">12:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">and a naive implementation could be that after <code>RunJobs</code> is called, maybe there's a channel where I emplaced some data and the <code>Promise</code> object that should be resolved, and then I can call JS::ResolvePromise there</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Apr 21 2025 05:17:01 GMT-0700 (Pacific Daylight Time)">12:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Apr 21 2025 05:17:06 GMT-0700 (Pacific Daylight Time)">12:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">(a naive implementation of "serializing back to the main thread")</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Apr 21 2025 05:17:21 GMT-0700 (Pacific Daylight Time)">12:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">ok cool, thank you very much that's very useful</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Apr 21 2025 05:38:16 GMT-0700 (Pacific Daylight Time)">12:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">maybe just to clear up some intellectual curiosity, but when would one want to provide their own JS::JobQueue? </td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Apr 21 2025 05:38:54 GMT-0700 (Pacific Daylight Time)">12:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">or: when does using <code>js::UseInternalJobQueues</code> not suffice?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Apr 21 2025 06:44:15 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">for example when you want to enqueue non-promise jobs, or you want to perform more operations before running each promise reaction job</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Apr 21 2025 06:45:34 GMT-0700 (Pacific Daylight Time)">13:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in HTML spec, the promise reaction jobs are subset of microtasks, and there are many kind of microtasks</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon Apr 21 2025 06:45:54 GMT-0700 (Pacific Daylight Time)">13:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if your embedding's system also wants to do similar, then you'll want to implement your own queue</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon Apr 21 2025 06:48:54 GMT-0700 (Pacific Daylight Time)">13:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, it depends on the features the system provides, and also the requirements around the execution order</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon Apr 21 2025 14:49:02 GMT-0700 (Pacific Daylight Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">One of those days of spending a bunch of time writing test after test after test that passes... </td></tr>

</tbody></table></div></div></div>
</body></html>