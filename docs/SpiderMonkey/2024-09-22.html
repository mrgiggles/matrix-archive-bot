<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-09-22</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-09-22<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-09-20" class="nav-link"><span>prev</span></a>
<a href="2024-09-25" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sun Sep 22 2024 01:22:37 GMT-0700 (Pacific Daylight Time)">08:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@kbrecordzz:mozilla.org">kbrecordzz</span>&gt;</div></td><td class="msg-cell">Hey! I have a question about Spidermonkey's parser. When it comes to the "scanning" part of the parser (the one that removes whitespace and creates tokens), is it a very simple or a more complex process? I could imagine that the time spent in the scanner is proportional to the number of characters in the code, like, the scanner goes through each character and does pretty much the same job for each one. Or does it spend more time on examining the semantic meaning of the whole code? If it's the latter, the amount spent in the scanner should depend more on the code's complexity than the code's length, and I'm not sure which way Spidermonkey's parser works.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sun Sep 22 2024 01:40:12 GMT-0700 (Pacific Daylight Time)">08:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">kbrecordzz</span>: in most case the parsing is done in single-pass, with a lookahead buffer with 2 tokens, so it's mostly proportional to the code length.  There are some case where the parser rewinds the tokenizer's state.  One is the arrow function, where the parameter part is re-parsed once it hits the arrow token (<code>=&gt;</code>)</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sun Sep 22 2024 01:41:58 GMT-0700 (Pacific Daylight Time)">08:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/f4c888365156e2a4fd08c7b3591857e9cb439087/js/src/frontend/Parser.cpp#10335-10344">this part handles the rewind for the arrow function</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sun Sep 22 2024 01:44:48 GMT-0700 (Pacific Daylight Time)">08:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the other case happens in the optimization to skip generating the AST for inner functions.  When an inner function is found, the parser tries to skip compiling the inner function but instead just apply syntacitc-validation (called syntax-parsing), and defer the compilation until the function gets called.  then, the syntax-parsing is not supported in some cases (e.g. new-ish syntax), and in that case the syntax-parsing is aborted and full-parsing is performed.  that also rewinds the tokenizer's state.  that happens <a href="https://searchfox.org/mozilla-central/rev/f4c888365156e2a4fd08c7b3591857e9cb439087/js/src/frontend/Parser.cpp#3217-3227">here</a></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sun Sep 22 2024 01:46:28 GMT-0700 (Pacific Daylight Time)">08:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the last case is where the function body has a different directive (e.g. "use strict") than the enclosing context, where the parameters need to be re-parsed to apply different early-error rules.  that happens <a href="https://searchfox.org/mozilla-central/rev/f4c888365156e2a4fd08c7b3591857e9cb439087/js/src/frontend/Parser.cpp#3138-3140">here</a></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sun Sep 22 2024 01:51:36 GMT-0700 (Pacific Daylight Time)">08:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, in term of tokenizer, the syntax-parsed inner functions will be re-tokenized when the function is compiled later.  At this point the inner-inner functions are simply skipped with the pre-computed source position, and not re-tokenized. (happens <a href="https://searchfox.org/mozilla-central/rev/f4c888365156e2a4fd08c7b3591857e9cb439087/js/src/frontend/Parser.cpp#3082-3086">here</a>)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sun Sep 22 2024 01:54:05 GMT-0700 (Pacific Daylight Time)">08:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@kbrecordzz:mozilla.org">kbrecordzz</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">kbrecordzz</span>: in most case the parsing is done in single-pass, with a lookahead buffer with 2 tokens, so it's mostly proportional to the code length.  There are some case where the parser rewinds the tokenizer's state.  One is the arrow function, where the parameter part is re-parsed once it hits the arrow token (<code>=&gt;</code>)</blockquote></mx-reply>Thanks for a great explanation. What does this lookahead buffer contain? If parsing is done before tokens are created, how can it have a lookahead buffer containing tokens already?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sun Sep 22 2024 01:55:16 GMT-0700 (Pacific Daylight Time)">08:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, my explanation was obsolete. the lookahead buffer contains 2 or 3 tokens, depending on the build configuration (<a href="https://searchfox.org/mozilla-central/rev/f4c888365156e2a4fd08c7b3591857e9cb439087/js/src/frontend/TokenStream.h#282-285">ref</a>)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sun Sep 22 2024 01:56:29 GMT-0700 (Pacific Daylight Time)">08:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the lookahead buffer contains the tokens that are once gotten and then ungotten when the code doesn't match certain syntax</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sun Sep 22 2024 01:58:28 GMT-0700 (Pacific Daylight Time)">08:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what do you mean with "parsing is done before tokens are created" ?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sun Sep 22 2024 01:59:37 GMT-0700 (Pacific Daylight Time)">08:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">parsing and tokenization are done at the same time.  the parser asks tokenizer (<a href="https://searchfox.org/mozilla-central/rev/f4c888365156e2a4fd08c7b3591857e9cb439087/js/src/frontend/TokenStream.h">TokenStream</a>) to get the next token, and branch based on it and the parser's state</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sun Sep 22 2024 02:00:32 GMT-0700 (Pacific Daylight Time)">09:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@kbrecordzz:mozilla.org">kbrecordzz</span>&gt;</div></td><td class="msg-cell">Okay, I wrongly assumed parsing and tokenization were two completely separate steps.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sun Sep 22 2024 02:01:23 GMT-0700 (Pacific Daylight Time)">09:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe I should've clarified this first.  SpiderMonkey's parser is recursive descent parser.  the parser has methods that mostly corresponds to each AST node, or similar unit</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sun Sep 22 2024 02:04:38 GMT-0700 (Pacific Daylight Time)">09:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the tokenization needs to be done depending on each state, given a certain character sequence can have different meaning depending on the state.  for example, <code>/a/g</code> sequence is a single regexp token if that appears in the context where a literal can appear, but if it appears in the context where only operator can appear, it should be tokenized as "division operator, identifier, division operator, and identifier" tokens</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sun Sep 22 2024 02:08:14 GMT-0700 (Pacific Daylight Time)">09:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and also the tokenizer need to insert a semicolon token (see <a href="https://tc39.es/ecma262/#sec-automatic-semicolon-insertion">https://tc39.es/ecma262/#sec-automatic-semicolon-insertion</a> for more details) depending on the context.  So, the tokenization cannot be performed as a completely separate step than parsing (or at least some kind of semantic analysis)</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sun Sep 22 2024 02:20:21 GMT-0700 (Pacific Daylight Time)">09:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the comment for <a href="https://searchfox.org/mozilla-central/rev/f4c888365156e2a4fd08c7b3591857e9cb439087/js/src/frontend/Token.h#74-128">js::frontend::Token::Modifier</a> explains about the behavior around slash.  parser passes one of those modifiers when getting tokens</td></tr>

</tbody></table></div></div></div>
</body></html>