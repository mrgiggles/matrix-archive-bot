<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-09-10</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-09-10<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-09-09" class="nav-link"><span>prev</span></a>
<a href="2021-09-11" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Sep 10 2021 08:32:59 GMT-0700 (Pacific Daylight Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: are you are resident structured clone expert now?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Sep 10 2021 09:11:37 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">evilpie</span>: yes, for the mechanism. DOM people, mostly baku, handle the DOM types.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Sep 10 2021 09:11:52 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'll be out for at least an hour right now though</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Sep 10 2021 09:45:24 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><p>I just noticed that <code>ToUInt32</code> explicitly disallows BigInts. To coerce from BigInt to Number is using the Number constructor the standard approach?</p>
<pre><code>js&gt; Math.clz32(100)
25
js&gt; Math.clz32(100n)
typein:2:6 TypeError: can't convert BigInt to number
Stack:
  @typein:2:6
js&gt; Math.clz32(Number(100n))
25
</code></pre>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Sep 10 2021 15:10:07 GMT-0700 (Pacific Daylight Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">confession: I have an uncatchable exception triggering a JIT bailout while inside a interrupt callback and am regretting my life choices..</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Sep 10 2021 15:10:11 GMT-0700 (Pacific Daylight Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Sep 10 2021 15:17:11 GMT-0700 (Pacific Daylight Time)">22:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">oh, maybe this actually isn't a terrible bug</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Sep 10 2021 15:18:00 GMT-0700 (Pacific Daylight Time)">22:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I've nearly gotten our exceptions tamed so we no longer accidentally clobber eachother</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Sep 10 2021 15:19:56 GMT-0700 (Pacific Daylight Time)">22:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">My recurring problem with that sort of bug is that you spend 90% of your time fixing the issue, and then another 90% of your time trying to write a reasonable testcase</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Sep 10 2021 15:21:40 GMT-0700 (Pacific Daylight Time)">22:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">in this case I'm adding a new assert that we cannot throw while already throwing, and also asserting that our "uncatchable" return-false-with-no-pending-exception only happens intentionally and not because an OOM was forgotten</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Sep 10 2021 15:22:41 GMT-0700 (Pacific Daylight Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(which oomTest mostly does, but it has a special flag as an escape hatch)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Sep 10 2021 15:23:57 GMT-0700 (Pacific Daylight Time)">22:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">There are only about 20 defects I've found</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Sep 10 2021 15:26:26 GMT-0700 (Pacific Daylight Time)">22:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">the main thing when this is done is that we can change the JSContext throw state to an enum for { Normal, Throwing, OutOfMemory, StackOverflow, Terminate, ForcedReturn }</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Sep 10 2021 15:26:52 GMT-0700 (Pacific Daylight Time)">22:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">where states can be mutually exclusive instead of the current system..</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Sep 10 2021 15:27:20 GMT-0700 (Pacific Daylight Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">also makes it much clearer who can recover from each of these oddball states</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Sep 10 2021 15:27:25 GMT-0700 (Pacific Daylight Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">feels like there should be a DrinkingHeavily or something in there.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Sep 10 2021 15:30:15 GMT-0700 (Pacific Daylight Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I mean, the horror already there, this just is shining some light on places we do bad things on purpose</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Sep 10 2021 15:31:01 GMT-0700 (Pacific Daylight Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">now we just need static analysis to annotate each function with which cx states it may return. and then throw that in searchfox</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Sep 10 2021 15:45:14 GMT-0700 (Pacific Daylight Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">"only about 20 defects that I've found" ðŸ¤”</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Sep 10 2021 15:59:04 GMT-0700 (Pacific Daylight Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: did you really thing we had <em>all</em> the <code>ReportOutOfMemory</code> calls in the right place?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Sep 10 2021 16:08:56 GMT-0700 (Pacific Daylight Time)">23:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">fixed test case. Either I have have a good grasp of what is going on, or I have entirely no idea what is going on.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Sep 10 2021 16:30:28 GMT-0700 (Pacific Daylight Time)">23:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-4">iain</span>: do you recognize this jit code?</p>
<pre><code>   0x000021c41a7edd2f:  int3   
   0x000021c41a7edd30:  sub    $0x30,%rsp
   0x000021c41a7edd34:  mov    %rsp,%rax
   0x000021c41a7edd37:  mov    %rsp,%rcx
   0x000021c41a7edd3a:  and    $0xfffffffffffffff0,%rsp
   0x000021c41a7edd3e:  push   %rcx
   0x000021c41a7edd3f:  sub    $0x8,%rsp
=&gt; 0x000021c41a7edd43:  mov    %rax,%rdi
   0x000021c41a7edd46:  test   $0xf,%spl
   0x000021c41a7edd4a:  je     0x21c41a7edd51
   0x000021c41a7edd50:  int3   
   0x000021c41a7edd51:  callq  0x21c41a7eff30
   0x000021c41a7edd56:  add    $0x8,%rsp
</code></pre>
</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Sep 10 2021 16:30:54 GMT-0700 (Pacific Daylight Time)">23:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I'm not sure what the test to check stack alighnment is about</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Sep 10 2021 16:35:49 GMT-0700 (Pacific Daylight Time)">23:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">looks like <code>assertStackAlignement</code></td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Sep 10 2021 16:36:11 GMT-0700 (Pacific Daylight Time)">23:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you capture it in rr you can use <code>jitsrc 0x000021c41a7edd46</code> to see where we generated that instruction</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Sep 10 2021 16:36:30 GMT-0700 (Pacific Daylight Time)">23:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It certainly looks like it is a call that is asserting that the stack is aligned before we do the actual call</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Sep 10 2021 16:36:53 GMT-0700 (Pacific Daylight Time)">23:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Can't say that I recognize anything else about it</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Sep 10 2021 16:37:24 GMT-0700 (Pacific Daylight Time)">23:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">it is just callWithABI stuff</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Sep 10 2021 16:38:04 GMT-0700 (Pacific Daylight Time)">23:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I was confusing myself. I'm just in the <a href="https://searchfox.org/mozilla-central/rev/1761c710b035d7dc8892dfa8e56589b4e095221f/js/src/jit/x64/MacroAssembler-x64.cpp#450">exception trampoline</a></td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Sep 10 2021 16:42:08 GMT-0700 (Pacific Daylight Time)">23:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: Hi! Background question: the <code>void *</code> passed to a <code>JSJitMethodOp</code>, where does it get its value from?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Sep 10 2021 16:44:05 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">jimb</span>: looks like the DOM_OBJECT_SLOT <a href="https://searchfox.org/mozilla-central/source/dom/bindings/JSSlots.h#14-19">https://searchfox.org/mozilla-central/source/dom/bindings/JSSlots.h#14-19</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Sep 10 2021 16:44:51 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(derived this answer from: <a href="https://searchfox.org/mozilla-central/rev/1761c710b035d7dc8892dfa8e56589b4e095221f/js/src/jit/CodeGenerator.cpp#5233-5234,5269,5271-5273">https://searchfox.org/mozilla-central/rev/1761c710b035d7dc8892dfa8e56589b4e095221f/js/src/jit/CodeGenerator.cpp#5233-5234,5269,5271-5273</a> )</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Sep 10 2021 16:47:38 GMT-0700 (Pacific Daylight Time)">23:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">which I believe is typically set here: <a href="https://searchfox.org/mozilla-central/source/dom/bindings/BindingUtils.h#2665-2666">https://searchfox.org/mozilla-central/source/dom/bindings/BindingUtils.h#2665-2666</a></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Sep 10 2021 16:48:45 GMT-0700 (Pacific Daylight Time)">23:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This also might be relevant: <a href="https://searchfox.org/mozilla-central/source/dom/bindings/BindingUtils.cpp#2899-2912">https://searchfox.org/mozilla-central/source/dom/bindings/BindingUtils.cpp#2899-2912</a></td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Sep 10 2021 16:49:13 GMT-0700 (Pacific Daylight Time)">23:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's used here: <a href="https://searchfox.org/mozilla-central/source/dom/bindings/BindingUtils.cpp#3284-3300">https://searchfox.org/mozilla-central/source/dom/bindings/BindingUtils.cpp#3284-3300</a></td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Sep 10 2021 16:50:30 GMT-0700 (Pacific Daylight Time)">23:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">That code in <code>visitCallDOMNative</code> seems like the void* is produced by <code>LoadDOMPrivate</code>.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Sep 10 2021 16:50:59 GMT-0700 (Pacific Daylight Time)">23:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yeah, should be</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Sep 10 2021 16:53:16 GMT-0700 (Pacific Daylight Time)">23:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">Great - thanks!</td></tr>

</tbody></table></div></div></div>
</body></html>