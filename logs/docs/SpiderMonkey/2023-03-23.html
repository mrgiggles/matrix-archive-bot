<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-03-23</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-03-23<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-03-22" class="nav-link"><span>prev</span></a>
<a href="2023-03-24" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Mar 23 2023 06:20:02 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">the blog post "Calls between JavaScript and WebAssembly are finally fast" mentions inlining (small) wasm functions into jitted JS code as a potential optimization. has this been explored further in the meantime?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Mar 23 2023 06:24:49 GMT-0700 (Pacific Daylight Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This was once again mentioned last week, this might be looked at in the near future.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Mar 23 2023 06:25:46 GMT-0700 (Pacific Daylight Time)">13:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">There is "inlining" of calls without additional stubs. The JS and Wasm have different ABIs. <span class="nick-4">l11d</span> do you have specific use case for inlining? (Besides some trivial accessor into Wasm GC objects)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Mar 23 2023 06:34:21 GMT-0700 (Pacific Daylight Time)">13:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">well, my "use case" is fuzzing the engine and hence I'm exploring whether there are any features/interactions that current fuzzers might be missing. I was wondering whether wasm is inlined at the MIR/LIR layer as this could be an interesting surface</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Mar 23 2023 06:50:07 GMT-0700 (Pacific Daylight Time)">13:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">the term 'inlining' is a bit misleading, we can sometimes emit a direct call from a JS JIT'ed function to a wasm function without a stub to convert between ABI's. but the body of the wasm function is not inlined into the JS JIT'ed function.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Mar 23 2023 06:50:52 GMT-0700 (Pacific Daylight Time)">13:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">I'm not sure why that terminology was used, maybe because the stub to convert between the two ABI's is inlined? but 'direct calls' is a bit clearer</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Mar 23 2023 06:54:01 GMT-0700 (Pacific Daylight Time)">13:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">JS &lt;-&gt; Wasm stubs need to fuzzed/tested, yes. There are so many edge cases: stack alignments, different amount of parameters or results, GC references, etc.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Mar 23 2023 06:56:26 GMT-0700 (Pacific Daylight Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">thanks for clarifying the terminology. I sort-of thought that wasm/JS might be inlined cross-langugage, similar to rust/C in lto-builds</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Mar 23 2023 07:00:43 GMT-0700 (Pacific Daylight Time)">14:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: WASM does not enabled Range Analysis, as opposed to Ion/Warp: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/IonOptimizationLevels.cpp#34">https://searchfox.org/mozilla-central/source/js/src/jit/IonOptimizationLevels.cpp#34</a></td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Mar 23 2023 07:03:15 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> thanks for clarifying the terminology. I sort-of thought that wasm/JS might be inlined cross-langugage, similar to rust/C in lto-builds</blockquote></mx-reply>We might do this in the future in very specific and limited cases (JS calling a small wasm function with certain known instructions). But we don't have immediate plans for that</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Mar 23 2023 07:04:15 GMT-0700 (Pacific Daylight Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-16">Ryan Hunt</span>: WASM does not enabled Range Analysis, as opposed to Ion/Warp: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/IonOptimizationLevels.cpp#34">https://searchfox.org/mozilla-central/source/js/src/jit/IonOptimizationLevels.cpp#34</a></blockquote></mx-reply>Oh interesting, I wonder why it showed up in <span class="nick-1">jseward</span> 's profiles then</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Mar 23 2023 07:12:45 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell">What my profiles show is a bunch of instructions going into  the call to RangeAnalysis::addBetaNodes at <a href="https://searchfox.org/mozilla-central/source/js/src/jit/Ion.cpp#1182">https://searchfox.org/mozilla-central/source/js/src/jit/Ion.cpp#1182</a></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Mar 23 2023 07:13:14 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">under WASM compilations?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Mar 23 2023 07:13:34 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell">Yes.  I think so.  It seems to me as if <code>mir-&gt;optimizationInfo().rangeAnalysisEnabled() == true</code>.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Mar 23 2023 11:47:56 GMT-0700 (Pacific Daylight Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">Hey JS gang - suppose I'm looking at code that might be dealing with a very large JS object structure.... think maybe an array of many JS objects representing tabs that can be sync'd. It looks like we have code that tries to clamp down how much data we send to the sync server by attempting to compute the serialized size of the data structure, and then culling records until we hit our maximum threshold.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Mar 23 2023 11:48:30 GMT-0700 (Pacific Daylight Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">The way that serialization currently works is by using JSON.stringify, into an utf8Encoder.encode, and then looking at the bytelength</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Mar 23 2023 11:48:57 GMT-0700 (Pacific Daylight Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">As this happens in the parent process on the main thread, this kind of thing can get pretty expensive for extremely large sessions with many tabs and windows.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Mar 23 2023 11:49:54 GMT-0700 (Pacific Daylight Time)">18:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">Is there a more efficient way of doing this computation, or at least taking it off of the main thread? Or are we stuck doing at least one JSON.stringify in order to get it over to a Worker or something?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Mar 23 2023 11:50:52 GMT-0700 (Pacific Daylight Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">This is the code I'm looking at, fwiw: <a href="https://searchfox.org/mozilla-central/rev/d630a6aad368dbbae4d90853f8cff5cb7c852407/services/sync/modules/util.sys.mjs#413-447">https://searchfox.org/mozilla-central/rev/d630a6aad368dbbae4d90853f8cff5cb7c852407/services/sync/modules/util.sys.mjs#413-447</a></td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Mar 23 2023 11:52:25 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Huh. Maybe that's why JSON.stringify is showing up in profiles.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Mar 23 2023 11:54:10 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">I guess there's not a great way of "moving" an array of JS objects like this to a Worker?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Mar 23 2023 11:54:45 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">I'm looking at transferrables, and it looks like we'd need to probably do a structured clone or serialization anyways on the same thread in order to construct something transferrable...</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Mar 23 2023 11:55:49 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if it's just an estimate, then switching to structured serialization might be faster. Quoting strings for JSON is slow. Still main thread, though.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Mar 23 2023 11:56:15 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">You can't transfer any of the interesting types (objects, strings).</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Mar 23 2023 11:56:55 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">We've talked about creating some sort of size estimate internally, in order to pick a better size for the JSON.stringify output buffer.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Mar 23 2023 11:58:43 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">these end up serialized via JSON, not structured clone, after this returns?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Mar 23 2023 11:59:33 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I was thinking that if we had an API that took a maximum size, then in the common case where the whole thing fits, you could only serialize once.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Mar 23 2023 12:02:02 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">It looks like it gets passed into some layer that communicates with some the Rust backend for sync</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Mar 23 2023 12:02:10 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/d630a6aad368dbbae4d90853f8cff5cb7c852407/services/sync/modules/engines/tabs.sys.mjs#77-84">https://searchfox.org/mozilla-central/rev/d630a6aad368dbbae4d90853f8cff5cb7c852407/services/sync/modules/engines/tabs.sys.mjs#77-84</a></td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Mar 23 2023 12:02:36 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">but it looks like there's at least a bit of post-processing after <code>tryFitItems</code>.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Mar 23 2023 12:04:52 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, it looks like it goes through <a href="https://searchfox.org/mozilla-central/rev/d630a6aad368dbbae4d90853f8cff5cb7c852407/toolkit/components/uniffi-bindgen-gecko-js/components/generated/RustTabs.jsm#1056-1059">a bunch of FFI calls</a> for the individual components. So not JSON and not structured clone.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Mar 23 2023 12:05:31 GMT-0700 (Pacific Daylight Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(be back in a bit)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Mar 23 2023 12:05:45 GMT-0700 (Pacific Daylight Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">👍️</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Mar 23 2023 12:06:19 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">Anyhow, <a href="https://phabricator.services.mozilla.com/D173369">the patch I'm reviewing</a> tries to make things a little bit better by letting the event loop breathe a bit between stringifications</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Mar 23 2023 12:06:31 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">but I wanted to know if anybody had ideas on a better way to do this.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Mar 23 2023 13:01:36 GMT-0700 (Pacific Daylight Time)">20:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">mconley</span>: looking at it, it seems like all of the Rust writing stuff already has <code>computeSize</code> functionality. The whole <code>tryFitItems</code> copy-fest seems like a waste to me. It would be better in all ways to implement a <code>writeLimited</code> method similar to <a href="https://searchfox.org/mozilla-central/rev/d630a6aad368dbbae4d90853f8cff5cb7c852407/toolkit/components/uniffi-bindgen-gecko-js/components/generated/RustTabs.jsm#1438-1443"><code>write</code></a> on <code>FfiConverterSequenceTypeRemoteTabRecord</code> that takes a <code>sizeThreshold</code> parameter and just stops writing after the first tab that exceeds the threshold. (It would add up the size using <code>computeSize</code> before each write.)</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Mar 23 2023 13:20:09 GMT-0700 (Pacific Daylight Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">Thanks! I've included that note in my review.</td></tr>

</tbody></table></div></div></div>
</body></html>