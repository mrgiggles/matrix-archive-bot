<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-04-30</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-04-30<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-04-29" class="nav-link"><span>prev</span></a>
<a href="2024-05-01" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Apr 30 2024 08:30:31 GMT-0700 (Pacific Daylight Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Well the snow isn't unprecedented -- but I'm not <em>loving</em> it. Video from another edmontonian: <a href="https://dialup.cafe/@vga256/112360848014127198">https://dialup.cafe/@vga256/112360848014127198</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Apr 30 2024 08:59:14 GMT-0700 (Pacific Daylight Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell">Hi everyone! I was wondering what V8 does differently than SpiderMonkey to make it more performant. I know they do a lot of optimizations, have a great jit, gc, caching, hidden classes, etc</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Apr 30 2024 09:02:38 GMT-0700 (Pacific Daylight Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">arjun</span>: There is no simple answer to that question. All three of the major JS engines have all the things you've listed, and will be faster on individual microbenchmarks.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Apr 30 2024 09:05:26 GMT-0700 (Pacific Daylight Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell">ive been meaning to develop a mini proof of concept js engine that uses some nice cs theory stuff, but i think even if it was implemented perfectly (it never will), i dont know what engine authors could do to further optimize what is already optimized to the bone</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Apr 30 2024 09:05:46 GMT-0700 (Pacific Daylight Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In broad strokes, I think V8 is currently a bit ahead in terms of pushing more work offthread (offthread compilation, concurrent GC). <a href="https://v8.dev/docs/torque">Torque</a> has some advantages over the self-hosted code approach that we use (I believe JSC also uses self-hosted code).</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Apr 30 2024 09:06:02 GMT-0700 (Pacific Daylight Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">A lack of things to optimize is never the problem.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Apr 30 2024 09:06:58 GMT-0700 (Pacific Daylight Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> ive been meaning to develop a mini proof of concept js engine that uses some nice cs theory stuff, but i think even if it was implemented perfectly (it never will), i dont know what engine authors could do to further optimize what is already optimized to the bone</blockquote></mx-reply>one example of "nice cs theory stuff" would be using adaptive ll(*) parsing, but i dont know how much of an impact that would even make</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Apr 30 2024 09:09:02 GMT-0700 (Pacific Daylight Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> In broad strokes, I think V8 is currently a bit ahead in terms of pushing more work offthread (offthread compilation, concurrent GC). <a href="https://v8.dev/docs/torque">Torque</a> has some advantages over the self-hosted code approach that we use (I believe JSC also uses self-hosted code).</blockquote></mx-reply>i have heard of torque and browsed the docs on it a few days ago. also saw maglev which is pretty incredible imho</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Apr 30 2024 09:09:33 GMT-0700 (Pacific Daylight Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Parsing is not a huge component of overall performance right now. Also, to the great dismay of theoreticians, every production-quality parser that I know of is a hand-written recursive descent parser, because that's the most reliable way to be fast while also producing good error messages.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Apr 30 2024 09:12:10 GMT-0700 (Pacific Daylight Time)">16:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We spent a while working on an project called Smooshmonkey where we generated a parser. It turns out that JS is a big enough language that a) you can't fit the LALR table in L1 cache, so performance wasn't as good as we'd hoped, and b) it takes forever to reimplement the parser. Eventually we gave up.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Apr 30 2024 09:15:47 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Jason Orendorff wrote a <a href="https://github.com/mozilla-spidermonkey/jsparagus/blob/master/js-quirks.md#js-syntactic-quirks">great summary</a> of the difficulties of parsing JS</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Apr 30 2024 09:18:56 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> We spent a while working on an project called Smooshmonkey where we generated a parser. It turns out that JS is a big enough language that a) you can't fit the LALR table in L1 cache, so performance wasn't as good as we'd hoped, and b) it takes forever to reimplement the parser. Eventually we gave up.</blockquote></mx-reply>what do you think the main issues preventing further performance gains in js engines are? just curious</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Apr 30 2024 09:19:47 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Resources. There are plenty of things to optimize, and not enough hours in the day.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Apr 30 2024 09:24:36 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Here is a graph of JS_PAGELOAD_MS over the last year (from a few months ago), which is a telemetry metric showing how long JS runs during pageload (95th percentile).</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Apr 30 2024 09:24:58 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We did a big performance push for the release of speedometer 3, and those were the results.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Apr 30 2024 09:29:13 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The big questions are all software engineering questions. Given all the different JS features / idioms that we could focus on optimizing, which ones are the most important? How do we design our engine to make it easy to add new optimizations quickly? How do we balance performance against correctness / security?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Apr 30 2024 09:29:25 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Coming up with cool new ideas for things to improve is the easy part.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Apr 30 2024 09:30:02 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@julienw:mozilla.org">julienw</span>&gt;</div></td><td class="msg-cell">I remember markus mentioning how v8 stores pointers differently than spidermonkey</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Apr 30 2024 09:32:05 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, we represent a JS value as a 64-bit double, with all non-double values disguised as NaNs. V8 uses a compressed pointer representation where 32-bit values have a low-bit tag to distinguish between 31-bit small integers, and offsets into the heap.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Apr 30 2024 09:33:17 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The big questions are all software engineering questions. Given all the different JS features / idioms that we could focus on optimizing, which ones are the most important? How do we design our engine to make it easy to add new optimizations quickly? How do we balance performance against correctness / security?</blockquote></mx-reply>just to entertain a thought experiment: say you have infinite time, engineering power etc - do you think it would be beneficial to make a new js engine using a new design, or in other words what servo was to firefox, this new js engine would be to spidermonkey? but would you even see a performance increase? for example servo (still being incomplete) idt is as fast as blink for pure layout performance</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Apr 30 2024 09:35:08 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">The JITs used to get rewritten every few years. 😄 I think it is a bit more stable since we had Ion Monkey.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Apr 30 2024 09:36:01 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Infinite resources is a weird question. Spidermonkey is nearly 30 years old at this point, and most of the performance-critical parts have been rewritten at least once, if not multiple times.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Apr 30 2024 09:36:46 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Case in point: since we added IonMonkey, we also added the baseline compiler and the baseline interpreter, and then completely replaced IonBuilder with WarpBuilder.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Apr 30 2024 09:36:52 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Also I'd say generally that the space of compilers is much more well explored than layout engines. There are lots and lots of compilers out there.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Apr 30 2024 09:37:09 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The big questions are all software engineering questions. Given all the different JS features / idioms that we could focus on optimizing, which ones are the most important? How do we design our engine to make it easy to add new optimizations quickly? How do we balance performance against correctness / security?</blockquote></mx-reply>very interesting! so the battle between the engines is like, who can optimize more?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Apr 30 2024 09:37:37 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Who can optimize more, and who can pick the right things to optimize.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Apr 30 2024 09:37:54 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We have less resources than V8, so we have to be smarter about what we work on.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Apr 30 2024 09:39:30 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Infinite resources is a weird question. Spidermonkey is nearly 30 years old at this point, and most of the performance-critical parts have been rewritten at least once, if not multiple times.</blockquote></mx-reply>well its a thought experiment to entertain a certain conclusion, whether even if you made a js engine from scratch using "modern" (?) cs theory (really just like servo), would you even see that much of a performance bump over say v8?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Apr 30 2024 09:39:59 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell">i think of the xi editor (ralph linus' project) and the performance increases he got from that, but a js engine is so much bigger than a text editor idt its even comparable</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Apr 30 2024 09:41:06 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In practice, a lot of the really cutting-edge VM work is already being done inside the big engines, not in academia</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Apr 30 2024 09:47:38 GMT-0700 (Pacific Daylight Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Given your references to xi and servo, you're probably also asking: how much faster would a JS engine be if we rewrote it in Rust. And my stock answer there is that I would love to find out, but a JS engine is actually a hard problem for Rust, for a couple of reasons. First, I don't think anybody's ever really figured out how to write a garbage collector in Rust that is performant, safe, and ergonomic to use. I'm sure it's possible, but to the best of my knowledge it's still an open research question. Second, the nature of JIT compilation inherently undermines Rust's security guarantees. The borrow checker is great, but when your entire strategy for making things fast is "I'm going to write some bytes into this buffer at runtime and then execute them", there's only so much Rust can do for you.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Apr 30 2024 09:50:26 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">There has been work on verifying and verified compilation, but Rust doesn't really help you there, and doing that in a JIT setting is tougher because compilation time is effectively part of the program runtime.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Apr 30 2024 09:51:33 GMT-0700 (Pacific Daylight Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I did work on GC verification a long time ago, but it needed a very powerful theorem proving system to be doable.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Apr 30 2024 09:51:41 GMT-0700 (Pacific Daylight Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">there is some works in the v8 code base for isolating the jitted code better but that's quite a vast undertaking  </td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Apr 30 2024 09:51:50 GMT-0700 (Pacific Daylight Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, a lot of academic theory gets thrown out the window when compilation time counts against your execution time</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Apr 30 2024 09:52:09 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We have a collaboration going with some researchers to start looking into a similar JIT sandbox for SM</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Apr 30 2024 09:52:28 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But that is a long-term project</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Apr 30 2024 09:53:53 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think there's a non-zero chance that we eventually migrate to a compressed pointer representation for values to make sandboxing easier</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Apr 30 2024 09:54:12 GMT-0700 (Pacific Daylight Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So that's two huge projects stacked on top of each other</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Apr 30 2024 09:57:55 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">interesting to know that someone in academia is working on this for SM. still, the attack surface of the content process is vast considering the number APIs exposed to JS. its just that the JS engine allows for fine-granular control so its one of the preferred component for exploitation  </td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Apr 30 2024 10:03:07 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://v8.dev/blog/sandbox">Here</a> is a good V8 article about their sandbox, in case anybody hasn't seen it. The general idea is that mortal humans have a demonstrated inability to write an optimizing JIT that doesn't have any vulnerabilities, so instead of completely trying to prevent those, we can assume that the attacker uses a JIT vulnerability to gain control of the JS heap and then put a sandbox around the JS heap so that you can't do anything fun without finding another vulnerability in the sandbox.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Apr 30 2024 10:16:34 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@arjun:tchncs.de">arjun</span>&gt;</div></td><td class="msg-cell">is there any website that shows speedometer 3 scores for each browser? arewefastyet seems to only show speedometer 2</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Apr 30 2024 10:23:19 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We have an internal dashboard, but I'm not sure if there's anything public-facing</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Apr 30 2024 10:25:27 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Everybody's currently close enough that the highest score will vary depending on your hardware</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Apr 30 2024 11:03:32 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">And the time it takes to run mostly depends on your internet connection (not the score)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Apr 30 2024 11:04:37 GMT-0700 (Pacific Daylight Time)">18:04</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-2" title="@nbp:mozilla.org">nbp</span></div></td><td class="msg-cell">internally yelling at sunspider benchmark harness.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Apr 30 2024 12:02:54 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">Hi all, I'm running into an issue where I have a C++ object (i.e Foo) stored in a private data slot of a JS Object (Custom_JS_Obj). The C++ object Foo has a Heap&lt;&gt; member pointing to another JS object. I've implemented the tracing, but I notice that the trace() method gets called too late. By the time trace() gets called on my Heap&lt;T&gt; member, it's already been swept for GC. In debugging this, I can see my Heap&lt;T&gt; get moved into tenured heap, and setting a watchpoint on the memory address pointing to it, I can see it get cleaned up/swept before trace() gets called. Is there something I need to do to ensure the object gets traced properly earlier? </td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Apr 30 2024 12:16:13 GMT-0700 (Pacific Daylight Time)">19:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. That definitely sounds surprising. I don't have an immediate obvious anwser; you're sure here that the JSObject with the private slot is live too, right? (as if they were all dead, this would make sense to me as I don't think there's a guaranteed sweep order)</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Apr 30 2024 12:17:03 GMT-0700 (Pacific Daylight Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Do you have a trace hook on CustomJSObj? Or just a trace method on Foo?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Apr 30 2024 12:17:44 GMT-0700 (Pacific Daylight Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Oh that's a good point too -- I sort of assumed the trace hook was installed since you said it did get called, but if it's potentially getting invoked some other way (rooted?) </td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Apr 30 2024 12:24:53 GMT-0700 (Pacific Daylight Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">yup, to confirm, Custom_JS_Obj has a <code>trace()</code>  hook installed, and the JSObject with the private data slot is still alive.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Apr 30 2024 12:28:04 GMT-0700 (Pacific Daylight Time)">19:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it really sounds like your <code>Custom_JS_Obj</code> trace function isn't getting called at all, and something else is tracing the object in your <code>Heap&lt;T&gt;</code>. What should be causing that <code>Custom_JS_Object</code> to be traced? Is it in <code>Rooted</code>, or is it a property of something else that is live?</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Apr 30 2024 12:29:20 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess you say that <code>trace()</code> is getting called eventually, but that seems like maybe it's getting called for another reason. I guess that's another question: what is calling the <code>trace()</code> function when it <em>does</em> get called?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Apr 30 2024 12:31:36 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell"><pre><code>#0 ::mozjs::Foo::trace (trc=0x31827fc22fc0, obj=&lt;optimized out&gt;)
#1  0x0000fffff3b44a8c in ::trace&lt;::mozjs::FooInfo&gt; (trc=0x0, obj=0xdecc9)
#2  0x0000ffffeee16d80 in JSClass::doTrace (this=&lt;optimized out&gt;, trc=0x31827fc22fc0, obj=0xc9cc3254e98) at ../js/Class.h:653
#3  CallTraceHook (trc=trc@entry=0x31827fc22fc0, obj=obj@entry=0xc9cc3254e98) at ../js/src/gc/Marking.cpp:1238
#4  0x0000ffffeee1cbec in js::GCMarker::processMarkStackTop&lt;4u&gt; (this=this@entry=0x31827fc22fc0, budget=...) at ../js/src/gc/Marking.cpp:1521
#5  0x0000ffffeee23270 in js::GCMarker::markOneColor&lt;4u, (js::gc::MarkColor)2&gt; (this=this@entry=0x31827fc22fc0, budget=...) at ../js/src/gc/Marking.cpp:1315
#6  0x0000ffffeee1b9c8 in js::GCMarker::doMarking&lt;4u&gt; (this=this@entry=0x31827fc22fc0, budget=..., reportTime=js::gc::ReportMarkTime) at ../js/src/gc/Marking.cpp:1283
#7  0x0000ffffeee12a5c in js::GCMarker::markUntilBudgetExhausted (this=0x31827fc22fc0, budget=..., reportTime=js::gc::ReportMarkTime) at ../js/src/gc/Marking.cpp:1274
#8  0x0000ffffeedf5f30 in js::gc::GCRuntime::markUntilBudgetExhausted (this=this@entry=0x31827ffa2728, sliceBudget=..., allowParallelMarking=&lt;optimized out&gt;, reportTime=js::gc::ReportMarkTime) at ../js/src/gc/GC.cpp:2999
#9  0x0000ffffeedf82e8 in js::gc::GCRuntime::incrementalSlice (this=this@entry=0x31827ffa2728, budget=..., reason=reason@entry=JS::GCReason::API, budgetWasIncreased=&lt;optimized out&gt;) at ../js/src/gc/GC.cpp:3615
#10 0x0000ffffeedfa088 in js::gc::GCRuntime::gcCycle (this=this@entry=0x31827ffa2728, nonincrementalByAPI=false, budgetArg=..., reason=reason@entry=JS::GCReason::API) at ../js/src/gc/GC.cpp:4179
#11 0x0000ffffeedfabc0 in js::gc::GCRuntime::collect (this=this@entry=0x31827ffa2728, nonincrementalByAPI=&lt;optimized out&gt;, budget=..., reason=reason@entry=JS::GCReason::API) at ../js/src/gc/GC.cpp:4367
#12 0x0000ffffeede1604 in js::gc::GCRuntime::gc (this=0x31827ffa2728, options=JS::GCOptions::Normal, reason=JS::GCReason::API) at ../js/src/gc/GC.cpp:4444
...
</code></pre>
</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Apr 30 2024 12:31:55 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">This is the trace for stack trace for my <code>trace()</code> getting called.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Apr 30 2024 12:32:06 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that's not during sweeping</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Apr 30 2024 12:32:38 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm, I wonder if you have a minor GC where it doesn't get called, and then a major GC where it does?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Apr 30 2024 12:33:42 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">that seems likely. I've tried triggering <code>gc()</code> manually within my repro script, but I can only get it to <code>trace() i</code>n the final <code>gc()</code> during teardown.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Apr 30 2024 12:33:52 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">and by that time, my object is already invalid.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Apr 30 2024 12:34:10 GMT-0700 (Pacific Daylight Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">So the trace itself is segfaulting.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Apr 30 2024 12:34:29 GMT-0700 (Pacific Daylight Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it might be useful to set breakpoints on <code>Nursery::doCollection</code> to identify the time that a minor GC is starting, and, uh... I guess <code>GCRuntime::collect</code> to identify the start of the major GC</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Apr 30 2024 12:34:41 GMT-0700 (Pacific Daylight Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(with the caveat that the major GC will probably run a minor GC at the beginning)</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Apr 30 2024 12:35:13 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, I'm thinking you're getting some sort of collection that discards the object, then a later collection that traces it.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Apr 30 2024 12:35:57 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">thanks, I'll give that a try. What's the difference between minor/major gc?</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue Apr 30 2024 12:36:28 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess you need to answer the question: why do you think the <code>Custom_JS_Obj</code> is reachable in the earlier collection? What is holding it?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue Apr 30 2024 12:37:06 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we have a generational GC, so most things are allocated in the nursery. Collecting the nursery and moving the survivors into the tenured heap is a minor GC. Collecting the tenured heap is a major GC.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue Apr 30 2024 12:37:50 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but the trace functions should be called the same for both.</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue Apr 30 2024 12:38:26 GMT-0700 (Pacific Daylight Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(as in, the code you write that causes them to be traced is the same.)</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue Apr 30 2024 14:02:52 GMT-0700 (Pacific Daylight Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">thanks for the help! It looks like we were tracing conditionally on a different set of conditions 🙃</td></tr>

</tbody></table></div></div></div>
</body></html>