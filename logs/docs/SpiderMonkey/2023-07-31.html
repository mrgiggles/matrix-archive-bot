<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-07-31</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-07-31<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-07-28" class="nav-link"><span>prev</span></a>
<a href="2023-08-01" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jul 31 2023 09:23:20 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">Hi, I'm currently messing around with <a href="https://github.com/mozilla-spidermonkey/sm-wasi-demo">https://github.com/mozilla-spidermonkey/sm-wasi-demo</a> and got it to work with the latest version of wasmer, which did a complete rework of their js api. Now I'm wondering how I can import things like functions into the WASM+spidermonkey environment so I can communicate from inside the the wasm js runtime to the outsite nodejs runtime in order to request data or do other things. Thanks in advance for the help!</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jul 31 2023 09:44:26 GMT-0700 (Pacific Daylight Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">nitwel</span>: one option is to use files on the in-memory file system, that's how we pass the input source code (in /input.js), or stdout/stderr</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jul 31 2023 09:45:20 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">keep in mind that this is just a quick demo. I've been thinking about doing something similar with <a href="https://github.com/bytecodealliance/componentize-js">https://github.com/bytecodealliance/componentize-js</a> but these components don't run in the browser yet last I heard</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jul 31 2023 09:45:39 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Can anyone point me to some good examples of how to use modules in mozjs?  I've looked through the code and I don't fully understand how they're used</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jul 31 2023 09:48:02 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">nitwel</span>: was it hard to make it work with latest wasmer? I ran into some issues when I tried this last year or so but maybe they've fixed those since then</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jul 31 2023 09:52:49 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">Was fairly easy, they had a few good examples, only thing I wasn't able to find was how to do bindings, maybe they got rid of that. Feel free to have a look at the code here: <a href="https://github.com/directus/directus/blob/ext-secure/api/src/extensions/wasm.ts">https://github.com/directus/directus/blob/ext-secure/api/src/extensions/wasm.ts</a>

How would I communicate over the file system / how do I watch for changes in these virtual files?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jul 31 2023 09:55:16 GMT-0700 (Pacific Daylight Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">nitwel</span>: there's also <code>readline()</code> that reads from stdin, but I don't know if that works in the wasi environment</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jul 31 2023 09:56:16 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">Haha, I tried using that too and that works fine aswell. ^^</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jul 31 2023 09:57:24 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">ideally you probably want an embedding that's not the JS shell that's easier to pass data from/to</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jul 31 2023 09:58:51 GMT-0700 (Pacific Daylight Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">maybe we could add something to the wasi build of the shell</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jul 31 2023 10:02:12 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">doesn't the wasi host expose callbacks for the file system? I thought it was using that for stdout/stderr</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jul 31 2023 10:03:20 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">oh nevermind, it's just using <code>readFileSync</code>. Hm</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jul 31 2023 10:04:05 GMT-0700 (Pacific Daylight Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">I'm not able to follow what a js shell embedding is? Is that what spidermonkey is when build to wasm?
<a href="https://github.com/wasmerio/wasmer-js#typescript-api">https://github.com/wasmerio/wasmer-js#typescript-api</a> has all methods accessible through wasmer-js. I can't see any way to watch for file changes.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jul 31 2023 10:06:44 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">nitwel</span>: we have a command line application that we use for testing SpiderMonkey called the JS shell, and that's the one we compile to WASI. It's typically just running a single script and using stdin/stdout, that makes this a bit tricky</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jul 31 2023 10:08:12 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">maybe we could add a builtin function to the wasi shell build that calls a function in the host environment? I'm not sure how hard that is though</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jul 31 2023 10:10:47 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">Ah, thanks for the clarification, that makes sense!
As far as I know, we are able to provide imports to the wasm environment with wasmer on the instantiate method. What probably has to be done is to pass them down to the js runtime or as you mentioned to have a function that checks for their existance and calls them if present.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jul 31 2023 10:12:09 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">agreed. We could probably make it work for passing/returning strings and numbers at least..</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jul 31 2023 10:12:55 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">That would be more than enough for most usecases as it enables 1 or 2 way communication while wasm is running.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jul 31 2023 10:20:08 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I don't have time to work on this anytime soon, but feel free to file a bug. It could also be nice for the online demo (to request user input or access a canvas or something)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jul 31 2023 10:25:09 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">No worries. I'm not very familiar with SpiderMonkey, but do you think I would be able to implement this myself and add it to the JS Shell? The reason being that this is a requirement for what I need for work, otherwise I would have to look into different solutions of running arbitrary js code securely which probably aren't as sophisticated as SpiderMonkey + WASM.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jul 31 2023 10:27:01 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">also note that the JS shell has a pretty large number of builtin functions (see <code>help()</code>) that are normally unsafe to expose to arbitrary JS code, but at least Wasm/WASI sandboxes those too...</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jul 31 2023 10:37:11 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">nitwel</span>: you could try <a href="https://firefox-source-docs.mozilla.org/js/build.html">these instructions</a> to build the JS shell locally for WASI with <a href="https://paste.mozilla.org/UhirYPB3">this mozconfig</a>. The JS shell code is in js/src/shell/js.cpp. The <code>print(..)</code> builtin for example uses <code>PrintInternal</code>, maybe you could do something similar to that</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jul 31 2023 10:41:06 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">Thanks for all the help, really appreciate it! Will have a look at this tomorrow, hopefully I will be able to manage my way through it.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jul 31 2023 10:42:27 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">good luck. I have to run now too but usually people will be around in this channel if you get stuck</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jul 31 2023 14:21:35 GMT-0700 (Pacific Daylight Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">What happens in SpiderMonkey when running code with an import statement.  Is a file automatically searched for in the current directory, or is there some way of adding hooks to import statements?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jul 31 2023 14:25:27 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: the file handling is done in embedder's side, by providing <a href="https://searchfox.org/mozilla-central/rev/e4fa79ba05364da0d6ec40d3f9dbe0d15ce6f902/js/public/Modules.h#53">HostResolveImportedModule </a></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jul 31 2023 14:26:30 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">when SpiderMonkey finds import, the hook is called, and the embedder is supposed to fetch a corresponding resource and compile the module</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jul 31 2023 14:26:38 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">thanks</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Jul 31 2023 14:27:02 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">And it loooks like this operation is synchronous.  I know some of the imports are sync and some are async</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Jul 31 2023 14:27:25 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>example in JS shell <a href="https://searchfox.org/mozilla-central/rev/e4fa79ba05364da0d6ec40d3f9dbe0d15ce6f902/js/src/shell/ModuleLoader.cpp#62,75">https://searchfox.org/mozilla-central/rev/e4fa79ba05364da0d6ec40d3f9dbe0d15ce6f902/js/src/shell/ModuleLoader.cpp#62,75</a></p>
<pre><code class="language-cpp">  JS::SetModuleResolveHook(rt, ModuleLoader::ResolveImportedModule);
...
JSObject* ModuleLoader::ResolveImportedModule(
</code></pre>
</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Jul 31 2023 14:31:03 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">dynamic import is handled with <code>JS::SetModuleDynamicImportHook</code> call below</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Jul 31 2023 14:50:10 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">What exactly is the distinction between normal and dynamic import?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Jul 31 2023 15:06:36 GMT-0700 (Pacific Daylight Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">normal one is <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import">import declaration</a>, which can appear only at module the top level, and handled before executing the module top-level script.  <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import">dynamic import</a> is function-call-style import that can appear anywhere, and returns a promise for the module namespace object</td></tr>

</tbody></table></div></div></div>
</body></html>