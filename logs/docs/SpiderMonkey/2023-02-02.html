<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-02-02</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-02-02<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-02-01" class="nav-link"><span>prev</span></a>
<a href="2023-02-03" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Feb 02 2023 04:50:43 GMT-0800 (Pacific Standard Time)">12:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">in spidermonkey, there are dedicated allocation arenas (js::StringBufferArena/js::MallocArena/js::ArrayBufferContentsArena). are these arenas used by multiple threads or are all allocations using a specific arena made from a single thread?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Feb 02 2023 05:31:08 GMT-0800 (Pacific Standard Time)">13:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">l11d</span>: multiple threads afaik, for example <code>js::MallocArena</code> is used for all <code>js_malloc(..)</code> callers</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Feb 02 2023 05:35:22 GMT-0800 (Pacific Standard Time)">13:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">would rerouting allocation requests with specific arenas to the default heap work or does the engine somehow depend on this?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Feb 02 2023 05:36:07 GMT-0800 (Pacific Standard Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">should be possible as one can build entirely without jemalloc?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Feb 02 2023 05:36:48 GMT-0800 (Pacific Standard Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah, should be fine</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Feb 02 2023 06:34:31 GMT-0800 (Pacific Standard Time)">14:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>So just to continue off from yesterday</p>
<pre><code class="language-C++">JS::Value getVal(JSContext* ctx) {
  JS::RootedValue val(ctx);
...
  return val;
}

void topFunction(JSContext* ctx) {
  JS::RootedValue val(ctx, getVal(ctx));
...
}
</code></pre>
<p>Is it possible that GC will get triggered on getVal's JS::RootedValue before it gets rerooted? Lets say because the runtime is running low from memory due to other contexts on other threads.</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Feb 02 2023 06:44:38 GMT-0800 (Pacific Standard Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: I don't see how that can happen in this case, because there's no call to something that can GC between returning from <code>getVal</code> and re-rooting it in the caller</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Feb 02 2023 06:45:46 GMT-0800 (Pacific Standard Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">davidj361</span>: I don't see how that can happen in this case, because there's no call to something that can GC between returning from <code>getVal</code> and re-rooting it in the caller</blockquote></mx-reply>What if this is just one of the worker threads/contexts and the other contexts are doing something that takes up a ton of memory where GC is called while my example is executing?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Feb 02 2023 06:47:20 GMT-0800 (Pacific Standard Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: then we will trigger a GC for (and on) those other threads but it won't affect your context</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Feb 02 2023 06:48:02 GMT-0800 (Pacific Standard Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">(GC is mostly a per-context/thread thing)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Feb 02 2023 06:48:06 GMT-0800 (Pacific Standard Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Memory isn't shared between contexts?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Feb 02 2023 06:48:14 GMT-0800 (Pacific Standard Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I see</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Feb 02 2023 06:48:41 GMT-0800 (Pacific Standard Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the engine does some sharing internally for some data structures, but not like this no</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Feb 02 2023 06:49:17 GMT-0800 (Pacific Standard Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I'm surprised to hear that it's okay to re-root things, I would assume it was incredibly bad practice to root something that's considered deleted or fallen off the stack/scope</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Feb 02 2023 06:51:33 GMT-0800 (Pacific Standard Time)">14:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Where instead you are supposed to root in the top most stack frame and pass that RootedValue as <code>JS::MutableHandle</code> to reassign in those sub function calls</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Feb 02 2023 06:51:54 GMT-0800 (Pacific Standard Time)">14:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">alternative is to have a single <code>Rooted</code> that you pass to <code>getVal</code> (as <code>MutableHandle&lt;Value&gt;</code>) and then set there, but it's often more natural to return an unrooted value</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Feb 02 2023 06:54:15 GMT-0800 (Pacific Standard Time)">14:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Thanks jandem</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Feb 02 2023 09:26:22 GMT-0800 (Pacific Standard Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: <span class="nick-4">iain</span> : the linux man page for mprotect says it can fail if "Changing the protection of a memory region would result in the total number of mappings with distinct attributes (e.g., read versus read/write protection) exceeding the allowed maximum.  (For example, making the protection of a range PROT_READ in the middle of a region currently protected as PROT_READ|PROT_WRITE would result in three mappings: two read/write mappings at each end and a read- only mapping in the middle.)"  - I think this is what happened</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Feb 02 2023 09:27:03 GMT-0800 (Pacific Standard Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Okay, yeah, that makes sense</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Feb 02 2023 09:29:19 GMT-0800 (Pacific Standard Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This is what I had discovered as well. The funny thing was windows reporting that you had provided the wrong set of arguments.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Feb 02 2023 09:29:32 GMT-0800 (Pacific Standard Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Because this is not windows failure, this is yours.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Feb 02 2023 09:31:28 GMT-0800 (Pacific Standard Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm surprised to hear that it's okay to re-root things, I would assume it was incredibly bad practice to root something that's considered deleted or fallen off the stack/scope</blockquote></mx-reply>Nothing is considered deleted until there's a GC at a point where nothing cares about it. And it <em>is</em> a bad practice to start caring about something after that point. But there's always going to be a need to have things temporarily in a register or whatever. As long as you put things back where the GC can find them before it has a chance to run, it's all good. And the places where GC can run aren't that hard to identify (mostly: when you call something in the JSAPI that takes a <code>JSContext*</code> argument.)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Feb 02 2023 10:39:36 GMT-0800 (Pacific Standard Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: I finally filed: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1814711">https://bugzilla.mozilla.org/show_bug.cgi?id=1814711</a></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Feb 02 2023 10:50:48 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I wonder if escape analysis &amp; scalar replacement could unroll the loop and only keep the last iteration …</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Feb 02 2023 10:51:13 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Sounds like a job for the Sink phase :P</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Feb 02 2023 11:13:19 GMT-0800 (Pacific Standard Time)">19:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">ion-sink seems to be default disabled; would you be interested in fuzzbugs with this option enabled?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Feb 02 2023 11:47:43 GMT-0800 (Pacific Standard Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">l11d</span>: To the best of my knowledge, ion-sink has never been in proper working order; it landed briefly (bug 1093674), but was backed out for causing errors. The only open bug against it seems to be bug 1108413, which doesn't fail in my current build, so I guess I would be interested in a fuzzbug to poke at to see if it can flush out the existing issues.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Feb 02 2023 11:47:45 GMT-0800 (Pacific Standard Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1093674">https://bugzil.la/1093674</a> — RESOLVED (nbp) — IonMonkey: Sink recoverable instructions</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Feb 02 2023 11:47:45 GMT-0800 (Pacific Standard Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1108413">https://bugzil.la/1108413</a> — REOPENED (nbp) — Assertion failure: isLowered(), at js/src/jit/MIR.h:716 or Crash [@ js::jit::LiveInterval::addRangeAtHead]</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Feb 02 2023 11:54:47 GMT-0800 (Pacific Standard Time)">19:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(But once you've opened one, the marginal value of a second one is lower.)</td></tr>

</tbody></table></div></div></div>
</body></html>