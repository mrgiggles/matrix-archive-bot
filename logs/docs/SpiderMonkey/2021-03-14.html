<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-03-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-03-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-03-13" class="nav-link"><span>prev</span></a>
<a href="2021-03-15" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sat Mar 13 2021 16:26:26 GMT-0800 (Pacific Standard Time)">00:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I can't actually remember ever having encountered the JSFINALIZE_ stuff before, but I can hazard guesses anyway.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sat Mar 13 2021 16:29:15 GMT-0800 (Pacific Standard Time)">00:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ptomato</span>: I believe what is going on is that we do most sweeping in the background (and some in parallel as well), but there's a foreground-only prep phase needed before kicking the tasks off.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sat Mar 13 2021 16:30:35 GMT-0800 (Pacific Standard Time)">00:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the weird part is that if there are certain types of edges between two Zones, then they will impose ordering constraints on their sweeping. In practice, that means that all the collecting Zones get grouped into some number of sweep groups. All the zones in one sweep group are swept together.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sat Mar 13 2021 16:32:19 GMT-0800 (Pacific Standard Time)">00:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so I would expect to always see JSGC_BEGIN, one or more JSFINALIZE_GROUP_PREPARE -&gt; JSFINALIZE_GROUP_START -&gt; JSFINALIZE_GROUP_END (possibly interleaved if there are multiple sweep groups, or perhaps they are never interleaved, I don't know), and only after the last JSFINALIZE_GROUP_END has come in, GC end.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sat Mar 13 2021 16:32:57 GMT-0800 (Pacific Standard Time)">00:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if I get a chance, I can look further to get more precise about what's going on. (Or I won't, and jonco will answer it off the top of his head on Monday.)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sat Mar 13 2021 17:37:44 GMT-0800 (Pacific Standard Time)">01:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ptomato:gnome.org">ptomato</span>&gt;</div></td><td class="msg-cell">thanks! that would be enlightening :-)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sun Mar 14 2021 01:20:16 GMT-0800 (Pacific Standard Time)">09:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I'm just looking through Deno right now, how much effort is it to implement a <code>setTimeout</code></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sun Mar 14 2021 01:20:33 GMT-0800 (Pacific Standard Time)">09:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">cause it seems like <em>quite</em> a lot</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sun Mar 14 2021 01:30:27 GMT-0800 (Pacific Standard Time)">09:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you'll need to handle a kind of job/task queue, and dispatch it based on timer.  a job queue handling itself is already provided by SpiderMonkey, as part of Promise handling (see <code>JS::JobQueue</code>, <code>JS::SetJobQueue</code>), but it's independent from timer, and Firefox (gecko) is using different layer of task handling for the timer (microtasks vs tasks, in term of HTML spec)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sun Mar 14 2021 01:41:02 GMT-0800 (Pacific Standard Time)">09:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">so.... a lot of effort to follow the ES spec</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sun Mar 14 2021 01:42:36 GMT-0800 (Pacific Standard Time)">09:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the task/job handling is both in ES spec and HTML spec.  so, it depends on whether your application/embedding follows HTML spec</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sun Mar 14 2021 01:43:03 GMT-0800 (Pacific Standard Time)">09:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://tc39.es/ecma262/#sec-jobs">https://tc39.es/ecma262/#sec-jobs</a> and <a href="https://html.spec.whatwg.org/#integration-with-javascript-jobs">https://html.spec.whatwg.org/#integration-with-javascript-jobs</a></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sun Mar 14 2021 01:44:23 GMT-0800 (Pacific Standard Time)">09:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ES spec has some requirements (it's in section 9.4 above), and HTML spec defines the detailed steps</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sun Mar 14 2021 01:45:23 GMT-0800 (Pacific Standard Time)">09:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(and... <code>setTimeout</code> isn't part of ES)</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sun Mar 14 2021 01:46:26 GMT-0800 (Pacific Standard Time)">09:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">hm, i see</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sun Mar 14 2021 01:51:13 GMT-0800 (Pacific Standard Time)">09:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">so, TL;DR very hard</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sun Mar 14 2021 01:53:23 GMT-0800 (Pacific Standard Time)">09:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I shall hence, ignore the timers for now and go on to es modules</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sun Mar 14 2021 04:07:11 GMT-0700 (Pacific Daylight Time)">11:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">how does one check if a <code>JSObject</code>/<code>JS::RootedObject</code> contains any keys</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sun Mar 14 2021 04:09:24 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Redfire</span>: if it's about own property, <code>JS_HasOwnPropertyById</code>, or <code>JS_HasOwnProperty</code></td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sun Mar 14 2021 04:17:03 GMT-0700 (Pacific Daylight Time)">11:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">also, how does one initialise a <code>SourceText</code> using rust-mozjs, I can't seem to find anything</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Sun Mar 14 2021 04:19:43 GMT-0700 (Pacific Daylight Time)">11:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">oh wait, found it</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Sun Mar 14 2021 04:19:47 GMT-0700 (Pacific Daylight Time)">11:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><a href="https://doc.servo.org/mozjs/rust/fn.transform_u16_to_source_text.html">https://doc.servo.org/mozjs/rust/fn.transform_u16_to_source_text.html</a></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Sun Mar 14 2021 05:57:51 GMT-0700 (Pacific Daylight Time)">12:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">hmm, rust-mozjs has a macro for <code>CapturedJSStack</code> but I still can't seem to find a way to get the exception</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Sun Mar 14 2021 05:58:43 GMT-0700 (Pacific Daylight Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">JS_GetPendingException ?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Sun Mar 14 2021 06:00:14 GMT-0700 (Pacific Daylight Time)">13:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">there's no param or similar to use the exception from that in <code>CapturedJSStack</code> as far as i can see</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Sun Mar 14 2021 06:01:49 GMT-0700 (Pacific Daylight Time)">13:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">unless...</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Sun Mar 14 2021 06:02:02 GMT-0700 (Pacific Daylight Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">i use the <code>new</code> method instead of the macro</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Sun Mar 14 2021 06:14:14 GMT-0700 (Pacific Daylight Time)">13:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><p>hmm, not working</p>
<pre><code class="language-rs">			if JS_IsExceptionPending(rt.cx()) {
				rooted!(in(rt.cx()) let mut rval = UndefinedValue());
				if JS_GetPendingException(rt.cx(), rval.handle_mut().into()) {
					rooted!(in(rt.cx()) let mut obj = rval.get().to_object());

					let stack = CapturedJSStack::new(rt.cx(), obj, None);
					let js_stack = stack.and_then(|s| s.as_string(None, StackFormat::SpiderMonkey));
					if let Some(stack_trace) = js_stack {
						println!("{}", stack_trace);
					}

					JS_ClearPendingException(rt.cx());
				}
			}
</code></pre>
</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Sun Mar 14 2021 06:14:41 GMT-0700 (Pacific Daylight Time)">13:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">the <code>stack_trace</code> is just an empty string rn</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Sun Mar 14 2021 06:17:33 GMT-0700 (Pacific Daylight Time)">13:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">looks like CapturedJSStack always captures the current stack <a href="https://doc.servo.org/src/mozjs/rust.rs.html#1332">https://doc.servo.org/src/mozjs/rust.rs.html#1332</a></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Sun Mar 14 2021 06:20:50 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><p>that means that this would have the same result(which it does)</p>
<pre><code class="language-rs">			if JS_IsExceptionPending(rt.cx()) {
				capture_stack!(in(rt.cx()) let stack);
				let js_stack = stack.and_then(|s| s.as_string(None, StackFormat::SpiderMonkey));
				if let Some(stack_trace) = js_stack {
					println!("{}", stack_trace);
				}

				JS_ClearPendingException(rt.cx());
			}
</code></pre>
</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Sun Mar 14 2021 06:24:02 GMT-0700 (Pacific Daylight Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">(i dont think the <code>JS_IsExceptionPending</code> matters anymore either but that's not the problem rn)</td></tr>

</tbody></table></div></div></div>
</body></html>