<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-05-05</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-05-05<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-05-04" class="nav-link"><span>prev</span></a>
<a href="2022-05-06" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu May 05 2022 04:57:27 GMT-0700 (Pacific Daylight Time)">11:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@gsvelto:mozilla.org">gsvelto</span>&gt;</div></td><td class="msg-cell"><p>Alright I'm really butting my head against a failing test and I need some help to sort it out. The background is that in bug 1670885 I'm replacing some deprecated spinlocks used by the memory allocator under macOS for some new ones which are supported. This fixes a bunch of concrete issues related to the old tests causing live-locks, causing Firefox to hang on loaded machines. My patch seems to break a single jit-test, only in debug builds, only in macOS 10.15 and only on try. I attempted to reproduce the failure locally but couldn't which makes debugging it almost impossible.</p>
<p>The failure is in the <code>tests/jit-test/jit-test/tests/wasm/caching.js</code> test and appears to prevent a process from being spawned: <a href="https://treeherder.mozilla.org/logviewer?job_id=376779493&amp;repo=try&amp;lineNumber=12855-12859">https://treeherder.mozilla.org/logviewer?job_id=376779493&amp;repo=try&amp;lineNumber=12855-12859</a></p>
<p>Given the specificity of the failure I'm inclined to think we're hitting a macOS bug, especially because it's on 10.15 and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1676343">we've already wasted a ton of time on its locking bugs</a>. So my question is: can the test be disabled just on that platform? I've noticed that I could disable it for macOS by adding this line to the test:</p>
<p><code>// |jit-test| skip-if: getBuildConfiguration()['osx']</code></p>
<p>Is there a way to make it more specific and ensure it runs on more recent versions of macOS?</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu May 05 2022 04:57:29 GMT-0700 (Pacific Daylight Time)">11:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1670885">https://bugzil.la/1670885</a> — ASSIGNED (gsvelto) — Replace deprecated OSSpinLock with os_unfair_lock</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu May 05 2022 06:34:38 GMT-0700 (Pacific Daylight Time)">13:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>Alright I'm really butting my head against a failing test and I need some help to sort it out. The background is that in bug 1670885 I'm replacing some deprecated spinlocks used by the memory allocator under macOS for some new ones which are supported. This fixes a bunch of concrete issues related to the old tests causing live-locks, causing Firefox to hang on loaded machines. My patch seems to break a single jit-test, only in debug builds, only in macOS 10.15 and only on try. I attempted to reproduce the failure locally but couldn't which makes debugging it almost impossible.</p>
<p>The failure is in the <code>tests/jit-test/jit-test/tests/wasm/caching.js</code> test and appears to prevent a process from being spawned: <a href="https://treeherder.mozilla.org/logviewer?job_id=376779493&amp;repo=try&amp;lineNumber=12855-12859">https://treeherder.mozilla.org/logviewer?job_id=376779493&amp;repo=try&amp;lineNumber=12855-12859</a></p>
<p>Given the specificity of the failure I'm inclined to think we're hitting a macOS bug, especially because it's on 10.15 and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1676343">we've already wasted a ton of time on its locking bugs</a>. So my question is: can the test be disabled just on that platform? I've noticed that I could disable it for macOS by adding this line to the test:</p>
<p><code>// |jit-test| skip-if: getBuildConfiguration()['osx']</code></p>
<p>Is there a way to make it more specific and ensure it runs on more recent versions of macOS?</p>
</blockquote></mx-reply><p>You could probably tweak the <a href="https://searchfox.org/mozilla-central/source/js/src/builtin/TestingFunctions.cpp#228">definition of GetBuildConfiguration</a> to include a version, which you could then use in a skip-if expression, or in this case perhaps better, early-return in the test case with a comment.</p>
<p>Especially given coverage is maintained elsewhere, I don't think anyone would be too upset</p>
</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu May 05 2022 06:58:47 GMT-0700 (Pacific Daylight Time)">13:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>You could probably tweak the <a href="https://searchfox.org/mozilla-central/source/js/src/builtin/TestingFunctions.cpp#228">definition of GetBuildConfiguration</a> to include a version, which you could then use in a skip-if expression, or in this case perhaps better, early-return in the test case with a comment.</p>
<p>Especially given coverage is maintained elsewhere, I don't think anyone would be too upset</p>
</blockquote></mx-reply>Yeah, we've recently greatly increased our wasm caching coverage so disabling that test on a specific OSX version is not a problem.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu May 05 2022 07:11:56 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@gsvelto:mozilla.org">gsvelto</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span> <span class="nick-16">Ryan Hunt</span> thanks! I'll give extending <code>getBuildConfiguration()</code> a spin</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu May 05 2022 10:54:40 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">confession: creating the ShadowRealm globals is... more complicated than I expected! </td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu May 05 2022 10:54:43 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu May 05 2022 14:26:48 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">confession: First working host integration test case for shadow realms. </td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu May 05 2022 14:26:50 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>

</tbody></table></div></div></div>
</body></html>