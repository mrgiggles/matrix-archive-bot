<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-02-10</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-02-10<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-02-09" class="nav-link"><span>prev</span></a>
<a href="2024-02-12" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Feb 09 2024 16:04:23 GMT-0800 (Pacific Standard Time)">00:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Gijs</span>: Good question. The script source and the bytecode are shared. If I'm reading <a href="https://searchfox.org/mozilla-central/source/js/src/vm/SharedStencil.h#375-376">this comment</a> correctly, they are shared across zones, so probably per-thread. (I don't know if we share across workers.) Jit code, inline caches, GC things owned by the script (string and bigint constants, object literals, etc), and other things of that nature are duplicated per-instance.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Feb 09 2024 16:05:32 GMT-0800 (Pacific Standard Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@gijs:mozilla.org">Gijs</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: thanks, that's helpful! I don't suppose we expose that as a separate "line item" in some way in about:memory or some other piece of instrumentation?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Feb 09 2024 16:06:41 GMT-0800 (Pacific Standard Time)">00:06</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-13" title="@gijs:mozilla.org">Gijs</span></div></td><td class="msg-cell">is looking at how to cut down <code>browser.js</code> from being the 10k-line monstrosity that it is, and is wondering if there would be [significant] runtime memory benefits to shifting some of the code into <code>sys.mjs</code> singleton modules instead</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Feb 09 2024 16:07:13 GMT-0800 (Pacific Standard Time)">00:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@gijs:mozilla.org">Gijs</span>&gt;</div></td><td class="msg-cell">ISTM there will be at least some in terms of cases where we currently e.g. mirror prefs into memory, or have observers, we'll have only 1 per Firefox instance instead of 1 per window</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Feb 09 2024 16:07:32 GMT-0800 (Pacific Standard Time)">00:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't know this area well, but I do see that we have <a href="https://searchfox.org/mozilla-central/source/js/src/vm/MemoryMetrics.cpp#343-349">this code</a> that is giving special handling to script source for memory reporting</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Feb 09 2024 16:07:41 GMT-0800 (Pacific Standard Time)">00:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@gijs:mozilla.org">Gijs</span>&gt;</div></td><td class="msg-cell">but unclear how I'd get a sense of how big a win that'd be other than "do the work", which will obviously be a bit of a "long hard slog" kind of job :-)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Feb 09 2024 16:08:17 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@gijs:mozilla.org">Gijs</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: isn't that code specific to wasm?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Feb 09 2024 16:08:35 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@gijs:mozilla.org">Gijs</span>&gt;</div></td><td class="msg-cell">(at least I assume that's what <code>WasmModuleObject</code> means...)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Feb 09 2024 16:08:45 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Sorry, there's another call to the same helper lower down: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/MemoryMetrics.cpp#396">https://searchfox.org/mozilla-central/source/js/src/vm/MemoryMetrics.cpp#396</a></td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Feb 09 2024 16:08:51 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I linked that one because it had a comment</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Feb 09 2024 16:11:01 GMT-0800 (Pacific Standard Time)">00:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">One complication is that IIUC the bytecode for a script belongs to the <a href="https://searchfox.org/mozilla-central/source/js/src/vm/SharedStencil.h#428">ImmutableScriptData</a>, which is a different thing than the <a href="https://searchfox.org/mozilla-central/source/js/src/vm/JSScript.h#407">ScriptSource</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Feb 09 2024 16:11:09 GMT-0800 (Pacific Standard Time)">00:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't know how the memory accounting is done for ImmutableScriptData</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Feb 09 2024 16:20:02 GMT-0800 (Pacific Standard Time)">00:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>*/runtime/script-data</code> in about:memory represents ImmutableScriptData size</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Feb 09 2024 16:23:04 GMT-0800 (Pacific Standard Time)">00:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, it's not about memory win tho, moving large script into <code>sys.mjs</code> will reduce the cost of de-duplicating the ImmutableScriptData across multiple compilations</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Feb 09 2024 16:24:22 GMT-0800 (Pacific Standard Time)">00:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, it doesn't apply to <code>&lt;script&gt;</code> stored in cache, but iirc loadsubscript doesn't cache?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Feb 09 2024 16:25:20 GMT-0800 (Pacific Standard Time)">00:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Gijs</span>: Is each step of the long hard slog difficult, or could you try splitting out a small isolated chunk of <code>browser.js</code> and measure the effect on memory usage before committing to shifting anything else?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Feb 09 2024 16:33:04 GMT-0800 (Pacific Standard Time)">00:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Gijs</span>: I hacked up a thing a few years ago to let you record the size of individual objects in a GC log, which you can use with a dominator tree analysis to figure out how much memory individual scripts are holding alive. I don't know if it still works but it might. There are some examples of the output here: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463569#c7">https://bugzilla.mozilla.org/show_bug.cgi?id=1463569#c7</a></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Feb 09 2024 16:36:11 GMT-0800 (Pacific Standard Time)">00:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">(kmag used it to reduce the size of some content process scripts for Fission)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sat Feb 10 2024 04:08:57 GMT-0800 (Pacific Standard Time)">12:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@gijs:mozilla.org">Gijs</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: loadSubScript used to cache in some ways, a long time ago when I was still a volunteer I added an explicit flag to bypass cache, because of extension usecases.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sat Feb 10 2024 04:11:03 GMT-0800 (Pacific Standard Time)">12:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@gijs:mozilla.org">Gijs</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: that's a good question. If I can find some output / method that gets me accurate enough measurements then that could work. I think my fear is that there's too much variability when measuring "run a full-scale browser window", in terms of when idle tasks run, when I press the GC/CC buttons, etc., that it'll be hard to measure reliably for "small" changes.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Sat Feb 10 2024 04:12:29 GMT-0800 (Pacific Standard Time)">12:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@gijs:mozilla.org">Gijs</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/09681126c79cd415e41a44e978f30d61c08de7e8/js/xpconnect/idl/mozIJSSubScriptLoader.idl#42">https://searchfox.org/mozilla-central/rev/09681126c79cd415e41a44e978f30d61c08de7e8/js/xpconnect/idl/mozIJSSubScriptLoader.idl#42</a> was the subscript thing I was thinking of. Though it looks like I was just about an employee at that point.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Sat Feb 10 2024 04:14:43 GMT-0800 (Pacific Standard Time)">12:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">good to know that :) so, given <code>browser.js</code> is <a href="https://searchfox.org/mozilla-central/rev/09681126c79cd415e41a44e978f30d61c08de7e8/browser/base/content/global-scripts.inc#15">loaded with loadSubScript</a>, moving part of it to sys.mjs should improve the time taken by compilation for subsequent window open</td></tr>

</tbody></table></div></div></div>
</body></html>