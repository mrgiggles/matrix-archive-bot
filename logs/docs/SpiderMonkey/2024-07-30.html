<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-07-30</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-07-30<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-07-29" class="nav-link"><span>prev</span></a>
<a href="2024-07-31" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jul 30 2024 13:00:59 GMT-0700 (Pacific Daylight Time)">20:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Regarding JS_RequestInterruptCallback, what happens if we didn't call JS_AddInterruptCallback?

Does execution still stop, but with no callback?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jul 30 2024 13:05:24 GMT-0700 (Pacific Daylight Time)">20:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: Roughly speaking: nothing happens. At various points during execution the engine checks to see if an interrupt has been requested. If it has, it calls into <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Runtime.cpp#392-456">this code</a>. If no callbacks have been registered, I think we will just end up returning back to the interrupted code.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jul 30 2024 13:06:11 GMT-0700 (Pacific Daylight Time)">20:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">kfjvj</span>: Roughly speaking: nothing happens. At various points during execution the engine checks to see if an interrupt has been requested. If it has, it calls into <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Runtime.cpp#392-456">this code</a>. If no callbacks have been registered, I think we will just end up returning back to the interrupted code.</blockquote></mx-reply>In that case, what should I do in my callback to actually interrupt execution?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jul 30 2024 13:06:26 GMT-0700 (Pacific Daylight Time)">20:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you want execution to terminate, return <code>false</code>.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jul 30 2024 13:06:43 GMT-0700 (Pacific Daylight Time)">20:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, so the callback's return value determines what happens.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jul 30 2024 13:07:52 GMT-0700 (Pacific Daylight Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Another question: If the interrupt returns false, does anything happen to the job queue?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jul 30 2024 13:09:16 GMT-0700 (Pacific Daylight Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I can't think of any mechanism that would affect the job queue directly</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jul 30 2024 13:09:28 GMT-0700 (Pacific Daylight Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">So it would be up to us to clean that up</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jul 30 2024 13:12:40 GMT-0700 (Pacific Daylight Time)">20:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/jsfriendapi.h#238-250">StopDrainingJobQueue</a> might be relevant</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jul 30 2024 13:16:39 GMT-0700 (Pacific Daylight Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-4">iain</span>:  Also, I noticed something here: <a href="https://searchfox.org/mozilla-central/source/js/public/Interrupt.h#28">https://searchfox.org/mozilla-central/source/js/public/Interrupt.h#28</a></p>
<p>The comments refer to additional callbacks and ensuring that a callback is "disconnected".  Can you clarify what is meant here?</p>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jul 30 2024 13:45:31 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It looks like that part of the comment <a href="https://searchfox.org/mozilla-central/rev/a7e69522d87dc02a8c823afe2be17afe0abfc039/js/src/jsapi.h#759-761">hasn't been touched</a> since the <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=477187">first version of this code 15 years ago</a>. Broadly speaking I think the point is that if you call back into the engine from inside your callback, then it's possible for another interrupt to occur, and you should be prepared for that.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jul 30 2024 13:46:26 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It looks like that part of the comment <a href="https://searchfox.org/mozilla-central/rev/a7e69522d87dc02a8c823afe2be17afe0abfc039/js/src/jsapi.h#759-761">hasn't been touched</a> since the <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=477187">first version of this code 15 years ago</a>. Broadly speaking I think the point is that if you call back into the engine from inside your callback, then it's possible for another interrupt to occur, and you should be prepared for that.</blockquote></mx-reply>What would qualify as "calling back into the engine"?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jul 30 2024 13:54:03 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In theory: anything that can run JS code or hit one of <a href="https://searchfox.org/mozilla-central/search?path=&amp;q=checkforinterrupt">these calls to CheckForInterrupt</a>. In practice, somebody needs to actually request an interrupt, so you're unlikely to be re-interrupted unless you are using some sort of watchdog timer thread, and you spend too long in your interrupt handler</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jul 30 2024 13:57:03 GMT-0700 (Pacific Daylight Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> In theory: anything that can run JS code or hit one of <a href="https://searchfox.org/mozilla-central/search?path=&amp;q=checkforinterrupt">these calls to CheckForInterrupt</a>. In practice, somebody needs to actually request an interrupt, so you're unlikely to be re-interrupted unless you are using some sort of watchdog timer thread, and you spend too long in your interrupt handler</blockquote></mx-reply>I am 100% doing this as part of a watchdog timer.  But I'll make sure I don't call into any other JS code.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jul 30 2024 13:58:23 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't see any code that would explode in unusual ways if you had a reentrant interrupt, but it's the sort of thing that can often surprise you, so I would advise you to keep your interrupt callbacks short and simple</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jul 30 2024 13:58:54 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I'll do my best, and I'll just use a mutex if I need to do anything more complicated.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jul 30 2024 14:00:36 GMT-0700 (Pacific Daylight Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Hang on... would a re-entry into the interrupt be on the same call stack as the original interrupt?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jul 30 2024 14:15:02 GMT-0700 (Pacific Daylight Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yes.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jul 30 2024 14:18:38 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The underlying mechanism here is just that we periodically check a flag while running JS (or while doing some other long-running operation that we want to be able to interrupt if it takes too long). Each JSContext (aka thread) has its own flag. The flag can be set from any thread to request an interrupt.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jul 30 2024 14:19:13 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But in  every case, it's just a matter of the JSContext thread seeing that an interrupt has been requested and calling the callback.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jul 30 2024 14:19:16 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There's no real magic here.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jul 30 2024 14:31:35 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Well, there's a bit of handwaving magic in terms of <a href="https://searchfox.org/mozilla-central/source/js/src/vm/JSContext.h#815-833">how we justify our use of relaxed atomics</a>)</td></tr>

</tbody></table></div></div></div>
</body></html>