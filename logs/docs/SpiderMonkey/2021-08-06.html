<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-08-06</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-08-06<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-08-05" class="nav-link"><span>prev</span></a>
<a href="2021-08-07" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Aug 05 2021 18:23:09 GMT-0700 (Pacific Daylight Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">fitzgen</span>: in debug build, <code>DumpMessage</code> function, or <code>dbg</code> macro in <code>js/src/builtin/Utilities.js</code> that appends file+line</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Aug 06 2021 02:22:48 GMT-0700 (Pacific Daylight Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Do we have any policy / guidelines on adding large data files / increasing binary size? Asking wrt <a href="https://phabricator.services.mozilla.com/D121894">https://phabricator.services.mozilla.com/D121894</a></blockquote></mx-reply>I do not recall any past event similar to this one. Is this only for testing or shipped in the compiled binary? For very large file which are not changed as frequently as Firefox, we usually attempt to download them on the first run.  If this is only for testing, I do not see the point, as this kind of test would probably be better at the ICU library level than in the JS test suite which focus on the integration.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Aug 06 2021 03:05:22 GMT-0700 (Pacific Daylight Time)">10:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">writing testcase with Xray is very confusing... :/</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Aug 06 2021 04:56:49 GMT-0700 (Pacific Daylight Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: is it possible to also add a jit-test for the promise patch? we have testing functions to get an object's global</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Aug 06 2021 04:58:41 GMT-0700 (Pacific Daylight Time)">11:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if we add a testing function to get jobs in internal job queue, it would be possible</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Aug 06 2021 04:59:01 GMT-0700 (Pacific Daylight Time)">11:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'll look into it</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Aug 06 2021 05:00:15 GMT-0700 (Pacific Daylight Time)">12:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that function would be fuzzing-unsafe of course</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Aug 06 2021 05:01:18 GMT-0700 (Pacific Daylight Time)">12:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">ah I still have to look at the patch in detail. If it's a lot of work then feel free to ignore</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Aug 06 2021 05:11:46 GMT-0700 (Pacific Daylight Time)">12:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: ^</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Aug 06 2021 05:12:03 GMT-0700 (Pacific Daylight Time)">12:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I see</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Aug 06 2021 05:36:09 GMT-0700 (Pacific Daylight Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think the testcase is simple enough</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Aug 06 2021 05:36:14 GMT-0700 (Pacific Daylight Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">will add it</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Aug 06 2021 05:36:40 GMT-0700 (Pacific Daylight Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Aug 06 2021 05:40:39 GMT-0700 (Pacific Daylight Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">actually I was wondering if we can add testcase for "check if we can run script" part in JS shell, and this seems to be a good solution without actually introducing the branch into the internal job queue</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Aug 06 2021 06:45:56 GMT-0700 (Pacific Daylight Time)">13:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@ewlsh:gnome.org">ewlsh</span>&gt;</div></td><td class="msg-cell">I'm trying to construct a native-backed function with a given prototype to mimic the static inheritance of ES2015 classes but I can't find a way to do that through the jsapi without calling SetPrototype.

Are there performance implications for native functions still? Their subclasses?

And/or any API ideas? js::NewFunctionWithGivenProto is internal and constructing from the built-in class doesn't let me set the native function ðŸ¤”</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Aug 06 2021 06:58:57 GMT-0700 (Pacific Daylight Time)">13:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">ewlsh</span>: which version are you on? prototype changes should be fine perf-wise since 83-85 and it has improved more with 91</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Aug 06 2021 07:19:36 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@ewlsh:gnome.org">ewlsh</span>&gt;</div></td><td class="msg-cell">78, though we're upgrading to 91esr soon</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Aug 06 2021 07:28:47 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">we could expose <code>NewFunctionWithGivenProto</code> but changing the proto is probably simplest for you especially if you're upgrading soon</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Aug 06 2021 07:39:38 GMT-0700 (Pacific Daylight Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@ewlsh:gnome.org">ewlsh</span>&gt;</div></td><td class="msg-cell">Are there any remaining performance worries? For context, this would trigger SetPrototype on the constructor of most of our classes that wrap native objects</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Aug 06 2021 07:40:19 GMT-0700 (Pacific Daylight Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@ewlsh:gnome.org">ewlsh</span>&gt;</div></td><td class="msg-cell">The prototypes of these functions (and their given Prototypes) would be untouched though</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Aug 06 2021 07:47:00 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">performance could be a concern for 78. With 91, changing an object's prototype gives the object a new shape for the new proto but after that it's equivalent to allocating the object with that proto upfront</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Aug 06 2021 07:47:36 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">(it's a bit more complicated for objects that are already on another object's prototype chain, but I don't think you're doing that)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Aug 06 2021 07:48:13 GMT-0700 (Pacific Daylight Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@ewlsh:gnome.org">ewlsh</span>&gt;</div></td><td class="msg-cell">Essentially we're doing JS_NewFunction and then JS_SetPrototype</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Aug 06 2021 07:48:36 GMT-0700 (Pacific Daylight Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@ewlsh:gnome.org">ewlsh</span>&gt;</div></td><td class="msg-cell">And we'd wait until post-91 then</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Aug 06 2021 07:49:46 GMT-0700 (Pacific Daylight Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">with 91 these two calls will be equivalent to NewFunctionWithGivenProto, after that point, as far as I know</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Aug 06 2021 07:59:24 GMT-0700 (Pacific Daylight Time)">14:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@ewlsh:gnome.org">ewlsh</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: thanks for the help ðŸ˜„</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Aug 06 2021 08:00:57 GMT-0700 (Pacific Daylight Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">no problem, please let us know if you notice any perf/memory improvements or regressions from the 78 =&gt; 91 upgrade (it <em>should</em> be better!)</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Aug 06 2021 08:40:09 GMT-0700 (Pacific Daylight Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@fabrice:mozilla.org">fabrice</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: we are seeing main thread freezing issues on low-memory devices (32 bits ARM) after the changes in bug 1434542. Do you have ideas on what/how to investigate?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Aug 06 2021 08:40:12 GMT-0700 (Pacific Daylight Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1434542">https://bugzil.la/1434542</a> â€” RESOLVED (jonco) â€” Reduce non-incremental GCs by increasing the slice budget as we approach the non-incremental threshold</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Aug 06 2021 08:45:54 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> can anyone help investigating regression/behavior change observed in <a href="https://phabricator.services.mozilla.com/D119426">https://phabricator.services.mozilla.com/D119426</a> ?  it's for bug 531915</blockquote></mx-reply>anyone available for looking into this?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Aug 06 2021 09:08:15 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I agree with your concern on the additional branch, at least for non-jitted calls. This is something which can be solved by using a function pointer which is set to either one function or the other when the preference is toggled.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Aug 06 2021 09:10:02 GMT-0700 (Pacific Daylight Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">nbp: could the branch in non-jitted case affect the benchmark score so much?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Aug 06 2021 09:11:41 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I have not yet seen benchmark results, I skimmed through quickly.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Aug 06 2021 09:12:01 GMT-0700 (Pacific Daylight Time)">16:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I see</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Aug 06 2021 09:14:29 GMT-0700 (Pacific Daylight Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sanketh: can you try removing the branch in not-inlined case, for fdlibm=false case, and check the benchmark?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Aug 06 2021 09:18:36 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I may suggest one thing to test, which is to reorder symbols based on where they come from: group fdlibm together and native togeter instead of interleaving the functions.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Aug 06 2021 09:19:48 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">nbp: symbols in source, or binary?</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Aug 06 2021 09:20:09 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">grouping in source will cause them to be <del>sorted</del> grouped in the binary as well.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Aug 06 2021 09:20:54 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, reorder the function definitions for math_* ?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Aug 06 2021 09:21:17 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Aug 06 2021 09:22:33 GMT-0700 (Pacific Daylight Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I have seen 6% sunspider increase by just shuffling code around, this can happen when code is too large, or when we have such tiny function, I suspect that executing the sin function might preload the body of the cos function in the i-cache.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Aug 06 2021 09:22:45 GMT-0700 (Pacific Daylight Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">(or the opposite)</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Aug 06 2021 09:23:13 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ah, sounds promising. thank you!</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Aug 06 2021 09:24:06 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sanketh: ^</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Aug 06 2021 09:24:23 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">promising I do not know, but this happens â€¦</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Aug 06 2021 09:24:49 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(I'll also post review comment later</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Aug 06 2021 09:56:01 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I wonder, if the function's placement inside the binary affects the performance much, shouldn't we try automating that for all functions?</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Aug 06 2021 09:57:46 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or perhaps, does PGO cover that?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Aug 06 2021 10:00:02 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I would be surprised if this is integrated in PGO, usually PGO focuses on inlining and moving infrequent branches.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Aug 06 2021 10:00:18 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">It would hardly guess temporal correlations between functions.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Aug 06 2021 10:01:05 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">And even less when this temporality is provided by JS code on the fly.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Aug 06 2021 10:03:50 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hm, I see</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Aug 06 2021 10:04:52 GMT-0700 (Pacific Daylight Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I thought I saw similar discussions for startup performance, but I don't remember the details</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Aug 06 2021 10:10:01 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">glandium</span>: made a tool to reverse the order of symbols such that they are loaded in the order of execution a long time ago, and this was a big deal for the first Firefox for Android at the time, IIRC.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Aug 06 2021 10:13:04 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">How big is the hot loop in those benchmarks? Won't everything be in cache anyway? </td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Aug 06 2021 10:16:09 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I've seen big performance changes in microbenchmarks from irrelevant changes in code position (eg we generate one fewer instruction at point A, and at point B thirty instructions later we suddenly get 10% slower), and the best explanation I've been able to come up with is that we've changed where the code is laid out relative to the beginning of the cache line</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Aug 06 2021 10:16:18 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">i-cache aliasing are ineffable!</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Aug 06 2021 10:16:47 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which is unfortunate for that particular microbenchmark, but not a good reason to (for example) disable the optimization that removed the instruction at point A</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Aug 06 2021 10:17:00 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is it about the size of JIT compiled generated code?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Aug 06 2021 10:17:33 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">No, in this case the generated code would look the same.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Aug 06 2021 10:19:10 GMT-0700 (Pacific Daylight Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Sometimes you make changes that are neutral or good on average, but happen to make a particular microbenchmark slower for reasons that you can't control</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Aug 06 2021 10:20:01 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And when that happens, the best respnse is often to just land the change anyway, because we don't expect the slowdown in the microbenchmark to generalize to real code</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Aug 06 2021 10:20:14 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I haven't looked closely enough at this case to know if we're in a situation like that, though</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Aug 06 2021 10:20:34 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The smaller the microbenchmark, the more likely it is to be a weird fluke</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Aug 06 2021 10:20:47 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ah, makes sense</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Aug 06 2021 10:20:54 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If it's showing up in multiple microbenchmarks then it's more likely to be a real problem</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Aug 06 2021 10:21:38 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so far, only in kraken audio-* on linux</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Aug 06 2021 10:22:35 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@fabrice:mozilla.org">fabrice</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-4">jonco</span>: we are seeing main thread freezing issues on low-memory devices (32 bits ARM) after the changes in bug 1434542. Do you have ideas on what/how to investigate?</blockquote></mx-reply>or <span class="nick-10">jandem</span> / anyone that knows the GC :)</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Aug 06 2021 10:22:51 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so it could be that it's just unfortunate regression as you said</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Aug 06 2021 10:24:29 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">fabrice</span>: would it be possible to either capture a profile, or run with env var <code>MOZ_GCTIMER=/tmp/gc.txt</code> ?</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Aug 06 2021 10:26:03 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">One example: when I was replacing the regex engine, I saw a 50% regression on one microbenchmark. After half a day of debugging, I found out that the hot loop was 11 instructions long, it was identical (aside from register allocation) in both cases, and adding a 4-byte nop before the hot loop made the regression disappear.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Aug 06 2021 10:26:19 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Hardware: you can't trust it</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Aug 06 2021 10:27:00 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Or you cannot trust the compiler for making good use of the hardware.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Aug 06 2021 10:27:10 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Compilers are clever dummies.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Aug 06 2021 10:27:12 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Of course not! I wrote the compiler!</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Aug 06 2021 10:27:34 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Trusting it would be silly :P</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Aug 06 2021 10:29:20 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@fabrice:mozilla.org">fabrice</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Ok, I will use the MOZ_GCTIMER var. Using the profiler at startup is difficult on these devices.</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Aug 06 2021 10:30:23 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you're seeing this during startup?</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Aug 06 2021 10:30:37 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><a href="https://preactjs.com/">https://preactjs.com/</a> â€” interesting.</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Aug 06 2021 10:31:51 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">"We work closely with browser engineers to get the maximum performance possible out of Preact."</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Aug 06 2021 10:32:10 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Anybody heard from them?</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Aug 06 2021 10:33:23 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we're not browser engineers, we're alternative browser engineers :-(</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Aug 06 2021 10:34:33 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I am listening to a conf which is bashing on react.</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Aug 06 2021 11:17:34 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@fabrice:mozilla.org">fabrice</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> you're seeing this during startup?</blockquote></mx-reply>early enough that it may be hard to profile.</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Aug 06 2021 12:23:18 GMT-0700 (Pacific Daylight Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@fabrice:mozilla.org">fabrice</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: here's a gc timer log: <a href="https://pastebin.com/P9y3iscU">https://pastebin.com/P9y3iscU</a></td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Aug 06 2021 13:40:51 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">fabrice</span>: I filed this as <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1724510">https://bugzilla.mozilla.org/show_bug.cgi?id=1724510</a> but the longest max pause in that log was 94ms. Is that what you mean by "freezes", or should we be looking for something else?</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Aug 06 2021 13:47:25 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@fabrice:mozilla.org">fabrice</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: we're still debugging and will comment in the bug - I'm seeing crashes in Statistics::computeMMU() but need to get a better stack</td></tr>

</tbody></table></div></div></div>
</body></html>