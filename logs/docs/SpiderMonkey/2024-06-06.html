<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-06-06</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-06-06<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-06-05" class="nav-link"><span>prev</span></a>
<a href="2024-06-07" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Jun 06 2024 02:31:02 GMT-0700 (Pacific Daylight Time)">09:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">The benefit of having 2 pile of tests, is that people who want to bikeshed will not realize that there is actually a third one named <code>jsapi-tests</code> ðŸ¤£</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jun 06 2024 02:31:58 GMT-0700 (Pacific Daylight Time)">09:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">(not counting the 4th one that nobody touched in decades, hidden in a subfolder)</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jun 06 2024 08:10:19 GMT-0700 (Pacific Daylight Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">alexical</span>: <span class="nick-13">jlink</span> The JS perf meeting is cancelled this week because it overlaps with our TC39 proposal review meeting</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jun 06 2024 08:35:49 GMT-0700 (Pacific Daylight Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: Oh wow. Your patch drops the jstests runtime from 164.0s to 34.7s on my machine... that's like 5x faster</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jun 06 2024 08:38:20 GMT-0700 (Pacific Daylight Time)">15:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">Sounds like you don't need a perf meeting anymore</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jun 06 2024 08:49:07 GMT-0700 (Pacific Daylight Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: nice! did jit-tests also improve? else jit-tests and jstests are pretty close</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jun 06 2024 08:49:37 GMT-0700 (Pacific Daylight Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">it did, but not 5x. 

I have this suspicion that part of the issue is test skipping </td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jun 06 2024 08:49:59 GMT-0700 (Pacific Daylight Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">but that was from me injecting a bunch of timing code </td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jun 06 2024 08:50:14 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Well â€¦ pretty close? That would be multiple years since I am unable to run jstests due to a miss matching python version.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jun 06 2024 08:51:35 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">so you can run both jit-tests and jstests in under a minute</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jun 06 2024 08:51:47 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(the parallel job dispatch is shared between the two) </td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jun 06 2024 08:52:00 GMT-0700 (Pacific Daylight Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">comfortably -- like 50s for both </td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jun 06 2024 08:59:08 GMT-0700 (Pacific Daylight Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>Oh darn I lied...</p>
<pre><code>$ time (./mach jstests &amp;&amp; ./mach jit-test)
[45759|    0|    0| 8586] 100% ======================================&gt;|  36.1s
PASS
[11514|    0|    0|    0] 100% ======================================&gt;|  22.1s
PASSED ALL

real    1m1.424s
user    27m53.893s
sys     17m39.674s
</code></pre>
</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jun 06 2024 09:43:32 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: While I suspect this is mostly moved code, git is not helping at confirming that as seems to think that some copied lines are being added ðŸ¤¦<br>I will look at it tomorrow morning.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jun 06 2024 09:45:31 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-16">Ryan Hunt</span>: While I suspect this is mostly moved code, git is not helping at confirming that as seems to think that some copied lines are being added ðŸ¤¦<br>I will look at it tomorrow morning.</blockquote></mx-reply>Yeah it should just be moving code. If I was still using hg, I used to be able to do hg cp to duplicate the file then remove the stuff I was moving, and then the diffs would understand it all. But I donâ€™t know the git equivalent</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jun 06 2024 09:45:52 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">Sorry for the churn, should hopefully not be too hard to read through</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Jun 06 2024 10:28:03 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">Hi - hopefully this isn't a bother (feel free to ignore if it is), but I'm working on a webpage and trying to make it a bit faster, and I've noticed that if I loop through a function in the console a couple hundred times (10s or so of string and DOM manipulation), that'll be followed up by a solid couple minutes of GC/CC work... is that to be expected (are there naturally pathological cases?  Am I doing something stupid?) or is there something someone might want to look at here?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Jun 06 2024 10:28:09 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">I am running nightly</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Jun 06 2024 10:29:46 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">(And in real use that function won't be constantly hammered to the same degree as when I'm doing looping through it to test, but I was a bit surprised by how long GC took)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Jun 06 2024 10:32:55 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that's insanely long. Make a <a href="https://profiler.firefox.com">profile</a> of it. It seems like it'd have to create a <em>lot</em> of stuff that's getting held onto for a while.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Jun 06 2024 10:34:49 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">what makes you think it's GC/CC? I mean, it's the obvious culprit when the browser goes away for a while, but I'm wondering if you have a specific reason to think it's that.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Jun 06 2024 10:38:51 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">I was profiling</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Jun 06 2024 10:46:44 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">Okay this is not near as bad as some of the ones I saw earlier (which I should've saved but didn't), but it's an example of what I'm looking at: <a href="https://share.firefox.dev/4eczTQB">https://share.firefox.dev/4eczTQB</a></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Jun 06 2024 10:46:54 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">(It seems a bit inconsistent in how bad it is, I'm still playing around with it and if I get one that shows it well I'll put it here.)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Jun 06 2024 10:51:12 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yep, it looks like you really pissed off the cycle collector</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Jun 06 2024 10:53:24 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">3.8M suspected objects sounds like a lot. This might be from the artificial nature of the test. I'm kind of curious how you managed to create so many CC'd objects. I recently briefly attempted to write a test that did that, and failed, and then I realized I didn't really need it for what I was working on anyway.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Jun 06 2024 10:53:49 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">Yeah I can send STR in a minute</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Jun 06 2024 10:53:56 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">Probably poorly written code on my part</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Jun 06 2024 10:54:11 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span> would you happen to have any thoughts? ^</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Jun 06 2024 10:57:14 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">Basically what I'm doing is iterating through an array (~700 elements), checking a couple properties against some filters, appending some HTML to a string if it passes, and then eventually setting innerHTML on an element (because somehow that's faster than everything else I've tried so far)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Jun 06 2024 10:58:12 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">do we seriously not have isCCW? </td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Jun 06 2024 10:58:15 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">as a shell helper... </td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Jun 06 2024 10:58:35 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">this seems worth filing a bug on</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Jun 06 2024 10:58:56 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">also a good test case for figuring out additional info to add to CC markers</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Jun 06 2024 10:59:20 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell"><a href="https://share.firefox.dev/3yRDunf">https://share.firefox.dev/3yRDunf</a> is a bad one</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Jun 06 2024 10:59:28 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">I'll go write a bug then</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Jun 06 2024 11:04:46 GMT-0700 (Pacific Daylight Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Basically what I'm doing is iterating through an array (~700 elements), checking a couple properties against some filters, appending some HTML to a string if it passes, and then eventually setting innerHTML on an element (because somehow that's faster than everything else I've tried so far)</blockquote></mx-reply>That kind of behavior usually means the page is leaking stuff. The CC is usually good at avoiding looking at stuff that is alive, but if you have DOM node that have been removed from the document, then we usually have to look at them and the CC is much slower per object than the GC. Mostly this only happens once when we clean up a page, but in leak-ish scenarios that stuff stays around for a long time.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Jun 06 2024 11:06:59 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1901090">https://bugzilla.mozilla.org/show_bug.cgi?id=1901090</a></td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Jun 06 2024 11:07:05 GMT-0700 (Pacific Daylight Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@japeter:mozilla.org">japeter</span>&gt;</div></td><td class="msg-cell">Advice on writing better code is also welcome</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Jun 06 2024 15:37:52 GMT-0700 (Pacific Daylight Time)">22:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: I think the title of bug 1900933 is misleading.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Jun 06 2024 15:37:54 GMT-0700 (Pacific Daylight Time)">22:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1900933">https://bugzil.la/1900933</a> â€” UNCONFIRMED (nobody) â€” WeakRef should be eligible for Nursery Garbage Collection</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Jun 06 2024 15:39:05 GMT-0700 (Pacific Daylight Time)">22:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The reporter doesn't actually care about minor vs major GC. He wants the targets of dead WeakRefs to be collectible without having to return to the event loop.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Jun 06 2024 15:50:05 GMT-0700 (Pacific Daylight Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right now we have a set of kept objects. I think if it was instead a map from kept objects to ref counts, and we decremented the ref count of the target when a WeakRef is finalized, then we could maybe remove objects from KeptObjects before we actually return to the event loop.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Jun 06 2024 15:51:44 GMT-0700 (Pacific Daylight Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">If I read it correctly, all he really wants is to be able to use WeakRefs to efficiently implement his Signals alternative implementation thing. He is under the impression that it will depend on prompt collection of WeakRefs and/or their targets (I'm still not clear if it's both), and he might be right about that. If so, it may very well require both fixing the unobservable KeptObjects problem you're talking about, as well as allowing minor GCs to collect these things not just major GCs.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Jun 06 2024 15:52:50 GMT-0700 (Pacific Daylight Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(under the assumption that major GCs for these would still be too expensive, which is an untested assumption right now given that his benchmark is not returning to the event loop)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Jun 06 2024 15:53:29 GMT-0700 (Pacific Daylight Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">whether his use case really requires this prompt cleanup is unclear to me; would these Signal-like things <em>really</em> create that much trash?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Jun 06 2024 15:53:58 GMT-0700 (Pacific Daylight Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the benchmark by itself isn't all that convincing</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Jun 06 2024 15:57:27 GMT-0700 (Pacific Daylight Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't think he has any evidence of needing weakrefs collected in minor GCs. I think he saw something somewhere in V8 about how they don't support nursery collection of WeakRefs, and leapt to the conclusion that that was his problem.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Jun 06 2024 16:00:11 GMT-0700 (Pacific Daylight Time)">23:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But maybe I'm misreading things.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Jun 06 2024 16:33:20 GMT-0700 (Pacific Daylight Time)">23:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Right now we have a set of kept objects. I think if it was instead a map from kept objects to ref counts, and we decremented the ref count of the target when a WeakRef is finalized, then we could maybe remove objects from KeptObjects before we actually return to the event loop.</blockquote></mx-reply>That's a good idea. Though a map from WeakRef -&gt; RefCnt&lt;target&gt; would require holding the WeakRef keys weakly, which somehow always ends up complicated. (Or use a WeakMap of WeakRef -&gt; target, but that's more expensive.) And I guess I haven't yet seen a reason why returning to the event loop is a problem.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Jun 06 2024 16:34:48 GMT-0700 (Pacific Daylight Time)">23:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't mean from WeakRef to RefCnt, I mean from target to refcnt. As I understand it, KeptObjects is currently a hash set of objects, and is strongly traced.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Jun 06 2024 16:36:01 GMT-0700 (Pacific Daylight Time)">23:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If instead of being a hash set with objects as the keys, it was a hash map with objects as the keys and ref counts as the values, then everything stays the same except that when the WeakRef finalizer decrements a ref count, we may remove the key from the hash map.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Jun 06 2024 16:37:12 GMT-0700 (Pacific Daylight Time)">23:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, that makes more sense than mine</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Jun 06 2024 16:38:25 GMT-0700 (Pacific Daylight Time)">23:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It all depends on my assertion that we don't care about the objects in KeptObjects if there are no reachable WeakRefs that target them.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Jun 06 2024 16:38:32 GMT-0700 (Pacific Daylight Time)">23:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so it's a map from target object to the number of WeakRefs with that target that were dereffed or initialized in the current turn?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Jun 06 2024 16:38:41 GMT-0700 (Pacific Daylight Time)">23:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, precisely</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Jun 06 2024 16:42:57 GMT-0700 (Pacific Daylight Time)">23:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think it's at least a little reasonable to be able to allocate a large number of weak refs in a single turn without leaking memory, provided that we can do so in a way that doesn't suck to implement or violate the spec</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Jun 06 2024 16:43:19 GMT-0700 (Pacific Daylight Time)">23:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and if you have a WeakRef to a cross-compartment wrapper to a target in another compartment, then we tell you to go to hell?</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Jun 06 2024 16:43:34 GMT-0700 (Pacific Daylight Time)">23:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I would certainly like to do this, yes</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Jun 06 2024 16:43:36 GMT-0700 (Pacific Daylight Time)">23:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe only if you nuke the ccw</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Jun 06 2024 16:44:30 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Why is that case different from any other target?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Jun 06 2024 16:45:02 GMT-0700 (Pacific Daylight Time)">23:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Do we have special handling for WeakRefs to CCWs? This is the sort of thing that could definitely throw a spanner in the works.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Jun 06 2024 16:46:40 GMT-0700 (Pacific Daylight Time)">23:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it might not be, I was just imagining that when you nuke the CCW, you might need to update these counters. But that doesn't actually seem that bad. Maybe I'm wrong, but I think WeakRef with a CCW target is already special because you don't want that CCW by itself to keep the actual target alive. I'm probably overthinking this.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Jun 06 2024 16:47:50 GMT-0700 (Pacific Daylight Time)">23:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I vaguely remember seeing some CCW stuff when I was skimming this code this morning, but whenever I see CCWs my brain develops a smooth protective outer layer and I cross my finger and hope somebody else knows what's up</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Jun 06 2024 16:47:55 GMT-0700 (Pacific Daylight Time)">23:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Oh, it looks like we finesse that by making the WeakRef be in the same zone as the target, and using a CCW to that WeakRef. Similar to typed arrays and arraybufers.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Jun 06 2024 16:48:11 GMT-0700 (Pacific Daylight Time)">23:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/59d854a90e036cfa77f3c5b70c8c6ef1d60ebb98/js/src/builtin/WeakRefObject.cpp#66-68">https://searchfox.org/mozilla-central/rev/59d854a90e036cfa77f3c5b70c8c6ef1d60ebb98/js/src/builtin/WeakRefObject.cpp#66-68</a></td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Jun 06 2024 16:48:23 GMT-0700 (Pacific Daylight Time)">23:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, so not a problem after all</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Jun 06 2024 16:49:30 GMT-0700 (Pacific Daylight Time)">23:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(besides, any tricky situations could probably be dealt with by disabling removals from the target-&gt;refcnt table; it'll get cleared at the end of the turn anyway)</td></tr>

</tbody></table></div></div></div>
</body></html>