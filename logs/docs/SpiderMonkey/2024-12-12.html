<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-12-12</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-12-12<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-12-11" class="nav-link"><span>prev</span></a>
<a href="2024-12-13" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Dec 11 2024 23:09:33 GMT-0800 (Pacific Standard Time)">07:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@fwang:igalia.com">FrÃ©dÃ©ric</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">evilpie</span>: In <a href="https://phabricator.services.mozilla.com/D229624">https://phabricator.services.mozilla.com/D229624</a>, I rewrote <code>AreArgumentsTrustedForEnsureCSPDoesNotBlockStringCompilation</code> to rely on an ErrorResult. Can you please double-check whether the exception handling stuff looks correct now?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Dec 12 2024 02:17:13 GMT-0800 (Pacific Standard Time)">10:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">does wasm::Log add a lot of overhead? I see it in pretty low level stuff</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Dec 12 2024 05:05:46 GMT-0800 (Pacific Standard Time)">13:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell"><p>Hello, do you know of any examples of implementing subclasses using <code>jsapi</code>? I'm struggling to get this working. I thought something like the code below would work, but I'm getting an error: <code>TypeError: ({}) is not a constructor</code></p>
<pre><code class="language-cpp">bool Derived::init_class(JSContext *cx, JS::HandleObject global) {
  // Init class with Parent proto:
  proto_obj_.init(cx, JS_InitClass(cx, global, &amp;class_, Parent::proto_obj_, "Derived",
                                  Derived::constructor, 0,
                                  nullptr, nullptr, nullptr, nullptr));

  return proto_obj_ != nullptr;
}

bool Derived::constructor(JSContext *cx, unsigned argc, JS::Value *vp) {
  CallArgs args = CallArgsFromVp(argc, vp);                                                        \

  RootedObject self(cx, JS_NewObjectForConstructor(cx, &amp;class_, args));
  if (!self) {
    return false;
  }

  RootedObject parent_ctor(cx, JS_GetConstructor(cx, Parent::proto_obj_));
  if (!parent_ctor) {
    return false;
  }

  MOZ_ASSERT(JS::IsConstructor(parent_ctor));

  RootedValue parent_ctor_val(cx, JS::ObjectValue(*parent_ctor));

  // Call construct with newTarget
  JS::RootedObject obj(cx);
  if (!JS::Construct(cx, parent_ctor_val, self, JS::HandleValueArray::empty(), &amp;obj)) {
      return false;
  }

  args.rval().setObject(*obj);
  return true;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Dec 12 2024 05:08:33 GMT-0800 (Pacific Standard Time)">13:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">It would be great if we could get an example of this in the <a href="https://github.com/bytecodealliance/spidermonkey-wasi-embedding">https://github.com/bytecodealliance/spidermonkey-wasi-embedding</a> repo ðŸ™‚<br>Sorry that's obviously a wrong link, I meant this: <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples</a></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Dec 12 2024 05:15:15 GMT-0800 (Pacific Standard Time)">13:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what is <code>Parent::proto_obj_</code> ?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Dec 12 2024 05:21:48 GMT-0800 (Pacific Standard Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell"><p>That would be proto of the Parent class:</p>
<pre><code class="language-cpp">class Parent {
public:
  static PersistentRooted&lt;JSObject *&gt; proto_obj_;

  static constructor(JSContext *cx, unsigned argc, JS::Value *vp);
}

bool Parent::init_class(JSContext *cx, JS::HandleObject global) {
  proto_obj_.init(cx, JS_InitClass(cx, global, &amp;class_, nullptr, "Parent",
                                  Parent::constructor, 0,
                                  nullptr, nullptr, nullptr, nullptr));

  return proto_obj_ != nullptr;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Dec 12 2024 05:22:14 GMT-0800 (Pacific Standard Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay. where is the error thrown in your code?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Dec 12 2024 05:25:10 GMT-0800 (Pacific Standard Time)">13:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">This line fails: <code>if (!JS::Construct(cx, parent_ctor_val, self, JS::HandleValueArray::empty(), &amp;obj))</code></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Dec 12 2024 05:25:33 GMT-0800 (Pacific Standard Time)">13:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is the <code>Parent::constructor</code> called?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Dec 12 2024 05:26:59 GMT-0800 (Pacific Standard Time)">13:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">No, it's not.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Dec 12 2024 05:29:27 GMT-0800 (Pacific Standard Time)">13:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, the newTarget parameter is wrong</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Dec 12 2024 05:32:02 GMT-0800 (Pacific Standard Time)">13:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">newTarget parameter should be a constructor, not a result of the constructor</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Dec 12 2024 05:32:30 GMT-0800 (Pacific Standard Time)">13:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and also, unless your <code>Parent::constructor</code> uses it, you don't have to pass it</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Dec 12 2024 05:34:24 GMT-0800 (Pacific Standard Time)">13:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">basically, you don't need to call <code>JS::Construct</code> inside <code>Derived::constructor</code> if parent constructor is also  native function</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Dec 12 2024 05:35:33 GMT-0800 (Pacific Standard Time)">13:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you create an object, and perform necessary initialization on it, and return.   if the parent constructor has some initialization that needs to be performed, you can move it to a helper function and call it from both parent and derived constructors</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Dec 12 2024 05:36:06 GMT-0800 (Pacific Standard Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">But how do I control what arguments to pass to parent if they are not the same?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Dec 12 2024 05:36:38 GMT-0800 (Pacific Standard Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the helper function can directly receive them</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Dec 12 2024 05:37:15 GMT-0800 (Pacific Standard Time)">13:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I mean, a C++ function</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Dec 12 2024 05:39:41 GMT-0800 (Pacific Standard Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell"><p>So having something like:</p>
<pre><code class="language-cpp">class Parent {
    JSObject *create(JSContext *cx, HandleValue val);
}
</code></pre>
<p>And call this from <code>Derived::constructor</code>?</p>
</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Dec 12 2024 05:40:49 GMT-0800 (Pacific Standard Time)">13:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">something like <code>bool init(JSContext* cx, JS::Handle&lt;JSObject*&gt; thisObj, JS::CallArgs args);</code></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Dec 12 2024 05:41:08 GMT-0800 (Pacific Standard Time)">13:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or maybe receive parameters separately with <code>bool init(JSContext* cx, JS::Handle&lt;JSObject*&gt; thisObj, JS::Handle&lt;JS::Value&gt; param0, ...);</code></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Dec 12 2024 05:42:07 GMT-0800 (Pacific Standard Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what actually do you want to do inside the parent constructor?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Dec 12 2024 05:44:42 GMT-0800 (Pacific Standard Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">The thing I'm trying to implement is the builtin <code>File : Blob</code>. So <code>File</code> interface that extends the <code>Blob</code> as described in spec: <a href="https://w3c.github.io/FileAPI/#file-section">https://w3c.github.io/FileAPI/#file-section</a><br>I already have the <code>Blob</code> implementation.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Dec 12 2024 05:45:32 GMT-0800 (Pacific Standard Time)">13:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, perform some file operation and then store the result into the object with <code>JS_InitReservedSlot</code> etc?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Dec 12 2024 05:48:01 GMT-0800 (Pacific Standard Time)">13:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">Sorry, but It's still unclear to me how I model the actual inheritance ðŸ™‚</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Dec 12 2024 05:49:51 GMT-0800 (Pacific Standard Time)">13:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">I can surely make it via composition and just embed the Blob in the File object slot, but that's a lot of boilerplate. I thought it should be possible to model this using SpiderMonkey primitives ðŸ™‚ </td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Dec 12 2024 05:52:09 GMT-0800 (Pacific Standard Time)">13:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell"><p>I thought using <code>Construct</code> is the way to go here based on the docs:</p>
<pre><code class="language-cpp"> // Construct() takes a `newTarget` argument that most callers don't need.
 // Consider using the four-argument Construct signature instead. (But if you're
 // implementing a subclass or a proxy handler's construct() method, this is the
 // right function to call.)
</code></pre>
</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Dec 12 2024 06:01:30 GMT-0800 (Pacific Standard Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, with raw JSAPI, you have more control over what you can do with plain JS's class.  like how to create the object and how to share the code between the parent and derived classes</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Dec 12 2024 06:03:03 GMT-0800 (Pacific Standard Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the parent class is written in JS, then you'll need to call <code>JS::Construct</code>.  if the parent class is some ECMAScript built-in, you'll need to do the same, or maybe there's some other way (not sure.  we're moving away from it)</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Dec 12 2024 06:03:25 GMT-0800 (Pacific Standard Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, if the parent class is also your own one, you can do it more directly</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Dec 12 2024 06:04:05 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and also, it depends on how the parent and derived classes' method works.  such as, what they expect the <code>this</code> value be</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Dec 12 2024 06:04:19 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">The parent class is own one, written in c++</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Dec 12 2024 06:05:27 GMT-0800 (Pacific Standard Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">Right, do you know of any example that I could use as a reference?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Dec 12 2024 06:06:01 GMT-0800 (Pacific Standard Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the parent class's method expects the <code>this</code> value have one reserved slot with the slot 0 being a pointer to certain C++ struct, then the derived class's <code>this</code> to have the same.  the derived class can have more reserved slots, but the slot 0 should have the same</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Dec 12 2024 06:06:52 GMT-0800 (Pacific Standard Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in this case, you can have a helper function that initializes the reserved slot 0 with appropriate value, and call it from both constructors</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Dec 12 2024 06:11:04 GMT-0800 (Pacific Standard Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm not aware of any simple one</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Dec 12 2024 06:25:49 GMT-0800 (Pacific Standard Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@tandr:mozilla.org">tandr</span>&gt;</div></td><td class="msg-cell">OK, thanks for your help <span class="nick-15">arai</span> Really appreciate that. I will try your suggestion.</td></tr>

</tbody></table></div></div></div>
</body></html>