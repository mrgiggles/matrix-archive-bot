<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-12-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-12-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-12-13" class="nav-link"><span>prev</span></a>
<a href="2021-12-15" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Dec 13 2021 16:02:44 GMT-0800 (Pacific Standard Time)">00:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">caroline</span>: by any chance would happen to be able to assist me w/ generating a CacheIR Health Report? SM is building flawlessly on this new Windows Server 2022 computer, but noticed that there's special configuration necessary (and may potentially need to rebuild) -- wonder if you'd be able to clarify some doubts i have re: <a href="https://carolinecullen.github.io/cacheirhealthreport/info.html">https://carolinecullen.github.io/cacheirhealthreport/info.html</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Dec 13 2021 16:04:26 GMT-0800 (Pacific Standard Time)">00:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">DerekNonGeneric</span>: Yeah!</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Dec 13 2021 16:05:18 GMT-0800 (Pacific Standard Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">DerekNonGeneric</span>: Is it not generating a report with those instructions/specifications?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Dec 13 2021 16:07:16 GMT-0800 (Pacific Standard Time)">00:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell">well, i still haven't set up the environment variables or modified any configs mentioned in those instructions (basically have only done step 1 ...)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Dec 13 2021 16:08:26 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell">do you know if it would be possible to set the environment variables</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Dec 13 2021 16:08:51 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell">... and modify the config BEFORE doing an initial build?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Dec 13 2021 16:09:38 GMT-0800 (Pacific Standard Time)">00:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell">I should reorder the steps to specify that enabling jit spew is required before building</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Dec 13 2021 16:10:12 GMT-0800 (Pacific Standard Time)">00:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell">thanks for pointing that out</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Dec 13 2021 16:12:36 GMT-0800 (Pacific Standard Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell">it was an honest question -- i wasn't even aware that a re-build would be necessary, but that doesn't seem like it would be too much to ask</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Dec 13 2021 16:13:20 GMT-0800 (Pacific Standard Time)">00:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell">going to make all these modifications now by following your steps :)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Dec 13 2021 16:15:09 GMT-0800 (Pacific Standard Time)">00:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell">yeah, youll need to add jit-spew and rebuild. let me know if you need any other pointers, going to fix the steps now!</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Dec 13 2021 16:17:25 GMT-0800 (Pacific Standard Time)">00:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-13">caroline</span>: one more thing regarding this instruction:</p>
<blockquote>
<p>note: for this option you must set security.sandbox.content.level to 1 in about:config</p>
</blockquote>
<p>does this mean that i need to build the whole browser?</p>
</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Dec 13 2021 16:25:48 GMT-0800 (Pacific Standard Time)">00:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">DerekNonGeneric</span>: No need to rebuild, you can just open the browser and set it and then generate the report</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Dec 13 2021 16:36:58 GMT-0800 (Pacific Standard Time)">00:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">caroline</span>: sorry, to clarify (since it's likely different for me); i am given a prompt in the MozillaBuild shell on Windows w/ a few options... (unsure which of the following choices would be correct)</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Dec 13 2021 16:38:27 GMT-0800 (Pacific Standard Time)">00:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">DerekNonGeneric</span>: you want to choose option two if you want to generate reports from websites in the browser</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Dec 13 2021 21:36:16 GMT-0800 (Pacific Standard Time)">05:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell">thanks for the pointers <span class="nick-13">caroline</span> -- glad everything appears to be working as expected after a longer-than-anticipated compile time (whole browser) -- guess hacking on the engine is normally tested w/ SM-only builds</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Dec 13 2021 21:39:20 GMT-0800 (Pacific Standard Time)">05:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell">interestingly, while diagnosing these scripts, seems like all of them are unhappy and most of these unhappy scripts are the ones living under <code>resource://gre/modules/</code>, which apparently are the UA ones shipping w/ the browser ðŸ˜…</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Dec 13 2021 22:02:24 GMT-0800 (Pacific Standard Time)">06:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell">going to have to pick this back up tomorrow since it's getting late over here, but would be highly interested in learning more about what exactly makes these scripts unhappy (ranking criteria) and also what we can do to cheer them up</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Dec 14 2021 08:27:31 GMT-0800 (Pacific Standard Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell"><p>Are there any good guides on diagnosing garbage collection weirdness? I'm running some code in a loop trying to diagnose why memory is being held onto.</p>
<p>With no forced GC or <code>JS_MaybeGC(context)</code> garbage collection is called twice (at exactly the same place both times) before failing a while later.</p>
<pre><code>EVENT 0 test_leaking 
...
EVENT 233 Creating context 
EVENT 234 Creating context 
ERROR swi:SBjsi 404 ***** GC IS BEING CALLED *****
ERROR swi:SBjsi 404 ***** GC IS BEING CALLED *****
EVENT 235 Creating context 
EVENT 236 Creating context 
...
EVENT 467 Creating context 
EVENT 468 Creating context 
testleaking: testleaking.cpp:123: void test_leaking(VXIlogInterface *, VXIjsiInterface *): Assertion `res == VXIjsi_RESULT_SUCCESS' failed.
</code></pre>
<p>whereas with <code>JS_GC(context, JS::GCReason::UNUSED1)</code> it never fails:</p>
<pre><code>EVENT 0 test_leaking 
EVENT 0 Creating context 
ERROR swi:SBjsi 404 ***** GC IS BEING CALLED *****
ERROR swi:SBjsi 404 ***** GC IS BEING CALLED *****
EVENT 1 Creating context 
ERROR swi:SBjsi 404 ***** GC IS BEING CALLED *****
ERROR swi:SBjsi 404 ***** GC IS BEING CALLED *****
...
</code></pre>
</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Dec 14 2021 08:33:03 GMT-0800 (Pacific Standard Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell">(massif for the first run)</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Dec 14 2021 08:34:06 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger ðŸ’‰ðŸ’‰</span>&gt;</div></td><td class="msg-cell">Pretty</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Dec 14 2021 09:04:36 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">cmeister2</span>: this is an embedding? Is the garbage something that is allocated in the embedding (on the malloc heap, or whatever you're using)? If so, then it's probably a problem that the GC doesn't know there's memory pressure, so doesn't see a reason to run when you call <code>JS_MaybeGC</code></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Dec 14 2021 09:04:53 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if that's what's going on, you could report the memory being used to the GC</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Dec 14 2021 09:08:35 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah, <a href="https://searchfox.org/mozilla-central/rev/71befbc9bc348d33f0c7307dc48e3cb36ba78650/js/public/MemoryFunctions.h#79-95">here it is</a></td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Dec 14 2021 09:13:16 GMT-0800 (Pacific Standard Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell"><p>so the test is looping 1000 times, creating 10 Strings of 1MB each time as properties of a custom object. the memory usage at the peak is:</p>
<pre><code>99.98% (2,465,594,475B) (heap allocation functions) malloc/new/new[], --alloc-fns, etc.
-&gt;99.15% (2,445,111,979B) 0x51C85DE: unsigned char* js::MallocProvider&lt;JSContext&gt;::pod_arena_malloc&lt;unsigned char&gt;(unsigned long, unsigned long) (dist/include/js/Utility.h:384)
| -&gt;99.12% (2,444,230,656B) 0x5437494: JSLinearString* NewStringDeflated&lt;(js::AllowGC)1&gt;(JSContext*, char16_t const*, unsigned long) (vm/MallocProvider.h:149)
| | -&gt;99.12% (2,444,230,656B) 0x40AE81: JsiContext::VXIValueToJsval(JSContext*, VXIValue const*, JsiProtectedJsval*) (JsiContext.cpp:1413)
</code></pre>
</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Dec 14 2021 09:13:34 GMT-0800 (Pacific Standard Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell">(it's an old opensource library that I've tried to modernize)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Dec 14 2021 09:17:50 GMT-0800 (Pacific Standard Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell"><p>Expressed in Spidermonkey terms (the best I can): we have a JS_NewContext. With that context we're doing</p>
<pre><code>  JSObject *newglobal = NewGlobalObject(context);
  globalcxt.init(context, newglobal);
  JSAutoRealm ar(context, globalcxt);
    JS::RootedObject globalScope(context, JS_NewObject (context, &amp;SCOPE_CLASS));
...
      JS::RootedObject scopeobj(context, currentScope-&gt;GetJsobj());

      if (! JS_DefineUCProperty (context,
                                 scopeobj,
                                 tmpname,
                                 tmpnamelen,
                                 val.GetHandle( ),
                                 JSPROP_ENUMERATE) )
        rc = VXIjsi_RESULT_OUT_OF_MEMORY;
    }
</code></pre>
</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Dec 14 2021 09:19:22 GMT-0800 (Pacific Standard Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell">One wrinkle might be that to store the objects on the heap I'm using JS::PersistentRooted&lt;JSObject *&gt;; though I <em>believe</em> I'm handling them properly</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Dec 14 2021 09:21:29 GMT-0800 (Pacific Standard Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell">(that belief is entirely predicated on the fact that when JS_GC is called, it actually does clear all the memory up)</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Dec 14 2021 09:35:15 GMT-0800 (Pacific Standard Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Hm. <code>js::MallocProvider&lt;JSContext&gt;::pod_arena_malloc</code> is doing the correct accounting.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Dec 14 2021 09:36:55 GMT-0800 (Pacific Standard Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>PersistentRooted</code> is generally a problem when your objects are reachable from the global, because the global is normally reachable from any object, so you get a path from your <code>PersistentRooted</code> object -&gt; global -&gt; everything. But I agree that if GC clears the memory, then it sounds like that's not happening.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Dec 14 2021 09:38:29 GMT-0800 (Pacific Standard Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess I would step through <a href="https://searchfox.org/mozilla-central/rev/71befbc9bc348d33f0c7307dc48e3cb36ba78650/js/src/gc/GC.cpp#1608-1610">JS_MaybeGC code</a>, on the assumption that the eager alloc trigger is not getting hit.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Dec 14 2021 09:47:52 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell">Thanks, that's a really good idea.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Dec 14 2021 09:47:59 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell">Gives me somewhere to start tomorrow</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Dec 14 2021 11:26:36 GMT-0800 (Pacific Standard Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">My power is out, with no ETA for restoration. (Just fyi)</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Dec 14 2021 11:29:41 GMT-0800 (Pacific Standard Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">confession: we have a working implementation of modules in workers, with dynamic import</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Dec 14 2021 11:29:42 GMT-0800 (Pacific Standard Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Dec 14 2021 11:29:51 GMT-0800 (Pacific Standard Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">now, to clean this up...</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Dec 14 2021 11:30:08 GMT-0800 (Pacific Standard Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">it is satisfyingly small</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Dec 14 2021 11:43:59 GMT-0800 (Pacific Standard Time)">19:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">Is there a flag to run tests (either jit-test or jstests) that makes it... more eager about compiling code than --baseline-eager does? I'd like to run existing tests and force compilation to occur, but --baseline-eager doesn't achieve that if the code isn't inside a function definition, and I'd rather not edit all the tests to wrap the code in functions</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Dec 14 2021 11:59:31 GMT-0800 (Pacific Standard Time)">19:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">we had --ion-eager ... does that work?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Dec 14 2021 12:11:30 GMT-0800 (Pacific Standard Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> we had --ion-eager ... does that work?</blockquote></mx-reply>I'll try it</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Dec 14 2021 12:11:43 GMT-0800 (Pacific Standard Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">Tim</span>: what kind of "eager compilation" is it about?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Dec 14 2021 12:11:54 GMT-0800 (Pacific Standard Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">JIT compilation, or bytecode compilation?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Dec 14 2021 12:11:59 GMT-0800 (Pacific Standard Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-6">Tim</span>: what kind of "eager compilation" is it about?</blockquote></mx-reply>JIT compilation</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Dec 14 2021 12:12:56 GMT-0800 (Pacific Standard Time)">20:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">hm i just realized -- are you running this on top level statements?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Dec 14 2021 12:13:04 GMT-0800 (Pacific Standard Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> hm i just realized -- are you running this on top level statements?</blockquote></mx-reply>Yes</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Dec 14 2021 12:13:33 GMT-0800 (Pacific Standard Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">i am not entirely familiar with the jit, but i don't think we compile those -- i believe it does need to be in a function</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Dec 14 2021 12:13:43 GMT-0800 (Pacific Standard Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">OK, that's what I was afraid of</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Dec 14 2021 12:13:52 GMT-0800 (Pacific Standard Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">(it's not <em>too</em> big a deal to change the tests... I was just hoping to avoid the work)</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Dec 14 2021 12:13:54 GMT-0800 (Pacific Standard Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but, someone like <span class="nick-4">iain</span> would be able to answer better</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Dec 14 2021 12:15:53 GMT-0800 (Pacific Standard Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">Tim</span>: what layer are you trying to test?  blinterp, baseline, or ion?  or maybe all of them for coverage?</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Dec 14 2021 12:16:06 GMT-0800 (Pacific Standard Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-6">Tim</span>: what layer are you trying to test?  blinterp, baseline, or ion?  or maybe all of them for coverage?</blockquote></mx-reply>baseline (I don't have anything implemented in ion yet)</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Dec 14 2021 12:17:25 GMT-0800 (Pacific Standard Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">baseline should work on top-level</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Dec 14 2021 12:18:37 GMT-0800 (Pacific Standard Time)">20:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what part of the code have you implemented and how did you test?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Dec 14 2021 12:19:26 GMT-0800 (Pacific Standard Time)">20:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">I'm implementing records -- in one of my emit...() methods, I added a breakpoint to test whether the breakpoint gets executed when I run the test with --baseline-eager, and it doesn't (but it does if I wrap the code in a function)</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Dec 14 2021 12:20:00 GMT-0800 (Pacific Standard Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Tim... records, of the Records and Tuples proposal or something else?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Dec 14 2021 12:21:40 GMT-0800 (Pacific Standard Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Tim... records, of the Records and Tuples proposal or something else?</blockquote></mx-reply>Yes, of that proposal</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Dec 14 2021 12:21:56 GMT-0800 (Pacific Standard Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">(modifying BaselineCacheIRCompiler.cpp)</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Dec 14 2021 12:22:50 GMT-0800 (Pacific Standard Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So, we have a <em>mostly</em> complete implementation just waiting for TC39 to finish to land here <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1730843">https://bugzilla.mozilla.org/show_bug.cgi?id=1730843</a></td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Dec 14 2021 12:23:12 GMT-0800 (Pacific Standard Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So, we have a <em>mostly</em> complete implementation just waiting for TC39 to finish to land here <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1730843">https://bugzilla.mozilla.org/show_bug.cgi?id=1730843</a></blockquote></mx-reply>Right, that doesn't include the JIT, which is what I'm working on</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Dec 14 2021 12:24:01 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: We are working together</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Dec 14 2021 12:24:04 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We do compile top-level code, but it starts in the interpreter. We tier up at function entry and at loop headers</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Dec 14 2021 12:24:17 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Tim: Sweet. Ok. To your original question, iain sniped me :) </td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue Dec 14 2021 12:24:40 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Tim: Sweet. Ok. To your original question, iain sniped me :) </blockquote></mx-reply>OK -- sounds like I'll have to change the tests, which is fine, just wanted to make sure I wasn't overlooking anything!</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue Dec 14 2021 12:24:45 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Tim: Can I assign <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1744978">https://bugzilla.mozilla.org/show_bug.cgi?id=1744978</a> to you ? </td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue Dec 14 2021 12:24:56 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Tim: Can I assign <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1744978">https://bugzilla.mozilla.org/show_bug.cgi?id=1744978</a> to you ? </blockquote></mx-reply>Yes, I thought it already was :)</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue Dec 14 2021 12:25:19 GMT-0800 (Pacific Standard Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">You are now :D </td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue Dec 14 2021 12:25:29 GMT-0800 (Pacific Standard Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">*You are assigned now :P </td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue Dec 14 2021 12:26:10 GMT-0800 (Pacific Standard Time)">20:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Super cool :D Going to be very nice to hopefully see this landed, and ready to ship for Stage 3 </td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue Dec 14 2021 12:27:16 GMT-0800 (Pacific Standard Time)">20:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: I see <code>inJit()</code> be true at top-level, outside of the loop, with <code>--baseline-eager</code></td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue Dec 14 2021 12:28:05 GMT-0800 (Pacific Standard Time)">20:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, I was just about to say: if I run a simple top-level script with <code>--baseline-eager</code>, I see baseline compilation happening even without loops or functions</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue Dec 14 2021 12:29:07 GMT-0800 (Pacific Standard Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I wonder if there's some other bytecode that fails to compile, before hitting the breakpoint</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Tue Dec 14 2021 12:29:42 GMT-0800 (Pacific Standard Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That is a very good guess</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Tue Dec 14 2021 12:29:49 GMT-0800 (Pacific Standard Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">maybe logging the baseline compilation gives some hint</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Tue Dec 14 2021 12:30:42 GMT-0800 (Pacific Standard Time)">20:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">Tim</span>: Try running with <code>IONFLAGS=bl-aborts,bl-scripts</code> to see if anything interesting pops out</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Tue Dec 14 2021 12:31:38 GMT-0800 (Pacific Standard Time)">20:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Although if it works inside a function, then it seems like all the bytecode must compile)</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Tue Dec 14 2021 12:34:16 GMT-0800 (Pacific Standard Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (Although if it works inside a function, then it seems like all the bytecode must compile)</blockquote></mx-reply>This is so weird -- I'm seeing the BaselineScripts output now, but I swear it wasn't doing that before</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Tue Dec 14 2021 12:34:26 GMT-0800 (Pacific Standard Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">I'm going to have to look a little further to figure out exactly what I was doing before</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Tue Dec 14 2021 12:35:45 GMT-0800 (Pacific Standard Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">More broadly, I'll add: Ion/Warp depends on observing the behaviour of code before compiling it (specifically: we add stubs to ICs and then transpile the CacheIR to MIR as an input to the optimizing compiler), so tests aimed at the JIT should generally include loops</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Tue Dec 14 2021 12:36:19 GMT-0800 (Pacific Standard Time)">20:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Generally I just put the thing I want to test in a function, then call that function 50 times</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Tue Dec 14 2021 12:36:41 GMT-0800 (Pacific Standard Time)">20:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">Makes sense</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Tue Dec 14 2021 12:57:54 GMT-0800 (Pacific Standard Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (Although if it works inside a function, then it seems like all the bytecode must compile)</blockquote></mx-reply>Ah, I realized what I was confused about. It does generate code for a top-level statement, but the code doesn't actually get run unless it's inside a function</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Tue Dec 14 2021 13:02:20 GMT-0800 (Pacific Standard Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, I think I've worked out what's up</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Tue Dec 14 2021 13:02:52 GMT-0800 (Pacific Standard Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">maybe bailout happens somewhere?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Tue Dec 14 2021 13:03:31 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Wait, scratch that, maybe not. One second. I thought I had verified that we are in blinterp, but I may have misread something</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Tue Dec 14 2021 13:04:21 GMT-0800 (Pacific Standard Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, I was wrong</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Tue Dec 14 2021 13:05:17 GMT-0800 (Pacific Standard Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If I have <code>print(inJit())</code> as the only statement in <code>foo.js</code>, and then <code>./mach run --baseline-eager foo.js</code>, then inJit() returns true, and it is called from a baseline frame</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Tue Dec 14 2021 13:05:35 GMT-0800 (Pacific Standard Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So we are definitely in baseline without any loops or function entries</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Tue Dec 14 2021 13:05:50 GMT-0800 (Pacific Standard Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">Tim</span>: Can you post your testcase?</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Tue Dec 14 2021 13:06:09 GMT-0800 (Pacific Standard Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-6">Tim</span>: Can you post your testcase?</blockquote></mx-reply>yeah, I'll see if I can make a test case that doesn't involve records/tuples. Might be a little while</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Tue Dec 14 2021 13:06:24 GMT-0800 (Pacific Standard Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The current version is fine</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Tue Dec 14 2021 13:06:41 GMT-0800 (Pacific Standard Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I just want to see if anything pops out at me</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Tue Dec 14 2021 13:08:29 GMT-0800 (Pacific Standard Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">OK -- so, this is after I added an emitNewTuple() method to BaselineCacheIRCompiler and added an masm.breakpoint() statement in there so that creating a new tuple will trigger a breakpoint. With <code>mach run --baseline-eager --debugger=gdb</code>, I get:</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Tue Dec 14 2021 13:08:45 GMT-0800 (Pacific Standard Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">`js&gt; #[]
#[]
#[]
js&gt; #[]
#[]
#[]
js&gt; #[]
#[]
#[]
js&gt; function f() { x = #[]; }
function f() { x = #[]; }
js&gt; f()
f()
js&gt; f()
f()

Thread 1 "js" received signal SIGTRAP, Trace/breakpoint trap.
0x00003eddcac26442 in ?? ()
`</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Tue Dec 14 2021 13:08:59 GMT-0800 (Pacific Standard Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh! Okay, I think I might know what's going on there</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Tue Dec 14 2021 13:09:12 GMT-0800 (Pacific Standard Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I probably should have twigged in earlier</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Tue Dec 14 2021 13:09:39 GMT-0800 (Pacific Standard Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's because you're setting a breakpoint in CacheIR</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Tue Dec 14 2021 13:10:21 GMT-0800 (Pacific Standard Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The way it generally works is that the first time you hit an IC, we do the operation and attach a stub, not necessarily in that order</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Tue Dec 14 2021 13:10:39 GMT-0800 (Pacific Standard Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And then the second time you hit the IC, we actually invoke the stub you attached</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Tue Dec 14 2021 13:11:41 GMT-0800 (Pacific Standard Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For example, <a href="https://searchfox.org/mozilla-central/source/js/src/jit/BaselineIC.cpp#2398-2417">here</a> is the NewObject code</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Tue Dec 14 2021 13:12:01 GMT-0800 (Pacific Standard Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We reach this function when we get to an IC that doesn't have any stubs yet</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Tue Dec 14 2021 13:13:02 GMT-0800 (Pacific Standard Time)">21:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">Right, so, maybe I was asking for something silly, but basically my question was: can I force it to invoke the stub the first time? Not that anyone would want that behavior except for testing</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Tue Dec 14 2021 13:14:44 GMT-0800 (Pacific Standard Time)">21:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You can't</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Tue Dec 14 2021 13:15:37 GMT-0800 (Pacific Standard Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For example, the NewObject code uses the object that it gets back from calling NewObjectOperation as an input to TryAttachStub, so that we can use the right shape </td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Tue Dec 14 2021 13:16:51 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So in general we may not know what stub to attach until after we've done the operation</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Tue Dec 14 2021 13:17:00 GMT-0800 (Pacific Standard Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">OK, makes sense</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Tue Dec 14 2021 13:17:47 GMT-0800 (Pacific Standard Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Reasonable question, though. We have a bunch of options to force things to happen as early as possible</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Tue Dec 14 2021 14:05:06 GMT-0800 (Pacific Standard Time)">22:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@tephra:mozilla.org">tephra</span>&gt;</div></td><td class="msg-cell">Sorry if this is the wrong place but I have a patch that's been stuck for a while and I think I got all the resolutions (on the ECMA262 side as well) done. Would anyone be willing to help get it further along? <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=802750">https://bugzilla.mozilla.org/show_bug.cgi?id=802750</a> is the bug and <a href="https://phabricator.services.mozilla.com/D122648">https://phabricator.services.mozilla.com/D122648</a> the phabricator link.</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Tue Dec 14 2021 14:09:59 GMT-0800 (Pacific Standard Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">tephra</span>: I'll take a look</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Tue Dec 14 2021 14:10:22 GMT-0800 (Pacific Standard Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@tephra:mozilla.org">tephra</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: Thanks :)</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Tue Dec 14 2021 14:22:14 GMT-0800 (Pacific Standard Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">tephra</span>: commented</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Tue Dec 14 2021 14:23:25 GMT-0800 (Pacific Standard Time)">22:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@tephra:mozilla.org">tephra</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-8">tephra</span>: commented</blockquote></mx-reply>Thanks again!</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Tue Dec 14 2021 14:57:20 GMT-0800 (Pacific Standard Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">chat: Code review is awesome, especially when a reviewer is fantastic. Lots of Streams fixes required, but we're going to be in much better shape on the other side of this. </td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Tue Dec 14 2021 14:58:50 GMT-0800 (Pacific Standard Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I recognize that reviewer, and that outcome.</td></tr>

</tbody></table></div></div></div>
</body></html>