<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-04-17</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-04-17<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-04-15" class="nav-link"><span>prev</span></a>
<a href="2023-04-18" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Apr 17 2023 09:58:05 GMT-0700 (Pacific Daylight Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Does anyone know how to force the GC to run?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Apr 17 2023 10:01:34 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">there is a <code>gc()</code> function in the shell. It might also be available in Firefox chrome code.<br><a href="https://searchfox.org/mozilla-central/source/js/src/builtin/TestingFunctions.cpp#8304">https://searchfox.org/mozilla-central/source/js/src/builtin/TestingFunctions.cpp#8304</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Apr 17 2023 10:09:59 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">it's exposed in <code>Component.util.forceGC()</code></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Apr 17 2023 10:11:08 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">there's a bunch of other functions depending</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Apr 17 2023 10:13:00 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Yeah it depends on what kind of test you are writing. <code>SpecialPowers.forceGC()</code> will work in plain mochitests.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Apr 17 2023 10:19:16 GMT-0700 (Pacific Daylight Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: The embedder-exposed GC code is <a href="https://searchfox.org/mozilla-central/source/js/public/GCAPI.h">here</a>. In particular, if you just want a GC and aren't worried about making it incremental, <a href="https://searchfox.org/mozilla-central/source/js/public/GCAPI.h#713,743-744">these</a> look promising.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Apr 17 2023 10:24:59 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>I'm trying to test finalizers, and I'm getting weird behaviour.</p>
<pre><code>JS_GC(ctx); // This call causes segfault
JS::PrepareForFullGC(ctx); // This call does not
</code></pre>
</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Apr 17 2023 10:27:03 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: Without digging too deeply into the implementation, it looks to me like <code>PrepareForFullGC</code> schedules all zones to be collected, but does not actually trigger a GC. You need something like <code>NonIncrementalGC</code> to actually force a GC.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Apr 17 2023 10:28:08 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But also: <code>JS_GC</code> looks like an easier way of triggering a GC than the links I provided. If it's segfaulting with finalizers, something is probably going wrong during the GC.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Apr 17 2023 10:36:07 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@dug:mozilla.org">dug</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I'm trying to test finalizers, and I'm getting weird behaviour.</p>
<pre><code>JS_GC(ctx); // This call causes segfault
JS::PrepareForFullGC(ctx); // This call does not
</code></pre>
</blockquote></mx-reply>JS_GC(runtime) (SM 24) has been working for me. JS_GC Segfaults can be because of other rooting or JSAPI mistakes, I found out, so in my C++ I put JS_GC() after each/every JSAPI call in my app to pinpoint where my JSAPI calls start to go wrong -- a debugging tool.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Apr 17 2023 10:42:34 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">dug</span>: there is an environment variable that does this automatically for you! (well, not <em>exactly</em> this, but it does a GC after every memory allocation): <code>JS_GC_ZEAL=2,1</code></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Apr 17 2023 12:00:36 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Not sure why line 35 segfaults <a href="https://godbolt.org/z/r4dG11P8h">https://godbolt.org/z/r4dG11P8h</a></blockquote></mx-reply>I found the issue, JSClass needed to be <code>static</code></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Apr 17 2023 16:11:03 GMT-0700 (Pacific Daylight Time)">23:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jgilbert:mozilla.org">Kelsey (jgilbert)</span>&gt;</div></td><td class="msg-cell">does <a href="https://github.com/tc39/proposal-type-annotations">https://github.com/tc39/proposal-type-annotations</a> have any momentum?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Apr 17 2023 16:11:09 GMT-0700 (Pacific Daylight Time)">23:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jgilbert:mozilla.org">Kelsey (jgilbert)</span>&gt;</div></td><td class="msg-cell">seems like no?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Apr 17 2023 16:16:46 GMT-0700 (Pacific Daylight Time)">23:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">Kelsey (jgilbert)</span>: IIRC it was discussed at one of the last few meetings, without making forward progress. There are some concerns about how valuable it really is to make some (but not all) typescript code parse as JS.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Apr 17 2023 16:17:14 GMT-0700 (Pacific Daylight Time)">23:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jgilbert:mozilla.org">Kelsey (jgilbert)</span>&gt;</div></td><td class="msg-cell">it has my vote for "strong yes", fwiw :)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Apr 17 2023 16:18:05 GMT-0700 (Pacific Daylight Time)">23:18</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-4" title="@jgilbert:mozilla.org">Kelsey (jgilbert)</span></div></td><td class="msg-cell">is having to vendor some typescript example tests into the tree for CI right now, and they <em>barely</em> use TS, but I still need to do the whole song and dance and get pretty mangled output html/js</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Apr 17 2023 16:19:01 GMT-0700 (Pacific Daylight Time)">23:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jgilbert:mozilla.org">Kelsey (jgilbert)</span>&gt;</div></td><td class="msg-cell">obviously it's more complicated than the explainer overview gist, but coming from python, I really miss the lint-only annotations</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Apr 17 2023 16:21:13 GMT-0700 (Pacific Daylight Time)">23:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">Kelsey (jgilbert)</span>: Here are the notes, fwiw: <a href="https://github.com/tc39/notes/blob/main/meetings/2023-03/mar-22.md#type-annotations-proposal-update">https://github.com/tc39/notes/blob/main/meetings/2023-03/mar-22.md#type-annotations-proposal-update</a></td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Apr 17 2023 16:21:22 GMT-0700 (Pacific Daylight Time)">23:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jgilbert:mozilla.org">Kelsey (jgilbert)</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Apr 17 2023 16:22:22 GMT-0700 (Pacific Daylight Time)">23:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Also here: <a href="https://github.com/tc39/notes/blob/main/meetings/2023-03/mar-22.md#type-annotations-delimiting-concerns">https://github.com/tc39/notes/blob/main/meetings/2023-03/mar-22.md#type-annotations-delimiting-concerns</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Apr 17 2023 16:23:38 GMT-0700 (Pacific Daylight Time)">23:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which summarized is basically "there's a lot of syntax in them thar types"</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Apr 17 2023 16:26:34 GMT-0700 (Pacific Daylight Time)">23:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jgilbert:mozilla.org">Kelsey (jgilbert)</span>&gt;</div></td><td class="msg-cell">it's certainly harder when trying to serve a bunch of existing grammars</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Apr 17 2023 16:31:10 GMT-0700 (Pacific Daylight Time)">23:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Roughly speaking, the big problem with the proposal is that the engine can't make any use of the type annotations (because there's no guarantee that they're trustworthy), so they're pure overhead that we have to parse as quickly as possible. The best way to do that is to wrap the type in some sort of delimiter so that the parser can skip past it without caring what's inside, but then you've just introduced a new syntax that isn't TypeScript, so it's not actually helping anybody run their TypeScript code</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Apr 17 2023 16:32:25 GMT-0700 (Pacific Daylight Time)">23:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But if you don't have delimiters, then the engine needs to parse the union of several different type systems, some of which are under active development</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Apr 17 2023 16:34:00 GMT-0700 (Pacific Daylight Time)">23:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I suspect it falls into the category of "nice sounding idea that doesn't actually work in practice", but we'll see how it plays out</td></tr>

</tbody></table></div></div></div>
</body></html>