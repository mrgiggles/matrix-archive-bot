<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-11-02</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-11-02<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-11-01" class="nav-link"><span>prev</span></a>
<a href="2022-11-03" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Nov 01 2022 21:38:06 GMT-0700 (Pacific Daylight Time)">04:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">confession: Have been nerdsniped into analyzing the JS::Value representation. On the plus side, I think some more documentation is coming from this :) </td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Nov 01 2022 21:38:09 GMT-0700 (Pacific Daylight Time)">04:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Nov 02 2022 04:07:18 GMT-0700 (Pacific Daylight Time)">11:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: how many free bits are remaining before we have to mashup some types together?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Nov 02 2022 04:09:12 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I guess we could have a larger type tag for small values, such as Magic, int32, null and undefined (which are not pointer base) if we wanted to free some space, but then the payload size would depend on the content.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Nov 02 2022 04:13:53 GMT-0700 (Pacific Daylight Time)">11:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@caleb.distributive:mozilla.org">caleb.distributive</span>&gt;</div></td><td class="msg-cell">Hi everyone, I'm embedding Spidermonkey, and got a question regarding JSGCCallbacks. Namely: how do they work? The documentation is kinda sparse. So for all I've got is that I can set them with JS_SetGCCallback.

I'm attempting to tell the garbage collector not to collect a given GCThing if a particular statement is true, and I may potentially have many such GCThings that I may or may not want to prevent collection for (and whether I want them collected may change), but I still want it to collect other things that I'm not concerned with.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Nov 02 2022 04:50:51 GMT-0700 (Pacific Daylight Time)">11:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><p>TIL that WebKit, Chromium, and Gecko each give a completely different error message when trying to consume a response body stream which becomes errored during the streaming‚Ä¶<br>WebKit: ‚ÄúTypeError: undefined‚Äù<br>Chromium: ‚ÄúTypeError: Failed to fetch‚Äù<br>Gecko: ‚ÄúDOMException: The operation was aborted.‚Äù</p>
<p>This is the code:</p>
<pre><code>new Response(new ReadableStream({
    pull(controller) {
      controller.error();
    },
  })
).text()
</code></pre>
<p>I'm not quite sure where to report this inconsistency, any pointers where I should report this would be appreciated ü§û</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Nov 02 2022 05:40:37 GMT-0700 (Pacific Daylight Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Probably we shouldn't have a dom exception, so you can open a bug on bugzilla for us to take a look. However, regarding the contents of the error message, those are not standardized unfortunately. We've tried to standardize error messages in the past, but it led to WebCompat issues, as people use different error messages to determine which browser they are running on</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Nov 02 2022 05:44:32 GMT-0700 (Pacific Daylight Time)">12:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Probably we shouldn't have a dom exception, so you can open a bug on bugzilla for us to take a look. However, regarding the contents of the error message, those are not standardized unfortunately. We've tried to standardize error messages in the past, but it led to WebCompat issues, as people use different error messages to determine which browser they are running on</blockquote></mx-reply>Thanks -- I've opened <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1798678">https://bugzilla.mozilla.org/show_bug.cgi?id=1798678</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Nov 02 2022 05:44:47 GMT-0700 (Pacific Daylight Time)">12:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Nov 02 2022 08:47:05 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">mgaudet</span>: how many free bits are remaining before we have to mashup some types together?</blockquote></mx-reply><p>So as near as I can tell, we're actually over-allocated on type bits. We seem to have only 12 types, but 5 bits allocated to types. So we should in theory be able to support 20 more type tags.</p>
<p>Here's my type map:</p>
<pre><code>// Tag Map:
// Float Bits:            51  50  49  48  47
// Double:       0x00     0   0   0   0   0
// Int32:        0x01     0   0   0   0   1
// Boolean:      0x02     0   0   0   1   0
// Undefined:    0x03     0   0   0   1   1
// Null:         0x04     0   0   1   0   0
// Magic:        0x05     0   0   1   0   1
// String:       0x06     0   0   1   1   0
// Symbol:       0x07     0   0   1   1   1
// PrivateGC:    0x08     0   1   0   0   0
// BigInt:       0x09     0   1   0   0   1
// Unused:       0x0a     0   1   0   1   0
// ExtPrimitive: 0x0b     0   1   0   1   1
// Object:       0x0c     0   1   1   0   0
// Unused:       0xd though 0x1f
</code></pre>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Nov 02 2022 08:49:04 GMT-0700 (Pacific Daylight Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Even if we shrank out type-bit allocation to 4 bits, we'd still have 4 bits remaining. I've done a little bit of experimentation with doing that shrink, but either I've misunderstood (possible!) or we've got a lot of assumptions about 5 bits baked in already. </td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Nov 02 2022 09:02:09 GMT-0700 (Pacific Daylight Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Maybe it's best to just keep the extra tag bits in our back pocket for a rainy day? I think the only meaningful advantage of freeing up the 48th address bit is that we could hypothetically run in kernel mode, which is not exactly a priority</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Nov 02 2022 09:04:33 GMT-0700 (Pacific Daylight Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">also some of the bits are special (eg <code>ValueObjectOrNullBit</code>) and there are some ordering constraints :)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Nov 02 2022 09:05:44 GMT-0700 (Pacific Daylight Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Maybe we try setting the object tag to 0x14 -- it preserves the single bit difference constraint between Object and Null, but uses the top bit (and obeys our current ordering constraint), and helps us ensure we're not accidentally losing that bit somehow. (I think this is maybe my current worry; because we never use that bit as significant, we may have accidentally lost the ability to!) </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Nov 02 2022 09:16:05 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Hi everyone, I'm embedding Spidermonkey, and got a question regarding JSGCCallbacks. Namely: how do they work? The documentation is kinda sparse. So for all I've got is that I can set them with JS_SetGCCallback.

I'm attempting to tell the garbage collector not to collect a given GCThing if a particular statement is true, and I may potentially have many such GCThings that I may or may not want to prevent collection for (and whether I want them collected may change), but I still want it to collect other things that I'm not concerned with.</blockquote></mx-reply>See the "GC thing pointers on the heap" section of the <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr91/docs/GC%20Rooting%20Guide.md">GC Rooting Guide</a>, especially the Tracing section.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Nov 02 2022 09:17:54 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">your callback should trace anything you want to keep alive, and null out everything you don't.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Nov 02 2022 09:19:02 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the latter is to avoid dangling pointers, either because the thing they point to is now dead, or because it's still alive (because something <em>else</em> points to it) but has been moved.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Nov 02 2022 09:23:23 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: Last time I looked at it, I do not think we could used the sign bit, as this is our tag for Private value.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Nov 02 2022 09:24:36 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. The way we've got our tags defined, I don't think we can use the fifth bit currently. 

The problem is here: <a href="https://searchfox.org/mozilla-central/source/js/public/Value.h#113,116,127">https://searchfox.org/mozilla-central/source/js/public/Value.h#113,116,127</a> 

If we set the topmost bit, changing JSVAL_TYPE_OBJECT from 0xc to 0x14, then JSVAL_TAG_NULL == JSVAL_TAG_OBJECT, as JSVAL_TAG_MAX_DOUBLE has that top bit set as well. </td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Nov 02 2022 09:25:48 GMT-0700 (Pacific Daylight Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">mgaudet</span>: Last time I looked at it, I do not think we could used the sign bit, as this is our tag for Private value.</blockquote></mx-reply><p>The float sign bit; my best guess was that it always had to be set. I couldn't find anything that said that, but derived this (not yet reviewed or landed comment):</p>
<pre><code>diff --git a/js/public/Value.h b/js/public/Value.h
--- a/js/public/Value.h
+++ b/js/public/Value.h
@@ -123,6 +123,17 @@ class JS_PUBLIC_API Value;
 // 4. The tags for Object and Null differ by a single flipped bit, to simplify
 //    toObjectOrNull. (See ValueObjectOrNullBit)
 //
+// An aside: In the puboxing format described above, we've only described a use
+// in boxing of 63 of the 64 bits of the double-precision floating point. In
+// theory we could use NaN boxing and use the sign bit for our own purposes.
+// However, we assume we always have a set sign bit (1) in our value
+// representation in order to support quick determination of whether or not a
+// value is a double.
+//
+// The quick check is performed by shifting all the non-tag fraction bits out,
+// then comparing if the resulting value is strictly greater the maximum double
+// value tag. This check only works if we assume a set sign bit.
+//
 // [1]:
 // https://wingolog.org/archives/2011/05/18/value-representation-in-javascript-implementations#969f63bbe4eb912778c9da85feb0f5763e7a7862
 
@@ -208,6 +219,7 @@ static_assert(sizeof(JSValueTag) == size
 #elif defined(JS_PUNBOX64)
 
 enum JSValueTag : uint32_t {
+  // Any value with a 'tag' lower than this is actually a double.
   JSVAL_TAG_MAX_DOUBLE = 0x1FFF0,
   JSVAL_TAG_INT32 = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_INT32,
   JSVAL_TAG_UNDEFINED = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_UNDEFINED,
</code></pre>
</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Nov 02 2022 09:26:40 GMT-0700 (Pacific Daylight Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I recall it being non-free ‚Ä¶ maybe due to the comparison complexity induced by using it.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Nov 02 2022 09:27:41 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">That's it: <a href="https://searchfox.org/mozilla-central/source/js/public/Value.h#185-187">https://searchfox.org/mozilla-central/source/js/public/Value.h#185-187</a></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Nov 02 2022 09:28:57 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">oh, for sure, allowing a zero sign bit makes other things complicated too. I just don't know if it's actually written down that we require a non-zero sign bit, or if it's just implicit in our value type construction. </td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Nov 02 2022 09:29:41 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I wonder if I've just goofed in my understanding: maybe we do actually only have 4 type tag bits, and the fifth bit is the discriminator between a float and the ECMAScript NaN </td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Nov 02 2022 09:29:51 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">that's basically what the comment mention, we keep the sign bit at 1 to have a fast isDouble check.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Nov 02 2022 09:30:07 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> that's basically what the comment mention, we keep the sign bit at 1 to have a fast isDouble check.</blockquote></mx-reply>which comment?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Nov 02 2022 09:30:18 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">The one you pasted above.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Nov 02 2022 09:30:38 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Oh yeah -- but that's something I just reverse engineered last night, it's not written down elsewhere</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Nov 02 2022 09:31:01 GMT-0700 (Pacific Daylight Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">‚ÄúHowever, we assume we always have a set sign bit (1) in our value representation in order to support quick determination of whether or not a value is a double.‚Äù</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Nov 02 2022 09:31:46 GMT-0700 (Pacific Daylight Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">oh ok, that your patch. That's something I had reverse engineer in the past as well ‚Ä¶ not recalling.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Nov 02 2022 09:32:28 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">So there only <del>1</del> 4 free tag today.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Nov 02 2022 09:33:37 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I guess we should add on our todo list to coalesce int32, null, undefined, boolean and magic into a 32bits tag.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Nov 02 2022 09:34:24 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So there only 1 free tag today.</blockquote></mx-reply>Possibly -- at the very least, attempting to use tags 0x{d,e,f} may require reordering of our tags, or giving up on some previously assumed constraints.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Nov 02 2022 09:35:44 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Shifting String and Symbols by 2 would be make a cheap test for GC things.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Nov 02 2022 09:37:50 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Shifting them where? </td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Nov 02 2022 09:37:53 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(don't quite follow) </td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Nov 02 2022 09:45:11 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We have four tags free, no? a, d, e, f?</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Nov 02 2022 09:46:46 GMT-0700 (Pacific Daylight Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The only limitation is that if we want all GC things to be contiguous, Object to be the biggest tag, and Null to only differ by 1 bit from Object, then no more than half of our tags can be for GC things</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Nov 02 2022 09:47:59 GMT-0700 (Pacific Daylight Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In which case combining our primitive tags together doesn't get us anywhere</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Nov 02 2022 09:48:16 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Yes, currently this is a requirement that they are contiguous:
<a href="https://searchfox.org/mozilla-central/source/js/public/Value.h#717-724">https://searchfox.org/mozilla-central/source/js/public/Value.h#717-724</a></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Nov 02 2022 09:50:13 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@allstarschh:mozilla.org">@allstarschh</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: meeting? this week Europe ends daylight saving so the meeting is 1 hour earlier for you</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Nov 02 2022 09:57:14 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Of the restrictions, I think "all primitive types have smaller tags than Object" is the easiest to relax. None of the <a href="https://searchfox.org/mozilla-central/search?q=symbol:_ZNK2JS5Value11isPrimitiveEv&amp;redirect=false">uses</a> of <code>isPrimitive</code> look very performance sensitive. Implementing it as <code>return toTag() != JSVAL_TAG_OBJECT</code> seems fine.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Nov 02 2022 10:10:02 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: Don`t forget generated code.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Nov 02 2022 10:10:22 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">but we are most likely checking individual tags.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Nov 02 2022 10:16:26 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Good point</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Nov 02 2022 10:16:46 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">At first glance, it looks like the only place we check isPrimitive (in jitcode) is for the return value of constructors</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Nov 02 2022 10:17:36 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(<a href="https://searchfox.org/mozilla-central/search?q=branchtestprimitive&amp;path=&amp;case=false&amp;regexp=false">https://searchfox.org/mozilla-central/search?q=branchtestprimitive&amp;path=&amp;case=false&amp;regexp=false</a>)</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Nov 02 2022 10:42:18 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. I wonder if we're not using the MSB of the mantissa for the tag is to avoid producing signalling NaNs... 

Tweaking the definition of JSVAL_TAG_MAX_DOUBLE to 0x1ffe0 (freeing up the fifth tag bit) passes a good number, but not all, jstests. Haven't investigated further yet. </td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Nov 02 2022 10:43:24 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(It feels weird to me that JSVAL_TAG_SHIFT is 47, and yet we only use 4 of the bits for tags; I thought it might be the canonical nan, but turns out we require our canonical NaN to have a zero sign bit, and so our fast-path for checking isDouble already works properly there) </td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Nov 02 2022 10:43:39 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think I've worked out to my satisfaction where the fifth tag bit went. Writing up an explanation now.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Nov 02 2022 10:44:24 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In short, the problem is that the hardware generated NaN has one of our tag bits set</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Nov 02 2022 10:44:30 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I had wondered the same, and my conclusion is that it was not necessary to care about the signalling bit as we are not doing any math with tagged values.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Nov 02 2022 10:47:12 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Unless I've been counting bits incorrectly, which may well be possible)</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Nov 02 2022 10:48:32 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Okay, yeah, I think my counting is correct</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Nov 02 2022 10:48:54 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">mgaudet</span>: I had wondered the same, and my conclusion is that it was not necessary to care about the signalling bit as we are not doing any math with tagged values.</blockquote></mx-reply>That was me too, but I'm eager to hear Iain's explanation, because this has nerdsniped me badly :P</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Nov 02 2022 10:54:14 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><pre><code>| 63   | 62 - 52  |  51  | 50 | 49 | 48 | 47 | 46 - 0  |
| sign | exponent | **** |    |    |    |    | payload |

The largest non-NaN double we have to handle is -infinity, which has all 12 of the sign/exponent bits set, and none of the tag/payload bits.
-infinity is 0x1ffe0 &lt;&lt; 47 (aka 0xfff &lt;&lt; 48). As soon as we hit (0x1ffe0 &lt;&lt; 47) + 1, we're in NaN space.

To make the maximum use out of our tag space, it would be great if our canonical NaN was (0x1ffe0 &lt;&lt; 47) + 1.
All doubles would be contiguous, and no value with any of the five tag bits set would be a double.

However, the canonical NaN produced by the hardware is 0xfff8000000000000, which has the top 13 bits set.
If we don't want to have to canonicalize NaNs after doing any math with doubles, we have to ensure that value is interpreted as a double.

So we give that bit back. Any value without bit 51 set is a double.
Effectively, all of our tags already have the top bit set; we just don't write them that way.
</code></pre>
</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Nov 02 2022 10:57:01 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I think that aligns with my debugging of setting JSVAL_TAG_MAX_DOUBLE to 0x1ffe0; </td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Nov 02 2022 10:57:13 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(About to take off for lunch, so only about 75% confident) </td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Nov 02 2022 10:57:29 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Well -- yet another comment to add to Value.h</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Nov 02 2022 10:59:45 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">IIRC, x64 and arm differ in the canonical NaN, in the sense that one of them sets the sign bit on eg <code>0.0/0.0</code> and the other doesn't, but it doesn't matter because multiplying by -1 will flip the sign bit, even for a NaN.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Nov 02 2022 11:00:13 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So both platforms are capable of creating <code>0xfff8000000000000</code> through legitimate math</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Nov 02 2022 11:01:33 GMT-0700 (Pacific Daylight Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><del><span class="nick-4">iain</span>: <code>0xfff8000000000000</code> has the sign bit set, which is not the case of our NaN boxing.</del></td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Nov 02 2022 11:03:10 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: I don't understand what you mean. All of our NaN-boxed values have the sign bit set.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Nov 02 2022 11:03:20 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(As in, everything that isn't a double)</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Nov 02 2022 11:05:56 GMT-0700 (Pacific Daylight Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Another way of phrasing this: we draw the line between doubles and other values at the highest point that can be produced by doing math with hardware, and unfortunately the line is <code>0xfff8000000000000</code></td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Nov 02 2022 11:06:36 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><code>// NaN:       0x10     1   0   0   0   0</code>, maybe?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Nov 02 2022 11:08:27 GMT-0700 (Pacific Daylight Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Excluding NaN from double math does not sounds like a big trouble maker, except for messing a bit with our type inference.<br>We would have to add <code>isUntagged</code> in addition to <code>isDouble</code>, but that would free the signaling bit.</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Nov 02 2022 11:10:03 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <code>// NaN:       0x10     1   0   0   0   0</code>, maybe?</blockquote></mx-reply>I don't understand this notation</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Nov 02 2022 11:10:35 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This is a reference to <span class="nick-2">mgaudet</span> previous comment describing the mapping of each tag.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Nov 02 2022 11:11:57 GMT-0700 (Pacific Daylight Time)">18:11</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-2" title="@nbp:mozilla.org">nbp</span></div></td><td class="msg-cell">is confused</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Nov 02 2022 11:12:03 GMT-0700 (Pacific Daylight Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, got it</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Nov 02 2022 11:12:16 GMT-0700 (Pacific Daylight Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think the problem is that it makes <code>isDouble</code> more expensive</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Nov 02 2022 11:13:31 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For the purposes of telling if something is a number, for example</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Nov 02 2022 11:14:10 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But maybe we can do something fancy where we just clear that bit before doing the comparison, similar to the ObjectOrNull trick</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Nov 02 2022 11:15:09 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">When we care about doing double math, we might just use <code>isUntagged</code>, <code>isDouble</code> would only be used when we have to write "NaN" for a string, or for the <code>type v === "number"</code></td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Nov 02 2022 11:15:39 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Clearing the bit would be a pain as it is produced by every math instruction.</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Nov 02 2022 11:18:47 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Suppose we have a binary arithmetic IC for a + b, and we see 1.5 + 2.4. What guards are you proposing we generate?</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Nov 02 2022 11:19:21 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right now, we can quickly tell that a value is a double by comparing it to a single maximum.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Nov 02 2022 11:19:24 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><code>isUntagged</code> for both. We would have a slower path for NaN.</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Nov 02 2022 11:19:55 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">so keeping the fast path for non-NaN values.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Nov 02 2022 11:21:56 GMT-0700 (Pacific Daylight Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think there might be a better approach</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Nov 02 2022 11:23:54 GMT-0700 (Pacific Daylight Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Where we check <code>(val &amp; ~(1 &lt;&lt; 51)) &lt;= JSVAL_SHIFTED_TAG_MAX_DOUBLE</code></td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Nov 02 2022 11:25:17 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">you have one extra <code>&amp;</code> operation, but this would work.</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Nov 02 2022 11:25:30 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We only have to clear the bit when comparing, not for every arithmetic operation</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Nov 02 2022 11:25:32 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which helps</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Nov 02 2022 11:25:37 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">however, this implies encoding 2 64 bits immediate :/</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Wed Nov 02 2022 11:25:59 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Is there no better way to flip a high bit?</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Wed Nov 02 2022 11:27:31 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">rotating and moving it to the carry flag? but that would be even more instructions.</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Wed Nov 02 2022 11:29:43 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">godbolt says: <a href="https://godbolt.org/z/9WMPr7G5G">https://godbolt.org/z/9WMPr7G5G</a></td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Wed Nov 02 2022 11:30:43 GMT-0700 (Pacific Daylight Time)">18:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">TIL: never heard of <code>btr</code> before!</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Wed Nov 02 2022 11:31:40 GMT-0700 (Pacific Daylight Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">We should make a patch to clang, and to SpiderMonkey.</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Wed Nov 02 2022 11:32:23 GMT-0700 (Pacific Daylight Time)">18:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I think ARM64 has proper instructions for extracting bits.</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Wed Nov 02 2022 11:34:47 GMT-0700 (Pacific Daylight Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Agner Fog does say "BT, BTC, BTR, and BTS change the carry flag but leave the other flags unchanged. This causes a false dependence on the previous value of the flags and costs an extra Œºop."</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Wed Nov 02 2022 11:35:07 GMT-0700 (Pacific Daylight Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But that might still be better than encoding an entire immediate</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Wed Nov 02 2022 11:35:51 GMT-0700 (Pacific Daylight Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Also, that might just be on specific old hardware)</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Wed Nov 02 2022 11:38:25 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This trick would make  testing for int32 or double slightly more complicated, but I think at worst we just have to set tag 0x11 aside as unused</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Wed Nov 02 2022 11:40:16 GMT-0700 (Pacific Daylight Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Anyway, I think this is a plausible solution to keep in our back pocket in case we desperately need more tag bits, but doesn't seem like something we want to do unless we're forced to</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Wed Nov 02 2022 12:05:27 GMT-0700 (Pacific Daylight Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Neat discussion: Iain, would you be able to add your writeup of the HW NaN issue (and maybe a proposed road forward) to some comments in Value.h? would be nice to have this written down in tree for future considerations</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Wed Nov 02 2022 14:13:47 GMT-0700 (Pacific Daylight Time)">21:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1316557#c1">https://bugzilla.mozilla.org/show_bug.cgi?id=1316557#c1</a> sounds like an actual problem that is going to get lost since it's piled on an unrelated bug. Just so I know, what should I do to get it onto the triage list?</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Wed Nov 02 2022 14:17:33 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">You can unset the Priority and it will get discussed at the next triage meeting (November üòé</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Wed Nov 02 2022 14:19:14 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">perfect, thank you. Though I guess for that bug I should probably open a new one myself; it's marked triage-deferred for the original issue.</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Wed Nov 02 2022 14:26:39 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Does anyone have suggestions for the best way to create JS Enums using Spidermonkey? </td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Wed Nov 02 2022 14:30:46 GMT-0700 (Pacific Daylight Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>From what I understand, they're typically defined as objects with mappings from name to number and from number back to name.  So,</p>
<pre><code>enum Foo {A = 1, B = 2};
</code></pre>
<p>Would end up as something like:</p>
<pre><code>Foo = {'A': 1, 1: 'A', 'B': 2, 2:'B'}
</code></pre>
</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Wed Nov 02 2022 14:34:50 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I don't, really, but you could look at the code that gets generated for webidl enums. Look at the generated code for <a href="https://searchfox.org/mozilla-central/search?q=symbol:T_mozilla%3A%3Adom%3A%3AScrollBehavior&amp;redirect=false">the ScrollBehavior</a> type, as an example. Though the generated code is pretty messy, and I'm not sure if it's useful as a base.</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Wed Nov 02 2022 14:35:22 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You could also look at what TypeScript does; I know they support enum syntax.</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Wed Nov 02 2022 14:38:22 GMT-0700 (Pacific Daylight Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Here's what they do: <a href="https://www.typescriptlang.org/play?q=386#example/enums">https://www.typescriptlang.org/play?q=386#example/enums</a> </td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Wed Nov 02 2022 14:39:05 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>This enum:</p>
<pre><code>enum CompassDirection {
  North,
  East,
  South,
  West,
}
</code></pre>
<p>Becomes this monstrosity:</p>
<pre><code>var CompassDirection;
(function (CompassDirection) {
    CompassDirection[CompassDirection["North"] = 0] = "North";
    CompassDirection[CompassDirection["East"] = 1] = "East";
    CompassDirection[CompassDirection["South"] = 2] = "South";
    CompassDirection[CompassDirection["West"] = 3] = "West";
})(CompassDirection || (CompassDirection = {}));
</code></pre>
</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Wed Nov 02 2022 14:41:21 GMT-0700 (Pacific Daylight Time)">21:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so it's what you said originally</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Wed Nov 02 2022 14:42:18 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that seems kind of handy</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Wed Nov 02 2022 14:42:51 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Here's the question I have: How does one assign a numeric property to an object using SpiderMonkey.  It seems like it only accepts strings as keys.</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Wed Nov 02 2022 14:43:22 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>JS_SetElement</code></td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Wed Nov 02 2022 14:43:43 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or <code>JS_DefineElement</code></td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Wed Nov 02 2022 14:43:50 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I thought SetElement only worked on arrays</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Wed Nov 02 2022 14:45:26 GMT-0700 (Pacific Daylight Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I wouldn't expect it to make a difference. For a regular object, I would expect that you could create a <code>PropertyKey</code> from an integer and use <code>JS_DefineProperty</code> to do the same thing.</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Wed Nov 02 2022 14:45:42 GMT-0700 (Pacific Daylight Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I wouldn't expect it to make a difference. For a regular object, I would expect that you could create a <code>PropertyKey</code> from an integer and use <code>JS_DefineProperty</code> to do the same thing.</blockquote></mx-reply>Excellent.  THanks</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Wed Nov 02 2022 14:46:34 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, <code>JS_DefinePropertyById</code> exists. That seems pretty direct.</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Wed Nov 02 2022 14:47:01 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I've seen this PropertyKey thing around.  Is it something you can make from an int or a string?</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Wed Nov 02 2022 14:47:31 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Note that the only differences in JS between objects and arrays are 1. Arrays have a different prototype with some methods, 2. Arrays have a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/length">magic</a> <code>length</code> property that is automatically updated as you add elements, and 3. Arrays get fancy syntax</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Wed Nov 02 2022 14:47:46 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">int, string, or symbol, I think.</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Wed Nov 02 2022 14:48:16 GMT-0700 (Pacific Daylight Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and note that <code>jsid</code> is an alias for <code>JS::PropertyKey</code>.</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Wed Nov 02 2022 14:53:56 GMT-0700 (Pacific Daylight Time)">21:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>Neat discussion: Iain, would you be able to add your writeup of the HW NaN issue (and maybe a proposed road forward) to some comments in Value.h? would be nice to have this written down in tree for future considerations</p>
</blockquote>
<p><a href="https://phabricator.services.mozilla.com/D161091">https://phabricator.services.mozilla.com/D161091</a></p>
</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Wed Nov 02 2022 15:45:27 GMT-0700 (Pacific Daylight Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Mhm I thought we didn't use the sign bit, because otherwise we would have to cannoncalize on negation</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Wed Nov 02 2022 15:52:02 GMT-0700 (Pacific Daylight Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">evilpie</span>: We always set the sign bit for boxed values</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Wed Nov 02 2022 15:52:12 GMT-0700 (Pacific Daylight Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We don't enforce a particular sign bit on our canonical NaN</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Wed Nov 02 2022 15:53:51 GMT-0700 (Pacific Daylight Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You get different sign bits on arm and x86 by default, but you can get the other one by negating it</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Wed Nov 02 2022 15:54:29 GMT-0700 (Pacific Daylight Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So we draw the line between boxed values and doubles at <code>0xfff8_0000_0000_0000</code></td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Wed Nov 02 2022 16:06:40 GMT-0700 (Pacific Daylight Time)">23:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> We don't enforce a particular sign bit on our canonical NaN</blockquote></mx-reply>I came to a different conclusion actually; how did I go wrong?</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Wed Nov 02 2022 16:07:52 GMT-0700 (Pacific Daylight Time)">23:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(I concluded that we make GenericNaN always have a zero sign bit)</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Wed Nov 02 2022 16:09:30 GMT-0700 (Pacific Daylight Time)">23:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><a href="https://phabricator.services.mozilla.com/D161054">https://phabricator.services.mozilla.com/D161054</a></td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Wed Nov 02 2022 16:17:12 GMT-0700 (Pacific Daylight Time)">23:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/public/Value.h#395,420-422">https://searchfox.org/mozilla-central/source/js/public/Value.h#395,420-422</a> + <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Initialization.cpp#77">https://searchfox.org/mozilla-central/source/js/src/vm/Initialization.cpp#77</a> convinced me we always have a zero bit on the sign of our canonical NaN</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Wed Nov 02 2022 16:21:34 GMT-0700 (Pacific Daylight Time)">23:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: Sorry, overloading terminology here</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Wed Nov 02 2022 16:21:50 GMT-0700 (Pacific Daylight Time)">23:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/public/Value.h#392-394">https://searchfox.org/mozilla-central/source/js/public/Value.h#392-394</a></td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Wed Nov 02 2022 16:22:29 GMT-0700 (Pacific Daylight Time)">23:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">When we create a NaN ourselves, the sign bit is always 0.</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Wed Nov 02 2022 16:23:00 GMT-0700 (Pacific Daylight Time)">23:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But on x86, the sign bit is set when the hardware creates a NaN itself</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Wed Nov 02 2022 16:24:13 GMT-0700 (Pacific Daylight Time)">23:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And we still consider that NaN to be canonicalized, in the sense that we don't have to make any changes to it</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Wed Nov 02 2022 16:25:56 GMT-0700 (Pacific Daylight Time)">23:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This is kind of necessary, because you can flip the sign bit on a NaN from JS just by negating it</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Wed Nov 02 2022 16:26:17 GMT-0700 (Pacific Daylight Time)">23:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The hardware doesn't do a special check to make sure something isn't a NaN before flipping the bit, it just flips the bit unconditionally</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Wed Nov 02 2022 16:27:15 GMT-0700 (Pacific Daylight Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You could say that we have two canonical NaN values, differing only in the sign bit</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Wed Nov 02 2022 16:27:33 GMT-0700 (Pacific Daylight Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's the one with the sign bit set that causes us all the trouble with tagging</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Wed Nov 02 2022 16:27:36 GMT-0700 (Pacific Daylight Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">ah ok -- my notes are wrong </td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Wed Nov 02 2022 16:27:43 GMT-0700 (Pacific Daylight Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I'll have to tweak that patch tomorrow</td></tr>

</tbody></table></div></div></div>
</body></html>