<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-01-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-01-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-01-06" class="nav-link"><span>prev</span></a>
<a href="2022-01-08" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Jan 07 2022 03:34:49 GMT-0800 (Pacific Standard Time)">11:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: thank you for the link. I've noticed but I still don't quite understand how an instruction node maps to that enum. I guess what I'm trying to say is how should I translate/interpret <code>BailoutKind</code>?. i.e I don't understand what kind of <code>BailoutKind</code> abs as <span class="nick-15">arai</span> said or, add, sub should have based on that enum. Does every fallible instruction have a standard/default <code>BailoutKind</code> based on its fallible case?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Jan 07 2022 03:42:57 GMT-0800 (Pacific Standard Time)">11:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: The bailoutKind is selected based on the name of the error, and based on what is necessary to do to prevent this compilation path from being selected in future compilations.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Jan 07 2022 03:44:01 GMT-0800 (Pacific Standard Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">^ Apparently this changed a lot since I last looked at it, and now it seems to be only focused on the compilation path.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Jan 07 2022 03:45:33 GMT-0800 (Pacific Standard Time)">11:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">So the question for selecting a BailoutKind would be, what is the latest optimization phases which had to be executed which allowed this fallible path to exists. </td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Jan 07 2022 03:51:39 GMT-0800 (Pacific Standard Time)">11:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">Ok that makes a bit more sense now thank you!</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Jan 07 2022 03:52:54 GMT-0800 (Pacific Standard Time)">11:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">And why this latest optimization phase is important to know? To jump back to in case of the fallible scenario? Or to avoid that path on future occurrences when going through that phase?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Jan 07 2022 04:00:46 GMT-0800 (Pacific Standard Time)">12:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This is important to know, to disable this optimization phase, such that the next time we compile this code, we do not generate this fallible path.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Jan 07 2022 04:01:09 GMT-0800 (Pacific Standard Time)">12:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Thus, avoiding compilation &amp; bailout loops.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Jan 07 2022 04:04:05 GMT-0800 (Pacific Standard Time)">12:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">compilation &amp; bailout loop will cause the compiler to run, produce the same code as last time, and exit the compiled code with a bailout. Having loop of such kind can be a waste of CPU resources, as compilations are not free.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Jan 07 2022 04:18:03 GMT-0800 (Pacific Standard Time)">12:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">Thank you for the explanation :) I’ll come back with more questions</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Jan 07 2022 04:40:08 GMT-0800 (Pacific Standard Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">In which case does JS_DefineProperty fail?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Jan 07 2022 04:40:13 GMT-0800 (Pacific Standard Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">OOM ?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Jan 07 2022 05:04:17 GMT-0800 (Pacific Standard Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: it looks like that maps to <a href="https://tc39.es/ecma262/#sec-ordinary-object-internal-methods-and-internal-slots-defineownproperty-p-desc">https://tc39.es/ecma262/#sec-ordinary-object-internal-methods-and-internal-slots-defineownproperty-p-desc</a> so it would greatly depend on the type of object</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Jan 07 2022 05:33:37 GMT-0800 (Pacific Standard Time)">13:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: OOM, (bad thread?), non-configurable, non-extensible object, beyond array length of array with non-writable length</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Jan 07 2022 05:33:56 GMT-0800 (Pacific Standard Time)">13:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">And probably more which are specific to JSClasses</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Jan 07 2022 05:34:31 GMT-0800 (Pacific Standard Time)">13:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">The case I was thinking was related to defining properties on an interface object in bindings code</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Jan 07 2022 05:58:53 GMT-0800 (Pacific Standard Time)">13:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: Another way of thinking about it: BailoutKind doesn't describe what an instruction does, it describes where that node came from.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Jan 07 2022 06:01:33 GMT-0800 (Pacific Standard Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: and what does <code>BailoutKind::Unknown</code> mean in that context? You don't know where that node came from?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Jan 07 2022 06:01:42 GMT-0800 (Pacific Standard Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Most fallible instructions come from transpiled CacheIR. When we hit an inline cache in baseline, we attach a stub that covers that case. When we compile in Warp, we look at the CacheIR instructions for the stub and generate the equivalent MIR. So if an instruction bails out in Warp, then it usually means that the equivalent CacheIR would have failed a guard.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Jan 07 2022 06:02:01 GMT-0800 (Pacific Standard Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Unknown generally means that the node has never been given a bailout kind, and it shouldn't bail out.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Jan 07 2022 06:02:50 GMT-0800 (Pacific Standard Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Any instructions generated in the Warp CacheIR transpiler will automatically have BailoutKind::TranspiledCacheIR (unless we gave them something more specific)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Jan 07 2022 06:04:00 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So if it's unknown, it probably means that we generated it during an optimization</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Jan 07 2022 06:04:46 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If that optimization took a node that was already fallible and transforms it to a node that will fail in the same cases, then you can just copy the existing BailoutKind over</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Jan 07 2022 06:05:39 GMT-0800 (Pacific Standard Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">confession: Delazification off-main-thread started! Ok, it is still crashing … like the past 2 days, but at least the code is now getting executed!</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Jan 07 2022 06:05:40 GMT-0800 (Pacific Standard Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Jan 07 2022 06:05:41 GMT-0800 (Pacific Standard Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If that optimization creates a new fallible node where we couldn't fail before, then we may want to add a new bailout kind that is specific to that optimization, so that we can turn it off for the next compilation of this script if we see that it's introducing unnecessary bailouts</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Jan 07 2022 06:07:38 GMT-0800 (Pacific Standard Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So for example GVN <a href="https://searchfox.org/mozilla-central/source/js/src/jit/ValueNumbering.cpp#787-789">copies the existing BailoutKind</a>, but InstructionReordering <a href="https://searchfox.org/mozilla-central/source/js/src/jit/InstructionReordering.cpp#232-237">uses a new BailoutKind</a></td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Jan 07 2022 06:39:35 GMT-0800 (Pacific Standard Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Weird, Despite calling <code>IsPromiseObject</code> to check that an object is indeed a promise, <code>GetPromiseResult</code> is failing the <code>as&lt;PromiseObject&gt;</code> cast</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Jan 07 2022 06:40:39 GMT-0800 (Pacific Standard Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Failure is because of the <code>MOZ_ASSERT</code> in it</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Jan 07 2022 06:40:47 GMT-0800 (Pacific Standard Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">are they exactly same pointer?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Jan 07 2022 06:41:14 GMT-0800 (Pacific Standard Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">iain: thank you for elaborating further!</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Jan 07 2022 06:41:20 GMT-0800 (Pacific Standard Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is there any <code>wrap</code> operation or something between them?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Jan 07 2022 06:42:19 GMT-0800 (Pacific Standard Time)">14:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I'm rooting it again, if that matters? (I should really stop passing around values and stuff instead of handles)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Jan 07 2022 06:43:08 GMT-0800 (Pacific Standard Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can you provide the code?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Jan 07 2022 06:43:48 GMT-0800 (Pacific Standard Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Give me a moment</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Jan 07 2022 06:54:07 GMT-0800 (Pacific Standard Time)">14:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-rs">// Pseudo
fn IonPromise::is_promise_raw(cx: *mut JSContext, obj: *mut JSObject) -&gt; bool {
    rooted!(in(cx) let mut robj = obj);
    IsPromiseObject(robj.handle().into())
}
fn IonPromise::from(cx: *mut IonContext, obj: *mut JSObject) -&gt; Option&lt;IonPromise&gt; {
    if IonPromise::is_promise_raw(cx, obj) {
        Some(IonPromise { obj })
    } else {
        None
    }
}
fn IonPromise::result(&amp;self, cx: *mut IonContext) -&gt; Value {
    rooted!(in(cx) let robj = self.obj);
    GetPromiseResult(robj.handle().into())
}

// Call
promise.result(cx);
</code></pre></td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Jan 07 2022 06:54:22 GMT-0800 (Pacific Standard Time)">14:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Pseudocode, but you should get the idea</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Jan 07 2022 06:55:47 GMT-0800 (Pacific Standard Time)">14:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Redfire</span>: what's the type of <code>IonPromise.obj</code> ?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Jan 07 2022 06:55:58 GMT-0800 (Pacific Standard Time)">14:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><code>*mut JSObject</code></td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Jan 07 2022 06:56:09 GMT-0800 (Pacific Standard Time)">14:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is it rooted somewhere?</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Jan 07 2022 06:56:34 GMT-0800 (Pacific Standard Time)">14:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I wonder if GC happens between them and the pointer becomes invalid</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Jan 07 2022 06:57:01 GMT-0800 (Pacific Standard Time)">14:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">As I said, I should definitely stop using raw values everywhere.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Jan 07 2022 06:57:24 GMT-0800 (Pacific Standard Time)">14:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">It's worked till now, but now I have to deal with it</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Jan 07 2022 06:58:16 GMT-0800 (Pacific Standard Time)">14:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">GC timing depends on the other code, and this kind of issue happen only sometimes</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Jan 07 2022 06:58:47 GMT-0800 (Pacific Standard Time)">14:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">anyway, I'd suggest checking if the raw pointer lives across GC</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Jan 07 2022 07:00:01 GMT-0800 (Pacific Standard Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I really didn't want to do wrapper structs using handles because i thought I'd need two types for each, one for mutable handles and one for regular handles</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Jan 07 2022 07:00:02 GMT-0800 (Pacific Standard Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in such case, you need to either make the field rooted, or add trace method to the struct and root the <code>IonPromise</code> from somewhere else</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Jan 07 2022 07:00:29 GMT-0800 (Pacific Standard Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">why you need 2 types?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Jan 07 2022 07:00:59 GMT-0800 (Pacific Standard Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I would need one thing to wrap handles and one to wrap mutable handles, no? </td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Jan 07 2022 07:01:41 GMT-0800 (Pacific Standard Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't understand the reasoning</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Jan 07 2022 07:04:42 GMT-0800 (Pacific Standard Time)">15:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, to be clear, you don't need to make the field <code>handle</code>.  you can have raw pointer.  but you just need <code>trace</code> method on the struct and let the owner of the instance call it</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Jan 07 2022 07:05:13 GMT-0800 (Pacific Standard Time)">15:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the instance lives only on the stack, you can also use <code>Rooted</code> as field type</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Jan 07 2022 07:10:30 GMT-0800 (Pacific Standard Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't know rust's <code>rooted</code> macro tho. in C++, what you need is, to have raw pointer field, and <code>trace</code> method that traces the raw pointer field.  now the class can be stored in <code>Rooted</code>.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Jan 07 2022 07:10:31 GMT-0800 (Pacific Standard Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>something like:</p>
<pre><code>class Foo {
  JSObject* obj = nullptr;
  void trace(JSTracer* trc);
}

void Foo::trace(JSTracer* trc) {
  TraceNullableRoot(trc, obj, "Foo.obj");
}

Rooted&lt;Foo*&gt; foo(cx, new Foo());
</code></pre>
</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Jan 07 2022 07:10:43 GMT-0800 (Pacific Standard Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so that the raw pointer field is kept valid across GC</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Jan 07 2022 07:11:18 GMT-0800 (Pacific Standard Time)">15:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">There's a <code>Trace</code> trait in rust-mozjs, which might be what I want</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Jan 07 2022 07:44:12 GMT-0800 (Pacific Standard Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span> <span class="nick-2">nbp</span> : is there a definition of what a Warp snapshot represents? is it a safepoint to bailout to if an assumption is no longer valid? do you assign snapshots only on fallible nodes?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Jan 07 2022 07:50:16 GMT-0800 (Pacific Standard Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: <a href="https://nbp.github.io/slides/RInstruction/?full#cover">This slide deck</a> may be of interest to you (I seem to recall it helping me, but it's been a long time)</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Jan 07 2022 07:54:43 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I'll have a look thank you!</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Jan 07 2022 07:55:23 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">seems <span class="nick-2">nbp</span> is one of the go-to JIT gurus in here :)</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Jan 07 2022 07:56:54 GMT-0800 (Pacific Standard Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">would've been lovely if there was a voice with each slide :)</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Jan 07 2022 07:59:05 GMT-0800 (Pacific Standard Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span> <span class="nick-2">nbp</span> at the LIRGenerator::generate stage, all nodes should have a <code>BailoutKind</code> at that point right?</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Jan 07 2022 08:01:27 GMT-0800 (Pacific Standard Time)">16:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: There are actually two completely different things that we call snapshots</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Jan 07 2022 08:02:44 GMT-0800 (Pacific Standard Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Warp snapshots are the inputs to WarpBuilder: we take a snapshot of the information needed to compile a script, and bundle it up so that we can do off-thread compilation.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Jan 07 2022 08:03:00 GMT-0800 (Pacific Standard Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The snapshots you're looking at are presumably the other kind, which I guess we just call snapshots</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Jan 07 2022 08:05:47 GMT-0800 (Pacific Standard Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And yeah, a snapshot contains the information necessary to rewind to the most recent safe point and resume execution after bailing out.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Jan 07 2022 08:07:28 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So in Lowering.cpp, whenever we lower a fallible MIR node to LIR, we call <code>assignSnapshot</code> and pass in the bailoutKind, which can't be Unknown</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Jan 07 2022 08:09:01 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">why can't it be Unknown? If I understood correctly, optimization phases can create nodes of themselves according to <code>So if it's unknown, it probably means that we generated it during an optimization</code></td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Jan 07 2022 08:10:04 GMT-0800 (Pacific Standard Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Because we assert that it's not Unknown when we generate the snapshot: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/shared/Lowering-shared.cpp#275">https://searchfox.org/mozilla-central/source/js/src/jit/shared/Lowering-shared.cpp#275</a></td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Jan 07 2022 08:10:06 GMT-0800 (Pacific Standard Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">it can't be Unkown because Lowering.cpp is the last and final stage?</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Jan 07 2022 08:10:43 GMT-0800 (Pacific Standard Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You can have nodes with BailoutKind::Unknown iff they're infallible</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Jan 07 2022 08:11:05 GMT-0800 (Pacific Standard Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">understood, makes sense</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Jan 07 2022 08:14:43 GMT-0800 (Pacific Standard Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The other piece of this puzzle is resume points, which are basically the MIR equivalent of snapshots in LIR. After every effectful operation, we create a resume point, which represents the state of the VM stack after that operation </td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Jan 07 2022 08:14:57 GMT-0800 (Pacific Standard Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And that information is encoded in the snapshots</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Jan 07 2022 08:16:18 GMT-0800 (Pacific Standard Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which means that at any point that we bail out, we can go back to the last safe point, and the snapshot can point us to a node for every local variable / value on the operand stack</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Jan 07 2022 08:18:27 GMT-0800 (Pacific Standard Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">Oh I see. So there are Warp snapshots (first stage), MIR snapshots aka resume points (second stage) and finally LIR snapshots?</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Jan 07 2022 08:18:53 GMT-0800 (Pacific Standard Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I'd say that Warp snapshots are a separate thing with a misleading name</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Jan 07 2022 08:19:39 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Which I'm allowed to say because I was involved in naming them :P)</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Jan 07 2022 08:20:18 GMT-0800 (Pacific Standard Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But the rest of your sentence is roughly right: roughly speaking, resume points in MIR turn into snapshots in LIR</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Jan 07 2022 08:25:49 GMT-0800 (Pacific Standard Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: Warp snapshots are not the same as Ion snapshot. (see <span class="nick-4">iain</span> comment)</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Jan 07 2022 08:26:45 GMT-0800 (Pacific Standard Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">thank you for the clear answers <span class="nick-4">iain</span></td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Jan 07 2022 08:28:21 GMT-0800 (Pacific Standard Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: MIR ResumePoint capture the equivalent interpreter stack. Instead of having Values on the stack, we have MIR instructions which are computing the values.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Jan 07 2022 08:28:47 GMT-0800 (Pacific Standard Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">I'd appreciate it even further if you folks point me to some code that does what you're mentioning :D</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Jan 07 2022 08:29:18 GMT-0800 (Pacific Standard Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: LIR snapshots are a list of all value allocations. These are used to reconstruct the interpreter frame described by the resume points.</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Jan 07 2022 08:32:09 GMT-0800 (Pacific Standard Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpCacheIRTranspiler.cpp#2337-2348">https://searchfox.org/mozilla-central/source/js/src/jit/WarpCacheIRTranspiler.cpp#2337-2348</a> <code>pushResult</code> will set the top of the stack slot emulation with the Add instruction.</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Jan 07 2022 08:33:27 GMT-0800 (Pacific Standard Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: When resume points are created, they copy these slots. <a href="https://searchfox.org/mozilla-central/source/js/src/jit/MIR.cpp#3361-3363,3369-3374">https://searchfox.org/mozilla-central/source/js/src/jit/MIR.cpp#3361-3363,3369-3374</a></td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Jan 07 2022 08:33:30 GMT-0800 (Pacific Standard Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: I see! Shouldn't you at that point emit some info in case of bailout (of the overflow case let's say)?</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Fri Jan 07 2022 08:34:09 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The resume point is exactly that information </td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Fri Jan 07 2022 08:34:28 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We have checks that will bail out in case of overflow.</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Fri Jan 07 2022 08:34:36 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If that happens, we will revert to the last known-good state</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Fri Jan 07 2022 08:34:38 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: We do, this is what the RecoverInfo and Snapshot are for, they are written after the code, and describe how to get these information when we bailout.</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Fri Jan 07 2022 08:35:32 GMT-0800 (Pacific Standard Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The resume point says "after the last effectful operation, this is the state of the VM stack". </td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Fri Jan 07 2022 08:36:00 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So when we bail out, we effectively go back in time to just after the last effectful operation, and we recreate the state at that point</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Fri Jan 07 2022 08:37:26 GMT-0800 (Pacific Standard Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">stratan</span>: See <a href="https://searchfox.org/mozilla-central/source/js/src/jit/shared/CodeGenerator-shared.cpp#540">CodeGeneratorShared::encode(LSnapshot*)</a></td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Fri Jan 07 2022 08:38:53 GMT-0800 (Pacific Standard Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p>For example, here's a useless little function:</p>
<pre><code>function foo() {
  var x = 1;
  var y = 2;
  var z = 1 + bar(x,y);
  return z;
}
</code></pre>
<p>There are two resume points in this function: one at the beginning, and one after the call to bar. We can't rewind past the call, because it could have arbitrary side-effects.</p>
</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Fri Jan 07 2022 08:39:34 GMT-0800 (Pacific Standard Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">you mean <code>bar</code> could modify what's after the caller calls it? that's why you can't rewind?</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Fri Jan 07 2022 08:40:25 GMT-0800 (Pacific Standard Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Let's say that bar always returns an integer</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Fri Jan 07 2022 08:40:40 GMT-0800 (Pacific Standard Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So we have an MAdd that will add 1 to the result of bar(x,y)</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Fri Jan 07 2022 08:40:53 GMT-0800 (Pacific Standard Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If that ever overflowed, we would have to bail out</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Fri Jan 07 2022 08:41:41 GMT-0800 (Pacific Standard Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If so, we can't go all the way back to the beginning of foo(), because calling bar() could have a side effect (like printing a message, or incrementing a counter, etc...)</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Fri Jan 07 2022 08:42:02 GMT-0800 (Pacific Standard Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So we need a resume point that captures the state of the world after calling bar</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Fri Jan 07 2022 08:42:14 GMT-0800 (Pacific Standard Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In this case, it would look something like: <code>resumepoint 18 6 1 5 4 0 1 1</code></td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Fri Jan 07 2022 08:42:28 GMT-0800 (Pacific Standard Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Re-executing <code>bar</code> could have noticeable side-effect. Thus we cannot re-execute <code>bar</code>. We add a resume point to capture the state of the interpreter after <code>bar</code>, such that any failure such as an overflow in <code>z + …</code> would not re-execute <code>bar</code>, but would resume after the execution of <code>bar</code>, at the resume point.</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Fri Jan 07 2022 08:43:47 GMT-0800 (Pacific Standard Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Here's a screenshot of my ionlog output, in case you want to follow along</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Fri Jan 07 2022 08:43:51 GMT-0800 (Pacific Standard Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">A Snapshot captures the allocations made by the register allocator, in order to reconstruct the interpreter stack described by the resume point.</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Fri Jan 07 2022 08:45:38 GMT-0800 (Pacific Standard Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">18 is the result of the call, which is still on the stack waiting to be added. 6 is the constant 1, also on the stack. 1, 5, and 4 are the local variables z, y, and x respectively: y and x contain constant values, and z contains undefined because we haven't stored anything in it yet.</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Fri Jan 07 2022 08:46:42 GMT-0800 (Pacific Standard Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The last <code>0 1 1</code> is <code>this</code>, the return value, and the environment chain, in an order I can never remember without looking it up. If this function used <code>arguments</code>, it would also have a slot here.</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Fri Jan 07 2022 08:47:58 GMT-0800 (Pacific Standard Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So each resume point captures a set of definitions, which collectively can be used to recreate the state of the VM in the baseline interpreter after we bail out</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Fri Jan 07 2022 08:48:40 GMT-0800 (Pacific Standard Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And then all the snapshot stuff, and anything you might see about recover instructions, is just a bunch of details about how we encode that information efficiently</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Fri Jan 07 2022 08:49:54 GMT-0800 (Pacific Standard Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(For some value of "efficiently"; we have vague plans to use a more memory efficient delta encoding, but we haven't gotten around to implementing it.)</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Fri Jan 07 2022 08:50:29 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">super cool, insightful and clear example!</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Fri Jan 07 2022 08:50:37 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I would point to specific parts of the code here, but I'm not sure what the most relevant parts are. It's all kind of distributed.</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Fri Jan 07 2022 08:51:22 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">I think both you and <span class="nick-2">nbp</span> shared enough code keywords to look around myself :)</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Fri Jan 07 2022 08:51:39 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (For some value of "efficiently"; we have vague plans to use a more memory efficient delta encoding, but we haven't gotten around to implementing it.)</blockquote></mx-reply>Noting that this has to be decoded without relying on allocated memory … (my 2 cents)</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Fri Jan 07 2022 08:52:41 GMT-0800 (Pacific Standard Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">Seems like Friday is the day to pick your brains apart. Much appreciated :D</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Fri Jan 07 2022 08:52:41 GMT-0800 (Pacific Standard Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Resume points are MResumePoint in MIR.h, snapshots are implemented in Snapshots.cpp, there's a whole additional mechanism for pushing computation into the bailout path in Recover.cpp, bailouts happen in Bailouts.cpp and BaselineBailouts.cpp</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Fri Jan 07 2022 08:52:43 GMT-0800 (Pacific Standard Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">(or maybe used to have … :pending mistery to anyone who might dig too much in recover instructions:)</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Fri Jan 07 2022 08:53:08 GMT-0800 (Pacific Standard Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: Why no allocated memory?</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Fri Jan 07 2022 08:53:56 GMT-0800 (Pacific Standard Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: because we have/had no way to bubble up allocation issues.</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Fri Jan 07 2022 08:54:04 GMT-0800 (Pacific Standard Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The delta encoding is something I've heard jandem mention, but I have never looked into the details myself</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Fri Jan 07 2022 08:55:02 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, in that case you know that my personal recommendation is, as always, that we should just crash on small OOMs :)</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Fri Jan 07 2022 08:55:46 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(But also I think it should be possible to read a delta encoding without allocating memory)</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Fri Jan 07 2022 08:57:22 GMT-0800 (Pacific Standard Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">thank you for your time and explanations <span class="nick-4">iain</span> <span class="nick-2">nbp</span> :)</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Fri Jan 07 2022 08:57:41 GMT-0800 (Pacific Standard Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@stratan:matrix.org">stratan</span>&gt;</div></td><td class="msg-cell">I'll be back with more questions once I re-iterate and digest all this info dump</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Fri Jan 07 2022 09:02:29 GMT-0800 (Pacific Standard Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You're welcome! I haven't been working on this code for so long that I don't still appreciate an opportunity to explain things and make sure my own mental models are in working order</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Fri Jan 07 2022 10:56:54 GMT-0800 (Pacific Standard Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">I am having an issue with a embedded SpiderMonkey 78, basically every time we use a regular expression where the result set exceeds 9, I get a  "too much recursion" error - for instance doing a match on "1,2,3,4,5,6,7,8,9,10" with /([0-9])+/g. This is working fine with an older version of SpiderMonkey</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Fri Jan 07 2022 11:00:47 GMT-0800 (Pacific Standard Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">are you using <code>JS_SetNativeStackQuota</code>?</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Fri Jan 07 2022 11:00:55 GMT-0800 (Pacific Standard Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">let me check</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Fri Jan 07 2022 11:01:37 GMT-0800 (Pacific Standard Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">no it does not look like it</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Fri Jan 07 2022 11:02:15 GMT-0800 (Pacific Standard Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it's weird, I would expect <a href="https://searchfox.org/mozilla-central/source/js/src/vm/JSContext.cpp#156">InitDefaultStackQuota</a> to give you reasonable values</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Fri Jan 07 2022 11:04:13 GMT-0800 (Pacific Standard Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe <code>js::GetNativeStackBaseImpl</code> isn't getting the right thing.</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Fri Jan 07 2022 11:05:18 GMT-0800 (Pacific Standard Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess I'm assuming it's the stack limit check, but maybe not.</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Fri Jan 07 2022 11:05:21 GMT-0800 (Pacific Standard Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: ^</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Fri Jan 07 2022 11:31:42 GMT-0800 (Pacific Standard Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Hmm, that's weird. Off the top of my head I can't think of a good explanation.</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Fri Jan 07 2022 11:31:59 GMT-0800 (Pacific Standard Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The new regex engine landed in 78, but I don't think I've seen that problem before.</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Fri Jan 07 2022 11:34:49 GMT-0800 (Pacific Standard Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">dheitbrink</span>: Are you doing anything with interrupts?</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Fri Jan 07 2022 11:35:51 GMT-0800 (Pacific Standard Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@mdashti:mozilla.org">mdashti</span>&gt;</div></td><td class="msg-cell">Hi, a newbie question. How do you run the linter on the code written in the Firefox codebase?</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Fri Jan 07 2022 11:35:54 GMT-0800 (Pacific Standard Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">Not that I can think of, I would have to look with the interrupts, Just playing around with it, it seems if I set JS_SetNativeStackQuota, to something unreasonably high, it solves the issue.</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Fri Jan 07 2022 11:36:24 GMT-0800 (Pacific Standard Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Huh, okay, if setting the stack limit fixes it then the interrupt thing is a red herring</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Fri Jan 07 2022 11:37:54 GMT-0800 (Pacific Standard Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, one possibility: I think we've had a few bugs where somebody called into the engine to execute a regular expression from a position where we were already over a stack limit</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Fri Jan 07 2022 11:38:30 GMT-0800 (Pacific Standard Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Is it possible that you've already used up your stack quota before calling into the engine?</td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Fri Jan 07 2022 11:39:11 GMT-0800 (Pacific Standard Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">I tend to doubt it, the stack should be real shallow where this is being called</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Fri Jan 07 2022 11:39:24 GMT-0800 (Pacific Standard Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">mdashti</span>: If you use <code>./mach help</code>, there are a variety of linting options in the "Development Environment" section, depending on what you want to lint</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Fri Jan 07 2022 11:40:13 GMT-0800 (Pacific Standard Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I believe the default configuration also runs a variety of linters as commit hooks, although I can never keep track of which ones</td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Fri Jan 07 2022 11:41:53 GMT-0800 (Pacific Standard Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(By default configuration I mean the mercurial configuration wizard that optionally runs as part of ./mach bootstrap. I think clang-format= and js-format= are the .hgrc options that do it.)</td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Fri Jan 07 2022 11:52:00 GMT-0800 (Pacific Standard Time)">19:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">dheitbrink</span>: It only happens with global matches? That seems weird. Nothing comes to mind as an explanation.</td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Fri Jan 07 2022 11:52:54 GMT-0800 (Pacific Standard Time)">19:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">Yeah, I do not seem to be having this issue with non-global matches. </td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Fri Jan 07 2022 14:22:28 GMT-0800 (Pacific Standard Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@mtigley:mozilla.org">mtigley</span>&gt;</div></td><td class="msg-cell">Hello! I've been working on an issue where I need to load a script from a system addon into a .jsm file: <a href="https://phabricator.services.mozilla.com/D109073?id=525434#inline-744206">https://phabricator.services.mozilla.com/D109073?id=525434#inline-744206</a>

But it's failing at this assertion here: <a href="https://searchfox.org/mozilla-central/rev/682e5a82d403974bacb779c1db515962d946be48/js/xpconnect/loader/mozJSSubScriptLoader.cpp#264">https://searchfox.org/mozilla-central/rev/682e5a82d403974bacb779c1db515962d946be48/js/xpconnect/loader/mozJSSubScriptLoader.cpp#264</a> on debug builds.</td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Fri Jan 07 2022 14:23:16 GMT-0800 (Pacific Standard Time)">22:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@mtigley:mozilla.org">mtigley</span>&gt;</div></td><td class="msg-cell">After some getting some help from <a href="https://matrix.to/#/#fx-desktop-dev:mozilla.org">#fx-desktop-dev:mozilla.org</a>, it looks like the issue might be because we don't update the original content length if it's still -1: <a href="https://searchfox.org/mozilla-central/rev/682e5a82d403974bacb779c1db515962d946be48/js/xpconnect/loader/mozJSSubScriptLoader.cpp#252-254">https://searchfox.org/mozilla-central/rev/682e5a82d403974bacb779c1db515962d946be48/js/xpconnect/loader/mozJSSubScriptLoader.cpp#252-254</a>. Since this looks to be part of the JS engine, I wanted to confirm if we'd need to <code>SetContentLength</code> in that check as well.</td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Fri Jan 07 2022 14:52:07 GMT-0800 (Pacific Standard Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">mtigley</span>: I doubt the current code matches the comment</td></tr>
  <tr class="msg" id="L150"><td class="ts-cell"><a class="ts" href="#L150" alt="Fri Jan 07 2022 14:52:56 GMT-0800 (Pacific Standard Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't know the restriction about <code>GetContentLength()</code> mentioned there, but it would be better asking the author/reviewer of the patch that added the assertion</td></tr>
  <tr class="msg" id="L151"><td class="ts-cell"><a class="ts" href="#L151" alt="Fri Jan 07 2022 14:53:48 GMT-0800 (Pacific Standard Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">to me, "that value" seems to point "correct value"</td></tr>
  <tr class="msg" id="L152"><td class="ts-cell"><a class="ts" href="#L152" alt="Fri Jan 07 2022 14:54:26 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and the comment sounds like <code>len</code> is overwritten by <code>NS_ReadInputStreamToString</code></td></tr>
  <tr class="msg" id="L153"><td class="ts-cell"><a class="ts" href="#L153" alt="Fri Jan 07 2022 14:54:33 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@mdashti:mozilla.org">mdashti</span>&gt;</div></td><td class="msg-cell"><p>Thanks. I'm using VSCode, and get this error:</p>
<pre><code>YAML:28:19: error: unknown key 'StatementMacros'
StatementMacros: [MARKUPMAP, ASSERT_TRUE, ASSERT_FALSE, TEST, CHECK]
                  ^
Error reading /home/ubuntu/spidermonkey/.clang-format: Invalid argument
</code></pre>
<p>when I use the default "Format on Save". Any suggestion?</p>
</td></tr>
  <tr class="msg" id="L154"><td class="ts-cell"><a class="ts" href="#L154" alt="Fri Jan 07 2022 14:59:08 GMT-0800 (Pacific Standard Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">mdashti</span>: what version of clang-format are you using?</td></tr>

</tbody></table></div></div></div>
</body></html>