<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-08-20</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-08-20<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-08-19" class="nav-link"><span>prev</span></a>
<a href="2024-08-21" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Aug 20 2024 00:18:57 GMT-0700 (Pacific Daylight Time)">07:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> You've had 13 years to fix it. What have you been doing all this time?</blockquote></mx-reply>It's been waiting for your review for 12 of those years</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Aug 20 2024 00:19:09 GMT-0700 (Pacific Daylight Time)">07:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">(Not really, but it could have been, right? :))</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Aug 20 2024 01:17:21 GMT-0700 (Pacific Daylight Time)">08:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell">May <code>binding_detail::AutoSequence</code> (<a href="https://searchfox.org/mozilla-central/rev/527d691a542ccc0f333e36689bd665cb000360b2/dom/bindings/BindingDeclarations.h#526,528">https://searchfox.org/mozilla-central/rev/527d691a542ccc0f333e36689bd665cb000360b2/dom/bindings/BindingDeclarations.h#526,528</a>) be used instead of <code>Sequence</code>  for a compile-time known Sequence of length 2?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Aug 20 2024 01:17:39 GMT-0700 (Pacific Daylight Time)">08:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell">Outside of binding code, though.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Aug 20 2024 01:30:59 GMT-0700 (Pacific Daylight Time)">08:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">I would recommend against</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Aug 20 2024 03:06:48 GMT-0700 (Pacific Daylight Time)">10:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">Ms2ger</span>: why?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Aug 20 2024 03:13:04 GMT-0700 (Pacific Daylight Time)">10:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">I would assume that method to be considered private to the bindings implementation</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Aug 20 2024 03:13:15 GMT-0700 (Pacific Daylight Time)">10:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">Though maybe <a href="https://matrix.to/#/#dom:mozilla.org">#dom:mozilla.org</a> could give a more definitive answer</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Aug 20 2024 03:17:46 GMT-0700 (Pacific Daylight Time)">10:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I would assume that method to be considered private to the bindings implementation</blockquote></mx-reply>From the comment only, or from its functionality too? If so, why?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Aug 20 2024 03:18:50 GMT-0700 (Pacific Daylight Time)">10:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><code>detail</code> in a namespace implies that</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Aug 20 2024 03:19:30 GMT-0700 (Pacific Daylight Time)">10:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell">Yeah, but does it make sense?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Aug 20 2024 03:20:35 GMT-0700 (Pacific Daylight Time)">10:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell">It could of course be moved out of that namespace.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Aug 20 2024 03:22:02 GMT-0700 (Pacific Daylight Time)">10:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">well, if you want it, do it!</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Aug 20 2024 03:22:10 GMT-0700 (Pacific Daylight Time)">10:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell">:D</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Aug 20 2024 03:23:08 GMT-0700 (Pacific Daylight Time)">10:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">I doubt you really need it.  AutoTArray would probably work</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Aug 20 2024 03:31:13 GMT-0700 (Pacific Daylight Time)">10:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">exactly</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Aug 20 2024 06:52:15 GMT-0700 (Pacific Daylight Time)">13:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: "We should be able to remove these overloads when gcc hazard builds use modern clang" - do you know if this is possible yet? <a href="https://searchfox.org/mozilla-central/source/js/public/ComparisonOperators.h#188-189">https://searchfox.org/mozilla-central/source/js/public/ComparisonOperators.h#188-189</a></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Aug 20 2024 06:52:53 GMT-0700 (Pacific Daylight Time)">13:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Oh, if that really requires clang then I guess not</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Aug 20 2024 07:01:33 GMT-0700 (Pacific Daylight Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Are there any instances of <code>JS::TranscodeBuffer</code> actually being saved to a file?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Aug 20 2024 07:05:41 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: yes we do that in a few places. Why?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Aug 20 2024 07:06:10 GMT-0700 (Pacific Daylight Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">was trying to find the proper 1:1 way to do it instead of guessing it</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Aug 20 2024 07:12:18 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">is std::filesystem used?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Aug 20 2024 07:12:21 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/527d691a542ccc0f333e36689bd665cb000360b2/dom/xul/nsXULElement.cpp#1512-1534">here's code</a> that writes to a stream</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Aug 20 2024 07:13:40 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the JS shell <a href="https://searchfox.org/mozilla-central/rev/527d691a542ccc0f333e36689bd665cb000360b2/js/src/shell/js.cpp#11672-11718">has code</a> for writing self-hosted code to a file, but that uses a slightly different API</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Aug 20 2024 07:15:08 GMT-0700 (Pacific Daylight Time)">14:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">hello, two questions: can one completely disable gc? not just postpone it ; does it makes sense that a webpage would have allocated ~3-4GB, and that after expected gc/cc and even forcing it via about:memory (+ minimize memory usage) it still reports 3-4GB in about:processes?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Aug 20 2024 07:19:34 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">What does XDR stand for?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Aug 20 2024 07:21:07 GMT-0700 (Pacific Daylight Time)">14:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: <a href="https://en.wikipedia.org/wiki/External_Data_Representation">https://en.wikipedia.org/wiki/External_Data_Representation</a> . These days in SM it's just the Stencil serialization format but the XDR name goes back to very old SM versions</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Aug 20 2024 07:27:27 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">gerard-majax</span>: it could be a leak in Firefox, or the website just allocates a lot of memory (or leaks). An about:memory report might tell us why it's using so much memory</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Aug 20 2024 07:28:15 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: i captured the logs, but it's not a website, it's a microbenchmark as a local file and i dont think it should leak at that level</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Aug 20 2024 07:28:34 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">it's the code emilio shared: <a href="https://bugzilla.mozilla.org/attachment.cgi?id=9419417&amp;action=edit">https://bugzilla.mozilla.org/attachment.cgi?id=9419417&amp;action=edit</a></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Aug 20 2024 07:28:49 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">i'd like to make sure that the figures I see are not related to that issue</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Aug 20 2024 07:32:09 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">oh almost 3 GB of dom/orphan-nodes in about:memory</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Aug 20 2024 07:33:49 GMT-0700 (Pacific Daylight Time)">14:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">emilio</span>: ^</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Aug 20 2024 07:34:48 GMT-0700 (Pacific Daylight Time)">14:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">even <code>window.onload = undefined;</code> i could not see freeing that memory</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Aug 20 2024 07:35:48 GMT-0700 (Pacific Daylight Time)">14:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: we should look what is keeping those nodes alive... <span class="nick-8">gerard-majax</span> can you file a separate bug for that?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Aug 20 2024 07:35:58 GMT-0700 (Pacific Daylight Time)">14:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">sure</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Aug 20 2024 07:36:00 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">Ah no</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Aug 20 2024 07:36:02 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">it's expected</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Aug 20 2024 07:36:09 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">is it?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Aug 20 2024 07:36:12 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><code>window.a = tree.querySelectorAll("*")</code></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Aug 20 2024 07:36:18 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">oh</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Aug 20 2024 07:36:22 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">That basically puts all the nodes on a list and hangs it off the global</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Aug 20 2024 07:36:56 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">nulled both</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Aug 20 2024 07:37:02 GMT-0700 (Pacific Daylight Time)">14:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">CPU 100% likely gc?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Aug 20 2024 07:37:10 GMT-0700 (Pacific Daylight Time)">14:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">down to 2GB</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Aug 20 2024 07:37:10 GMT-0700 (Pacific Daylight Time)">14:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">I thought you were seeing it on the second test-case I attached to that bug (that doesn't return any node in the list)</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Aug 20 2024 07:38:26 GMT-0700 (Pacific Daylight Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">weird</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Aug 20 2024 07:38:51 GMT-0700 (Pacific Daylight Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell"><code>window.a = null; window.b = null; window.onload = null;</code>, still 2GB visible</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Aug 20 2024 07:39:03 GMT-0700 (Pacific Daylight Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">about:memory shows dom/orphan-nodes</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Aug 20 2024 07:39:20 GMT-0700 (Pacific Daylight Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">even after GC, CC and minimize memory</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Aug 20 2024 07:40:24 GMT-0700 (Pacific Daylight Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I doubt you really need it.  AutoTArray would probably work</blockquote></mx-reply>Indeed</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Aug 20 2024 07:42:02 GMT-0700 (Pacific Daylight Time)">14:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">gerard-majax</span>: ok that seems worth digging into. Please file and attach the modified test-case?</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Aug 20 2024 07:45:40 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell">ok i was doing it from the console, doing from the test it goes back to 18MB</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Aug 20 2024 08:07:04 GMT-0700 (Pacific Daylight Time)">15:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@gerard-majax:mozilla.org">gerard-majax</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: but no way to completely disable the gc to verify?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Aug 20 2024 08:40:03 GMT-0700 (Pacific Daylight Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> ok i was doing it from the console, doing from the test it goes back to 18MB</blockquote></mx-reply>Devtools has the tendency to leak the entire page FWIW</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Aug 20 2024 10:18:42 GMT-0700 (Pacific Daylight Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">In warp builder I see the following <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpSnapshot.h#44-46">environment objects</a> being referred to and one example use <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpBuilder.cpp#2021">here</a> my question is it like guranteed that the other environment objects wont appear here? specifically thinking about ModuleEnvironmentObject is it like guranteed that the snapshot wont capture a ModuleEnvironmentObject?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Aug 20 2024 10:24:48 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">debadree25</span>: Those snapshots are created <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpOracle.cpp#458-511">here</a>. They're each created by a specific op (or set of ops). There are currently no ops that push a ModuleEnvironmentObject, so we don't have any need for WarpModuleEnvironment. (Compare the results if you search <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Opcodes.h#3364">Opcodes.h</a> for <code>ClassBodyEnvironmentObject</code> vs <code>ModuleEnvironmentObject</code>)</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Aug 20 2024 10:25:35 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-12">sfink</span>: "We should be able to remove these overloads when gcc hazard builds use modern clang" - do you know if this is possible yet? <a href="https://searchfox.org/mozilla-central/source/js/public/ComparisonOperators.h#188-189">https://searchfox.org/mozilla-central/source/js/public/ComparisonOperators.h#188-189</a></blockquote></mx-reply>It's possible that newer gcc handles it differently, though I'm not sure we've upgraded gcc in the last 4 years.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Aug 20 2024 10:27:30 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">WarpOracle runs on the main thread and takes a snapshot of all the information that is needed for a compilation. Then we send that snapshot to a background thread where WarpBuilder turns it all into MIR.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Aug 20 2024 10:30:39 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-12">debadree25</span>: Those snapshots are created <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpOracle.cpp#458-511">here</a>. They're each created by a specific op (or set of ops). There are currently no ops that push a ModuleEnvironmentObject, so we don't have any need for WarpModuleEnvironment. (Compare the results if you search <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Opcodes.h#3364">Opcodes.h</a> for <code>ClassBodyEnvironmentObject</code> vs <code>ModuleEnvironmentObject</code>)</blockquote></mx-reply>so in case a opcode which would operate the EnvironmentObject and it could either be LexicalEnvironmentObject or ModuleEnvironmentObject we first have to add handling for the same here to create a snapshot</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Aug 20 2024 10:43:22 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">debadree25</span>: I think that sounds about right.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Aug 20 2024 10:43:40 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">What does the baseline code look like in this case?</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Aug 20 2024 10:48:23 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> What does the baseline code look like in this case?</blockquote></mx-reply>baseline code just calls into vm</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Aug 20 2024 10:49:32 GMT-0700 (Pacific Daylight Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">debadree25</span>: Assuming we're talking about <a href="https://phabricator.services.mozilla.com/D219406">this patch</a>, I suspect you will want to store the disposeCapability ArrayObject in the snapshot, not the environment itself.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue Aug 20 2024 10:50:26 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Actually, wait, maybe I'm wrong there</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue Aug 20 2024 10:50:31 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Let me read this patch more closely</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue Aug 20 2024 10:50:56 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-12">debadree25</span>: Assuming we're talking about <a href="https://phabricator.services.mozilla.com/D219406">this patch</a>, I suspect you will want to store the disposeCapability ArrayObject in the snapshot, not the environment itself.</blockquote></mx-reply>the array idea sounds very nice it would be very good if can do that</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue Aug 20 2024 10:58:21 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">debadree25</span>: If you're just doing VM calls, it looks to me like you don't need to store the environment object at all?</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue Aug 20 2024 10:59:59 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">So basically as define this op as a LIR op that calls the vm?</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue Aug 20 2024 11:01:07 GMT-0700 (Pacific Daylight Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That's the simplest way to get something working</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue Aug 20 2024 11:02:18 GMT-0700 (Pacific Daylight Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I haven't been following this project closely enough to understand what these ops do, so I don't know whether the operation that's being done is simple enough that we could reasonably write it in masm, or whether calling into the VM is just the best approach.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue Aug 20 2024 11:03:41 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">i was thinking along the lines of reading this <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpBuilder.cpp#2025">code</a> that i could just retrive the environment object here and just call the method to add the resources into it (i have another patch in which i have moved all the handling of property access to existing bytecode so all these ops do it retrive the array and push on to it or pop of it)</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue Aug 20 2024 11:06:01 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">CreateSuppressedError seems like the sort of op that shouldn't be hot, so a VM call is probably fine as the final implementation. Pushing/popping from an array is the sort of thing that we can eventually implement pretty efficiently in native code, but for an initial prototype, VM calls are totally fine</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Tue Aug 20 2024 11:06:14 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Especially if you're still working out exactly what the bytecode is going to look like</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Tue Aug 20 2024 11:06:55 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The main difference between a VM call and native code is just performance, and we don't care about performance here yet</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Tue Aug 20 2024 12:01:51 GMT-0700 (Pacific Daylight Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>I've never seem this message from UpdateBot before, but I love it:</p>
<blockquote>
<p>All the jobs in the try run succeeded. Like literally all of them, there weren't<br>even any intermittents. That is pretty surprising to me, so maybe you should double<br>check to make sure I didn't misinterpret things and that the correct tests ran...</p>
<p>Anyway, I've done all I can, so I'm passing to you to review and land the patch.<br>When reviewing, please note that this is external code, which needs a full and<br>careful inspection - not a rubberstamp.</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Tue Aug 20 2024 13:23:19 GMT-0700 (Pacific Daylight Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: Bug 1904429 should be back on your queue now -- I think it's pretty good now.</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Tue Aug 20 2024 13:34:23 GMT-0700 (Pacific Daylight Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">debadree25</span>: Note that in the PushLexicalEnv case, we want to allocate a new environment object, so we're passing in a template and <a href="https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#4389-4409">using that in the code generator</a> as an input to <code>createGCObject</code> (roughly speaking: "allocate a new object that looks like this"). It doesn't look like you're allocating anything, so what you probably want is for your codegen to use the <em>current</em> environment object. (<a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpBuilder.cpp#2920-2932">build_Lambda</a> is an example of what that might look like)</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Tue Aug 20 2024 13:38:13 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">oh! the environmentChain is indeed there!! nice</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Tue Aug 20 2024 13:40:22 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">ok a rookie question what does<code>current-&gt;add</code> and <code>current-&gt;push</code> i understand its a graph so this would be adding edges?</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Tue Aug 20 2024 13:43:11 GMT-0700 (Pacific Daylight Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">MIR is arranged into a control flow graph (CFG) consisting of <a href="https://en.wikipedia.org/wiki/Basic_block">basic blocks</a> connecting by control flow edges. <code>current</code> is the block we're in the process of building. <code>add</code> inserts an instruction at the end of the current block.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Tue Aug 20 2024 13:47:53 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">While we're in the process of building MIR, we keep track of the state of the VM stack. For example, if you have the bytecode <code>GetArg / GetArg / Add</code>, then the first two instructions push a value on the stack, and the Add pops two values and pushes a result. <code>current-&gt;push</code> and <code>current-&gt;pop</code> update the virtual state of the stack: you push a MIR instruction onto the stack so that a subsequent op can pull it off and use it as an operand to a new MIR instruction.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Tue Aug 20 2024 13:52:59 GMT-0700 (Pacific Daylight Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> While we're in the process of building MIR, we keep track of the state of the VM stack. For example, if you have the bytecode <code>GetArg / GetArg / Add</code>, then the first two instructions push a value on the stack, and the Add pops two values and pushes a result. <code>current-&gt;push</code> and <code>current-&gt;pop</code> update the virtual state of the stack: you push a MIR instruction onto the stack so that a subsequent op can pull it off and use it as an operand to a new MIR instruction.</blockquote></mx-reply>ohhh i see got it!</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Tue Aug 20 2024 13:55:11 GMT-0700 (Pacific Daylight Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">i guess maybe it can be done without vm call since we can have the (virtual) stack and the environment chain also</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Tue Aug 20 2024 14:13:03 GMT-0700 (Pacific Daylight Time)">21:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-4">iain</span>: So I've got a patch that sets the allocSite on the context; if I try to wire this into the MIR such that I set the actual predicted heap in warp when we transpile the cacheIR op, I'm faced with a challenge -- currently the code asserts because the instruction is marked as effectful, and we can only have one effectful instruction per block.</p>
<p>I see "effectfulness" is essentially "Hey, does the alias set say this is a store"</p>
<p>So I'm wondering how this is best handled architecturally... should I be 1) using addEffectfulUnsafe 2) setting a custom aliasset on my MIR node? 3) something else?</p>
</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Tue Aug 20 2024 14:15:38 GMT-0700 (Pacific Daylight Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">debadree25</span>: If I understand correctly, there are three ops. JSOp::AddDisposable takes the object on top of the stack and pushes it into the array in a reserved slot on the current environment. JSOp::TakeDisposeCapability removes the array from the current environment and pushes it onto the stack. JSOp::CreateSuppressedError does some error handling stuff. CreateSuppressedError shouldn't need a fast implementation, since it shouldn't be on a hot path. The other two seem like they should be implementable in jitcode, with a little bit of work (eg you need to make sure you can handle the case where the array isn't currently big enough to push another element). But a VM call is okay for now. Note that if we can generate nice jitcode in Warp/Ion, we can probably also do the same in baseline.</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Tue Aug 20 2024 14:17:45 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-12">debadree25</span>: If I understand correctly, there are three ops. JSOp::AddDisposable takes the object on top of the stack and pushes it into the array in a reserved slot on the current environment. JSOp::TakeDisposeCapability removes the array from the current environment and pushes it onto the stack. JSOp::CreateSuppressedError does some error handling stuff. CreateSuppressedError shouldn't need a fast implementation, since it shouldn't be on a hot path. The other two seem like they should be implementable in jitcode, with a little bit of work (eg you need to make sure you can handle the case where the array isn't currently big enough to push another element). But a VM call is okay for now. Note that if we can generate nice jitcode in Warp/Ion, we can probably also do the same in baseline.</blockquote></mx-reply>yes indeed that is the case essentially Add and Take just either push or remove the capability i guess the array part can still be handled because during parsing we know how many bindings there will be so we can allocate an array of exact size too iguess</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Tue Aug 20 2024 14:19:09 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: Interesting question. One option is definitely to say AliasSet::None.</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Tue Aug 20 2024 14:19:23 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I'm trying to think through whether that is safe.</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Tue Aug 20 2024 14:19:30 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You probably don't want it to be movable.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Tue Aug 20 2024 14:19:34 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I had already marked it as non-movable </td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Tue Aug 20 2024 14:19:45 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">so... maybe AliasSet::none make sense? </td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Tue Aug 20 2024 14:20:38 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So this op is reaching into the JSContext and setting a field that says "allocate things in the tenured heap"?</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Tue Aug 20 2024 14:20:44 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">When is that flag being cleared?</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Tue Aug 20 2024 14:21:16 GMT-0700 (Pacific Daylight Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The other option I would consider would be to add a flag on the dom call node that says "set that field just before calling, and clear it after we return"</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Tue Aug 20 2024 14:22:10 GMT-0700 (Pacific Daylight Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">flag is being cleared on return at the moment </td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Tue Aug 20 2024 14:22:24 GMT-0700 (Pacific Daylight Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In jitcode?</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Tue Aug 20 2024 14:23:10 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">... looks at patch. Ah, I have only wired it up in baseline 

</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Tue Aug 20 2024 14:23:37 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">plan had been to edit the cacheIR transpilation for emitCallDomFunction to clear on return</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Tue Aug 20 2024 14:25:42 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">debadree25</span>: A fixed-size array makes things simpler. I wonder a little bit whether there's a way to do this where we just push the value on the stack and dispose of it when we pop it, instead of using an array at all. Not sure how unwinding plays in, though.</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Tue Aug 20 2024 14:32:14 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: So, I'm guessing that we end up generating an <a href="https://searchfox.org/mozilla-central/source/js/src/jit/MIR.h#2346-2388">MCallDOMNative</a>, which gets code-genned <a href="https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#6011">here</a>. My assumption is that if you pass an extra argument into that constructor somehow, you can set and clear whatever JSContext state you need inline with the call, and then you don't have to worry about alias sets / whether the state gets cleared properly if the call throws</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Tue Aug 20 2024 14:32:48 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think that's where I would start</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Tue Aug 20 2024 14:33:45 GMT-0700 (Pacific Daylight Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">The issue is how you communicate from the transpiled cacheIR op to the creation of the MCall (or subclass) </td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Tue Aug 20 2024 14:34:33 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">like the transpilation of the former comes before the latter... just install a Maybe&lt;AllocSite&gt; on the warpbuilder and consume during call creation if it's there maybe? </td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Tue Aug 20 2024 14:35:26 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(I was more thinking you just always clear the alloc site on MCallNative codegen (which is what I do in baseline effectively) </td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Tue Aug 20 2024 14:37:35 GMT-0700 (Pacific Daylight Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So you have some sort of CacheOp::SetAllocSite op that you're inserting before the DOM call?</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Tue Aug 20 2024 14:37:50 GMT-0700 (Pacific Daylight Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yes </td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Tue Aug 20 2024 14:38:59 GMT-0700 (Pacific Daylight Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Hmm. It's a little unusual to have multiple effectful CacheIR ops, which is I guess why you're sort of running into this problem in WarpCacheIRTranspiler.</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Tue Aug 20 2024 14:40:15 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. I guess I could try and wire this through the CallDomFunction; they'd have an optional allocSite stub field instead of what I've got already </td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Tue Aug 20 2024 14:40:26 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">but then it keeps everything connected tighter</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Tue Aug 20 2024 14:40:33 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">less spooky-action-at-a-distance </td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Tue Aug 20 2024 14:40:44 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, I think that's how I would approach it</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Tue Aug 20 2024 14:40:52 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">This seems clearly better :P </td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Tue Aug 20 2024 14:41:03 GMT-0700 (Pacific Daylight Time)">21:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Darn. I was hoping this patch was almost over the line :P </td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Tue Aug 20 2024 14:42:53 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's possible that you'll want a separate op instead of an optional field, because the BaselineCacheIRCompiler doesn't look at the stub fields so it doesn't have an idiomatic way of knowing whether the optional parameter is present</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Tue Aug 20 2024 14:43:26 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">wait... so do both? </td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Tue Aug 20 2024 14:43:31 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Although I guess you could have one bool immediate to indicate whether the field is present</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Tue Aug 20 2024 14:43:46 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I mean a new CallDOMFunctionWithAllocSite op</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Tue Aug 20 2024 14:43:58 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">oh I see</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Tue Aug 20 2024 14:44:12 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah, ok that scans as reasonable enough </td></tr>

</tbody></table></div></div></div>
</body></html>