<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-05-03</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-05-03<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-05-02" class="nav-link"><span>prev</span></a>
<a href="2023-05-04" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed May 03 2023 06:27:25 GMT-0700 (Pacific Daylight Time)">13:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">would it be possible to store "is proxy" flag in the object itself?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed May 03 2023 06:27:42 GMT-0700 (Pacific Daylight Time)">13:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I think the pointer chasing here <a href="https://searchfox.org/mozilla-central/rev/e6cb503ac22402421186e7488d4250cc1c5fecab/js/public/Proxy.h#383-384">https://searchfox.org/mozilla-central/rev/e6cb503ac22402421186e7488d4250cc1c5fecab/js/public/Proxy.h#383-384</a> shows up a bit in the profiles</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed May 03 2023 07:56:17 GMT-0700 (Pacific Daylight Time)">14:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Unfortunately the only common fields for all JSObjects is the shape pointer, so storing the is-proxy flag would require some reasonably large redesign and rebalance of performance tradeoffs. That being said, JSC does make the tradeoff of using integer IDs instead of pointers for shapes which allows them to pack these sorts of flags. The JIT shape guards remain simple comparisons, but things that need the actual shape data all need to do some pointer math. If we identify a collection of flags beyond just the is-proxy that would have material benefit, then there might be more motivation to redesign this all.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed May 03 2023 07:57:38 GMT-0700 (Pacific Daylight Time)">14:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">There could be comparatively lighter-weight tricks around laying out virtual address space in clever ways so that even a pointer could give context, but someone would need to understand the fragmentation tradeoffs.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed May 03 2023 07:57:59 GMT-0700 (Pacific Daylight Time)">14:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it used to be <code>object-&gt;shape-&gt;base-&gt;clasp-&gt;flags</code> until pretty recently instead of <code>object-&gt;shape-&gt;flags</code> :)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed May 03 2023 08:00:22 GMT-0700 (Pacific Daylight Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The other issue with is-proxy flags in profiles is that often that even if you got past that check, there would very likely be a memory stall on the same shape data immediately after. In that case while you might see some speedup for avoiding a load in the memory functional-unit of CPU, the stall time may not be avoided so the wins would be less exciting.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed May 03 2023 08:01:10 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Overall though, evidence of these patterns is good to collect, but I have a hard time believing we would be able to target a single flag in isolation.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed May 03 2023 08:02:52 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(ha.. there we go. Now Jan and Iain can give their own takes.. :)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed May 03 2023 08:05:59 GMT-0700 (Pacific Daylight Time)">15:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, the wins from moving it up from the class to the shape were not as big as we'd hoped, because we often need multiple pieces of information from the class/shape, and unless they've all been hoisted, we end up loading the same memory in the long run</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed May 03 2023 08:23:18 GMT-0700 (Pacific Daylight Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I was just testing out my finalise hook and noticed that in a simple script (literally 2 lines), the prototypes always have their finalisers run before the objects themselves. Is this intentional or just coincidental?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed May 03 2023 08:23:41 GMT-0700 (Pacific Daylight Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">If it matters, it's background finalisation, not foreground.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed May 03 2023 08:28:07 GMT-0700 (Pacific Daylight Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the objects might be in the same arena with the prototype coming first, but that could be different if things were moved, if we filled holes in an arena, if the prototype is being kept alive longer, etc</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed May 03 2023 08:29:10 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I was thinking given how the prototype chain exists, shouldn't the objects get finalised before the prototypes? Like, technically the object is still using the prototype?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed May 03 2023 08:30:38 GMT-0700 (Pacific Daylight Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">During a garbage collection, we mark all live objects, then sweep up all the dead ones. If the object and the prototype become unreachable in the same collection, then the order in which their finalizers run will just depend on which one the sweep pass happens to see first.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed May 03 2023 08:31:52 GMT-0700 (Pacific Daylight Time)">15:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">So basically it's just a coincidence and the GC is smarter than I thought.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed May 03 2023 08:44:04 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah; this is also why finalizers have to be done with care -- mostly we do a good job hiding too much danger by avoiding providing a JSContext -- as if done incorrectly you can end up with references to dead objects already collected </td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed May 03 2023 13:38:05 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Hi there.  I don't know if this issue is a bug or not, but I recently encountered undefined behaviour and segfaults when executing a function that took a std::initializer_list&lt;std::tuple&lt;std::string, JS::MutableHandleValue&gt;&gt;</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed May 03 2023 13:40:25 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Should a copy constructor not be used for Mutable handles?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed May 03 2023 13:55:09 GMT-0700 (Pacific Daylight Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Never mind.  Looks like the issue I was experiencing was due to something else.</td></tr>

</tbody></table></div></div></div>
</body></html>