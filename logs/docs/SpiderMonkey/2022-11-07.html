<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-11-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-11-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-11-06" class="nav-link"><span>prev</span></a>
<a href="2022-11-08" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Nov 07 2022 01:11:31 GMT-0800 (Pacific Standard Time)">09:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: thanks for requesting uplift on my bugs while I was away</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Nov 07 2022 01:14:34 GMT-0800 (Pacific Standard Time)">09:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: no problem :)</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Nov 07 2022 05:20:19 GMT-0800 (Pacific Standard Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">In the JS::CompileFunctions() function, one of the arguments is a pointer for a pointer called argnames. How am I supposed to set this up if I have more than one arg name?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Nov 07 2022 05:21:37 GMT-0800 (Pacific Standard Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><p>Is it comma separated or something?</p>
<pre><code>        const char* paramNames = "arg1, arg2";
        JS::CompileFunction(...., &amp;paramNames...)
</code></pre>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Nov 07 2022 05:26:29 GMT-0800 (Pacific Standard Time)">13:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Nevermind, I got it. It's <code>const char* paramName[] ={"arg1", "arg2"};</code></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Nov 07 2022 06:07:46 GMT-0800 (Pacific Standard Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I'm trying to compile a function with <code>JS::CompileFunction()</code> and then run it with <code>JS_CallFunction()</code>. It compiles, but it's not returning as expected.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Nov 07 2022 06:07:50 GMT-0800 (Pacific Standard Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><pre><code>        const auto sampleCode = "() =&gt; { return 6; }";

        JS::SourceText&lt;mozilla::Utf8Unit&gt; preprocessSource;
        preprocessSource.init(cx, sampleCode, strlen(sampleCode), JS::SourceOwnership::Borrowed);
        JS::RootedObjectVector envC(cx);
        JS::CompileOptions cOps(cx);
        JS::RootedFunction processFunc (cx, JS::CompileFunction(cx, envC, cOps, "returnSix", 0, nullptr, preprocessSource));        
        JS::RootedValue rVall(cx);

        if (!JS_CallFunction(cx, glob, processFunc, JS::HandleValueArray::empty(), &amp;rVall))
            MOZ_ASSERT(false);

        js::DumpValue(rVall);
</code></pre>
</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Nov 07 2022 06:08:34 GMT-0800 (Pacific Standard Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I expected this to print 6, but it returns undefined.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Nov 07 2022 06:08:53 GMT-0800 (Pacific Standard Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Am I doing something wrong? Or am I wrong to expect that it returns 6?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Nov 07 2022 06:20:56 GMT-0800 (Pacific Standard Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">You are defining a function that has as its body an arrow function, you probably want <code>sampleCode = "return 6;"</code></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Nov 07 2022 06:25:33 GMT-0800 (Pacific Standard Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Ha, I knew it was something simple.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Nov 07 2022 06:26:42 GMT-0800 (Pacific Standard Time)">14:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Does that mean I have to write my javascript without a function definition?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Nov 07 2022 06:27:41 GMT-0800 (Pacific Standard Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">It would be nice for readability and debugging if I could write my function with a normal definition, compile it, and then run it.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Nov 07 2022 06:28:44 GMT-0800 (Pacific Standard Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><code>(() =&gt; { return 6; })()</code> or something then</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Nov 07 2022 06:56:11 GMT-0800 (Pacific Standard Time)">14:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Couldn't get that one working, but actually it's not so bad writing my code without the function definition at the top. Thanks a ton for your help.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Nov 07 2022 10:43:54 GMT-0800 (Pacific Standard Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Is it even possible to make a function return type as a <code>JS::RootedObject</code>?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Nov 07 2022 10:44:37 GMT-0800 (Pacific Standard Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Or you strictly have to use C raw pointers as return types? like <code>JSObject*</code></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Nov 07 2022 10:45:37 GMT-0800 (Pacific Standard Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><code>js::RootedObject</code> must live on the stack</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Nov 07 2022 10:46:24 GMT-0800 (Pacific Standard Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You should be returning raw pointers</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Nov 07 2022 10:46:30 GMT-0800 (Pacific Standard Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I have a class wrapper for <code>JSContext*</code> and I want the global as a member variable obtainable via a getter function, so is it not possible to return that global as a <code>JS::RootedObject</code> to hand off to other functions that require a global as <code>JS::HandleObject</code>?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Nov 07 2022 10:47:05 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You have to root the return value yourself</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Nov 07 2022 10:47:14 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This makes sense if you think about what rooting is doing</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Nov 07 2022 10:47:39 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We are saying "I have stored a pointer to this object on the stack in a place that the GC knows about"</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Nov 07 2022 10:47:40 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">so you mean return the global as a C raw pointer from the getter function and root the global each time I want to use it?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Nov 07 2022 10:47:46 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yes</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Nov 07 2022 10:48:09 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">that sounds very tedious that I can't automate that with a function</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Nov 07 2022 10:48:30 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you call into your getter function, you can root the pointer to the global inside the getter, but as soon as you return, that stack frame is freed up</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Nov 07 2022 10:49:35 GMT-0800 (Pacific Standard Time)">18:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You can't call a function to do something inside your own stack frame, which is what you would need to avoid doing this</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Nov 07 2022 10:53:33 GMT-0800 (Pacific Standard Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You can say <code>RootedObject result(cx, FunctionIAmCalling(...));</code>, which is not meaningfully worse than <code>RootedObject result = FunctionIAmCalling(...);</code></td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Nov 07 2022 10:57:10 GMT-0800 (Pacific Standard Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But you can't pass the return value directly into a function that expects a Handle</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Nov 07 2022 10:57:30 GMT-0800 (Pacific Standard Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You need to store it somewhere in your own stack frame</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Nov 07 2022 10:57:58 GMT-0800 (Pacific Standard Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which is just the cost of doing business with SM's garbage collector</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Nov 07 2022 10:58:33 GMT-0800 (Pacific Standard Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Thank you for clarifying</td></tr>

</tbody></table></div></div></div>
</body></html>