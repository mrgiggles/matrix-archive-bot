<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-06-24</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-06-24<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-06-23" class="nav-link"><span>prev</span></a>
<a href="2022-06-25" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Jun 23 2022 17:44:26 GMT-0700 (Pacific Daylight Time)">00:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> For example, if you were using Debugger API for this stuff, you'd have a DebuggerScript instead of a raw ScriptSourceObject, and that would be a good place to shove the hash function</blockquote></mx-reply>I have been looking at the wrong object then.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jun 23 2022 17:44:35 GMT-0700 (Pacific Daylight Time)">00:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell">thanks!  I'll look at DebuggerScript</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jun 23 2022 18:07:50 GMT-0700 (Pacific Daylight Time)">01:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Oops, DebuggerSource, but same concept</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Jun 24 2022 06:10:33 GMT-0700 (Pacific Daylight Time)">13:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell">Yeah I found it yesterday.  Hacked up an ugly-ish solution.  Testing it now by just having DebuggerSource.hash return a unique generated string each time.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Jun 24 2022 06:10:59 GMT-0700 (Pacific Daylight Time)">13:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj2:mozilla.org">djvj2</span>&gt;</div></td><td class="msg-cell">Thanks for the help!</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Jun 24 2022 06:38:57 GMT-0700 (Pacific Daylight Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Glad it was straightforward :)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Jun 24 2022 09:42:21 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">Is there a way to raise a TypeError instead of an Error with <code>JS_ReportErrorASCII</code> ?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Jun 24 2022 09:48:52 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">I found ErrorResult has ThrowTypeError but I'm not sure how to construct an ErrorResult from the public JS API</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Jun 24 2022 09:53:20 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">what's the best way to determine if lazy loading is disabled in spidermonkey? a colleague at fastly mentioned that spidermonkey uses lazy loading to improve performance on the web, but for our uses here it would be really great to ensure that all code is eagerly translated to bytecode.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Jun 24 2022 09:55:16 GMT-0700 (Pacific Daylight Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> what's the best way to determine if lazy loading is disabled in spidermonkey? a colleague at fastly mentioned that spidermonkey uses lazy loading to improve performance on the web, but for our uses here it would be really great to ensure that all code is eagerly translated to bytecode.</blockquote></mx-reply>If it helps, this was about disabling the lazy compilation of Regular Expressions in particular</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Jun 24 2022 09:58:15 GMT-0700 (Pacific Daylight Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">exactly right. i think there's currently no option to disable lazy compilation of regular expressions, but following the existing implementation for conditional lazy loading seemed like a good way to understand next steps for allowing lazy regex compilation to be disabled as well.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Jun 24 2022 09:59:26 GMT-0700 (Pacific Daylight Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">iain: ^ (regarding regex compilation) </td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Jun 24 2022 09:59:52 GMT-0700 (Pacific Daylight Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Sounds like one more thing we could off-load the compilation of :)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Jun 24 2022 10:01:33 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I found ErrorResult has ThrowTypeError but I'm not sure how to construct an ErrorResult from the public JS API</blockquote></mx-reply>Hmm. Looks like your best bet would be JS::CreateError</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Jun 24 2022 10:02:05 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">but not sure yet how to throw that</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Jun 24 2022 10:02:30 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">jakechampion</span>: depends on where your code lives</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Jun 24 2022 10:02:49 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> what's the best way to determine if lazy loading is disabled in spidermonkey? a colleague at fastly mentioned that spidermonkey uses lazy loading to improve performance on the web, but for our uses here it would be really great to ensure that all code is eagerly translated to bytecode.</blockquote></mx-reply>I will note, regex compilation is largely separate from script compilation, and I think follow different heuristics too</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Jun 24 2022 10:03:59 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">that's good to know, thank you. my interest in lazy loading was twofold: following an existing implementation through the codebase to understand conventions for flags like this, and verifying that we're successfully disabling lazy loading in our own use of spidermonkey.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Jun 24 2022 10:07:04 GMT-0700 (Pacific Daylight Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Hmm. Looks like your best bet would be JS::CreateError</blockquote></mx-reply>Oh, 🤦‍♂️ then JS_SetPendingException should work</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Jun 24 2022 10:07:54 GMT-0700 (Pacific Daylight Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">So JS_ReportErrorNumberASCII is the version of JS_ReportErrorASCII that would allow you to select the type of error to throw</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Jun 24 2022 10:08:01 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">but the setup for this isn't easy</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Jun 24 2022 10:09:29 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I guess we must be able to add external numbers; because we have <a href="https://searchfox.org/mozilla-central/source/js/src/jsshell.msg">https://searchfox.org/mozilla-central/source/js/src/jsshell.msg</a> which contains the shell messages </td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Jun 24 2022 10:09:38 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Never tried to figure out how that worked tho</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Jun 24 2022 10:10:36 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Oh. That's actually less complicated than I worried; <a href="https://searchfox.org/mozilla-central/source/js/src/shell/js.cpp#10063-10077">https://searchfox.org/mozilla-central/source/js/src/shell/js.cpp#10063-10077</a> </td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Jun 24 2022 10:10:38 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">You would implement a custom JSErrorCallback <a href="https://searchfox.org/mozilla-central/source/js/public/ErrorReport.h#92">https://searchfox.org/mozilla-central/source/js/public/ErrorReport.h#92</a></td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Jun 24 2022 10:20:12 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">this looks like the option that controls lazy loading, and it does appear to be <code>false</code> by default: <a href="https://searchfox.org/mozilla-central/source/js/public/CompileOptions.h#183">https://searchfox.org/mozilla-central/source/js/public/CompileOptions.h#183</a></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Jun 24 2022 10:27:46 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">elliottt</span>: Regular expressions are compiled when they are first used. By default, we initially compile them to a bytecode format that can be interpreted. After the tenth use, we compile them to native code.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Jun 24 2022 10:29:47 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">thanks! for our uses, it would be great to ensure that they're eagerly compiled to bytecode so that we're not paying the cost to re-compile the regex everytime the spidermonkey instances is reloaded fresh.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Jun 24 2022 10:31:10 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The relevant flags are <code>--no-native-regexp</code> (to force execution in the interpreter) and <code>--regexp-warmup-threshold=COUNT</code> (set to 0 to jump straight to native code)</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Jun 24 2022 10:32:04 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">we're unable to generate native code in this case, as we're running spidermonkey compiled to wasm. will setting the warmup threshold to 0 also force eager compilation to bytecode when the source is first compiled?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Jun 24 2022 10:33:03 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">No, the warmup threshold only affects what happens when we first execute</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Jun 24 2022 10:34:51 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In general it isn't possible to precompile every regexp, because <code>Regexp(someStringVariable)</code> is a valid way to create a regexp</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Jun 24 2022 10:35:28 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">that's a good point. what about the case where we have a regex literal?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Jun 24 2022 10:36:57 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right now we run it through the regex parser to emit syntax errors, then throw away the parse tree</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Jun 24 2022 10:37:58 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(The spec says that regex syntax errors should happen when you parse the script, although v8 just ignores that part of the spec and doesn't parse at all until the regex runs)</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Jun 24 2022 10:43:33 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Here is the parser code: <a href="https://searchfox.org/mozilla-central/source/js/src/frontend/Parser.cpp#11053-11118">https://searchfox.org/mozilla-central/source/js/src/frontend/Parser.cpp#11053-11118</a></td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Jun 24 2022 10:45:13 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think it would technically be possible to force the creation of regexp bytecode at that point, and save it in the stencil for later, but it would require plumbing changes through quite a few layers</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Jun 24 2022 10:45:53 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">elliottt</span>: Have you measured any problems with the cost of regexps, or is this problem hypothetical?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Jun 24 2022 10:49:57 GMT-0700 (Pacific Daylight Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There are definitely some patterns where the regexp parser is slow, but in some of those cases you can work around it by modifying the regexp</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Jun 24 2022 10:50:06 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So if you have concrete examples I can take a look</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Jun 24 2022 10:53:50 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">the problem isn't hypothetical for us: we load the js to execute into spidermonkey, run it so that it registers callbacks, and then freeze the wasm memory at that point. we then re-run the wasm from that point whenever we're running the javascript, which means that every time a regex is used that wasn't evaluated in the top-level of the script, it's as though it's used for the first time</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Jun 24 2022 10:54:46 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">we' like to eagerly compile all regexes when the script is first loaded to avoid having to refactor programs to use global regex objects that live at the top-level of the program</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Jun 24 2022 10:55:20 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So, one thing to mention is that regexp compilation is shared between all regexps with the same source</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Jun 24 2022 10:55:55 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So if you execute a regexp once, then another regexp with the same source will not need compilation</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Jun 24 2022 10:57:39 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">oh interesting! so it's enough to replicate the textual pattern of the regex at the top-level of the script?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Jun 24 2022 10:57:46 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yep</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Jun 24 2022 10:58:01 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Well, you also need to run it on something</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Jun 24 2022 10:58:31 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ideally you would run it on two strings, one with only latin1 characters, and another with two-byte characters</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Jun 24 2022 10:58:32 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">that might be a good short-term fix, but longer-term we would like to optimize usage patterns as well, most likely yielding new regexes as a result.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Jun 24 2022 10:59:30 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Strings inside SM can be stored with 1-byte or 2-byte encodings, so we (lazily) compile a separate regexp for each</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Jun 24 2022 11:11:26 GMT-0700 (Pacific Daylight Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">elliottt</span>: Right now, regexp compilation relies heavily on the existence of a RegExpShared, which is the garbage-collected object storing data that can be shared between different regexps with the same source</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Jun 24 2022 11:13:37 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The parser doesn't interact with GC things, so a lot of the code in <code>RegExpAPI.cpp</code> would have to be refactored (particularly <code>CompilePattern</code> and <code>Assemble</code>)</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Jun 24 2022 11:18:05 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">After creating a GC-free interface for the parser to call (returning the bytecode plus any other necessary metadata), you'd have to store that data in the regexp stencil, and then modify the code that consumes the stencil to create a RegExpObject to prepopulate the bytecode field of the associated RegExpShared</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Jun 24 2022 11:18:21 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which is a little tricky, since I think normally we allocate the RegExpShared lazily as well, but doable</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Jun 24 2022 11:18:51 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">thank you so much for the explanation, this is really helpful :)</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Jun 24 2022 11:26:00 GMT-0700 (Pacific Daylight Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In the short term, my advice would be to add something like <code>function precompileRegex(r) { r.exec("a"); r.exec("\u1000"); }</code> to your scripts and call it at the top level on any regexps you want precompiled</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Jun 24 2022 11:28:49 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <pre><code class="language-bash">export PKG_CONFIG_PATH=/home/dj/spiderMonkey/install/lib/pkgconfig
export LD_LIBRARY_PATH=/home/dj/spiderMonkey/install/lib
meson _build
</code></pre>
</blockquote></mx-reply>returning back to this</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Jun 24 2022 11:28:54 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">the difficulty is that we're handling arbitrary javascript, and don't have much control over the dependencies our customers choose to use. we can potentially pre-process the javascript to add calls like that automatically at the top-level, but it would be great in the longer-term to implement something like you've suggested above, where we can pre-compile regexes</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Jun 24 2022 11:29:35 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> returning back to this</blockquote></mx-reply><code>libmozjs-103a1</code> isn't being found even though I see <code>libmozjs-103a1 .so</code> and <code>mozjs-103a1.pc</code> in those directories</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Jun 24 2022 11:30:21 GMT-0700 (Pacific Daylight Time)">18:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell">i.e. the dependency isn't being found: "Dependency 'libmozjs-103a1' not found, tried pkgconfig and cmake". I exported those paths</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Jun 24 2022 11:33:57 GMT-0700 (Pacific Daylight Time)">18:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@drpastah:matrix.org">Pastah</span>&gt;</div></td><td class="msg-cell">actually it works now with <code>mozjs-103a1</code> instead as the dependency. but it's saying that cannot compile the tests in the <code><a href="http://meson.build">meson.build</a></code></td></tr>

</tbody></table></div></div></div>
</body></html>