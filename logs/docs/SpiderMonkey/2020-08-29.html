<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2020-08-29</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2020-08-29<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2020-08-28" class="nav-link"><span>prev</span></a>
<a href="2020-08-31" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sat Aug 29 2020 10:40:41 GMT-0700 (Pacific Daylight Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">Hey could anyone point me to a good resource to understand all about the lifecycle and interactions of bytecode with all components in spidermonkey? I read the MDN pages </td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sat Aug 29 2020 10:41:39 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I understood a little bit of whats happening reading the bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478034">https://bugzilla.mozilla.org/show_bug.cgi?id=1478034</a> and patches but still not clear about many things</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sat Aug 29 2020 10:47:42 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">yozaam</span>: I'm not sure if we have a resource written down. Very fast outline: the parser/bytecode generator take JS source and produce bytecode. Each of the execution tiers takes bytecode as an input, but does different things with them. The interpreter / baseline interpreter execute one opcode at a time. The baseline compiler compiles an entire script by translating each opcode into native code. The highest tier (currently Ion, but switching over to Warp very soon) takes bytecode (and some other things) as input, converts it into MIR (mid-level intermediate representation), optimizes it a bunch, and then generates native code.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sat Aug 29 2020 10:52:30 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">They all need to ask questions about the bytecode. The goal of the bytecode interface is to put a layer between the code asking questions, and the bytecode representation itself, so that it's easier to modify the bytecode without rewriting all the code that depends on it</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sat Aug 29 2020 10:54:42 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(A couple other examples of consumers: the debugger uses bytecode, and we have some analyses that examine the bytecode to determine properties of the script)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sat Aug 29 2020 11:30:44 GMT-0700 (Pacific Daylight Time)">18:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">Thanks a lot that was really helpful</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sat Aug 29 2020 11:31:22 GMT-0700 (Pacific Daylight Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">basically it is just a list of opcodes in a stack?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sat Aug 29 2020 11:31:49 GMT-0700 (Pacific Daylight Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">and the interface lets us manipulate the list</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sat Aug 29 2020 11:36:10 GMT-0700 (Pacific Daylight Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It is a list of opcodes. They are not in a stack, but they manipulate values on a stack.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sat Aug 29 2020 11:37:54 GMT-0700 (Pacific Daylight Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So for example if you open the shell and type <code>function foo(a,b) { return a + b; } dis(foo)</code>, you can see the <code>dis</code>assembled bytecodes for <code>foo</code>, which are <code>GetArg 0; GetArg 1; Add; Return</code></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sat Aug 29 2020 11:38:15 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We start executing at the beginning and continue until something tells us to stop.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sat Aug 29 2020 11:39:14 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><code>GetArg 0</code> gets the first argument and pushes it on the stack. <code>GetArg 1</code> does the same with the second argument. <code>Add</code> takes two arguments off the stack, adds them together, and pushes the sum back on the stack. <code>Return</code> takes the value on the stack and returns it to the caller.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sat Aug 29 2020 11:39:41 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">ohhhh makes sense, thank you</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sat Aug 29 2020 14:28:15 GMT-0700 (Pacific Daylight Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">why do many files have -inl 

does it mean these have inline functions ?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sat Aug 29 2020 14:28:51 GMT-0700 (Pacific Daylight Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">ScriptLocation.h and ScriptLocation-inl.h is it because we don't include function definition in normal headers? ( I realized these files are not part of the current codebase -&gt; but there are others i found like ParseContext-inl.h</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sat Aug 29 2020 14:37:01 GMT-0700 (Pacific Daylight Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-11">yozaam</span>: C++ always requires stuff be declared before it's used.  You can't have <code>JSScript* s = nullptr;</code> without having already observed a declaration of <code>JSScript</code>.</p>
<p>Sometimes, C++ also requires stuff be <em>defined</em> before it's used.  <code>JSString* s = nullptr;</code> is fine with just a declaration; <code>JSString* s = ...; std::cout &lt;&lt; s-&gt;length() &lt;&lt; std::endl;</code> requires <code>JSString</code> also be defined.</p>
<p>But <em>defining</em> things, means the majority of what's in them also needs to be defined, too.  And the more stuff that has to be defined, the more inclusion dependencies are required.  So ideally, if you can rely on a declaration but not a definition, that's usually preferable.  Putting inline functions that have large dependencies in <code>-inl.h</code> files helps reduce dependencies, to only the files that need those inline functions.</p>
<p>But there's another problem: what about an inline function in a class that depends on the definition of another class, but that class <em>itself</em> has an inline function that requires the definition of the first class?  Toy example:  <code>struct A { static size_t sizeOfB() { return sizeof(B); } }; struct B { static size_t sizeOfA() { return sizeof(A); } };</code>.  In this case, the inline function in the first class (at minimum) needs to be <em>declared</em> in the class body but <em>defined</em> after <code>B</code> is defined: <code>struct A { static inline size_t sizeOfB(); }; struct B { static size_t sizeOfA() { return sizeof(A); } }; /* static */ inline size_t A::sizeOfB() { return sizeof(B); }</code>.  In cases like this, we put the inline function definition in a <code>-inl.h</code> file -- and we do it for both <code>A::sizeOfB</code> and <code>B::sizeOfA</code>, symmetrically, so that our includes aren't implicitly encoding unpredictably (to the developer) giving one class priority over another.  (And the additional benefit is, only the files that need these inline functions have to include the <code>-inl.h</code> files -- so dependencies are reduced generally.)</p>
</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sat Aug 29 2020 14:39:27 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">In a better language than C++, there wouldn't be this requirement of things being defined at time of their use.  But C++, deriving from C, has this conceit that everything must be defined at the time it is used, so that compilers can compile code by just reading in linear order start to finish basically.  So, we have to play these games to make sure things are defined when they are used, and ideally are <em>not</em> defined (if they are complicated or have costly dependencies) until they are needed.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sat Aug 29 2020 14:41:23 GMT-0700 (Pacific Daylight Time)">21:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">Thank you very much! is this called a cyclic dependency?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sat Aug 29 2020 14:43:10 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">yozaam</span>: Arguably, yes.  Terminologically, I think the quibbling pedantic definition would probably be "no" -- because <code>A</code> depends only only a subset of <code>B</code>, and vice versa.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sat Aug 29 2020 14:43:37 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">oh ok , so we just import that subset to both of them in advance and there is no cycle</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Sat Aug 29 2020 14:44:20 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">yozaam</span>: In particular, <code>A</code> and <code>B</code> don't depend on the full definition of the other, they require that the other be "complete" -- their definition is required, but every member function within them does not have to be defined.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Sat Aug 29 2020 14:45:20 GMT-0700 (Pacific Daylight Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">I think i understood,</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Sat Aug 29 2020 14:45:20 GMT-0700 (Pacific Daylight Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">Past the end of a class or struct body, and inside of member and static functions within those bodies, a class or struct is "complete".  Before the definition of the class or struct, or in the class or struct body but not inside a function defined within that struct body, a class or struct is not complete.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Sat Aug 29 2020 14:46:18 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">("complete" is C++ term of art, I'm spewing C++ language fine-grained details at you, I would avoid it if I really could but I'm not sure I can, so I'm trying to be precise but also understandable without deep understanding of C++.)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Sat Aug 29 2020 14:46:33 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">ohh okay , I think  i got it</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Sat Aug 29 2020 14:46:54 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">(back shortly)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Sat Aug 29 2020 14:46:54 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yozaam:mozilla.org">yozaam</span>&gt;</div></td><td class="msg-cell">thank you very very very much!</td></tr>

</tbody></table></div></div></div>
</body></html>