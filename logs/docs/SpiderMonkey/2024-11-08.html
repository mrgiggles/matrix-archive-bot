<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-11-08</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-11-08<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-11-07" class="nav-link"><span>prev</span></a>
<a href="2024-11-09" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Nov 08 2024 01:11:14 GMT-0800 (Pacific Standard Time)">09:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@aryx:mozilla.org">Aryx</span>&gt;</div></td><td class="msg-cell">Hi, any idea what started these [@ js::IsProxy] <a href="https://crash-stats.mozilla.org/report/index/c5eb6203-1fff-4ae8-8b2e-041920241108">crashes</a> in Nightly?<br><a href="https://hg.mozilla.org/integration/autoland/pushloghtml?fromchange=7ac8585e3c02763662a597f94e0676111667aa60&amp;tochange=785541f0311a90d71ea29959cc5092b1b0fa6f2b">Pushlog</a> cc <span class="nick-4">jonco</span> <span class="nick-10">jandem</span></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Nov 08 2024 01:22:34 GMT-0800 (Pacific Standard Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sounds like bug 1928412 </td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Nov 08 2024 01:22:35 GMT-0800 (Pacific Standard Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1928412">https://bugzil.la/1928412</a> — RESOLVED (sefeng) — Implement `HostDefined` object</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Nov 08 2024 01:23:32 GMT-0800 (Pacific Standard Time)">09:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@aryx:mozilla.org">Aryx</span>&gt;</div></td><td class="msg-cell">Thank you very much</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Nov 08 2024 01:27:03 GMT-0800 (Pacific Standard Time)">09:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think we should backout the patch</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Nov 08 2024 07:16:48 GMT-0800 (Pacific Standard Time)">15:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">How can I check if a BigInt will only fit a uint64 vs an int64?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Nov 08 2024 07:22:14 GMT-0800 (Pacific Standard Time)">15:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">ah i see <code>BigIntIsInt64(..)</code> and <code>BigIntIsUint64(const BigInt* bi, uint64_t* result)</code></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Nov 08 2024 07:24:25 GMT-0800 (Pacific Standard Time)">15:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Though I'm confused why the 2nd arg is a <code>int64</code> or <code>uint64</code> when I want to know whether it fits or not before giving it a value.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Nov 08 2024 07:27:03 GMT-0800 (Pacific Standard Time)">15:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it returns true with the converted value if it fits.  otherwise it returns false</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Nov 08 2024 07:28:08 GMT-0800 (Pacific Standard Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so you can perform the test and conversion at once, instead of separate 2 steps</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Nov 08 2024 07:50:35 GMT-0800 (Pacific Standard Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: compare to the <a href="https://searchfox.org/mozilla-central/rev/af714b0fe5223bff962ddc04d1f71593bb79e22d/js/src/builtin/Promise.cpp#1553-1557">old code</a>, looks like I didn't do that <code>nonCCWGlobal();</code> call.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Nov 08 2024 07:51:25 GMT-0800 (Pacific Standard Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">Do you think I should do it at the same place, like get the unwrapped host defined data, and then get the <code>nonCCWGblobal</code>, and then override the slot..?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Nov 08 2024 07:51:48 GMT-0800 (Pacific Standard Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">or Should I do extra checks in<code>CycleCollectedJSContext::enqueuePromiseJob</code>?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Nov 08 2024 07:52:41 GMT-0800 (Pacific Standard Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">SpiderMonkey internal shouldn't touch the object except for wrap/unwrap</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Nov 08 2024 07:54:48 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">right..I see</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Nov 08 2024 07:56:39 GMT-0800 (Pacific Standard Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then. the crash seems to be caused by type confusion or something</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Nov 08 2024 07:57:24 GMT-0800 (Pacific Standard Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">yeah, I checked a few crash reports, they all started with <code>EnqueuePromiseReactionJob</code></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Nov 08 2024 07:57:30 GMT-0800 (Pacific Standard Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">so I think that was the cause</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Nov 08 2024 08:01:44 GMT-0800 (Pacific Standard Time)">16:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: but..is <code>nonCCWGlobal</code> a JS thing? Calling this method requires CycleCollectedJSContext to know the definitation of JSContext</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Nov 08 2024 08:02:35 GMT-0800 (Pacific Standard Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if necessary, it can be done with <code>JS::GetNonCCWObjectGlobal</code></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Nov 08 2024 08:02:53 GMT-0800 (Pacific Standard Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but I don't think it's necessary, because the global object is stored into an object in the same global</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Nov 08 2024 08:03:10 GMT-0800 (Pacific Standard Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and there's no need to wrap/unwrap the global object itself</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Nov 08 2024 08:03:59 GMT-0800 (Pacific Standard Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the wrap/unwrap is done by SpiderMonkey.  The Gecko side receives the unwrapped HostDefined object, and extracting the slot doesn't need any extra operation</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Nov 08 2024 08:04:00 GMT-0800 (Pacific Standard Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: hmm, so I shouldn't call <code>xpc::NativeGlobal</code> here? I am a bit confused about the issue honestly</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Nov 08 2024 08:04:50 GMT-0800 (Pacific Standard Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">You need to call <code>xpc::NativeGlobal</code>.  it's a way to convert JSObject to nsIGlobalObject</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Nov 08 2024 08:05:17 GMT-0800 (Pacific Standard Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but yeah, if we're to directly store the nsIGlobalObject itself (instead of storing the corresponding JSObject), the conversion isn't necessary</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Nov 08 2024 08:05:32 GMT-0800 (Pacific Standard Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but I guess that's separate thing than the current issue</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Nov 08 2024 08:06:08 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what I can think of is either the slot contains unexpected value, or an unexpected object is passed as hostDefinedData object</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Nov 08 2024 08:06:49 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">so you don't think that <a href="https://searchfox.org/mozilla-central/rev/af714b0fe5223bff962ddc04d1f71593bb79e22d/js/src/builtin/Promise.cpp#1557">nonCCWGlobal</a> from the JS side matters?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Nov 08 2024 08:06:58 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">(which is something I didn't do in my code)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Nov 08 2024 08:07:31 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">given the crash volume isn't high, it could be some minor code path.  perhaps the FinalizationRegistry things</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Nov 08 2024 08:08:37 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">okay I see, so it should be high if this is the cause </td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Nov 08 2024 08:08:39 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the <code>nonCCWGlobal</code> part was done before because SpiderMonkey was receiving a global object from the embedding, where the global object comes from different global than the reaction record object</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Nov 08 2024 08:09:03 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">okay</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Nov 08 2024 08:09:22 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">object's slot cannot store an object from different global, and wrapping a global object isn't trivial.  So, instead of storing the global object, we were using an object inside the global</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Nov 08 2024 08:09:48 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, store an object inside the global to the slot, and when extracting from the slot, we get the object's global</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Nov 08 2024 08:09:49 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">ok!</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Nov 08 2024 08:09:54 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that's `nonCCWGlobal call</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Nov 08 2024 08:10:09 GMT-0800 (Pacific Standard Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, that part is no longer necessary with the patch's setup</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Nov 08 2024 08:11:39 GMT-0800 (Pacific Standard Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hmm, the backtrace doesn't imply anything about FinalizationRegistry.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Nov 08 2024 08:12:24 GMT-0800 (Pacific Standard Time)">16:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">yeah that's why I was looking at <code>EnqueuePromiseReactionJob</code>..</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Nov 08 2024 08:16:19 GMT-0800 (Pacific Standard Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'll check how the <code>0x0007800000000000</code> value in the crash report can be generated</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Nov 08 2024 08:16:47 GMT-0800 (Pacific Standard Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I wonder if non-object value becomes that pointer</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Nov 08 2024 08:18:10 GMT-0800 (Pacific Standard Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">another question - is this still the <a href="https://searchfox.org/mozilla-central/rev/b1cd7e191ac57f8dfe31806be2539e51843c03eb/xpcom/base/CycleCollectedJSContext.cpp#262">object inside the global</a>?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Nov 08 2024 08:19:03 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it should be the global object itself</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Nov 08 2024 08:19:16 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">so that's wrong then?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Nov 08 2024 08:19:31 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">why?</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Nov 08 2024 08:19:54 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe I'm not following</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Nov 08 2024 08:19:59 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">oh I thought you mean that code is wrong and it should be the global object itself</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Nov 08 2024 08:20:18 GMT-0800 (Pacific Standard Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I haven't yet figured out where it goes wrong</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Nov 08 2024 08:26:27 GMT-0800 (Pacific Standard Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'll look into it next week</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Nov 08 2024 08:28:24 GMT-0800 (Pacific Standard Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">sure, thanks! I am still looking at it :) </td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Nov 08 2024 10:26:35 GMT-0800 (Pacific Standard Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell">While looking at a memory report (the second memory report from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1894286">this bug</a>) earlier, Markus and I noticed a lot duplicated strings. For example, in the parent process there are 60 copies of a string for an icon for a total of 2.35MB, in the first youtube process there are 778 copies of a text string for 6.10MB, in the second youtube process there are 21065 copies of a string for 21.05MB, and in the third youtube process there are 21108 copies of a string for 21.09MB.<br>It doesn't seem like it's the main issue being reported here but there are a number of strings that have thousands or even tens of thousands of copies.<br>This level of duplication isn't expected, is it?<br>Also is this the right place to ask this question? Or is this more of a DOM thing? Or both?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Nov 08 2024 10:29:03 GMT-0800 (Pacific Standard Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">The JS engine does some kind of string deduplication. I'm not sure what the heuristics are for when it applies. Maybe we don't do it if the strings are too long.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Nov 08 2024 10:35:56 GMT-0800 (Pacific Standard Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@lbe:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">I'd like to confine SM s.t. it cannot interact with other parts of the browser or the OS in any manner, unless the interaction passes through a dedicated interface. is this doable in a somewhat realistic time period or would this require tremendous changes? I know this is a bit vague a question, but any input is appreciated</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Nov 08 2024 11:01:00 GMT-0800 (Pacific Standard Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell">Yeah, the string situation in the browser seems very complicated. I know that some strings, at least in JS and maybe DOM contexts, get atomized so there shouldn't be duplicates in those contexts, but I've also heard about "string de-duplication" and I don't really know much about that, other than what is obvious about the name, or how it all fits together.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Nov 08 2024 11:05:53 GMT-0800 (Pacific Standard Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">We explicitly deduplicate most strings when tenuring during minor GCs, which sort of provides a filter between the nursery generation and the tenured generation that reduces the number of duplicates being created to one per minor GC. Relatedly, any nursery string that has been atomized will be replaced with the atom during tenuring. But neither of those apply to all types of strings.</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Nov 08 2024 11:08:23 GMT-0800 (Pacific Standard Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Duplicate strings in the tenured heap mostly persist, I think? Tenured strings that are atomized will get converted to AtomRefs, which will free the duplicate data.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Nov 08 2024 11:10:00 GMT-0800 (Pacific Standard Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">External strings, which very well might be the ones here, are not nursery-allocated so will skip the filter.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Nov 08 2024 11:11:27 GMT-0800 (Pacific Standard Time)">19:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Hm... I'm wondering about strings whose data is stored in a StringBuffer. I wonder if we report those as duplicates when there are multiple JSString headers that share StringBuffer data?</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Nov 08 2024 11:13:01 GMT-0800 (Pacific Standard Time)">19:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">l11d</span>: You can trivially sandbox SM away from the browser by only building the shell, but I assume that's not what you want. What do you mean by preventing OS interaction? That seems a little trickier.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Nov 08 2024 11:14:22 GMT-0800 (Pacific Standard Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you can compile SpiderMonkey to wasm, which gives you a sandbox. But I don't know if that'll be valid for your use case.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Nov 08 2024 11:15:07 GMT-0800 (Pacific Standard Time)">19:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@lbe:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">OS interactions = "all calls to external libs and syscalls". its not that the SM should work without these (in fact it cannot work w/o e.g. mmap), its that I'd like to re-route all calls through a dedicated interface between SM and the rest of the OS/browser</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Nov 08 2024 11:16:25 GMT-0800 (Pacific Standard Time)">19:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@lbe:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">mostly with the goal to make it easier to reason about security properties of SM and confine adversaries</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Nov 08 2024 11:17:18 GMT-0800 (Pacific Standard Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">for production use, or testing, or research?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Nov 08 2024 11:17:46 GMT-0800 (Pacific Standard Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Would LD_LIBRARY_PATH help? I have the vague notion that it lets you shim external libraries (including libc?), but I have never used it myself</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Nov 08 2024 11:17:47 GMT-0800 (Pacific Standard Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@lbe:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">first of all, research</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Nov 08 2024 11:19:54 GMT-0800 (Pacific Standard Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@lbe:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">I'm currently writing a text of future directions of JS security so I was thinking about sandboxing strategies</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Nov 08 2024 11:20:08 GMT-0800 (Pacific Standard Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@lbe:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">I probably have to give it some more thought</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Nov 08 2024 11:20:29 GMT-0800 (Pacific Standard Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I actually don't know whether SM uses any syscalls directly, or only via libc. I'm not aware of any direct syscalls off the top of my head, but that guarantees nothing.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Nov 08 2024 11:26:00 GMT-0800 (Pacific Standard Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">jlink</span>: I think the duplicate string reporting uses <a href="https://searchfox.org/mozilla-central/rev/b1cd7e191ac57f8dfe31806be2539e51843c03eb/js/src/vm/MemoryMetrics.cpp#63-97">the code here</a>, which suggests that different JSStrings that point to the same data (eg in a StringBuffer) would be reported as duplicates. So it's possible that some of the reported duplication is mostly a false alarm. But I don't know.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Nov 08 2024 11:26:39 GMT-0800 (Pacific Standard Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in answer to your original question, I don't have a good sense for what is expected these days. The last time I remember looking at it, I saw similar things to what you're seeing, but didn't investigate. jandem might have a better sense.</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Nov 08 2024 11:31:17 GMT-0800 (Pacific Standard Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">l11d</span>: I would expect there to be something out there to do a pretty generic virtualization within a process. ptrace could do it, somewhat slowly. Look at <code>PTRACE_SYSEMU</code> <a href="https://www.man7.org/linux/man-pages/man2/ptrace.2.html">for example</a>.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Nov 08 2024 11:32:19 GMT-0800 (Pacific Standard Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or something based on seccomp-bpf</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Nov 08 2024 11:33:14 GMT-0800 (Pacific Standard Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, huh -- it looks like Chromium already uses seccomp-bpf</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Nov 08 2024 11:34:04 GMT-0800 (Pacific Standard Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=790923">so has Firefox</a></td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Nov 08 2024 11:34:39 GMT-0800 (Pacific Standard Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">jld would be a very good person to brainstorm this sort of thing with</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Nov 08 2024 11:35:54 GMT-0800 (Pacific Standard Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://wiki.mozilla.org/Security/Sandbox/Seccomp">https://wiki.mozilla.org/Security/Sandbox/Seccomp</a></td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Nov 08 2024 11:51:00 GMT-0800 (Pacific Standard Time)">19:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@lbe:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">many thanks for all the pointers :)</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Nov 08 2024 12:37:37 GMT-0800 (Pacific Standard Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Jed really is the right person to talk to. He's very knowledgeable about sandboxing, and not just on Linux. He also has the battle scars from real experience using it in anger, so to speak.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Nov 08 2024 13:09:10 GMT-0800 (Pacific Standard Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@itms:mozilla.org">itms</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>Well, I will say we have very small amounts of use of JS_DeepFreezeObject. Would not be surprised if there was a bug in there right now.</p>
<p>Could you ( <span class="nick-6">itms</span> ) open a bug with the backtrace from a debug build?</p>
</blockquote></mx-reply>Hello! I managed to reduce our crash situation with <code>JS_DeepFreezeObject</code> to a minimal example. I attached it to bug 1930258</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Nov 08 2024 13:09:13 GMT-0800 (Pacific Standard Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1930258">https://bugzil.la/1930258</a> — UNCONFIRMED (nobody) — JS_DeepFreezeObject triggers environment crash when freezing function objects</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Nov 08 2024 13:11:37 GMT-0800 (Pacific Standard Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mgaudet:mozilla.org">mgaudet|out-until-nov-12</span>&gt;</div></td><td class="msg-cell">I am off today but this will get triaged next week! Thank you!</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Nov 08 2024 14:19:20 GMT-0800 (Pacific Standard Time)">22:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Is there a way to create my own subclass of JobQueue and use it?</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Nov 08 2024 14:22:27 GMT-0800 (Pacific Standard Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">jlink</span>: I think the duplicate string reporting uses <a href="https://searchfox.org/mozilla-central/rev/b1cd7e191ac57f8dfe31806be2539e51843c03eb/js/src/vm/MemoryMetrics.cpp#63-97">the code here</a>, which suggests that different JSStrings that point to the same data (eg in a StringBuffer) would be reported as duplicates. So it's possible that some of the reported duplication is mostly a false alarm. But I don't know.</blockquote></mx-reply>Thanks for pointing me there. I'm not sure how exactly we calculate the total memory usage for a string but that makes me wonder - if we <em>are</em> considering two JStrings that use the same underlying StringBuffer as distinct copies, does that mean that we're counting more memory usage for them than we should? <span class="nick-16">mccr8</span> Do you happen to know?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Nov 08 2024 14:26:22 GMT-0800 (Pacific Standard Time)">22:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell">Interestingly I just started up a fresh copy of Nightly (locally built) and I see exactly 60 copies of a different and smaller icon in my parent process as well. (I had not navigated anywhere yet.)</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Nov 08 2024 14:27:40 GMT-0800 (Pacific Standard Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell">And then I waited a minute and generated a report again and now it's gone.</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Fri Nov 08 2024 14:30:29 GMT-0800 (Pacific Standard Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Thanks for pointing me there. I'm not sure how exactly we calculate the total memory usage for a string but that makes me wonder - if we <em>are</em> considering two JStrings that use the same underlying StringBuffer as distinct copies, does that mean that we're counting more memory usage for them than we should? <span class="nick-16">mccr8</span> Do you happen to know?</blockquote></mx-reply>I'm not sure. That seems like a big thing to overlook so I'd be surprised if it was missed, but maybe the string implementation has changed and the reporter wasn't? If a single block of memory is reported twice it will show up in a DMD report.</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Fri Nov 08 2024 14:35:08 GMT-0800 (Pacific Standard Time)">22:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Does anyone know of a way I can make a subclass of the internal job queues with minor modifications and use it?</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Fri Nov 08 2024 14:38:42 GMT-0800 (Pacific Standard Time)">22:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: No, short of editing your own local copy of the code. If you want custom job queue behaviour, all the hooks are available.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Fri Nov 08 2024 14:41:30 GMT-0800 (Pacific Standard Time)">22:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm not sure. That seems like a big thing to overlook so I'd be surprised if it was missed, but maybe the string implementation has changed and the reporter wasn't? If a single block of memory is reported twice it will show up in a DMD report.</blockquote></mx-reply>I'm also seeing that <em>some</em> (but not all) strings are reporting about twice as much memory as I would expect given their length, copies, and bytes-per-char:<br>│  │   ├──6.10 MB (24.75%) -- string(length=2204, copies=778, "Hashtags/n/uD83D/uDCFA ..."<br>│  │   │  ├──6.08 MB (24.68%) ── malloc-heap/two-byte<br>│  │   │  └──0.02 MB (00.07%) ── gc-heap/two-byte<br>Is there something else that I'm neglecting to take into account when checking these numbers that makes this make sense?</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Fri Nov 08 2024 14:47:14 GMT-0800 (Pacific Standard Time)">22:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm also seeing that <em>some</em> (but not all) strings are reporting about twice as much memory as I would expect given their length, copies, and bytes-per-char:<br>│  │   ├──6.10 MB (24.75%) -- string(length=2204, copies=778, "Hashtags/n/uD83D/uDCFA ..."<br>│  │   │  ├──6.08 MB (24.68%) ── malloc-heap/two-byte<br>│  │   │  └──0.02 MB (00.07%) ── gc-heap/two-byte<br>Is there something else that I'm neglecting to take into account when checking these numbers that makes this make sense?</blockquote></mx-reply>I think that includes allocator slop. So if it tries to allocate say 154 bytes of characters and jemalloc has buckets at, say, 120bytes and 256bytes, then the 154 bytes will actually take 256. (those numbers are pulled out of a hat, I should look up the actual buckets)</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Fri Nov 08 2024 14:47:49 GMT-0800 (Pacific Standard Time)">22:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm also seeing that <em>some</em> (but not all) strings are reporting about twice as much memory as I would expect given their length, copies, and bytes-per-char:<br>│  │   ├──6.10 MB (24.75%) -- string(length=2204, copies=778, "Hashtags/n/uD83D/uDCFA ..."<br>│  │   │  ├──6.08 MB (24.68%) ── malloc-heap/two-byte<br>│  │   │  └──0.02 MB (00.07%) ── gc-heap/two-byte<br>Is there something else that I'm neglecting to take into account when checking these numbers that makes this make sense?</blockquote></mx-reply>The chart is here: <a href="https://searchfox.org/mozilla-central/rev/450aacd753c98b3200f120ed4340e1ed53b7ff47/memory/build/mozjemalloc.cpp#58">https://searchfox.org/mozilla-central/rev/450aacd753c98b3200f120ed4340e1ed53b7ff47/memory/build/mozjemalloc.cpp#58</a></td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Fri Nov 08 2024 14:49:14 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Looks like the "large" ones there are 4kB and in this case the strings take 4408 bytes each, so it is almost 100% allocator slop there.</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Fri Nov 08 2024 14:49:29 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">because it'll get rounded up to the next size with is 8kB</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Fri Nov 08 2024 15:20:19 GMT-0800 (Pacific Standard Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell">Ahh yes, that makes perfect sense. Thank you! </td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Fri Nov 08 2024 15:29:52 GMT-0800 (Pacific Standard Time)">23:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Good catch, though. It took me a bit to remember what was probably going on.</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Fri Nov 08 2024 15:31:21 GMT-0800 (Pacific Standard Time)">23:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Not the case here, but we had a number of places in Firefox where somebody tried to be clever and fit a data structure entirely within a bucket, but then forgot about some extra bytes needed for the header, causing it to go into the next bucket size and end up with almost 50% allocator slop.</td></tr>

</tbody></table></div></div></div>
</body></html>