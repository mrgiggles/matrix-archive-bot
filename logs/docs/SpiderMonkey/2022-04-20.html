<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-04-20</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-04-20<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-04-19" class="nav-link"><span>prev</span></a>
<a href="2022-04-21" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Apr 19 2022 21:39:00 GMT-0700 (Pacific Daylight Time)">04:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@caspy7:mozilla.org">Caspy7</span>&gt;</div></td><td class="msg-cell">apparently this is the first draft of the wasm 2.0 spec? <a href="https://www.w3.org/TR/wasm-core-2/">https://www.w3.org/TR/wasm-core-2/</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Apr 20 2022 03:39:34 GMT-0700 (Pacific Daylight Time)">10:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">hi folks. I work on Apache CouchDB which embeds spidermonkey for user-defined callbacks (for indexing and other tasks). We've always used <code>.toSource()</code> when these callback functions throw an error. We're aware that toSource is disabled by default and we, like the JS shell, enable it back explicitly (<a href="https://github.com/apache/couchdb/blob/main/src/couch/priv/couch_js/86/main.cpp#L67">https://github.com/apache/couchdb/blob/main/src/couch/priv/couch_js/86/main.cpp#L67</a>). However I've found a bug where .toSource is undefined on an error object and I can't figure out why. I'm compiling against spidermonkey 91 on macOS using the homebrew package.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Apr 20 2022 03:44:12 GMT-0700 (Pacific Daylight Time)">10:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">rnewson</span>: is the issue specific to the error object?  is .toSource() work for other case?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Apr 20 2022 03:44:29 GMT-0700 (Pacific Daylight Time)">10:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, does the issue with error object always happen?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Apr 20 2022 03:44:53 GMT-0700 (Pacific Daylight Time)">10:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">it happens every time, yes.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Apr 20 2022 03:45:43 GMT-0700 (Pacific Daylight Time)">10:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">I stumbled on this as we have one place where we call err.toSource() left. We have an old patch that did err.toSource ? err.toSource() : err.toString() which masked the fact that toSource() isn't working even though it should be.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Apr 20 2022 03:46:55 GMT-0700 (Pacific Daylight Time)">10:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">I'm really just asking if there's more to do than options.creationOptions().setToSourceEnabled(true); in spidermonkey 91? I expect the problem will be inside CouchDB somehow, but I'm here because I'm baffled, and I wanted to check my understanding of this option and whether it's changed recently.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Apr 20 2022 03:50:36 GMT-0700 (Pacific Daylight Time)">10:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Yeah, that's the only option and setting it to true should enable <code>toString</code> (so, each prototypes should get <code>toString</code> <a href="https://searchfox.org/mozilla-esr91/rev/e692ca4879c94163d2941e327673c68573c65e69/js/src/vm/JSObject.cpp#2497-2503">https://searchfox.org/mozilla-esr91/rev/e692ca4879c94163d2941e327673c68573c65e69/js/src/vm/JSObject.cpp#2497-2503</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Apr 20 2022 03:51:38 GMT-0700 (Pacific Daylight Time)">10:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">right. (you mean 'toSource' there?). We only call .toSource on errors, that is <code>try { do things } catch (err) { log("exception caught: " + err.toSource()); }</code> patterns.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Apr 20 2022 03:51:45 GMT-0700 (Pacific Daylight Time)">10:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Apr 20 2022 03:51:50 GMT-0700 (Pacific Daylight Time)">10:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, <code>toSource</code></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Apr 20 2022 03:52:41 GMT-0700 (Pacific Daylight Time)">10:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">ok, so it must be something we're doing in CouchDB. that helps to narrow it down, thanks.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Apr 20 2022 03:52:48 GMT-0700 (Pacific Daylight Time)">10:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">It might be nice to check what the prototype of <code>err</code> is</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Apr 20 2022 03:52:57 GMT-0700 (Pacific Daylight Time)">10:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code><a href="http://err.constructor.name">err.constructor.name</a></code></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Apr 20 2022 03:53:00 GMT-0700 (Pacific Daylight Time)">10:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">hmm I can do that</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Apr 20 2022 03:53:38 GMT-0700 (Pacific Daylight Time)">10:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell"><code>Object</code></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Apr 20 2022 03:53:55 GMT-0700 (Pacific Daylight Time)">10:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, so it's not <code>Error</code></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Apr 20 2022 03:54:10 GMT-0700 (Pacific Daylight Time)">10:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">apparently not. is that the problem?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Apr 20 2022 03:54:29 GMT-0700 (Pacific Daylight Time)">10:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-function">  try {  throw({name: 'TypeError', message: 'oops'}); } catch (err) { print("yay: " + err.constructor.name); print("yay: " + err.toSource()) }
}```
</code></pre>
</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Apr 20 2022 03:54:37 GMT-0700 (Pacific Daylight Time)">10:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">not problem. Object should also have <code>toSource</code></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Apr 20 2022 03:55:09 GMT-0700 (Pacific Daylight Time)">10:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">is my test. I get a <code>yay Object</code> print but not the second one. that crashes and our couchjs program prints <code>["error","TypeError",{}]</code></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Apr 20 2022 03:55:30 GMT-0700 (Pacific Daylight Time)">10:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">right. toSource should be on Object, so it should still work. </td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Apr 20 2022 03:55:31 GMT-0700 (Pacific Daylight Time)">10:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">hrm</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Apr 20 2022 03:56:04 GMT-0700 (Pacific Daylight Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Can you check if <code>Object.prototype.toSource</code> exists, in the catch clause?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Apr 20 2022 03:56:09 GMT-0700 (Pacific Daylight Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">sure</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Apr 20 2022 03:56:54 GMT-0700 (Pacific Daylight Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell"><code>undefined</code></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Apr 20 2022 03:56:59 GMT-0700 (Pacific Daylight Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">that'd do it</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Apr 20 2022 03:57:07 GMT-0700 (Pacific Daylight Time)">10:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what about <code>Function.prototype.toSource</code> ?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Apr 20 2022 03:57:17 GMT-0700 (Pacific Daylight Time)">10:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'd like to see if it's specific to Object or not</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Apr 20 2022 03:57:30 GMT-0700 (Pacific Daylight Time)">10:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">sure</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Apr 20 2022 03:57:40 GMT-0700 (Pacific Daylight Time)">10:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">also undefined</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Apr 20 2022 03:58:01 GMT-0700 (Pacific Daylight Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">I'm thinking it must be CouchDB. There's some work we do to further sandbox what users can do in these callbacks</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Apr 20 2022 03:58:14 GMT-0700 (Pacific Daylight Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">and I wonder if it redeclares Object and only adds some prototypes</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Apr 20 2022 03:58:20 GMT-0700 (Pacific Daylight Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, it sounds like the creation option isn't properly reflected</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Apr 20 2022 03:59:06 GMT-0700 (Pacific Daylight Time)">10:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">or, I think, we (couchdb) have broken it at some point before we execute user code</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Apr 20 2022 03:59:21 GMT-0700 (Pacific Daylight Time)">10:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">it definitely worked when we did this against 1.8.5.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Apr 20 2022 04:01:11 GMT-0700 (Pacific Daylight Time)">11:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">hm, nope. we only do that extra work when compiling a user supplied function, and my test is outside of that area.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Apr 20 2022 04:01:12 GMT-0700 (Pacific Daylight Time)">11:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">hrm</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Apr 20 2022 04:01:48 GMT-0700 (Pacific Daylight Time)">11:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is the code on the github the latest one you're testing?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Apr 20 2022 04:02:01 GMT-0700 (Pacific Daylight Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Apr 20 2022 04:02:08 GMT-0700 (Pacific Daylight Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, let me check</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Apr 20 2022 04:02:20 GMT-0700 (Pacific Daylight Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/apache/couchdb/blob/3.x/src/couch/priv/couch_js/86/main.cpp#L67">https://github.com/apache/couchdb/blob/3.x/src/couch/priv/couch_js/86/main.cpp#L67</a> is exactly what I'm testing</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Apr 20 2022 04:03:25 GMT-0700 (Pacific Daylight Time)">11:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">I'm really sorry but I need to step out for a bit, the dogs are insisting on a walk, I'll be back in about an hour.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Apr 20 2022 04:04:01 GMT-0700 (Pacific Daylight Time)">11:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">no problem :)</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Apr 20 2022 04:09:44 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">Caspy7</span>: I wouldn't worry too much about the version number, it's just signalling that wasm is switching from a versioned spec model to an evergreen spec model.  it has no impact on wasm itself, it's just paperwork.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Apr 20 2022 04:42:36 GMT-0700 (Pacific Daylight Time)">11:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@lostnet:matrix.org">lostnet</span>&gt;</div></td><td class="msg-cell"> <span class="nick-1">rnewson</span>:  I think we just missed enabling it on the main realm options:</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Apr 20 2022 04:42:47 GMT-0700 (Pacific Daylight Time)">11:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@lostnet:matrix.org">lostnet</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/apache/couchdb/blob/9e6fd279dbc6ae4d90ad14bf970c9cec528c5c15/src/couch/priv/couch_js/86/main.cpp#L271">https://github.com/apache/couchdb/blob/9e6fd279dbc6ae4d90ad14bf970c9cec528c5c15/src/couch/priv/couch_js/86/main.cpp#L271</a>
</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Apr 20 2022 04:44:39 GMT-0700 (Pacific Daylight Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, good to see it's solved :)  I'm still having trouble setting up development environment :P</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Apr 20 2022 04:56:23 GMT-0700 (Pacific Daylight Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">hi, back.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Apr 20 2022 04:56:30 GMT-0700 (Pacific Daylight Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">lostnet</span>: ooh</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Apr 20 2022 04:58:38 GMT-0700 (Pacific Daylight Time)">11:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">that fixes my test. checking the "real" path now which will take a little longer</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Apr 20 2022 05:01:39 GMT-0700 (Pacific Daylight Time)">12:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell">yup, that's it. </td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Apr 20 2022 05:02:45 GMT-0700 (Pacific Daylight Time)">12:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@rnewson:mozilla.org">rnewson</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">lostnet</span>: thanks!</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Apr 20 2022 07:27:34 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">@allstarschh</span>: did you file test issues about <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1688879#c11">https://bugzilla.mozilla.org/show_bug.cgi?id=1688879#c11</a> ?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Apr 20 2022 07:30:00 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, nm, missed that one line 🙂</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Apr 20 2022 08:36:59 GMT-0700 (Pacific Daylight Time)">15:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: I would be around if you want to chat</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Apr 20 2022 08:37:32 GMT-0700 (Pacific Daylight Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">evilpie</span>: shoot, right now I'm coming up on back-to-back meetings. :-(</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Apr 20 2022 11:39:20 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">What is the interaction between the profiler and the frame pointer in Ion? In bug 736299 we added code to reserve the frame pointer when the profiler is turned on, but AFAICT we don't actually use that register as a frame pointer. Since then, it looks like we've completely replaced the profiler implementation. Do we still need to reserve the frame pointer when the profiler is turned on? If so, why?</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Apr 20 2022 11:39:22 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/736299">https://bugzil.la/736299</a> — RESOLVED (u443197) — IonMonkey: Add a frame pointer for profiling &amp; debugging mode.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Apr 20 2022 14:47:15 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: Hi, I'm from the Profiler side 👋<br>When sampling a stack: We need the <code>JS::ProfilingFrameIterator</code> machinery to get the JS stack. We also walk the native stack (C++, Rust), for which frame pointers are probably needed; however since bug 1700869, if the native stack walker gets lost somewhere, we use <code>jit::JitRuntime::getCppEntryRegisters</code> to retrieve the stack&amp;frame pointers where native code entered JS-generated code, so that we can resume native stack-walking from there.<br>So I <em>think</em> that as long as the above stays, it <em>may</em> be acceptable to lose other frame pointers. In any case, if you wanted to experiment removing it, please please make sure the Profiler can still do its work. 🙂<br><span class="nick-10">jandem</span> : You helped review bug 1700869, so I assume you know more about the JS side... What do you think?</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Apr 20 2022 14:47:17 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1700869">https://bugzil.la/1700869</a> — RESOLVED (gerald) — Add `JS::ProfilingFrameIterator::getCppEntryRegisters()` to retrieve registers needed to resume stack-walking</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Apr 20 2022 15:38:03 GMT-0700 (Pacific Daylight Time)">22:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">gerald</span>: Thanks for the info!</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Apr 20 2022 15:44:55 GMT-0700 (Pacific Daylight Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">On the JS side, most of our code uses frame pointers, but Ion-compiled code (the highest optimization tier) doesn't. When the profiler is turned on, we <em>do</em> make sure not to allocate the frame pointer as a regular register, but (unless I've missed something) we don't actually use it for anything/keep it updated.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Apr 20 2022 15:45:32 GMT-0700 (Pacific Daylight Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If we were to change anything on the JS side, it would likely be to add frame pointers to Ion, not take them away elsewhere.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Apr 20 2022 15:46:10 GMT-0700 (Pacific Daylight Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But right now it seems like maybe we're in the worst of all worlds, where we don't use the frame pointer as a regular register but also don't make it useful for stack walking.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Apr 20 2022 15:47:00 GMT-0700 (Pacific Daylight Time)">22:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell">Yeah, that sounds wasteful. Good luck in your further explorations!</td></tr>

</tbody></table></div></div></div>
</body></html>