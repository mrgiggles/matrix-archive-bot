<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-05-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-05-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-05-06" class="nav-link"><span>prev</span></a>
<a href="2025-05-08" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue May 06 2025 17:16:06 GMT-0700 (Pacific Daylight Time)">00:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@thinker.li:mozilla.org">thinker</span>&gt;</div></td><td class="msg-cell">One question about JSON.stringify(), it uses StringBuilder as the buffer during stringify. However, when the capacity of the buffer in StringBuilder is exhuasted, it reallocates buffer. That means data copy several times with a big size of result. I also found that there is another StringBuilder in dom/base/nsContentUtils.cpp. It keep entries that refer to the data source (origin array, string, ... etc). And, when the capacity entries is exhausted, it will allocates new entries instead of relocating buffers.  Is there any reason JS's StringBuilder taking this approach? The other day (1 month ago), I found stringify may expansive when I studying a profile although I have lost that one now. I just wondering if it is possible to improve it.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed May 07 2025 04:06:04 GMT-0700 (Pacific Daylight Time)">11:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">thinker</span>: it's a good suggestion. This has come up recently also in bug 1963431 and bug 1957918. The latter one is the next thing on my list so I want to collect some data to see how common it is to have large strings appended to string builders for JSON.stringify, join etc</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed May 07 2025 04:09:12 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the JS StringBuilder allows stealing the vector's malloced buffer for the result string in some cases, but we often over allocate this buffer now (to avoid reallocs) so I also want to see how well that works in practice</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed May 07 2025 04:12:56 GMT-0700 (Pacific Daylight Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">we're also moving away from raw malloc for JS string chars now that we have nursery allocated chars, ref-counted StringBuffers and ongoing work on the buffer allocator</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed May 07 2025 05:18:04 GMT-0700 (Pacific Daylight Time)">12:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">There is an approach I wanted to try in the past for JSON.stringify(), which is to use a different buffering mechanism which only copy twice, once to aggregate the chunks, and a second time to linearize the buffer. We have a Printer class named <code>LSprinter</code> which was made to avoid copies during buffer extensions. It makes small allocations backed by a LifoAlloc-ator and coalesce adjoint allocation in bigger chunks.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed May 07 2025 05:18:38 GMT-0700 (Pacific Daylight Time)">12:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Except that moving from a <code>StringBuffer</code> to an <code>LSprinter</code> is quite invasive.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed May 07 2025 09:27:13 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I am prototyping something; is it possible to have a JSFunction with a custom class (w Finalizer) or should I just keep pushing down the JSObject+callHook road? </td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed May 07 2025 09:31:06 GMT-0700 (Pacific Daylight Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I think we currently have exactly two classes for JSFunction: <a href="https://searchfox.org/mozilla-central/source/js/public/Class.h#688-690">https://searchfox.org/mozilla-central/source/js/public/Class.h#688-690</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed May 07 2025 09:31:52 GMT-0700 (Pacific Daylight Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which share the same finalizer-less classops: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/JSFunction.cpp#1185-1196">https://searchfox.org/mozilla-central/source/js/src/vm/JSFunction.cpp#1185-1196</a></td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed May 07 2025 09:33:14 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can it be JSFunction+custom class object in the function's slot, so that they'll be GCed at almost same timing? or does the finalizer have to be directly associated with the function/callable?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed May 07 2025 09:34:22 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. That probably would be fine too, but trying to reduce allocations in general, so I think I'll keep pushing along JSObject + callHook for now. (All this prototype has to be rewritten eventually anyhow) </td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed May 07 2025 09:48:43 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: This is for promise reaction jobs?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed May 07 2025 09:48:53 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">I see Speedometer 3 vendored in the tree, but I'm not clear on how to run it against a local build. I see directions for running in the Speedometer3 directory, but it's not clear whether I should be running the browser separately or wha.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed May 07 2025 09:50:48 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">leftmostcat</span>: You can run it <a href="https://browserbench.org/Speedometer3.1/">here</a>, or, for more control over specific subtests, <a href="https://browserbench.org/Speedometer3.1/InteractiveRunner.html">here</a>.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed May 07 2025 09:51:13 GMT-0700 (Pacific Daylight Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">Thank you.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed May 07 2025 10:11:32 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">No; a JS side holder for non-JS microtask jobs </td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed May 07 2025 10:12:33 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, interesting. I expect that to be a slightly less hot path, so an extra allocation there might not be the worst (but if we can do it without allocation so much the better)</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed May 07 2025 10:16:09 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span></div></td><td class="msg-cell">nods</td></tr>

</tbody></table></div></div></div>
</body></html>