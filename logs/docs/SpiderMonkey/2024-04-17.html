<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-04-17</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-04-17<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-04-16" class="nav-link"><span>prev</span></a>
<a href="2024-04-18" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Apr 16 2024 22:54:08 GMT-0700 (Pacific Daylight Time)">05:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><p>I accidentally wrote some terrible code which crashed Spidermonkey:</p>
<pre><code>async function badidea() {
    await badidea();
}
</code></pre>
<p>I can see why this one would be a pain to handle, since you can't track the recursion on the stack. But isn't this something that the engine should be able to recover from? Right now I'm getting an unhandled C++ exception.</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Apr 17 2024 00:04:39 GMT-0700 (Pacific Daylight Time)">07:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">do you set the stack limit?  if it's set, over-recursion error should be thrown</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Apr 17 2024 00:05:53 GMT-0700 (Pacific Daylight Time)">07:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if not set, it will just become native stack overflow or something</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Apr 17 2024 00:14:25 GMT-0700 (Pacific Daylight Time)">07:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/b94e479d0b79b157029379832d05229df646e134/js/public/Stack.h#59-80">JS_SetNativeStackQuota</a> is the function to set the stack limit</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Apr 17 2024 00:15:07 GMT-0700 (Pacific Daylight Time)">07:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if you get the C++ exception even with it, try reducing the size to see if it changes the behavior</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Apr 17 2024 00:20:16 GMT-0700 (Pacific Daylight Time)">07:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, if you have multiple threads, you need to call it for each thread</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Apr 17 2024 01:08:46 GMT-0700 (Pacific Daylight Time)">08:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@sagu:mozilla.org">samson</span>&gt;</div></td><td class="msg-cell">Is it possible to run any code before any object is actually finalized (so between mark and sweep)?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Apr 17 2024 03:10:28 GMT-0700 (Pacific Daylight Time)">10:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in what layer is it about?  pure JavaScript, or embedding's JavaScript, or embedding's C++ side?  on pure JavaScript, you can use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Apr 17 2024 03:11:31 GMT-0700 (Pacific Daylight Time)">10:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">on C++ side, for your own JSClass, you can have finalize hook</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Apr 17 2024 03:15:32 GMT-0700 (Pacific Daylight Time)">10:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@sagu:mozilla.org">samson</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> in what layer is it about?  pure JavaScript, or embedding's JavaScript, or embedding's C++ side?  on pure JavaScript, you can use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry</a></blockquote></mx-reply>Embedding C++ (well rust in servo).</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Apr 17 2024 03:16:01 GMT-0700 (Pacific Daylight Time)">10:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@sagu:mozilla.org">samson</span>&gt;</div></td><td class="msg-cell">So finalize hook is run before any object destruction?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Apr 17 2024 03:18:29 GMT-0700 (Pacific Daylight Time)">10:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's <a href="https://searchfox.org/mozilla-central/rev/b94e479d0b79b157029379832d05229df646e134/js/public/Class.h#593,601">JSClassOps.finalize</a> field, and <a href="https://searchfox.org/mozilla-central/rev/b94e479d0b79b157029379832d05229df646e134/js/public/Class.h#293-298">JSFinalizeOp</a> has comment describes how it works</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Apr 17 2024 03:18:57 GMT-0700 (Pacific Daylight Time)">10:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, yes, it's called before the object gets collected</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Apr 17 2024 03:20:16 GMT-0700 (Pacific Daylight Time)">10:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you can control in which thread it gets called by <a href="https://searchfox.org/mozilla-central/rev/b94e479d0b79b157029379832d05229df646e134/js/public/Class.h#548-551">JSCLASS_BACKGROUND_FINALIZE/JSCLASS_FOREGROUND_FINALIZE</a> flags for <code>JSClass.flags</code> field</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Apr 17 2024 03:26:40 GMT-0700 (Pacific Daylight Time)">10:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">to be clear, this applies only to objects with your own JSClass.  so doesn't meet the "any object" criteria</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Apr 17 2024 03:28:04 GMT-0700 (Pacific Daylight Time)">10:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if you want to run code on specific-but-now-your-own-class object, you could put your own class's object to the target object's property, so that both will be finalized in almost same timing</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Apr 17 2024 03:37:10 GMT-0700 (Pacific Daylight Time)">10:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@sagu:mozilla.org">samson</span>&gt;</div></td><td class="msg-cell">I see, but looking at servo code again the problem wasn't GC ðŸ˜…, but drop from program.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Apr 17 2024 03:37:42 GMT-0700 (Pacific Daylight Time)">10:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@sagu:mozilla.org">samson</span>&gt;</div></td><td class="msg-cell">Thank you anyway for more knowledge.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Apr 17 2024 04:07:15 GMT-0700 (Pacific Daylight Time)">11:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">no problem :)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Apr 17 2024 04:11:19 GMT-0700 (Pacific Daylight Time)">11:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> if not set, it will just become native stack overflow or something</blockquote></mx-reply>I see, that's what's happening. I'll use the <code>JS_SetNativeStackQuota</code> as you suggest.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Apr 17 2024 06:06:49 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: the bug about clearing references <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1891023#c4">https://bugzilla.mozilla.org/show_bug.cgi?id=1891023#c4</a>  (perfherder <a href="https://treeherder.mozilla.org/perfherder/graphs?highlightAlerts=1&amp;highlightChangelogData=1&amp;highlightCommonAlerts=0&amp;replicates=0&amp;series=autoland,3912889,1,13&amp;timerange=5184000">link</a>)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Apr 17 2024 06:09:19 GMT-0700 (Pacific Daylight Time)">13:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Oh this landed already, great</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Apr 17 2024 06:17:19 GMT-0700 (Pacific Daylight Time)">13:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">jlink</span>: it's not supported by all memory allocators on all platforms (I don't remember off hand but using this causes some failures)</blockquote></mx-reply>Thanks! It turns out that that static assert was added recently so I've been looking the commits/discussion on it since your message. I'll ask any more questions on <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1842582">https://bugzilla.mozilla.org/show_bug.cgi?id=1842582</a>.</td></tr>

</tbody></table></div></div></div>
</body></html>