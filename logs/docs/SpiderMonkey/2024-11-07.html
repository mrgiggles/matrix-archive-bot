<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-11-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-11-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-11-06" class="nav-link"><span>prev</span></a>
<a href="2024-11-08" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Nov 06 2024 17:02:13 GMT-0800 (Pacific Standard Time)">01:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">It's about this one <code>JSObject* incumbentGlobal = global-&gt;GetGlobalJSObject();</code></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Nov 06 2024 17:02:54 GMT-0800 (Pacific Standard Time)">01:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the variable is not rooted, and it's used across <code>JS_NewObject</code> call</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Nov 06 2024 17:03:52 GMT-0800 (Pacific Standard Time)">01:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS_NewObject</code> can GC, which means the object pointed by <code>incumbentGlobal</code> can be moved by GC, and the <code>incumbentGlobal</code> pointer can become dangling pointer when used in <code>JS_SetReservedSlot(objResult, INCUMBENT_SETTING_SLOT, JS::ObjectValue(*incumbentGlobal));</code></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Nov 06 2024 17:04:20 GMT-0800 (Pacific Standard Time)">01:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">So, it needs to be <code>JS::Rooted&lt;JSObject*&gt; incumbentGlobal(cx, global-&gt;GetGlobalJSObject());</code></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Nov 06 2024 17:23:59 GMT-0800 (Pacific Standard Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">sefeng</span>: added comment to <a href="https://phabricator.services.mozilla.com/D224959">https://phabricator.services.mozilla.com/D224959</a></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Nov 06 2024 21:05:35 GMT-0800 (Pacific Standard Time)">05:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Hi, I'm working on <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1928966">https://bugzilla.mozilla.org/show_bug.cgi?id=1928966</a>. Right now, I'm refactoring the jsnum.cpp file because my plan is to have JS::ParseInt call js::ParseIntSlow. For performance reasons, I want to implement fast paths in js::ParseIntSlow similar to those in num_parseInt. To avoid code duplication, I discussed with Yulia yesterday the idea of creating a common function.

I'm interested in finding the best name for this function. It would handle fast-track operations similar to num_parseInt before calling js::NumberParseInt. My current ideas is something like js::FastParseInt or js::ParseIntAccelerated, but I'm afraid it could be confusing names.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Nov 06 2024 21:07:50 GMT-0800 (Pacific Standard Time)">05:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Do you mean <a href="https://searchfox.org/mozilla-central/source/js/src/jsnum.cpp#580-629">this</a> part ?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Nov 06 2024 21:11:48 GMT-0800 (Pacific Standard Time)">05:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Do you mean <a href="https://searchfox.org/mozilla-central/source/js/src/jsnum.cpp#580-629">this</a> part ?</blockquote></mx-reply>Yes, you're right. However, I also think it might be a bit redundant, since <code>JS::ParseInt</code> will be called when <code>console.log</code> is invoked. Given that I/O operations take considerable time, we might not see much difference between the optimized and non-optimized versions.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Nov 06 2024 21:19:25 GMT-0800 (Pacific Standard Time)">05:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">If that part is going to be moved to a common function, I would expect it to have either <code>Try</code> or <code>Is</code> prefix</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Nov 06 2024 21:19:46 GMT-0800 (Pacific Standard Time)">05:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">actually I think there's similar example where <code>Is</code> prefix is used. let me check</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Nov 06 2024 21:23:02 GMT-0800 (Pacific Standard Time)">05:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">other option I can think of is not to move that part to a common function, but templatize the entire function with "inline fast path + call for slow path" structure, with making the input/output controllable with the template parameter.  so that you don't have to think about the function name for the fast path part</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Nov 06 2024 21:25:25 GMT-0800 (Pacific Standard Time)">05:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Let's go to the thread</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Nov 06 2024 21:25:55 GMT-0800 (Pacific Standard Time)">05:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><p>My idea is that we call this function what tries to do fast tracks, and if it is impossible, calls js::NumberParseInt,</p>
<p>The structure is the next</p>
<pre><code>bool js::FastParseInt(JSContext\* cx, HandleValue v, int32\_t radix,
MutableHandleValue result) {
&lt;fast tracks&gt;
...
// Step 1.
  RootedString inputString(cx, ToString&lt;CanGC&gt;(cx, v));
  if (!inputString) {
    return false;
  }

  // Steps 2-5, 7-16.
  return NumberParseInt(cx, inputString, radix, result);
</code></pre>
</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Nov 06 2024 21:26:34 GMT-0800 (Pacific Standard Time)">05:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hm, the case I was thinking of with <code>Is</code> prefis was <a href="https://searchfox.org/mozilla-central/rev/5b288ed276a9580f2bedd4f67543940667d6a8c0/js/src/vm/StringType.h#2376">JSLinearString::isIndex</a> and  <a href="https://searchfox.org/mozilla-central/rev/5b288ed276a9580f2bedd4f67543940667d6a8c0/js/src/builtin/Array.h#26">js::IdIsIndex</a>, but it also has the slow path inside it. so it's different structure</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Nov 06 2024 21:28:16 GMT-0800 (Pacific Standard Time)">05:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><p>I also think about the helper function will try to do fast paths and call slow implementation if optimizations are impossible. This option is good because we will be able just to write smth like</p>
<pre><code>return js::FastParseInt(cx, v, radix, args.rval())
</code></pre>
</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Nov 06 2024 21:28:51 GMT-0800 (Pacific Standard Time)">05:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, the "Fast" function also performs the slow path?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Nov 06 2024 21:29:03 GMT-0800 (Pacific Standard Time)">05:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">If your function handles all cases, why isn't it just called <code>ParseInt</code>? The structure you posted looks fine.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Nov 06 2024 21:29:52 GMT-0800 (Pacific Standard Time)">05:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">So this is why I'm asking about calling, because it tries to do fast path, but it's more comfortable if it also calls slow implementation</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Nov 06 2024 21:31:45 GMT-0800 (Pacific Standard Time)">05:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>I was thinking the following structure:</p>
<pre><code>bool JS::ParseInt(..) {
  ...
  if (TryParseIntFast(...)) {
    return true;
  }

  return ParseIntSlow(...);
}

bool num_parseInt(..) {
  ...
  if (TryParseIntFast(...)) {
    return true;
  }

  return ParseIntSlow(...);
}
</code></pre>
</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Nov 06 2024 21:32:42 GMT-0800 (Pacific Standard Time)">05:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> If your function handles all cases, why isn't it just called <code>ParseInt</code>? The structure you posted looks fine.</blockquote></mx-reply><p>right now js::NumberParseInt is about the ECMA standard, and in ECMA it's said that the argument is a string.</p>
<p>But because we want to have optimizations, we need to do some checks in other functions</p>
</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Nov 06 2024 21:33:45 GMT-0800 (Pacific Standard Time)">05:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, you want a new function that performs <code>NumberParseInt</code> but with extra fast path performed before the spec-ed operation ?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Nov 06 2024 21:33:57 GMT-0800 (Pacific Standard Time)">05:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I will defer to arai, who has more context here.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Nov 06 2024 21:35:29 GMT-0800 (Pacific Standard Time)">05:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I was thinking the following structure:</p>
<pre><code>bool JS::ParseInt(..) {
  ...
  if (TryParseIntFast(...)) {
    return true;
  }

  return ParseIntSlow(...);
}

bool num_parseInt(..) {
  ...
  if (TryParseIntFast(...)) {
    return true;
  }

  return ParseIntSlow(...);
}
</code></pre>
</blockquote></mx-reply><p>Hmm, that's an interesting solution.</p>
<p>However, I also have some concerns. <code>JS::ParseInt</code> will only be called in cases involving I/O operations, so trying to speed up parsing might be unnecessary. Additionally, by adding a new call in <code>num_parseInt</code>, the compiler might <strong>not</strong> inline it, leading to potential performance degradation.</p>
</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Nov 06 2024 21:35:48 GMT-0800 (Pacific Standard Time)">05:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the function does both fast path and slow path, then the function shouldn't have any prefix/suffix</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Nov 06 2024 21:36:48 GMT-0800 (Pacific Standard Time)">05:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you can use <a href="https://searchfox.org/mozilla-central/rev/5b288ed276a9580f2bedd4f67543940667d6a8c0/mfbt/Attributes.h#14-38">MOZ_ALWAYS_INLINE</a> if you want the function to always be inlined</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Nov 06 2024 21:38:24 GMT-0800 (Pacific Standard Time)">05:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, just to make sure, the above fast + slow calls are my initial understanding of what you were trying to do.  I don't mean that best fits the bug's case</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Nov 06 2024 21:38:58 GMT-0800 (Pacific Standard Time)">05:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'll only mention that you're adding a public function, so you can't assume that yours will be the only caller. Somebody else might end up using it later. So don't overfit based on your current use case.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Nov 06 2024 21:39:59 GMT-0800 (Pacific Standard Time)">05:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Ok, about performance, I could try to find jstests to test performance before and after</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Nov 06 2024 21:40:59 GMT-0800 (Pacific Standard Time)">05:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">If having a single shared function with both fast and slow path fits both consumers, then that would be better</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Nov 06 2024 21:42:22 GMT-0800 (Pacific Standard Time)">05:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> oh, just to make sure, the above fast + slow calls are my initial understanding of what you were trying to do.  I don't mean that best fits the bug's case</blockquote></mx-reply><p>I'm trying to add JS::ParseInt to JSAPI public interface for c++. I can do it like JS::ToInt32, when I just check that the argument is int type, I return it, otherwise I call js::NumberParseInt.</p>
<p>But I want to do all my best, and one of the idea is to perform more fast paths, however it leads to code duplication</p>
</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Nov 06 2024 21:43:38 GMT-0800 (Pacific Standard Time)">05:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">So, the design would depend on how much duplication there are, or how the common part look like between them</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Nov 06 2024 21:45:41 GMT-0800 (Pacific Standard Time)">05:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the difference is only about input and output, then the most of the function body can be moved to the shared function.  and the shared function can have the same name as the current slow path.  the parameter type should be sufficient to distinguish between them</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Nov 06 2024 21:46:49 GMT-0800 (Pacific Standard Time)">05:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, for example, if the fast path is common but the slow path is heavily different between those 2 consumers, then you'll want a shared function to be only for the fast path.  in that case, the shared function should have a function name that explains "this is only fast path", "you need to fallback to slow path on failure", etc</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Nov 06 2024 21:46:51 GMT-0800 (Pacific Standard Time)">05:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'll only mention that you're adding a public function, so you can't assume that yours will be the only caller. Somebody else might end up using it later. So don't overfit based on your current use case.</blockquote></mx-reply>You're right that making the function flexible as soon as possible is a good idea. However, this function is specifically about how JS parses integers (in a rather unusual way), and currently, the only use case is in <code>console.log</code> invocations. As I discussed with Yulia yesterday, it's fine to go with a constrained implementation for now.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Nov 06 2024 21:48:41 GMT-0800 (Pacific Standard Time)">05:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> if the difference is only about input and output, then the most of the function body can be moved to the shared function.  and the shared function can have the same name as the current slow path.  the parameter type should be sufficient to distinguish between them</blockquote></mx-reply><p>The difference between JS::ParseInt and num_parseInt is only about input/output.</p>
<p>In JS::ParseInt we have <code>HandleValue v</code> to parse and <code>radix</code> is always equal to 10.<br>In num_parseInt we have <code>CallArgs args</code>, <code>args[0]</code> is similar to <code>v</code>, and <code>args[1]</code> is similar to <code>radix</code></p>
</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Nov 06 2024 21:48:47 GMT-0800 (Pacific Standard Time)">05:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if you're thinking about deduplication, it would be nice to first write the "duplicated" version.  then we can discuss based on it</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Nov 06 2024 21:50:16 GMT-0800 (Pacific Standard Time)">05:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">It's a good point to see the duplicated version and after that to decide how we can enhance the code. I'm going to do it</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Nov 06 2024 21:50:38 GMT-0800 (Pacific Standard Time)">05:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Thank you a lot for the assistance, <span class="nick-15">arai</span> and <span class="nick-12">sfink</span> !</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Nov 06 2024 21:50:52 GMT-0800 (Pacific Standard Time)">05:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, so the input is mostly just <code>JS::Value</code>.  and the output is <code>JS::Value</code> vs <code>int64_t</code>.  which means you need to handle the difference between non-<code>int32_t</code> range part.  you'll need some abstraction about how to handle the result</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Nov 06 2024 21:57:07 GMT-0800 (Pacific Standard Time)">05:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, if the <code>uint64_t</code> result is just converted from <code>JS::Value</code>, then there's no need to handle that part in shared function</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Nov 06 2024 21:57:34 GMT-0800 (Pacific Standard Time)">05:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">My revision is not correct, I need to return double, not int64_t (we need to detect NaN)</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Nov 06 2024 21:59:41 GMT-0800 (Pacific Standard Time)">05:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, I'll wait for the updated and "duplicated" version :)</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Nov 06 2024 22:00:24 GMT-0800 (Pacific Standard Time)">06:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Working on it, what's the best way to provide "duplicated" version?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Nov 06 2024 22:01:57 GMT-0800 (Pacific Standard Time)">06:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you can submit it to phabricator, or pastebin the diff to <a href="https://pastebin.mozilla.org/">https://pastebin.mozilla.org/</a></td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Nov 06 2024 22:02:51 GMT-0800 (Pacific Standard Time)">06:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">submiting with <code>--wip</code> option marks the revision as "work in progress".  that revision doesn't trigger any notification</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Nov 06 2024 22:11:22 GMT-0800 (Pacific Standard Time)">06:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><a href="https://phabricator.services.mozilla.com/D228280">https://phabricator.services.mozilla.com/D228280</a></td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Nov 06 2024 22:16:19 GMT-0800 (Pacific Standard Time)">06:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">looking</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Nov 06 2024 22:38:32 GMT-0800 (Pacific Standard Time)">06:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">gaporf</span>: added comments</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Nov 06 2024 22:39:33 GMT-0800 (Pacific Standard Time)">06:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, the structure is actually different between them, and absorbing all of them may require some amount of abstraction with template etc</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Nov 06 2024 22:43:14 GMT-0800 (Pacific Standard Time)">06:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and I'm not sure if the de-duplication worth the extra complexity, especially with the template way</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Nov 06 2024 22:44:20 GMT-0800 (Pacific Standard Time)">06:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, one more question, don't we need ParseInt with non-10 radix?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Nov 06 2024 22:44:57 GMT-0800 (Pacific Standard Time)">06:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if that's also necessary, the situation becomes different</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Nov 06 2024 22:45:31 GMT-0800 (Pacific Standard Time)">06:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">IMHO, template function seems too complex in current case.

In num_parseInt we can firstly to extract radix, and call shared_function with value to parse and radix, so we don't need to have templates</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Nov 06 2024 22:46:35 GMT-0800 (Pacific Standard Time)">06:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> also, one more question, don't we need ParseInt with non-10 radix?</blockquote></mx-reply>From the standard (<a href="https://console.spec.whatwg.org/#logger">https://console.spec.whatwg.org/#logger</a>):</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Nov 06 2024 22:48:03 GMT-0800 (Pacific Standard Time)">06:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>num_parseInt</code>'s order cannot be changed.   it's defined by <a href="https://tc39.es/ecma262/#sec-parseint-string-radix">the spec</a>, and both <code>ToString</code> and <code>ToInt32</code> are observable from user code.  changing the order makes the implementation not spec-compliant</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Nov 06 2024 22:48:50 GMT-0800 (Pacific Standard Time)">06:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">But right now we firstly do step 6, and only after that we do steps 2-5</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Nov 06 2024 22:49:27 GMT-0800 (Pacific Standard Time)">06:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's because the early return path is for the case all operations are not observed</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Nov 06 2024 22:50:53 GMT-0800 (Pacific Standard Time)">06:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the <code>string</code> is int32/double/string and radix is undefined/int32, none of ToString and <code>ToInt32</code> are observable.  so we can perform the early return without any side effect</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Nov 06 2024 22:51:39 GMT-0800 (Pacific Standard Time)">06:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Honestly I don't see any problems why we can't extract radix firstly? We can only fails if radix value is incorrect, but fast paths are executed if radix value is absent or correct int</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Nov 06 2024 22:52:13 GMT-0800 (Pacific Standard Time)">06:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can you define the detail of "extract radix" ?</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Nov 06 2024 22:52:27 GMT-0800 (Pacific Standard Time)">06:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Do you mean <code>ToInt32(radix)</code>, or something else?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Nov 06 2024 22:53:03 GMT-0800 (Pacific Standard Time)">06:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Step 6</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Nov 06 2024 22:53:22 GMT-0800 (Pacific Standard Time)">06:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/jsnum.cpp#637-643">https://searchfox.org/mozilla-central/source/js/src/jsnum.cpp#637-643</a></td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Nov 06 2024 22:53:41 GMT-0800 (Pacific Standard Time)">06:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>ToString(string)</code> and <code>ToInt32(radix)</code> are observable.  performing <code>ToInt32(radix)</code> before <code>ToString(string)</code> doesn't conform to the spec</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Nov 06 2024 22:54:29 GMT-0800 (Pacific Standard Time)">06:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe we should define more clearly about the problem</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Nov 06 2024 22:54:46 GMT-0800 (Pacific Standard Time)">06:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Do you mean moving <code>ToInt32(cx, args[1], &amp;radix)</code> call ?  or something else?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Nov 06 2024 22:55:33 GMT-0800 (Pacific Standard Time)">06:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>ToInt32(cx, args[1], &amp;radix)</code> is observable operation unless <code>args[1]</code> is known to have no side-effect with it</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Nov 06 2024 22:55:40 GMT-0800 (Pacific Standard Time)">06:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">I want to move it between line 584 and 586</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Nov 06 2024 22:55:56 GMT-0800 (Pacific Standard Time)">06:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, that doesn't work</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Nov 06 2024 22:56:08 GMT-0800 (Pacific Standard Time)">06:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">let me prepare some example</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Nov 06 2024 22:57:07 GMT-0800 (Pacific Standard Time)">06:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Got your point, so I think that template function is complicated for understanding, and it's better to use functions <code>TryFastParseInt</code> and <code>ParseIntSlow</code></td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Nov 06 2024 22:57:12 GMT-0800 (Pacific Standard Time)">06:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><pre><code>parseInt({
  toString() { console.log("toString"); }
}, {
  valueOf() { console.log("valueOf"); }
});
</code></pre>
</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Nov 06 2024 22:57:37 GMT-0800 (Pacific Standard Time)">06:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>This is supposed to print the following</p>
<pre><code>toString
valueOf
</code></pre>
</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Nov 06 2024 22:58:03 GMT-0800 (Pacific Standard Time)">06:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">which means, <code>ToString&lt;CanGC&gt;(cx, args[0])</code> should be performed before <code>ToInt32(cx, args[1], &amp;radix)</code></td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Nov 06 2024 22:59:32 GMT-0800 (Pacific Standard Time)">06:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, then now we need to think about the name for the "fast path only" function :)</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Nov 06 2024 23:01:17 GMT-0800 (Pacific Standard Time)">07:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Then, for the fast path here, there's similar structure in functions with "Pure" suffix, for example <a href="https://searchfox.org/mozilla-central/rev/5b288ed276a9580f2bedd4f67543940667d6a8c0/js/src/vm/JSObject.cpp#1809">js::GetPropertyPure</a></td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Nov 06 2024 23:01:42 GMT-0800 (Pacific Standard Time)">07:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">It's a kind of GetProperty operation, but works only when there's no side effect</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Nov 06 2024 23:02:12 GMT-0800 (Pacific Standard Time)">07:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the caller is supposed to fallback to regular operation when there's possible side-effect</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Nov 06 2024 23:02:49 GMT-0800 (Pacific Standard Time)">07:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">So, the "Pure" suffix might fit here  (not yet sure if that's the best)</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Nov 06 2024 23:03:24 GMT-0800 (Pacific Standard Time)">07:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Then, if we go with "Fast" in the name, I think it should be suffix, to follow the existing "Slow" suffix rule</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Nov 06 2024 23:03:44 GMT-0800 (Pacific Standard Time)">07:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, "TryParseIntFast" for instance</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Nov 06 2024 23:05:40 GMT-0800 (Pacific Standard Time)">07:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">I like <code>TryParseIntFast</code>, however it can be confusing, that it returns <strong>true</strong> if it's possible to do fast track, <strong>false</strong> otherwise, but in <code>ParseIntSlow</code>** true** if we can parse the value, <strong>false</strong> otherwise.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Nov 06 2024 23:06:19 GMT-0800 (Pacific Standard Time)">07:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Yeah, I'm not sure if there's any existing function that follows "Fast" suffix with that return value semantics</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Nov 06 2024 23:06:48 GMT-0800 (Pacific Standard Time)">07:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(the "Pure" suffix function uses the return value semantics tho)</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Nov 06 2024 23:07:13 GMT-0800 (Pacific Standard Time)">07:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">other option would be to use <code>bool*</code> out parameter for "successfully taken the fast path or not"</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Nov 06 2024 23:08:58 GMT-0800 (Pacific Standard Time)">07:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">given the "TryParseIntFast" doesn't cause any runtime error, there's no need to track it, but it just need to return whether the fast path is taken or not.  so it can be <code>void TryParseIntFast(input, output, bool* result);</code> or something</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Wed Nov 06 2024 23:10:35 GMT-0800 (Pacific Standard Time)">07:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or, it can have a dedicate enum class as return value, so that it's clear the return value is not about pending exception</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Wed Nov 06 2024 23:28:39 GMT-0800 (Pacific Standard Time)">07:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Maybe we can use Maybe like in <a href="https://searchfox.org/mozilla-central/source/js/src/jit/ShuffleAnalysis.cpp#466-497">https://searchfox.org/mozilla-central/source/js/src/jit/ShuffleAnalysis.cpp#466-497</a></td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Wed Nov 06 2024 23:45:24 GMT-0800 (Pacific Standard Time)">07:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">However <a href="https://searchfox.org/mozilla-central/source/js/src/builtin/Object.cpp#1064-1142">here</a> we have function <code>TryAssignNative</code> returning <strong>bool</strong> value</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Wed Nov 06 2024 23:49:04 GMT-0800 (Pacific Standard Time)">07:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Yeah, the TryAssignNative's return value is about the pending exception.  and the <code>bool*</code> out parameter is for the result of "try"</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Wed Nov 06 2024 23:51:47 GMT-0800 (Pacific Standard Time)">07:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Maybe is for the case where <code>Nothing</code> is for a kind of failure, and the <code>Some</code> is for successful case with a value.  so I don't think that also fits, given there's only 2 cases for ParseInt fast path</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Wed Nov 06 2024 23:52:21 GMT-0800 (Pacific Standard Time)">07:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">I'll try to implement similar to TryAssignNative</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Thu Nov 07 2024 01:28:02 GMT-0800 (Pacific Standard Time)">09:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><pre><code>$ ./mach jstests
[46348|    0|    0| 5818] 100% ======================================&gt;| 205.9ss
PASS
</code></pre>
<pre><code>$ ./mach jit-test
[12293|    0|    0|  445] 100% ======================================&gt;| 172.0ss
PASSED ALL
</code></pre>
<pre><code>$ ./jsapi-tests.exe
&lt;...&gt;
Passed: ran 862 tests.
</code></pre>
<p>Also I send it to Phabricator (<a href="https://phabricator.services.mozilla.com/D228292">https://phabricator.services.mozilla.com/D228292</a>) and I will be thankful if you looked at it, arai</p>
</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Thu Nov 07 2024 06:58:42 GMT-0800 (Pacific Standard Time)">14:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">that makes perfect sense, thanks! </td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Thu Nov 07 2024 09:19:54 GMT-0800 (Pacific Standard Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">Is there a way to get <code>./mach jit-test</code> to show me the command that was invoked?  <code>./mach --verbose jit-test</code> doesn't seem to change anything.</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Thu Nov 07 2024 09:22:07 GMT-0800 (Pacific Standard Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">nevermind, it looks like it's <code>./mach jit-test -s basic/bug1875795.js</code></td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Thu Nov 07 2024 09:35:38 GMT-0800 (Pacific Standard Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mgaudet:mozilla.org">mgaudet|out</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: <a href="https://share.firefox.dev/48BJEpf">Here's the compare report</a> (I worry a bit about the fact that ArraySliceDense gets a new function name tho)</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Thu Nov 07 2024 09:53:57 GMT-0800 (Pacific Standard Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(And here's the microbenchmark: <a href="https://gist.github.com/mgaudet/8787576dd31b95a7d59ef1aabf971946">https://gist.github.com/mgaudet/8787576dd31b95a7d59ef1aabf971946</a>) </td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Thu Nov 07 2024 09:55:57 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: what is the size of the array slices in that benchmark?</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Thu Nov 07 2024 09:56:19 GMT-0800 (Pacific Standard Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">100 elements I think</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Thu Nov 07 2024 09:56:28 GMT-0800 (Pacific Standard Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(not sure what the original benchmark used) </td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Thu Nov 07 2024 09:57:14 GMT-0800 (Pacific Standard Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Oh, OK. </td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Thu Nov 07 2024 09:57:20 GMT-0800 (Pacific Standard Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Slices are randomly selected subslices of that</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Thu Nov 07 2024 09:58:28 GMT-0800 (Pacific Standard Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Like up to 100 elements?</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Thu Nov 07 2024 09:58:49 GMT-0800 (Pacific Standard Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I'm surprised to not see any malloc in the original profile if we are tenuring the slices</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Thu Nov 07 2024 09:59:44 GMT-0800 (Pacific Standard Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">(It looks like the JIT allocates a zero element array from a template object and calls into the VM to extend it as necessary and fill it with slice data)</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Thu Nov 07 2024 10:04:28 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">In the original one I guess because they're nursery allocated we're not using malloc -- just as you said in the meeting. (Or would you expect to see malloc, but called from tenuring?)</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Thu Nov 07 2024 10:05:04 GMT-0800 (Pacific Standard Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: Wrote up the size class feedback idea <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1929935">https://bugzilla.mozilla.org/show_bug.cgi?id=1929935</a> if we ever want to pull more on that string</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Thu Nov 07 2024 10:07:01 GMT-0800 (Pacific Standard Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">When we tenure the objects we would malloc the elements buffer if the elements couldn't fit inside an object</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Thu Nov 07 2024 10:09:44 GMT-0800 (Pacific Standard Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">But if it's small enough to fit in the object then we wouldn't? 

Sort of feeling like this is a twofold problem: 1) It's not clear that this optimization is helping in general (I can't really show any improvement on real world benchmarks) 2) Part of the problem is that this microbenchmark is showing off all the worst of this opt -- extra tenuring = slower allocation -and- slower slot allocation </td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Thu Nov 07 2024 10:12:33 GMT-0800 (Pacific Standard Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Yeah, it's defeating an optimisation built into tenuring where we try and move elements inline in the tenured object if we can</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Thu Nov 07 2024 10:12:36 GMT-0800 (Pacific Standard Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">In general, it sort of seems like this actually may end up being slightly counterproductive -- while we do want to reduce tenuring in general, if we're manipulating elements while the object is in the nursery, then pre-tenuring actually hurts us because it moves us off the fastpath of element allocation, even if we have to then pay a tenuring cost</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Thu Nov 07 2024 10:15:12 GMT-0800 (Pacific Standard Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">If we could make the JIT allocate sensible sized objects for the slices then I think it would help. But at the moment it seems counterproductive.</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Thu Nov 07 2024 10:19:02 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I'm not actually sure why we have the JIT allocate the slice object and and then call into the VM to populate it (CodeGenerator::visitArraySlice). It might be better to do this all in the VM and then you could allocate an appropriately sized object more easily</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Thu Nov 07 2024 10:20:12 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. That's a good point. </td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Thu Nov 07 2024 10:20:29 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Lemme play around a bit </td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Thu Nov 07 2024 10:42:28 GMT-0800 (Pacific Standard Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: I'm totally blanking. Can we just do direct call to a JSNative signature from JIT code with simple masm (e.g. <code>bool array_slice(JSContext* cx, unsigned argc, Value* vp)</code> )</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Thu Nov 07 2024 10:43:06 GMT-0800 (Pacific Standard Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: In a meeting, ping me again in a bit if I don't respond</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Thu Nov 07 2024 11:14:37 GMT-0800 (Pacific Standard Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: well the good news is that 100+ of these intermittents are all the same "random SIGTRAP happening on ARM64 MacOS". The bad news is I'm not sure why they happen..</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Thu Nov 07 2024 11:47:58 GMT-0800 (Pacific Standard Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: this might be totally irrelevant, but missing entitlements will cause a SIGTRAP when you try to use the feature that requires it.</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Thu Nov 07 2024 11:51:41 GMT-0800 (Pacific Standard Time)">19:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">hmm</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Thu Nov 07 2024 12:04:54 GMT-0800 (Pacific Standard Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">One would sort of expect those to be not intermittent? Right? </td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Thu Nov 07 2024 12:25:40 GMT-0800 (Pacific Standard Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: You can call a JSNative signature from jitcode, but it makes me suspect that you're doing something unnecessary. The JSNative signature is designed to be similar to the JS-to-JS calling convention so that eg baseline code doesn't have to care whether the array_slice implementation is native or scripted. If you have full control, why not just do a callWithABI / callVM? (Probably callVM in this case because you're allocating.)</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Thu Nov 07 2024 12:39:38 GMT-0800 (Pacific Standard Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">although these SIGTRAP intermittents are rare per-testcase, it seems that 50% of the <code>test-macosx1100-aarch64-shippable-qr/opt-jittest-1proc</code> runs fail for <em>some</em> test</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Thu Nov 07 2024 12:48:37 GMT-0800 (Pacific Standard Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yikes. </td></tr>

</tbody></table></div></div></div>
</body></html>