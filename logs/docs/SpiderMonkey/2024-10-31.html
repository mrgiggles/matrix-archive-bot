<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-10-31</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-10-31<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-10-30" class="nav-link"><span>prev</span></a>
<a href="2024-11-01" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Oct 30 2024 18:32:10 GMT-0700 (Pacific Daylight Time)">01:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dragonslayer:mozilla.org">dragonslayer</span>&gt;</div></td><td class="msg-cell"><p>can any one help me with this test sample code i made</p>
<p>So i keep getting a heap error with this code and cant understand why its doing that i know somethings need there own memory but any help with this test sample would benefit me alot .</p>
<pre><code>#define DEBUG
#include &lt;jsapi.h&gt;
#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;js/Initialization.h&gt;
#include &lt;js/Object.h&gt;
#include &lt;js/Warnings.h&gt;
#include &lt;js/CompilationAndEvaluation.h&gt;
#include &lt;js/SourceText.h&gt;

#include "js/CharacterEncoding.h"
#include "js/Conversions.h"

inline JSClass global_class = { "global", JSCLASS_GLOBAL_FLAGS, &amp;JS::DefaultGlobalClassOps };

class SpiderMonkeyEngine {
public:
  SpiderMonkeyEngine() {
    if (!JS_Init()) { throw std::runtime_error("Failed to initialize JS engine"); }

    cx = JS_NewContext(8192 * 1024); // 8MB stack
    if (!cx) { throw std::runtime_error("Failed to create JS context"); }

    JS::InitSelfHostedCode(cx);

    JS::RealmOptions options;
    auto newGlobal = JS_NewGlobalObject(cx, &amp;global_class, nullptr, JS::FireOnNewGlobalHook, options);
    if (!newGlobal) { throw std::runtime_error("Failed to create global object"); }

    global.init(cx, newGlobal);

    JSAutoRealm ar(cx, global);

    const char* script = "function hello(name) { return 'Hello, ' + name; }";
    JS::CompileOptions opts(cx);
    JS::SourceText&lt;mozilla::Utf8Unit&gt; srcBuf;
    if (!srcBuf.init(cx, script, strlen(script), JS::SourceOwnership::Borrowed)) { throw std::runtime_error("Failed to initialize source buffer"); }

    JS::RootedValue val(cx);
    JS::MutableHandleValue rval(&amp;val);

    if (!JS::Evaluate(cx, opts, srcBuf, rval)) { throw std::runtime_error("Failed to compile script"); }
  }

  ~SpiderMonkeyEngine() {
    JS_DestroyContext(cx);
    JS_ShutDown();
  }

  std::string callHello(const std::string&amp; name) {
    JSAutoRealm ar(cx, global);

    JS::RootedString jsStr(cx, JS_NewStringCopyZ(cx, name.c_str()));
    if (!jsStr) { throw std::runtime_error("Failed to create JS string"); }

    JS::RootedValue func(cx);
    if (!JS_GetProperty(cx, global, "hello", &amp;func) || !func.isObject() || !JS_ObjectIsFunction(&amp;func.toObject())) {
      throw std::runtime_error("Failed to get hello function");
    }

    JS::RootedValueArray&lt;1&gt; args(cx);
    args[0].setString(jsStr);

    JS::RootedValue val(cx);
    JS::MutableHandleValue rval(&amp;val);

    if (!JS_CallFunctionValue(cx, global, func, args, rval)) { throw std::runtime_error("Failed to call hello function"); }

    if (!rval.isString()) { throw std::runtime_error("Failed to get string back"); }
    //JS::RootedString resultStr(cx, rval.toString());
    JS::RootedString resultStr(cx, JS::ToString(cx, rval));
    /// UNCOMMENT THE NEXT LINE TO TRIGGER THE CRASH ON ROUTINE EXIT
    JS::UniqueChars resultCStr = JS_EncodeStringToUTF8(cx, resultStr);
    /// UNCOMMENT THE ABOVE LINE TO TRIGGER THE CRASH ON ROUTINE EXIT
    if (!resultCStr) {
      throw std::runtime_error("Failed to encode result string");
    }
    //
    std::string resultCppStr(resultCStr.get());
    return resultCppStr;
  }

protected:
  JSContext* cx;
  JS::PersistentRootedObject global;
};

int main() {
  try {
    SpiderMonkeyEngine engine;
    std::string result = engine.callHello("World");
    std::cout &lt;&lt; result &lt;&lt; std::endl;
  }
  catch (const std::exception&amp; e) {
    std::cerr &lt;&lt; e.what() &lt;&lt; std::endl;
    return 1;
  }

  return 0;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Oct 30 2024 19:33:17 GMT-0700 (Pacific Daylight Time)">02:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what's the details of the "heap error" ?  for example, you can run the program with debugger to see the stack trace and some other details.  also, if you're not using a debug build of SpiderMonkey, try using a debug build (--enable-debug), that enables debug assertions and it can catch something</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Oct 30 2024 19:34:41 GMT-0700 (Pacific Daylight Time)">02:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, we don't support the C++ "throw".  so it might break something</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Oct 30 2024 19:46:23 GMT-0700 (Pacific Daylight Time)">02:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">there should be a null check on the result of <code>JS::ToString</code> (<code>if (resultStr == nullptr)</code> would work), but the commented out <code>rval.toString()</code> should also work since you've already tested <code>isString()</code>.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Oct 30 2024 19:47:49 GMT-0700 (Pacific Daylight Time)">02:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I <em>think</em> throwing exceptions should be ok, as long as it never unwinds a JSAPI stack frame. But I don't know for sure; it could be that you have to compile with <code>-fno-exceptions</code> for anything to work.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Oct 30 2024 19:48:50 GMT-0700 (Pacific Daylight Time)">02:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I would expect what you have for the <code>MutableHandleValue</code> to work, but normally you wouldn't use the <code>rval</code> temporary. Just pass <code>&amp;val</code> into <code>JS_CallFunctionValue</code> directly.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Oct 30 2024 20:23:54 GMT-0700 (Pacific Daylight Time)">03:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the other option is to wrap the slot value on Gecko side with <a href="https://searchfox.org/mozilla-central/rev/53e8dfd81c32f1ab275516406ec06a68136aaef0/js/src/jsapi.h#156">JS_WrapValue</a> or <a href="https://searchfox.org/mozilla-central/rev/53e8dfd81c32f1ab275516406ec06a68136aaef0/js/src/jsapi.h#153-154">JS_WrapObject</a></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Oct 30 2024 20:25:32 GMT-0700 (Pacific Daylight Time)">03:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the SpiderMonkey side has wrap/unwrap for the passed HostDefined object, so the Gecko side can pass an object from any compartment</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Oct 30 2024 20:27:16 GMT-0700 (Pacific Daylight Time)">03:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the requirement here is that the object and its slot values should come from the same compartment.  the <code>JSAutoRealm</code> way makes the HostDefined object belongs to the global's compartment.   The JS_WrapValue way wraps the global object and set the CCW to the HostDefined object's slot</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Oct 30 2024 20:28:32 GMT-0700 (Pacific Daylight Time)">03:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">JSAutoRealm way can be easier, given that you don't have to unwrap the slot value when accessing it</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Oct 31 2024 02:32:00 GMT-0700 (Pacific Daylight Time)">09:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-4">jonco</span>: <span class="nick-10">yulia</span> you may have some opinion on <a href="https://github.com/whatwg/html/pull/10528">https://github.com/whatwg/html/pull/10528</a> (that seems to be in tomorrow's WHATNOT agenda)</blockquote></mx-reply>I was on PTO yesterday but I've looked at this this morning. The mechanics of the change look fine. I don't love that import map conflicts are ignored with only a warning but at least there is a warning now.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Oct 31 2024 03:07:09 GMT-0700 (Pacific Daylight Time)">10:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@canova:mozilla.org">canova</span>&gt;</div></td><td class="msg-cell">Yes, this code will not run if you disable the js feature in about:profiling</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Oct 31 2024 03:27:13 GMT-0700 (Pacific Daylight Time)">10:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: <span class="nick-4">jonco</span> is jit code somehow bound to a global or zone, or what keeps it alive?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Oct 31 2024 03:27:23 GMT-0700 (Pacific Daylight Time)">10:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(I've probably asked this before ðŸ™‚ )</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Oct 31 2024 03:29:04 GMT-0700 (Pacific Daylight Time)">10:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">if a JS function or script is alive we keep its JIT code alive, but we can also discard all JIT code in a Zone on GC based on some heuristics</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Oct 31 2024 03:30:52 GMT-0700 (Pacific Daylight Time)">10:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">we can't for example discard if the relevant global/realm is dying?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Oct 31 2024 03:31:47 GMT-0700 (Pacific Daylight Time)">10:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Also, did we have some statistic of how much jit code is in memory?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Oct 31 2024 03:34:04 GMT-0700 (Pacific Daylight Time)">10:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the global dying in the sense of it's not actually collected by the GC yet but the browser knows it's navigated away from? we talked about that before also for canceling off-thread Ion compilations. I have a local patch stack somewhere that makes JIT code discarding more of a per-realm thing instead of per-zone, that would help here</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Oct 31 2024 03:36:55 GMT-0700 (Pacific Daylight Time)">10:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">right, that thing. sp3, on this laptop, ends up creating and "destroying" 20 realms (used for subtests) between major GCs</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Oct 31 2024 03:38:01 GMT-0700 (Pacific Daylight Time)">10:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I'm not sure if we can discard the JIT code for such realms right away but we could at least cancel off-thread compilations at that point and be more aggressive about discarding JIT code for such realms</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Oct 31 2024 03:39:48 GMT-0700 (Pacific Daylight Time)">10:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">what is blocking us discarding, say when minorGC runs?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Oct 31 2024 03:42:03 GMT-0700 (Pacific Daylight Time)">10:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">discarding JIT code can be slow and we want minor GCs to be fast. We could add a "mark realm as dying" JSAPI and use that to cancel compilations and discard JIT code for that realm</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Oct 31 2024 03:43:32 GMT-0700 (Pacific Daylight Time)">10:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">one issue with that still is that there may be other realms that point to the dying one and that can include JIT guards</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Oct 31 2024 03:43:38 GMT-0700 (Pacific Daylight Time)">10:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">What if we found idle time after realm is likely dying (if course one can always access the content of an iframe even after removing it from the document, if one had reference) and tried to discard then?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Oct 31 2024 03:43:54 GMT-0700 (Pacific Daylight Time)">10:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">aha</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Oct 31 2024 03:44:00 GMT-0700 (Pacific Daylight Time)">10:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">What does a JIT guard mean?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Oct 31 2024 03:46:31 GMT-0700 (Pacific Daylight Time)">10:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">JIT ICs can for example have a pointer to a shape (which keeps its realm alive) that it uses for a shape guard. Baseline ICs use weak pointers for shapes and some other things now but we don't do that in Ion ICs yet IIRC</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Oct 31 2024 03:49:07 GMT-0700 (Pacific Daylight Time)">10:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">purging JIT code earlier for dying realms is probably a good idea but I don't know how much it will help. Maybe the gc can collect more garbage that way and will be a bit faster, but hard to say how much</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Oct 31 2024 08:02:29 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">Hey folks, if anyone could weigh in on this odd x86/x64 arch fingerprinting leak we would appreciate it! <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1928095">https://bugzilla.mozilla.org/show_bug.cgi?id=1928095</a></td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Oct 31 2024 08:23:46 GMT-0700 (Pacific Daylight Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">tjr</span>: This comment suggests this might be known and expected: <a href="https://searchfox.org/mozilla-central/source/js/public/Value.h#425-432">https://searchfox.org/mozilla-central/source/js/public/Value.h#425-432</a></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Oct 31 2024 08:24:30 GMT-0700 (Pacific Daylight Time)">15:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Writing up a comment. I think the key part of the JS spec is <a href="https://tc39.es/ecma262/#sec-numerictorawbytes">here</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Oct 31 2024 08:28:28 GMT-0700 (Pacific Daylight Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">oh I also commented on the bug</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Oct 31 2024 13:45:51 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. somehow <code>1.02 Â± 0.02 times faster</code> for this patch feels underwhelming.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Oct 31 2024 15:10:24 GMT-0700 (Pacific Daylight Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: It's probably not slower!</td></tr>

</tbody></table></div></div></div>
</body></html>