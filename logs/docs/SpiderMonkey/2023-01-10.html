<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-01-10</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-01-10<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-01-09" class="nav-link"><span>prev</span></a>
<a href="2023-01-11" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jan 09 2023 17:41:02 GMT-0800 (Pacific Standard Time)">01:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: have you looked at getting matrix-react-bench running in the v8 shell?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jan 09 2023 17:42:57 GMT-0800 (Pacific Standard Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">tcampbell</span>: have you looked at getting matrix-react-bench running in the v8 shell?</blockquote></mx-reply>I have not. Main problem was around flushing the microtask queue. That is probably easier on v8 shell since I think they have working setTimeout, but I never tried it. I think dthayer was also looking at cleaning up the test to run more than 1 iteration on jsshell too</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jan 09 2023 17:43:42 GMT-0800 (Pacific Standard Time)">01:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: yeah, that happened here: <a href="https://github.com/squarewave/matrix-react-bench/commits/main">https://github.com/squarewave/matrix-react-bench/commits/main</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jan 09 2023 17:48:09 GMT-0800 (Pacific Standard Time)">01:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: it looks like they have a setTimeout that just runs the function immediately</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jan 09 2023 17:48:36 GMT-0800 (Pacific Standard Time)">01:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">hmm</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jan 09 2023 17:51:44 GMT-0800 (Pacific Standard Time)">01:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: how do things get put in the microtask queue in the shell?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jan 09 2023 17:53:11 GMT-0800 (Pacific Standard Time)">01:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Promises are the main thing.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jan 09 2023 18:11:55 GMT-0800 (Pacific Standard Time)">02:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: looks like <code>%PerformMicrotaskCheckpoint()</code> is the V8 equivalent to <code>drainJobQueue()</code></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jan 10 2023 07:17:03 GMT-0800 (Pacific Standard Time)">15:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: <a href="https://github.com/jrmuizel/matrix-react-bench/tree/other-shells">https://github.com/jrmuizel/matrix-react-bench/tree/other-shells</a> adds support for v8 and not quite working support for JSC</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jan 10 2023 07:18:07 GMT-0800 (Pacific Standard Time)">15:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: were you able to just use <code>setTimeout</code> for it?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jan 10 2023 07:29:10 GMT-0800 (Pacific Standard Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: no, I used <code>%PerformMicrotaskCheckpoint()</code> in V8 and <code>drainMicrotasks</code> in JSC</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jan 10 2023 07:30:00 GMT-0800 (Pacific Standard Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">oh, I was in the wrong branch in github somehow</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jan 10 2023 07:30:35 GMT-0800 (Pacific Standard Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">cool. thanks for investigating that</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jan 10 2023 12:50:50 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: I guess you meant <a href="https://searchfox.org/mozilla-central/rev/a156a65ced2dae5913ae35a68e9445b8ee7ca457/modules/libpref/init/StaticPrefList.yaml#1883-1887">https://searchfox.org/mozilla-central/rev/a156a65ced2dae5913ae35a68e9445b8ee7ca457/modules/libpref/init/StaticPrefList.yaml#1883-1887</a></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jan 10 2023 12:52:45 GMT-0800 (Pacific Standard Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>:  yeah. here are the profiles: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1808824">https://bugzilla.mozilla.org/show_bug.cgi?id=1808824</a></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jan 10 2023 12:53:46 GMT-0800 (Pacific Standard Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">the initial-paint delay means we ignore vsync, and then we get spend 400ms processing JS before we look at vsync again</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jan 10 2023 13:03:29 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I guess I could do some try runs with different values. As I said in the bug, it is possible that speedindex regresses, if one paints too often</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jan 10 2023 13:03:44 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">react sites just tend to do too much stuff in rAF callbacks</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jan 10 2023 13:09:54 GMT-0800 (Pacific Standard Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">But all those prefs are really old. They were designed to optimize page load time over anything visual. Gecko would show the old page way longer and then once most of the new page was loaded, the new page was painted - or that was the idea, I think. (Didn't perhaps work too well always)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jan 10 2023 14:24:03 GMT-0800 (Pacific Standard Time)">22:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: FWIW, I pushed a tweak to the pref value to see how it affects page load metrics.  At some point I had added check which would yield if there was a pending vsync, but that didn't affect anything too much, so it was removed.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jan 10 2023 14:25:49 GMT-0800 (Pacific Standard Time)">22:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Your point about SpeedIndex makes sense. I tried to play with lowering it to 50ms and didn't see other pageload tests improve beyond the *gslides case</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jan 10 2023 14:27:54 GMT-0800 (Pacific Standard Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The whole mechanism seemed surprising to still exist after our focus on pageload, but since in practice it doesn't seem to directly have huge impact I can see why it remained untouched</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jan 10 2023 14:28:40 GMT-0800 (Pacific Standard Time)">22:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">well, some of that mechanism was removed in bug 1804295</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jan 10 2023 14:28:41 GMT-0800 (Pacific Standard Time)">22:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1804295">https://bugzil.la/1804295</a> — RESOLVED (smaug) — Remove the current use of favorPerformanceHint and change the mechanism to have a short burst of Gecko tasks over native tasks</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jan 10 2023 14:29:07 GMT-0800 (Pacific Standard Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">one just needs to go through the prefs one by one and hopefully not regress anything</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jan 10 2023 14:29:47 GMT-0800 (Pacific Standard Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Is the initial-paint.delay stuff still meaningful?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jan 10 2023 14:30:04 GMT-0800 (Pacific Standard Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Some comments seemed to suggest it was about css background flashing, but wouldn't we rather then target that directly over a timer</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jan 10 2023 14:31:07 GMT-0800 (Pacific Standard Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(I haven't looked in much depth to this script scheduling stuff before now, so I am definitely behind on a lot of the history)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jan 10 2023 14:33:16 GMT-0800 (Pacific Standard Time)">22:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">ah, that framerate-between-fcp-and-pageload thing is interesting</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Jan 10 2023 14:33:26 GMT-0800 (Pacific Standard Time)">22:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">paint suppression is tricky, also, it is just 5ms these days</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Jan 10 2023 14:33:32 GMT-0800 (Pacific Standard Time)">22:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">it used to be something like 200ms</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Jan 10 2023 14:34:14 GMT-0800 (Pacific Standard Time)">22:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">we do paint rather soon, we explicitly try to have refreshdriver up and running very early</td></tr>

</tbody></table></div></div></div>
</body></html>