<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-11-24</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-11-24<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-11-23" class="nav-link"><span>prev</span></a>
<a href="2022-11-25" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Nov 24 2022 12:38:26 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">How do I get around: <code>Rooted(const Rooted&amp;) = delete;</code>? Is it not possible to <code>std::move(JSAutoRealm/Js::RootedObject)</code>?<br>Making a wrapper for JsContext + global + JSAutoRealm that could be held in a <code>std::vector</code></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Nov 24 2022 13:14:47 GMT-0800 (Pacific Standard Time)">21:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: Rooted and AutoRealm have to live on the stack.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Nov 24 2022 13:15:14 GMT-0800 (Pacific Standard Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">are you not able to std::move them? I'm keeping them as class data members. But the class being copy constructed or move constructed is breaking it.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Nov 24 2022 13:16:17 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You shouldn't keep them as class data members, unless that class is also only stack-allocated</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Nov 24 2022 13:16:56 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Rooted in particular relies on the fact that instances are created/destroyed in LIFO order</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Nov 24 2022 13:17:20 GMT-0800 (Pacific Standard Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">It should be stack allocated, i'm using no pointers atm</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Nov 24 2022 13:17:43 GMT-0800 (Pacific Standard Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">copying/moving the wrapper breaks everything though</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Nov 24 2022 13:19:38 GMT-0800 (Pacific Standard Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you're putting them in a vector, then they're not on the stack</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Nov 24 2022 13:20:11 GMT-0800 (Pacific Standard Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And you're losing the guarantee that Rooted instances are destroyed in the reverse order of creation</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Nov 24 2022 13:20:21 GMT-0800 (Pacific Standard Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Ah right, i forgot ðŸ˜…</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Nov 24 2022 13:21:22 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">So would I utilize <code>JS::Heap&lt;T&gt;</code>?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Nov 24 2022 13:21:38 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I was told that <code>JS::PersistentRooted&lt;T&gt;</code> might be an option too</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Nov 24 2022 13:21:55 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You could consider RootedVector: <a href="https://searchfox.org/mozilla-central/source/js/public/GCVector.h#336-344">https://searchfox.org/mozilla-central/source/js/public/GCVector.h#336-344</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Nov 24 2022 13:22:19 GMT-0800 (Pacific Standard Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I mean I would like move/copy the Wrapper lets say</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Nov 24 2022 13:22:34 GMT-0800 (Pacific Standard Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Where the wrapper could be dynamically allocated</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Nov 24 2022 13:22:44 GMT-0800 (Pacific Standard Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Just to avoid future usecase headaches</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Nov 24 2022 13:23:49 GMT-0800 (Pacific Standard Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You can create a dynamically allocated class with <code>Heap&lt;T&gt;</code> pointers</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Nov 24 2022 13:24:08 GMT-0800 (Pacific Standard Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But you are responsible for making sure that instances of that class are traced by the GC</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Nov 24 2022 13:24:38 GMT-0800 (Pacific Standard Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I don't understand the different between <code>Heap&lt;T&gt;</code> and <code>PersistentRooted&lt;T&gt;</code> when Persistent says " for things that are alive until the process exits (or until you manually delete the PersistentRooted for a reason not based on GC finalization.)", doesn't that make it work just like a Heap?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Nov 24 2022 13:24:39 GMT-0800 (Pacific Standard Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So you have to write a <code>trace</code> method, and you need to store them somewhere the GC knows about</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Nov 24 2022 13:24:55 GMT-0800 (Pacific Standard Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Like a RootedVector</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Nov 24 2022 13:25:29 GMT-0800 (Pacific Standard Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I don't follow</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Nov 24 2022 13:26:28 GMT-0800 (Pacific Standard Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Say you have an object containing a pointer to a JSObject.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Nov 24 2022 13:27:05 GMT-0800 (Pacific Standard Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">When a GC is triggered, the garbage collector will clean up any objects that aren't reachable, and potentially move existing objects to a new location.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Nov 24 2022 13:27:17 GMT-0800 (Pacific Standard Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If the GC doesn't know about your object, then your pointer could be invalidated.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Nov 24 2022 13:28:19 GMT-0800 (Pacific Standard Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Step 1 of telling the GC about your object is using <code>Heap&lt;T&gt;</code>. This is a helper class that implements some bookkeeping that the GC needs to do when you write to that pointer.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Nov 24 2022 13:29:09 GMT-0800 (Pacific Standard Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Step 2 of telling the GC about your object is writing a <code>trace</code> method. This lets the GC know which garbage-collected things are reachable via your object.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Nov 24 2022 13:29:55 GMT-0800 (Pacific Standard Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Step 3 is making sure that the GC knows to trace your object in the first place. This is accomplished by making sure there is <em>some</em> path from a GC root to your object.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Nov 24 2022 13:31:19 GMT-0800 (Pacific Standard Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I'm not binding the Wrapper to JavaScript, i.e. it should not be reachable inside the JavaScript. I'm just creating some Wrapper manager class for holding JSContext, global, and JSAutoRealm together</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Nov 24 2022 13:31:48 GMT-0800 (Pacific Standard Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The thing you might be missing is that <code>Heap&lt;T&gt;</code> only keeps an object alive if the owner of the <code>Heap&lt;T&gt;</code> is reachable (aka traced by the GC)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Nov 24 2022 13:32:03 GMT-0800 (Pacific Standard Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">right</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Nov 24 2022 13:32:12 GMT-0800 (Pacific Standard Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I'm still reading up on tracing atm trying to understand it better</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Nov 24 2022 13:32:24 GMT-0800 (Pacific Standard Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">but it seems like it's meant for classes that you bind to JavaScript?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Nov 24 2022 13:32:48 GMT-0800 (Pacific Standard Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Also you almost certainly don't want to be storing a JSAutoRealm. You want a realm, and then to enter it when needed using a stack-allocated AutoRealm.)</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Nov 24 2022 13:33:05 GMT-0800 (Pacific Standard Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Tracing is used to figure out which objects are alive and which objects are dead.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Nov 24 2022 13:34:19 GMT-0800 (Pacific Standard Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Note that it's possible for there to be cycles between regular C++ objects (with <code>Heap&lt;T&gt;</code> members) and GC-managed JSObjects. If such a cycle isn't reachable from outside, then we want to clean it up.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Nov 24 2022 13:35:32 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">An example from code I'm currently working on: here's a C++ class, NativeIterator, that contains a pointer to a JSObject: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Iteration.h#27">https://searchfox.org/mozilla-central/source/js/src/vm/Iteration.h#27</a></td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Nov 24 2022 13:35:54 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(For current purposes, you can think of GCPtr&lt;T&gt; as a SM-internal version of Heap&lt;T&gt;)</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Nov 24 2022 13:36:22 GMT-0800 (Pacific Standard Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That pointer points to a PropertyIteratorObject: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Iteration.h#411">https://searchfox.org/mozilla-central/source/js/src/vm/Iteration.h#411</a></td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Nov 24 2022 13:36:50 GMT-0800 (Pacific Standard Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Inside that PropertyIteratorObject, we store a pointer back to the NativeIterator.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Nov 24 2022 13:37:34 GMT-0800 (Pacific Standard Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This kind of wrapper pattern isn't the only way to have cycles, but it's probably the simplest one</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Nov 24 2022 13:38:06 GMT-0800 (Pacific Standard Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">When the GC runs, if nothing holds a reference to the PropertyIteratorObject, we want to clean it up</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Nov 24 2022 13:39:30 GMT-0800 (Pacific Standard Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But if we keep everything alive that has a <code>Heap&lt;T&gt;</code> (or a <code>GCPtr&lt;T&gt;</code> in this case) pointing to it, then we'll never be able to delete the PropertyIteratorObject</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Nov 24 2022 13:40:15 GMT-0800 (Pacific Standard Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So when the GC traces the object graph to figure out what is alive, it needs to be able to trace through regular C++ objects</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Nov 24 2022 13:41:57 GMT-0800 (Pacific Standard Time)">21:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If neither object is reachable, then the PropertyIteratorObject will not be marked as alive, and then when we sweep the heap, we'll delete it. When we do so, its <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Iteration.cpp#1205-1210">finalizer</a> will run and delete the NativeIterator</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Nov 24 2022 13:42:51 GMT-0800 (Pacific Standard Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I'm confused on how finalize and trace gets even ran. Aren't you supposed to bind the class?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Nov 24 2022 13:43:40 GMT-0800 (Pacific Standard Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't know what you mean by "bind" here</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Nov 24 2022 13:44:08 GMT-0800 (Pacific Standard Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">like you're supposed to call some SM API function on your class and it exposes your class to JavaScript I assume?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Nov 24 2022 13:44:19 GMT-0800 (Pacific Standard Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Which I don't want to expose the class to JavaScript</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Nov 24 2022 13:44:51 GMT-0800 (Pacific Standard Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">A class can require tracing without being exposed to JS</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Nov 24 2022 13:45:55 GMT-0800 (Pacific Standard Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The GC manages memory. When we need to free some memory, we trigger a garbage collection, and we get rid of the objects we no longer need.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Nov 24 2022 13:46:02 GMT-0800 (Pacific Standard Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">How do we know which objects we still need?</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Nov 24 2022 13:46:14 GMT-0800 (Pacific Standard Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Well, we start with the objects that are directly reachable.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Nov 24 2022 13:46:29 GMT-0800 (Pacific Standard Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That generally means things that are currently stored somewhere on the stack</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Nov 24 2022 13:46:34 GMT-0800 (Pacific Standard Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That's what <code>Rooted&lt;T&gt;</code> is for</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Nov 24 2022 13:47:02 GMT-0800 (Pacific Standard Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><code>PersistentRooted</code> is another form of roots.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Nov 24 2022 13:47:20 GMT-0800 (Pacific Standard Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Then, we trace all the pointers leaving those objects to figure out which objects are reachable from a root</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Nov 24 2022 13:47:21 GMT-0800 (Pacific Standard Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>ok after re-reading again, i'm confused how step 3 is achieved</p>
<blockquote>
<p>Step 3 is making sure that the GC knows to trace your object in the first place. This is accomplished by making sure there is some path from a GC root to your object.</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Nov 24 2022 13:49:36 GMT-0800 (Pacific Standard Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Either you stick your object in a Rooted (or RootedVec, or PersistentRooted, or some other equivalent container), or you stick it in some other object that will trace it recursively</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Nov 24 2022 13:50:05 GMT-0800 (Pacific Standard Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Oh boy, that's another rabbit hole of wrappers</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Nov 24 2022 13:53:16 GMT-0800 (Pacific Standard Time)">21:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Thanks for the help iain, i'll have to play around with this code some more</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Nov 24 2022 13:57:05 GMT-0800 (Pacific Standard Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The "easiest" way to handle this is probably to have a class that holds the data you care about, and implement a trace method on that class, then use PersistentRooted to store a pointer to that class. The massive footgun here is that you need to be very careful with the ownership of the PersistentRooted. None of the data that is reachable from a persistent-rooted instance of your class can be freed as long as the PersistentRooted exists, so if you ever end up with a cycle where the PersistentRooted owns itself, it will never be freed and you'll leak a bunch of memory.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Nov 24 2022 13:58:04 GMT-0800 (Pacific Standard Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you can guarantee that won't happen, then PersistentRooted might be the way to go</td></tr>

</tbody></table></div></div></div>
</body></html>