<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-01-11</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-01-11<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-01-10" class="nav-link"><span>prev</span></a>
<a href="2022-01-12" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jan 11 2022 00:27:23 GMT-0800 (Pacific Standard Time)">08:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> and yet, there are things like bug 1700585. I was under the impression that we were no longer supporting building with MSVC, but we were still trying to maintain header compatibility with MSVC so you could compile with MSVC and link with a clang-built library. But I could be wrong.</blockquote></mx-reply>As far as I understand, clang on windows tries to be ABI-compatible with MSVC</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jan 11 2022 00:27:40 GMT-0800 (Pacific Standard Time)">08:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">So header-compatibility with MSVC-compiled projects seems easily attainable if you mostly target C++ standards compatibility</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jan 11 2022 00:32:57 GMT-0800 (Pacific Standard Time)">08:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">There is still some code for the <code>--with-visual-studio-version</code> option, but I'm not certain that does anything following 1512504</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jan 11 2022 00:46:50 GMT-0800 (Pacific Standard Time)">08:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Think I found why: it appears MSVC17 doesn't like the default member initialiser in JS::Error <a href="https://godbolt.org/z/PKrxWxoKf">https://godbolt.org/z/PKrxWxoKf</a></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jan 11 2022 00:47:25 GMT-0800 (Pacific Standard Time)">08:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">This appears to be a MSVC-specific issue and also one that's fixed by VS2019.27 (though I can't find much online about it)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jan 11 2022 00:55:13 GMT-0800 (Pacific Standard Time)">08:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">mmh, in fact it seems weird that the LowbitTagIsError code checks for trivially copyable/destructuble but SelectResultImpl doesn't</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jan 11 2022 00:56:02 GMT-0800 (Pacific Standard Time)">08:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Especially given that JS::Error specialises UnusedZero, suggesting this was intended to be used</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jan 11 2022 00:56:20 GMT-0800 (Pacific Standard Time)">08:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I would call the diff in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1665927">https://bugzilla.mozilla.org/show_bug.cgi?id=1665927</a> potentially problematic</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jan 11 2022 02:03:51 GMT-0800 (Pacific Standard Time)">10:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">mmh, no, the above analysis is wrong, the LSB should be available</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jan 11 2022 02:22:31 GMT-0800 (Pacific Standard Time)">10:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I'm pretty sure we can get away with just removing the std::is_trivially_copyable check</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jan 11 2022 02:24:01 GMT-0800 (Pacific Standard Time)">10:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">since the type is memcpy-able regardless of what the compiler thinks of its trivial-copyability</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jan 11 2022 02:59:03 GMT-0800 (Pacific Standard Time)">10:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Maybe this code should be rewritten such that assertion are no different than the filtering conditions …</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jan 11 2022 03:01:29 GMT-0800 (Pacific Standard Time)">11:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><p>such as:</p>
<pre><code class="language-c++">template &lt;typename V, typename E&gt;
class Conditional&lt;V, E, PackingStrategy::LowBitTagIsError&gt; { const bool value = …; };
</code></pre>
</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jan 11 2022 03:04:43 GMT-0800 (Pacific Standard Time)">11:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">This wouldn't actually solve the VS2017 issue which is definitely just a compiler bug, but yes there seems to be some opportunity for some slightly tyding</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jan 11 2022 03:05:00 GMT-0800 (Pacific Standard Time)">11:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Anyways stan managed to compile &amp; run by just removing the failing static_assert, which I think is what we'll go for at the moment</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jan 11 2022 03:06:41 GMT-0800 (Pacific Standard Time)">11:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I am responsible for adding this code, to select the best packing strategy. This is my way to push more meta programmation in Firefox code base. :P</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jan 11 2022 05:37:26 GMT-0800 (Pacific Standard Time)">13:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@stan:mozilla.org">stan</span>&gt;</div></td><td class="msg-cell">Well at least now it works. I was hoping for more perf improvements with Warp, but it seems it doesn't apply in our case</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jan 11 2022 05:50:13 GMT-0800 (Pacific Standard Time)">13:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Well at least now it works. I was hoping for more perf improvements with Warp, but it seems it doesn't apply in our case</blockquote></mx-reply>Yeah as it turned out, my 2x performance improvement was from compiling for native ARM, not spider monkey itself...</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jan 11 2022 06:00:23 GMT-0800 (Pacific Standard Time)">14:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Warp should provide stable improvement over what IonMonkey did with Type Inference. With a lot of effort from <span class="nick-4">iain</span> to tackle all sources of recompilations which would yield to identical recompilations.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jan 11 2022 07:23:36 GMT-0800 (Pacific Standard Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">OK so this was our bit of fun: We're sticking with ESR78 for embedding for now, but it looks like the new regexp code breaks without calling InitDefaultStackAllocation.  In JS78 InitDefaultStackAllocation never gets called during context initialization, and regex call fail in JIT as a result.

That's apparently fixed in whatever the current ESR version is according to SMDOC.
</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jan 11 2022 07:24:46 GMT-0800 (Pacific Standard Time)">15:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">By the way we're using the TypeScript compiler in a SpiderMonkey embed app, and got that to work.  I had to double the memory size for the interpreter to get it to work ;-)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jan 11 2022 07:25:49 GMT-0800 (Pacific Standard Time)">15:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, just realized that <code>JS_SetNativeStackQuota</code> needs to be explicitly called on ESR78</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jan 11 2022 07:26:32 GMT-0800 (Pacific Standard Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's changed in 91 (bug 1716324)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jan 11 2022 07:26:34 GMT-0800 (Pacific Standard Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1716324">https://bugzil.la/1716324</a> — RESOLVED (jandem) — Call JS_SetNativeStackQuota when creating the JSContext</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jan 11 2022 07:30:37 GMT-0800 (Pacific Standard Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">We can't go to a newer SpiderMonkey version in the near term, are there any other ESR78 gotchas we should look out for?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jan 11 2022 07:31:58 GMT-0800 (Pacific Standard Time)">15:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">It seems to work in our testing - modulo the regexp thing - it even runs the TypeScript compiler.  But it would be good to know if there's anything else to watch out for, without trying to go through bugziilla looking for gotchas.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jan 11 2022 07:32:54 GMT-0800 (Pacific Standard Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm not aware of any.  if you hit any issue, feel free to ask here</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jan 11 2022 07:45:03 GMT-0800 (Pacific Standard Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">Thanks</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jan 11 2022 07:45:20 GMT-0800 (Pacific Standard Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">maybe the JS78 embedding example needs that added!</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Jan 11 2022 07:52:34 GMT-0800 (Pacific Standard Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I have decided to switch to wrapping <code>RootedGuard&lt;*mut JSObject&gt;</code> (which itself wraps <code>Rooted&lt;*mut JSObject&gt;</code>) instead of wrapping <code>*mut JSObject</code> directly</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Jan 11 2022 10:19:34 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I know we can trigger uncatchable exceptions with the debugger API -- how else can they get generated? </td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Jan 11 2022 10:21:41 GMT-0800 (Pacific Standard Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">IIRC, slow script interrupts trigger uncatchable exceptions</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Jan 11 2022 10:22:23 GMT-0800 (Pacific Standard Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Ooh that's a good suggestion too. ( <span class="nick-1">krosylight</span> perhaps relevant to your try server issues )</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Jan 11 2022 10:23:08 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Oh wow, thanks! My old mystery is now solved</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Jan 11 2022 14:43:09 GMT-0800 (Pacific Standard Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">confession: Putting ReadableStreams and Cu.nukeSandbox in a blender, and coming up with a whole bunch of hangs... forward progress in the web in the face of cross-origin stuff????</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Jan 11 2022 14:43:11 GMT-0800 (Pacific Standard Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>

</tbody></table></div></div></div>
</body></html>