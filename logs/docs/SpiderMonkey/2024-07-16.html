<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-07-16</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-07-16<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-07-15" class="nav-link"><span>prev</span></a>
<a href="2024-07-17" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jul 15 2024 17:19:37 GMT-0700 (Pacific Daylight Time)">00:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">I was wondering if anyone here had had a chance to revisit the collapsed <a href="https://github.com/tc39/proposal-temporal/issues/2857">valueOf</a> and <a href="https://github.com/tc39/proposal-temporal/issues/2858">toJSON</a> methods for Temporal objects that were proposed in the June TC39. at the time, we discussed that Mozilla would like to investigate these further before giving a definite yes or no</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jul 15 2024 18:46:03 GMT-0700 (Pacific Daylight Time)">01:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">great! I'll look into utilizing it</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jul 16 2024 00:13:47 GMT-0700 (Pacific Daylight Time)">07:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">anba</span>: ^</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jul 16 2024 00:26:55 GMT-0700 (Pacific Daylight Time)">07:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@pbone:mozilla.org">pbone (he/him)</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-4">jonco</span>: I know that SpiderMonkey uses 3 different jemalloc arenas <a href="https://searchfox.org/mozilla-central/source/js/src/util/Utility.cpp#103-109">https://searchfox.org/mozilla-central/source/js/src/util/Utility.cpp#103-109</a></p>
<p>Is it for performance (to keep objects accessed together located together, or accessed on different threads from trying to lock the same arena)?  Or is it for security?</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jul 16 2024 01:05:55 GMT-0700 (Pacific Daylight Time)">08:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">pbone (he/him)</span>: Array buffer contents and string buffer contents use separate jemalloc arenas to the main one for security reasons (I don't know how important it is to keep these separate from each other).</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jul 16 2024 01:06:37 GMT-0700 (Pacific Daylight Time)">08:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@pbone:mozilla.org">pbone (he/him)</span>&gt;</div></td><td class="msg-cell">Okay that's fine.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jul 16 2024 01:07:09 GMT-0700 (Pacific Daylight Time)">08:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@pbone:mozilla.org">pbone (he/him)</span>&gt;</div></td><td class="msg-cell">I was considering adding a different API for performance cases (I've been talking to WebRender folk) and wondered if you'd be interested too.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jul 16 2024 01:07:58 GMT-0700 (Pacific Daylight Time)">08:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@pbone:mozilla.org">pbone (he/him)</span>&gt;</div></td><td class="msg-cell">If you allocate on one thread and free on a different one then they contend for the same locks. but if you switch arenas, especially if you pass data from one thread to the other, then they won't contend.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jul 16 2024 01:13:14 GMT-0700 (Pacific Daylight Time)">08:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Our strategy for the GC is going to be to move away from using jemalloc for allocation as much as possible (partly for these reasons).</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jul 16 2024 01:25:14 GMT-0700 (Pacific Daylight Time)">08:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@pbone:mozilla.org">pbone (he/him)</span>&gt;</div></td><td class="msg-cell">Oh. That'll be good.  Your sweeping code could be much faster/better/simplier without needing to free jemalloc things.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jul 16 2024 01:25:47 GMT-0700 (Pacific Daylight Time)">08:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@pbone:mozilla.org">pbone (he/him)</span>&gt;</div></td><td class="msg-cell">FWIW I am working on a change to move some of the slower jemalloc operations outside its lock.
</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jul 16 2024 01:39:00 GMT-0700 (Pacific Daylight Time)">08:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">That sounds like it would be a big improvement</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jul 16 2024 03:13:15 GMT-0700 (Pacific Daylight Time)">10:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">is that fixed with <a href="https://phabricator.services.mozilla.com/D216564">https://phabricator.services.mozilla.com/D216564</a> ?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jul 16 2024 03:17:20 GMT-0700 (Pacific Daylight Time)">10:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1848884">https://bugzilla.mozilla.org/show_bug.cgi?id=1848884</a> <span class="nick-12">sfink</span>, <span class="nick-10">jandem</span>: What happened? Should we drop the review? Has this work fallen into Monkey pit?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jul 16 2024 04:07:29 GMT-0700 (Pacific Daylight Time)">11:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">is setTimeout not available in the js shell? if run <code>setTimeout(() =&gt; { console.log("test.js"); }, 1000)</code> it shows reference error</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jul 16 2024 04:09:26 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">Correct</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jul 16 2024 04:11:23 GMT-0700 (Pacific Daylight Time)">11:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">:-(</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jul 16 2024 04:11:35 GMT-0700 (Pacific Daylight Time)">11:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">What do you want to do with timeout?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jul 16 2024 04:12:00 GMT-0700 (Pacific Daylight Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">but i see a few jit-tests with setTimeout <a href="https://searchfox.org/mozilla-central/source/js/src/jit-test/tests/basic/testNestedEscapingLambdas.js">https://searchfox.org/mozilla-central/source/js/src/jit-test/tests/basic/testNestedEscapingLambdas.js</a> for example here</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jul 16 2024 04:12:22 GMT-0700 (Pacific Daylight Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> What do you want to do with timeout?</blockquote></mx-reply>basically i was trying to think of a test to verify if a promise was awaited or not</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jul 16 2024 04:12:30 GMT-0700 (Pacific Daylight Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the above defines its own <code>setTimeout</code> function</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jul 16 2024 04:12:52 GMT-0700 (Pacific Daylight Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> basically i was trying to think of a test to verify if a promise was awaited or not</blockquote></mx-reply>so trying things out nothing concrete yet</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jul 16 2024 04:13:07 GMT-0700 (Pacific Daylight Time)">11:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> but i see a few jit-tests with setTimeout <a href="https://searchfox.org/mozilla-central/source/js/src/jit-test/tests/basic/testNestedEscapingLambdas.js">https://searchfox.org/mozilla-central/source/js/src/jit-test/tests/basic/testNestedEscapingLambdas.js</a> for example here</blockquote></mx-reply>err my bad i should look properly 😅</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jul 16 2024 04:13:48 GMT-0700 (Pacific Daylight Time)">11:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">usually, relying on timeout inside testcase isn't good, given it can behave differently depending on how fast/slow the execution is</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jul 16 2024 04:15:10 GMT-0700 (Pacific Daylight Time)">11:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the test wants to wait for promise resolution/rejection, just waiting for them is better</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jul 16 2024 04:15:48 GMT-0700 (Pacific Daylight Time)">11:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the test wants to verify "something doesn't happen asynchronously", it's slightly difficult, and the solution would depend on each case</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jul 16 2024 05:43:15 GMT-0700 (Pacific Daylight Time)">12:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, it looks like <code>Wrapped</code> is almost transparent type on <code>JSObject*</code>, with the unwrap operations. then, it doesn't touch the current realm (AutoRealm etc), and also apparently there's no realm handling inside temporal code (other than wrap and unwrap).  I assume, this is because no allocation happens with non-null Wrapped variables around?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jul 16 2024 07:53:27 GMT-0700 (Pacific Daylight Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: Review ping for <a href="https://github.com/mozilla-spidermonkey/spidermonkey.dev/pull/180">https://github.com/mozilla-spidermonkey/spidermonkey.dev/pull/180</a></td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jul 16 2024 07:58:15 GMT-0700 (Pacific Daylight Time)">14:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: oops, done. Thanks for doing this</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Jul 16 2024 07:58:38 GMT-0700 (Pacific Daylight Time)">14:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">You're welcome :) I'll do a force push to update the date before landing </td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Jul 16 2024 08:54:36 GMT-0700 (Pacific Daylight Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Anyone know how to find the build actions for spidermonkey.def these days? I just landed the newsletter... but the site hasn't been updated, and I can't figure out if maybe the build failed? </td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Jul 16 2024 08:56:35 GMT-0700 (Pacific Daylight Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">... like the deploy preview was/is fine: <a href="https://deploy-preview-180--spidermonkey-dev.netlify.app/">https://deploy-preview-180--spidermonkey-dev.netlify.app/</a> </td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Jul 16 2024 10:08:35 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">When did we switch to v8's regexp engine? Because I've got 3 bugs from 10 years ago which are mentioning irregexp 🤔
Did we change multiple times?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Jul 16 2024 10:08:53 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> When did we switch to v8's regexp engine? Because I've got 3 bugs from 10 years ago which are mentioning irregexp 🤔<br>Did we change multiple times?</blockquote></mx-reply>yes</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Jul 16 2024 10:09:42 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Maybe this was the bug that switched it? <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1634135">https://bugzilla.mozilla.org/show_bug.cgi?id=1634135</a></td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Jul 16 2024 10:26:53 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We switched from yarr to irregexp in 2014, and then from our own private copy of irregexp to an approach that keeps up to date with upstream in 2020. (I wrote <a href="https://hacks.mozilla.org/2020/06/a-new-regexp-engine-in-spidermonkey/">this blogpost</a> at the time)</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Jul 16 2024 10:55:19 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1848884">https://bugzilla.mozilla.org/show_bug.cgi?id=1848884</a> <span class="nick-12">sfink</span>, <span class="nick-10">jandem</span>: What happened? Should we drop the review? Has this work fallen into Monkey pit?</blockquote></mx-reply>For the overall thing, the perf changes were basically zero. I still wanted to land some of the refactoring patches, but never got review of the base patch in the stack. At this point, I will very probably need to redo that patch. I'll mark it as changes-needed or whatever it's called for now.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Jul 16 2024 12:57:21 GMT-0700 (Pacific Daylight Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Alright: Newsletter is now up! <a href="https://spidermonkey.dev/blog/2024/07/16/newsletter-firefox-128-129.html">https://spidermonkey.dev/blog/2024/07/16/newsletter-firefox-128-129.html</a> Thanks to the GitHub admins for unblocking us </td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Jul 16 2024 13:03:59 GMT-0700 (Pacific Daylight Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">also... bulk deallocation is nice in theory, but man do I wish we had a static analyzer to suggest that "hey, you've added a thing with a non-trivial destructor to a class which is bulk-deallocated on at least some paths... perhaps you... shouldn't" </td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Jul 16 2024 13:04:45 GMT-0700 (Pacific Daylight Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">mysterious. bug 1903037 causes thousands of hazards locally, and I can't see why it isn't happening in CI too.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Jul 16 2024 13:04:46 GMT-0700 (Pacific Daylight Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1903037">https://bugzil.la/1903037</a> — RESOLVED (jandem) — Replace DOMStringExternalString with JS strings using StringBuffer directly</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Jul 16 2024 13:04:54 GMT-0700 (Pacific Daylight Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(AKA, I just got backed out because MIRGenerator gets allocated in a lifoalloc)</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Jul 16 2024 13:05:06 GMT-0700 (Pacific Daylight Time)">20:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">pondering... just fix it? Or spend the time to figure it out too.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Jul 16 2024 13:05:30 GMT-0700 (Pacific Daylight Time)">20:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">The hazards... thousands of them, are real? </td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Jul 16 2024 13:05:55 GMT-0700 (Pacific Daylight Time)">20:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(Probably should know why it didnt break in CI) </td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Jul 16 2024 13:25:37 GMT-0700 (Pacific Daylight Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">real genuine false positives</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Jul 16 2024 13:26:23 GMT-0700 (Pacific Daylight Time)">20:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(two calls through function pointers were added, but they'll only be set to simple things that won't GC)</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Jul 16 2024 13:27:18 GMT-0700 (Pacific Daylight Time)">20:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">huh... definitely not happy that it didn't trigger on CI </td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Jul 16 2024 13:28:13 GMT-0700 (Pacific Daylight Time)">20:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it's gated on an <code>#ifdef</code> that is probably <code>#undef</code> on CI. I just don't know why. (Or perhaps why it's defined locally?)</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Jul 16 2024 13:33:31 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it's looking like it only happens on the older version I had checked out. The code and annotations haven't changed since then. Something else must have changed that affected the <code>#ifdef</code>. I'm not feeling that motivated to figure it out, given that it both works on the current head and I'll be landing a fix (in case someone does something that enables the <code>#ifdef</code>.)</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Jul 16 2024 13:33:49 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">fair enough :) </td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Jul 16 2024 13:34:15 GMT-0700 (Pacific Daylight Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">now I have to figure out what to do about a lifoalloc'd data structure that actually does need cleanup --- </td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Jul 16 2024 13:37:28 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I was idly pondering how hard it would be to make the hazard analysis implement that check. The easy part is (1) add a check for a non-trivial destructor and annotate the type, and (2) find placement new calls for that type. The hard part is (3) figure out whether the memory came from a bulk allocator.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Jul 16 2024 13:37:53 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess if we're ok with annotating all placement new calls, that could be faked with an annotation.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Jul 16 2024 13:38:15 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Honestly I'd take it as a taint; i.e. if you -ever- allocate a type via LifoAlloc, then you get the error</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Jul 16 2024 13:39:33 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">how do you detect "allocating a type via LifoAlloc", though?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Jul 16 2024 13:40:22 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>but this also feels amenable to the mfbt/Attributes + Clang Plugin; something along the lines of an annotation <code>MOZ_NO_NON_TRIVIAL_DESTRUCTOR</code> -- though, what counts as non-trivial is perhaps the semantic problem here; <code>mozilla::Vector</code> not having its destructor called (even if it requires a free nominally) is fine so long as the contents were allocated in the same lifo alloc.</p>
<p>Oh. Actually. Maybe that's my fix. I put my unique ptrs into the lifo alloc</p>
</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Jul 16 2024 13:41:28 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah, I see. <code>LifoAlloc::newWithSize</code></td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Jul 16 2024 13:41:51 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">wouldn't that just be the existence of a <code>LifoAlloc::new_</code> template expansion</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Jul 16 2024 13:42:28 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, I didn't realize that's how it was done as opposed to allocating a <code>void*</code> and placement new'ing into it.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Jul 16 2024 13:42:55 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so it does seem like it could be done as a local analysis, for which clang plugin is better</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Jul 16 2024 13:45:33 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(I think the sound way to do this would be to require everything stored in a destructor-free class to be annotated, but it'd be a bit noisy) </td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Jul 16 2024 13:56:27 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">-sigh- 

Fixing this is going to be a pain. </td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Jul 16 2024 13:57:05 GMT-0700 (Pacific Daylight Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Either horrible shortcuts, or a heck of a lot of infrastructure code, or a total rethinking. 

Gonna... think for a whiel</td></tr>

</tbody></table></div></div></div>
</body></html>