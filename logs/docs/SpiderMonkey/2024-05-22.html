<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-05-22</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-05-22<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-05-21" class="nav-link"><span>prev</span></a>
<a href="2024-05-23" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed May 22 2024 06:14:25 GMT-0700 (Pacific Daylight Time)">13:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Thanks <span class="nick-4">jonco</span> and <span class="nick-12">sfink</span> for looking at the indexeddb thing.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed May 22 2024 06:34:41 GMT-0700 (Pacific Daylight Time)">13:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Thanks <span class="nick-4">jonco</span> and <span class="nick-12">sfink</span> for looking at the indexeddb thing.</blockquote></mx-reply>np, thanks for bringing it to my (our) attention</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed May 22 2024 07:33:04 GMT-0700 (Pacific Daylight Time)">14:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">We introduced a NativeObject, <code>RawJSONObject</code>, with our implementation of the <em>JSON.parse with source</em> proposal, but I'm not sure if we usually handle CrossCompartmentWrappers transparently for such objects. Specifically, we have <code>JSON.isRawJSON()</code> which returns true if its argument is a <code>RawJSONObject</code>; should it also return true if its argument is a CCW around a <code>RawJSONObject</code>? To say it another way, should it unwrap its argument before deciding what to return?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed May 22 2024 07:35:34 GMT-0700 (Pacific Daylight Time)">14:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it should</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed May 22 2024 07:37:56 GMT-0700 (Pacific Daylight Time)">14:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">CCW itself shouldn't be visible to JS, and the <code>isRawJSON</code>'s algorithm which checks <code>[[IsRawJSON]]</code> internal slot isn't dependent to the current or target object realm</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed May 22 2024 07:42:28 GMT-0700 (Pacific Daylight Time)">14:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Thanks!</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed May 22 2024 07:42:30 GMT-0700 (Pacific Daylight Time)">14:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">on the other hand, if the algorithm was "return whether the object's constructor equals to the current realm's some constructor", then the function may return different value between CCW vs non-CCW</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed May 22 2024 07:45:56 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">similar case is <code>obj instanceof Foo</code> which is dependent to the <code>obj</code>'s realm and <code>Foo</code>'s realm</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed May 22 2024 07:50:24 GMT-0700 (Pacific Daylight Time)">14:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(those case still needs to unwrap tho)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed May 22 2024 11:44:37 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>/<span class="nick-4">smaug</span> : This profile is from a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1894286">user reported bug</a> , <a href="https://share.firefox.dev/3K9cpOK">https://share.firefox.dev/3K9cpOK</a>.  There is a GCMajor being triggered every few seconds even though no memory is being collected.   I wonder if it makes sense to reduce this frequency if nothing is being freed?  Seems like we're just wasting CPU resources here.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed May 22 2024 11:46:19 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">sounds reasonable. I don't recall what sorts of information CCGCScheduler gets from SM side about collections</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed May 22 2024 11:46:50 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(for CC there are some heuristics that if (almost) nothing is collected, we don't trigger the next CC too soon)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed May 22 2024 11:48:26 GMT-0700 (Pacific Daylight Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, but the reason here is alloc trigger</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed May 22 2024 11:49:35 GMT-0700 (Pacific Daylight Time)">18:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">that is coming from SM itself. <span class="nick-12">sfink</span> <span class="nick-4">jonco</span>  any ideas?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed May 22 2024 11:53:38 GMT-0700 (Pacific Daylight Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">This looks like thrashing when the heap is full or close to full. We're better about that than we used to be, but it looks like it can still be bad.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed May 22 2024 11:54:37 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm not sure what the best thing to do in this situation is. We could OOM crash. We could avoid collecting and let something else OOM crash.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed May 22 2024 11:55:11 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">continuing to limp along, as this profile shows, isn't very good behavior.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed May 22 2024 11:57:08 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or I guess we could allow &gt;4GB GC heap, but that seems pretty extreme. Is there a way to infer the total memory usage from a profile?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed May 22 2024 11:59:39 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I wonder why that profile shows it doing a DllLoad of gdi32.dll several times.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed May 22 2024 12:05:50 GMT-0700 (Pacific Daylight Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> or I guess we could allow &gt;4GB GC heap, but that seems pretty extreme. Is there a way to infer the total memory usage from a profile?</blockquote></mx-reply>I don't think so in that profile, but there is a memory report for the same session in the bug.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed May 22 2024 12:06:35 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, I just read the bug. I haven't read the memory report, but the reporter claimed 13GB.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed May 22 2024 12:07:42 GMT-0700 (Pacific Daylight Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">yeah it's around there in the report</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed May 22 2024 12:24:21 GMT-0700 (Pacific Daylight Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Is there a way in the JS shell or XPC shell for testing purposes to construct nested CCW?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed May 22 2024 12:26:35 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">what's a nested CCW?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed May 22 2024 12:27:00 GMT-0700 (Pacific Daylight Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">a CrossCompartmentWrapper that is wrapping another CrossCompartmentWrapper</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed May 22 2024 12:28:43 GMT-0700 (Pacific Daylight Time)">19:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that's not possible by design</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed May 22 2024 12:28:43 GMT-0700 (Pacific Daylight Time)">19:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/shell/js.cpp#6784">WrapWithProto</a> mentions nested wrapper chains, and I'm not sure if that applies to CCW</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed May 22 2024 12:29:37 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that must be talking about other types of wrappers, probably the scary ones (Xray wrappers or something?)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed May 22 2024 12:30:24 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">a CCW is always a function of only the wrapping compartment and the target compartment of the actual wrapped object</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed May 22 2024 12:30:50 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm not sure how to create the nested wrappers the comment is referring to.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed May 22 2024 12:31:43 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">there's a mysterious <code>wrapWithProto</code> test function in the shell. Maybe look at where it's used?</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed May 22 2024 12:32:14 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(hopefully someone knowledgeable can give a better answer)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed May 22 2024 12:33:14 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">though if you know you only care about CCWs, then you don't need to worry about nesting</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed May 22 2024 12:34:49 GMT-0700 (Pacific Daylight Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">I know I care about CCWs, I'm not sure about Xrays, WindowProxy, etc.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed May 22 2024 12:36:44 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">what is this for? rawJSON or something?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed May 22 2024 12:40:39 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Yes</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed May 22 2024 12:41:56 GMT-0700 (Pacific Daylight Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Ok. I really wish I didn't always feel so lost when looking at this stuff, but it looks to me like you should be able to get away with <code>js::CheckedUnwrapStatic</code> for everything there.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed May 22 2024 12:42:34 GMT-0700 (Pacific Daylight Time)">19:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(or <code>JSObject::unwrapAs</code> or <code>JSObject::maybeUnwrapAs</code> or <code>JSObject::maybeUnwrapIf</code> etc.)</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed May 22 2024 12:48:53 GMT-0700 (Pacific Daylight Time)">19:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Mostly, those just call <code>js::CheckedUnwrapStatic</code>, so that seems fine</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed May 22 2024 13:04:45 GMT-0700 (Pacific Daylight Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Thanks!</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed May 22 2024 13:06:38 GMT-0700 (Pacific Daylight Time)">20:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@bvisness:mozilla.org">bvisness</span>&gt;</div></td><td class="msg-cell">I see that BigInt has a <code>toUint64</code> method, but how can I check if the value is actually in uint64 range?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed May 22 2024 13:08:37 GMT-0700 (Pacific Daylight Time)">20:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/6d437ba43e7752a85f5731133ee66152b390aa16/js/src/vm/BigIntType.h#172-175">JS::BigInt::isUint64</a></td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed May 22 2024 13:15:22 GMT-0700 (Pacific Daylight Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@bvisness:mozilla.org">bvisness</span>&gt;</div></td><td class="msg-cell">aha, thank you</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed May 22 2024 14:40:44 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">alexical</span>: can you rebase bug 1894428? I attempted to land it, but I guess it must be based on old code now that the cluster of other things have landed.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed May 22 2024 14:40:47 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1894428">https://bugzil.la/1894428</a></td></tr>

</tbody></table></div></div></div>
</body></html>