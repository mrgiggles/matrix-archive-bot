<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-02-20</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-02-20<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-02-19" class="nav-link"><span>prev</span></a>
<a href="2025-02-21" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Feb 20 2025 04:47:34 GMT-0800 (Pacific Standard Time)">12:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">FYI I did some investigation of how clang compiles atomics on ARM wrote it up in bug 1949418</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Feb 20 2025 06:27:51 GMT-0800 (Pacific Standard Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: I've done more research on your patch set that aims at speeding up calls from WASM -&gt; C++ kernels. I see that it lowers the time from wasm -&gt; C++ from about 1 to 2us to 350 to 750ns. In addition, I can tell you that in real life (say, translating a web page, or summaring it, etc.), the C++ kernels execution duration are frequently in the 1us range (extremely high and frequent numbers of very small calls), but can also be dozens of ms (e.g. operating on very large matrices). The overall effectiveness of your optimization then depends on the repartition of the duration of those calls. In all cases, we're seeing that it's always beneficial and never a regression, regardless of the workload we throw at it. I'm working on a doc that will explain all of this with methodologies and profiles and stats etc.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Feb 20 2025 06:36:17 GMT-0800 (Pacific Standard Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-16">Ryan Hunt</span>: I've done more research on your patch set that aims at speeding up calls from WASM -&gt; C++ kernels. I see that it lowers the time from wasm -&gt; C++ from about 1 to 2us to 350 to 750ns. In addition, I can tell you that in real life (say, translating a web page, or summaring it, etc.), the C++ kernels execution duration are frequently in the 1us range (extremely high and frequent numbers of very small calls), but can also be dozens of ms (e.g. operating on very large matrices). The overall effectiveness of your optimization then depends on the repartition of the duration of those calls. In all cases, we're seeing that it's always beneficial and never a regression, regardless of the workload we throw at it. I'm working on a doc that will explain all of this with methodologies and profiles and stats etc.</blockquote></mx-reply>Nice, good to know. The patch was a bit of a hack, so I’ll need to rewrite it to be able to land. I should be able to work on it soon though</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Feb 20 2025 06:38:30 GMT-0800 (Pacific Standard Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: a hack maybe, but it was extremely helpful to understand whether being able to replace very specific key math operation by super super optimized kernel written in asm or clever simd with vector size much greater than what WASM has (or even more specialized stuff such as imm8) would be beneficial, and it seems like it is, thanks to the lower overhead your stuff brings</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Feb 20 2025 06:38:49 GMT-0800 (Pacific Standard Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">the alternatives being "not bothering" or "ditching wasm and go full native"</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Feb 20 2025 07:51:09 GMT-0800 (Pacific Standard Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">Do we have something to nicely inspect the WASM output by a compiler, à la godbolt ?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Feb 20 2025 07:52:04 GMT-0800 (Pacific Standard Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">There is a shell builtin ‘wasmDis’ which takes a function or a module to disassemble</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Feb 20 2025 07:53:15 GMT-0800 (Pacific Standard Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">Apparently the wasmtime engine is just integrated into godbolt, I’m sort of jealous. It’d be nice to have that</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Feb 20 2025 07:54:10 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">how would I load my little <code>.wasm</code> in the shell to disass it ?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Feb 20 2025 07:55:00 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I have this function that's doing math, and clang -O3 does wonders with it on x86_64 march=native, and it doesn't seem too bad either with emscripten -O3, it must be using SIMD, I wanted to verify what happens in practice</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Feb 20 2025 08:17:19 GMT-0800 (Pacific Standard Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">padenot</span>: something like this should work: <code>let bin = os.file.readFile("/path/to/file.wasm", 'binary'); wasmDis(new WebAssembly.Module(bin));</code></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Feb 20 2025 08:18:07 GMT-0800 (Pacific Standard Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">hm I need to build the shell I guess</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Feb 20 2025 08:21:17 GMT-0800 (Pacific Standard Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">for that you can use a mozconfig with <code>ac_add_options --enable-application=js</code> to build just the JS shell. Disassembler support requires <code>ac_add_options --enable-jitspew</code> probably (this is the default for debug builds)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Feb 20 2025 08:21:37 GMT-0800 (Pacific Standard Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">thanks, doing that</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Feb 20 2025 08:25:54 GMT-0800 (Pacific Standard Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">use a <code>--disable-debug</code> build because debug builds emit extra code for 'assertions'</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Feb 20 2025 08:26:47 GMT-0800 (Pacific Standard Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">you can switch between wasm compilers with the <code>--wasm-compiler=baseline</code> or <code>optimizing</code> shell flag</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Feb 20 2025 08:27:12 GMT-0800 (Pacific Standard Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">yeah I'm doing perf work so I'm <code>--enable-profiling --disable-debug --enable-opt</code></td></tr>

</tbody></table></div></div></div>
</body></html>