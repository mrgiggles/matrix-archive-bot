<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-07-09</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-07-09<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-07-07" class="nav-link"><span>prev</span></a>
<a href="2023-07-10" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sun Jul 09 2023 09:11:48 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Is there any way to have some sort of weak ref to an object? ie kinda like a <code>Heap</code> but not traced and you can attempt a deref to see if it hasn't been GC'ed yet?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sun Jul 09 2023 10:25:42 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm not sure how nice they are to use, but there are some APIs for that.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sun Jul 09 2023 10:26:12 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the basic thing is that you have to arrange for them to be swept, so that they can either be nulled out or updated (if the object moved).</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sun Jul 09 2023 10:27:01 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/31702d1881e54ac219d1ca3d50575fb9ea6d7f46/js/public/SweepingAPI.h#81-87"><code>WeakCache</code></a> automates it for containers.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sun Jul 09 2023 10:27:09 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but you can see what it's doing.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sun Jul 09 2023 10:28:05 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm, actually it's a little hard to see, because it (1) uses a magic internal list that is traversed during sweeping, and (2) goes through <code>GCPolicy&lt;T&gt;::traceWeak()</code> that you'd have to track down.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sun Jul 09 2023 10:30:28 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess that's <a href="https://searchfox.org/mozilla-central/rev/31702d1881e54ac219d1ca3d50575fb9ea6d7f46/js/public/GCPolicyAPI.h#138-140">this</a> for <code>Heap&lt;JSObject*&gt;</code></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sun Jul 09 2023 10:32:50 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm not sure the underlying stuff is exposed for embedding. You may <em>have</em> to go through <code>WeakCache</code>.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sun Jul 09 2023 11:58:30 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell">So here's a puzzling API regression.  When compiling scripts, it used to be possible to set a negative line number in the compilation options.  This is really useful in the case where you're wrapping a source file in an IIFE and want the line numbers in the stack trace to line up with the line numbers of the source file.

The new C++ API has &amp;setLine(unsigned l) ........... why is it unsigned?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sun Jul 09 2023 12:16:42 GMT-0700 (Pacific Daylight Time)">19:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">line number has been unsigned from SpiderMonkey 1.6.0</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sun Jul 09 2023 12:20:22 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the body needs to start from line 1, you can use <code>setLine(0)</code> and put all the header into the line 0</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sun Jul 09 2023 12:20:45 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>similar thing is done in <a href="https://searchfox.org/mozilla-central/rev/ada05ac4faf1f79944a35a9eb79083a684a98975/dom/events/EventListenerManager.cpp#1183,1185">https://searchfox.org/mozilla-central/rev/ada05ac4faf1f79944a35a9eb79083a684a98975/dom/events/EventListenerManager.cpp#1183,1185</a></p>
<pre><code class="language-cpp">// Use line 0 to make the function body starts from line 1.
...
    .setFileAndLine(url.get(), 0)
</code></pre>
</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sun Jul 09 2023 12:42:42 GMT-0700 (Pacific Daylight Time)">19:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-15">arai</span>: Interesting...thanks. 1.6 is the first version of jsapi I embedded.  I worked heavily with 1.7 (array extras) through 1.8.5 (es5). I wonder if I'm getting mixed up with v8?  I haven't done a jsapi project until recently in ~8 years.  Now I want to dig up my code that ran on 1.8.5 and see how I solved this.</p>
<p>What I wound up doing was<br><code>pm.eval("""multiline string""".replace("\n", " ") + "\n" + <a href="http://moduleSourceCode.read">moduleSourceCode.read</a>() + "}", { 'lineno':0, 'filename': filename })</code><br>... pretty similar to what you suggested. This forces the whole IIFE preamble on to the zeroeth line and lines up the source code to start line 1, column 0.</p>
</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sun Jul 09 2023 12:43:34 GMT-0700 (Pacific Daylight Time)">19:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell">We'll just have to make sure that our preamble doesn't include any // comments or multiline strings</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sun Jul 09 2023 16:14:44 GMT-0700 (Pacific Daylight Time)">23:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: It seems the main part of that is <code>js::gc::TraceWeakEdge</code>. If I just used that, would the <code>Heap&lt;JSObject*&gt;</code> just point to a null pointer which I could check for manually?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sun Jul 09 2023 16:16:10 GMT-0700 (Pacific Daylight Time)">23:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Yes. But (1) I don't think that's exported to embeddings (I don't see <code>JS_PUBLIC_API</code> on it, and the namespace suggests that it wouldn't be), and (2) you still need a way for it to be invoked during sweeping.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sun Jul 09 2023 16:16:26 GMT-0700 (Pacific Daylight Time)">23:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but yes, the effect would be that if the object dies, it would be set to nullptr</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sun Jul 09 2023 16:17:42 GMT-0700 (Pacific Daylight Time)">23:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Isn't it public?<br><a href="https://searchfox.org/mozilla-central/source/js/src/gc/Marking.cpp#2493">https://searchfox.org/mozilla-central/source/js/src/gc/Marking.cpp#2493</a></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sun Jul 09 2023 16:18:37 GMT-0700 (Pacific Daylight Time)">23:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Since on the rust side we already have traits for this kinda stuff, I'm thinking I can just add a <code>trace_weak</code> method and you can choose when you want to use it.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sun Jul 09 2023 16:19:10 GMT-0700 (Pacific Daylight Time)">23:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">uh, it does rather look like it is. <a href="https://searchfox.org/mozilla-central/rev/ada05ac4faf1f79944a35a9eb79083a684a98975/js/public/TracingAPI.h#406-407">https://searchfox.org/mozilla-central/rev/ada05ac4faf1f79944a35a9eb79083a684a98975/js/public/TracingAPI.h#406-407</a> too.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Sun Jul 09 2023 16:19:48 GMT-0700 (Pacific Daylight Time)">23:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">not sure how I missed that</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Sun Jul 09 2023 16:19:50 GMT-0700 (Pacific Daylight Time)">23:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I'll need to do some shims on the rust side because of templating but that shouldn't be too bad</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Sun Jul 09 2023 16:21:34 GMT-0700 (Pacific Daylight Time)">23:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">looks like you can arrange to be called with <code>JS_AddWeakPointerZonesCallback</code> and/or <code>JS_RemoveWeakPointerZonesCallback</code> and/or <code>JS_AddFinalizeCallback</code></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Sun Jul 09 2023 16:22:49 GMT-0700 (Pacific Daylight Time)">23:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/ada05ac4faf1f79944a35a9eb79083a684a98975/js/xpconnect/src/XPCJSRuntime.cpp#938-954">example callback</a></td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Sun Jul 09 2023 16:26:11 GMT-0700 (Pacific Daylight Time)">23:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Could I just call <code>TraceWeakEdge</code> from a regular <code>trace</code> function? I'd prefer not to need some form of global map to keep track of weak refs</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Sun Jul 09 2023 16:52:49 GMT-0700 (Pacific Daylight Time)">23:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">No. It can't know at that point in time whether the object is dead or alive. Something later may trace it.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Sun Jul 09 2023 16:55:17 GMT-0700 (Pacific Daylight Time)">23:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(also, you're not guaranteed to have that trace function called. Or rather, if you are then it's not really a weak edge.)</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Sun Jul 09 2023 16:57:19 GMT-0700 (Pacific Daylight Time)">23:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">well, that might be overstating it. That particular edge may very well be weak even if you know the containing object will be traced. But consider a weak edge behind a weak edge. How do you ensure that the inner edge is updated when its target moves, for example, if you can't guarantee that its holder is traced?</td></tr>

</tbody></table></div></div></div>
</body></html>