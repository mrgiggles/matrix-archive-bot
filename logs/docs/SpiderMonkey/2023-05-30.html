<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-05-30</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-05-30<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-05-29" class="nav-link"><span>prev</span></a>
<a href="2023-05-31" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon May 29 2023 22:13:02 GMT-0700 (Pacific Daylight Time)">05:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ptomato:gnome.org">ptomato</span>&gt;</div></td><td class="msg-cell">is the advice in <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr102/examples/cookbook.cpp#L341-L375">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr102/examples/cookbook.cpp#L341-L375</a> for throwing a new Error object still current?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon May 29 2023 22:13:26 GMT-0700 (Pacific Daylight Time)">05:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ptomato:gnome.org">ptomato</span>&gt;</div></td><td class="msg-cell">or should we be using <code>JS::CreateError()</code> and <code>JS::SetPendingExceptionStack()</code> these days?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue May 30 2023 00:04:56 GMT-0700 (Pacific Daylight Time)">07:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jandem:mozilla.org">jandem|away</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ptomato</span>: <code>JS::CreateError</code> seems nicer than that <code>JS_CallFunctionName</code>. Note that <code>JS_SetPendingException</code> has an optional argument that specifies whether it should capture a stack, so that part should be fine</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue May 30 2023 00:15:29 GMT-0700 (Pacific Daylight Time)">07:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Random suggestion: would it be workable at all to treat PersistentRooted specially when tracing the nursery (by .e.g pretenuring anything owned by a PersistentRooted, so that you don't even need to trace it).
0 A.D. uses a lot of PersistentRooted objects for the JS wrappers of our C++ components. These are traced when clearing the nursery, which is generally a waste of time (those objects live much longer).
Or is that something that the API can already do in another way and we should change our logic ? </td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue May 30 2023 00:18:05 GMT-0700 (Pacific Daylight Time)">07:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I see that roots added via JS_AddExtraGCRootsTracer aren't traced in minor GCs, but I don't understand the comment saying why (though conceptually that API doesn't say it's dangerous so that's probably safe)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue May 30 2023 00:27:12 GMT-0700 (Pacific Daylight Time)">07:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I see that roots added via JS_AddExtraGCRootsTracer aren't traced in minor GCs, but I don't understand the comment saying why (though conceptually that API doesn't say it's dangerous so that's probably safe)</blockquote></mx-reply>K think I can answer my own question -&gt; storing something in a Heap puts a reference to it (or something) in the store buffer, which means it won't be GCed even if the object is in the nursery. Ergo, safe.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue May 30 2023 00:28:00 GMT-0700 (Pacific Daylight Time)">07:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Conclusion is that I should probably change our code from persistentrooted to JS_AddExtraGCRootsTracer so that nursery collecting becomes faster</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue May 30 2023 00:28:15 GMT-0700 (Pacific Daylight Time)">07:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">which ultimately might also make it possible for us to use a larger nursery and reduce our GC time, would need to test that though</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue May 30 2023 01:36:22 GMT-0700 (Pacific Daylight Time)">08:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">approximately how many persistent roots are we talking about? there are probably better ways to represent this</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue May 30 2023 01:47:41 GMT-0700 (Pacific Daylight Time)">08:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Several thousands potentially, each entities have several, and we can have thousands of these</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue May 30 2023 01:48:53 GMT-0700 (Pacific Daylight Time)">08:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">It seems like it'd be much more efficient to register a <code>JS_AddExtraGCRootsTracer</code> in the central 'component manager' C++ struct we have, and iterate manually over our JS components (which would use JS::Heap instead)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue May 30 2023 02:20:46 GMT-0700 (Pacific Daylight Time)">09:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">PersistentRooted is not the most efficient way to trace roots and is meant for use for convenience of adding a few roots or when nothing else will work.  Adding your own tracer that understands your data structures will be more efficient.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue May 30 2023 02:21:51 GMT-0700 (Pacific Daylight Time)">09:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Yes, use of Heap&lt;&gt; will add store buffer entries which will trace nursery GC things automatically if they are referenced from the heap.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue May 30 2023 02:24:28 GMT-0700 (Pacific Daylight Time)">09:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I think the reason we did it is mostly convenience, and we don't technically keep a list of all JS-component-objects, because we had some lazy/on-demand initialisation, but I think overall just doing our own thing will still probably be faster (since adding new roots requires them to be added/pruned from the list anyways)</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue May 30 2023 02:27:04 GMT-0700 (Pacific Daylight Time)">09:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I had noticed that doing that was slow-ish in itself, but I hadn't noticed that it led to a bad pattern in the nursery too, which seems worse</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue May 30 2023 04:50:29 GMT-0700 (Pacific Daylight Time)">11:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Funny thing is servo mozjs is pretty much planning to only have <code>JS_AddExtraGCRootsTracer</code> (in the process of being merged)<br>The glue needed for PersistentRooted is really annoying.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue May 30 2023 04:55:00 GMT-0700 (Pacific Daylight Time)">11:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">changing them is probably a good idea regardless wrt to performance. </td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue May 30 2023 04:55:32 GMT-0700 (Pacific Daylight Time)">11:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Servo itself only uses the former. (See <a href="https://github.com/servo/servo/blob/fc07c2127669ecd6c2419552553212a0cd333ea3/components/script/script_runtime.rs#L475">script_runtime.rs</a>)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue May 30 2023 05:40:32 GMT-0700 (Pacific Daylight Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I'm trying to figure out if we actually need to run shrinking gcs manually, but it seems like the answer is 'no'.
As far as I can tell, the main positive impact for 0 A.D. would be that the cells get 'defragmented', so that the total # of arenas is reduced. But we don't actually 'gain' any memory capability, as the arenas otherwise have free slots. The only situation, insofar as I can tell, where there would be a relevant difference is if we needed  to allocate a 'big' object and that wasn't possible in any of the remaining arenas, where a compacted-version might allow it. But that seems rather unlikely to me, as in general the size of objects seems to be very similar and rather small.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue May 30 2023 05:40:57 GMT-0700 (Pacific Daylight Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Furthermore, shrinking GCs frees memory, that we might then re-allocate if the runtime grows. So that seems less efficient than running partially empty arenas, potentially</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue May 30 2023 08:12:50 GMT-0700 (Pacific Daylight Time)">15:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">i.ain: Great analysis in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1833315">https://bugzilla.mozilla.org/show_bug.cgi?id=1833315</a>. As far as action goes, I'm not sure we have much in the way of options... perhaps on android (and android only) we mark js::StackUses as MOZ_NEVER_INLINE?; while this appears solidly to be a hardware bug it has to be something about the instruction -sequence- otherwise we'd see waaaaaay more crashes of this nature I think. So perhaps judicious use of <code>MOZ_NEVER_INLINE</code> might jostle emitted instructions just enough that we can get this to work properly?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue May 30 2023 08:13:11 GMT-0700 (Pacific Daylight Time)">15:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Or perhaps we should see if someone from the tools team can suggest a more precise intervention?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue May 30 2023 09:07:06 GMT-0700 (Pacific Daylight Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: The part that stands out to me is that we're storing the opcode, and then reading it back to look it up in the table instead of just using the value we already have. I haven't quite worked out where that happens, and it's a little weird that the compiler doesn't fix it for us, but if we could generate better code there then the problem would go away.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue May 30 2023 09:08:10 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: That's js::StackUses -- which is slightly awkward, because you wish you could just carry the op along, but because there are sometimes secondary data needed from the instruction stream, passing <code>jsbytecode*</code> makes more sense in the general case.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue May 30 2023 09:08:34 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/vm/BytecodeUtil.h#331,341,345,352">https://searchfox.org/mozilla-central/source/js/src/vm/BytecodeUtil.h#331,341,345,352</a></td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue May 30 2023 09:08:39 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, so it is</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue May 30 2023 09:08:40 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">There aren't any truly big objects. Anything big will get a small thing allocated in the arena that points to the big stuff in malloc memory. There <a href="https://searchfox.org/mozilla-central/source/js/src/gc/AllocKind.h#60-79">aren't that many</a> different kinds of objects that will get allocated, and the largest has space for 16 64-bit Values.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue May 30 2023 09:09:44 GMT-0700 (Pacific Daylight Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Also, since the tenured heap tracks free space within the arenas (and everything stored in an arena is the same size), you're right that compaction won't help if you're just going to end up allocating enough to use up the fragmented space in the partially-filled arenas.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue May 30 2023 09:10:42 GMT-0700 (Pacific Daylight Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">It'll only save memory if you have a bunch of partially filled arenas and can compact them down to fewer, and you've mostly stopped allocating stuff so you won't be filling them back up agian.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue May 30 2023 09:11:49 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I suspect it should mostly happen only when things have been idle for a while and will be idle for a while longer. Which may never happen in your game?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue May 30 2023 09:15:01 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">ptomato</span>: <code>JS::CreateError</code> seems nicer than that <code>JS_CallFunctionName</code>. Note that <code>JS_SetPendingException</code> has an optional argument that specifies whether it should capture a stack, so that part should be fine</blockquote></mx-reply>thanks! by the way, what's the reason we have both <code>JS_SetPendingException</code> and <code>JS::SetPendingExceptionStack</code>? I thought the latter might be for when you need to customize the stack, but you can also provide a custom stack to <code>JS::CreateError</code>.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue May 30 2023 09:15:21 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>ArrayBufferFromUserContents</code> ought to be pretty fast. <code>DataView</code> is mostly unoptimized, and I would expect its performance to be pretty bad.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue May 30 2023 09:16:46 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I can think of 4 options for creating object graphs: (1) all from C++, (2) your idea of getting a chunk of data and processing it in JS, (3) going through a JSON string, and (4) going through a structured clone buffer. None of them seem all that pleasant to use, honestly.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue May 30 2023 09:17:53 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Oh right, and also I'm guessing that you're getting very small objects because you're creating them with a generic thing that'll use the smallest object type and then filling them in? That would mean big objects are even less of a concern.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue May 30 2023 09:20:07 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I think you're correct on all counts yes</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue May 30 2023 09:20:50 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">When we incremental GC we actually get some freed memory, which I presume is arenas becoming completely empty (which probably happens often), but I doubt the 'uncompacted' data is a problem since we'll fill them up again, as we indeed never go idle</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue May 30 2023 09:21:31 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">wrt to 'small / big objects' I was mostly asking as a sanity-check that we wouldn't run into problems trying to allocate big arrays or something, but I had not understood that, in actuality, things like strings and arrays are mostly stored in C++ memory and don't reflect in the JS heap</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue May 30 2023 09:21:45 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: The other thread I would consider pulling is looking into the specific CPUs involved and seeing if they have errata for this bug. I got as far as discovering that this particular phone apparently has an <a href="https://www.gsmarena.com/samsung_galaxy_s20_fe-10428.php">octa-core arrangement</a> with two different arrangements of three different chips depending on where you bought it, and then I gave up for the day.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue May 30 2023 09:22:37 GMT-0700 (Pacific Daylight Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">ArrayBufferFromUserContents is pretty fast but I'm running into more minor GCs, which makes it maybe less efficient sometimes.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue May 30 2023 09:22:44 GMT-0700 (Pacific Daylight Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">DataView is the same but it's also slow on its own</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue May 30 2023 09:23:30 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">We're mostly using (1) right now, but to create e.g. our ECS messages, which look for example like <code>{ tag: 434, added:[234, 42], removed: [2324, 42] }</code>, that's pretty slow, as SetProperty takes a lot of time checking for things and adding slots and whatnot</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue May 30 2023 09:23:51 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">This is legitimately faster in JITted code bar the dataview/arraybufefr concerns</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue May 30 2023 09:24:06 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I kinda doubt JSON would be faster but I haven't checked</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue May 30 2023 09:24:26 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I don't think embedder C++ code can manually craft Structured clones, but that might be a good trick otherwise</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue May 30 2023 09:24:44 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I also had the option of just making these proxies, but I fear that probably won't be much more efficient since we need to create arrays in some cases</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue May 30 2023 09:27:28 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">but TBH if we're looking into really optimising these, I think the fastest solution would be to re-use the last created object</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue May 30 2023 09:27:42 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">and e.g. clear() arrays and such, would also reduce GC overhead</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue May 30 2023 09:29:03 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah... cursory googling is not giving me anything nice like intel/amd errata </td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue May 30 2023 09:32:26 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">BTW is there any way from JS to interact with atomised strings for e.g. Map() objects? We have some access patterns where it would be convenient to pass the atomised string directly</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue May 30 2023 09:38:36 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>JSAtom</code> inherits from <code>JSString</code>, so you can use <code>JSAtom*</code> in place of <code>JSString*</code> if nothing else.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue May 30 2023 09:39:33 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think it'll do a dynamic flag check and then use the atom, so it should work performance-wise.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue May 30 2023 09:40:52 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">my question was more along the lines of 'Can I, within JS, call something that takes a non-atomised string and gives me an atomised (behind the scenes) version of that string instead' ?</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue May 30 2023 09:41:03 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">and/or would it work if I wrote that C++ function </td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue May 30 2023 09:41:58 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">we have a particularly hot codepath that essentially calls Map.get(some_string_key), atomising that. In some particular case, we could pre-atomise that string. Furthermore, if the key is not found, we end up re-using the same string to set the key in the map, which as far as I can tell re-atomizes</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue May 30 2023 09:43:24 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ptomato</span>: yeah, if you pass a custom stack to <code>CreateError</code> you probably don't need <code>SetPendingExceptionStack</code></td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue May 30 2023 09:44:14 GMT-0700 (Pacific Daylight Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah. In the past, I have recommended <code>asAtom = str =&gt; Object.keys({str:undefined})[0]</code> (WRONG CODE, see below) though that was for the purpose of saving space.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue May 30 2023 09:45:24 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but it should work for your case. Obviously, you still wouldn't want to call it repeatedly.</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue May 30 2023 09:47:51 GMT-0700 (Pacific Daylight Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">especially if you fix the bug in my code above</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue May 30 2023 09:48:22 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">sorry, it should be <code>asAtom = str =&gt; Object.keys({[str]:undefined})[0]</code> if you want it to work for anything but the literal <code>"str"</code></td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue May 30 2023 09:52:52 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">I see, that works but the the raw overhead from the the object construction makes it not particularly interesting here. Guess I should try a specific function, or just generally make sure that this gets called with an atomised string.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue May 30 2023 09:52:59 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Are 'string constants' pre-atomised in general ? </td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue May 30 2023 10:04:11 GMT-0700 (Pacific Daylight Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes (though note that I'm answering from observation, just based on what I see happening in the JS shell). The JS parser seems to create atoms for everything it sees in the source text.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue May 30 2023 10:05:26 GMT-0700 (Pacific Daylight Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Is there an API to get a HandleValue from a Heap<a href="JS::Value">JS::Value</a> ? Or do I have to fromMarkedLocation?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue May 30 2023 10:09:06 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Normally, you'd copy it to a <code>Rooted&lt;JS::Value&gt;</code> and then use that.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue May 30 2023 10:10:11 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but <code>fromMarkedLocation</code> does the right thing.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue May 30 2023 10:12:34 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">If the value is guaranteed to be already rooted (which it will be here, because I'm switching from PersistentRooted to Heap, and adding tracers), I think RootedValue just adds overhead ? </td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue May 30 2023 10:12:53 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue May 30 2023 10:14:41 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> yes (though note that I'm answering from observation, just based on what I see happening in the JS shell). The JS parser seems to create atoms for everything it sees in the source text.</blockquote></mx-reply>I believe that we used to always atomize string literals, but we changed it to avoid atomizing long strings unnecessarily. See bug 1721413.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue May 30 2023 10:14:42 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1721413">https://bugzil.la/1721413</a> — RESOLVED (arai) — Use JSString instead of JSAtom for string literals during instantiation</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue May 30 2023 10:15:28 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you just need to be a little careful with <code>fromMarkedLocation</code>, since it's fairly easy to accidentally use it on a pointer that is not guaranteed to get marked.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue May 30 2023 10:15:46 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but you're thinking about that already, so you should be fine</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue May 30 2023 10:17:16 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, this is what I was remembering: <a href="https://searchfox.org/mozilla-central/source/js/src/frontend/ParserAtom.cpp#133">https://searchfox.org/mozilla-central/source/js/src/frontend/ParserAtom.cpp#133</a></td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue May 30 2023 10:17:54 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We always atomize latin-1 strings if they are less than 8 characters long</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Tue May 30 2023 10:18:50 GMT-0700 (Pacific Daylight Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@wraitii:mozilla.org">wraitii</span>&gt;</div></td><td class="msg-cell">Guess I'll check deeper into the code, those particular strings happen to be pretty long as well. We're definitely antipattern-ing here, but if I can get cheap speedups I'd like to do it</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Tue May 30 2023 10:19:24 GMT-0700 (Pacific Daylight Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span> has great analysis in that bug 1721413.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Tue May 30 2023 10:19:25 GMT-0700 (Pacific Daylight Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1721413">https://bugzil.la/1721413</a> — RESOLVED (arai) — Use JSString instead of JSAtom for string literals during instantiation</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Tue May 30 2023 13:38:03 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I made a minor refactoring change to the hazard analysis, just to make it a little easier to use external tooling. In my tree, that had a small side effect of going from 4 → 7175 hazards. Keep it?</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Tue May 30 2023 13:43:42 GMT-0700 (Pacific Daylight Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, but have you considered that if a minor refactor can increase the number of hazards by three orders of magnitude, it can also decrease the number of hazards in the same way. 0.004 hazards, here we come!</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Tue May 30 2023 13:48:41 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I am intrigued by your ideas and wish to subscribe to your newsletter.</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Tue May 30 2023 16:29:35 GMT-0700 (Pacific Daylight Time)">23:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the JS shell has an example of fabricating structured clone data, but it would be a pretty unusual solution. (The data format is weird but fixed; we have to be able to load ancient structured clone data from disk, so it's fully backward-compatible.)</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Tue May 30 2023 16:30:13 GMT-0700 (Pacific Daylight Time)">23:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but it sounds like these are short-lived, so in terms of maximum performance I think your idea of reusing objects would be the fastest.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Tue May 30 2023 16:31:08 GMT-0700 (Pacific Daylight Time)">23:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you could try to reuse the Shape for the next object, but I don't tihnk that's possible via the public API. And it would still produce GC churn, as you said.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Tue May 30 2023 16:33:25 GMT-0700 (Pacific Daylight Time)">23:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we used to have TypedObjects, which would probably fit your use case well. Those may come back someday in some other form, probably via wasm.</td></tr>

</tbody></table></div></div></div>
</body></html>