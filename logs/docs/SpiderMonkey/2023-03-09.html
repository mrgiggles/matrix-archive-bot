<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-03-09</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-03-09<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-03-08" class="nav-link"><span>prev</span></a>
<a href="2023-03-10" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Mar 09 2023 01:26:30 GMT-0800 (Pacific Standard Time)">09:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: every JS object has a pointer to its global that goes via shape, then baseshape</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Mar 09 2023 01:27:01 GMT-0800 (Pacific Standard Time)">09:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">so they just somehow show up under JS Script?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Mar 09 2023 01:27:12 GMT-0800 (Pacific Standard Time)">09:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">in cc graph</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Mar 09 2023 01:31:53 GMT-0800 (Pacific Standard Time)">09:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: is it the case where single <code>JS Script</code> has multiple <code>baseshape_global</code> properties  ?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Mar 09 2023 01:33:19 GMT-0800 (Pacific Standard Time)">09:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">yes, that is what I see in the graph. I guess we just report some edges to CC in that way.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Mar 09 2023 01:36:41 GMT-0800 (Pacific Standard Time)">09:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><p>It looks like<br>0x290b123878d0 [gc.marked] JS Script</p>
<blockquote>
<p>0xeff219fd580 function<br>0x2ed605d15820 sourceObject<br>0x8bad29b4240 cacheir-object<br>0x290b12352078 cacheir-object<br>0x377207a6a900 cacheir-object<br>0x8bad29b4240 baseshape_global<br>0xeff2198a6b8 baseshape_proto<br>0xeff2198a6b8 cacheir-object<br>0x8bad29b4240 baseshape_global</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Mar 09 2023 01:38:04 GMT-0800 (Pacific Standard Time)">09:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in that case that would be part of <code>JitScript</code> I guess</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Mar 09 2023 01:38:27 GMT-0800 (Pacific Standard Time)">09:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>somewhere in <a href="https://searchfox.org/mozilla-central/rev/cd2121e7d83af1b421c95e8c923db70e692dab5f/js/src/jit/JitScript.cpp#176">https://searchfox.org/mozilla-central/rev/cd2121e7d83af1b421c95e8c923db70e692dab5f/js/src/jit/JitScript.cpp#176</a></p>
<pre><code class="language-cpp">void JitScript::trace(JSTracer* trc) {
</code></pre>
</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Mar 09 2023 01:39:03 GMT-0800 (Pacific Standard Time)">09:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">unless the output is sorted after the trace</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Mar 09 2023 01:48:03 GMT-0800 (Pacific Standard Time)">09:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">maybe I'm misunderstanding how the graph is generated :/</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Mar 09 2023 02:10:16 GMT-0800 (Pacific Standard Time)">10:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Same thing happens with an object too. 0x3656dd5ba60 [gc.marked] JS Object having multiple baseshape_global edges</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Mar 09 2023 02:11:01 GMT-0800 (Pacific Standard Time)">10:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">and multiple baseshape_proto edges</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Mar 09 2023 02:12:38 GMT-0800 (Pacific Standard Time)">10:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, I got similar case locally</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Mar 09 2023 02:15:54 GMT-0800 (Pacific Standard Time)">10:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">i wonder if the child edge of "cacheir-object" is somehow printed there?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Mar 09 2023 02:20:32 GMT-0800 (Pacific Standard Time)">10:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">guybedford</span>: the wasi build we have in CI is building with <code>--without-intl-api</code>. A local build without that flag works fine for me, I tested it with wasmtime</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Mar 09 2023 02:22:59 GMT-0800 (Pacific Standard Time)">10:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">guybedford</span>: that's with this mozconfig + <code>./mach build</code>, mozilla-central tip: <a href="https://paste.mozilla.org/B8gyLNJd">https://paste.mozilla.org/B8gyLNJd</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Mar 09 2023 02:28:46 GMT-0800 (Pacific Standard Time)">10:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">guybedford</span>: I'll see if we can add a wasi-intl build in CI. Fwiw the binary is 2.8x larger when gzip compressed (2.7 MB without Intl =&gt; 7.8 MB with)</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Mar 09 2023 02:31:14 GMT-0800 (Pacific Standard Time)">10:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Somehow a List object in the parent page is keeping a reference to the globals of the iframes in sp3 through baseshape_global</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Mar 09 2023 02:31:40 GMT-0800 (Pacific Standard Time)">10:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I wonder if that is through async iterator or what</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Mar 09 2023 02:37:47 GMT-0800 (Pacific Standard Time)">10:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: FWIW, I was just wondering why I see the window globals of already run subtests in cc graph, and somehow this one List keeps references to them. It does get collected eventually.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Mar 09 2023 02:38:45 GMT-0800 (Pacific Standard Time)">10:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">still trying to understand what this means ðŸ™‚ Is there anything we could optimize - can we cut those edges ?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Mar 09 2023 02:38:46 GMT-0800 (Pacific Standard Time)">10:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">yeah I haven't figured out why the dump heap output looks like this, but it's probably from JIT ICs</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Mar 09 2023 02:39:36 GMT-0800 (Pacific Standard Time)">10:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I'm not sure how this can end up referencing previous globals though</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Mar 09 2023 02:39:54 GMT-0800 (Pacific Standard Time)">10:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">the List lives in the parent page </td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Mar 09 2023 02:40:10 GMT-0800 (Pacific Standard Time)">10:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">and parent page iterates through the tests, load them in an iframe</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Mar 09 2023 02:40:38 GMT-0800 (Pacific Standard Time)">10:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">oh ok, so it's referencing child globals, some of which are otherwise dead</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Mar 09 2023 02:41:36 GMT-0800 (Pacific Standard Time)">10:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I think so. There might be some other edges, but so far I haven't found them. We don't kill those globals nor the native object because they are gc.marked</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Mar 09 2023 02:42:05 GMT-0800 (Pacific Standard Time)">10:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(this is the CC meaning of gc.marked)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Mar 09 2023 02:42:15 GMT-0800 (Pacific Standard Time)">10:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">ICs have GC pointers e.g. to shapes to guard against, and ideally these should really be weak pointers but at the moment they are not</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Mar 09 2023 02:45:14 GMT-0800 (Pacific Standard Time)">10:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">my guess is that is where these are coming from</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Mar 09 2023 02:48:07 GMT-0800 (Pacific Standard Time)">10:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">you could try with baseline interpreter disabled to see if that helps</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Mar 09 2023 02:49:00 GMT-0800 (Pacific Standard Time)">10:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><a href="https://paste.mozilla.org/c9QhROUd">https://paste.mozilla.org/c9QhROUd</a> the list, lots of different globals, each of them seem to be a pointer to a [gc.marked] JS Object (Window)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Mar 09 2023 02:49:14 GMT-0800 (Pacific Standard Time)">10:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: how do I try that?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Mar 09 2023 02:49:26 GMT-0800 (Pacific Standard Time)">10:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">which pref ?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Mar 09 2023 02:50:31 GMT-0800 (Pacific Standard Time)">10:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: <code>javascript.options.blinterp = false</code>, requires a browser restart. This will disable all JS JITs too</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Mar 09 2023 02:56:20 GMT-0800 (Pacific Standard Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">with that I don't see the all the time increasing GC times in the profile. But it of course does affect timing quite a bit, so in theory gc/cc might run differently. But overall, the profile looks way less orange</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Mar 09 2023 02:56:28 GMT-0800 (Pacific Standard Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(orange being cc and gc)</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Mar 09 2023 03:02:25 GMT-0800 (Pacific Standard Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>can we cut those edges ?</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Mar 09 2023 03:02:55 GMT-0800 (Pacific Standard Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: do we know when those edges can be safely cut?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Mar 09 2023 03:03:32 GMT-0800 (Pacific Standard Time)">11:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, I don't know. I don't know what they are used for.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Mar 09 2023 03:04:09 GMT-0800 (Pacific Standard Time)">11:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I mean, does the browser know that those globals should be dead?  (we don't know in the engine)</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Mar 09 2023 03:06:46 GMT-0800 (Pacific Standard Time)">11:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">well, DOM side has tried its best to kill them. Most of the edges those native Window objects have have been removed explicitly. Unlink of course can't happen, since JS keeps them alive.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Mar 09 2023 03:07:30 GMT-0800 (Pacific Standard Time)">11:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">can we nuke wrappers to them?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Mar 09 2023 03:08:35 GMT-0800 (Pacific Standard Time)">11:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">or is it still possible for JS to hold valid references to them?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Mar 09 2023 03:10:43 GMT-0800 (Pacific Standard Time)">11:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">it is possible</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Mar 09 2023 03:12:01 GMT-0800 (Pacific Standard Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">it is fine for parent page to do   document.body.innerHTML = "&lt;iframe&gt;"; let w = document.body.firstChild.contentWindow; document.body.firstChild.remove();  /* now do something with w*/</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Mar 09 2023 03:12:30 GMT-0800 (Pacific Standard Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">You can't do much with w, but it is still there.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Mar 09 2023 03:13:01 GMT-0800 (Pacific Standard Time)">11:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">though, hmm, this is a cross page load</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Mar 09 2023 03:13:17 GMT-0800 (Pacific Standard Time)">11:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">different case, but shouldn't really matter. One can still have a reference to the old window.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Mar 09 2023 03:14:33 GMT-0800 (Pacific Standard Time)">11:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: I wonder if we can treat cross-realm pointers differently in JITs?  (if that is what the problem is here)</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Mar 09 2023 03:28:25 GMT-0800 (Pacific Standard Time)">11:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: it's a bit tricky because it can also happen indirectly through other pointers. I wonder if we can change our discard-jit-code heuristics if we see a lot of globals being created/destroyed or something?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Mar 09 2023 03:29:13 GMT-0800 (Pacific Standard Time)">11:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: you could try adding an early <code>return false;</code> to <code>GCRuntime::shouldPreserveJITCode</code>, that should make us more aggressive about discarding JIT code when we GC</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Mar 09 2023 03:29:56 GMT-0800 (Pacific Standard Time)">11:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">ok, just at the beginning here <a href="https://searchfox.org/mozilla-central/source/js/src/gc/GC.cpp#2300">https://searchfox.org/mozilla-central/source/js/src/gc/GC.cpp#2300</a> ?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Mar 09 2023 03:30:11 GMT-0800 (Pacific Standard Time)">11:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Mar 09 2023 03:31:44 GMT-0800 (Pacific Standard Time)">11:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, I see realm-&gt;preserveJitCode() there. DOM could hint that a realm is supposed to be gone</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Mar 09 2023 03:31:47 GMT-0800 (Pacific Standard Time)">11:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">anyhow, testing</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Mar 09 2023 03:36:36 GMT-0800 (Pacific Standard Time)">11:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">doesn't seem to change anything</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Mar 09 2023 03:37:00 GMT-0800 (Pacific Standard Time)">11:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">that was based on profiling</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Mar 09 2023 03:38:22 GMT-0800 (Pacific Standard Time)">11:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, wait, it does</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Mar 09 2023 03:40:37 GMT-0800 (Pacific Standard Time)">11:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">when looking at the system monitor, memory usage stays in lower level, I think. (one can't profile when looking at that)</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Mar 09 2023 03:41:07 GMT-0800 (Pacific Standard Time)">11:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: for what it's worth, we do already have this flag that we can use in the engine: <a href="https://searchfox.org/mozilla-central/rev/cd2121e7d83af1b421c95e8c923db70e692dab5f/dom/base/nsGlobalWindowInner.cpp#1482">https://searchfox.org/mozilla-central/rev/cd2121e7d83af1b421c95e8c923db70e692dab5f/dom/base/nsGlobalWindowInner.cpp#1482</a></td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Mar 09 2023 03:41:42 GMT-0800 (Pacific Standard Time)">11:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">ideally this would only affect 1 discard code cycle so maybe we want something slightly different</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Mar 09 2023 03:41:48 GMT-0800 (Pacific Standard Time)">11:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">well, is that quite the same</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Mar 09 2023 03:41:55 GMT-0800 (Pacific Standard Time)">11:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">if window is unlinked, it is really gone</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Mar 09 2023 03:42:13 GMT-0800 (Pacific Standard Time)">11:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">here, we can't get unlink, because js engine keeps the window alive</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Mar 09 2023 03:42:28 GMT-0800 (Pacific Standard Time)">11:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">oh I see, right</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Mar 09 2023 03:44:20 GMT-0800 (Pacific Standard Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">ok, run couple of times, and memory usage does seem to stay lower. I should also try to see what CC graphs look like with this</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Mar 09 2023 03:44:35 GMT-0800 (Pacific Standard Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: I guess it wouldn't be hard to add a simple flag to Realm</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Mar 09 2023 03:44:45 GMT-0800 (Pacific Standard Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">also worth looking at perf numbers to see how it affects our score</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Mar 09 2023 03:45:13 GMT-0800 (Pacific Standard Time)">11:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: this current hack GCs all the realms</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Mar 09 2023 03:45:23 GMT-0800 (Pacific Standard Time)">11:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">we should GC only the ones gone</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Mar 09 2023 03:46:07 GMT-0800 (Pacific Standard Time)">11:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">but the pointers are from jit code in realms that are still alive I think?</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Mar 09 2023 03:47:18 GMT-0800 (Pacific Standard Time)">11:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">anyway, changing our jit code heuristics to handle this "we want to cut all edges to likely dead globals" case seems reasonable</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Mar 09 2023 03:47:46 GMT-0800 (Pacific Standard Time)">11:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">ah, I see, I thought that method would affect also how we might clean up some stuff</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Mar 09 2023 03:48:23 GMT-0800 (Pacific Standard Time)">11:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">maybe we could set a flag on the zone that we then clear after looking at it, or something</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Mar 09 2023 03:48:51 GMT-0800 (Pacific Standard Time)">11:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I mean, clean up realm specific. But yeah, I had my CC dev hat on. We can do weird stuff there ðŸ™‚ </td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Mar 09 2023 03:50:58 GMT-0800 (Pacific Standard Time)">11:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">could also use a counter if we want to be less eager.. I think we've seen similar issues a few times now so it does seem generally useful</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Mar 09 2023 03:51:33 GMT-0800 (Pacific Standard Time)">11:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">if I push this to try to get some numbers, are there still some very important cases when shouldPreserveJITCode should return true</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Mar 09 2023 03:52:18 GMT-0800 (Pacific Standard Time)">11:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">should be fine, maybe some js tests could complain but it should be correct, just a bit slower in some cases</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Mar 09 2023 03:52:31 GMT-0800 (Pacific Standard Time)">11:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(and I should still look at the new CC graphs, to ensure I'm not just seeing some random lower memory usage numbers, but actually verify the graphs are smaller)</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Mar 09 2023 03:53:02 GMT-0800 (Pacific Standard Time)">11:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">ok, so just return false always</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Mar 09 2023 04:12:04 GMT-0800 (Pacific Standard Time)">12:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">guybedford</span>: I filed bug 1821313</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Mar 09 2023 04:12:05 GMT-0800 (Pacific Standard Time)">12:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1821313">https://bugzil.la/1821313</a> â€” ASSIGNED (jandem) â€” Build SpiderMonkey for WASI with Intl/ICU in CI</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Mar 09 2023 07:08:48 GMT-0800 (Pacific Standard Time)">15:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">guybedford</span>: would very much like to hear how spidermonkey on WASI is going, you have a blog or anything? How is perf?</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Thu Mar 09 2023 07:09:51 GMT-0800 (Pacific Standard Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell">(geez I sound like Homer Simpson: "I find your ideas intriguing and would like to subscribe to your newsletter", lol)</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Thu Mar 09 2023 07:23:08 GMT-0800 (Pacific Standard Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: I didn't entirely follow the discussion here, but can we maybe dump JIT code when we nuke windows? (it seemed like you were talking about edges that weren't CCWs and thus can't be nuked by our usual stuff, although we are only doing that for chrome-content edges right now anyways.)</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Thu Mar 09 2023 07:23:45 GMT-0800 (Pacific Standard Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">The idea would be that if a tab got closed we probably don't care about fast JIT code, and dumping JIT code wouldn't break the page exactly.</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Thu Mar 09 2023 07:26:20 GMT-0800 (Pacific Standard Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: no tab is being closed. We have just a page which is loading new pages to an iframe in it.</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Thu Mar 09 2023 07:26:41 GMT-0800 (Pacific Standard Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">so everything is same compartment and zone and all that</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Thu Mar 09 2023 07:27:02 GMT-0800 (Pacific Standard Time)">15:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: but maybe we still fire the WindowDestroyedEvent stuff? I guess I don't know how that works exactly.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Thu Mar 09 2023 07:28:23 GMT-0800 (Pacific Standard Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">we do, DOM could tell to JS that the global should be gone, but I don't know what all JS can do with that information.</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Thu Mar 09 2023 07:28:52 GMT-0800 (Pacific Standard Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">It could discard the JIT code. ðŸ˜„</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Thu Mar 09 2023 07:29:18 GMT-0800 (Pacific Standard Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, sure. But I think the problem here is that an object living in the parent document is keeping that stuff alive</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Thu Mar 09 2023 07:30:04 GMT-0800 (Pacific Standard Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">and I don't know how to deal with that. Perhaps GC could selectively discard something?  Perhaps JIT itself should somehow clear the references?</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Thu Mar 09 2023 07:31:01 GMT-0800 (Pacific Standard Time)">15:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Yeah I have no idea how JIT code lifetime actually works. We just complain about it occasionally and then a JIT person tweaks something.</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Thu Mar 09 2023 07:39:54 GMT-0800 (Pacific Standard Time)">15:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">waiting for try results to see how the possible tweak affects numbers. One could discard jit only if some realms have been marked as dead. And sp3 might not be too much affected, since gc happens usually outside the measured time.  No idea how MotionMark would behave though. In other words, needs some investigation ðŸ™‚ </td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Thu Mar 09 2023 09:41:52 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: are you around today? I wanted to talk about a hazard review and weak maps.</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Thu Mar 09 2023 09:42:28 GMT-0800 (Pacific Standard Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: hey, yes I'm around</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Thu Mar 09 2023 09:43:39 GMT-0800 (Pacific Standard Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">we can talk on zoom if that's easier</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Thu Mar 09 2023 09:44:15 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok great. First, do you think it's ok to rely on <a href="https://phabricator.services.mozilla.com/D170112#5600821">a.hal's review</a> of <code>mach hazards view</code>? Otherwise, I'll need to wait for someone to take a look at it.</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Thu Mar 09 2023 09:44:25 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">both of these are pretty small</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Thu Mar 09 2023 09:44:53 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">second, how do you feel about doing rekeying for WeakMap/WeakMap rather than using the UniqueId mechanism?</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Thu Mar 09 2023 09:45:03 GMT-0800 (Pacific Standard Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I know we had problems with it</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Thu Mar 09 2023 09:45:05 GMT-0800 (Pacific Standard Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">no, I think someone familiar with mach should take a look</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Thu Mar 09 2023 09:45:29 GMT-0800 (Pacific Standard Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but they're different in a couple of ways. We already have a list of nursery keys.</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Thu Mar 09 2023 09:45:46 GMT-0800 (Pacific Standard Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and it's using OrderedHashMap, which I <em>think</em> makes things cleaner.</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Thu Mar 09 2023 09:46:39 GMT-0800 (Pacific Standard Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, I can try to find someone on the build peers for it. I'm kind of finding that all of the people I knew of who worked on mach are either gone or have moved away from it.</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Thu Mar 09 2023 09:47:16 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">ok, I think OrderedHashMap helps a lot</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Thu Mar 09 2023 09:47:26 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">but I don't remember the details all that well</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Thu Mar 09 2023 09:47:55 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">possibly we should try it and see, I do remember there were problems with it before and MovableCellHasher was a great improvement</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Thu Mar 09 2023 09:48:06 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the nursery keys make the common case of rekeying easier, but still won't handle compaction</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Thu Mar 09 2023 09:48:45 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">right, we would have to trace and update all weak maps; that's probably fine as we already do a ton of that when we compact already</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Thu Mar 09 2023 09:49:12 GMT-0800 (Pacific Standard Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">potentially it could affect nursery collection if there are many weakmaps</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Thu Mar 09 2023 09:50:39 GMT-0800 (Pacific Standard Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I guess we're not doing something silly and doing more lookups in the unique key lookups that we need to?</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Thu Mar 09 2023 09:52:24 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I didn't see that in <a href="https://share.firefox.dev/3T3xEVH">the profile</a> but I guess I wasn't looking for it.</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Thu Mar 09 2023 09:54:16 GMT-0800 (Pacific Standard Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: wait, we don't use OrderedHashMap for WeakMap, unless I'm misreading this?</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Thu Mar 09 2023 09:55:51 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">difficult to see with all those templates...</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Thu Mar 09 2023 09:55:51 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">uh... wait, I think you're right.</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Thu Mar 09 2023 09:56:16 GMT-0800 (Pacific Standard Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ugh, confused Map/Set with WeakMap.</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Thu Mar 09 2023 09:58:20 GMT-0800 (Pacific Standard Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I was thinking "...but how does it maintain order then?!...oh. Right."</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Thu Mar 09 2023 10:00:32 GMT-0800 (Pacific Standard Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">annoyingly it looks like we do do an extra lookup in the unique ID table, because of the way fallible hashing works</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Thu Mar 09 2023 10:00:35 GMT-0800 (Pacific Standard Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">it may be possible to fix that</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Thu Mar 09 2023 12:05:47 GMT-0800 (Pacific Standard Time)">20:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: thanks for tracking that! I deleted all my stateful folders and reran it and the LLVM segfault seems to have gone away... so no actually sure what the issue was, but thanks for confirming it works. Yes we likely will want both builds due to the size difference, and can include some workarounds for the non-intl cases. But for those who do want the APIs it would be good to start thinking about how we could ship them. Perhaps there's ways to introduce further optimizations as well.</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Thu Mar 09 2023 12:14:18 GMT-0800 (Pacific Standard Time)">20:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">guybedford</span>: I'm glad it works :) Regarding the size, I haven't tried wasm-opt with the intl version yet but I noticed it can shrink the non-intl wasm file quite a lot with (I think) -Z</td></tr>

</tbody></table></div></div></div>
</body></html>