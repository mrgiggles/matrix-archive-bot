<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-02-16</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-02-16<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-02-15" class="nav-link"><span>prev</span></a>
<a href="2023-02-17" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Feb 15 2023 18:00:44 GMT-0800 (Pacific Standard Time)">02:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: that looks helpful. Is there a tool that consumes the output?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Feb 15 2023 20:59:55 GMT-0800 (Pacific Standard Time)">04:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: for the size, the most direct way is <code>print(performance.mozMemory.gcBytes)</code> and <code>print(performance.mozMemory.mallocBytes)</code> (the latter is malloc bytes owned by GC things).</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Feb 16 2023 03:01:43 GMT-0800 (Pacific Standard Time)">11:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><a href="https://twitter.com/mhevery/status/1626002464469323777">https://twitter.com/mhevery/status/1626002464469323777</a> Sounds like we might have a lot of overhead on ICs compared to other engines.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Feb 16 2023 03:10:36 GMT-0800 (Pacific Standard Time)">11:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">the test case is a little funny</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Feb 16 2023 03:10:36 GMT-0800 (Pacific Standard Time)">11:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><a href="https://perf.builder.io/?q=eyJpZCI6Inh0a3l0czhvbDY5IiwidGl0bGUiOiJGaW5kaW5nIG51bWJlcnMgaW4gYW4gYXJyYXkiLCJiZWZvcmUiOiJjb25zdCBkYXRhID0gWzAsIDFdO1xuY29uc3QgZGF0YUludCA9IGRhdGEubWFwKHY9PjAtdik7XG5jb25zdCBkYXRhTWl4ID0gZGF0YS5tYXAodj0%2BLXYpO1xuXG5jb25zdCBsZW5ndGggPSAxMDA7XG5jb25zdCBpZHhJbnQgPSBbXTtcbmNvbnN0IGlkeE1peCA9IFtdO1xuZm9yKGxldCBpPTA7IGk8bGVuZ3RoOyBpKyspIHtcbiAgaWR4SW50LnB1c2goaSUyKTtcbiAgaWR4TWl4LnB1c2goLShpJTIpKTtcbn1cbiIsInRlc3RzIjpbeyJuYW1lIjoiSW5kZXggYXJyYXkgd2l0aCBJbnQiLCJjb2RlIjoibGV0IHN1bSA9IDA7XG5mb3IobGV0IGk9MDsgaTxsZW5ndGg7IGkrKykge1xuICBzdW0gKz0gZGF0YUludFtpZHhJbnRbaV1dO1xufSIsInJ1bnMiOltdLCJvcHMiOjQyOTkyMH0seyJuYW1lIjoiSW5kZXggYXJyYXkgd2l0aCBGbG9hdCIsImNvZGUiOiJsZXQgc3VtID0gMDtcbmZvcihsZXQgaT0wOyBpPGxlbmd0aDsgaSsrKSB7XG4gIHN1bSArPSBkYXRhTWl4W2lkeE1peFtpXV07XG59IiwicnVucyI6W10sIm9wcyI6ODc4NjB9XSwidXBkYXRlZCI6IjIwMjMtMDItMTZUMTE6MDg6MzAuNDU0WiJ9">https://perf.builder.io/?q=eyJpZCI6Inh0a3l0czhvbDY5IiwidGl0bGUiOiJGaW5kaW5nIG51bWJlcnMgaW4gYW4gYXJyYXkiLCJiZWZvcmUiOiJjb25zdCBkYXRhID0gWzAsIDFdO1xuY29uc3QgZGF0YUludCA9IGRhdGEubWFwKHY9PjAtdik7XG5jb25zdCBkYXRhTWl4ID0gZGF0YS5tYXAodj0%2BLXYpO1xuXG5jb25zdCBsZW5ndGggPSAxMDA7XG5jb25zdCBpZHhJbnQgPSBbXTtcbmNvbnN0IGlkeE1peCA9IFtdO1xuZm9yKGxldCBpPTA7IGk8bGVuZ3RoOyBpKyspIHtcbiAgaWR4SW50LnB1c2goaSUyKTtcbiAgaWR4TWl4LnB1c2goLShpJTIpKTtcbn1cbiIsInRlc3RzIjpbeyJuYW1lIjoiSW5kZXggYXJyYXkgd2l0aCBJbnQiLCJjb2RlIjoibGV0IHN1bSA9IDA7XG5mb3IobGV0IGk9MDsgaTxsZW5ndGg7IGkrKykge1xuICBzdW0gKz0gZGF0YUludFtpZHhJbnRbaV1dO1xufSIsInJ1bnMiOltdLCJvcHMiOjQyOTkyMH0seyJuYW1lIjoiSW5kZXggYXJyYXkgd2l0aCBGbG9hdCIsImNvZGUiOiJsZXQgc3VtID0gMDtcbmZvcihsZXQgaT0wOyBpPGxlbmd0aDsgaSsrKSB7XG4gIHN1bSArPSBkYXRhTWl4W2lkeE1peFtpXV07XG59IiwicnVucyI6W10sIm9wcyI6ODc4NjB9XSwidXBkYXRlZCI6IjIwMjMtMDItMTZUMTE6MDg6MzAuNDU0WiJ9</a></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Feb 16 2023 03:11:38 GMT-0800 (Pacific Standard Time)">11:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">It seems to be due to array traversal using negative numbers, the other doesn't apply the same transform (there is no negation). the behavior doesn't look right in either case</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Feb 16 2023 03:14:09 GMT-0800 (Pacific Standard Time)">11:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">If you flip the array traversal, then the first case does worse</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Feb 16 2023 03:20:34 GMT-0800 (Pacific Standard Time)">11:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">the problem is the <code>-(i%2)</code> creating <code>-0</code> as indexes, not the <code>0-v</code> or <code>-v</code> reported.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Feb 16 2023 03:21:36 GMT-0800 (Pacific Standard Time)">11:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"> * yes, i was just looking at this, but if you make the test fair this only makes a difference of 10%</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Feb 16 2023 03:21:49 GMT-0800 (Pacific Standard Time)">11:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><pre><code>  idxInt.push(0-(i%2));
  idxMix.push(-(i%2));
</code></pre>
<p>Reports 8% difference here, which sounds ok.</p>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Feb 16 2023 03:22:14 GMT-0800 (Pacific Standard Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">yeah i was just playing around with it.. </td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Feb 16 2023 03:22:25 GMT-0800 (Pacific Standard Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">it was 2% in a previous run and now i have it at 10%, thats a bit odd</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Feb 16 2023 03:22:34 GMT-0800 (Pacific Standard Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">So the problem seems to be indexing with negative numbers.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Feb 16 2023 03:22:45 GMT-0800 (Pacific Standard Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">or with non-existant properties.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Feb 16 2023 03:22:54 GMT-0800 (Pacific Standard Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">now it is at 4.. would need to be a more robust benchmark i think to see the real difference</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Feb 16 2023 03:23:30 GMT-0800 (Pacific Standard Time)">11:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">the top part with the negation doesn't seem to have a relevant impact. </td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Feb 16 2023 03:23:45 GMT-0800 (Pacific Standard Time)">11:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> or with non-existant properties.</blockquote></mx-reply>I was just thinking that... maybe we are doing worse with this.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Feb 16 2023 03:24:41 GMT-0800 (Pacific Standard Time)">11:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><p>Using:</p>
<pre><code>const dataInt = {"-1": -1, "0": 0, "1": 1};
const dataMix = {"-1": -1, "0": 0, "1": 1};
</code></pre>
<p>Reports the same difference (8% / 9%), thus invalidating the non-existence case. Thus this is the float to int conversion when doing accesses.</p>
</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Feb 16 2023 03:25:21 GMT-0800 (Pacific Standard Time)">11:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Or the undefined sum ???</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Feb 16 2023 03:25:23 GMT-0800 (Pacific Standard Time)">11:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">this is interesting:</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Feb 16 2023 03:25:44 GMT-0800 (Pacific Standard Time)">11:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">doesn't happen for a smaller gap probably because of data layout</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Feb 16 2023 03:27:01 GMT-0800 (Pacific Standard Time)">11:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><pre><code>const dataInt = {"-1": -1, "0": undefined, "1": 1};
const dataMix = {"-1": -1, "0": undefined, "1": 1};

const length = 100;
const idxInt = [];
const idxMix = [];
for(let i=0; i&lt;length; i++) {
  idxInt.push(i%2);
  idxMix.push(i%2-1);
}
</code></pre>
<p>reports 41% the performance on negative indexes.</p>
</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Feb 16 2023 03:29:20 GMT-0800 (Pacific Standard Time)">11:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><p>And the same difference (42%) on positive indexing but with Value sums instead of integer sums:</p>
<pre><code>const dataInt = {"-1": -1, "0": 0, "1": 1};
const dataMix = {"-1": -1, "0": undefined, "1": 1};
</code></pre>
</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Feb 16 2023 03:29:21 GMT-0800 (Pacific Standard Time)">11:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">so that will be 0 and -1, rather than -0 and -1</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Feb 16 2023 03:30:00 GMT-0800 (Pacific Standard Time)">11:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>And the same difference (42%) on positive indexing but with Value sums instead of integer sums:</p>
<pre><code>const dataInt = {"-1": -1, "0": 0, "1": 1};
const dataMix = {"-1": -1, "0": undefined, "1": 1};
</code></pre>
</blockquote></mx-reply>interesting</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Feb 16 2023 03:32:36 GMT-0800 (Pacific Standard Time)">11:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><p>So the performace cliff we are seeing is coming from 3 things:</p>
<ul>
<li>Using -1 as indexes (0.41)</li>
<li>Using additions with undefined properties (0.42)</li>
<li>And float conversion to integer while indexing (0.92)</li>
</ul>
<p>Which yield a score of ~0.16 of the original. I think we have all the root causes.</p>
</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Feb 16 2023 03:32:59 GMT-0800 (Pacific Standard Time)">11:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">neat</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Feb 16 2023 04:58:19 GMT-0800 (Pacific Standard Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">we are suuuper late but jan and i just posted an intro to mastodon: <a href="https://mastodon.social/@SpiderMonkey/109874524955427717">https://mastodon.social/@SpiderMonkey/109874524955427717</a></td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Feb 16 2023 04:58:27 GMT-0800 (Pacific Standard Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">in case anyone is active there and wants to retoot</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Feb 16 2023 05:02:48 GMT-0800 (Pacific Standard Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it's going viral, 6 retoots and 9 likes already</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Feb 16 2023 05:05:37 GMT-0800 (Pacific Standard Time)">13:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">not quite likes</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Feb 16 2023 05:05:50 GMT-0800 (Pacific Standard Time)">13:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">mastodon favourites don't really correlate 1:1 with twitter likes</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Feb 16 2023 05:07:51 GMT-0800 (Pacific Standard Time)">13:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">true, but close enough for this :-)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Feb 16 2023 05:12:02 GMT-0800 (Pacific Standard Time)">13:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it's nice that favorites are a lot more private than on twitter, where likes often show up in timelines similar to a retweet</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Feb 16 2023 09:41:03 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">I am having an issue.......basically I have a process where I have JS callback to log error we get from SM monkey. The issue I have is when I get the error "out of memory", and I construct the a JS object with the error message......and I get a core-dump on the object construction. I do a JS_NewObject(cx, NULL), I get back a new object, but as soon as I add something to it via a : JS_SetProperty , I get a core-dump. The simple answer in the case is........yeah don't do that, which I can live with, but what I am concerned about is properly handling the object construction, it seems I should be picking up some kind of error when I do that........which I am not. It seems that I should be checking something before the JS_SetProperty. </td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Feb 16 2023 09:43:17 GMT-0800 (Pacific Standard Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">This is the relevant stack, this is JS78, #0  js::gc::Cell::storeBuffer (this=&lt;optimized out&gt;) at js/js/src/gc/Cell.h:363
#1  js::HeapSlot::post (owner=0x3eacb0a70a40, kind=js::HeapSlot::Slot, slot=0, target=..., this=&lt;optimized out&gt;) at /js/js/src/gc/Barrier.h:885
#2  js::HeapSlot::set (this=&lt;optimized out&gt;, owner=0x3eacb0a70a40, kind=js::HeapSlot::Slot, slot=0, v=...) at js/js/src/gc/Barrier.h:873
#3  js::NativeObject::setSlot (this=0x3eacb0a70a40, slot=0, value=...) at js/js/src/vm/NativeObject.h:1014
#4  js::NativeObject::setSlotWithType (this=0x3eacb0a70a40, cx=0x34e4220, shape=0x3eacb0a8b9e8, value=..., overwriting=false) at js/js/src/vm/NativeObject-inl.h:480
#5  UpdateShapeTypeAndValueForWritableDataProp (cx=0x34e4220, obj=0x3eacb0a70a40, shape=0x3eacb0a8b9e8, value=..., id=...) at js/js/src/vm/NativeObject.cpp:1293
#6  AddDataProperty (cx=0x34e4220, obj=..., id=..., v=...) at js/js/src/vm/NativeObject.cpp:1511
#7  DefineNonexistentProperty (cx=0x34e4220, obj=..., id=..., v=..., result=...) at js/js/src/vm/NativeObject.cpp:2084
#8  SetNonexistentProperty&lt;(js::QualifiedBool)1&gt; (cx=0x34e4220, obj=..., id=..., v=..., receiver=..., result=...) at /js/js/src/vm/NativeObject.cpp:2722
#9  js::NativeSetProperty&lt;(js::QualifiedBool)1&gt; (cx=&lt;optimized out&gt;, cx@entry=0x34e4220, obj=obj@entry=..., id=..., v=v@entry=..., receiver=..., result=...) at js/js/src/vm/NativeObject.cpp:2852
#10 0x000000000096d79c in js::SetProperty (cx=0x34e4220, obj=..., id=..., v=..., receiver=..., result=...) at js/js/src/vm/ObjectOperations-inl.h:283
#11 JS_SetPropertyById (cx=0x34e4220, obj=..., id=..., v=...) at js/js/src/jsapi.cpp:2625
#12 JS_SetProperty (cx=0x34e4220, obj=..., name=0x3503b60 "message", v=...) js/js/src/jsapi.cpp:2635</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Feb 16 2023 09:48:36 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">dheitbrink</span>: can you share part of your code where you call <code>JS_NewObject</code>? note that it can return <code>nullptr</code> on OOM and you have to check for that</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Feb 16 2023 09:49:53 GMT-0800 (Pacific Standard Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell"><pre><code>auto ptr = JS_NewObject(cx, NULL);
if (!ptr) {
	throw std::bad_alloc();
}
</code></pre>
</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Feb 16 2023 09:50:03 GMT-0800 (Pacific Standard Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">also, are you using an <code>--enable-debug</code> build? that's highly recommended because we have many debug assertions to catch issues</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Feb 16 2023 09:53:39 GMT-0800 (Pacific Standard Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">Yeah I have not yet run it with that, that was my next step......but on the flip side, I would not want to rely on that in production</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Feb 16 2023 09:54:47 GMT-0800 (Pacific Standard Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">oh definitely, it's just an easy way to catch issues related to misusing JSAPI functions while developing</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Feb 16 2023 10:00:31 GMT-0800 (Pacific Standard Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell"><p>After I construct the object, I to created a PersistentRootedObject, to hold it with something like:</p>
<p>typedef std::unique_ptr<a href="JS::RootedObject">JS::RootedObject</a> TObjRef;<br>std::vector&lt;TObjRef&gt; _ObjectStore;<br>_ObjectStore.emplace_back(new JS::PersistentRootedObject(cx, ptr));</p>
<p>Under normal conditions I have not had an issue with this, I am not sure that would make a difference</p>
</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Feb 16 2023 10:14:01 GMT-0800 (Pacific Standard Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@fabrice:mozilla.org">fabrice</span>&gt;</div></td><td class="msg-cell">What happened around Feb 9 that explains the changes in <a href="https://arewefastyet.com/linux64/benchmarks/overview?numDays=60">https://arewefastyet.com/linux64/benchmarks/overview?numDays=60</a> ?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Feb 16 2023 10:15:45 GMT-0800 (Pacific Standard Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">fabrice</span>: The test machines had a firmware update with new CPU microcode</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Feb 16 2023 10:16:47 GMT-0800 (Pacific Standard Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Unclear why impact is so high, but machines are 6 years old and running old OSes. The spectre mitigations might have favoured security </td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Feb 16 2023 10:17:19 GMT-0800 (Pacific Standard Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@fabrice:mozilla.org">fabrice</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Unclear why impact is so high, but machines are 6 years old and running old OSes. The spectre mitigations might have favoured security </blockquote></mx-reply>ok, thanks!</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Feb 16 2023 10:18:38 GMT-0800 (Pacific Standard Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">dheitbrink</span>: not related to your problem, but a PersistentRooted&lt;GCVector&lt;JSObject*&gt;&gt; will be more efficient than a vector&lt;PersistentRooted&lt;JSObject*&gt;&gt;</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Feb 16 2023 10:20:04 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">(leaving now but will be around tomorrow if you still have problems)</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Feb 16 2023 12:47:57 GMT-0800 (Pacific Standard Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Are there any examples using <code>JS::MapEntries</code>? I'm confused how you would loop through it and obtain the key + value</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Feb 16 2023 13:21:32 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>?</p>
<pre><code class="language-c++">    JS::RootedValue entries(ctx);
    JS::MapEntries(ctx, mapObj, entries);
    RootedValue pair(ctx);
    pair = MapIteratorObject::createResultPair(ctx);
    while (!MapIteratorObject::next(entries, pair, ctx)) {
        std::cout &lt;&lt; "hi\n";
    }

</code></pre>
</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Feb 16 2023 14:00:26 GMT-0800 (Pacific Standard Time)">22:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I suppose I won't be able to use MapIteratorObject and what not as it's not in <code>js/public</code></td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Feb 16 2023 14:03:12 GMT-0800 (Pacific Standard Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: I think you could use the ForOfIterator on the entries value: <a href="https://searchfox.org/mozilla-central/source/js/public/ForOfIterator.h#30">https://searchfox.org/mozilla-central/source/js/public/ForOfIterator.h#30</a></td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Feb 16 2023 14:07:23 GMT-0800 (Pacific Standard Time)">22:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Thanks evilpie, will give it a try</td></tr>

</tbody></table></div></div></div>
</body></html>