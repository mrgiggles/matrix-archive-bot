<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-02-10</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-02-10<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-02-09" class="nav-link"><span>prev</span></a>
<a href="2023-02-12" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Feb 10 2023 06:55:42 GMT-0800 (Pacific Standard Time)">14:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">is e5e5e5e5e5e5e5e5 some kind of magic pattern for spidermonkey?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Feb 10 2023 06:56:14 GMT-0800 (Pacific Standard Time)">14:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">Yes</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Feb 10 2023 06:56:33 GMT-0800 (Pacific Standard Time)">14:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">I would have asked firebot, but I don't think it's around anymore</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Feb 10 2023 06:57:34 GMT-0800 (Pacific Standard Time)">14:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>0xE5E5E5E5: "jemalloc freed memory",</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Feb 10 2023 07:00:38 GMT-0800 (Pacific Standard Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">thanks, I'll file a bug</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Feb 10 2023 07:01:04 GMT-0800 (Pacific Standard Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">So I have a shell version of backbone-TodoMVC.js</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Feb 10 2023 07:02:10 GMT-0800 (Pacific Standard Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">running SM with <code>--spectre-mitigations=off --no-ion --no-blinterp --no-baseline index.js</code> gives 300ms</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Feb 10 2023 07:02:45 GMT-0800 (Pacific Standard Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">V8 with <code>--jitless</code> is 90ms</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Feb 10 2023 07:03:02 GMT-0800 (Pacific Standard Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">V8 with <code>--jitless --no-use-ic</code> is 205ms</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Feb 10 2023 07:03:43 GMT-0800 (Pacific Standard Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">JSC with <code>--useJIT=false</code> is 163ms</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Feb 10 2023 07:03:51 GMT-0800 (Pacific Standard Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">are these numbers surprising or expected?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Feb 10 2023 07:12:13 GMT-0800 (Pacific Standard Time)">15:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">my concern is that slow interpretation is causing us to tier up less quickly. See:
V8: <a href="https://share.firefox.dev/3HJmsrW">https://share.firefox.dev/3HJmsrW</a>
SM: <a href="https://share.firefox.dev/3lhtrAS">https://share.firefox.dev/3lhtrAS</a></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Feb 10 2023 07:13:43 GMT-0800 (Pacific Standard Time)">15:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">those profiles represent the same amount of time (65ms) so you can switch tabs to get a sense of the what the jit tiering looks like</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Feb 10 2023 07:14:47 GMT-0800 (Pacific Standard Time)">15:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">V8 seems to be running a lot more in baseline noticeably earlier</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Feb 10 2023 07:28:54 GMT-0800 (Pacific Standard Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: does <code>--blinterp-eager</code> make a difference?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Feb 10 2023 07:35:07 GMT-0800 (Pacific Standard Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: I'll check</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Feb 10 2023 07:37:33 GMT-0800 (Pacific Standard Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the numbers are not unexpected though, we haven't optimized our C++ interpreter a lot lately. V8/JSC generate theirs similar to our blinterp</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Feb 10 2023 07:38:58 GMT-0800 (Pacific Standard Time)">15:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: --blinterp-eager does seem to help a little</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Feb 10 2023 07:40:19 GMT-0800 (Pacific Standard Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: here's the corresponding profile: <a href="https://share.firefox.dev/3ltMQi4">https://share.firefox.dev/3ltMQi4</a></td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Feb 10 2023 07:41:22 GMT-0800 (Pacific Standard Time)">15:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: why isn't <code>--blinterp-eager</code> the default?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Feb 10 2023 07:44:07 GMT-0800 (Pacific Standard Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: a lot of scripts on the web are very cold, like 1 or 2 calls/iterations, so there <code>--blinterp-eager</code> could be slower because we now have to allocate a <code>JitScript</code> to store the IC data. We've made this a lot faster though so we could consider lowering the blinterp threshold (<code>--blinterp-warmup-threshold=N</code>)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Feb 10 2023 07:45:22 GMT-0800 (Pacific Standard Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: do you know if V8 always uses ICs in their interpreter?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Feb 10 2023 07:46:08 GMT-0800 (Pacific Standard Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">also could we run blinterp without storing IC data?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Feb 10 2023 07:47:45 GMT-0800 (Pacific Standard Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">*Not sure if V8 has a non-IC interpreter mode.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Feb 10 2023 07:53:19 GMT-0800 (Pacific Standard Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: I don't understand your response</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Feb 10 2023 07:55:35 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">sorry, fixed</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Feb 10 2023 07:57:27 GMT-0800 (Pacific Standard Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: we've talked about it some (an IC-less version of blinterp), but to not be stuck with VM call overhead it would probably need some manual optimizations. The C++ interpreter gets inlining like that for free</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Feb 10 2023 07:58:18 GMT-0800 (Pacific Standard Time)">15:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">but with <code>--blinterp-eager</code> there are likely to be a lot more ICs where we attach a stub but then never use it</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Feb 10 2023 07:59:38 GMT-0800 (Pacific Standard Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">(the C++ interpreter has perf overhead elsewhere though.. it can't use the fast JIT =&gt; JIT call ABI)</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Feb 10 2023 08:10:33 GMT-0800 (Pacific Standard Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">why is that? and could we fix it somehow?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Feb 10 2023 08:14:52 GMT-0800 (Pacific Standard Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">am I allowed to do this? <code>JSNative wrapper = [inFunc](JSContext* ctx, unsigned argc, JS::Value* vp) -&gt; bool {</code> trying to pass off a lambda to <code>JSFunction* func = JS_DefineFunction(ctx, global, funcName.c_str(), &amp;wrapper, sizeof...(Args), 0);</code></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Feb 10 2023 08:15:21 GMT-0800 (Pacific Standard Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">and will it also not work because the lambda will fall off the stack and die?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Feb 10 2023 08:16:31 GMT-0800 (Pacific Standard Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">(meeting..)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Feb 10 2023 08:18:41 GMT-0800 (Pacific Standard Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">basically trying to create and bind a C++ JSNative function wrapping around a <code>std::function</code></td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Feb 10 2023 08:29:09 GMT-0800 (Pacific Standard Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">For fun, I ran the same test in quickjs and I get 192ms</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Feb 10 2023 08:34:02 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: why does not exposing script source objects fix that crash?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Feb 10 2023 08:36:13 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: the testing function tries to expose it to JS, but it has to wrap it for that, so we assert there</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Feb 10 2023 08:42:31 GMT-0800 (Pacific Standard Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: oh right, I wasn't familiar with Node::exposeToJS. "If this node refers to something that can be represented as a JavaScript value that is safe to expose to JavaScript code, return that value" - I expected this to be the same as ExposeValueToActiveJS</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Feb 10 2023 08:43:53 GMT-0800 (Pacific Standard Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: oh yeah the name is ambiguous unfortunately</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Feb 10 2023 09:28:22 GMT-0800 (Pacific Standard Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> am I allowed to do this? <code>JSNative wrapper = [inFunc](JSContext* ctx, unsigned argc, JS::Value* vp) -&gt; bool {</code> trying to pass off a lambda to <code>JSFunction* func = JS_DefineFunction(ctx, global, funcName.c_str(), &amp;wrapper, sizeof...(Args), 0);</code></blockquote></mx-reply>I don't think that'll work, because with C function pointers there's no place to pass in the closure with captured variables</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Feb 10 2023 09:30:06 GMT-0800 (Pacific Standard Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: the quickjs interpreter is more optimized because they don't have a jit and their bytecode is tuned for that. We've made things easier for the JITs by splitting up bytecode ops for example, but that makes interpreting a bit slower</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Feb 10 2023 09:32:39 GMT-0800 (Pacific Standard Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it's two different worlds: we need some bookkeeping and/or trampolines to enter/leave JIT code. Things like saving volatile registers so the JITs can use all registers etc</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Feb 10 2023 09:33:10 GMT-0800 (Pacific Standard Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">once we're in JIT code it's easy to make fast calls to other JITted functions because we can just push the arguments on the stack with some metadata and call the function's JIT pointer</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Feb 10 2023 09:34:48 GMT-0800 (Pacific Standard Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">we could potentially optimize the JIT &lt;-&gt; C++ interpreter transitions a bit more, but there's not a ton of low-hanging fruit - there's a bunch of necessary state we need to maintain for stack walking, gc etc when entering/leaving</td></tr>

</tbody></table></div></div></div>
</body></html>