<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-07-18</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-07-18<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-07-17" class="nav-link"><span>prev</span></a>
<a href="2024-07-19" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Jul 18 2024 09:15:09 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: for the workers GC case, doesn't allocation triggered GC prevent us from OOMing?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jul 18 2024 09:15:39 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe today it does</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jul 18 2024 09:15:51 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">there were some older bugs where we were OOMing from malloc memory that wasn't getting cleaned up</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jul 18 2024 09:16:16 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but that's a great point, with the new accounting you added, that may just not be a problem now</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jul 18 2024 09:17:56 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">yeah, that could have been because the memory wasn't properly associated with a GC thing</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jul 18 2024 11:13:36 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@josh-cena:mozilla.org">josh-cena</span>&gt;</div></td><td class="msg-cell">Hi! I want to ask about the <code>preserveWrapperCallback</code> function, which is used to deny native wrappers from being weakly held. I searched the code but it's not clear to me which objects possess it. I also looked up old bugs and I saw <code>navigator</code> and <code>MouseEvent</code> being mentioned, but they can be weakly held now. Which objects does this apply to?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jul 18 2024 11:16:24 GMT-0700 (Pacific Daylight Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Hi! I want to ask about the <code>preserveWrapperCallback</code> function, which is used to deny native wrappers from being weakly held. I searched the code but it's not clear to me which objects possess it. I also looked up old bugs and I saw <code>navigator</code> and <code>MouseEvent</code> being mentioned, but they can be weakly held now. Which objects does this apply to?</blockquote></mx-reply>That's more of a <a href="https://matrix.to/#/#dom:mozilla.org">#dom:mozilla.org</a> question. Wrapper preservation is implemented for objects that inherit from nsWrapperCache. More or less it applies to all WebIDL objects, though not ones where aren't going to get a strong reference from the C++ object. I'm not too sure of the specifics.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jul 18 2024 11:19:41 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@josh-cena:mozilla.org">josh-cena</span>&gt;</div></td><td class="msg-cell">Ah I see. I'll ask there instead.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jul 18 2024 13:57:18 GMT-0700 (Pacific Daylight Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">WIll calls to JS::TraceEdge fail if they execute on the wrong thread?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jul 18 2024 13:59:20 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Some phases of GC are multithreaded and may call trace methods from background threads.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jul 18 2024 14:01:44 GMT-0700 (Pacific Daylight Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">So, does it matter which thread I call js::TraceEdge on?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jul 18 2024 14:02:15 GMT-0700 (Pacific Daylight Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You shouldn't be calling TraceEdge outside of trace methods, which the GC is responsible for calling.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jul 18 2024 14:04:27 GMT-0700 (Pacific Daylight Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">of course.  I'm calling them inside trace methods, but I think JS_GC was called from a thread that isn't the same as the one where the context was created.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jul 18 2024 14:05:12 GMT-0700 (Pacific Daylight Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, that's the mistake</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jul 18 2024 14:05:43 GMT-0700 (Pacific Daylight Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">A JSContext is per-thread</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jul 18 2024 14:06:08 GMT-0700 (Pacific Daylight Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Somehow this error only started causing problems once I added tracing.  JS_GC calls seemed to work from the other thread before that.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Jul 18 2024 14:06:09 GMT-0700 (Pacific Daylight Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You mostly shouldn't be touching it from any other thread</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Jul 18 2024 14:06:48 GMT-0700 (Pacific Daylight Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in a DEBUG build, I would expect it to crash from a <a href="https://searchfox.org/mozilla-central/rev/b220e40ff2ee3d10ce68e07d8a8a577d5558e2a2/js/src/gc/GCAPI.cpp#52">nullptr exception</a></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Jul 18 2024 14:09:36 GMT-0700 (Pacific Daylight Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">("it" == calling JS_GC)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Jul 18 2024 14:34:43 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">So, if we're not operating on a debug build, it could hypothetically work, but it's dangerous.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Jul 18 2024 14:35:00 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Which might explain how we've been getting away with it.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Jul 18 2024 14:38:09 GMT-0700 (Pacific Daylight Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It is honestly surprising to me that it ever worked</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Jul 18 2024 14:39:55 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Yeah.  It only showed up after we included tracing.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Jul 18 2024 14:44:22 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Wait a minute.  If I recall correctly, I got around this issue last time by using JSCLASS_FOREGROUND_FINALIZE instead of JSCLASS_BACKGROUND_FINALIZE</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Jul 18 2024 15:24:16 GMT-0700 (Pacific Daylight Time)">22:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">That's only for finalization. Calling GC off the main thread is only going to work coincidentally, especially if the main thread is doing anything that could read or write JS-related data in the meantime. (Not just data actually in the JS heap, but also malloced data that is consulted or freed based on JS heap data.) There are some places that will grab things from thread local storage that'll crash, but only when you use the sort of object that does that.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Jul 18 2024 15:25:39 GMT-0700 (Pacific Daylight Time)">22:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">It probably wouldn't be horrendously hard to make it work to call GC off the main thread as long as the main thread is paused, but it also would be unlikely to help. (If you had something else that could run in that time that was guaranteed to never look at any shared data, then you could probably run <em>it</em> off the main thread instead.)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Jul 18 2024 15:26:35 GMT-0700 (Pacific Daylight Time)">22:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It probably wouldn't be horrendously hard to make it work to call GC off the main thread as long as the main thread is paused, but it also would be unlikely to help. (If you had something else that could run in that time that was guaranteed to never look at any shared data, then you could probably run <em>it</em> off the main thread instead.)</blockquote></mx-reply>Thinking fondly back to when the CC sort of did that.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Jul 18 2024 15:27:13 GMT-0700 (Pacific Daylight Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, we tried to do something similar for GC and painting, I think it was?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Jul 18 2024 15:28:11 GMT-0700 (Pacific Daylight Time)">22:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I thought that was on the main thread but I could be wrong.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Jul 18 2024 15:28:46 GMT-0700 (Pacific Daylight Time)">22:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">For the CC the argument was it would get you different cache stuff so the traversal wouldn't mess up the cache of the regular program. I'm not sure there was any actual evidence that worked.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Jul 18 2024 15:29:02 GMT-0700 (Pacific Daylight Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh!</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Jul 18 2024 15:29:56 GMT-0700 (Pacific Daylight Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but, er, if it's just a different thread, aren't all the caches past L1 shared anyway?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Jul 18 2024 15:30:03 GMT-0700 (Pacific Daylight Time)">22:30</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-12" title="@sfink:mozilla.org">sfink</span></div></td><td class="msg-cell">reveals his ignorance</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Jul 18 2024 15:30:18 GMT-0700 (Pacific Daylight Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It varies by chip</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Jul 18 2024 15:31:30 GMT-0700 (Pacific Daylight Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh yeah, my laptop and desktop both have core-specific L1 and L2, and shared L3</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Jul 18 2024 15:31:38 GMT-0700 (Pacific Daylight Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think usually L1 and L2 are private, and L3 is shared</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Jul 18 2024 15:31:40 GMT-0700 (Pacific Daylight Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Jul 18 2024 15:32:04 GMT-0700 (Pacific Daylight Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">well, not globally shared L3, sets of 4 cores share the L3</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Jul 18 2024 15:33:08 GMT-0700 (Pacific Daylight Time)">22:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(I'm playing with this nifty <code>lstopo</code> command that I just learned about last week)</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Jul 18 2024 15:34:05 GMT-0700 (Pacific Daylight Time)">22:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh cool!</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Jul 18 2024 15:34:33 GMT-0700 (Pacific Daylight Time)">22:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">on Fedora, it's from a package named <code>hwloc-gui</code></td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Jul 18 2024 15:34:47 GMT-0700 (Pacific Daylight Time)">22:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, I got it on Ubuntu from <code>hwloc</code></td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Jul 18 2024 15:40:13 GMT-0700 (Pacific Daylight Time)">22:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Looks like I have two power cores with their own dedicated L1/L2 caches, then eight efficiency cores clustered into two shared L2 caches, and then the whole L3 is shared.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Jul 18 2024 15:40:37 GMT-0700 (Pacific Daylight Time)">22:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So I guess whether the L2 is shared varies even within a chip</td></tr>

</tbody></table></div></div></div>
</body></html>