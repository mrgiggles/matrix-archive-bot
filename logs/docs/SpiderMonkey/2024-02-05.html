<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-02-05</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-02-05<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-02-01" class="nav-link"><span>prev</span></a>
<a href="2024-02-06" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Feb 05 2024 03:35:26 GMT-0800 (Pacific Standard Time)">11:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: oh, parallel thingie.  We use TaskController threads for it?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Feb 05 2024 03:35:42 GMT-0800 (Pacific Standard Time)">11:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I mean the same stuff GC has used for now already, right?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Feb 05 2024 03:41:50 GMT-0800 (Pacific Standard Time)">11:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: yes we do</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Feb 05 2024 03:43:22 GMT-0800 (Pacific Standard Time)">11:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I haven't yet thought too much how that affects the overall GC scheduling</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Feb 05 2024 03:43:32 GMT-0800 (Pacific Standard Time)">11:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: do we have some stress test for that code?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Feb 05 2024 03:43:46 GMT-0800 (Pacific Standard Time)">11:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'm just pondering whether we should tweak the number of TaskController threads</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Feb 05 2024 03:44:43 GMT-0800 (Pacific Standard Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">stress tests for marking or for the helper thread system?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Feb 05 2024 03:45:04 GMT-0800 (Pacific Standard Time)">11:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">parallel marking has been enabled for some JS / jit test builds for a while now</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Feb 05 2024 03:45:46 GMT-0800 (Pacific Standard Time)">11:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'm thinking some test running in browser. I guess speedometer should be quite good</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Feb 05 2024 03:49:15 GMT-0800 (Pacific Standard Time)">11:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">perhaps this code isn't quite as parallel as stylo, where ensuring we don't use too many threads is good for performance</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Feb 05 2024 03:49:26 GMT-0800 (Pacific Standard Time)">11:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">no, it uses two threads max</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Feb 05 2024 03:50:39 GMT-0800 (Pacific Standard Time)">11:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Using more threads is future investigation. Two threads gives a good improvement without the problems of using too many threads.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Feb 05 2024 03:56:18 GMT-0800 (Pacific Standard Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">(the current approach doesn't scale well beyond two threads either)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Feb 05 2024 03:56:19 GMT-0800 (Pacific Standard Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: does GC somehow split the work to two equal parts and let threads go through them, or is it more like whichever is faster, ends up doing more work?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Feb 05 2024 03:56:59 GMT-0800 (Pacific Standard Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">a thread can request more work from another thread when it runs out</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Feb 05 2024 03:57:12 GMT-0800 (Pacific Standard Time)">11:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">work is split initially</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Feb 05 2024 04:00:42 GMT-0800 (Pacific Standard Time)">12:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">that sounds good. I was just thinking about the case where one thread (probably the main thread) is running on a p-core and a taskcontroller thread on an e-core.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Feb 05 2024 04:06:59 GMT-0800 (Pacific Standard Time)">12:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">yes, that is not great (parallel marking has some overhead so if we get a e-core we might see lower performance overall)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Feb 05 2024 04:07:33 GMT-0800 (Pacific Standard Time)">12:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">ideally we would be able to request p cores for task controller tasks as presumably this is a problem for other users of this system too</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Feb 05 2024 04:07:40 GMT-0800 (Pacific Standard Time)">12:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">do you know if that's a known issue?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Feb 05 2024 04:09:19 GMT-0800 (Pacific Standard Time)">12:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'm not aware of too good APIs to request use of p-cores</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Feb 05 2024 04:09:54 GMT-0800 (Pacific Standard Time)">12:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">We do use the information about how many and which kinds of cores there are in couple of places, on some OSes</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Feb 05 2024 04:12:19 GMT-0800 (Pacific Standard Time)">12:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">So far the most effective part there has been to limit the number of parallel threads, so that at least in theory we could run everything on p/big + mid-perf cores, and avoid e-cores</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Feb 05 2024 04:12:41 GMT-0800 (Pacific Standard Time)">12:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(On Android the cpu configurations do vary <em>a_lot</em>)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Feb 05 2024 12:22:46 GMT-0800 (Pacific Standard Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: do you think there might be something CC could reuse to speedup traversing through GCThings?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Feb 05 2024 15:35:31 GMT-0800 (Pacific Standard Time)">23:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">hey everyone!<br>a small question: I have a custom method that creates a promise that is resolved later in native code (e.g. <code>AsyncLoadStuff()</code>). This async work might fail in native code, which I need to translate to JS error.<br>Is there a way to somehow get JS backtrace info during <code>AsyncLoadStuff()</code> invocation, so that I could it save it somewhere and pass it latee to JS error?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Feb 05 2024 15:37:03 GMT-0800 (Pacific Standard Time)">23:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> hey everyone!<br>a small question: I have a custom method that creates a promise that is resolved later in native code (e.g. <code>AsyncLoadStuff()</code>). This async work might fail in native code, which I need to translate to JS error.<br>Is there a way to somehow get JS backtrace info during <code>AsyncLoadStuff()</code> invocation, so that I could it save it somewhere and pass it latee to JS error?</blockquote></mx-reply>(because such errors result in stackless exceptions, which is not user-friendly :))</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Feb 05 2024 15:37:29 GMT-0800 (Pacific Standard Time)">23:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS::GetPendingExceptionStack</code> and <code>JS::SetPendingExceptionStack</code> in <a href="https://searchfox.org/mozilla-central/rev/896042a1a71066254ceb5291f016ca3dbca21cb7/js/public/Exception.h#162-177">Exception.h</a> maybe?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Feb 05 2024 15:38:56 GMT-0800 (Pacific Standard Time)">23:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">that's the problem: I don't have an exception yet during JS method invocation. Error happens only afterwards, in off-thread native code.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Feb 05 2024 15:40:21 GMT-0800 (Pacific Standard Time)">23:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">i.e. I have only native error, which I need to convert to JS error (and imbue it with information about the place where the original method was invoked)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Feb 05 2024 15:44:29 GMT-0800 (Pacific Standard Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the exception is reported against the original method's stack, simple workaround would be to temporarily report exception and get and clear it.   the other option would be to generate async stack and apply it to the stack for the error reported later.  let me check where the API is</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Feb 05 2024 15:46:49 GMT-0800 (Pacific Standard Time)">23:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/896042a1a71066254ceb5291f016ca3dbca21cb7/js/public/Stack.h#182">JS::CaptureCurrentStack</a> to capture, and then <a href="https://searchfox.org/mozilla-central/rev/896042a1a71066254ceb5291f016ca3dbca21cb7/js/src/jsapi.h#755">JS::AutoSetAsyncStackForNewCalls</a> to apply the stack</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Feb 05 2024 15:47:24 GMT-0800 (Pacific Standard Time)">23:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and report an error inside its scope</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Feb 05 2024 15:47:48 GMT-0800 (Pacific Standard Time)">23:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">that's exactly what I was looking for!
thanks!</td></tr>

</tbody></table></div></div></div>
</body></html>