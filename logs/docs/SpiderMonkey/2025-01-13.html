<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-01-13</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-01-13<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-01-12" class="nav-link"><span>prev</span></a>
<a href="2025-01-14" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jan 13 2025 04:47:02 GMT-0800 (Pacific Standard Time)">12:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">Hi, is it expected that if I have a loop that simply copies 100k integers from a float32 array to another one, it can be about 40% faster to unroll manually the body of the loop by eg 16x, in current nightly? I think I do enough iteration / filtering to have the fastest jit to kick in, and filter out outliers. Chrome shows 25% improvement as well</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jan 13 2025 04:47:45 GMT-0800 (Pacific Standard Time)">12:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><a href="https://paul.cx/public/bench-unroll.html">https://paul.cx/public/bench-unroll.html</a> has some code</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jan 13 2025 04:48:25 GMT-0800 (Pacific Standard Time)">12:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I'd use <code>set</code> on the array, except this requires views to copy with offsets, and so this create objects, and so it's not appropriate to use in an AudioWorklet</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jan 13 2025 04:48:42 GMT-0800 (Pacific Standard Time)">12:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">We have no loop unrolling at the moment, this has been an expriment a while back, but it never made it past the experiment stage.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jan 13 2025 04:54:29 GMT-0800 (Pacific Standard Time)">12:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">ok, what I'm hearing is that this is something to consider to get some performance in a library I'm writing</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jan 13 2025 04:54:34 GMT-0800 (Pacific Standard Time)">12:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">in the current state of things</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jan 13 2025 05:21:30 GMT-0800 (Pacific Standard Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mayankleoboy1:mozilla.org">mayankleoboy1</span>&gt;</div></td><td class="msg-cell">bug 1039458</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jan 13 2025 05:21:32 GMT-0800 (Pacific Standard Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1039458">https://bugzil.la/1039458</a> — RESOLVED (bhackett1024) — Unroll tight loops</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jan 13 2025 05:25:40 GMT-0800 (Pacific Standard Time)">13:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">thanks mayank. on the machines I've tested, Firefox is faster than Chrome when unrolled manually (~10% faster), slower than Chrome when not unrolling (8% slower)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jan 13 2025 05:51:56 GMT-0800 (Pacific Standard Time)">13:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">For what is worth, this might be easy as a code generation within a JS library, with high potential for logic optimization which might not be possible within a JS compiler.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jan 13 2025 05:56:22 GMT-0800 (Pacific Standard Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">padenot</span>: Thanks for finding this, I hadn't thought to try this when I was optimizing loops over typed arrays in the profiler. It might help in a few places.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jan 13 2025 06:14:26 GMT-0800 (Pacific Standard Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: it's a user of <a href="https://github.com/padenot/ringbuf.js">https://github.com/padenot/ringbuf.js</a> that tried it, unrolling by 4, and then I tried 16x because why not</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jan 13 2025 06:15:01 GMT-0800 (Pacific Standard Time)">14:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: yeah fairly trivial in my case to do it on our side, it really is just a <code>memcpy</code>, I figured I'd mention it here anyway</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jan 13 2025 06:15:59 GMT-0800 (Pacific Standard Time)">14:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I wonder if there are further tricks we could use e.g. copying pairs of f32 as uint64_t</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jan 13 2025 06:22:40 GMT-0800 (Pacific Standard Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">From a typed array this might be possible, but from an ordinary array, while I drafted something 13 years ago … this is doable, but handling bailouts waste most of the benefits.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jan 13 2025 06:24:31 GMT-0800 (Pacific Standard Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I only deal w/ typed arrays, this is in the context of real-time audio processing and all the APIs in the area deal with typed array, and almost always f32</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jan 13 2025 06:30:21 GMT-0800 (Pacific Standard Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">you copy from typedarray to another typedarray of the same type?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jan 13 2025 06:31:05 GMT-0800 (Pacific Standard Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">oh right, why not use <code>set</code></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jan 13 2025 06:41:30 GMT-0800 (Pacific Standard Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">as said initially, when copying w/ offset, <code>set</code> requires the use of views, that creates an object, and that leads to gc</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jan 13 2025 06:44:07 GMT-0800 (Pacific Standard Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">oops, sorry, I missed that message</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jan 13 2025 06:44:38 GMT-0800 (Pacific Standard Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">in a typical workload with this library, we'd be able to use <code>set</code> in ~28% of copy operations</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jan 13 2025 06:45:13 GMT-0800 (Pacific Standard Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">the problem being that it means that some operations will be fast, some will be slow, which is really something you want to avoid in real-time programming</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jan 13 2025 07:27:53 GMT-0800 (Pacific Standard Time)">15:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: it's a task. But <code>scheduler.yield()</code> also dispatches a task, so the promise won't be resolved until this task is run</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jan 13 2025 07:29:54 GMT-0800 (Pacific Standard Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, okay.  then it would depend on the order of those tasks?  do we know the current order?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jan 13 2025 07:30:44 GMT-0800 (Pacific Standard Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, does the scheduler.yield's task have mictotask checkpoint?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jan 13 2025 07:35:31 GMT-0800 (Pacific Standard Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hmm, maybe I'm missing something.  how does the testcase expect that order?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jan 13 2025 07:37:57 GMT-0800 (Pacific Standard Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the yield's task runs out of order?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jan 13 2025 07:50:24 GMT-0800 (Pacific Standard Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: so the ordering for <code>task</code> is not super clear defined, blink has some notes about this and we plan to align that (or whatever makes sense). However, I don't think this relates to this particular test</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Jan 13 2025 07:52:05 GMT-0800 (Pacific Standard Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">we have three setTimeout handlers here, and when the first one runs, <code>scheduler.yield()</code> will dispatch a task for its promise, and it won't be resolved until the rest of the setTimeout handlers are run</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Jan 13 2025 07:52:43 GMT-0800 (Pacific Standard Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">so I think this test seems wrong</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Jan 13 2025 07:53:40 GMT-0800 (Pacific Standard Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, unless there's something that requires the out-of-order-ness for the yield's task, the test's expectation doesn't make sense</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Jan 13 2025 07:54:20 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the test is correct, it would be nice to have a comment that describes the reasoning behind the order</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Jan 13 2025 07:54:43 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">yeah, okay, I'll ask this to the spec author </td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Jan 13 2025 07:54:44 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">thanks! </td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Jan 13 2025 07:54:45 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(some magic around the setTimeout handling or nesting, or something around that?)</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Jan 13 2025 09:59:09 GMT-0800 (Pacific Standard Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it would be nice if <code>new Uint8Array(b1).set(new Uint8Array(b2))</code> could optimize away the temporary views, but that seems complex. (It would be conditional on some jerk doing <code>Uint8Array.prototype.set = () =&gt; console.log("hello world")</code> for example.)</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Jan 13 2025 10:38:36 GMT-0800 (Pacific Standard Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: unrelated to my previous question - I am a bit skeptical about if I handle the life time of the scheduling state object correct, especially when it is set to the hostdefined object and being kept in the PromiseJobRunnable</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Jan 13 2025 10:39:31 GMT-0800 (Pacific Standard Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">do you mind give it quick check? Here's the <a href="https://phabricator.services.mozilla.com/D234071">patch</a>. It's causing some a <a href="https://treeherder.mozilla.org/jobs?repo=try&amp;author=sefeng%40mozilla.com&amp;selectedTaskRun=WfCz0XSHTISOIxtcnROuxw.0">crash</a></td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Jan 13 2025 10:43:50 GMT-0800 (Pacific Standard Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">sefeng</span>:   can you give me an access to the patch? I'll look into it today</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Jan 13 2025 10:44:27 GMT-0800 (Pacific Standard Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">access granted (I thought it was a public patch..)</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon Jan 13 2025 10:51:31 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">So, the <code>WebTaskSchedulingState</code> is a ref-counted object, right?  in that case, you're supposed to AddRef it when storing the pointer to <code>SCHEDULING_STATE_SLOT</code>.  and then Release when resetting the slot to undefined</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon Jan 13 2025 10:52:28 GMT-0800 (Pacific Standard Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">PrivateValue behaves like a raw pointer.  the ref-count part needs to be performed manually</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon Jan 13 2025 10:55:21 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">okay, that makes sense. Let me try that</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Mon Jan 13 2025 10:55:29 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, the crash sounds like caused by accesses on it from multiple threads.  is it supposed to happen?  if so, I think you need to mark it thread safe somehow</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Mon Jan 13 2025 10:55:44 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">possibly the NS_SOMETHING part ?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Mon Jan 13 2025 10:56:08 GMT-0800 (Pacific Standard Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">yeah, that's something I don't know. It's also a CC participant </td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Mon Jan 13 2025 10:56:11 GMT-0800 (Pacific Standard Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">isn't it main thread only?</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Mon Jan 13 2025 10:57:47 GMT-0800 (Pacific Standard Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't know much about CC, but the crash happens on main thread. so it sounds like the instance is created off main thread, or perhaps the data is already corrupted at that point</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Mon Jan 13 2025 10:58:23 GMT-0800 (Pacific Standard Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">perhaps...I am going to try to fix the ref count, hope it'll also fix that </td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Mon Jan 13 2025 10:58:35 GMT-0800 (Pacific Standard Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">If the crash keeps happening after the ref-count part fixed, try checking the stack of the <code>new</code> call</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Mon Jan 13 2025 11:57:13 GMT-0800 (Pacific Standard Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dminor:mozilla.org">dminor</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-2">padenot</span>: <a href="https://github.com/tc39/proposal-immutable-arraybuffer">https://github.com/tc39/proposal-immutable-arraybuffer</a> is up for Stage 2.7 at the February plenary, which would mean that the spec is complete and it's ready for test cases to be written. Do you have any concerns about the way it's currently specified?</p>
<p>From your earlier comments, it sounds like this is something we should explicitly support this time around.</p>
</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Mon Jan 13 2025 12:35:30 GMT-0800 (Pacific Standard Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">I have a question.  I am right about here <a href="https://searchfox.org/mozilla-central/source/dom/canvas/CanvasRenderingContext2D.cpp#2106">https://searchfox.org/mozilla-central/source/dom/canvas/CanvasRenderingContext2D.cpp#2106</a> in a content process.  If I call nsContentUtils::SubjectPrincipal() (which does GetCurrentJSContext() and then JS::GetRealmPrincipals(realm);) - I expect to the get the principal of the website I'm on, e.g. <a href="http://example.com">example.com</a></td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Mon Jan 13 2025 12:37:00 GMT-0800 (Pacific Standard Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">But I've actually gotten there via some Javascript running in a child actor: <a href="https://searchfox.org/mozilla-central/source/toolkit/components/resistfingerprinting/UserCharacteristicsPageService.sys.mjs#331">https://searchfox.org/mozilla-central/source/toolkit/components/resistfingerprinting/UserCharacteristicsPageService.sys.mjs#331</a></td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Mon Jan 13 2025 12:37:54 GMT-0800 (Pacific Standard Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">And in <em>that</em> situation I get the SystemPrincipal (and I'm still in the content process).  Which makes some sense - I'm running system code, sure.  But... GetCurrentJSContext() is looking at what I think is a thread-local variable on the main thread to get the context.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Mon Jan 13 2025 12:38:11 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">Does the context get swapped intelligently between System and non-System?  Is something else happening?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Mon Jan 13 2025 12:38:51 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">If you are running chrome JS, then the current principal is the system principal.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Mon Jan 13 2025 12:40:27 GMT-0800 (Pacific Standard Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">That implies that the thread-local JSContext is either a pointer getting changed between the privileged context and the original page context; or we're promoting and demoting the Context when we enter and leave chrome JS.  It could very well be how it works, I just want to make sure my mental model is correct....</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Mon Jan 13 2025 12:41:16 GMT-0800 (Pacific Standard Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">There's only one JSContext. Stuff gets swapped around in the context when we switch compartments. There's some kind of stack thing.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Mon Jan 13 2025 12:43:18 GMT-0800 (Pacific Standard Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">eg this kind of stuff deals with the swapping (I think this is really kind of a DOM question though there's a lot of overlap with JS which provides the mechanism that DOM uses) <a href="https://searchfox.org/mozilla-central/source/dom/script/AutoEntryScript.h#41">https://searchfox.org/mozilla-central/source/dom/script/AutoEntryScript.h#41</a></td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Mon Jan 13 2025 12:43:50 GMT-0800 (Pacific Standard Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">thank you!</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Mon Jan 13 2025 12:58:03 GMT-0800 (Pacific Standard Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">For your specific case, it sounds like you want to run some JS in the context of the page itself which I think should be doable but I can't think off the top of my head how to do it.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Mon Jan 13 2025 12:59:29 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">Opposite actually, we want to run it in the system context, but we don't check the privileges of the currently running script, we get the document's permissions, meaning we're applying fingerprinting protections to the system-privileged code</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Mon Jan 13 2025 12:59:55 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">This isn't to hard to fix, I'm just trying to understand the ecosystem I'm in to make the least bad fix</td></tr>

</tbody></table></div></div></div>
</body></html>