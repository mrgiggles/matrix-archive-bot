<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-06-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-06-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-06-06" class="nav-link"><span>prev</span></a>
<a href="2022-06-08" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jun 06 2022 23:21:25 GMT-0700 (Pacific Daylight Time)">06:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I'm having trouble getting the JSString classes (especially JSLinearString) to work with my pre-existing string functions, which use <code>std::string</code> and <code>const char*</code> arguments. I can use JS::GetLatin1LinearStringChars(), but I don't know how to convert from <code>Latin1Char*</code> to <code>char*</code>. I really need a systematic solution, i.e. one or two new functions to convert JS Strings to std::string or char[], rather than wrestling with the problem again and again. Ideally I would love it if these functions were non allocating, but I would settle for something that copies to std::string. What do people normally use for this? There are a few candidates in CharacterEncoding.h, but they are depracated.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jun 07 2022 02:53:25 GMT-0700 (Pacific Daylight Time)">09:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">Anyone else noticing that <code>Cargo.lock</code> changes every time you run a build, meaning that it's easy to accidentally <code>git add</code> the change if you're not being careful?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jun 07 2022 02:53:42 GMT-0700 (Pacific Daylight Time)">09:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">this just started happening after pulling changes within the past few days</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jun 07 2022 03:39:03 GMT-0700 (Pacific Daylight Time)">10:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: what's the encoding of <code>const char*</code> in your code?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jun 07 2022 03:40:20 GMT-0700 (Pacific Daylight Time)">10:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if it's ASCII and the <code>JSString</code> also contains ASCII, you can just cast <code>Latin1Char*</code> to <code>char*</code></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jun 07 2022 03:42:27 GMT-0700 (Pacific Daylight Time)">10:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, <code>JSString</code> base class doesn't guarantee the contiguous memory block.  so, possible allocation is necessary at least once for <code>JS_EnsureLinearString</code></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jun 07 2022 03:43:53 GMT-0700 (Pacific Daylight Time)">10:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there's a comment in <a href="https://searchfox.org/mozilla-central/rev/1c6bb1476e86b6d428b26d04e6ea3f4367528c77/js/public/String.h#137-175">String.h</a></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jun 07 2022 03:45:18 GMT-0700 (Pacific Daylight Time)">10:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">So JSLinearString is guaranteed to be contiguous, is it?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jun 07 2022 03:45:26 GMT-0700 (Pacific Daylight Time)">10:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">That answers another one of my questions :)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jun 07 2022 03:46:43 GMT-0700 (Pacific Daylight Time)">10:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, <code>JSLinearString</code> is guaranteed to use single memory block</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jun 07 2022 03:46:53 GMT-0700 (Pacific Daylight Time)">10:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">The characters are just ascii, but I'm not able to cast them. <code>static_cast&lt;const char*&gt;</code> on an <code>unsigned char*</code> doesn't compile for me.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jun 07 2022 03:47:28 GMT-0700 (Pacific Daylight Time)">10:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">(and Latin1char seems to be a typedef for unsigned char)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jun 07 2022 03:47:59 GMT-0700 (Pacific Daylight Time)">10:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there's document about strings in <a href="https://searchfox.org/mozilla-central/rev/1c6bb1476e86b6d428b26d04e6ea3f4367528c77/js/src/vm/StringType.h#80">StringType.h</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jun 07 2022 03:48:55 GMT-0700 (Pacific Daylight Time)">10:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what error do you get?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jun 07 2022 03:49:02 GMT-0700 (Pacific Daylight Time)">10:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Yeah I've read through that but I'm still struggling. Sorry, this is really basic stuff I know. Char and string handling is one of my weakest areas of C++</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jun 07 2022 03:51:06 GMT-0700 (Pacific Daylight Time)">10:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I guess you need <code>reinterpret_cast&lt;const char*&gt;(...)</code></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jun 07 2022 03:52:45 GMT-0700 (Pacific Daylight Time)">10:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Will this take care of it? I was guessing that the static_cast doesn't work because the data would be offset by 128.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jun 07 2022 03:53:02 GMT-0700 (Pacific Daylight Time)">10:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> what error do you get?</blockquote></mx-reply>It's just a plan invalid type conversion.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jun 07 2022 03:53:21 GMT-0700 (Pacific Daylight Time)">10:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there's no offset</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jun 07 2022 03:53:50 GMT-0700 (Pacific Daylight Time)">10:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Will this take care of it? I was guessing that the static_cast doesn't work because the data would be offset by 128.</blockquote></mx-reply>No need to explain to me if / why this comment doesn't make any sense :) I guess I'll play around with reinterpret_cast and see if I can get it to work.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jun 07 2022 04:28:04 GMT-0700 (Pacific Daylight Time)">11:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">reinterpret_cast does seem to work, and I can get a <code>string_view</code> from here. This seems like a good solution.<br><a href="https://paste.mozilla.org/x8Q55hop">https://paste.mozilla.org/x8Q55hop</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jun 07 2022 04:29:57 GMT-0700 (Pacific Daylight Time)">11:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">New problem though: <code>JS::GetLatin1LinearStringChars()</code> requires <code>JS::AutoRequireNoGC</code>. I'm using <code>JS::AutoCheckCannotGC</code>, but this asserts (because I've done nothing to stop the GC). Is there another version of <code>JS::AutoRequireNoGC</code> I should be using? Or is there some way of halting the GC within this scope?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jun 07 2022 04:34:16 GMT-0700 (Pacific Daylight Time)">11:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><code>AutoDisableGenerationalGC</code> maybe?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jun 07 2022 04:35:32 GMT-0700 (Pacific Daylight Time)">11:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can you provide the code and the error? <a href="https://paste.mozilla.org/">https://paste.mozilla.org/</a></td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jun 07 2022 04:37:19 GMT-0700 (Pacific Daylight Time)">11:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><a href="https://paste.mozilla.org/zVhzLYRv">https://paste.mozilla.org/zVhzLYRv</a></td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jun 07 2022 04:37:38 GMT-0700 (Pacific Daylight Time)">11:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what's the code?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jun 07 2022 04:38:48 GMT-0700 (Pacific Daylight Time)">11:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Oh sorry, it's the one I posted already: <a href="https://paste.mozilla.org/x8Q55hop">https://paste.mozilla.org/x8Q55hop</a></td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jun 07 2022 04:38:59 GMT-0700 (Pacific Daylight Time)">11:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Not a working example though.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jun 07 2022 04:39:37 GMT-0700 (Pacific Daylight Time)">11:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you shouldn't perform any operation that can GC inside <code>JS::AutoCheckCannotGC</code>'s scope</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Jun 07 2022 04:41:05 GMT-0700 (Pacific Daylight Time)">11:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you need to move <code>toLinearString</code>  out of it, at least</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Jun 07 2022 04:44:04 GMT-0700 (Pacific Daylight Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://paste.mozilla.org/WqinJ1p0">https://paste.mozilla.org/WqinJ1p0</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Jun 07 2022 04:44:37 GMT-0700 (Pacific Daylight Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Also, note that, the pointer returned by <code>JS::GetLatin1LinearStringChars</code> is valid only in the <code>JS::AutoCheckCannotGC</code>'s scope</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Jun 07 2022 04:45:39 GMT-0700 (Pacific Daylight Time)">11:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if you want to keep the string after that, you need to copy it, instead of using view</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Jun 07 2022 04:45:50 GMT-0700 (Pacific Daylight Time)">11:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Yes, I'll work within that scope.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Jun 07 2022 04:46:54 GMT-0700 (Pacific Daylight Time)">11:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I got it working with <code>JS::AutoCheckCannotGC();</code> I was using <code>JS::AutoCheckCannotGC {};</code> instead, and the brace initialization was the problem.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Jun 07 2022 04:47:16 GMT-0700 (Pacific Daylight Time)">11:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Thanks for getting me back on my feet, once again!</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Jun 07 2022 04:47:40 GMT-0700 (Pacific Daylight Time)">11:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">SpiderMonkey is the most challenging coding I've ever done. But also somehow the most rewarding.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Jun 07 2022 04:58:46 GMT-0700 (Pacific Daylight Time)">11:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I got it working with <code>JS::AutoCheckCannotGC();</code> I was using <code>JS::AutoCheckCannotGC checkGB{};</code> instead, and the brace initialization was the problem.</blockquote></mx-reply><code>JS::AutoCheckCannotGC();</code> Is wrong. You need something like <code>JS::AutoCheckCannotGC noGc();</code></td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Jun 07 2022 05:07:26 GMT-0700 (Pacific Daylight Time)">12:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Right, it needs to be named.</td></tr>

</tbody></table></div></div></div>
</body></html>