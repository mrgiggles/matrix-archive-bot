<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-02-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-02-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-02-13" class="nav-link"><span>prev</span></a>
<a href="2023-02-15" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Feb 13 2023 22:20:33 GMT-0800 (Pacific Standard Time)">06:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@vladyslavy:mozilla.org">vladyslavy</span>&gt;</div></td><td class="msg-cell"><p>Hi all! Sorry if I'm asking an embedding question in the wrong place.<br>I'm embedding SpiderMonkey 102.0.7 and need help with object tracing.<br>There are two containers in my application - <code>std::unordered_set</code> for <code>JS::Heap&lt;JSObject*&gt;</code> instances, and <code>std::map</code> for mapping <code>JSObjects*</code> to some data:</p>
<pre><code>struct UserData{};

std::unordred_set&lt;JS::Heap&lt;JSObject*&gt;&gt; allObjects_;
std::map&lt;JSObject*, UserData&gt; someObjectsWithData_;
</code></pre>
<p>And I use <code>JS_AddExtraGCRootsTracer</code> with my callback to trace object and update keys in <code>someObjectsWithData_</code>:</p>
<pre><code>static void traceObjects(JSTracer* tracer, void* data)
{
    auto* storage = reinterpret_cast&lt;Storage*&gt;(data);
    
    for (auto&amp; object : storage-&gt;allObjects_)
    {
        auto* prev = object.unbarrieredGet();
        JS::TraceEdge(tracer, &amp;object, "Heap Object");
        auto* theNew = object.unbarrieredGet();
        
        if (prev != theNew)
        {
            auto iter = storage-&gt;someObjectsWillData_.find(prev);
            if (iter != storage-&gt;someObjectsWillData_.end())
            {
                auto userData = it-&gt;second;
                storage-&gt;someObjectsWillData_.erase(it);
                storage-&gt;someObjectsWillData_.insert({theNew, std::move(userData)});
            }
        }
    }
}
</code></pre>
<p>The problem is that at the time <code>traceObjects</code> is called, the elements in <code>allObjects_</code> already have been updated somewhere in the engine, and I can't use their previous value to update the existing keys.<br>What am I doing wrong, and please advise me what I should use for maps keying?</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Feb 14 2023 01:59:43 GMT-0800 (Pacific Standard Time)">09:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">vladyslavy</span>: First of all, the interaction of moving GC with a hash table like is complicated because when the GC moves your objects it breaks the hash table's invariants about what should go where.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Feb 14 2023 02:00:50 GMT-0800 (Pacific Standard Time)">10:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">We have our own hash tables which we use with a keying strategy that is not based on the pointer value to get around this.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Feb 14 2023 02:01:43 GMT-0800 (Pacific Standard Time)">10:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">These are JS::GCHashMap and JS::GCHashSet and the MovableCellHasher template.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Feb 14 2023 02:02:43 GMT-0800 (Pacific Standard Time)">10:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">An example use outside the engine is: <a href="https://searchfox.org/mozilla-central/source/dom/base/CustomElementRegistry.h#498-501">https://searchfox.org/mozilla-central/source/dom/base/CustomElementRegistry.h#498-501</a></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Feb 14 2023 02:05:21 GMT-0800 (Pacific Standard Time)">10:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">The problem you're having is that the Heap&lt;&gt; wrapper is updating object pointers in the allObjects_ set when they are evicted from the nursery which is why you can no longer find them in somObjectWithData_.  Unfortunately this is necessary to make generational GC work (and you really need to use it in the map too).</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Feb 14 2023 02:06:33 GMT-0800 (Pacific Standard Time)">10:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Another approach would be to disable generational GC entirely, or prevent these particular objects from being allocated in the nursery.  Performance might be worse though.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Feb 14 2023 02:07:02 GMT-0800 (Pacific Standard Time)">10:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@vladyslavy:mozilla.org">vladyslavy</span>&gt;</div></td><td class="msg-cell">Thank you for the reply</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Feb 14 2023 02:07:43 GMT-0800 (Pacific Standard Time)">10:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@vladyslavy:mozilla.org">vladyslavy</span>&gt;</div></td><td class="msg-cell"><p>Well, I should say thats sad, especially because I see these lines for the JS::TraceEdge function:</p>
<pre><code>// The argument to JS::TraceEdge is an in-out param: when the function returns,
// the garbage collector might have moved the GC thing. In this case, the
// reference passed to JS::TraceEdge will be updated to the thing's new
// location. Callers of this method are responsible for updating any state that
// is dependent on the object's address. For example, if the object's address
// is used as a key in a hashtable, then the object must be removed and
// re-inserted with the correct hash.
</code></pre>
</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Feb 14 2023 02:11:28 GMT-0800 (Pacific Standard Time)">10:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">That comment is basically true but doesn't tell the full story (that this is not the best way to deal with hash tables).  I'll file a bug to update that.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Feb 14 2023 02:14:48 GMT-0800 (Pacific Standard Time)">10:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@vladyslavy:mozilla.org">vladyslavy</span>&gt;</div></td><td class="msg-cell">Thank you, I think I understood the roadmap to get my code to work. Could you please also give a little advice on how to disable generational GC or prevent objects from being allocated in the nursery. The reference to the documentation is fine also</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Feb 14 2023 02:22:10 GMT-0800 (Pacific Standard Time)">10:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@vladyslavy:mozilla.org">vladyslavy</span>&gt;</div></td><td class="msg-cell">And as far as I understood I should avoid using <code>std::unordered_set&lt;JS::Heap&lt;JSObject*&gt;&gt;</code> too</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Feb 14 2023 02:27:42 GMT-0800 (Pacific Standard Time)">10:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">You can use an AutoDisableGenerationalGC to disable generational GC while it is live: <a href="https://searchfox.org/mozilla-central/source/js/public/GCAPI.h#1005-1012">https://searchfox.org/mozilla-central/source/js/public/GCAPI.h#1005-1012</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Feb 14 2023 02:29:02 GMT-0800 (Pacific Standard Time)">10:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">std::unordered_set won't work with generational GC; it should be fine if you update it as you do in the code you pasted above</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Feb 14 2023 02:29:38 GMT-0800 (Pacific Standard Time)">10:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">The GCHashSet/Table approach is better tested though because it's what we use ourselves</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Feb 14 2023 02:36:55 GMT-0800 (Pacific Standard Time)">10:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@vladyslavy:mozilla.org">vladyslavy</span>&gt;</div></td><td class="msg-cell">Correct me if I'm wrong. std::unordered_set will store the old hash values, which is the hash of the object before it is evicted from the nursery. so I should call rehash or search wouldn't work</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Feb 14 2023 02:56:58 GMT-0800 (Pacific Standard Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">vladyslavy</span>: yes, that's what I mean - std::unordered_set won't work with generational GC at all because updating the keys breaks the hashtable's internal layout</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Feb 14 2023 02:57:52 GMT-0800 (Pacific Standard Time)">10:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">If you disable generational GC you can still use this but you will also need to update the keys in case compacting GC moves objects.  Alternatively this too can be disabled.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Feb 14 2023 02:58:12 GMT-0800 (Pacific Standard Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Another options is to use the std:: containers but don't key off the pointer value</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Feb 14 2023 02:58:18 GMT-0800 (Pacific Standard Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">This is what our internal solution does</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Feb 14 2023 03:01:21 GMT-0800 (Pacific Standard Time)">11:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@vladyslavy:mozilla.org">vladyslavy</span>&gt;</div></td><td class="msg-cell">The conclusion is that I should use JS::GC-aware containers. They are tested and adapted</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Feb 14 2023 05:22:26 GMT-0800 (Pacific Standard Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@vladyslavy:mozilla.org">vladyslavy</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: one more question. How to properly remove objects from GCHashMap after finalizing JSObject? I found <code>JS_AddWeakPointerZonesCallback</code> and <code>JS_AddWeakPointerCompartmentCallback</code>, as far as I understand I should put a call to <code>GCHashMap::traceWeak</code> in the callbacks.<br>Should I use both of them, or is one enough? Or should I use something else?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Feb 14 2023 05:42:47 GMT-0800 (Pacific Standard Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">If you're marking the contents of the map as roots they will die until you shutdown the JS engine (and then you can just clear your map)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Feb 14 2023 05:43:48 GMT-0800 (Pacific Standard Time)">13:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">If you want them to be able to die when they are no longer otherwise referenced, then you wouldn't mark them as roots but trace them in one of the weak pointer callbacks by calling traceWeak</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Feb 14 2023 05:44:02 GMT-0800 (Pacific Standard Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">vladyslavy</span>: ^</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Feb 14 2023 05:45:41 GMT-0800 (Pacific Standard Time)">13:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@vladyslavy:mozilla.org">vladyslavy</span>&gt;</div></td><td class="msg-cell">Yes, I want them to be able to die. So I can use <code>JS_AddWeakPointerZonesCallback</code> and its enough</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Feb 14 2023 05:48:49 GMT-0800 (Pacific Standard Time)">13:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">that should work</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Feb 14 2023 06:01:17 GMT-0800 (Pacific Standard Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">Argh. Why does JS_Stringify return "null" when JSON.stringify returns undefined?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Feb 14 2023 06:06:03 GMT-0800 (Pacific Standard Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">Blame points at <span class="nick-15">Waldo</span> in bug 645922</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Feb 14 2023 06:06:05 GMT-0800 (Pacific Standard Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/645922">https://bugzil.la/645922</a> — RESOLVED (Waldo) — Remove js_TryJSON and JS_TryJSON</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Feb 14 2023 10:19:31 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">How should I go about creating an anonymous lambda from spidermonkey?  JS_NewFunction seems to require a name.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Feb 14 2023 10:24:18 GMT-0800 (Pacific Standard Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it looks like it accepts <code>nullptr</code> for the name</td></tr>

</tbody></table></div></div></div>
</body></html>