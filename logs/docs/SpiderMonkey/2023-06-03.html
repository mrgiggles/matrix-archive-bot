<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-06-03</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-06-03<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-06-02" class="nav-link"><span>prev</span></a>
<a href="2023-06-04" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Jun 02 2023 18:04:52 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"> * the "normal" thing would be JSObject* GetStoredValue() { return &amp;_storedValue.toObject() } assuming you know it'll have a valid object pointer in it.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Jun 02 2023 18:05:09 GMT-0700 (Pacific Daylight Time)">01:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> the "normal" thing would be JSObject* GetStoredValue() { return &amp;_storedValue.toObject() } assuming you know it'll have a valid object pointer in it.</blockquote></mx-reply><code>JSObject* GetStoredValue() { return _storedValue.toObjectOrNull() }</code> if not.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Jun 02 2023 18:05:37 GMT-0700 (Pacific Daylight Time)">01:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(sorry, I meant to say this after the earlier message, but ended up replacing it instead)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sat Jun 03 2023 05:00:52 GMT-0700 (Pacific Daylight Time)">12:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">question regarding tracing: if I have custom JS object <code>a</code> that have a native with Trace that traces Heap object <code>b</code>, is it the same as if I had <code>let a =...; let b = ...; a.field = b;</code> in JS? I.e. it detects that <code>b</code> is part of and <code>a</code> (and thus will detect cycles and GC everything properly in case <code>b</code> stores <code>a</code>)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sat Jun 03 2023 05:02:02 GMT-0700 (Pacific Daylight Time)">12:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">and thus I don't need to manually 'break' links to <code>b</code> in my custom object for GC to work properly and collect <code>a</code> (and contained <code>b</code>) once it's not referenced anywhere</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sat Jun 03 2023 05:03:01 GMT-0700 (Pacific Daylight Time)">12:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">if <code>b</code> is stored as an object value in the reserved slot, it should, but if <code>b</code> is stored in a private value as part of a struct, it isn't</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sat Jun 03 2023 05:03:13 GMT-0700 (Pacific Daylight Time)">12:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">or at least that's what I was told when I asked a while ago</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sat Jun 03 2023 05:04:02 GMT-0700 (Pacific Daylight Time)">12:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">yea, I know about reserved slot, but in this case it's stored in traced native</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sat Jun 03 2023 05:04:18 GMT-0700 (Pacific Daylight Time)">12:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">so the private value thing I said?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sat Jun 03 2023 05:06:09 GMT-0700 (Pacific Daylight Time)">12:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">yea, something like that: custom JS object has a reserved slot, which stores a corresponding native object, which itself has a container with Heap objects, and said custom JS object has a custom tracer in JSClassOps which traces these Heap objects</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sat Jun 03 2023 05:07:20 GMT-0700 (Pacific Daylight Time)">12:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">so the question is, whether GC consider objects traced via custom tracer in JSClassOps as part of an object that this JSClassOps  is for</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sat Jun 03 2023 05:09:18 GMT-0700 (Pacific Daylight Time)">12:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">or if it just a way for global tracer to reach inside (i.e. it doesn't make a relation between object with said JSClassOps and all the data that traced with custom tracer)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sat Jun 03 2023 05:17:08 GMT-0700 (Pacific Daylight Time)">12:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">on unrelated note: HTMLImageElement spec (as in actual html standard) is pure cancer</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sat Jun 03 2023 09:43:48 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> question regarding tracing: if I have custom JS object <code>a</code> that have a native with Trace that traces Heap object <code>b</code>, is it the same as if I had <code>let a =...; let b = ...; a.field = b;</code> in JS? I.e. it detects that <code>b</code> is part of and <code>a</code> (and thus will detect cycles and GC everything properly in case <code>b</code> stores <code>a</code>)</blockquote></mx-reply>and a follow-up question: if JSClassOps tracer does not add such relation between JS things, is it possible to add it manually? (without resorting to storing everything in reserved slots)</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sat Jun 03 2023 10:38:02 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@cosmin:mozilla.org">CosminS|sheriffduty</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: hi, any chance you could tackle Bug 1832153? It has 321 total failures in the last 30 days <a href="https://treeherder.mozilla.org/intermittent-failures/bugdetails?startday=2023-05-04&amp;endday=2023-06-03&amp;tree=trunk&amp;failurehash=all&amp;bug=1832153">https://treeherder.mozilla.org/intermittent-failures/bugdetails?startday=2023-05-04&amp;endday=2023-06-03&amp;tree=trunk&amp;failurehash=all&amp;bug=1832153</a></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sat Jun 03 2023 10:38:04 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1832153">https://bugzil.la/1832153</a> — NEW (jonco) — High frequency valgrind-test | 16 bytes in 1 blocks are definitely lost at malloc / js_arena_malloc / js_pod_arena_malloc / maybe_pod_arena_malloc</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sat Jun 03 2023 11:14:38 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">TheQwertiest</span>: I don't entirely follow the way you're describing it, as <code>a</code> containing <code>b</code>, but I think I get the gist. Anyway, the answer is that it's doing what you want. Nothing is going to trace <code>b</code> automatically. There's no global trace that loops over custom trace functions or anything. Having a custom tracer that traces a <code>Heap</code> field results in the same effect as an object stored in a non-private reserved slot.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sat Jun 03 2023 11:15:20 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in either case, the result is the same: if the only way to get to that <code>b</code> is through <code>a</code>, then <code>b</code> will be collected if there is no <code>a</code> that causes it to be traced.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sat Jun 03 2023 11:15:29 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you should definitely not have to manually break links or anything.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sat Jun 03 2023 11:17:11 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think of it as "reachability" rather than "containment". Everything reachable from roots is live. Everything unreachable from roots will be collected. A custom trace function on <code>obj1</code> will only be invoked if <code>obj1</code> is reachable. Same with a reserved slot on <code>obj1</code>.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Sat Jun 03 2023 11:18:24 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">a custom trace function could look through whatever data structures it wants to discover objects to be traced, so it's not limited to simple containment. If the object that has the custom trace function is reachable, then everything the trace function processes will be reachable.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Sat Jun 03 2023 11:19:15 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">If the object with the trace function is not reachable, then the trace function will not be invoked and so it can't make anything else reachable.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Sat Jun 03 2023 11:20:23 GMT-0700 (Pacific Daylight Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(note that I am avoiding saying something like "if obj1 is not reachable, then the things that its trace function would have processed will not be reachable". That's only true if nothing else causes those other objects to be reachable. They just won't be reachable <em>because of <code>obj1</code></em>.)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Sat Jun 03 2023 11:20:52 GMT-0700 (Pacific Daylight Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">"because of" could also be described as "through" or "via".</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Sat Jun 03 2023 11:24:23 GMT-0700 (Pacific Daylight Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: thanks for the detailed answer! It answers almost everything, but one question remains though, will it detect circular dependency this way? I.e. in case <code>b</code> is traced through <code>a</code> and <code>a</code> is traced through <code>b</code> (where <code>a</code> and <code>b</code> are custom JS objects with tracers implemented)</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Sat Jun 03 2023 11:25:12 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">If either <code>a</code> or <code>b</code> is reachable from something else (as in, from a path starting at a root and going through something else), then both will be kept. Otherwise, both will be discarded.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Sat Jun 03 2023 11:25:24 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">circular dependencies are not a problem</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Sat Jun 03 2023 11:26:52 GMT-0700 (Pacific Daylight Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">awesome! Apparently I was doing it wrong for more than 5 years xD
thanks again :)

PS: But IIRC I do have to manually clean PersistentRooted things</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Sat Jun 03 2023 11:27:03 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, because those are roots</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Sat Jun 03 2023 11:27:07 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">they are <em>always</em> reachable</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Sat Jun 03 2023 11:27:27 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and that's the big risk in using them, you'll need to manually clean them when it makes sense</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Sat Jun 03 2023 11:28:24 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(and if anything in your heap that is reachable from a <code>PersistentRooted</code> can reach that <code>PersistentRooted</code>, then you're hosed and you can never clean it up)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Sat Jun 03 2023 11:29:14 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">yea, I think my misunderstanding of how tracing works originated exactly from the handling required by PersistentRooted </td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Sat Jun 03 2023 11:29:54 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">and I've been manually breaking all 'links' for JS things for all this time...</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Sat Jun 03 2023 11:40:03 GMT-0700 (Pacific Daylight Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">totally unrelated question: is it possible to have a realm without associated global? Context: wondering whether I should <code>GetCurrentRealmOrNull</code> or <code>GetCurrentGlobalOrNull</code> for asserts to check if current realm is usable</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Sat Jun 03 2023 15:50:43 GMT-0700 (Pacific Daylight Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in normal operation, a realm will always have a global. But the Realm doesn't keep the global alive, so <a href="https://searchfox.org/mozilla-central/rev/f5dde549cca5193743d11daa1c5f08258bee9d42/js/src/vm/Realm.h#439-447">briefly during a GC</a> you will see a global-less Realm.</td></tr>

</tbody></table></div></div></div>
</body></html>