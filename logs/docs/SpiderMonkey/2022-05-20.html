<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-05-20</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-05-20<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-05-19" class="nav-link"><span>prev</span></a>
<a href="2022-05-22" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu May 19 2022 20:12:59 GMT-0700 (Pacific Daylight Time)">03:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">I'm trying to get an overview of which pieces of runtime-generated machine code exist in Firefox, what they are generated from, and how these pieces of code can call each other. With Ted's help I was able to make the following graphs: <a href="https://mermaid.live/edit#pako:eNp1kklvgzAQhf-K5ZORkjZtbhwqBbKUiqgSROIAPRiYJKhmkTFqUJT-9g5rky4ckP3me-PxgzON8hioTvci_4iOXKogI_gsGHtxiZtXMgJNI9PpEzFQeS1IWCtoPFoHGmR6h0WTWWavmC29ZCaPjmA5vbps1ZUfUMskKZaSDEjTh7AY4qoQScQVxFpA38bGaFj7Bi9BNPC16YbZsC0e0y5ty2H2sHn2PS6LeyvPfns7_85-wIHGE6xMgSwk4PvGMc60sx-R30meFnnjKAlLeVZPyOd8NutGH8C5v-ZChDx6Jz8uPELewt0y5kG4KEtIQ1H3QW--y-3eM_wriPwXSOeScIATYw4cKsElgRPepyyTPCv77g5G5DQQGXJytqbfKX9ETCc0BZnyJMaf5NxGR9URUgxFx2UMe14JFdAguyBaFTF-xVWcqFxSfc9FCRPKK5W7dRZRXckKBmiZ8AMG2VOXL3LDyOI">How machine code is generated</a> and <a href="https://mermaid.live/edit#pako:eNp1kstugzAQRX8FzTaJumdRqXVbKVK7SSuxqLsYYJKg-IGMURtF-fe65mVMilh4jq_hzMAFCl0SpLAX-rs4orHJ646rxN3uYnX9xj45sNWKw1fHtsyjLRvJIzYkKkWeD8WU18pvZGjqO1dMx1zMkuneMBTj7odBWevxsVM5Jl5QiByLUy80lElglmEjZ3YZ5Q9NQzIX52RhuqMD_fiYX3ked5hsNvd-BEFzEZv6isOsR2FvHvg5R6GA-aWHk0i8401u2vZtxcIzHDmHo701yf8F57mbPsuHh2QxoNh7eTwYz9gGV7AGSUZiVbq_-_KX5GCPJN33Tt2yRHPiwNXV5dq6REvPZWW1gXSPoqE1YGv1-1kVkFrT0hB6qvDg5Dp4_QUOZP65">How machine code calls each other</a><br>Could you double-check these graphs for correctness?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu May 19 2022 20:16:13 GMT-0700 (Pacific Daylight Time)">03:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">This is for the profiler; starting from the native stack I'd like to show various panes of "source code" for each frame on the stack, depending on which unit of machine code that frame is in. E.g. for a stack frame in Ion code I'd like to show four panes at the bottom: JS source, MIR, LIR, and assembly. Or for a stack frame in an IC I'd like to show the CacheIR and the assembly for that IC.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu May 19 2022 22:51:56 GMT-0700 (Pacific Daylight Time)">05:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: webassembly also generates various types of machine code stubs dynamically</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu May 19 2022 22:55:56 GMT-0700 (Pacific Daylight Time)">05:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: your second graph is probably substantially more complicated in reality.  there are many ways to get into and out of wasm code, and at least two kinds of wasm code (baseline and optimized)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu May 19 2022 22:57:58 GMT-0700 (Pacific Daylight Time)">05:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">all that said, the stubs usually don't have a frame of their own and might not show up in disassembly / profiler output for that reason</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri May 20 2022 02:45:27 GMT-0700 (Pacific Daylight Time)">09:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: the calls graph is incomplete, we have multiple kind of Trampolines. Trampolines are used to go from C++ code to JIT code, as well as go from JIT code to C++ code. We have fast path for some calls which cannot GC where the JIT is also capable of calling into C++.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri May 20 2022 02:46:27 GMT-0700 (Pacific Daylight Time)">09:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: JIT* are calling directly into C++ using callWithABI, except for WASM which has a special index of functions.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri May 20 2022 02:47:18 GMT-0700 (Pacific Daylight Time)">09:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: Then, EME is also generating code just-in-time, IIRC.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri May 20 2022 02:49:29 GMT-0700 (Pacific Daylight Time)">09:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This would be lovely, feel free to reach if you need any help on this task.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri May 20 2022 02:51:00 GMT-0700 (Pacific Daylight Time)">09:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Ion can call into WASM at a low cost, this was the work of Benjamin.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri May 20 2022 02:51:50 GMT-0700 (Pacific Daylight Time)">09:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">IC can call into JIT code without going through trampoline nor C++.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri May 20 2022 02:53:01 GMT-0700 (Pacific Daylight Time)">09:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">basically, once we are in JIT code, we have the ability to remain in JIT code, for example, Ion can call other Ion functions.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri May 20 2022 07:07:36 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">Thanks for the feedback!</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri May 20 2022 07:09:51 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: those diagrams look really useful, especially from the perspective of someone new to SpiderMonkey. I really appreciate the effort you're making!</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri May 20 2022 07:10:12 GMT-0700 (Pacific Daylight Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-1">mstange</span>: webassembly also generates various types of machine code stubs dynamically</blockquote></mx-reply>Could you give me a list of the different types of machine code stubs, or maybe a pointer to the code so that I could make a list myself?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri May 20 2022 07:11:25 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-1">mstange</span>: your second graph is probably substantially more complicated in reality.  there are many ways to get into and out of wasm code, and at least two kinds of wasm code (baseline and optimized)</blockquote></mx-reply>Same here, a list of those different ways would be super useful! And for the two types, my intention was to have those covered by the "WebAssembly Baseline" node (for baseline) and the "Warp / Ion" node (for optimized)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri May 20 2022 07:12:16 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> all that said, the stubs usually don't have a frame of their own and might not show up in disassembly / profiler output for that reason</blockquote></mx-reply>Not sure I understand what you mean here. If the instruction pointer can ever be in this code, then it'll show up as a leaf frame in the native stack.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri May 20 2022 07:13:23 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: i'm winding down for the day but i'll get back to you tomorrow or monday, if somebody else does not get to it first</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri May 20 2022 07:13:46 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">no rush at all, have a good weekend!</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri May 20 2022 07:14:25 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-1">mstange</span>: the calls graph is incomplete, we have multiple kind of Trampolines. Trampolines are used to go from C++ code to JIT code, as well as go from JIT code to C++ code. We have fast path for some calls which cannot GC where the JIT is also capable of calling into C++.</blockquote></mx-reply>Ah ok, so then I need to break the Trampolines out into two types. And I'll add arrows from the "Baseline" and "Warp / Ion" notes to the "C++" node for the no-GC fast path.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri May 20 2022 07:46:01 GMT-0700 (Pacific Daylight Time)">14:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: I made an attempt at the wasm control flow graph with some pseudo graph syntax: <a href="https://paste.mozilla.org/enwyb14B">https://paste.mozilla.org/enwyb14B</a>. The real world CFG has a bunch of edge cases, but that's essentially what can happen.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri May 20 2022 08:01:25 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: I guess what would be more practical than separating the different kind of code generators, is separating the different kind of ABIs.  Wasm, Ion &amp; Baseline, Trampolines and C++ have different ABIs. Our ABI logic is easier to grep and to build graph out-of.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri May 20 2022 08:01:42 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">ah, that sounds promising</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri May 20 2022 08:28:39 GMT-0700 (Pacific Daylight Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: awesome, thank you! I'm still processing it</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri May 20 2022 08:37:03 GMT-0700 (Pacific Daylight Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">not a problem, let me know if you want anything clarified. It's more complicated than it probably should be..</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri May 20 2022 10:32:01 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">yulia</span>: Hey; working through the script-loader patch. You were right about the argument being wrong that I was passing. Trying to do the right thing now. Seems like one of the things i'll have to do is implement <code>nsIGlobalObject::GetModuleLoader()</code> ... do you have any suggestions for where to look on how this is going to be put together? (also... whether or not I'll have to teach <code>mozilla::dom::ModuleLoader</code> about a a new <code>Kind</code>?)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri May 20 2022 10:55:27 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Yes, you want to look at nsIGlobalObject — the virtual method is there. You need to implement it for your global. Two examples are the sandbox global and the backstage pass for the compartment module loader</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri May 20 2022 10:56:22 GMT-0700 (Pacific Daylight Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I don’t know if you will necessarily need a new kind, unless you need to switch behavior that can’t be handled with a LoadContext or in a loader (if it is a web ext case, which I think this is)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri May 20 2022 10:57:23 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">But I can take a look at any sketches on Monday</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri May 20 2022 11:39:55 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: did you want to look at <a href="https://phabricator.services.mozilla.com/D145184">https://phabricator.services.mozilla.com/D145184</a> ?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri May 20 2022 11:44:18 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, sorry, I got distracted by other things for a while. I'll take a look today.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri May 20 2022 11:45:26 GMT-0700 (Pacific Daylight Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: no worries. Next week is totally fine</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri May 20 2022 14:53:32 GMT-0700 (Pacific Daylight Time)">21:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">confession: ShadowRealm module loading work... complicated :0 </td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri May 20 2022 14:53:36 GMT-0700 (Pacific Daylight Time)">21:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>

</tbody></table></div></div></div>
</body></html>