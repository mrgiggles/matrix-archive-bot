<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-11-27</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-11-27<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-11-26" class="nav-link"><span>prev</span></a>
<a href="2024-11-28" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Nov 27 2024 02:35:47 GMT-0800 (Pacific Standard Time)">10:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">stupid question: if I add a printf in the c++ code that gets compiled in wasm, will I see it in the stdout when it runs in the browser in SpiderMonkey?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Nov 27 2024 02:43:28 GMT-0800 (Pacific Standard Time)">10:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@ms2ger:igalia.com">Ms2ger üáßüá™</span>&gt;</div></td><td class="msg-cell">No</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Nov 27 2024 02:45:58 GMT-0800 (Pacific Standard Time)">10:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">make yourself a small function to log, if needed</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Nov 27 2024 02:46:10 GMT-0800 (Pacific Standard Time)">10:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">some sort of callback </td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Nov 27 2024 02:49:06 GMT-0800 (Pacific Standard Time)">10:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">that's surfaced as an extern via the imports stuff?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Nov 27 2024 02:55:55 GMT-0800 (Pacific Standard Time)">10:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">yep</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Nov 27 2024 02:56:07 GMT-0800 (Pacific Standard Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">then you can bind it to moz_log or just printf or whatever is best</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Nov 27 2024 02:56:14 GMT-0800 (Pacific Standard Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">same for profiler markers, etc.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Nov 27 2024 03:02:50 GMT-0800 (Pacific Standard Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">thx</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Nov 27 2024 04:22:23 GMT-0800 (Pacific Standard Time)">12:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: ah, the functor thing is called only when we actually are dumping the heap <a href="https://searchfox.org/mozilla-central/rev/234f91a9d3ebef0d514868701cfb022d5f199cb5/js/src/util/DumpFunctions.cpp#593">https://searchfox.org/mozilla-central/rev/234f91a9d3ebef0d514868701cfb022d5f199cb5/js/src/util/DumpFunctions.cpp#593</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Nov 27 2024 04:22:36 GMT-0800 (Pacific Standard Time)">12:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I do need to add name to the functor callback</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Nov 27 2024 04:26:00 GMT-0800 (Pacific Standard Time)">12:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">yes, we don't generate the edge name when marking</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Nov 27 2024 04:35:25 GMT-0800 (Pacific Standard Time)">12:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: is there some flag in JSTracer which could be used as a hint that we want logs</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Nov 27 2024 04:36:40 GMT-0800 (Pacific Standard Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">looks like DumpHeapTracer is a callbacktracer</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Nov 27 2024 04:37:01 GMT-0800 (Pacific Standard Time)">12:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Not really</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Nov 27 2024 04:37:08 GMT-0800 (Pacific Standard Time)">12:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Yes</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Nov 27 2024 04:38:42 GMT-0800 (Pacific Standard Time)">12:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: would it be ok to add a boolean flag to JSTracer telling that it is a DumpHeapTracer ?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Nov 27 2024 04:39:18 GMT-0800 (Pacific Standard Time)">12:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">or perhaps "wantLog()"</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Nov 27 2024 04:45:36 GMT-0800 (Pacific Standard Time)">12:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">what do you need to know that for?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Nov 27 2024 05:10:55 GMT-0800 (Pacific Standard Time)">13:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: Are we progressively dropping <code>JitOptions</code> in favor of <code>JS::Prefs</code>?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Nov 27 2024 05:19:28 GMT-0800 (Pacific Standard Time)">13:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: yes. I don't know if we can convert all of them but it should work for most</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Nov 27 2024 05:21:36 GMT-0800 (Pacific Standard Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">üëè Nice work <span class="nick-16">Ryan Hunt</span></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Nov 27 2024 05:49:54 GMT-0800 (Pacific Standard Time)">13:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: just to not use AutoTracingDetails if we're not logging</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Nov 27 2024 05:50:02 GMT-0800 (Pacific Standard Time)">13:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">or do you think it is fast enough to use AutoTracingDetails always</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Nov 27 2024 05:53:11 GMT-0800 (Pacific Standard Time)">13:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: the functor will only be called by DumpHeap so you can use it always</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Nov 27 2024 05:53:32 GMT-0800 (Pacific Standard Time)">13:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">uh, I'm assuming you can use AutoTracingDetails outside the loop</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Nov 27 2024 05:53:33 GMT-0800 (Pacific Standard Time)">13:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">sure, but AutoTracingDetails install the functor anyhow</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Nov 27 2024 05:54:11 GMT-0800 (Pacific Standard Time)">13:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Could I use it outside? And always change the internal holder pointer?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Nov 27 2024 05:54:49 GMT-0800 (Pacific Standard Time)">13:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Nothing can somewhere (in some nested function call) replace it?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Nov 27 2024 05:55:16 GMT-0800 (Pacific Standard Time)">13:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I think so if the functor has a reference to aIter</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Nov 27 2024 05:55:31 GMT-0800 (Pacific Standard Time)">13:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">so you can get the current holder</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Nov 27 2024 05:55:49 GMT-0800 (Pacific Standard Time)">13:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">right. I was mostly worried about someone overriding the functor</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Nov 27 2024 05:56:07 GMT-0800 (Pacific Standard Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I wonder if ~AutoTracingDetails should restore the old value of trc_-&gt;context().functor_</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Nov 27 2024 05:56:11 GMT-0800 (Pacific Standard Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">not just set to null</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Nov 27 2024 05:57:01 GMT-0800 (Pacific Standard Time)">13:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">yes, that's good idea</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Nov 27 2024 05:57:55 GMT-0800 (Pacific Standard Time)">13:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I don't think AutoTracingDetails is used very much though so it's unlikely to be a problem</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Nov 27 2024 06:14:22 GMT-0800 (Pacific Standard Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">ah, and there is AutoClearTracingContext for explicitly clearing, temporarily</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Nov 27 2024 06:29:34 GMT-0800 (Pacific Standard Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">davidj361</span>: for "proper way", here's a list of some common cases:  <a href="https://paste.mozilla.org/Nwf5YOHN">https://paste.mozilla.org/Nwf5YOHN</a></blockquote></mx-reply><p>I assume write XDR is also in idle time:</p>
<blockquote>
<p>on idle time, encode the stencil into XDR with JS::EncodeStencil<br>write the XDR to a file</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Nov 27 2024 06:30:32 GMT-0800 (Pacific Standard Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, it can be done any time, as long as you keep the stencil alive until that point.  the design is based on the browser's use case, where there's idle time after the page load</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Nov 27 2024 07:25:53 GMT-0800 (Pacific Standard Time)">15:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">davidj361</span>: for "proper way", here's a list of some common cases:  <a href="https://paste.mozilla.org/Nwf5YOHN">https://paste.mozilla.org/Nwf5YOHN</a></blockquote></mx-reply><p>Where is compile for non-stencils in the linked example?</p>
<blockquote>
<p>Without stencil: compile, instantiate, and execute with JS::Evalute</p>
</blockquote>
<p><a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/9ad752366b2486eaa0867d5bcb6662648e5d7ee0/examples/hello.cpp#L20-L37">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/9ad752366b2486eaa0867d5bcb6662648e5d7ee0/examples/hello.cpp#L20-L37</a></p>
</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Nov 27 2024 07:26:59 GMT-0800 (Pacific Standard Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">JS::Evaluate is for those 3 steps</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Nov 27 2024 07:38:01 GMT-0800 (Pacific Standard Time)">15:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>Should</p>
<pre><code>compile JS source to stencil with JS::CompileGlobalScriptToStencil
instantiate the stencil into JSScript with JS::InstantiateGlobalStencil
execute the JSScript with JS_ExecuteScript
</code></pre>
<p>be slower or faster than JS::Evaluate in completion time?</p>
</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Nov 27 2024 07:38:25 GMT-0800 (Pacific Standard Time)">15:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there shouldn't be notable difference</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Nov 27 2024 07:38:48 GMT-0800 (Pacific Standard Time)">15:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS::Evaluate</code> is doing the same thing internally</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Nov 27 2024 07:59:21 GMT-0800 (Pacific Standard Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>:  So the whole aspect of stencils being faster is that you only have to execute (e.g. line 3: <code>execute the JSScript with JS_ExecuteScript</code>) rather than compiling and instantiating right? i.e. <code>execute the JSScript with JS_ExecuteScript</code></td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Nov 27 2024 08:00:30 GMT-0800 (Pacific Standard Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"instantiate + execute" is what you need with stencil, for each global</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Nov 27 2024 08:00:51 GMT-0800 (Pacific Standard Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so you can skip "compile" part, except for the first one</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Nov 27 2024 08:02:07 GMT-0800 (Pacific Standard Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">stencil is GC-free data, and it's independent from globals.  JSScript is GC data and associated with global.  so you need "instantiate" for each global</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Nov 27 2024 08:02:31 GMT-0800 (Pacific Standard Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but the "compile" step needs to be done only once, and all consumers can share the result</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Nov 27 2024 08:05:40 GMT-0800 (Pacific Standard Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if the stencil is directly shared between consumers as on-memory data structure, this reduces the cost of "compile" step for each global.  the additional cost is the memory consumption from the cached stencil</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Nov 27 2024 08:08:44 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the stencil needs to be encoded/decoded, it replaces the "read JS source" with "read stencil XDR", and also "compile" with "decode",  with additional cost of encoding and writing at certain point.  So this is trade off.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Nov 27 2024 08:09:51 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the JS source is very small, there may be not much benefit, and the additional cost may result in some regression.  we have some heuristics in Firefox's script loader about the decision whether to cache the encoded stencil, in <a href="https://searchfox.org/mozilla-central/rev/234f91a9d3ebef0d514868701cfb022d5f199cb5/dom/script/ScriptLoader.cpp#2530">mozilla::dom::ScriptLoader::CalculateBytecodeCacheFlag</a></td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Nov 27 2024 08:11:59 GMT-0800 (Pacific Standard Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, "stencils being faster" is not precise.  stencil gives you more control, and there are some cases where using it can improve the performance, with acceptable amount of cost</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Nov 27 2024 08:14:02 GMT-0800 (Pacific Standard Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">is the compile step very performance heavy? i.e. takes a long time or takes lots of memory?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Nov 27 2024 08:14:37 GMT-0800 (Pacific Standard Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">both, depending on the source size and the complexity</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Nov 27 2024 08:16:25 GMT-0800 (Pacific Standard Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>For restarts: it's worth the trade off to read from a file (file I/O operation) and instantiate from it instead? i.e. you avoid having to compile across restarts?</p>
<pre><code>    compile JS source to stencil with JS::CompileGlobalScriptToStencil
    instantiate the stencil into JSScript with JS::InstantiateGlobalStencil
    execute the JSScript with JS_ExecuteScript
    on idle time, encode the stencil into XDR with JS::EncodeStencil
    write the XDR to a file
    restart
    read the XDR from the file
    decode the stencil with JS::DecodeStencil
    instantiate the stencil into JSScript with JS::InstantiateGlobalStencil
    execute the JSScript with JS_ExecuteScript
</code></pre>
</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Nov 27 2024 08:18:21 GMT-0800 (Pacific Standard Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I've omitted "read JS source from a file" step, but in general you always need it unless you decode from XDR</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Nov 27 2024 08:18:42 GMT-0800 (Pacific Standard Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, file I/O is supposed to be always happen</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Nov 27 2024 08:22:30 GMT-0800 (Pacific Standard Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, in this case, "read JS source from a file" + "compile" is replaced with "read the XDR from the file" + "decode".   "instantiate" is common between "without Stencil" vs "with Stencil"</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Nov 27 2024 08:37:26 GMT-0800 (Pacific Standard Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@slavazavadsky:matrix.org">Vyacheslav Zavadsky</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: Thanks a lot of answering. Our use case that we have roughly ~1000 scripts, each script need to be executed in each own global (execution is mostly awaiting on promises), each script is few hundred lines of code, and 90% of it is definition is a JS object with a lot of different string/object members.<br>Our goal is to optimize time till first await (load time). Loading XDR from file and any other prep work can happen on thread different from JsContext thread and we do not care about it that much . Our hope that your steps 8-10 will be significantly faster then just evaluate script. Do you think it reasonable? Anything we can do with overall execution flow to improve load time. Eg, play with zones/compartments, currently we create a compartment per global, but we do not care that much</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Nov 27 2024 08:39:58 GMT-0800 (Pacific Standard Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">are those 1000 scripts same across restarts?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Nov 27 2024 08:41:17 GMT-0800 (Pacific Standard Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"read XDR + decode" can be done in any thread.  "instantiate + execute" needs to be done in the same thread as the target JSContext</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Nov 27 2024 08:43:44 GMT-0800 (Pacific Standard Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, in term of the JSContext's thread, the cost of "compile" can be fully removed</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Nov 27 2024 08:44:12 GMT-0800 (Pacific Standard Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, I'm not sure about "significantly faster".  it depends on the script size and how long it's taking right now</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Nov 27 2024 08:44:31 GMT-0800 (Pacific Standard Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, try taking a profile of your application and see how much time is taken by compilation part</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Nov 27 2024 09:27:51 GMT-0800 (Pacific Standard Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@slavazavadsky:matrix.org">Vyacheslav Zavadsky</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> so, try taking a profile of your application and see how much time is taken by compilation part</blockquote></mx-reply>yes, they are same across restarts.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Nov 27 2024 09:37:40 GMT-0800 (Pacific Standard Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if those scripts are same across restarts, you can save the compilation result on first execution, and all subsequent executions can use the saved file (as long as the SpiderMonkey version is same)</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Nov 27 2024 09:38:46 GMT-0800 (Pacific Standard Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, I think you can rewrite the code with Stencil-based API without encode/decode, and the check the profile, and see how much time is taken by <code>JS::CompileGlobalScriptToStencil</code></td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Nov 27 2024 09:39:14 GMT-0800 (Pacific Standard Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if it's taking much time, then you can look into introducing the encode/decode</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Nov 27 2024 09:42:34 GMT-0800 (Pacific Standard Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, <code>JS::CompileGlobalScriptToStencil</code> can also be done in any thread.  the other option than encode/decode is to compile scripts in some other thread while the main thread is busy, and use the result in the main thread</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Nov 27 2024 09:44:06 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">both are done in Firefox.  If we have encoded stencil, retrieve it and decode it.  if we don't have it and the script is large enough,  compile it off main thread.  otherwise compile it on main thread.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Nov 27 2024 09:46:14 GMT-0800 (Pacific Standard Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in your case, I suppose the set of scripts is known (compared to browser's case where the script is unknown), so you can apply some more optimization based on the input</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Nov 27 2024 09:50:32 GMT-0800 (Pacific Standard Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@slavazavadsky:matrix.org">Vyacheslav Zavadsky</span>&gt;</div></td><td class="msg-cell">Is it fair summary that optimal time on JsContext thread is pair (JS::InstantiateGlobalStencil and JS_ExecuteScript). We need to benchmark vs JS_EvaluateScript to make a decision if we can improve. Then we can decide what is better to be done on extra thread (read+decode or CompileGlobalScriptToStencil )?</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Nov 27 2024 09:51:26 GMT-0800 (Pacific Standard Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Nov 27 2024 10:36:33 GMT-0800 (Pacific Standard Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Do we have an equivalent of <code>SetGlobalOptionsPreJSInit</code> in XPConnect?</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Nov 27 2024 10:37:42 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Or a way to ensure that we can reset a preference in safe mode?</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Nov 27 2024 10:53:19 GMT-0800 (Pacific Standard Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, wrong room</td></tr>

</tbody></table></div></div></div>
</body></html>