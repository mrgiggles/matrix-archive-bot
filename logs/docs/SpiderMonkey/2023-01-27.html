<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-01-27</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-01-27<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-01-26" class="nav-link"><span>prev</span></a>
<a href="2023-01-30" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Jan 27 2023 05:32:57 GMT-0800 (Pacific Standard Time)">13:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Where would i look for how to do a beta build and run on try? Is it the selector for release? <a href="https://firefox-source-docs.mozilla.org/tools/try/selectors/release.html">https://firefox-source-docs.mozilla.org/tools/try/selectors/release.html</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Jan 27 2023 05:33:54 GMT-0800 (Pacific Standard Time)">13:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I just want to run tests on a non-nightly build</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Jan 27 2023 05:39:18 GMT-0800 (Pacific Standard Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">hm, maybe this is it: <a href="https://wiki.mozilla.org/Sheriffing/How_To/Beta_simulations">https://wiki.mozilla.org/Sheriffing/How_To/Beta_simulations</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Jan 27 2023 05:39:51 GMT-0800 (Pacific Standard Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I'll check with the sherrifs</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Jan 27 2023 05:47:10 GMT-0800 (Pacific Standard Time)">13:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: there is something about atom marking being wrong with my patch. But the old cache stuff doesn't do any special  atom marking either. Does it rely on some side effect of something else?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Jan 27 2023 05:47:16 GMT-0800 (Pacific Standard Time)">13:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">or perhaps <span class="nick-4">jonco</span> knows</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Jan 27 2023 05:47:59 GMT-0800 (Pacific Standard Time)">13:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: the background here is bug 1808673 and bug 1811749. The first one has the patch now.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Jan 27 2023 05:48:00 GMT-0800 (Pacific Standard Time)">13:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1808673">https://bugzil.la/1808673</a> â€” NEW (nobody) â€” Investigate if MruCache would be useful for atom cache</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Jan 27 2023 05:48:01 GMT-0800 (Pacific Standard Time)">13:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1811749">https://bugzil.la/1811749</a> â€” NEW (nobody) â€” Investigate if AtomizeString could avoid JSRope::flatten in the cases when the atom is cached</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Jan 27 2023 05:48:57 GMT-0800 (Pacific Standard Time)">13:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I think the code should do some marking, but also for the existing cache, and I just can't see why it is not needed in that case.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Jan 27 2023 05:49:06 GMT-0800 (Pacific Standard Time)">13:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><em>looking</em></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Jan 27 2023 05:50:37 GMT-0800 (Pacific Standard Time)">13:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: <a href="https://searchfox.org/mozilla-central/rev/3a13c5ad9c1dbd065e484a399af75eb98c235def/js/src/vm/JSAtom.cpp#727,740">https://searchfox.org/mozilla-central/rev/3a13c5ad9c1dbd065e484a399af75eb98c235def/js/src/vm/JSAtom.cpp#727,740</a> why that is ok without any marking? Ah, is it because linear strings live always in a single zone, so the created jsatom is there.... that could be it</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Jan 27 2023 05:51:05 GMT-0800 (Pacific Standard Time)">13:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">and my patch doesn't have such guarantee since it just takes the string out of JSRope as raw characters</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Jan 27 2023 05:55:32 GMT-0800 (Pacific Standard Time)">13:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">hmm not sure what's going on here - what error are you getting</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Jan 27 2023 05:55:33 GMT-0800 (Pacific Standard Time)">13:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Jan 27 2023 05:56:15 GMT-0800 (Pacific Standard Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>:  <a href="https://treeherder.mozilla.org/logviewer?job_id=403715464&amp;repo=try&amp;lineNumber=20150">https://treeherder.mozilla.org/logviewer?job_id=403715464&amp;repo=try&amp;lineNumber=20150</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Jan 27 2023 05:56:29 GMT-0800 (Pacific Standard Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">we do purge the cache on gc, maybe you need to do something similar?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Jan 27 2023 05:56:44 GMT-0800 (Pacific Standard Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">The existing cache looks like it's runtime-wide so I think we should mark atoms when return one for a zone </td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Jan 27 2023 05:56:54 GMT-0800 (Pacific Standard Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I did add code to purge</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Jan 27 2023 05:57:30 GMT-0800 (Pacific Standard Time)">13:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: the existing cache is runtime wide, but it does JSLinearString -&gt; JSAtom mapping</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Jan 27 2023 05:57:36 GMT-0800 (Pacific Standard Time)">13:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">linear strings and ropes can live in any zone. Atoms live in the atoms zone</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Jan 27 2023 05:58:05 GMT-0800 (Pacific Standard Time)">13:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, so strings aren't bound to a zone?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Jan 27 2023 05:59:41 GMT-0800 (Pacific Standard Time)">13:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">non-atoms strings are bound to a single zone</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Jan 27 2023 05:59:57 GMT-0800 (Pacific Standard Time)">13:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">ok, that does explain the current behavior then</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Jan 27 2023 06:00:04 GMT-0800 (Pacific Standard Time)">14:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">(I mean, there's not a single zone for all of them)</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Jan 27 2023 06:00:36 GMT-0800 (Pacific Standard Time)">14:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">all strings live in a single zone; atoms only live in the atoms zone; any zone may have pointers into the atoms zone (but must mark the atoms)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Jan 27 2023 06:01:20 GMT-0800 (Pacific Standard Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: I can't find where we mark atoms for the existing cache - this must happen somewhere right?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Jan 27 2023 06:01:32 GMT-0800 (Pacific Standard Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">but ok, the old code is fine, since it does JSLinearString -&gt; atom mapping, and if that isn't found, the underlying code will add the atom to zone's cache</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Jan 27 2023 06:02:04 GMT-0800 (Pacific Standard Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/vm/JSAtom.cpp#457-465,485-486">https://searchfox.org/mozilla-central/source/js/src/vm/JSAtom.cpp#457-465,485-486</a> ?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Jan 27 2023 06:02:04 GMT-0800 (Pacific Standard Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: I think that happens as part of the atomization process, for that cache we just take the resulting atom and because we purge on gc it should be ok</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Jan 27 2023 06:03:06 GMT-0800 (Pacific Standard Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">How slow or fast is marking?</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Jan 27 2023 06:03:07 GMT-0800 (Pacific Standard Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">oh, we're not testing string equality but identity for the cache?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Jan 27 2023 06:03:37 GMT-0800 (Pacific Standard Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: yeah, and I'm adding string equality, since it seems to help react quite a bit</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Jan 27 2023 06:03:47 GMT-0800 (Pacific Standard Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: oh I see what you mean, yeah I think it works because it's based on string identity so the atom is tied to the zone that way</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Jan 27 2023 06:03:55 GMT-0800 (Pacific Standard Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">ok thanks I understand now :)</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Jan 27 2023 06:04:16 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">So, now I wonder if I should do marking, or just limit the cache per zone</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Jan 27 2023 06:04:17 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">it's already marked because we marked it when we atomized it originally</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Jan 27 2023 06:04:23 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">depends on the speed of the marking</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Jan 27 2023 06:05:44 GMT-0800 (Pacific Standard Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">maybe checking <code>cx-&gt;zone() == str-&gt;zone()</code> is simplest and fastest?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Jan 27 2023 06:05:57 GMT-0800 (Pacific Standard Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">you're going to have to mark an atom one way or another</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Jan 27 2023 06:07:40 GMT-0800 (Pacific Standard Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'd rely on the existing marking. Store zone in the AtomTableKey and when doing comparison, zones would need to match. That is one way</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Jan 27 2023 06:09:04 GMT-0800 (Pacific Standard Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">atom marking is going to faster than linearising the string if you make your cache miss for different zones</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Jan 27 2023 06:09:33 GMT-0800 (Pacific Standard Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">but atom marking might slow single zone usage, no?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Jan 27 2023 06:10:05 GMT-0800 (Pacific Standard Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">it's just setting a bit, it's definitely fast if the atom's already marked</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Jan 27 2023 06:10:14 GMT-0800 (Pacific Standard Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">(it might require allocation otherwise)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Jan 27 2023 06:11:22 GMT-0800 (Pacific Standard Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">let me try that then</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Jan 27 2023 06:11:48 GMT-0800 (Pacific Standard Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: cx-&gt;markAtom(atom); ?</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Jan 27 2023 06:12:13 GMT-0800 (Pacific Standard Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Jan 27 2023 06:12:24 GMT-0800 (Pacific Standard Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">but yeah, try it and see</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Jan 27 2023 06:14:21 GMT-0800 (Pacific Standard Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Jan 27 2023 08:54:53 GMT-0800 (Pacific Standard Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><p>The following code is noticeably faster in V8 than SM</p>
<pre><code>function do_extend(o) {
  var result = Object.assign({}, o, {canvasOriginX: 0, canvasOriginY: 1 });
  return result;
}

var o = { w: 0, x: 1, y: 2, z: 3 };
var n = 1e8;

function test(fn) {
  var result;
  for (var i = 0; i &lt; n; ++i) result = fn(o);
  return result;
}

</code></pre>
<p>Is that expected?</p>
</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Jan 27 2023 08:55:06 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">SM: 9397ms</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Jan 27 2023 08:55:22 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">V8: 8671ms</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Jan 27 2023 09:00:38 GMT-0800 (Pacific Standard Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">the interest in Object.assign comes from the react-stockcharts benchmark</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Jan 27 2023 09:01:00 GMT-0800 (Pacific Standard Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">and is a pattern that's pretty common in React apps</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Jan 27 2023 09:04:33 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: is this <code>Object.assign</code> which is slow, or <code>do_extend</code>? Have you looked at the details of what "being slow" means in this test case?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Jan 27 2023 09:04:53 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: I have not</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Jan 27 2023 09:05:12 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Have you opened a bug?</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Jan 27 2023 09:05:21 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">nope</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Jan 27 2023 09:05:25 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">I'd be happy to though</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Jan 27 2023 09:06:13 GMT-0800 (Pacific Standard Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">I hope to have my perf profiling setup working again soon to better answer the question of what part is slow</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Jan 27 2023 09:06:29 GMT-0800 (Pacific Standard Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">I can file a bug once I have a decent profile</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Jan 27 2023 09:08:20 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">That would be great ;) Thanks</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Jan 27 2023 09:18:20 GMT-0800 (Pacific Standard Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">interestingly enough the version that uses spread is way slower:<br><code>  var result = {...o, ...{canvasOriginX: 0, canvasOriginY: 1 }};</code><br><code>v8: 84219 ms</code><br><code>sm: 16306 ms</code></td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Jan 27 2023 09:20:12 GMT-0800 (Pacific Standard Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Huh, it's interesting that v8 is so much slower than we are there. That's a case we don't optimize very much.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Jan 27 2023 09:22:38 GMT-0800 (Pacific Standard Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">is spread intrinsically more expensive or just not something that anybody has cared about making fast?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Jan 27 2023 09:22:56 GMT-0800 (Pacific Standard Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><a href="https://babeljs.io/docs/en/babel-plugin-transform-react-jsx#usespread">https://babeljs.io/docs/en/babel-plugin-transform-react-jsx#usespread</a></td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Jan 27 2023 09:24:52 GMT-0800 (Pacific Standard Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">It is possible that the spread operator, using the iterator pattern, benefit from scalar replacement &amp; escape analysis to get rid of the iterator allocations.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Jan 27 2023 09:32:23 GMT-0800 (Pacific Standard Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: is that a reason spread would be faster than Object.assign or a reason it should be slower?</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Jan 27 2023 09:36:33 GMT-0800 (Pacific Standard Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Spread is somewhat tricky to optimize because you can spread anything that supports the Iterator protocol</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Jan 27 2023 09:37:57 GMT-0800 (Pacific Standard Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So you have to support everything from an array to a generator</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Jan 27 2023 09:42:35 GMT-0800 (Pacific Standard Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, apparently we have some code to handle that spread case when creating an object. I was thinking about spread calls, where we don't do anything fancy unless there's a single spread parameter and nothing else.</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Jan 27 2023 10:00:35 GMT-0800 (Pacific Standard Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: using scalar replacement would make us faster once in Ion/Warp.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Jan 27 2023 10:41:03 GMT-0800 (Pacific Standard Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">one part of <code>Object.assign</code> was looked at in bug 1648546</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Jan 27 2023 10:41:05 GMT-0800 (Pacific Standard Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1648546">https://bugzil.la/1648546</a> â€” NEW (nobody) â€” Optimize Object.assign in CacheIR</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Jan 27 2023 10:42:43 GMT-0800 (Pacific Standard Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I would expect <code>Object.assign</code> to be very common. And I expect spread to take over from other things pretty rapidly with new code. It's a lot nicer to use than the alternatives.</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Jan 27 2023 10:52:21 GMT-0800 (Pacific Standard Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I ran an experiment a while ago to see how often spread calls were used on the web, to see if we should expand our coverage of spread calls beyond <code>foo(...oneArray)</code>, and it turned out that they barely showed up at all</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Jan 27 2023 10:52:42 GMT-0800 (Pacific Standard Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But that was spread calls, not initializing objects using spread syntax</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Jan 27 2023 14:39:51 GMT-0800 (Pacific Standard Time)">22:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-6">Tim</span>: ðŸ‘‹ Glad to see you pushing Change Array by Copy forward -- I have pinged our fuzzing team to see if they can get it fuzzed now.</blockquote></mx-reply>Based on the checklist, it seems like the only thing left to do is the "Intent to Ship" email and filing a follow-up bug to remove the preference/command-line flag?</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Jan 27 2023 14:40:43 GMT-0800 (Pacific Standard Time)">22:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">That seems plausible -- I haven't heard back from our fuzzing team, so I'd give it a week or so, but we can probably ship on nightly week after next (and yes, send the intent to ship) </td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Jan 27 2023 14:41:19 GMT-0800 (Pacific Standard Time)">22:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">also, you asked about cross-compartment creation -- I'm still thinking about that</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Jan 27 2023 14:44:20 GMT-0800 (Pacific Standard Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">Where would I look for an example of how that's tested for in another existing builtin? (I'm assuming there are no examples for array methods since there aren't any other array methods that copy an array, as far as I can see)</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Jan 27 2023 14:46:42 GMT-0800 (Pacific Standard Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>Yeah -- the kind of test cases I'm thinking about are (in the shell) something along the lines of</p>
<pre><code>g = newGlobal({newCompartment: true})
w = g.eval([].with)
w.call([1,2,3], 1, 3)
</code></pre>
<p>There's a couple of things of interest there:</p>
<ol>
<li>Did it work;</li>
<li>Is the resulting array -from the right realm- (the above test case is also interesting for cross-realm testing if you just drop the new compartment thing)</li>
</ol>
</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Jan 27 2023 14:48:59 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(I'm just about to drop for the weekend, but <a href="https://searchfox.org/mozilla-central/search?q=newGlobal%28%7B&amp;path=js%2Fsrc%2Ftests%2F&amp;case=false&amp;regexp=false">this searchfox query</a> shows a number of tests of the sort I was thinking about)</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Jan 27 2023 14:49:44 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Jan 27 2023 15:10:10 GMT-0800 (Pacific Standard Time)">23:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">Did you mean for line 2 to be <code>g.eval('[].with')</code>?</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Jan 27 2023 15:27:30 GMT-0800 (Pacific Standard Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yep :)</td></tr>

</tbody></table></div></div></div>
</body></html>