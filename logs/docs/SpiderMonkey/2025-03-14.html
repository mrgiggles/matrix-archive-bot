<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-03-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-03-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-03-13" class="nav-link"><span>prev</span></a>
<a href="2025-03-17" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Mar 14 2025 07:01:12 GMT-0700 (Pacific Daylight Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: hello! :) does this ST rings a bell to you? first time I see that. It crashes the inference process <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1954129">https://bugzilla.mozilla.org/show_bug.cgi?id=1954129</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Mar 14 2025 07:27:11 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">I have not seen that before</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Mar 14 2025 07:27:34 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">Good to know, I'll take a look at it</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Mar 14 2025 07:41:59 GMT-0700 (Pacific Daylight Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">thanks <span class="nick-16">Ryan Hunt</span></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Mar 14 2025 08:48:38 GMT-0700 (Pacific Daylight Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>:  When you have a minute, can I get a review for <a href="https://phabricator.services.mozilla.com/D241204">https://phabricator.services.mozilla.com/D241204</a> please?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Mar 14 2025 10:22:08 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">sorry, done</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Mar 14 2025 10:24:16 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">no worries, thanks!</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Mar 14 2025 10:42:10 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: can you approve it? if you do approve of course ;)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Mar 14 2025 10:43:22 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Argh. Sorry. Done for real this time.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Mar 14 2025 16:11:43 GMT-0700 (Pacific Daylight Time)">23:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think I may have just cracked a microbenchmark performance puzzle that has been intermittently driving me crazy since last summer.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Mar 14 2025 16:14:25 GMT-0700 (Pacific Daylight Time)">23:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Specifically, the one described in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1911160#c1">this comment</a> about why unboxing a stack argument is unexpectedly slow.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Mar 14 2025 16:15:32 GMT-0700 (Pacific Daylight Time)">23:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I mention somewhere in that bug that the CPU should almost be able to store-forward the value from whenever the caller pushed it, so it should definitely be in the L1 cache</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Mar 14 2025 16:17:24 GMT-0700 (Pacific Daylight Time)">23:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But I never actually went and looked at the caller. It turns out that the Ion caller is writing a known Int32 value to the stack in two pieces (payload and tag), and we're reading it back in one piece.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Mar 14 2025 16:18:02 GMT-0700 (Pacific Daylight Time)">23:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Something in that is presumably confusing the store-forwarding and/or top-of-stack logic</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Mar 14 2025 16:19:03 GMT-0700 (Pacific Daylight Time)">23:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Not sure whether this is specific to my CPU, or widespread</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Mar 14 2025 16:19:35 GMT-0700 (Pacific Daylight Time)">23:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jlink:mozilla.org">jlink</span>&gt;</div></td><td class="msg-cell">You're doing two 32-bit writes? Or two writes that are smaller but into the same 32-bit spot?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Mar 14 2025 16:19:47 GMT-0700 (Pacific Daylight Time)">23:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Two 32-bit writes.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Mar 14 2025 16:19:56 GMT-0700 (Pacific Daylight Time)">23:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Eg:</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Mar 14 2025 16:20:00 GMT-0700 (Pacific Daylight Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><pre><code>[Codegen] movl       %eax, -0x28(%rbp)
[Codegen] movl       $0xfff88000, -0x24(%rbp)
</code></pre>
</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Mar 14 2025 16:21:28 GMT-0700 (Pacific Daylight Time)">23:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p>Here's a testcase.</p>
<pre><code>function id(x) { return x; }

function foo() {
  for (var i = 0; i &lt; 10000000; i++) {
    // Pick one:
    id(0); // Fast
    id(i); // slow
  }
}

let start = Date.now();
for (var j = 0; j &lt; 10; j++) {
  foo();
}
print(Date.now() - start);
</code></pre>
<p>If anybody has an opt build of the shell lying around and can test out the two different configurations (id(0) and id(i)), it would be very interesting to see if you get a performance difference between them. Locally, id(0) is more than twice as fast.</p>
</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Mar 14 2025 16:42:54 GMT-0700 (Pacific Daylight Time)">23:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Should have specified: the test should be run with --ion-inlining=off.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Mar 14 2025 16:44:56 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Commenting out <a href="https://searchfox.org/mozilla-central/source/js/src/jit/x64/MacroAssembler-x64.h#151-153">this code</a> makes us faster than V8 (with no inlining).</td></tr>

</tbody></table></div></div></div>
</body></html>