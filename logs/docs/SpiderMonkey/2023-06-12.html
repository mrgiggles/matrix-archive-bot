<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-06-12</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-06-12<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-06-11" class="nav-link"><span>prev</span></a>
<a href="2023-06-13" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sun Jun 11 2023 21:08:37 GMT-0700 (Pacific Daylight Time)">04:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">How does <code>JSPropertySpec::Name</code> work with symbols? Does it just accept a <code>Symbol*</code>? I'm confused since it just says its a <code>uintptr_t</code>.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jun 12 2023 00:51:32 GMT-0700 (Pacific Daylight Time)">07:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">It's  <code>SymbolCode + 0x1</code> <a href="https://searchfox.org/mozilla-central/source/js/public/PropertySpec.h#168">https://searchfox.org/mozilla-central/source/js/public/PropertySpec.h#168</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jun 12 2023 01:08:39 GMT-0700 (Pacific Daylight Time)">08:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I think I've got it!</p>
<pre><code>#define XP_WIN 1
#define JS_CODEGEN_X86 1
#define JS_JITSPEW 1
#define JS_MASM_VERBOSE 1
#define JS_STANDALONE 1
#define MOZ_DEBUG 1
#define MOZ_DIAGNOSTIC_ASSERT_ENABLED 1
</code></pre>
</blockquote></mx-reply>I did some work on this in the past: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1590907">https://bugzilla.mozilla.org/show_bug.cgi?id=1590907</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jun 12 2023 05:04:18 GMT-0700 (Pacific Daylight Time)">12:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I did some work on this in the past: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1590907">https://bugzilla.mozilla.org/show_bug.cgi?id=1590907</a></blockquote></mx-reply>should I open a new bug?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jun 12 2023 06:24:10 GMT-0700 (Pacific Daylight Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: Does the Wasm GC work require integration with the JS GC? I'm mostly wondering about whether the tracing might have changed in any kind of way that the cycle collector would need to be aware of.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jun 12 2023 06:38:06 GMT-0700 (Pacific Daylight Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: Jon is on pto today, but as far as I know Wasm GC objects are traced like other JS objects so I think it should just work with the CC</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jun 12 2023 06:40:07 GMT-0700 (Pacific Daylight Time)">13:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-16">mccr8</span>: Jon is on pto today, but as far as I know Wasm GC objects are traced like other JS objects so I think it should just work with the CC</blockquote></mx-reply>Thanks. Yeah I don't see a new TraceKind for them so I think it should be okay.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jun 12 2023 06:40:19 GMT-0700 (Pacific Daylight Time)">13:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Messing with the TraceKinds is really what causes issues, I think.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jun 12 2023 06:40:47 GMT-0700 (Pacific Daylight Time)">13:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah internally they're just a special kind of <code>JSObject</code></td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jun 12 2023 06:40:51 GMT-0700 (Pacific Daylight Time)">13:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Cool.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jun 12 2023 06:41:15 GMT-0700 (Pacific Daylight Time)">13:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I should probably add changes to TraceKind.h to my Phabricator "watch list"...</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jun 12 2023 08:32:23 GMT-0700 (Pacific Daylight Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: I <a href="https://phabricator.services.mozilla.com/D180403#5963723">commented</a> on the initialization failure patch, but you might need to take that bug over if I'm getting the data structures' relationships wrong. Falling back to something closer to the previous behavior would probably be safer?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jun 12 2023 08:35:31 GMT-0700 (Pacific Daylight Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: ah you're right, I missed that the <code>clearJitZone</code> call was moved in this version</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jun 12 2023 08:36:09 GMT-0700 (Pacific Daylight Time)">15:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I wonder if changing <code>updateAllZoneAllocFlags</code> to skip the atoms zone is more like the previous behavior</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jun 12 2023 08:38:00 GMT-0700 (Pacific Daylight Time)">15:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Probably. Is that the only zone that is going to be used here for self-hosting and baseline etc (the stuff that happens during initialization). I guess it would leak on initialization before?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jun 12 2023 08:43:17 GMT-0700 (Pacific Daylight Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: I don't think we run any script or JIT compilation before <code>createJitRuntime</code>, so it'd be just the trampolines allocated in the atoms zone under <code>createJitRuntime</code></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jun 12 2023 08:44:24 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">there's a release assert in <code>InitSelfHostedCode</code> that it's only called once, so as long as callers check the return value of that I think everything gets cleaned up as part of the destroy-runtime gc?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jun 12 2023 08:46:18 GMT-0700 (Pacific Daylight Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the <code>JitZone</code> pointers are still there, whatever that means.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jun 12 2023 08:46:59 GMT-0700 (Pacific Daylight Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">they are deleted when we destroy the atoms zone</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jun 12 2023 08:47:23 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and generateBaselineICFallbackCode and GenerateBaselineInterpreter don't create anything in other zones?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jun 12 2023 08:48:03 GMT-0700 (Pacific Daylight Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">no it's all in the atoms zone</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jun 12 2023 08:50:08 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it's a bit unfortunate that <code>createJitRuntime</code> still creates the <code>JitZone</code> on OOM but I don't know if there's a simple fix</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jun 12 2023 08:51:14 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so to be sure I understand: the atoms zone's <code>JitZone</code> is deleted when the atoms zone is destroyed, but the <code>JitZone*</code> field is not cleared out?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jun 12 2023 08:52:46 GMT-0700 (Pacific Daylight Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">because <code>UpdateAllZoneAllocFlags</code> gets the atoms zone when it iterates over zones, even though the shutdown GC has happened</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jun 12 2023 08:52:55 GMT-0700 (Pacific Daylight Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: I was looking at this: <a href="https://searchfox.org/mozilla-central/rev/b91e9bef5a6d6f7b549fbc9cba70cb4665ed3866/js/src/gc/Zone.cpp#205">https://searchfox.org/mozilla-central/rev/b91e9bef5a6d6f7b549fbc9cba70cb4665ed3866/js/src/gc/Zone.cpp#205</a></td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jun 12 2023 08:53:34 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess the question is whether the atoms zone is actually deleted, then</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jun 12 2023 08:53:53 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it should be deleted as part of the final gc</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jun 12 2023 08:54:21 GMT-0700 (Pacific Daylight Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, and I'm not sure that's happening in this failed-initialization case, given that it's still present to be iterated over.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Jun 12 2023 08:54:39 GMT-0700 (Pacific Daylight Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe I'll walk through another rr recording and see whether it's being deleted.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Jun 12 2023 08:57:54 GMT-0700 (Pacific Daylight Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I can see that during that after disabling the nursery, there's still 1 zone left in GCRuntime::zones ...</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Jun 12 2023 09:07:49 GMT-0700 (Pacific Daylight Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it looks like the GC skips the atoms zone when sweeping zones, and only deletes it when <a href="https://searchfox.org/mozilla-central/source/js/src/gc/GC.cpp#917-928">killing the GCRuntime</a>, but the delete is soon <em>after</em> disabling the nursery.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Jun 12 2023 09:08:36 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so the atoms zone in particular will always be alive, and its <code>JitZone*</code> is the one causing problems.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Jun 12 2023 09:16:58 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the alloc flags are irrelevant ot the atoms zone, I think, so making <code>Nursery::updateAllZoneAllocFlags</code> skip the atoms zone is totally reasonable. I guess it just makes me nervous that we have inconsistent state, where <code>jitRuntime_</code> is null but the atoms zone still has a non-null <code>jitZone_</code> pointer. Changing the nursery will fix this immediately problem, but could it come back if something else decides to cancel offthread compiles for some other reason?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Jun 12 2023 09:18:30 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">given that this is specific to the atoms zone, my current patch that iterates over all zones doesn't seem right</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Jun 12 2023 09:18:44 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it'd have to be something in GC because I think that's the only thing that runs if initialization fails there</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Jun 12 2023 09:19:07 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">maybe we could also check for this in <code>JitDataStructuresExist</code>?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Jun 12 2023 09:19:22 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I was worried about slowing that down for a corner case, but yes, that would do it too</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Jun 12 2023 09:23:13 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I think ideally we'd stop using the atoms zone for this and instead store trampolines directly in <code>JitRuntime</code>. They live until we destroy the runtime so we don't need <code>JitCode</code>'s GC tracing for them. That's a much larger change though</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Jun 12 2023 09:24:19 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">right, makes sense</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Jun 12 2023 09:24:30 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, it's seeming like right now the thing to do is just skip the atoms zone</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon Jun 12 2023 09:25:21 GMT-0700 (Pacific Daylight Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah that should work</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon Jun 12 2023 09:26:02 GMT-0700 (Pacific Daylight Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and maybe add an assert somewhere if I can figure out a good place</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon Jun 12 2023 09:26:27 GMT-0700 (Pacific Daylight Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It's  <code>SymbolCode + 0x1</code> <a href="https://searchfox.org/mozilla-central/source/js/public/PropertySpec.h#168">https://searchfox.org/mozilla-central/source/js/public/PropertySpec.h#168</a></blockquote></mx-reply>huh, what's the <code>+1</code> for, to make nullptr a valid name (w/ string) or smth?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Mon Jun 12 2023 09:28:06 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">maybe we could assert in <code>CancelOffThreadIonCompileLocked</code> before getting the runtime's lazy link list</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Mon Jun 12 2023 09:29:14 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Redfire</span>: see line 171, 0 means uninitialized. (Searchfox thinks that <code>operator bool</code> definition is unused so I don't know if we actually depend on that. Maybe for the end-of-list sentinel value.)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Mon Jun 12 2023 09:59:54 GMT-0700 (Pacific Daylight Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">nvm</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Mon Jun 12 2023 10:53:58 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">it gives me a great confidence boost, when I browse mozilla sources and find the same design decisions that I made when embedding SM :D</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Mon Jun 12 2023 11:55:42 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it means you and someone else are smoking the same stuff</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Mon Jun 12 2023 14:34:57 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">hm... I've found a weird thing: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/ErrorReporting.h#77">https://searchfox.org/mozilla-central/source/js/src/vm/ErrorReporting.h#77</a>
Exception object is stored in JS::HandleValue without any tracers. Shouldn't it cause problems because of GC?

call site: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/JSContext.cpp#897">https://searchfox.org/mozilla-central/source/js/src/vm/JSContext.cpp#897</a></td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Mon Jun 12 2023 15:02:05 GMT-0700 (Pacific Daylight Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">TheQwertiest</span>: Handles don't need to be traced. A HandleValue is a pointer to a RootedValue. The GC knows about the RootedValue. If a GC happens and moves an object referenced by the RootedValue, it will update the pointer stored in the RootedValue, and then loading that pointer through the HandleValue will see the new location.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Mon Jun 12 2023 15:02:41 GMT-0700 (Pacific Daylight Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">ah</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Mon Jun 12 2023 15:03:47 GMT-0700 (Pacific Daylight Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">Never would've guessed that Handles could be used like that, thanks =)</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Mon Jun 12 2023 15:05:05 GMT-0700 (Pacific Daylight Time)">22:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Note that it only works because the ReportExceptionClosure is stack-allocated, so the (also stack-allocated) RootedValue must outlive the Handle. This wouldn't be safe if we were storing the handle in a heap object that outlived the root.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Mon Jun 12 2023 15:07:26 GMT-0700 (Pacific Daylight Time)">22:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">it would've worked even with heap allocated closure, if it's lifetime is greater than the root's though, no?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Mon Jun 12 2023 15:07:50 GMT-0700 (Pacific Daylight Time)">22:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">"heap" as in c++ heap</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Mon Jun 12 2023 15:11:50 GMT-0700 (Pacific Daylight Time)">22:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It would work assuming you were right about the lifetime</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Mon Jun 12 2023 15:11:57 GMT-0700 (Pacific Daylight Time)">22:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But that's the sort of thing we try to avoid doing</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Mon Jun 12 2023 16:09:43 GMT-0700 (Pacific Daylight Time)">23:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">is it possible to somehow add tracer callback to js context?</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Mon Jun 12 2023 16:22:49 GMT-0700 (Pacific Daylight Time)">23:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">context: currently I store JS::Heap value manager in global object, but I think there's no really need to do that, since JS::Heap values don't care much about global anyway</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Mon Jun 12 2023 16:26:56 GMT-0700 (Pacific Daylight Time)">23:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Does <code>JS_AddExtraGCRootsTracer</code> not work?</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Mon Jun 12 2023 16:30:46 GMT-0700 (Pacific Daylight Time)">23:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">can anyone point me to some details on how top-level async is meant to work? I'm debugging a divergence with some of my local changes and finding <code>ResumeKind</code> values differing, but in bytecode whose origin I can't pinpoint; I suspect maybe a toplevel driver loop of some sort is synthesized?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Mon Jun 12 2023 16:30:51 GMT-0700 (Pacific Daylight Time)">23:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Does <code>JS_AddExtraGCRootsTracer</code> not work?</blockquote></mx-reply>it most likely does, I just didnt manage to find it myself :D</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Mon Jun 12 2023 16:30:54 GMT-0700 (Pacific Daylight Time)">23:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">thanks :)</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Mon Jun 12 2023 16:34:47 GMT-0700 (Pacific Daylight Time)">23:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@jesup:mozilla.org">jesup</span>&gt;</div></td><td class="msg-cell">Someone told me a Long Time Ago that we don't JIT JS code in DEBUG builds.  This seems somewhat suspect, so I wanted to check.  (Trying to figure out causes of slowness in Debug Opt builds).   Also do we still rescan/GC the JS heap aggressively in debug builds, or did that get turned off?</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Mon Jun 12 2023 16:40:06 GMT-0700 (Pacific Daylight Time)">23:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">We definitely JIT in DEBUG builds. I don't think the thresholds are different for DEBUG, but I could be wrong.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Mon Jun 12 2023 16:41:03 GMT-0700 (Pacific Daylight Time)">23:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we don't exactly GC more aggressively in DEBUG, but we do verification passes that look at lots (all?) of the heap and I think are about as slow as a GC.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Mon Jun 12 2023 16:42:01 GMT-0700 (Pacific Daylight Time)">23:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the idea of identifying what DEBUG checks are most expensive and selectively enabling/disabling them comes up periodically, but nobody's done it</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Mon Jun 12 2023 16:49:59 GMT-0700 (Pacific Daylight Time)">23:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> can anyone point me to some details on how top-level async is meant to work? I'm debugging a divergence with some of my local changes and finding <code>ResumeKind</code> values differing, but in bytecode whose origin I can't pinpoint; I suspect maybe a toplevel driver loop of some sort is synthesized?</blockquote></mx-reply>found some relevant bits (<a href="https://searchfox.org/mozilla-central/source/js/src/builtin/Promise.cpp#6415">https://searchfox.org/mozilla-central/source/js/src/builtin/Promise.cpp#6415</a>), nevermind :-)</td></tr>

</tbody></table></div></div></div>
</body></html>