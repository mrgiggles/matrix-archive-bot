<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-06-01</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-06-01<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-05-31" class="nav-link"><span>prev</span></a>
<a href="2022-06-02" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue May 31 2022 20:24:05 GMT-0700 (Pacific Daylight Time)">03:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">When I'm doing GC Tracing, do I have to worry about multi-threading pitfalls? I.e. if the GC identifies all live Heap objects, but by the time it's finished some more of Objects have been created which weren't traced and hence accidentally get destroyed. Do I have to use locks to prevent this kind of thing, or is the GC smart enough too deal with it on its own?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue May 31 2022 20:24:54 GMT-0700 (Pacific Daylight Time)">03:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I'm asking this because I've read that GC happens on a background thread...</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue May 31 2022 23:33:30 GMT-0700 (Pacific Daylight Time)">06:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">workers have a non-null <code>parentRuntime</code>, but it would probably be safest and more robust to add a <code>ContextOption</code> that you set for the main thread in <code>XPCJSContext.cpp</code></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Jun 01 2022 01:34:16 GMT-0700 (Pacific Daylight Time)">08:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> When I'm doing GC Tracing, do I have to worry about multi-threading pitfalls? I.e. if the GC identifies all live Heap objects, but by the time it's finished some more of Objects have been created which weren't traced and hence accidentally get destroyed. Do I have to use locks to prevent this kind of thing, or is the GC smart enough too deal with it on its own?</blockquote></mx-reply>You don't have to worry, the GC handles this for you</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Jun 01 2022 01:34:41 GMT-0700 (Pacific Daylight Time)">08:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Nothing that is created during an incremental GC gets swept.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Jun 01 2022 02:53:04 GMT-0700 (Pacific Daylight Time)">09:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">What a relief!</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Jun 01 2022 02:53:12 GMT-0700 (Pacific Daylight Time)">09:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Thanks for your response.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jun 01 2022 05:13:59 GMT-0700 (Pacific Daylight Time)">12:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell"><p>I want to add a custom binary (custom shell for wasm stuff) alongside with existing <code>js/src/shell</code>. I've copied <code>js/src/shell</code> into <code>js/src/my-shell</code>, updated <code><a href="http://moz.build">moz.build</a></code>- <code>GeckoProgram("my-shell", linkage=None)</code> and updated the config file accordingly <code>ac_add_options --enable-application=my-shell</code>.<br>For unknown reason I get:</p>
<pre><code>Adding configure options from .../mozconfigs/release_wasi
  --enable-application=my-shell
  --target=wasm32-unknown-wasi
  --with-sysroot=/opt/wasi-sdk/share/wasi-sysroot/
  --disable-stdcxx-compat
  --without-system-zlib
  --without-intl-api
  --disable-shared-js
  --disable-shared-memory
  --disable-tests
  --disable-cranelift
  --disable-jemalloc
checking for host system type... 
Executing: `sh .../mozilla_ref/build/moz.configure/../autoconf/config.guess`
x86_64-pc-linux-gnu
checking for target system type... 
Executing: `sh .../mozilla_ref/build/moz.configure/../autoconf/config.sub wasm32-unknown-wasi`
Unknown OS: wasi

</code></pre>
<p>If I change existing shell and don't try to introduce my own - everything is OK.</p>
<p>Who has an expertise in SM build system to consult me?</p>
</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jun 01 2022 05:23:17 GMT-0700 (Pacific Daylight Time)">12:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell">target OS is <code>wasi</code> and this is OK because SM supports wasi but not in my shell</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jun 01 2022 05:29:18 GMT-0700 (Pacific Daylight Time)">12:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell">btw, what is a usual way to add custom binary into SM?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jun 01 2022 05:36:34 GMT-0700 (Pacific Daylight Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">dbezhetskov</span>: I wonder if it's simpler to follow jsapi-tests, see <a href="http://moz.build">moz.build</a> file <a href="https://searchfox.org/mozilla-central/source/js/src/jsapi-tests/moz.build">here</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jun 01 2022 05:37:39 GMT-0700 (Pacific Daylight Time)">12:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">a separate binary that's usually included when building the shell (depending on <code>--{enable,disable}-tests</code> configure flag)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jun 01 2022 05:38:37 GMT-0700 (Pacific Daylight Time)">12:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@awingo:igalia.com">wingo</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">dbezhetskov</span>: on the side apparently in moz.configure/init.configure, allow_wasi is false</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jun 01 2022 05:38:57 GMT-0700 (Pacific Daylight Time)">12:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@awingo:igalia.com">wingo</span>&gt;</div></td><td class="msg-cell">so whatever is calling split_triplet is not passing allow_wasi=true</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jun 01 2022 06:37:08 GMT-0700 (Pacific Daylight Time)">13:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">dbezhetskov</span>: I wonder if it's simpler to follow jsapi-tests, see <a href="http://moz.build">moz.build</a> file <a href="https://searchfox.org/mozilla-central/source/js/src/jsapi-tests/moz.build">here</a></blockquote></mx-reply>hmm, didn't understand how it is working, we build all these .cpp tests and then link them into the test main? I don't see any executable name in the <a href="http://moz.build">moz.build</a> for jsapi-tests</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jun 01 2022 06:37:57 GMT-0700 (Pacific Daylight Time)">13:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">there is one named jsapi-tests, which executes all the tests listed in the cpp files.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Jun 01 2022 06:43:46 GMT-0700 (Pacific Daylight Time)">13:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: I haven't finished reviewing this but am going out for a little bit, and wanted to be sure you saw the clang-tidy comment on <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1772129">https://bugzilla.mozilla.org/show_bug.cgi?id=1772129</a> (I also commented) -- there's a missing variable name, so the RAII object isn't doing anything.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Jun 01 2022 06:44:15 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: oh thanks</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jun 01 2022 06:49:23 GMT-0700 (Pacific Daylight Time)">13:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: wait, where's the missing variable name?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jun 01 2022 07:02:45 GMT-0700 (Pacific Daylight Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell">one more stupid question, if I declare <code>GeckoProgram("my-tests", linkage=None)</code>, what should I write inside mach config to build <code>my-tests</code>? I tried <code>ac_add_options --enable-application=my-tests</code> but mach returns <code>ERROR: Cannot find project my-tests</code></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jun 01 2022 07:03:18 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">jsapi-tests gets built automatically with the shell, so I was thinking that'd work for your shell too?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jun 01 2022 07:05:28 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">so you'd just keep using <code>--enable-application=js</code></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jun 01 2022 07:07:27 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell">hmm, I need my own custom shell as a wasm module in the end, I can't build it with all js-tests .cpp files</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jun 01 2022 07:08:19 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">jsapi-tests is just an example for how to add a binary to the JS shell's build system</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jun 01 2022 07:12:01 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell">aha, I see, actually I'm doing the same scheme for my custom shell</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jun 01 2022 07:38:30 GMT-0700 (Pacific Daylight Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell">hmm, looks like js-tests approach isn't working for me, I need a fully custom <code>js-shell</code>, I don't want to build the original shell, or maybe I misunderstand something</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jun 01 2022 07:39:16 GMT-0700 (Pacific Daylight Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">is there a problem with building the original shell next to yours?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jun 01 2022 07:43:00 GMT-0700 (Pacific Daylight Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> is there a problem with building the original shell next to yours?</blockquote></mx-reply>I think no, in theory, but why I need to build it, I don't need it?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Jun 01 2022 07:44:11 GMT-0700 (Pacific Daylight Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">dbezhetskov</span>: I think you can turn it off with a configure flag or similar, not all browser builds build the js shell afaik</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Jun 01 2022 07:44:48 GMT-0700 (Pacific Daylight Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">ah here: <a href="https://searchfox.org/mozilla-central/rev/3419858c997f422e3e70020a46baae7f0ec6dacc/js/src/moz.build#53">https://searchfox.org/mozilla-central/rev/3419858c997f422e3e70020a46baae7f0ec6dacc/js/src/moz.build#53</a></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Jun 01 2022 08:09:12 GMT-0700 (Pacific Daylight Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@dbezhetskov:igalia.com">dbezhetskov</span>&gt;</div></td><td class="msg-cell">thanks <span class="nick-10">jandem</span>, it works, I've just added my shell into <code>DIRS += [ "rust", "shell", "wasm-shell",]</code> instead of <code>TEST DIRS</code> because we don't build jstests for wasi target</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Jun 01 2022 08:18:12 GMT-0700 (Pacific Daylight Time)">15:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Oh this is neat: <a href="https://twitter.com/jimmyhmiller/status/1531638254264541185">https://twitter.com/jimmyhmiller/status/1531638254264541185</a> </td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Jun 01 2022 08:19:10 GMT-0700 (Pacific Daylight Time)">15:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: oh sorry, I thought I had linked the phabricator rev. <a href="https://phabricator.services.mozilla.com/D147849#inline-814926">https://phabricator.services.mozilla.com/D147849#inline-814926</a></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Jun 01 2022 08:19:34 GMT-0700 (Pacific Daylight Time)">15:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: thanks, that was silly</td></tr>

</tbody></table></div></div></div>
</body></html>