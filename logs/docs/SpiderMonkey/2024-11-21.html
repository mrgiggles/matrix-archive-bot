<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-11-21</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-11-21<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-11-20" class="nav-link"><span>prev</span></a>
<a href="2024-11-22" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Nov 20 2024 21:21:29 GMT-0800 (Pacific Standard Time)">05:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">Hello, <span class="nick-15">arai</span> ! I updated the rev, could you please review it if possible (<a href="https://phabricator.services.mozilla.com/D229445">https://phabricator.services.mozilla.com/D229445</a>)?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Nov 20 2024 21:25:51 GMT-0800 (Pacific Standard Time)">05:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><p>Also it seems that I find the funny thing:</p>
<p>In Mozilla Firefox and Google Chrome the next commands in the console are the same and have the right output:</p>
<pre><code>&gt; Number.parseInt(-0)
&lt; 0
&gt; Number.parseInt("-0")
&lt; -0
</code></pre>
<p>But if I try to use <code>console.log</code> in Google Chrome, it prints the wrong line:</p>
<pre><code>&gt; console.log("%d", -0)
0
&lt; undefined

&gt; console.log("%d", "-0")
0
&lt; undefined
</code></pre>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Nov 20 2024 21:27:57 GMT-0800 (Pacific Standard Time)">05:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what's the expected output?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Nov 20 2024 21:29:05 GMT-0800 (Pacific Standard Time)">05:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><p>From here (<a href="https://console.spec.whatwg.org/#formatter">https://console.spec.whatwg.org/#formatter</a>)</p>
<blockquote>
<p>Otherwise, let converted be the result of Call(%parseInt%, undefined, « current, 10 »).</p>
</blockquote>
<p>So It seems, that the second console.log should print -0, but I'm not sure</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Nov 20 2024 21:31:48 GMT-0800 (Pacific Standard Time)">05:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sounds reasonable.  it would be nice to add a testcase once the DevTools side is fixed :)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Nov 20 2024 21:33:16 GMT-0800 (Pacific Standard Time)">05:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">I'd like to clarify whether it's a real bug, or Google did it intentionally. 
If it's not expected I will add a comment in the 1846606 bug (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1846606">https://bugzilla.mozilla.org/show_bug.cgi?id=1846606</a>)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Nov 20 2024 21:40:01 GMT-0800 (Pacific Standard Time)">05:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, it's possible that printing "0" is better in the actual use cases.   I think we can file a spec bug about the inconsistency between the spec and the impls</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Nov 20 2024 22:04:48 GMT-0800 (Pacific Standard Time)">06:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell"><p>Safari does the same as Google Chrome</p>
<pre><code>&gt; console.log("%d", -0)
[Log] 0
&lt; undefined
&gt; console.log("%d", "-0")
[Log] 0
&lt; undefined

&gt; Number.parseInt("-0")
&lt; -0
&gt; Number.parseInt(-0)
&lt; 0
</code></pre>
</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Nov 20 2024 22:04:49 GMT-0800 (Pacific Standard Time)">06:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mayankleoboy1:mozilla.org">mayankleoboy1</span>&gt;</div></td><td class="msg-cell">TagisRangeTag is something i hadnt seen before in profiles.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Nov 20 2024 22:09:35 GMT-0800 (Pacific Standard Time)">06:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, then it's likely that we'll want to modify the spec to special case the <code>-0</code> in the %d/%i branch</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Nov 20 2024 22:09:45 GMT-0800 (Pacific Standard Time)">06:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">good find :)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Nov 20 2024 22:42:35 GMT-0800 (Pacific Standard Time)">06:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gaporf:mozilla.org">gaporf</span>&gt;</div></td><td class="msg-cell">I posted my notes in the corresponding bug for future reference.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Nov 21 2024 02:43:42 GMT-0800 (Pacific Standard Time)">10:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">mayankleoboy1</span>: that should get inlined, it's just a comparison</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Nov 21 2024 03:20:19 GMT-0800 (Pacific Standard Time)">11:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mayankleoboy1:mozilla.org">mayankleoboy1</span>&gt;</div></td><td class="msg-cell">Some profiles i captured today had that function in a gc-marking heavy part of the profile. 
Bug 1925065 comment 6 if you are curious. </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Nov 21 2024 03:22:10 GMT-0800 (Pacific Standard Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1925065">https://bugzil.la/1925065</a> — NEW (nobody) — Nightly is 2.4x slower than Chrome on an online demo (<a href="https://www.compresh.dev/">https://www.compresh.dev/</a>) and uses more memory</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Nov 21 2024 10:12:46 GMT-0800 (Pacific Standard Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Is there a way with <code>mach try perf</code> to push a desired local-git commit as a base comparison?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Nov 21 2024 10:16:00 GMT-0800 (Pacific Standard Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Sooo there's a complicated --comparator thing. Or you could do what I do which is push once with --single-run then push again with --single-run, and just put the revisions into perfcompare yourself</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Nov 21 2024 10:16:37 GMT-0800 (Pacific Standard Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(It's been a while since I've done this, but IIRC --single-run is kind of badly named; really it should be --no-baseline-push) </td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Nov 21 2024 10:17:28 GMT-0800 (Pacific Standard Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@julienw:mozilla.org">julienw</span>&gt;</div></td><td class="msg-cell">it might be good to file a bug about this need, if it's a common need :) <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Testing&amp;component=Performance">https://bugzilla.mozilla.org/enter_bug.cgi?product=Testing&amp;component=Performance</a></td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Nov 21 2024 10:32:25 GMT-0800 (Pacific Standard Time)">18:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">What should I read to understand why <a href="https://searchfox.org/mozilla-central/source/js/public/StableStringChars.h#42">https://searchfox.org/mozilla-central/source/js/public/StableStringChars.h#42</a> exists and when it needs to be used instead of <a href="https://searchfox.org/mozilla-central/source/js/src/vm/StringType.h#1142">https://searchfox.org/mozilla-central/source/js/src/vm/StringType.h#1142</a> ?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Nov 21 2024 10:33:44 GMT-0800 (Pacific Standard Time)">18:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">Given a string, I'd like to ensure that it is two-byte linear and then create a bunch of dependent strings ensuring that it cannot get GCed during my operation.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Nov 21 2024 10:35:36 GMT-0800 (Pacific Standard Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if there's any chance of GC call while the raw chars are used,  you need <code>AutoStableStringChars</code></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Nov 21 2024 10:36:15 GMT-0800 (Pacific Standard Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if there's no GC call, then you can use <code>twoByteChars</code>, with <a href="https://searchfox.org/mozilla-central/rev/75de397838825ba741820fec27225342ba15fd5b/js/public/GCAPI.h#1036">JS::AutoRequireNoGC</a></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Nov 21 2024 10:37:30 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">How do I know if there's a chance of GC that AutoRequireNoGC won't prevent?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Nov 21 2024 10:37:41 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">hsivonen</span>: <code>twoByteChars</code> returns a pointer to the characters of the string. If a GC occurs, the string might move, so that pointer is invalid. Allocating a dependent string can trigger GC, so you can't keep a pointer to <code>twoByteChars</code> alive across the call.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Nov 21 2024 10:38:11 GMT-0800 (Pacific Standard Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>AutoRequireNoGC</code> doesn't prevent.  it just asserts no GC</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Nov 21 2024 10:38:48 GMT-0800 (Pacific Standard Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, </td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Nov 21 2024 10:39:07 GMT-0800 (Pacific Standard Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">How can anything use RopeBuilder if creating dependents of the long string being examined won't work?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Nov 21 2024 10:39:49 GMT-0800 (Pacific Standard Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the list of functions that can GC is calculated by the hazard analysis job (H or SM(H))</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Nov 21 2024 10:41:07 GMT-0800 (Pacific Standard Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Note that GC only prevents you from holding on to a direct pointer to the string's characters. You can keep the string itself alive by rooting it.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Nov 21 2024 10:42:08 GMT-0800 (Pacific Standard Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">If AutoStableStringChars copies, is it worthwhile to create a rope of dependent strings of the original as opposed to writing yet another buffer?</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Nov 21 2024 10:42:42 GMT-0800 (Pacific Standard Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think you can probably accomplish your goals without needing AutoStableStringChars</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Nov 21 2024 10:43:07 GMT-0800 (Pacific Standard Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">AutoStableStringChars won't copy long strings. They'll be allocated with malloc, and even if the JSString header moves, the actual string data won't move.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Nov 21 2024 10:44:45 GMT-0800 (Pacific Standard Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">I'm thinking of making ICU4X normalizer create a rope of unchanged substrings (dependent) and inline strings for the changed characters.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Nov 21 2024 10:45:20 GMT-0800 (Pacific Standard Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">NewDependentString takes indices into the string. If you root the original string and loop creating dependent strings, then everything will work out. You can even use <code>twoByteChars</code> in each iteration of the loop to read the contents of the string, as long as the lifetime of the return value of <code>twoByteChars</code> does not extend past the call to NewDependentString.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Nov 21 2024 10:45:22 GMT-0800 (Pacific Standard Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">So it will need access to a stable UTF-16 input buffer while creating the dependent strings</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Nov 21 2024 10:46:20 GMT-0800 (Pacific Standard Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">I need to hold the pointer to a contiguous char16_t input while creating the dependents</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Nov 21 2024 10:47:12 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">Since a sink listening to normalizer output would create dependent strings while the normalizer holds the input</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Nov 21 2024 10:49:45 GMT-0800 (Pacific Standard Time)">18:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p>I was thinking something like this should work:</p>
<pre><code>Rooted&lt;String&gt; source = ...
while (...) {
  size_t start, length;
  {
    AutoRequireNoGC noGC;
    char16_t* chars = source-&gt;twoByteChars(noGC);
    start = ...
    length = ...
  }
  ... = NewDependentString(source, start, length);
}
  
</code></pre>
</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Nov 21 2024 10:50:37 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But I take it there's some sort of external normalizer that needs to hold <code>char16_t*</code> alive incrementally?</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Nov 21 2024 10:51:00 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You could also run the normalizer to create a list of start/length pairs, and then create all the dependent strings after that.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Nov 21 2024 10:51:15 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I was thinking something like this should work:</p>
<pre><code>Rooted&lt;String&gt; source = ...
while (...) {
  size_t start, length;
  {
    AutoRequireNoGC noGC;
    char16_t* chars = source-&gt;twoByteChars(noGC);
    start = ...
    length = ...
  }
  ... = NewDependentString(source, start, length);
}
  
</code></pre>
</blockquote></mx-reply>This won't work in my case, since Rust code own the loop over a contiguous UTF-16 slice representing the entire input, and that slice needs to stay alive for the duration of the whole normalizer invocation</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Nov 21 2024 10:51:51 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">If I understand correctly, then I think using AutoStableStringChars and then creating all the dependent strings while holding that should just work. You can use NewDependentString for the changed characters, too, since it will detect that it's a short string and give you back an inline string instead.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Nov 21 2024 10:52:42 GMT-0800 (Pacific Standard Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> If I understand correctly, then I think using AutoStableStringChars and then creating all the dependent strings while holding that should just work. You can use NewDependentString for the changed characters, too, since it will detect that it's a short string and give you back an inline string instead.</blockquote></mx-reply>So it seems. Does creating dependent strings in a rope as opposed to writing to a new linear buffer seem like an optimization, then?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Nov 21 2024 10:53:48 GMT-0800 (Pacific Standard Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">How long are the expected input strings? What fraction of the string do we expect to remain unchanged?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Nov 21 2024 10:54:53 GMT-0800 (Pacific Standard Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> How long are the expected input strings? What fraction of the string do we expect to remain unchanged?</blockquote></mx-reply>For the first question, I don't know what's common on the Web. For the second, NFC to NFKC seems popular, so mostly unchanged.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Nov 21 2024 10:55:56 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">In the worst case, like Vietnamese from NFC to NFD or vice versa, there are a lot of changes every two or three characters.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Nov 21 2024 10:56:58 GMT-0800 (Pacific Standard Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Roughly speaking, I think every piece of the rope will add 3 words of overhead.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Nov 21 2024 10:58:15 GMT-0800 (Pacific Standard Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So you'd want to write to a new linear buffer if there's more than one change per ... 24 bytes? Which is 12 characters?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Nov 21 2024 10:59:03 GMT-0800 (Pacific Standard Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Linear strings are generally nicer to work with, so I would fudge the heuristics in that direction a little.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Nov 21 2024 11:00:21 GMT-0800 (Pacific Standard Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">It seems that a rope is a pessimization for Vietnamese. Ropes seem excellent for Japanese and perhaps French. Unclear where German ends up.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Nov 21 2024 11:02:23 GMT-0800 (Pacific Standard Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I guess another question is how often we will end up linearizing the rope eventually anyways. </td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Nov 21 2024 11:02:35 GMT-0800 (Pacific Standard Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">a rope built from lots of short inline strings wouldn't be great. Space overhead for the unused part of the inline strings, plus the rope overhead, plus everything is scattered in memory.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Nov 21 2024 11:03:40 GMT-0800 (Pacific Standard Time)">19:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">With a linear buffer, there's the issue of reallocating and copying when guessing the size wrong.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Nov 21 2024 11:05:18 GMT-0800 (Pacific Standard Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">If assuming that the initial guess is wrong anyway, the simplest thing would be to write to a Rust Vec, let it handle the growth, and then have SpiderMonkey do yet another copy from there.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Nov 21 2024 11:06:29 GMT-0800 (Pacific Standard Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">A fancier thing would be a Vec-like thing whose backing buffer is eligible to be adopted as the heap-allocated buffer of a JSString.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Nov 21 2024 11:06:55 GMT-0800 (Pacific Standard Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">Does that already exist?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Nov 21 2024 11:08:01 GMT-0800 (Pacific Standard Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You might be able to use the infrastructure Jan added <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1892253">in this bug</a></td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Nov 21 2024 11:08:50 GMT-0800 (Pacific Standard Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">string data needs to go into a specific jemalloc arena. I don't know if that'll be problematic. Jan's StringBuffer seems like a good idea to me.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Nov 21 2024 11:09:27 GMT-0800 (Pacific Standard Time)">19:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm, actually, I'm not sure if the arena restriction applies to external strings</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Nov 21 2024 11:09:32 GMT-0800 (Pacific Standard Time)">19:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">Is there a good example already in SpiderMonkey using the new infra?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Nov 21 2024 11:10:30 GMT-0800 (Pacific Standard Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">I take it that I won't be able to use the nsstring crate from under js/</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Nov 21 2024 11:12:14 GMT-0800 (Pacific Standard Time)">19:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I see <a href="https://searchfox.org/mozilla-central/source/js/xpconnect/src/XPCString.cpp#56-76">https://searchfox.org/mozilla-central/source/js/xpconnect/src/XPCString.cpp#56-76</a> that <a href="https://searchfox.org/mozilla-central/source/js/xpconnect/src/xpcpublic.h#255">calls NewStringFromKnownLiveTwoByteBuffer</a></td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Nov 21 2024 11:14:33 GMT-0800 (Pacific Standard Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">The issue then is how to manage an mozilla::StringBuffer from Rust under js/, since nsstring assumes an actual nsString around the mozilla::StringBuffer.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Nov 21 2024 11:19:13 GMT-0800 (Pacific Standard Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I take it that I won't be able to use the nsstring crate from under js/</blockquote></mx-reply>I don't know the story of using Rust from js/, but isn't that what's happening in eg <a href="https://searchfox.org/mozilla-central/source/js/src/vm/StringType.cpp#186-187">encodeUTF8Partial</a> that ends up calling <a href="https://searchfox.org/mozilla-central/source/mfbt/Latin1.h#226">encoding_mem_convert_latin1_to_utf8_partial</a>?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Nov 21 2024 11:19:52 GMT-0800 (Pacific Standard Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, I guess it must be more a problem that the nsstring crate needs Gecko.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Nov 21 2024 11:21:19 GMT-0800 (Pacific Standard Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">Yes, the UTF-8 conversion uses Rust. So far it seems it will probably be easier not have materialize a mozilla::StringBuffer from Rust under js/</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Nov 21 2024 11:26:19 GMT-0800 (Pacific Standard Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">Probably easier to make a Vec-like thing whose backing buffer comes from JS_string_malloc</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Nov 21 2024 11:26:57 GMT-0800 (Pacific Standard Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/util/StringBuilder.h#115">js::JSStringBuilder</a> uses <code>mozilla::Vector</code> for the appending, then copies in <a href="https://searchfox.org/mozilla-central/source/js/src/util/StringBuilder.cpp#114">finishStringInternal</a></td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Nov 21 2024 11:27:50 GMT-0800 (Pacific Standard Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, and it creates a StringBuffer now.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Nov 21 2024 11:29:48 GMT-0800 (Pacific Standard Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">I think I should use that and make a single FFI function that appends to it from Rust</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Nov 21 2024 11:33:56 GMT-0800 (Pacific Standard Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">Thanks!</td></tr>

</tbody></table></div></div></div>
</body></html>