<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-01-08</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-01-08<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-01-06" class="nav-link"><span>prev</span></a>
<a href="2024-01-10" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jan 08 2024 08:08:51 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@mgaudet:mozilla.org">mgaudet|sick-but-also-pto-until-january-8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Hello everyone and merry christmas! Ben Visness pointed me here for more indepth js engine questions. I'm working on a thing that has to run in the browser and do so really quickly. I'm comfortable with native profiling tools, and was wondering what are my options for doing "serious profiling" for code running in the browser, beyond what firefox profiler (which is really good!) gives me. For example, I would like to know if my routine is memory or compute bound. Do such things exist? Maybe there are some flags or experimental features I can enable? Or would it be more straightforward to just use native tools and compile to WASM? Thanks a lot!</blockquote></mx-reply>Depends a bit on your workload -- if you can get it to run in the shell, then you can use tools like perf; then to determine the compute / mem bound you'd want to look at questions like "is the IPC of your workload as high as it could be". For regular code in the browser... I'm less sure about the good story here</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jan 08 2024 08:54:23 GMT-0800 (Pacific Standard Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">Say, general question, just for background:</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jan 08 2024 08:55:12 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">Why does SpiderMonkey try so hard to report out-of-memory conditions? Why doesn't it just crash?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jan 08 2024 08:55:26 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">The rest of Firefox just crashes on OOM, right?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jan 08 2024 08:56:27 GMT-0800 (Pacific Standard Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Yes, the rest of Firefox crashes on OOM by default. You can use fallible allocation but you have to opt into it.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jan 08 2024 08:57:24 GMT-0800 (Pacific Standard Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">Right. The "Why" question is what I'm interested in.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jan 08 2024 08:57:35 GMT-0800 (Pacific Standard Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">Because, SpiderMonkey definitely works hard on it.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jan 08 2024 09:00:04 GMT-0800 (Pacific Standard Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">jimb</span>: A very good question. I've been arguing for years that we should just give up on OOM handling.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jan 08 2024 09:00:51 GMT-0800 (Pacific Standard Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">At one point it was a thing that distinguished us from V8. IIUC, mongodb switched from v8 to sm for their embedded JS engine because they wanted OOM handling.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jan 08 2024 09:02:05 GMT-0800 (Pacific Standard Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In some contexts, like Ion compilation, there's an argument that it is wrong and bad for a webpage to crash just because we tried to make it go faster.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jan 08 2024 09:04:45 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Based on telemetry, it does seem to avoid some crashes in the wild (as measured by the number of crash reports where we OOM, but recover well enough to run a full GC.)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jan 08 2024 09:05:07 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">jimb</span>: To make sure the blame goes to the rest of Firefox, for not taking care of properly handling Out Of Memory conditions ;)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jan 08 2024 09:07:24 GMT-0800 (Pacific Standard Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">My take is that every optimization should not cause a failure. IonMonkey is an optimization, and failing to optimize the code should not cause the failure to execute the code.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jan 08 2024 09:12:49 GMT-0800 (Pacific Standard Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: This is not completely true, the rest of Firefox crashes on small OOMs, but should still handle failures of large allocations.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jan 08 2024 09:13:41 GMT-0800 (Pacific Standard Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Isn't that what mccr8 said? "You can use fallible allocation but you have to opt into it."</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jan 08 2024 09:14:47 GMT-0800 (Pacific Standard Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't think we would add OOM handling to the engine today if it didn't already exist, but given that it does, the argument for keeping it is that the cost of adding OOM handling in new code is smaller than the value of avoiding crashes.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jan 08 2024 09:15:57 GMT-0800 (Pacific Standard Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">In the case of JS, a small and large allocation mostly depend on the user input: <code>new Array(1)</code> and <code>new Array(200000000)</code></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jan 08 2024 09:18:26 GMT-0800 (Pacific Standard Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">To the best of my knowledge, no other JS engine handles OOM like we do.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jan 08 2024 09:18:42 GMT-0800 (Pacific Standard Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I agree, if the code base did not had OOM handling, we would not be adding it.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jan 08 2024 09:19:54 GMT-0800 (Pacific Standard Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Stack overflow have to be handled for Web compatibility reasons. I do not know if there is some similar corner case for OOMs.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jan 08 2024 09:54:05 GMT-0800 (Pacific Standard Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">These are exactly the sorts of considerations and choices I wanted to hear about. Thanks very much!</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jan 08 2024 10:03:45 GMT-0800 (Pacific Standard Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">But there was a point in the past where we implemented the OOM sweep tests, that try to fail each allocation in turn and make sure they're all covered. That must have been a lot of work to stand that up initially. Do you remember why it was undertaken?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jan 08 2024 10:04:15 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">Was it just someone getting a bee in their bonnet and nobody stopped them? Or was the investment discussed more as a team?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jan 08 2024 10:04:26 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">IIRC there was a pwn2own exploit that hit an OOM code path.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jan 08 2024 10:04:50 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">I had a vague recollection that it had something to do with security, yeah.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jan 08 2024 10:07:22 GMT-0800 (Pacific Standard Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">I guess since it's essential to handle OOMs on allocation whose size is controlled by content, you can't have a blanket policy of crashing on OOM.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jan 08 2024 10:07:40 GMT-0800 (Pacific Standard Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@jimb:mozilla.org">jimb</span>&gt;</div></td><td class="msg-cell">And if you can't eliminate the OOM paths altogether, the exploits show that you'd better be testing them.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jan 08 2024 10:09:25 GMT-0800 (Pacific Standard Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">jimb</span>: Yes, this was at the London work week, Jon added the OOMTest function, first based on the OOMAtAllocation, to make it more stable across engine changes.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Jan 08 2024 10:10:12 GMT-0800 (Pacific Standard Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I do not recall this being that painful overall.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Jan 08 2024 10:12:44 GMT-0800 (Pacific Standard Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">The problem with OOMAtAllocation is that it would be hard to reduce by fuzzers, also you would keep test cases which are no longer failing the way the test case was designed for.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Jan 08 2024 10:13:24 GMT-0800 (Pacific Standard Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">So OOMTest is kind of a way to embrace our OOM reporting by making "proper" tools to check for them.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Jan 08 2024 10:14:28 GMT-0800 (Pacific Standard Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">We all did your part in making OOMTest happen.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Jan 08 2024 10:18:04 GMT-0800 (Pacific Standard Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I would say that this is an area we're certainly curious about; whether or not our OOM handling actually is worth the development effort to maintain it. I don't think we have a firm grasp on the tradeoffs here. (e.g, I hypothesize that it would make some JSAPI functions infallible, but I also think I could be proven wrong). </td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Jan 08 2024 10:20:37 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I know in the interaction layer between DOM and JSAPI I have OOM concerns; the existence of OOM exceptions means some web-standards have the possibility of getting into an inconstent state, where an operation is specified as infallible, but is fallible in practice -- though, this is not exclusively the domain of OOM; stack overflow is another potential issue here. </td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Jan 08 2024 10:22:16 GMT-0800 (Pacific Standard Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Having said that, crash on OOM is a big hammer, and each crash on OOM is a real user impacted -- I think there's an organizational push towards reliability happening, which makes that big hammer less appealing, unless we can show that our OOM handling is truly not that helpful (e.g., a very high fraction of 'recovered' ooms crash when re-entering gecko land anynow) </td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Jan 08 2024 10:23:21 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">jimb</span>: One big reason for having OOM checks is that we had tabs, but only a single process.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Jan 08 2024 10:28:18 GMT-0800 (Pacific Standard Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">One thing I'll add is that security-wise it is better to crash than try to recover, because recovering leaves you in a potentially unexpected, untested state where it's much easier for bugs to lurk. Note that oomTest as it is currently implemented still only gives us patchy coverage: it calls a function N times failing on the Nth allocation, but it doesn't reset the VM / warmup counters in between, so allocations that only happen occasionally (eg during a compilation / bailout) don't get full coverage. Rerunning a test from a clean slate for every single allocation would be prohibitively slow. We rely on fuzzing instead.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Jan 08 2024 10:33:07 GMT-0800 (Pacific Standard Time)">18:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Digging into bugzilla, here are some of the milestones of testing OOM: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=642327">a shell option</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=872823">a testing function</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1155618">oomTest as a library</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1212469">oomTest as a testing function</a>. Notably, even the first of those is talking about preventing regressions in OOM handling, so the decision not to crash on OOM was made at least 13 years ago.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Jan 08 2024 10:36:14 GMT-0800 (Pacific Standard Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: This most likely predate that.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Jan 08 2024 10:37:14 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Here's a 17-year-old bug: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=383932">https://bugzilla.mozilla.org/show_bug.cgi?id=383932</a></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon Jan 08 2024 10:54:12 GMT-0800 (Pacific Standard Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, here's another way of illustrating how long ago we made this decision: JS_ReportOutOfMemory goes all the way back to <a href="https://searchfox.org/mozilla-central/rev/3b56a9af51519d2e77e05efa672a13e6be2e9ebc/js/src/jsapi.c#1785-1789">Free the lizard</a>.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon Jan 08 2024 12:15:41 GMT-0800 (Pacific Standard Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: during fuzzing, I set the <code>--disable-oom-functions</code> flag. from what I understand it could be interesting to remove this flag and search for edge-cases in OOM handling?</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon Jan 08 2024 12:20:37 GMT-0800 (Pacific Standard Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">l11d</span>: Somewhat interesting, yes.</td></tr>

</tbody></table></div></div></div>
</body></html>