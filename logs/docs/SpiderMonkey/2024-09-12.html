<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-09-12</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-09-12<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-09-11" class="nav-link"><span>prev</span></a>
<a href="2024-09-13" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Sep 12 2024 08:39:08 GMT-0700 (Pacific Daylight Time)">15:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: Thanks for prompting me (though I suspect you didn't realize you did it) to finally install <a href="https://atuin.sh/">https://atuin.sh/</a> -- while I still trip over things every once and a while, it's been a clear upgrade</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Sep 12 2024 09:00:31 GMT-0700 (Pacific Daylight Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the improved Ctrl+R UI looks great</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Sep 12 2024 09:12:09 GMT-0700 (Pacific Daylight Time)">16:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah, it's quite nice. And you can filter by host (if you have sync), workspace and session just by hitting ctrl-r again</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Sep 12 2024 09:45:04 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">[misc discussion] The <code>js::CollatorObject</code> type feels off to me since while we use in our standard library, its JSAPI needs should be satisfied by normal embedder APIs. My issue is that we use the concrete <code>js::NativeObject</code> as a base class which is not available to embedders. Do we need improvements to the ergnomics of JSAPI so that things like CollatorObject are implemented similar to how an embedder would?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Sep 12 2024 09:45:56 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(we have wayyyy too many ways to define new object types)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Sep 12 2024 10:42:52 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: So just rewrite it to use JS_NewObject with a JSClass? (Since proto class is already plain object?)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Sep 12 2024 10:43:03 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I don't disagree, curious why this stands out to you tho</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Sep 12 2024 10:44:54 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">We use the CollectorObject as a namespace for the various tables to call JS_NewObject as well as helpers and stuff</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Sep 12 2024 10:45:31 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">if we still have such a class as a namespace, what does it make sense to call it? (factory, etc?)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Sep 12 2024 10:46:21 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">what stands out is extraneous use of internal-to-spidermonkey-apis for things like builtins which <em>generally</em> can be outside the firewall</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Sep 12 2024 10:47:24 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(I've been doing a deep dive on our various gecko object definitions and I don't like how many different flags and tricks we use in adhoc ways...)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Sep 12 2024 10:59:29 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah, I'm not sure we have a good answer. Collator object largely looks... normalish to me, but I take your point that it could certainly be done using pretty much straight up the public API </td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Sep 12 2024 12:07:08 GMT-0700 (Pacific Daylight Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">PS: Now that <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1917020">https://bugzilla.mozilla.org/show_bug.cgi?id=1917020</a> has landed, anything using straight JS_LOG should work on releases :D Exciting times </td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Sep 12 2024 14:11:41 GMT-0700 (Pacific Daylight Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">OK: Here's a stupid question that I promise, if we can come to a good answer, I will write up as a doc and check in (unless there is something better): What are the lifetimes of various engine objects, and how do they relate to the lifecycle of the browser?

e.g. On browser startup we start with a fresh runtime, context, zone, realm, global... but as I navigate through sites, some of these will get reset, but presumably not everything? (ie. is a runtime alive for the duration of a tab? Process? ) </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Sep 12 2024 14:12:29 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Once upon a time, I seem to recall having it impressed upon me that a "zone" was roughly a tab... but I have no idea if that's still the case? </td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Sep 12 2024 14:27:04 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I don't have a good unified answer. I do remember zones changed somehow when we ended up with multiple realms in a compartment. Also with Fission, we won't store the global for multiple webpages that aren't same site in the same process, which of course precludes them being in the same anything JS runtimewise.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Sep 12 2024 14:28:37 GMT-0700 (Pacific Daylight Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah... A lot has changed which makes me wonder what the state of play is. Probably the best people to answer are in europe though, so may have to wait till tomorrow :) </td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Sep 12 2024 14:40:45 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I guess I can answer some of it. A runtime is per thread we run JS on. So, the main thread in processes we run JS, plus another one for DOM workers, though the main and worker threads can share some data. A realm is the same thing as a global, I think, and we have one per inner window, plus additional ones for various browser JS things. I think a context is 1:1 with a runtime. In a tab, you have a top level window, and it can contain iframes. These iframes may be in the same process or another process. If they are same origin, they'll be in the same compartment, because no security barrier is needed. If they are "same site" but not same origin, they'll be in the same process, in the same runtime, but in a different compartment. If they are neither, they'll be in another process entirely.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Sep 12 2024 14:45:26 GMT-0700 (Pacific Daylight Time)">21:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Ok. So if you have a same-site iframe, it would use the same JSRuntime as the outer window. Ok. That scans reasonably well to me. What about page navigations; my mental model is that the JSRuntime is long lived and only destroyed at process shutdown... but if I navigate to another origin, do we reuse the same process, or do we tear the current one down and rebuild a new one? </td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Sep 12 2024 14:46:34 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Ok. So if you have a same-site iframe, it would use the same JSRuntime as the outer window. Ok. That scans reasonably well to me. What about page navigations; my mental model is that the JSRuntime is long lived and only destroyed at process shutdown... but if I navigate to another origin, do we reuse the same process, or do we tear the current one down and rebuild a new one? </blockquote></mx-reply>A process can be reused for a different unrelated page, but only one that is same site, for security reasons.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Sep 12 2024 14:46:49 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">We create and destroy a LOT of processes with Fission.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Sep 12 2024 14:46:59 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Heh. I'm getting that impression! </td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Sep 12 2024 14:47:40 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">In Nightly (I think by default?) you can hover over a tab and see how many processes are in the page. For your standard ad-ridden local news site, it can be like a dozen.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Sep 12 2024 14:48:01 GMT-0700 (Pacific Daylight Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So in a real way, a JSRuntime is actually locked to a single site... interesting </td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Sep 12 2024 14:48:40 GMT-0700 (Pacific Daylight Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So in a real way, a JSRuntime is actually locked to a single site... interesting </blockquote></mx-reply>Yes, due to Spectre that's basically a requirement. Plus the browser JS, of course.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Sep 12 2024 14:48:44 GMT-0700 (Pacific Daylight Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">This isn't equally true on Android tho? ISTR full fission isn't there? </td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Sep 12 2024 14:50:13 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Yes Android does not have Fission yet. I'm not sure how exactly it works there, but in the pre-Fission world in desktop, a single JS runtime could contain any number of tabs worth of pages. All of the pages from a single tab would be in the same runtime. (Excluding things like COOP or something where a site could effectively opt-in to a Fission like isolation...)</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Sep 12 2024 14:51:54 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Also for Fission, in the same way we have cross compartment wrappers for references from one compartment to another, we have cross process proxies, for the limited set of objects that can be referred to across sites.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Sep 12 2024 14:52:35 GMT-0700 (Pacific Daylight Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">which gets fun when an iframe navigates from out of process to in process, or vice versa.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Sep 12 2024 14:52:52 GMT-0700 (Pacific Daylight Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Right... I knew they existed. I wasn't always clear on what restrictions existed for cross-site reference. 

Ooof. Yeah that must be knarly</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Sep 12 2024 14:54:06 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Ok. The next pieces I want to figure out is same-origin navigation (tho I'm almost at EOD here, so will disapperar shortly) -- Here my mental model is that we must essentially throw away all the zones related to the loaded page (and dom, document etc), and start with a fresh world. 

Part of my reason for asking is trying to understand the actual scope of JitHints as I think about building something similar for pretenuring (based on a patch denis wrote already :) ) </td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Sep 12 2024 14:55:22 GMT-0700 (Pacific Daylight Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Ok. The next pieces I want to figure out is same-origin navigation (tho I'm almost at EOD here, so will disapperar shortly) -- Here my mental model is that we must essentially throw away all the zones related to the loaded page (and dom, document etc), and start with a fresh world. <br><br>Part of my reason for asking is trying to understand the actual scope of JitHints as I think about building something similar for pretenuring (based on a patch denis wrote already :) ) </blockquote></mx-reply>Zones are kind of an "optimization" and invisible to the web, so we can do whatever we want. But yes, I think (and Jan would have to confirm) that on a same site navigation we get a new zone. Generally you want things in a zone to have a similar lifetime, to minimize fragmentation.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Sep 12 2024 14:55:47 GMT-0700 (Pacific Daylight Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">IIRC zones were introduced because content and chrome had very different lifetimes, but they were being stored all jumbled together and it caused bad fragmentation.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Sep 12 2024 14:57:18 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Ok -- this is all enormously helpful context, and I do intend to try to turn this into something. However, I have to scoot :) EOD </td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Sep 12 2024 14:57:41 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">That, and we can collect a subset of Zones, so we don't need to keep re-tracing live memory that belongs to long-living JS.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Sep 12 2024 14:57:55 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">There's some documents around, eg: <a href="https://searchfox.org/mozilla-central/source/js/public/Zone.h">https://searchfox.org/mozilla-central/source/js/public/Zone.h</a> Dunno if there's non-comment prose though.</td></tr>

</tbody></table></div></div></div>
</body></html>