<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-06-17</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-06-17<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-06-15" class="nav-link"><span>prev</span></a>
<a href="2024-06-18" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jun 17 2024 02:59:38 GMT-0700 (Pacific Daylight Time)">09:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">say i have written some code that causes some crash during emitting bytecode and i have identified the point right before the crash is there any way for me to print out what all bytecode has been emitted till the crash point like is there maybe something like <code>bce_-&gt;dump()</code></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jun 17 2024 03:04:04 GMT-0700 (Pacific Daylight Time)">10:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">unfortunately it doesn't exist yet.  the workaround I know is to look into <code>bce_-&gt;bytecodeSection()-&gt;code()</code> and hand-disassemble the vector</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jun 17 2024 03:05:54 GMT-0700 (Pacific Daylight Time)">10:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">can we print out the vectoror there is some kind of dump() function for that?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jun 17 2024 03:08:47 GMT-0700 (Pacific Daylight Time)">10:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the content itself can be printed by lldb's <code>memory read</code> command</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jun 17 2024 03:11:11 GMT-0700 (Pacific Daylight Time)">10:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">casting the <code>jsbytecode</code> to <code>JSOp</code> will tell which opcode it is</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jun 17 2024 03:11:35 GMT-0700 (Pacific Daylight Time)">10:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">like <code>p (JSOp)bytecodeSection()-&gt;code()[0]</code></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jun 17 2024 03:13:26 GMT-0700 (Pacific Daylight Time)">10:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and you can check the length of the opcode by <code>p CodeSpec((JSOp)bytecodeSection()-&gt;code()[0]).length</code></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jun 17 2024 07:25:27 GMT-0700 (Pacific Daylight Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">question for embedders: are you currently using external JS strings? (<code>JS_NewMaybeExternalString*</code>, <code>JS_NewExternalUCString</code> etc). We're moving away from them in Gecko and I'm considering removing them completely</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jun 17 2024 07:30:16 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">(it will be possible to use refcounted string buffers instead)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jun 17 2024 07:32:20 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it was interesting to see roc mention "You’ll want to share strings across interface boundaries" in <a href="https://robert.ocallahan.org/2024/06/browser-engine.html">https://robert.ocallahan.org/2024/06/browser-engine.html</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jun 17 2024 10:06:21 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: The code surrounding the ExecutableAllocator is really confusing. The executable pool is allocated and managed by the ExecutableAllocator, but leaked to the JitCode to hold on the reference counter of the pool. And apart from that, all the critical logic is in ProcessExecutableAllocator.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jun 17 2024 10:18:12 GMT-0700 (Pacific Daylight Time)">17:18</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-2" title="@nbp:mozilla.org">nbp</span></div></td><td class="msg-cell">has the <em>rewrite everything</em> feeling …</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jun 17 2024 10:42:12 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the <code>ExecutableAllocator</code> code is pretty old. It manages refcounted pools because the underlying allocator (which is also used directly for Wasm code allocations) has page size granularity</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jun 17 2024 10:42:28 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: what are you trying to do?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jun 17 2024 11:25:31 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: adding the data section.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jun 17 2024 12:58:29 GMT-0700 (Pacific Daylight Time)">19:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Am I misremembering, or do strings not get CCWs? </td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jun 17 2024 13:03:50 GMT-0700 (Pacific Daylight Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">Dumb question: is IonFrame aka JitActivation? or do we not have an equivalent of BaselineFrame?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jun 17 2024 13:06:04 GMT-0700 (Pacific Daylight Time)">20:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">hm I've confirmed its not an IonFrame... but im struggling to find what IonFrame <em>is</em></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jun 17 2024 13:09:37 GMT-0700 (Pacific Daylight Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">I ... think i see whats going on. Maybe IonFrame doesn't exist as a class, but it is a highly optimized data structure that isn't accessed in the usual way? Instead we have JitFrameLayout to tell us where stuff is</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jun 17 2024 13:09:47 GMT-0700 (Pacific Daylight Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">yulia | Sick</span>: A JitActivation is a section of the stack running jitcode. We start a JitActivation when we call into the JIT from C++, and we keep adding frames to it until we push an exit frame that calls back into C++. A JitActivation can contain a mix of baseline and Ion code.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jun 17 2024 13:10:33 GMT-0700 (Pacific Daylight Time)">20:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">do we keep adding to it continuously, even after a function instance finishes?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jun 17 2024 13:10:46 GMT-0700 (Pacific Daylight Time)">20:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">and does a function frame (baseline or ion) represent a single function instance?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jun 17 2024 13:15:29 GMT-0700 (Pacific Daylight Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">At any given point we are either executing jitcode or C++. If we're executing jitcode, then there's a current activation, which starts at some point on the call stack (the most recent call from C++ into jitcode) and covers everything called since then. If we're executing C++ code, then we have some number (possibly 0) of activations underneath us on the stack, indicating places where we called from C++ into jit code and back into C++, and we haven't return to the jit code yet. JitActivations are used (among other things) when the GC needs to trace roots on the stack, so that we know where we should be looking.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jun 17 2024 13:15:46 GMT-0700 (Pacific Daylight Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">Ok, a jit activation is unrelated to the function instance (i think, reading the .h file rn. also watching the euros + sick so my read is obviously questionable) -- jit activations are for tracking when the jit is active (seems obvious now that i say it outloud) and for handling the jumps to and from C++ code </td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jun 17 2024 13:15:58 GMT-0700 (Pacific Daylight Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Basically, yeah</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jun 17 2024 13:17:34 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">so i want to add some metadata that i can reference to the beginning and end of a function instance. My thinking was to do that in frames. not for shippable code, just to understand whats going on with individual methods. I'm dumping to a large file at the end. So far I've been doing this with the baseline frames and it is working... well? maybe this is misleading. Is this a dumb idea?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jun 17 2024 13:17:45 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">im adding a time stamp at the start of the function</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jun 17 2024 13:18:15 GMT-0700 (Pacific Daylight Time)">20:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">When we invoke a function with jit code, we will generally push a new stack frame, just like we would if we were calling a function written in C++. But it's not always 1-1; if I call an Ion-compiled function with other functions inlined into it, then there's only one hardware stack frame, but there are multiple functions logically on the stack</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Jun 17 2024 13:18:53 GMT-0700 (Pacific Daylight Time)">20:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">yes, that should be ok for the stats i am collecting, i mark functions that have been inlined and their parent</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Jun 17 2024 13:18:54 GMT-0700 (Pacific Daylight Time)">20:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">What do you mean by "function instance"? Normally I would use that to refer to a JSFunction object</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Jun 17 2024 13:19:47 GMT-0700 (Pacific Daylight Time)">20:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">As in, this is an individual instance of a function, but multiple function instances may be backed by the same JSScript</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Jun 17 2024 13:19:50 GMT-0700 (Pacific Daylight Time)">20:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">what i am doing (what i think im doing) is tracking how long a function runs when it is executed in the interpreter, in baseline interp, in baseline compiler, and in ion (maybe there is an easier way, i looked at perfspew and that looks like it should do what I want but couldn't figure it out)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Jun 17 2024 13:20:06 GMT-0700 (Pacific Daylight Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">using JSScript will result in a lot of book keeping</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Jun 17 2024 13:21:21 GMT-0700 (Pacific Daylight Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Are you using "function instance" to refer to one invocation of a function? As in, you have some function, you call it, it eventually returns, and the time in between is an "instance"?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Jun 17 2024 13:21:49 GMT-0700 (Pacific Daylight Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">lets say for simplicity yes</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Jun 17 2024 13:22:05 GMT-0700 (Pacific Daylight Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Okay, cool, just wanted to make sure we were on the same page</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Jun 17 2024 13:22:09 GMT-0700 (Pacific Daylight Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">ignoring osr and inlining</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Jun 17 2024 13:22:41 GMT-0700 (Pacific Daylight Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's a little unclear to me how this would interact with eg bailouts</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Jun 17 2024 13:23:18 GMT-0700 (Pacific Daylight Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think roughly speaking you want to emit a timestamp on function entry, and another one on function exit</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Jun 17 2024 13:23:20 GMT-0700 (Pacific Daylight Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">good question, i haven't gotten that far yet: once we bail out, we end up using the baselineframe again right?</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon Jun 17 2024 13:23:45 GMT-0700 (Pacific Daylight Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think roughly speaking you want to emit a timestamp on function entry, and another one on function exit</blockquote></mx-reply>yes, but i don't need to store it on function exit, i can just use it and stuff it in my datastructure for dumping later</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon Jun 17 2024 13:23:56 GMT-0700 (Pacific Daylight Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">the question is: where do i store that first timestamp in a trackable way</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon Jun 17 2024 13:24:09 GMT-0700 (Pacific Daylight Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell"><em>why yes, i am trying to be lazy</em></td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Mon Jun 17 2024 13:25:40 GMT-0700 (Pacific Daylight Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Do you want to be tracking the time taken per-tier, or overall for a given function?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Mon Jun 17 2024 13:25:54 GMT-0700 (Pacific Daylight Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">per tier</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Mon Jun 17 2024 13:26:23 GMT-0700 (Pacific Daylight Time)">20:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">the interesting info being how much faster do we get for a collection of bytecode / cacheIR entries</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Mon Jun 17 2024 13:32:57 GMT-0700 (Pacific Daylight Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This reminds me a little bit of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1510755">this prototype that Matt wrote</a></td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Mon Jun 17 2024 13:37:37 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">this looks like a much smarter version of what i am trying to do, and yes this might be nice to land for debugging!</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Mon Jun 17 2024 13:38:36 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">I think it is missing the ion tier though</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Mon Jun 17 2024 13:38:56 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">im only gathering averages and num executions, though i was thinking of getting min and max as well,</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Mon Jun 17 2024 13:39:40 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Matt's prototype only works inside C++ code, so it's not directly applicable, but it's a similar idea</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Mon Jun 17 2024 13:42:27 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">My initial instinct for implementation in your case is that I would just have a single ~global (per-runtime?) log of events (interpreterEnter/interpreterExit/baselineEnter/baselineExit/OSR/Bailout/etc + some sort of key to identify the script) and then post-process it</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Mon Jun 17 2024 13:42:57 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">i think we have that with perfspewer but im not sure how to use it</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Mon Jun 17 2024 13:43:06 GMT-0700 (Pacific Daylight Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">im using the script hash</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Mon Jun 17 2024 13:43:22 GMT-0700 (Pacific Daylight Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">so far i have everything up to ion, and i think i can use the jitframelayout to store the timestamp and retrieve it</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Mon Jun 17 2024 13:44:36 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, I see, you're storing an initial timestamp in the frame and then logging the total time when you return?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Mon Jun 17 2024 13:44:39 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">one issue i've had with logging, even with the script, is that the bookkeeping can be annoying, especially with multiprocess</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Mon Jun 17 2024 13:44:59 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Ah, I see, you're storing an initial timestamp in the frame and then logging the total time when you return?</blockquote></mx-reply>yep, and then i have an external data structure tracking stuff like executions, compile times etc</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Mon Jun 17 2024 13:45:07 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you make the log per-runtime then it should be singlethreaded</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Mon Jun 17 2024 13:45:25 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">ah yeah right, there is the content process env variable i keep forgetting about</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Mon Jun 17 2024 13:46:21 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">lemme try the jitframelayout real quick</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Mon Jun 17 2024 13:46:23 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It might be easier if you logged two events per call, one on entry and one on exit</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Mon Jun 17 2024 13:46:27 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">hackity hack</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Mon Jun 17 2024 13:47:04 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you just store a timestamp, that means you need to move the timestamp information over when you change tiers</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Mon Jun 17 2024 13:47:07 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell"><p>heres an example of what i've got so far from the Richards benchmark:</p>
<pre><code>scripthash, interpreter,baselineinterpreter, baselinecompiler, ion
959704650,42708,0,0,0
1173828872,2791,0,0,0
1930406448,1709,0,0,0
201637842,4667,0,0,0
1828086145,15292,0,0,0
2034711430,84,0,0,0
2719539033,29875,0,7209,0
1121380391,4958,0,0,0
2086576630,26834,0,0,0
1884838244,2334,0,0,0
1883349012,125,0,0,0
3559126721,167,0,0,0
1052740794,2001572542,0,0,0
1441841095,21458,0,0,0
3432037637,625,0,125,0
2347834532,583,0,84,0
57604327,1417,0,167,0
1316660446,41,0,0,0

</code></pre>
</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Mon Jun 17 2024 13:47:33 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">the numbers are in nanoseconds</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Mon Jun 17 2024 13:48:35 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> If you just store a timestamp, that means you need to move the timestamp information over when you change tiers</blockquote></mx-reply>This i think would mostly be an issue with OSR, but if i move the time stamp i won't get the info i am looking for, which is tier information per bytecode (or, trying to infer this), not actual function execution time</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Mon Jun 17 2024 13:49:21 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right, I guess you don't need to move it, but you do need to find it / populate a new timestamp for the new tier</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Mon Jun 17 2024 13:49:26 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Mon Jun 17 2024 13:50:05 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Eg if you store a timestamp in an ion frame, then when we bail out you need to recover that timestamp, compare it to the current time, log an entry, make a new timestamp, and put it in the right place in the bailed out frame</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Mon Jun 17 2024 13:50:33 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">I think im missing the correct exit for baseline interpreter also, it seems like we never hit the function epilogue (only my exit on osr code is triggering) for some reason, but it may also be the benchmark</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Mon Jun 17 2024 13:50:49 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We tier up from blinterp to baseline</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Mon Jun 17 2024 13:51:23 GMT-0700 (Pacific Daylight Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">yes, thats expected, but im surprised i never hit the function epilogue, its always on osr, does that sound right? </td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Mon Jun 17 2024 13:51:46 GMT-0700 (Pacific Daylight Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">i end up with really long execution times which are surprising, so i've turned that off for now</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Mon Jun 17 2024 13:52:35 GMT-0700 (Pacific Daylight Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">Would it be safe to just ignore this case and rely on warming up again? I don't need every execution, just an average and possibly trends over time</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Mon Jun 17 2024 13:52:53 GMT-0700 (Pacific Daylight Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">or, in the case of the bailout would we always go through the bailout path for that type? (jit code first, then bailing out) in that case im probably in trouble</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Mon Jun 17 2024 13:53:10 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell"><em>showing my JIT ignorance here</em></td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Mon Jun 17 2024 13:58:32 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">looks like the game is over... ill see if i can keep at it tomorrow.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Mon Jun 17 2024 14:04:27 GMT-0700 (Pacific Daylight Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I guess one advantage of storing a timestamp on entry is that if you transition tiers then you can also just drop the timestamp on the floor and ignore that data point, since it's going to be an outlier anyway. Maybe you could also initialize the timestamp slot of the new tier with some sentinel value to say "don't bother logging this on exit"</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Mon Jun 17 2024 14:05:55 GMT-0700 (Pacific Daylight Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Bailouts shouldn't be common in the grand scheme of things; after you bail out ten times we invalidate with the goal of recompiling a new version later that doesn't have to bail out on that input. We have a whole set of assertions designed to prevent endless bailout loops.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Mon Jun 17 2024 14:07:10 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">ok, great -- this was my thinking as well: we can ignore the exceptional cases for now</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Mon Jun 17 2024 14:07:26 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">if they are infrequent enough it probably isn't worth handling them anyway</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Mon Jun 17 2024 14:08:07 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">How does one turn on perfSpewer</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Mon Jun 17 2024 14:08:21 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">its driving me crazy, i can't find documentation anywhere but i might be searching for the wrong thing</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Mon Jun 17 2024 14:11:02 GMT-0700 (Pacific Daylight Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">oh thats obvious: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/PerfSpewer.cpp#254-286">https://searchfox.org/mozilla-central/source/js/src/jit/PerfSpewer.cpp#254-286</a></td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Mon Jun 17 2024 14:12:49 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell"><em>squints at dump file that is the output</em> I should really just come back to this tomorrow</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Mon Jun 17 2024 14:12:51 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Note that perfspewer is spewing once per compilation, not per invocation.</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Mon Jun 17 2024 14:12:51 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@yulia:mozilla.org">yulia | Sick</span>&gt;</div></td><td class="msg-cell">night all!</td></tr>

</tbody></table></div></div></div>
</body></html>