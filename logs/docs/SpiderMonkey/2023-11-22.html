<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-11-22</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-11-22<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-11-21" class="nav-link"><span>prev</span></a>
<a href="2023-11-23" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Nov 21 2023 16:09:38 GMT-0800 (Pacific Standard Time)">00:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sure, I'll look into it today</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Nov 21 2023 16:30:38 GMT-0800 (Pacific Standard Time)">00:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: In the stupid questions meeting last week, I asked about tagged pointers, and you pointed me to InternalBarrierMethods. Looking into it, I think my question was badly worded. What I'm trying to do is something more like CalleeToken than TaggedProto. TaggedProto is either a small tag <em>or</em> a pointer. I want a pointer with a low-bit tag that the GC just ignores. CalleeToken seems to be doing it with a void* and <a href="https://searchfox.org/mozilla-central/source/js/src/jit/BaselineFrame.cpp#31">bespoke handling</a>. Is there a more idiomatic way of doing that?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Nov 21 2023 16:34:25 GMT-0800 (Pacific Standard Time)">00:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For context, I want to use these tagged pointers in the <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Iteration.h#233-244">trailing array of properties attached to a NativeIterator</a>, setting the low bit to indicate that the property was deleted from the object being iterated mid-iteration. If it helps, I think this change will make it so that we no longer need to move properties around inside the array (which we previously did in <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Iteration.cpp#1805-1807">SuppressDeletedProperty</a>), so maybe the barriers are easier.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Nov 22 2023 00:20:47 GMT-0800 (Pacific Standard Time)">08:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">now reading the spec around waitAsync again, and looks like I overlooked that the timeout uses a task instead of a microtask (we should clarify which "task" word in the code means a microtask in the HTML spec, or a task in the HTML spec, or a generic task as a unit).  so, it needs to be handled separately than the existing promise reaction order</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Nov 22 2023 00:23:25 GMT-0800 (Pacific Standard Time)">08:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">anyway, the decision around when to perform the "timeout's critical section" or the "promise reaction for timeout" cannot be done from JavaScript engine's side, but it needs to be handled by Gecko</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Nov 22 2023 00:24:00 GMT-0800 (Pacific Standard Time)">08:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'll summarize it shortly</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Nov 22 2023 00:29:35 GMT-0800 (Pacific Standard Time)">08:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: There's not a standard way to do this at the moment, although maybe we could add infrastructure for this. Currently at least jsid, GCCellPtr, CalleeToken and TaggedProto have a (possibly optional) pointer with some kind tag in the low bits.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Nov 22 2023 00:35:14 GMT-0800 (Pacific Standard Time)">08:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">oh and wasm::AnyRef</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Nov 22 2023 00:43:48 GMT-0800 (Pacific Standard Time)">08:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">One factor is that when you trace a tagged pointer the GC needs to know the kind of GC thing it contains, and this typically comes from the tag. It can work this out in other ways but it's most efficient to get it from the tag. To do this requires handling specific to the tagged pointer type. Currently this happens by TraceTaggedPtrEdge calling a MapGCThingTyped overlaod provided by the tagged pointer.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Nov 22 2023 00:44:08 GMT-0800 (Pacific Standard Time)">08:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Arguably the small efficiency gain is not worth the extra complexity though (except for Value which uses this mechanism too)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Nov 22 2023 00:54:58 GMT-0800 (Pacific Standard Time)">08:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I've filed bug 1866002 to investigate adding infrastructure for this</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Nov 22 2023 00:54:59 GMT-0800 (Pacific Standard Time)">08:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1866002">https://bugzil.la/1866002</a> — NEW (nobody) — Investigate adding common infrastructure for handling tagged pointers</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Nov 22 2023 02:10:13 GMT-0800 (Pacific Standard Time)">10:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: posted some comments, but now I think we have yet another option. I'll think about it tomorrow</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Nov 22 2023 02:12:02 GMT-0800 (Pacific Standard Time)">10:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(or maybe tonight)</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Nov 22 2023 04:43:24 GMT-0800 (Pacific Standard Time)">12:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: is this check for <code>MOZ_DOM_STREAMS</code> still needed: <a href="https://searchfox.org/mozilla-central/rev/d7f837add602d270f2b2958b3ab5206dc85965c0/dom/webidl/moz.build#1034">https://searchfox.org/mozilla-central/rev/d7f837add602d270f2b2958b3ab5206dc85965c0/dom/webidl/moz.build#1034</a> ?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Nov 22 2023 06:43:53 GMT-0800 (Pacific Standard Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">mgaudet</span>: is this check for <code>MOZ_DOM_STREAMS</code> still needed: <a href="https://searchfox.org/mozilla-central/rev/d7f837add602d270f2b2958b3ab5206dc85965c0/dom/webidl/moz.build#1034">https://searchfox.org/mozilla-central/rev/d7f837add602d270f2b2958b3ab5206dc85965c0/dom/webidl/moz.build#1034</a> ?</blockquote></mx-reply>No. We only support DOM streams</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Nov 22 2023 06:44:09 GMT-0800 (Pacific Standard Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">ok, I'll remove it</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Nov 22 2023 08:21:32 GMT-0800 (Pacific Standard Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: do you remember what stops wrapper cached objects getting freed while they are in the mNurseryObjects list? This is for the  the JSObjectsTenured callback: <a href="https://searchfox.org/mozilla-central/source/xpcom/base/CycleCollectedJSRuntime.cpp#1565-1578">https://searchfox.org/mozilla-central/source/xpcom/base/CycleCollectedJSRuntime.cpp#1565-1578</a></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Nov 22 2023 08:40:33 GMT-0800 (Pacific Standard Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: Thanks for the comments. I've added a short response at the bottom of the document.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Nov 22 2023 08:55:19 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the revised approach looks good!</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Nov 22 2023 09:03:53 GMT-0800 (Pacific Standard Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">wow. Bug 1842701 happened totally under my radar, but is super cool. Thanks arai!</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Nov 22 2023 09:03:54 GMT-0800 (Pacific Standard Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1842701">https://bugzil.la/1842701</a> — RESOLVED (arai) — Fallback to no-extra-bindings-mode in Debugger.Object.prototype.executeInGlobalWithBindings if possible</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Nov 22 2023 09:04:50 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: getting freed? wrapper has strong reference to the native object</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Nov 22 2023 09:05:13 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">and when minorgc runs, the object is moved to the deferred finalize list</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Nov 22 2023 09:05:28 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">which will be cleared at some point (and usually that calls release)</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Nov 22 2023 09:07:25 GMT-0800 (Pacific Standard Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Or rather, when finalize on the js object runs, that triggers putting the native object to the deferred finalize list</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Nov 22 2023 09:23:26 GMT-0800 (Pacific Standard Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: thanks, so it's XPCWrappedNative init/finalization that manages this</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Nov 22 2023 09:47:10 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">In case there is WN and it has nursery allocated wrapper. DOM objects don't use WN, but webidl bindings</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Nov 22 2023 12:32:43 GMT-0800 (Pacific Standard Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Is the pointer returned by JS::GetClass guaranteed to be equal to the clasp parameter passed in to JS_NewObject?  (When called for an object created this way)</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Nov 22 2023 12:44:29 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Is the pointer returned by JS::GetClass guaranteed to be equal to the clasp parameter passed in to JS_NewObject?  (When called for an object created this way)</blockquote></mx-reply>If not, is there a simple way to compare two class pointers to make sure they represent the same class.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Nov 22 2023 12:59:25 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You should be able to compare class pointers using normal pointer equality</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Nov 22 2023 13:00:11 GMT-0800 (Pacific Standard Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But also the class pointer is immutable (with IIRC some weird exceptions involving brain transplants, but I don't think those are relevant here)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Nov 22 2023 13:08:59 GMT-0800 (Pacific Standard Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Also, what is the purpose of the function "slot0IsISupports" ?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Nov 22 2023 13:12:43 GMT-0800 (Pacific Standard Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's part of the DOM integration with the browser. If you're not Gecko, you can safely ignore it.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Nov 22 2023 13:14:15 GMT-0800 (Pacific Standard Time)">21:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">The basic idea is that Firefox needs to stash non-SpiderMonkey C++ pointers into JS objects sometimes and then retrieve them later.</td></tr>

</tbody></table></div></div></div>
</body></html>