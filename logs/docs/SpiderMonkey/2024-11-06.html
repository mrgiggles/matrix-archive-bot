<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-11-06</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-11-06<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-11-05" class="nav-link"><span>prev</span></a>
<a href="2024-11-07" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Nov 05 2024 22:03:21 GMT-0800 (Pacific Standard Time)">06:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">It makes sense that unwinding a mozjs stack frame would hit that error. If an exception unwinds an <code>-fno-exceptions</code> frame, it's undefined behavior and compilers in practice apparently either call <code>std::terminate</code> or skip over any destructors in the unwound frame. It sounds like you're seeing the latter, and any <code>Rooted</code> variables on the stack aren't getting removed. The next one that does get removed will notice that it's not the one on top of the <code>Rooted</code> stack, and give that assertion.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Nov 05 2024 22:08:46 GMT-0800 (Pacific Standard Time)">06:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I suspect it should probably work ok to mix exception-using and <code>-fno-exceptions</code> code as long as you never unwind an <code>-fno-exceptions</code> frame (which effectively includes JIT frames). But I'm not sure; I could imagine there being wrinkles with using RAII classes whose constructors and/or destructors are implemented in mozjs.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Nov 05 2024 22:10:54 GMT-0800 (Pacific Standard Time)">06:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Constructors compiled with <code>-fno-exceptions</code> will assume that they will never call their destructors from within the constructor. I can't see how that would cause issues; if you throw an exception from within code called by the constructor, you'll have to catch it before it can abort the constructor anyway (under the "never unwind <code>-fno-exceptions</code> code" rule). But I might lack the cleverness to see how it could be bad.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Nov 05 2024 22:45:19 GMT-0800 (Pacific Standard Time)">06:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Destructors compiled with <code>-fno-exceptions</code> can inline their guts into the calling function, though I can't come up with a scenario where that would be a problem.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Nov 06 2024 08:24:15 GMT-0800 (Pacific Standard Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1929227#c3">Mayank asked why incremental bytecode encoding brings large improvements</a>, and I don't know, so I thought I would ask here.<br>TLDR; turning off incremental encoding makes some google-slides performance metrics improve (such as largestContentfulPaint, fcp, FirstVisualChange) and others to regress (such as loadtime, SpeedIndex, PerceptualSpeedIndex).</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Nov 06 2024 08:32:27 GMT-0800 (Pacific Standard Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">just detect which test we're running, easy! /s</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Nov 06 2024 08:35:40 GMT-0800 (Pacific Standard Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">visual-related score totally depends on the scheduling, due to race between resources and something, and it depends on how long each mainthread/offthread task take.   even if single task takes more, that can <em>improve</em> the visual score</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Nov 06 2024 08:36:29 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, I think unfortunately it's probably one of those cases where the answer boils down to "we're doing a bunch of stuff at the same time and small differences in scheduling can have big effects". In general, if the net effect across a bunch of different noisy benchmarks is good, then I try not to worry about a few data points in the other direction.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Nov 06 2024 08:42:46 GMT-0800 (Pacific Standard Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This is kind of a problem for all performance tracking. One of my formative experiences in my days working on IBM's COBOL compiler was spending the better part of a week trying to figure out why one of our benchmarks had regressed from a very simple codegen improvement, and it turned out that generating smaller code in one part of the function changed the cache-line alignment of the code for an unrelated (but important) loop in a way that the hardware didn't like. Eventually you just have to shrug and say "welp, this change should be good in the aggregate even if these specific benchmarks don't happen to like it" and ship it.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Nov 06 2024 08:50:42 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah.... it does make me wonder how orgs manage to get anything done with strict "no regression" policies </td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Nov 06 2024 08:51:21 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">By overfitting on a particular set of machines and producing bad work, I assume</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Nov 06 2024 09:06:31 GMT-0800 (Pacific Standard Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mayankleoboy1:mozilla.org">mayankleoboy1</span>&gt;</div></td><td class="msg-cell">Like sp3? :D </td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Nov 06 2024 09:08:00 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">The good news about SP3 is that we have evidence that it helps more than just SP3: <a href="https://hacks.mozilla.org/2023/10/down-and-to-the-right-firefox-got-faster-for-real-users-in-2023/">https://hacks.mozilla.org/2023/10/down-and-to-the-right-firefox-got-faster-for-real-users-in-2023/</a> </td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Nov 06 2024 09:35:31 GMT-0800 (Pacific Standard Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or at least, the initial wave of optimizations for sp3 produced real-world improvements. Hopefully the continued work won't slide into the overfitting category yet.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Nov 06 2024 09:36:07 GMT-0800 (Pacific Standard Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">"Fortunately" there seems to be a fair amount of headroom before we hit a global optimum, so (I think?) we're still in a relatively target-rich environment.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Nov 06 2024 12:17:58 GMT-0800 (Pacific Standard Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I get a failure for <a href="https://treeherder.mozilla.org/jobs?repo=autoland&amp;group_state=expanded&amp;selectedTaskRun=BlGoHo1jRA-yRPD0F1dkiw.1&amp;resultStatus=success%2Ctestfailed%2Cbusted%2Cexception%2Crunnable&amp;searchStr=linux%2Cx64%2Cdebug%2Chazard-linux64-haz%2Fdebug%2Ch&amp;revision=a5b67007fef784f72829151e51325f6ff335bce0">unrooted incumbentGlobal live across GC calls</a> error, do you have an idea about this?</td></tr>

</tbody></table></div></div></div>
</body></html>