<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-09-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-09-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-09-13" class="nav-link"><span>prev</span></a>
<a href="2022-09-15" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Sep 14 2022 05:44:06 GMT-0700 (Pacific Daylight Time)">12:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> if a call to <code>JS_ExecuteScript(cx, script1)</code> returns and I execute another <code>JS_ExecuteScript(cx, script2)</code> with the same cx param; is it possible that during execution of script2 "something" related to script1 gets executed?</blockquote></mx-reply>any hint would here would be much appreciated. during differential fuzzing of SM, maybe once in 1000 CPU hours a flaky/spurious differential execution appears. it seems to be some kind of lingering artifact caused by previously invocations of <code>JS_ExecuteScript</code> but the rarity of the situation makes it difficult to investigate</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Sep 14 2022 06:04:50 GMT-0700 (Pacific Daylight Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger 游눌游눌</span>&gt;</div></td><td class="msg-cell">Did someone mention the wasm jsapi spec?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Sep 14 2022 08:53:40 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I am still quite confused about how to implement modules. Suppose I have a script A which contains <code>export var foo = function() {}</code>, and script B which contains <code>import foo from myFile.js; foo();</code>. Am I able to run script B using <code>JS::Compile()</code> and <code>JS_ExecuteScript()</code>? Or am I obliged to use <code>JS::CompileModule()</code> and <code>JS::ModuleEvaluate()</code> instead?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Sep 14 2022 09:00:57 GMT-0700 (Pacific Daylight Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger 游눌游눌</span>&gt;</div></td><td class="msg-cell">I suspect <code>JS::Compile()</code> will treat <code>import</code> as a syntax error</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Sep 14 2022 09:09:43 GMT-0700 (Pacific Daylight Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">So in that case, is it possible to compile / execute module scripts ( ie scripts using "import") with an envChain?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Sep 14 2022 09:11:13 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Because I can only see the envChain option inside the regular compile / execute functions. I don't see them in the modules header file.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Sep 14 2022 09:28:43 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Here's the situation. I want the user to be able to run something like <code>nativelyDefinedFunction(); userDefinedFunction();</code>. In this case,<code>userDefinedFunction()</code> is a function that the user has defined in some text file, and put in a directory where the program knows how to find it. I thought that using modules would be the best way of accomplishing this. But my use of the envChain parameter in <code>JS_ExecuteScript()</code> is pretty fundamental in my code, so I can't affort to compromise it.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Sep 14 2022 11:10:20 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> any hint would here would be much appreciated. during differential fuzzing of SM, maybe once in 1000 CPU hours a flaky/spurious differential execution appears. it seems to be some kind of lingering artifact caused by previously invocations of <code>JS_ExecuteScript</code> but the rarity of the situation makes it difficult to investigate</blockquote></mx-reply>If you haven't created a new GlobalObject and used something like <code>JSAutoRealm</code>, then the same global/document/window will be used for script2 (similar to multiple script tags in html) so any mutation of global variables (including things like Array) will leak into the next invocation.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Sep 14 2022 11:17:29 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>:  many thanks; based on your description I'll try to produce a reproducer and then proceed to fix the issue</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Sep 14 2022 11:20:41 GMT-0700 (Pacific Daylight Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: unfortunately we don't have envChain support for modules. The envChain stuff is required for certain corners of HTML Forms, and then some grab bag of non-standard tricks. ES Modules don't have a standard need for envChain anywhere, and ES modules also have special features like top-level-await so they need the special <code>ModuleEvaluate</code> entry point. As a result there has never been a need for envChain with modules and there are probably weird edges around environments that would come up if you tried to hack it.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Sep 14 2022 11:22:10 GMT-0700 (Pacific Daylight Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">What type of objects are you passing as <code>envChain</code>?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Sep 14 2022 12:13:48 GMT-0700 (Pacific Daylight Time)">19:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>What kind of numerical types is it possible to translate into SM?<br>I assume float and int are a given, but what about unsigned? What about <a href="https://en.cppreference.com/w/cpp/ranges/range">range</a>?</p>
<p>How do these correlate to actual <a href="https://www.programiz.com/javascript/data-types">JavaScript data types</a>?<br><a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/edfe74b65fba34408ef22fef53aeec243bb26537/examples/cookbook.cpp#L98-L107">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/edfe74b65fba34408ef22fef53aeec243bb26537/examples/cookbook.cpp#L98-L107</a></p>
</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Sep 14 2022 12:25:27 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: Numbers in javascript are semantically doubles. Where possible, the engine uses a 32-bit integer representation internally, but only in cases where the behaviour is the same. For example, if integer addition overflows, then the result will be a double.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Sep 14 2022 12:26:01 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There's also BigInt, which can be used for integers too large to be represented precisely as a double.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Sep 14 2022 12:27:08 GMT-0700 (Pacific Daylight Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(For example, wasm maps i64 to BigInt)</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Sep 14 2022 12:30:46 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I'm confused on whether it's double or integer as you said. Isn't double really bad since the mantissa of the double is not accurate and not representing the actual number?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Sep 14 2022 12:33:07 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">like how for floats: 0.1 + 0.2         -&gt;  0.30000000000000004</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Sep 14 2022 12:33:49 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Neither 0.1 nor 0.2 is an integer. Doubles can precisely represent integers up to 2^53.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Sep 14 2022 12:35:58 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>I didn't understand the 2 statements:</p>
<blockquote>
<p>Numbers in javascript are semantically doubles. Where possible, the engine uses a 32-bit integer representation internally</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Sep 14 2022 12:36:06 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">is it a double or int then?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Sep 14 2022 12:36:37 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">"Semantically" means "the specification of JS means that numbers behave like doubles"</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Sep 14 2022 12:37:13 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But adding two integers together (or indexing an array using an integer) is faster than doing so using doubles</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Sep 14 2022 12:37:38 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So in cases where the value of a number can be accurately represented as an integer, the engine will do so</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Sep 14 2022 12:38:04 GMT-0700 (Pacific Daylight Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So long as we can preserve the <em>behaviour</em> of a double from the user's perspective</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Sep 14 2022 12:41:51 GMT-0700 (Pacific Daylight Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Thank you for the info</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Sep 14 2022 16:06:00 GMT-0700 (Pacific Daylight Time)">23:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I wonder if <code>js/xpconnect</code> should be moved to just <code>xpconnect</code> like <code>xpcom</code>...</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Sep 14 2022 16:06:51 GMT-0700 (Pacific Daylight Time)">23:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">We have the 'js/loader' directory now which is gecko (non-libmozjs) code, so I guess it isn't too unreasonable where it is</td></tr>

</tbody></table></div></div></div>
</body></html>