<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-08-04</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-08-04<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-08-03" class="nav-link"><span>prev</span></a>
<a href="2021-08-05" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Aug 03 2021 17:44:45 GMT-0700 (Pacific Daylight Time)">00:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can anyone help investigating regression/behavior change observed in <a href="https://phabricator.services.mozilla.com/D119426">https://phabricator.services.mozilla.com/D119426</a> ?  it's for bug 531915</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Aug 03 2021 17:44:48 GMT-0700 (Pacific Daylight Time)">00:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/531915">https://bugzil.la/531915</a> — ASSIGNED (me) — Floating point differences between platforms</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Aug 03 2021 17:45:35 GMT-0700 (Pacific Daylight Time)">00:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the patch adds pref to use fdlibm sin/cos/tan instead of native one.  and we observed slight regression in kraken audio-*</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Aug 03 2021 17:45:44 GMT-0700 (Pacific Daylight Time)">00:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but the reason of the regression isn't clear</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Aug 04 2021 08:29:44 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tsyesika</span>: ping?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Aug 04 2021 08:30:02 GMT-0700 (Pacific Daylight Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@jtallon:igalia.com">tsyesika</span>&gt;</div></td><td class="msg-cell">hello :) </td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Aug 04 2021 08:30:57 GMT-0700 (Pacific Daylight Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I think I'm starting to understand your patch and the spec a little better now. I think my general guidance is that we don't touch JSFunction or introduce the WasmFunctionObject C++ type.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Aug 04 2021 08:31:57 GMT-0700 (Pacific Daylight Time)">15:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The reason is that the existing JSFunction already handles all the WASM features we need here, so that is really not being changed. Rather, we are introducing the new prototype which seems similar to how js::GeneratorFunctionClass is done.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Aug 04 2021 08:33:23 GMT-0700 (Pacific Daylight Time)">15:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">So I think the <code>WasmFunctionObject::class</code> instead becomes <code>js::WasmFunctionClass</code> like <a href="https://searchfox.org/mozilla-central/rev/064a1e6a2a6f6aa30be8bf4edea2f8408f779d4d/js/src/vm/GeneratorObject.cpp#441-443">here</a>.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Aug 04 2021 08:34:22 GMT-0700 (Pacific Daylight Time)">15:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">And then we use the <code>CLASP(..)</code> instead of <code>OCLASP(..)</code> macro for the ProtoKey, like <a href="https://searchfox.org/mozilla-central/rev/064a1e6a2a6f6aa30be8bf4edea2f8408f779d4d/js/public/ProtoKey.h#104">here</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Aug 04 2021 08:35:26 GMT-0700 (Pacific Daylight Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">does that make any sense?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Aug 04 2021 08:37:32 GMT-0700 (Pacific Daylight Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@allstarschh:mozilla.org">@allstarschh|afk</span>&gt;</div></td><td class="msg-cell">@jonco <span class="nick-12">sfink</span>  : I will be 10 mins late for the meeting, the baby is hungry now</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Aug 04 2021 08:38:49 GMT-0700 (Pacific Daylight Time)">15:38</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@jtallon:igalia.com">tsyesika</span></div></td><td class="msg-cell">looks at how GeneratorFunctionClass works</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Aug 04 2021 08:44:02 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">None of this work is introducing any new "exotic" objects, so the new C++ class seems misleading. The existing JSFunction type already supports WASM (even with this types proposal), and we are introducing a new prototype which is just an ordinary object with a few methods on it (eg. <code>type(...)</code>). The <code>GeneratorFunctionClass</code> approach lets us describe how to create this new oridinary prototype object, as well as caching it with <code>ProtoKey</code> so that there is a unique copy in each global. Then, we are additionally exposing this new prototype object as the initial value of <code>WebAssembly.Function</code>. The <code>type(..)</code> can be called on any object, but your <code>CallNonGenericMethod</code> check means it will throw if we do bad things.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Aug 04 2021 08:51:11 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@jtallon:igalia.com">tsyesika</span>&gt;</div></td><td class="msg-cell">I think I understand. So, I add the type getter and constrcutor for <code>WebAssembly.Function</code> to JSFunction, remove the <code>WasmFunctionObject</code> c++ class entirely and just create a new <code>JSClass</code> and ClassSpec which has a prototype with the <code>.type()</code> method in the chain with the JSFunction type.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Aug 04 2021 08:51:27 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@jtallon:igalia.com">tsyesika</span>&gt;</div></td><td class="msg-cell">right?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Aug 04 2021 08:52:01 GMT-0700 (Pacific Daylight Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I think the type getter can just be a top-level functions</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Aug 04 2021 08:52:17 GMT-0700 (Pacific Daylight Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><code>WasmFunctionTypeGetter</code> or something</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Aug 04 2021 08:53:26 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><code>GeneratorFunctionClassFinish</code> is the equivilent example that is adding things like <code>type</code> to the GeneratorFunction</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Aug 04 2021 08:53:54 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@jtallon:igalia.com">tsyesika</span>&gt;</div></td><td class="msg-cell">okay. Sounds good. I'll get started on it tomorrow, thanks for looking at it.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Aug 04 2021 08:54:32 GMT-0700 (Pacific Daylight Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(I think the result will end up a little simpler too)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Aug 04 2021 08:55:04 GMT-0700 (Pacific Daylight Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@jtallon:igalia.com">tsyesika</span>&gt;</div></td><td class="msg-cell">I agree</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Aug 04 2021 13:53:24 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Hmm.. Bug 1723844 is a bit annoying. We have <a href="https://searchfox.org/mozilla-central/rev/4b49a0dc50104e03ecadd1fd1902b27be6b9c0c8/js/src/vm/Interpreter.cpp#422-433">assertion</a> to catch dumb errors in native C++ function implementations, but through fuzzing the debugger can replace the return value with dumb things that trip the assertion.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Aug 04 2021 13:53:26 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1723844">https://bugzil.la/1723844</a> — NEW (tcampbell) — Assertion failure: args.rval().isObject() &amp;&amp; callee != &amp;args.rval().toObject(), at /js/src/vm/Interpreter.cpp:433</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Aug 04 2021 13:54:14 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The simple thing is to add the same check to debugger hook APIs, but it is kind of arbitrary already</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Aug 04 2021 13:54:27 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">dunno what is least gross fix</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Aug 04 2021 14:22:06 GMT-0700 (Pacific Daylight Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">aha. there is a <code>JSContext::insideDebuggerEvaluationWithOnNativeCallHook</code> that is probably good enough</td></tr>

</tbody></table></div></div></div>
</body></html>