<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-09-30</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-09-30<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-09-29" class="nav-link"><span>prev</span></a>
<a href="2021-10-01" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Sep 30 2021 00:57:52 GMT-0700 (Pacific Daylight Time)">07:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: are modules now cached? I saw some work happening there a little while ago</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Sep 30 2021 00:59:07 GMT-0700 (Pacific Daylight Time)">07:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm not aware of any change around that</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Sep 30 2021 00:59:23 GMT-0700 (Pacific Daylight Time)">07:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ok</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Sep 30 2021 00:59:58 GMT-0700 (Pacific Daylight Time)">07:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">which module is it about? web content, or chrome-priv code?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Sep 30 2021 01:00:10 GMT-0700 (Pacific Daylight Time)">08:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">chrom-priv</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Sep 30 2021 01:00:44 GMT-0700 (Pacific Daylight Time)">08:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but, i am also wondering about the general web content modules, as I am working heavily on that code but noticed on rebase that everything applied cleanly</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Sep 30 2021 01:01:32 GMT-0700 (Pacific Daylight Time)">08:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, no change so far.  the cache itself should work, but decode part needs some work to support instantiating modules</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Sep 30 2021 01:01:58 GMT-0700 (Pacific Daylight Time)">08:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is there already a bug for it?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Sep 30 2021 01:02:30 GMT-0700 (Pacific Daylight Time)">08:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">No, I can make one but it may be a little premature if it requires changes to the script loader</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Sep 30 2021 01:02:49 GMT-0700 (Pacific Daylight Time)">08:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I am finishing up the required changes to the script loader now for supporting workers</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Sep 30 2021 01:04:18 GMT-0700 (Pacific Daylight Time)">08:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Sep 30 2021 01:04:53 GMT-0700 (Pacific Daylight Time)">08:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, also I think the cache part needs change given that same script can be loaded both as module and script, and the result is different</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Sep 30 2021 01:05:14 GMT-0700 (Pacific Daylight Time)">08:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so the cache system should include the type of the compilation target as key</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Sep 30 2021 01:06:36 GMT-0700 (Pacific Daylight Time)">08:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(not sure if that happens in normal case, given module without import/export doesn't make much sense, but it's still possible</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Sep 30 2021 01:11:06 GMT-0700 (Pacific Daylight Time)">08:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that part can be changed right now</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Sep 30 2021 01:11:12 GMT-0700 (Pacific Daylight Time)">08:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ok, that sounds good</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Sep 30 2021 01:11:23 GMT-0700 (Pacific Daylight Time)">08:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">it looks like the desktop team wants to start using es6 soon</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Sep 30 2021 01:11:52 GMT-0700 (Pacific Daylight Time)">08:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I see</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Sep 30 2021 01:12:10 GMT-0700 (Pacific Daylight Time)">08:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I have the prototype which does a naive implementation</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Sep 30 2021 01:12:36 GMT-0700 (Pacific Daylight Time)">08:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but it isn't correct, it is only enough to see where es6 modules might be lacking compared to a full implementation</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Sep 30 2021 04:22:32 GMT-0700 (Pacific Daylight Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell"><p>me again with a porting question. The library I'm working on has the concept of scoping. This is implemented by calling JS_NewObject with the custom class, and then variables are set within that scope with JS_DefineUCProperty. When a scope is pushed it does a similar thing - creates a new Scope object and sets it as a property of the parent Scope.</p>
<p>Variables are retrieved out of Scopes by using (what used to be JS_ExecuteScript and is now) JS_Evaluate just specifying the variable name. However it doesn't appear that within a Scope that I can access properties of a parent Scope. I've implemented this using a <code>JS::RootedVector&lt;JSObject*&gt; js_scope_chain(context)</code> and pushing all the scope objects into that vector before running <code>JS::Evaluate(context, js_scope_chain, options, source, &amp;rval)</code>.</p>
<p>Is this something you'd expect to work? Am I missing something obvious?</p>
</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Sep 30 2021 04:39:58 GMT-0700 (Pacific Daylight Time)">11:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">cmeister2</span>: yes, it should work</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Sep 30 2021 04:40:06 GMT-0700 (Pacific Daylight Time)">11:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">here's example <a href="https://searchfox.org/mozilla-central/source/js/src/jsapi-tests/testJSEvaluateScript.cpp">https://searchfox.org/mozilla-central/source/js/src/jsapi-tests/testJSEvaluateScript.cpp</a></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Sep 30 2021 04:40:39 GMT-0700 (Pacific Daylight Time)">11:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and another example that defines property on the object and retrieves from script <a href="https://paste.mozilla.org/nKY1cdQz">https://paste.mozilla.org/nKY1cdQz</a></td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Sep 30 2021 04:44:25 GMT-0700 (Pacific Daylight Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if it doesn't, can you provide the code around that?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Sep 30 2021 05:36:06 GMT-0700 (Pacific Daylight Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell">Thanks for those. Let me take another look at the source</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Sep 30 2021 06:00:11 GMT-0700 (Pacific Daylight Time)">13:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> You are... well off the beaten path. <br><br>To your first question, I have no idea. <br><br>To your second question... is this something you could implement as part of your implementation of JobQueue (I presume you have your own implementation here). Maybe? <br><br>Sorry for not having more answers</blockquote></mx-reply>it seems that SM can only have a single job queue per Context. Of course, it is possible (or is it?) to emulate multiple queues by differentiating Promise object's Globals and chugging them into sub-queues inside the main queue, but that sounds like a pretty big undertaking...</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Sep 30 2021 06:16:31 GMT-0700 (Pacific Daylight Time)">13:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> it seems that SM can only have a single job queue per Context. Of course, it is possible (or is it?) to emulate multiple queues by differentiating Promise object's Globals and chugging them into sub-queues inside the main queue, but that sounds like a pretty big undertaking...</blockquote></mx-reply>Yeah, that was sort of what I was alluding to</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Sep 30 2021 06:16:37 GMT-0700 (Pacific Daylight Time)">13:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">ðŸ˜¬</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Sep 30 2021 06:17:39 GMT-0700 (Pacific Daylight Time)">13:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">It's just a bit strange that Job queue is per Context and not per Global/Realm</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Sep 30 2021 06:19:19 GMT-0700 (Pacific Daylight Time)">13:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there can be multiple globals in single page, because of frame/iframe etc, but there's only one running context and job queue</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Sep 30 2021 06:19:29 GMT-0700 (Pacific Daylight Time)">13:19</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span></div></td><td class="msg-cell">gestures vaguely at the "web threading model" </td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Sep 30 2021 06:19:47 GMT-0700 (Pacific Daylight Time)">13:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(Of which I only have the roughest cut of understanding) </td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Sep 30 2021 06:22:04 GMT-0700 (Pacific Daylight Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@cmeister2:mozilla.org">cmeister2</span>&gt;</div></td><td class="msg-cell">looking at my cutdown code it works :( so obviously there's something weird happening. is there a trivial way of printing out to stdout whenever something is GCed?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Sep 30 2021 06:24:21 GMT-0700 (Pacific Daylight Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> there can be multiple globals in single page, because of frame/iframe etc, but there's only one running context and job queue</blockquote></mx-reply>I see, so it seems that I should actually consider all my Globals as a single HTML event loop</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Sep 30 2021 07:50:59 GMT-0700 (Pacific Daylight Time)">14:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">TheQwertiest</span>: what communication do you need between these globals / event loops? If everything is separate, then one natural model would be multiple threads with a runtime (and JSContext) per thread. It's not great if they're going to be accessing anything shared, in your embedding or in the JS heap. Or if threads are a problem.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Sep 30 2021 07:54:01 GMT-0700 (Pacific Daylight Time)">14:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if you don't want to go the multiple thread route, then I think the right model would still depend on the degree of communication and control flow between your separate... globals or whatever they are. Could one global's thread of execution end up running code associated with a different global? Do they share any data? What data?</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Sep 30 2021 08:05:38 GMT-0700 (Pacific Daylight Time)">15:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Hello there, I do have some question about Debugger.Memory API and especiall its <code>trackingAllocationSites</code> feature, which also relate to <code>SavedFrame</code> class. Is this the right channel to ask questions about this code?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Sep 30 2021 08:06:53 GMT-0700 (Pacific Daylight Time)">15:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Long story short is that this Memory API is useful to track leaks... but it introduces many. It looks like when we enable allocation site recording we hold references to <code>SavedFrame</code> itself forcing to keep in memory the globals/documents from which the <code>SavedFrame</code> originates :/</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Sep 30 2021 09:30:24 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ochameau</span> definitely the right channel</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Sep 30 2021 09:30:55 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I think knowledge is a bit thin, but worth asking (having said that, it might be even better to open a bug just so this discussion can be preserved better) </td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Sep 30 2021 09:32:52 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Ok, let me do that. I'll try to also provide a mochitest to better highlights what's wrong.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Sep 30 2021 09:38:11 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">That would be -amazing- </td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Sep 30 2021 09:43:18 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">TheQwertiest</span>: what communication do you need between these globals / event loops? If everything is separate, then one natural model would be multiple threads with a runtime (and JSContext) per thread. It's not great if they're going to be accessing anything shared, in your embedding or in the JS heap. Or if threads are a problem.</blockquote></mx-reply><p>each global/realm is corresponding to a separate window (with it's own message loop), but everything happens (and must happen) on the main thread only.<br>The only communication between Globals/Realms are</p>
<ul>
<li>GC stuff</li>
<li>job queue</li>
<li><code>window.postMessage</code>-like method</li>
<li>some native shared stuff</li>
</ul>
</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Sep 30 2021 09:45:37 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so the relative ordering of job queue jobs is visible because of the existence of postMessage operations, I guess?  (Because otherwise if everything runs to completion, it doesn't seem like one global could detect that it's getting its jobs interleaved with another's.)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Sep 30 2021 09:48:46 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">postMessage stuff is rarely used. I guess I have to explain what my embedding does to make the scenario easier to understand
</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Sep 30 2021 10:08:00 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><p>There is an application that provides customization points.<br>One of those customization points is ability to create "panels", which makes it possible to replace the whole app interface.<br>Each "panel" is an object that has <code>on_message(Message)</code> callback which is invoked by the host application (it can be invoked by the "panel" itself as well).<br>Each <code>on_message(Message)</code> callback is always invoked on the main thread.</p>
<p>My embedding is an implementation of these "panels", which allows user to use JS to create them.<br>Each "panel" corresponds to a separate Global/Realm (so that user can create and use different panels without them interfering with each other). And all of those Globals/Realms belong to a single JSContext.</p>
<p>Currently all messages that must be processed by the JS are queued as events/tasks in a separate internal event priority queue (one queue for each panel).<br><code>on_message</code> callback mimics (or tries to) HTML event loop:</p>
<ul>
<li>if not nested, takes a single event/task from the corresponding internal queue and processes it.</li>
<li>after processing the event/task, if not nested, drains the job queue (aka <code>js::RunJobs</code>).</li>
</ul>
<p>The problem that I currently have is that while the execution of JS stuff in Realms/Globals is separate from each other, job processing (aka Promises) is not. So it makes the behaviour of each "panel" less intuitive (e.g. a Promise job might not be triggered in one panel, because another panel still has a nested call).</p>
</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Sep 30 2021 10:10:20 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">PS: this application is foobar2000, just in case anyone wondered :)</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Sep 30 2021 10:12:11 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if there's nested call, the other panel's event isn't processed?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Sep 30 2021 10:13:56 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">I've not decided yet xD
This is actually one of the reasons why I've delved into this "HTML event loop" stuff. My first implementation had a global "nested" counter. Now I'm contemplating if it should be made per "panel" instead to be more "canonical".</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Sep 30 2021 10:16:27 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, which is it "loop" or "call" that nests?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Sep 30 2021 10:16:34 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">Ideally my embedding should behave similar to JS built in browsers and NodeJS, so that users with previous JS experience won't get surprised by unexpected behaviour.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Sep 30 2021 10:19:16 GMT-0700 (Pacific Daylight Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can a panel block other panels' execution for long time, without just executing heavy task?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Sep 30 2021 10:25:11 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> err, which is it "loop" or "call" that nests?</blockquote></mx-reply><p>Something like this:</p>
<pre><code>void on_messsage(msg) 
{
  if (IsInternalRunNextMessage(msg)) {
     nestedCounter++;
     
     if (nestedCounter == 1) {
       queue.ProcessNextEvent()
     }

     nestedCounter--;
     if (!nestedCounter) {
       PostMessage("i_want_next_event");
       RunJobs()
     }
  }
  else {
     DoStuffWithOtherMessages();
  }
}

</code></pre>
</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Sep 30 2021 10:26:49 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it sounds like <code>ProcessNextEvent</code> can call <code>on_messsage</code> ?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Sep 30 2021 10:27:21 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> can a panel block other panels' execution for long time, without just executing heavy task?</blockquote></mx-reply>should not happen</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Sep 30 2021 10:30:22 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><p>it's possible during some scenarios (e.g. ProcessNextEvent triggers WM_QUIT, which is synchronous IIRC).</p>
<p>Nested calls can happen when modal dialog is created during ProcessNextEvent. If this happens then current on_messsage call is blocked (by the OS mechanism), and during the next on_messsage call the nested call guard is ignored for ProcessNextEvent (but still used for RunJobs). I don't like this, but I couldn't find a better way.</p>
</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Sep 30 2021 10:31:32 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ah, so the "message" directly maps Windows' message?</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Sep 30 2021 10:32:00 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><code>Msg</code> in <code>on_message</code> is a Windows message, yes =)</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Sep 30 2021 10:35:54 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">I can link the source code if you want, but I think it will be much easier to understand if I continue to use a simplified description instead (though some parts of event loop processing are adapted directly from Mozilla source=)).</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Sep 30 2021 10:36:34 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is the modal dialog's content related to the JS ?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Sep 30 2021 10:36:43 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I mean, does it require processing JS ?</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Sep 30 2021 10:38:45 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I mean, does it require processing JS ?</blockquote></mx-reply>hm... I don't think so, no. I can't recall immediately any such calls</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Sep 30 2021 10:40:45 GMT-0700 (Pacific Daylight Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if "modal" dialog is opened, message handling is stopped for all panels, right?</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Sep 30 2021 10:41:35 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> so, if "modal" dialog is opened, message handling is stopped for all panels, right?</blockquote></mx-reply>no, because as I've said above "If this happens ... during the next on_messsage call the nested call guard is ignored for ProcessNextEvent (but still used for RunJobs)"</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Sep 30 2021 10:42:21 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">because otherwise the whole panel becomes frozen which is not a good UX =)</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Sep 30 2021 10:45:30 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I guess I mixed up which is JS and which is native :P</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Sep 30 2021 10:46:11 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">JS is executed in <code>ProcessNextEvent</code> and <code>RunJobs</code> ?</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Sep 30 2021 10:49:26 GMT-0700 (Pacific Daylight Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">iiuc <code>ProcessNextEvent</code> is the main dispatch mechanism that triggers JS execution, and <code>RunJobs</code> is draining the microtask queue (I think that's HTML terminology) which means it'll run JS to resolve Promises</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Sep 30 2021 10:50:11 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(or whatever the right Promise terminology is; I can never get my head straight wrt that stuff)</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Sep 30 2021 10:50:21 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> JS is executed in <code>ProcessNextEvent</code> and <code>RunJobs</code> ?</blockquote></mx-reply>yep</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Sep 30 2021 10:50:57 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> iiuc <code>ProcessNextEvent</code> is the main dispatch mechanism that triggers JS execution, and <code>RunJobs</code> is draining the microtask queue (I think that's HTML terminology) which means it'll run JS to resolve Promises</blockquote></mx-reply>yepyep</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Sep 30 2021 10:52:39 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if modal dialog is opened and nested native event loop happens, <code>nestedCounter</code> is 2, and ProcessNextEvent isn't called until the modal dialog is closed?</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Sep 30 2021 10:54:07 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">btw, is "modal dialog" already provided in the current system?  I seems to recall that modal dialog was really troublesome around the nested loop, in Firefox/Thunderbird development</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Sep 30 2021 10:57:02 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><p>ugh, my bad:</p>
<ul>
<li>if modal dialog is opened and nested native event loop happens, nestedCounter is 2, <em>but</em> ProcessNextEvent is still called (so as not to freeze the UI)</li>
<li>I can't remember immediately which other scenarios can trigger the nested event, but if it <em>does</em> happen then ProcessNextEvent <em>won't</em> be called</li>
</ul>
<p>i.e. modal dialogs remove the "no nested calls" rule for the ProcessNextEvent</p>
</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Sep 30 2021 10:58:35 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> btw, is "modal dialog" already provided in the current system?  I seems to recall that modal dialog was really troublesome around the nested loop, in Firefox/Thunderbird development</blockquote></mx-reply>modal dialogs can be triggered when interacting with the host app from JS</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Sep 30 2021 10:59:29 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">those are problematic, but I can't avoid them, since they are a part of the host app and are required for some operations</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Sep 30 2021 11:22:47 GMT-0700 (Pacific Daylight Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hmm, for nested loop and promise jobs, I think you can mimic what Firefox does for the task + microtask with nested loop's case, but if "modal" isn't really modal and it still handles other messages and triggers JS code, it would behave somewhat surprisingly anyway (that was true also on Firefox, that XBL + microtask checkpoint was very troublesome)</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Sep 30 2021 12:19:07 GMT-0700 (Pacific Daylight Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>:  what do you mean by "what FF does" though? =)</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Sep 30 2021 13:00:08 GMT-0700 (Pacific Daylight Time)">20:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: Thanks for the review comments. The problem I ran into when I tried to add a pref+command-line flag was that in js/src/builtin/Array.cpp, the Array methods are defined as a static const array, and when I tried to make that dynamically computed based on the command-line flag, it ended up requiring a lot of invasive changes</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Sep 30 2021 13:00:37 GMT-0700 (Pacific Daylight Time)">20:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell">I can try to do it anyway if necessary, but it would be helpful to see an example of another change adding new methods that does this</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Sep 30 2021 13:16:34 GMT-0700 (Pacific Daylight Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">Tim</span>: look at <code>ShouldIgnorePropertyDefinition</code>. For example, <code>FinalizationRegistry</code>'s <code>cleanupSome</code> method is conditional.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Sep 30 2021 14:53:23 GMT-0700 (Pacific Daylight Time)">21:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: here is the bug about the leak <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1733480">https://bugzilla.mozilla.org/show_bug.cgi?id=1733480</a> with an attached mochitest. Let me know if you have any question.</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Sep 30 2021 15:09:20 GMT-0700 (Pacific Daylight Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ochameau</span>: Thanks! I'm past EOD today, but I'll take a look tomorrow, and at worst 'triage' it into a ni? for... someone :P</td></tr>

</tbody></table></div></div></div>
</body></html>