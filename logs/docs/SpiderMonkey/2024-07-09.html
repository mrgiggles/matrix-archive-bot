<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-07-09</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-07-09<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-07-08" class="nav-link"><span>prev</span></a>
<a href="2024-07-10" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jul 08 2024 21:51:58 GMT-0700 (Pacific Daylight Time)">04:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ptomato:gnome.org">ptomato</span>&gt;</div></td><td class="msg-cell">is making JS::WeakCache available again to embedders a realistic possibility at all? see <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1828648#c5">https://bugzilla.mozilla.org/show_bug.cgi?id=1828648#c5</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jul 09 2024 01:35:54 GMT-0700 (Pacific Daylight Time)">08:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ptomato</span>: Yeah it's a possibility. What's your use case?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jul 09 2024 01:56:16 GMT-0700 (Pacific Daylight Time)">08:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Oh right, I've read the comment now. Seems fine, it was only removed because I thought no one was using it.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jul 09 2024 01:57:05 GMT-0700 (Pacific Daylight Time)">08:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">It does raise the question of how we track which APIs are used by embedders.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jul 09 2024 11:37:28 GMT-0700 (Pacific Daylight Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">that's a good question and I don't have a good answer. an imperfect answer is maybe to post in <a href="https://discourse.mozilla.org/c/spidermonkey/551">https://discourse.mozilla.org/c/spidermonkey/551</a> when considering removing one?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jul 09 2024 12:56:04 GMT-0700 (Pacific Daylight Time)">19:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>Ok, so React Stock Charts slowdown -- Appears we get a bunch of extra invalidations;</p>
<p>Root cause seems to be this function (unminified):</p>
<pre><code class="language-js">function () {
                    var t = this.__on;
                    if (t) {
                        for (var n, r = 0, o = -1, a = t.length; r &lt; a; ++r) (n = t[r]), (e.type &amp;&amp; n.type !== e.type) || n.name !== e.name ? (t[++o] = n) : this.removeEventListener(n.type, n.listener, n.capture);
                        ++o ? (t.length = o) : delete this.__on;
                    }
                };
</code></pre>
<p>No idea what it's doing, but does seem to cause a number of invalidations that otherwise wouldn't have happened.</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jul 09 2024 12:56:37 GMT-0700 (Pacific Daylight Time)">19:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Haven't been able to align it with anything in the Speedometer repo yet -- can we build SP3 without minification?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jul 09 2024 13:06:27 GMT-0700 (Pacific Daylight Time)">20:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: <a href="https://shell--speedometer-preview.netlify.app">https://shell--speedometer-preview.netlify.app</a> has the unminified code</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jul 09 2024 13:09:27 GMT-0700 (Pacific Daylight Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>Awesome. That points to this as my culprit:</p>
<pre><code>            function onRemove(typename) {
                return function() {
                    var on = this.__on;
                    if (on) {
                        for (var o, j = 0, i = -1, m = on.length; j &lt; m; ++j) o = on[j], typename.type &amp;&amp; o.type !== typename.type || o.name !== typename.name ? on[++i] = o : this.removeEventListener(o.type, o.listener, o.capture);
                        ++i ? on.length = i : delete this.__on;
                    }
                };
            }
</code></pre>
</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jul 09 2024 13:11:44 GMT-0700 (Pacific Daylight Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>which in turn seems to be coming from <code>charts/dist/assets/plot-562fbdb6.js</code></p>
<pre><code class="language-js">function onRemove(typename) {
  return function() {
    var on = this.__on;
    if (!on)
      return;
    for (var j = 0, i = -1, m = on.length, o; j &lt; m; ++j) {
      if (o = on[j], (!typename.type || o.type === typename.type) &amp;&amp; o.name === typename.name) {
        this.removeEventListener(o.type, o.listener, o.options);
      } else {
        on[++i] = o;
      }
    }
    if (++i)
      on.length = i;
    else
      delete this.__on;
  };
}
</code></pre>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jul 09 2024 13:12:40 GMT-0700 (Pacific Daylight Time)">20:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Does this get called once per iteration with a big pile of invalidations, or repeatedly?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jul 09 2024 13:13:09 GMT-0700 (Pacific Daylight Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I wonder if the problem is that invalidating a bunch of scripts that will never run again is more expensive than not doing so</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jul 09 2024 13:17:45 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">In the rr recording I have we do this at least 4 times; we toss fewer scripts each time. Same back trace at every time </td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jul 09 2024 13:20:00 GMT-0700 (Pacific Daylight Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">but you can sort of imagine that these could be pretty costly. Doubly so if most scripts would only hit the guard conditionally. </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jul 09 2024 13:20:42 GMT-0700 (Pacific Daylight Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">LIke... this patch seems like it definitely will help the super happy path be even happier; but it is risky from a cliff perspective. Lots of potential collateral damage possible</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jul 09 2024 13:27:47 GMT-0700 (Pacific Daylight Time)">20:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I'm also not sure if there's any way to make it less potentially explosive...</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jul 09 2024 13:41:54 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I guess one thing would be to store a hint on the jitscript to not compile in that type of invalidation a second time... </td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jul 09 2024 14:07:11 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">One alternative would be to assume that if the fuse fires once, it may fire again, so we generate a constraint if the generation count is 0, and a guard otherwise</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jul 09 2024 14:07:50 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Or instead of generation count 0 we could set a flag on the realm when we bump the generation count with a non-empty set of depenencies, which might be slightly more precise)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jul 09 2024 14:09:53 GMT-0700 (Pacific Daylight Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Trying out the jit-script version shortly. I may light aflame in my office before I report back. Heat waves suck.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jul 09 2024 14:15:40 GMT-0700 (Pacific Daylight Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">hmm. Didn't seem to change the number of invalidations... I will get some beverage then do some actual science rather than numbervibes.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jul 09 2024 14:46:29 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. Investigating some alternatives -- but so far no clean fixes</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jul 09 2024 14:49:09 GMT-0700 (Pacific Daylight Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I will say -- just dumping the generation counts and expected values... there's a surprisingly large number of compilations that will get tossed. 

This too could be a cause of grief; again, the situation being that you have some conditional dependency where you'd normally bail if the generation count is wrong -- but most times you never actually hit that conditional branch, and thus you get a useful ion compilation. 

With compilation dependencies, because we check them at link time, we're just tossing these compilations rather than actually using them.  </td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jul 09 2024 14:54:07 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Interesting that we're tossing compilations at link time. I wonder if the number of bailouts goes down to compensate. Or maybe being in Ion until we invalidate is worthwhile?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jul 09 2024 14:56:44 GMT-0700 (Pacific Daylight Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Possibly? It sort of seems like this might be a case where more bailouts is better than more invalidations.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jul 09 2024 14:57:38 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I think in the short term I will rework this stack to land the cleanup code, and then leave the generation count invalidations to the side for the time being; then I can at least just deal with one thing at at time :) </td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jul 09 2024 14:57:49 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Tomorrow though. EOD approacheth rapidly here. </td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jul 09 2024 15:01:32 GMT-0700 (Pacific Daylight Time)">22:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Hey all.   I've just realized there is an option for a trace function hook in JSClassOps.

If I use that, does it mean I don't have to use MyCustomClass with a trace() function and Rooted&lt;MyCustomClass&gt; ?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jul 09 2024 15:07:42 GMT-0700 (Pacific Daylight Time)">22:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I don't remember what you were doing well enough. But yes, if you're defining your own type of JS object that stores a private pointer to a C++ object, then it is common and expected to define a trace hook to trace it.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Jul 09 2024 15:08:07 GMT-0700 (Pacific Daylight Time)">22:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK that makes way more sense.  </td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Jul 09 2024 15:10:11 GMT-0700 (Pacific Daylight Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">all of your slots that contain GC pointers (encoded in <code>JS::Value</code>s) will still get traced automatically, so you only need to trace any additional stuff you're storing that the GC can't figure out automatically.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Jul 09 2024 15:10:42 GMT-0700 (Pacific Daylight Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(the usual example is a private pointer to a C++ thing that itself stores GC stuff)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Jul 09 2024 15:14:15 GMT-0700 (Pacific Daylight Time)">22:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">It would have been nice if that was included in the tracing code example.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Jul 09 2024 15:16:56 GMT-0700 (Pacific Daylight Time)">22:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">That is a very polite, restrained way of saying that. Thank you. My apologies for the grief it caused.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Jul 09 2024 15:17:02 GMT-0700 (Pacific Daylight Time)">22:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm reading through the code example right now.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Jul 09 2024 15:17:24 GMT-0700 (Pacific Daylight Time)">22:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">based on the description at the top, I agree that it is a glaring omission.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Jul 09 2024 15:18:14 GMT-0700 (Pacific Daylight Time)">22:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess it gets into defining a custom JSClass, which otherwise the tracing example wouldn't involve.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Jul 09 2024 15:18:44 GMT-0700 (Pacific Daylight Time)">22:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it still seems like it should have it, though. Not just a comment.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Jul 09 2024 15:27:11 GMT-0700 (Pacific Daylight Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">If it fit, it could go in the lazy property resolve example, where there's already a custom JSClass?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Jul 09 2024 15:29:23 GMT-0700 (Pacific Daylight Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm leaning towards putting it directly in tracing.cpp. It's a more common tracing situation than some of the things in that file now, even though they are good and useful.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Jul 09 2024 15:29:34 GMT-0700 (Pacific Daylight Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(just for findability)</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Jul 09 2024 15:29:50 GMT-0700 (Pacific Daylight Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(there's gotta be a better word, preferably one that is a word)</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Jul 09 2024 16:52:38 GMT-0700 (Pacific Daylight Time)">23:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">bleh, that took me a while. <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/82">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/82</a></td></tr>

</tbody></table></div></div></div>
</body></html>