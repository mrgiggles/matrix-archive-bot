<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-09-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-09-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-09-13" class="nav-link"><span>prev</span></a>
<a href="2023-09-15" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Sep 13 2023 21:01:47 GMT-0700 (Pacific Daylight Time)">04:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">would it be possible to statically allocate <code>JSAtom</code> ? I'm wondering if entries in <a href="https://searchfox.org/mozilla-central/rev/1cae9ca7cc7d17cfc92088dfc68e5ff391128caa/js/src/vm/JSAtomState.h#20">JSAtomState</a> can be allocated statically instead of <a href="https://searchfox.org/mozilla-central/rev/1cae9ca7cc7d17cfc92088dfc68e5ff391128caa/js/src/vm/JSAtomUtils.cpp#252">allocating it while startup</a> from <a href="https://searchfox.org/mozilla-central/rev/1cae9ca7cc7d17cfc92088dfc68e5ff391128caa/js/src/vm/WellKnownAtom.cpp#9">js::wellKnownAtomInfos</a>.   the context is that I'm trying to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1848278">extend the JSAtomState with embedding-provided strings</a> (WebIDL properties), and it looks like <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1850344#c2">it's better putting all WebIDL properties into the table</a> (instead of limited set, such like frequently used). that means we need to atomize many strings either at compile-time or startup.  then, given the string itself is stored into binary, if <code>JSAtom</code> can also be stored into binary, that can reduce the cost during startup and also reduce the memory consumption (avoid the duplicate)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Sep 13 2023 21:04:10 GMT-0700 (Pacific Daylight Time)">04:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, the actual question would be:  1. is there a restriction about the address of <code>JSAtom</code> ?  2. can <code>JSAtom</code> be external ?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Sep 14 2023 02:03:53 GMT-0700 (Pacific Daylight Time)">09:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">arai: one problem is that all GC things live in chunks allocated by the GC, and these chunks have headers containing mark bits and other data that are found based on the address of the GC thing. </td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Sep 14 2023 02:05:08 GMT-0700 (Pacific Daylight Time)">09:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">also thing kind is found relative to the arena in the chunk</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Sep 14 2023 02:07:40 GMT-0700 (Pacific Daylight Time)">09:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">It might be possible to arrange similar data structures for statically allocated atoms.  Alternatively we might need to have a flag stored in the atom and then make sure we check it everywhere before accessing such data.  The latter is harder and I'm not sure it's possible because of all the places where we can have a pointer to a generic GC thing without knowing what kind it is.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Sep 14 2023 02:19:05 GMT-0700 (Pacific Daylight Time)">09:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">does the chunk need to be aligned to certain size?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Sep 14 2023 02:29:03 GMT-0700 (Pacific Daylight Time)">09:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hm, looks like we can just use <code>alignas</code> if necessary?  I'm not sure if there's any limit on <code>alignas</code> tho</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Sep 14 2023 02:32:33 GMT-0700 (Pacific Daylight Time)">09:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'll check if it's possible to create the chunk statically</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Sep 14 2023 03:24:48 GMT-0700 (Pacific Daylight Time)">10:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">arai: yes chunks are aligned to 1MB</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Sep 14 2023 03:25:46 GMT-0700 (Pacific Daylight Time)">10:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">alignas doesn't currently work for dynamic allocations greater than a certain alignment, but I don't know whether it works for static data</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Sep 14 2023 03:26:48 GMT-0700 (Pacific Daylight Time)">10:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">you may need to fake a bunch of suff in chunks and arenas, but that doesn't matter because these data structures will never be traversed by the GC</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Sep 14 2023 03:38:20 GMT-0700 (Pacific Daylight Time)">10:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, I've tested locally and 1MB align seems to work for statically allocated struct, at least on clang</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Sep 14 2023 06:42:00 GMT-0700 (Pacific Daylight Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">is it reasonable that this assert is caused by some kind of oom condition? <a href="https://searchfox.org/mozilla-central/source/js/src/jit/ProcessExecutableMemory.cpp#584">https://searchfox.org/mozilla-central/source/js/src/jit/ProcessExecutableMemory.cpp#584</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Sep 14 2023 06:44:49 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><p>From : mmap man page:</p>
<pre><code>       On success, mmap() returns a pointer to the mapped area.  On
       error, the value MAP_FAILED (that is, (void *) -1) is returned,
       and errno is set to indicate the error.
</code></pre>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Sep 14 2023 06:46:04 GMT-0700 (Pacific Daylight Time)">13:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">so it is possible that this assert would be triggered if: 1/ we run out of memory, or 2/ someone managed to jump in the middle of the function to call mmap without setting up properly the registers for the assertion to pass.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Sep 14 2023 06:47:17 GMT-0700 (Pacific Daylight Time)">13:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">however, I would expect the decommit to always work, unless the TLB overflows while remapping.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Sep 14 2023 06:53:40 GMT-0700 (Pacific Daylight Time)">13:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">I guess decommit could fail if the OS has to split a memory mapping due to the decommit but there are no mappings left. so probably some OOM issue</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Sep 14 2023 06:54:51 GMT-0700 (Pacific Daylight Time)">13:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I experienced it in the past with mprotect, Linux was properly reporting an OOM, Windows claimed wrong argument, and Mac crashed in the mprotect function.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Sep 14 2023 07:45:28 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">Do we know why we're worse than Chrome on the "WebAssembly Godot" benchmark?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Sep 14 2023 07:47:07 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Do we know why we're worse than Chrome on the "WebAssembly Godot" benchmark?</blockquote></mx-reply>Not really. Do you know how much worse we are?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Sep 14 2023 07:48:48 GMT-0700 (Pacific Daylight Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: is it possible the axis is in the wrong direction on <a href="https://arewefastyet.com/win10/benchmarks/overview?numDays=60">https://arewefastyet.com/win10/benchmarks/overview?numDays=60</a>?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Sep 14 2023 07:49:29 GMT-0700 (Pacific Daylight Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">Chrome gets 362, Firefox baseline 700, Firefox optimizing 1467</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Sep 14 2023 07:50:27 GMT-0700 (Pacific Daylight Time)">14:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">or maybe it's a startup test?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Sep 14 2023 07:52:51 GMT-0700 (Pacific Daylight Time)">14:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: it could definitely be a startup test, we've seen that before with some wasm tests in jetstream2</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Sep 14 2023 07:53:23 GMT-0700 (Pacific Daylight Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">V8 does lazy compilation of wasm functions, so if that test doesn't do much meaningful work we'd be penalized quite a bit compared to v8</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Sep 14 2023 07:55:01 GMT-0700 (Pacific Daylight Time)">14:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">I think the axis is correct, the unit looks like milliseconds</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Sep 14 2023 07:58:08 GMT-0700 (Pacific Daylight Time)">14:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Stupid spec question, when it reads <code>Let ownKeys be ? O.[[OwnPropertyKeys]]().</code>, can <code>OwnPropertyKeys</code> be redefined by the user, or is the double bracket a symbol-like?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Sep 14 2023 07:59:37 GMT-0700 (Pacific Daylight Time)">14:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think the axis is correct, the unit looks like milliseconds</blockquote></mx-reply>yeah, running it locally I do see better times in Chrome</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Sep 14 2023 07:59:49 GMT-0700 (Pacific Daylight Time)">14:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> V8 does lazy compilation of wasm functions, so if that test doesn't do much meaningful work we'd be penalized quite a bit compared to v8</blockquote></mx-reply>Do we plan to do this?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Sep 14 2023 08:01:04 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">wasm-godot times "from download finish to interactive" which seems like a reasonable metric that likely requires meaningful work</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Sep 14 2023 08:01:53 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Do we plan to do this?</blockquote></mx-reply>It's something I want to experiment with, but we likely don't have resources to do it until H1 24</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Sep 14 2023 08:03:08 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">proxies have an implementation that forwards to the <code>ownKeys</code> handler <a href="https://tc39.es/ecma262/#sec-proxy-object-internal-methods-and-internal-slots-ownpropertykeys">here</a></td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Sep 14 2023 08:03:29 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: It's the [[OwnPropertyKeys]] internal method: <a href="https://tc39.es/ecma262/#table-essential-internal-methods">https://tc39.es/ecma262/#table-essential-internal-methods</a>.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Sep 14 2023 08:04:06 GMT-0700 (Pacific Daylight Time)">15:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: Lazy compilation is a big change to the tiering architecture, and we would need to be careful to not break caching optimized code and peak performance</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Sep 14 2023 08:04:14 GMT-0700 (Pacific Daylight Time)">15:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Thanks! Thus less worry of user-defined cases, but we have to guard against proxies.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Sep 14 2023 08:04:41 GMT-0700 (Pacific Daylight Time)">15:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: right. Do we have any benchmarks that measure peak performance?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Sep 14 2023 08:25:19 GMT-0700 (Pacific Daylight Time)">15:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Thanks! Thus less worry of user-defined cases, but we have to guard against proxies.</blockquote></mx-reply>(if you've not seen it, on the spec page you can hit 'u' on the keyboard to add user-code annotations that (I don't think are perfect) which are intended to highlight possible user code dispatch</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Sep 14 2023 08:29:29 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I did not knew that!</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Sep 14 2023 08:31:41 GMT-0700 (Pacific Daylight Time)">15:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">there is not a lot of different mode when pressing the '?' key.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Sep 14 2023 08:32:14 GMT-0700 (Pacific Daylight Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">It's been added in the last... year let's say; not sure why it's not on by default</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Sep 14 2023 08:48:39 GMT-0700 (Pacific Daylight Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-12">sfink</span>: Does the pretenuring information for an AllocSite get thrown away whenever we collect jitcode?</blockquote></mx-reply><span class="nick-12">denispal</span>: I'm fuzzy on the details. <span class="nick-4">jonco</span>  knows better how AllocSites work with the JIT. There are several types of AllocSites. The ones attached to a bytecode will not be thrown away, but I expect the ones attached to an IC would be. (Or at least, I don't <em>think</em> there's any mechanism where discarded AllocSites donate their data to a "parent" or anything?)</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Sep 14 2023 09:00:41 GMT-0700 (Pacific Daylight Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Ok thanks!  I can put together a rough prototype for a longer cache to see if it helps sp3 at all.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Sep 14 2023 09:04:55 GMT-0700 (Pacific Daylight Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">denispal</span>: yeah the AllocSites for JIT code are owned by the JitScript so if we throw that away we lose the alloc site data</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Sep 14 2023 09:13:25 GMT-0700 (Pacific Daylight Time)">16:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: How do the AllocSites work in the Interpreter and Ion code?  Do we still create them and associate them with some bytecode pc?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Sep 14 2023 09:18:32 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">We only use AllocSites for baseline JIT code (except for a few 'catch-all' sites).  We don't bother collecting this data for code that only runs in the interpreter and we hope that we've figured out the correct heap to use by the time code gets to Ion.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Sep 14 2023 09:21:01 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">Oh I see, so it seems like we'll still consume the AllocSite in Ion <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpOracle.cpp#1248-1255">here</a> but we won't bother updating the alloc counts in Ion?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Sep 14 2023 09:37:54 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">yes we just take the heap we've decided on at that point</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Sep 14 2023 10:05:24 GMT-0700 (Pacific Daylight Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: sorry, had to step away for a bit. Good question, I think that's covered okay in our current CI benchmarks (like embenchen and some of the tests in JS2). But we haven't really looked closely at those benchmarks in several years now, so I don't remember all the details</td></tr>

</tbody></table></div></div></div>
</body></html>