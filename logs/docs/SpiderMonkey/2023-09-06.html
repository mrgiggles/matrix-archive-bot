<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-09-06</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-09-06<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-09-05" class="nav-link"><span>prev</span></a>
<a href="2023-09-07" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Sep 05 2023 17:32:39 GMT-0700 (Pacific Daylight Time)">00:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: yeah, that's messy. I believe that example would end up as a <code>JSFatInlineAtom</code>. The best I can come up with: since there is no such thing as a <code>JSThinInlineAtom</code>, we probably have plenty of excess space in almost all atoms. We could trade 8 bytes for a private pointer, and Gecko could use that to store an external string or the actual DOMString or whatever it is.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Sep 05 2023 17:33:21 GMT-0700 (Pacific Daylight Time)">00:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we actually have 32 unused bits in all atoms (because there's a 64-bit aligned 32-bit hash value), so we have plenty of flag bits if things need to be conditional or whatever.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Sep 05 2023 17:59:44 GMT-0700 (Pacific Daylight Time)">00:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Cool, thanks for the feedback. My takeaway is that the answer to the perf people is "it looks pretty hard". I did not get the impression that it was a big enough bottleneck to justify major heroics, so we will probably shelve the idea.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Sep 06 2023 07:29:33 GMT-0700 (Pacific Daylight Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: Arai's work on <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1848278">extensible permanent atoms</a> might be helpful, though it relies on the embedder knowing the string to be atomized, IIUC.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Sep 06 2023 07:41:54 GMT-0700 (Pacific Daylight Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">maybe we can put the embedding's index (e.g. <a href="https://searchfox.org/mozilla-central/rev/a4cb813cd4026cc24b45e843222e6a08204bae47/xpcom/ds/nsGkAtoms.h#96">mozilla::detail::GkAtoms::Atoms</a> or something that WebIDL binding codegen generates) into <code>JSAtom</code>'s field via the extended permanent atoms' initialization?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Sep 06 2023 08:00:11 GMT-0700 (Pacific Daylight Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">actually, we don't need any field to store the index.  the index is just an offset of given <code>JSAtom</code> pointer within <code>JSAtomState</code> in the above patch stack</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Sep 06 2023 08:02:10 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if gecko has an equivalent list of <code>nsAtom</code>s, the conversion is simple pointer calculation</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Sep 06 2023 08:03:05 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: is there a bug or metabug for it?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Sep 06 2023 08:13:24 GMT-0700 (Pacific Daylight Time)">15:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, I was wrong.  <code>JSAtomState</code> is a struct with pointers, not struct with <code>JSAtom</code> instances, so the pointer itself is not convertible to the index</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Sep 06 2023 08:14:11 GMT-0700 (Pacific Daylight Time)">15:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, we need an index field (14bit or so) inside <code>JSAtom</code>, in order to directly convert it to <code>nsAtom</code></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Sep 06 2023 08:28:00 GMT-0700 (Pacific Daylight Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This particular case is about strings that come from JS source code being passed to the embedding, not strings from the embedding being passed to JS. They aren't permanent atoms.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Sep 06 2023 08:33:42 GMT-0700 (Pacific Daylight Time)">15:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: There's no bug. Markus brought it up in a meeting. He had seen that V8 had the ability to convert strings to external strings in-place, and was wondering how hard it would be for us to implement the same thing. It looks like it's fairly tricky, and it would not have been a huge win.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Sep 06 2023 08:36:07 GMT-0700 (Pacific Daylight Time)">15:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the idea in the bug is to extend the permanent atom with the set of strings provided by gecko.  so, if gecko passes <code>"enter"</code> in the example and some others that they want to quickly convert in the list, they become permanent atoms, and if those strings appears in JS source, they're converted into permanent atoms during instantiation</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Sep 06 2023 08:39:48 GMT-0700 (Pacific Daylight Time)">15:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if we store the index within the list into the permanent <code>JSAtom</code> instance, we can convert it to the index and then convert it into <code>nsAtom</code></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Sep 06 2023 08:43:33 GMT-0700 (Pacific Daylight Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the background of the above bug is to move the atomization from runtime (mainly <a href="https://searchfox.org/mozilla-central/rev/a4cb813cd4026cc24b45e843222e6a08204bae47/dom/bindings/BindingUtils.cpp#1047">mozilla::dom::CreateInterfaceObjects</a>) to compile-time+startup.  the current candidate of the string list is mostly WebIDL propreties, but we could use it also for the parameters if that helps</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Sep 06 2023 08:51:52 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: Ah, I see! That's an interesting idea. I guess it depends on what the distribution of strings is, and how many new permanent atoms we would need to add to get good coverage. I'll ask.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Sep 06 2023 09:42:22 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">if we stored all the permanent atoms in an array, we could subtract the base address to get the index</td></tr>

</tbody></table></div></div></div>
</body></html>