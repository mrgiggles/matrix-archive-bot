<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-12-18</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-12-18<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-12-15" class="nav-link"><span>prev</span></a>
<a href="2023-12-20" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Dec 18 2023 07:55:52 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@mbroadst-5524402c15522ed4b3de8432:gitter.im">mbroadst (Matt Broadstone)</span>&gt;</div></td><td class="msg-cell">Hi, is it possible to capture the last result of a statement executed within a module? <code>JS_ExecuteScript</code> lets you capture the result of script execution, <code>JS::ModuleEvaluate</code> has an out parameter which I think the docs are telling me can be the result of a top-level await but I'm wondering if it's possible for that out parameter to also just be the final result produced during module evaluation?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Dec 18 2023 07:59:57 GMT-0800 (Pacific Standard Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">It's always a promise, as defined in <a href="https://tc39.es/ecma262/#sec-moduleevaluation">https://tc39.es/ecma262/#sec-moduleevaluation</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Dec 18 2023 08:02:58 GMT-0800 (Pacific Standard Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@mbroadst-5524402c15522ed4b3de8432:gitter.im">mbroadst (Matt Broadstone)</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">Ms2ger</span>: thanks for the clarification. In my experiments the promise does not necessarily hold the last produced value, it seems its often <code>undefined</code> though it might hold the last produced value if it was the result of top-level await</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Dec 18 2023 14:04:33 GMT-0800 (Pacific Standard Time)">22:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Oh fuse looks interesting. Nice.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Dec 18 2023 14:31:56 GMT-0800 (Pacific Standard Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Going to be very careful in trying to roll it out, and no guarantees I keep it around if it starts to blow up in our faces, but I agree... could be interesting</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Dec 18 2023 14:32:21 GMT-0800 (Pacific Standard Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Missed opportunity to use blowFuse though</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Dec 18 2023 14:32:38 GMT-0800 (Pacific Standard Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Good luck! I know we wanted something like this for a long time.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Dec 18 2023 14:34:13 GMT-0800 (Pacific Standard Time)">22:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah, I'm glad to have given it a shot. Hopefully in January we'll start reaping benefits. Intentionally landing everything disabled right now so we can see overhead impact (and so I don't have to worry about sec bugs while I'm on vacation for next week and week after) </td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Dec 18 2023 14:42:16 GMT-0800 (Pacific Standard Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">
random thought: I don't know how fuses work, exactly, but would it make sense / be useful to have the jit emit a runtime fuse check in DEBUG builds? If X happened, then this code should have been thrown out and never executed with fuse("X happened")==true.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Dec 18 2023 14:46:49 GMT-0800 (Pacific Standard Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So the design I just landed has each fuse defined with a 'checkInvariant' method; in principle we could definitely run this in JIT builds. 

Right now, all I've landed is what I call 'Guard' fuses; these are ones where consumers much actively check the state of a fuse. A next step would be building 'invalidating' fuses, where scripts can assume the fuse holds and we'd invalidate ion code when the state no longer holds. For sure, in debug builds we should emit an 'assert' node too. </td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Dec 18 2023 14:48:13 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, I see. What's the difference between a Guard fuse and an existing guard that bails out?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Dec 18 2023 14:48:29 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-12" title="@sfink:mozilla.org">sfink</span></div></td><td class="msg-cell">pretends to understand how the JIT works.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Dec 18 2023 14:52:16 GMT-0800 (Pacific Standard Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">so, existing guards are all built out of 'check property A, B, C holds; cool we're done.' 

Fuses say instead "Hey, if A, B or C ever change, we'll pop this fuse". Then, the fuses are also changed together, so that when one pops, it can pop 'downstream' ones as well. The end result being that we can replace a bunch of 'check this has this shape, check this has this proto, check the proto of that has this shape, ...' code with "check things are still kosher for this optimization", replacing all that walking and checking code with a single address load</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Dec 18 2023 14:53:51 GMT-0800 (Pacific Standard Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">The idea in general is that a fuse asserts some property of the {realm,runtime}, and we can use that to infer other things, rather than actively checking</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Dec 18 2023 14:54:30 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah! so a guard is a firecracker, and a fuse weaves together the... well, fuses of several firecrackers. Which is not the metaphor for "fuse" you were using. Forget I said it.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Dec 18 2023 14:54:45 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So one fuse I'm also prototyping is the 'HasSeenObjectEmulatesUndefined' fuse, which hopefully will allow us to stop constantly having to do the IsHTMLDDA checks, and only do them if we've ever actually seen anyone call <code>document.all</code></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Dec 18 2023 14:55:03 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">makes sense. Nice!</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Dec 18 2023 14:55:35 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(no, seriously, I have many doubts about the fuse metaphor; v8 calls this concept Protectors, and JSC calls them Watchpoints. and honestly, both those names are probably better) </td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Dec 18 2023 14:56:30 GMT-0800 (Pacific Standard Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">the major alignment of metaphor is that a fuse is one way -- once it pops, we provide no ability to 'un-pop' it, as it's designed to handle one-way transitions in the state of the VM</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Dec 18 2023 14:58:06 GMT-0800 (Pacific Standard Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, that's what I had been assuming all along. The fuse metaphor works for me.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Dec 18 2023 14:59:39 GMT-0800 (Pacific Standard Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Well. The important thing will be to see if this infrastructure patch stack pops 1) any fuzz bugs, as I've rigged the infrastructure up for fuzzability as best I can 2) any perf alerts. While we're willing to take a very small overhead to maintain these invariants, it should be small overhead. </td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Dec 18 2023 15:00:38 GMT-0800 (Pacific Standard Time)">23:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">But. I must run. talk to all later :) </td></tr>

</tbody></table></div></div></div>
</body></html>