<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-02-01</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-02-01<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-01-31" class="nav-link"><span>prev</span></a>
<a href="2023-02-02" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Feb 01 2023 03:40:43 GMT-0800 (Pacific Standard Time)">11:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: do we have telemetry data about how often we run shrinking GC?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Feb 01 2023 03:40:51 GMT-0800 (Pacific Standard Time)">11:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">compacting, whatever it is called ðŸ™‚</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Feb 01 2023 03:43:54 GMT-0800 (Pacific Standard Time)">11:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: no, not directly, although you can work it out from looking at GC_REASON_2 telemetry</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Feb 01 2023 03:44:30 GMT-0800 (Pacific Standard Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">only some reasons are used with compacting: mainly USER_INACTIVE and MEM_PRESSURE from memory</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Feb 01 2023 03:47:37 GMT-0800 (Pacific Standard Time)">11:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">thanks.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Feb 01 2023 03:48:04 GMT-0800 (Pacific Standard Time)">11:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'm just playing a bit with mozjemalloc and its mMaxDirty and Purge.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Feb 01 2023 03:48:57 GMT-0800 (Pacific Standard Time)">11:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">We seem to have very tiny page cache for arenas</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Feb 01 2023 03:49:45 GMT-0800 (Pacific Standard Time)">11:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">and I was wondering if we could have larger, but purge when doing shrinking GC or something</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Feb 01 2023 03:53:58 GMT-0800 (Pacific Standard Time)">11:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">Yes it makes sense to adjust this.  The way the GC frees unused chunks is more aggressive than that - it normally frees unused chunks down to the 'max free chunk' parameter but has a mode when GCs are happening frequently where that is skipped.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Feb 01 2023 03:55:01 GMT-0800 (Pacific Standard Time)">11:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I did a test with massive caches: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1805644#c16">https://bugzilla.mozilla.org/show_bug.cgi?id=1805644#c16</a> Obviously totally unrealistic, but something to investigate more.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Feb 01 2023 04:32:58 GMT-0800 (Pacific Standard Time)">12:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">wow that's a pretty big improvement across the board</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Feb 01 2023 05:16:35 GMT-0800 (Pacific Standard Time)">13:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@caleb.distributive:mozilla.org">caleb.distributive</span>&gt;</div></td><td class="msg-cell"><p>Was planning on doing this, but ran into (what I assume is) the same or similar issue. I've pulled the repo, built spidermonkey with "mach build", ran "make install", linked the .so and headers, and compiled my project. When I run the project I get "undefined symbol: _ZN7mozilla6detail23InvalidArrayIndex_CRASHEmm". Looking through the mozilla codebase, I see mozilla::detail::InvalidArrayIndex_CRASH is declared in mfbt/Assertions.h, and defined in mfbt/Assertions.cpp, and it has the MFBT_API annotation (which seems to expand to the same thing that JS_PUBLIC_API expands to). What am I doing wrong? I've managed to prune my code to just the below snippet while getting the same problem.</p>
<pre><code>static JSContext *cx;
static JS::RootedObject *global;

if (!JS_Init())
    return NULL;

  cx = JS_NewContext(JS::DefaultHeapMaxBytes);
  if (!cx)
    return NULL;

  if (!JS::InitSelfHostedCode(cx))
    return NULL;

  JS::RealmOptions options;
  static JSClass globalClass = {"global", JSCLASS_GLOBAL_FLAGS, &amp;JS::DefaultGlobalClassOps};
  global = new JS::RootedObject(cx, JS_NewGlobalObject(cx, &amp;globalClass, nullptr, JS::FireOnNewGlobalHook, options));
  if (!global)
    return NULL;
</code></pre>
</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Feb 01 2023 05:19:01 GMT-0800 (Pacific Standard Time)">13:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">Hi, how can I build this job: <a href="https://treeherder.mozilla.org/jobs?repo=try&amp;author=paul%40paul.cx&amp;selectedTaskRun=Pn6MA0LWRW2_W9f_DU3yYw.0">https://treeherder.mozilla.org/jobs?repo=try&amp;author=paul%40paul.cx&amp;selectedTaskRun=Pn6MA0LWRW2_W9f_DU3yYw.0</a> ? it's something js-shell related, and seem to use gcc, that has different compilation option it seems like </td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Feb 01 2023 05:26:06 GMT-0800 (Pacific Standard Time)">13:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">or understand the compilation flags in use</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Feb 01 2023 05:35:06 GMT-0800 (Pacific Standard Time)">13:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">huh nevermind this is using gcc 7.5, this is the problem</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Feb 01 2023 06:18:59 GMT-0800 (Pacific Standard Time)">14:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">caleb.distributive</span>: I think the issue with the <code>./mach build</code> is that this will add a local attribute to the symbol, see <a href="https://searchfox.org/mozilla-central/source/mfbt/Types.h#98">https://searchfox.org/mozilla-central/source/mfbt/Types.h#98</a> linking hence fails.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Feb 01 2023 08:47:34 GMT-0800 (Pacific Standard Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: ping</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Feb 01 2023 08:47:47 GMT-0800 (Pacific Standard Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">sorry, trying to get in, having trouble</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Feb 01 2023 09:03:19 GMT-0800 (Pacific Standard Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Is it bad for a JsContext to have multiple globals?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Feb 01 2023 09:09:41 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">e.g. hundreds of globals</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Feb 01 2023 09:11:21 GMT-0800 (Pacific Standard Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> e.g. hundreds of globals</blockquote></mx-reply>Certainly would be a stress test, and I could imagine it makes it more likely you'll run into something unexpected, but I don't think there's anything that we know would explicitly break...</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Feb 01 2023 09:12:16 GMT-0800 (Pacific Standard Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">mgaudet</span>: I tried applying your patch and it does help; however hit counts are limited to the first line per function. Do you have a general idea which function I'll need to change such that I'll get hit counts for each line?</blockquote></mx-reply>Sorry I dropped the ball here -- will try to take a look in a bit (perhaps best to file a bug so we can keep track of this)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Feb 01 2023 09:30:19 GMT-0800 (Pacific Standard Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> e.g. hundreds of globals</blockquote></mx-reply>Firefox has moved away from this. We used to have a lot more globals before Fission, but now they're split out across a bunch of processes. So you'd be pushing the opposite edge, so to speak, but as <span class="nick-2">mgaudet</span> says there's nothing fundamentally wrong or unsupported.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Feb 01 2023 09:31:23 GMT-0800 (Pacific Standard Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it will make a difference whether they're in the same compartment, and whether they're in the same Zone.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Feb 01 2023 10:03:03 GMT-0800 (Pacific Standard Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I got it to work (for my purposes), it just felt weird answering my own question. the issue seems to be that <code>ShouldSuppressBreakpointsAndSourceNotes</code> filters the selfhosted scripts and due to missing source notes hitcounts have no line information</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Feb 01 2023 10:23:40 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">I'm currently working on the JS Compute Runtime at Fastly, and running some prototypes with using ES modules. Currently finding that somehow the top-level let bindings in a module aren't being defined, as if the execution isn't completing. I'm running the steps from <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr102/examples/modules.cpp">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr102/examples/modules.cpp</a>. There's no errors, I'm running <code>RunJobs</code>. Wondering if this is something to do with the generator execution model not covered there, or something else?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Feb 01 2023 10:25:23 GMT-0800 (Pacific Standard Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">(I basically just changed ModuleInstantiate to ModuleLink, but perhaps there are more top-level await changes not covered?)</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Feb 01 2023 10:39:57 GMT-0800 (Pacific Standard Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">^ turned out the above was an exception, but I somehow wasn't finding when checking for a pending exception</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Feb 01 2023 10:48:20 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">I'm unclear on how ModuleEvaluate will succeed and there is no pending exception, when there is an evaluation error though</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Feb 01 2023 11:41:03 GMT-0800 (Pacific Standard Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Does anyone know of a straightforward way to determine if a JS object is an exception, using the mozjs api?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Feb 01 2023 11:47:44 GMT-0800 (Pacific Standard Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Or maybe a more general question: How can I determine if an object has a prototype that corresponds with a JSProtoKey</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Feb 01 2023 12:20:03 GMT-0800 (Pacific Standard Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>:  An exception can be an arbitrary object (<code>try { throw "hi"; } catch (e) { print(e); } </code>) -- or are you looking for a specific <code>Error</code> type?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Feb 01 2023 12:21:31 GMT-0800 (Pacific Standard Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm unclear on how ModuleEvaluate will succeed and there is no pending exception, when there is an evaluation error though</blockquote></mx-reply>ModuleEvaluate is <a href="https://tc39.es/ecma262/#sec-moduleevaluation">this part of the spec</a>, which returns a promise. Mostly when a promise returning method fails, that is indicated by a rejected promise, not by failing the actual method which returns the promise</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Feb 01 2023 12:30:59 GMT-0800 (Pacific Standard Time)">20:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">kfjvj</span>:  An exception can be an arbitrary object (<code>try { throw "hi"; } catch (e) { print(e); } </code>) -- or are you looking for a specific <code>Error</code> type?</blockquote></mx-reply>(I don't think we have a good method here tho)</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Feb 01 2023 12:31:40 GMT-0800 (Pacific Standard Time)">20:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">mgaudet</span>: I got it to work (for my purposes), it just felt weird answering my own question. the issue seems to be that <code>ShouldSuppressBreakpointsAndSourceNotes</code> filters the selfhosted scripts and due to missing source notes hitcounts have no line information</blockquote></mx-reply>Good to answer your own question :) glad you got it working sufficiently.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Feb 01 2023 13:16:58 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: can you file a blocking bug for the gc android scheduling so that it doesn't get lost in the top-level bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1810550#c9">https://bugzilla.mozilla.org/show_bug.cgi?id=1810550#c9</a></td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Feb 01 2023 13:20:29 GMT-0800 (Pacific Standard Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> ModuleEvaluate is <a href="https://tc39.es/ecma262/#sec-moduleevaluation">this part of the spec</a>, which returns a promise. Mostly when a promise returning method fails, that is indicated by a rejected promise, not by failing the actual method which returns the promise</blockquote></mx-reply><p>I did explicitly work on this part of the spec so should strictly know that I guess :) But I suppose I was expecting synchronous evaluation errors to throw into the surrounding context. Thank you this likely answers my issue.</p>
<p>It could be worth updating the embedding examples repo as well for the new TLA APIs.</p>
</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Feb 01 2023 13:29:12 GMT-0800 (Pacific Standard Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Is there a trick to using JS::RootedObject with lambda captures and <code>std::future</code>? Or am I supposed to use <code>JS::HeapObject</code> instead?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Feb 01 2023 13:31:03 GMT-0800 (Pacific Standard Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: Instances of Rooted&lt;T&gt; have to live on the stack and be freed in LIFO order. That's not compatible with lambdas or futures.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Feb 01 2023 13:32:24 GMT-0800 (Pacific Standard Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Remember that if you use HeapObject you are responsible for ensuring that your pointers get traced during garbage collection.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Feb 01 2023 13:54:23 GMT-0800 (Pacific Standard Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>What happens if you create a <code>JS::RootedObject</code> inside a conversion function and return a <code>JS::Value</code> of that? Like</p>
<pre><code class="language-c++">JS::Value convert(JSContext* ctx, SomeType inValue) {
  JS::RootedValue ret(ctx);
...
  return ret;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Feb 01 2023 13:56:24 GMT-0800 (Pacific Standard Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Well, in this case you never initialize the value, so you probably get back <code>UndefinedValue</code></td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Feb 01 2023 13:56:40 GMT-0800 (Pacific Standard Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But in general, you get back an unrooted value</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Feb 01 2023 13:56:46 GMT-0800 (Pacific Standard Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Because Rooted is an RAII type</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Feb 01 2023 13:56:56 GMT-0800 (Pacific Standard Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So when the RootedValue goes out of scope, we unroot the value</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Feb 01 2023 13:58:13 GMT-0800 (Pacific Standard Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There are no magic wands here to get around the fact that the GC needs to know where live GC pointers are, and how to tell if they're alive / update them if the thing they're pointing at moves</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Feb 01 2023 13:58:42 GMT-0800 (Pacific Standard Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And that's going to involve some plumbing</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Feb 01 2023 13:58:53 GMT-0800 (Pacific Standard Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">What does unrooting the value really mean? Couldn't I just re-root it in the above call stack?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Feb 01 2023 13:59:04 GMT-0800 (Pacific Standard Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yep!</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Feb 01 2023 13:59:18 GMT-0800 (Pacific Standard Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Or am I accessing dangerous dead memory when looking at <code>JS::Value</code>?</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Feb 01 2023 13:59:56 GMT-0800 (Pacific Standard Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You have to ensure it is rooted before calling anything that could trigger a garbage collection</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Feb 01 2023 14:00:20 GMT-0800 (Pacific Standard Time)">22:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(Depending on use case, you may be well served by a JS::PersistentRooted that works for non-lifo lifetimes) </td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Feb 01 2023 14:00:48 GMT-0800 (Pacific Standard Time)">22:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Because if you are holding a raw JS::Value, and trigger a GC, then the garbage collector could move the thing that the JS::Value points to</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Feb 01 2023 14:00:59 GMT-0800 (Pacific Standard Time)">22:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And since it's unrooted, the GC doesn't know to go update your pointer</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Feb 01 2023 14:01:10 GMT-0800 (Pacific Standard Time)">22:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: What if I did<br><code>JS::RootedObject myObj(ctx, convert(ctx));</code></td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Feb 01 2023 14:01:42 GMT-0800 (Pacific Standard Time)">22:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">PersistentRooted solves the problem by saying "this pointer is always alive while the object containing it exists"</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Feb 01 2023 14:02:26 GMT-0800 (Pacific Standard Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which is fine until you have a cycle and leak memory</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Feb 01 2023 14:03:05 GMT-0800 (Pacific Standard Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-4">iain</span>: What if I did<br><code>JS::RootedObject myObj(ctx, convert(ctx));</code></blockquote></mx-reply>Then you have a rooted object in your current stack frame</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Feb 01 2023 14:03:43 GMT-0800 (Pacific Standard Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So you can use that object freely, for as long as this stack frame exists, and the GC will not collect your object, and will update the root if it decides to move your object</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Feb 01 2023 14:05:05 GMT-0800 (Pacific Standard Time)">22:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(There is a weird hole about what happens if you return a raw value, and then a destructor runs and triggers a GC before you get a chance to reroot the return value in the parent frame. The answer is: don't write destructors that can trigger a GC)</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Feb 01 2023 14:05:24 GMT-0800 (Pacific Standard Time)">22:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Even if myObj is initialized off a JS::RootedObject inside <code>convert</code> function where it fell off the stack/scope? Shouldn't this have triggered GC as well?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Feb 01 2023 14:06:31 GMT-0800 (Pacific Standard Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Filed bug 1814510</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Feb 01 2023 14:06:32 GMT-0800 (Pacific Standard Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">GC is (roughly speaking) triggered when we try to allocate memory and don't have any available</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Feb 01 2023 14:06:33 GMT-0800 (Pacific Standard Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1814510">https://bugzil.la/1814510</a> â€” NEW (nobody) â€” GC scheduler should not treat Android background idle time as idle time</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Feb 01 2023 14:06:50 GMT-0800 (Pacific Standard Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Returning from a function won't trigger a GC</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Feb 01 2023 14:07:48 GMT-0800 (Pacific Standard Time)">22:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I did explicitly work on this part of the spec so should strictly know that I guess :) But I suppose I was expecting synchronous evaluation errors to throw into the surrounding context. Thank you this likely answers my issue.</p>
<p>It could be worth updating the embedding examples repo as well for the new TLA APIs.</p>
</blockquote></mx-reply><p>To follow up on this, it turns out you need to explicitly do an error check along the lines of:</p>
<pre><code>    JS::Rooted&lt;JSObject*&gt; eval_promise(CX);
    eval_promise.set(&amp;rval.toObject());
    if (JS::ThrowOnModuleEvaluationFailure(CX, eval_promise, JS::ModuleErrorBehaviour::ThrowModuleErrorsSync)) {
</code></pre>
<p>in order to get the top-level evaluation error thrown synchronously</p>
</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Feb 01 2023 14:07:49 GMT-0800 (Pacific Standard Time)">22:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: thanks! It isn't urgent, we just don't want to lose it. The other areas around setTimeout will be tried first </td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Feb 01 2023 14:08:43 GMT-0800 (Pacific Standard Time)">22:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Thank you <span class="nick-4">iain</span> , I'll get back to you tomorrow on this</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Feb 01 2023 14:09:47 GMT-0800 (Pacific Standard Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">generally speaking, it's totally fine to return unrooted pointers from functions. As long as the caller puts it someplace safe before doing anything interesting (as in, anything that could GC), that's the way you're expected to do things.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Feb 01 2023 14:10:25 GMT-0800 (Pacific Standard Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>To follow up on this, it turns out you need to explicitly do an error check along the lines of:</p>
<pre><code>    JS::Rooted&lt;JSObject*&gt; eval_promise(CX);
    eval_promise.set(&amp;rval.toObject());
    if (JS::ThrowOnModuleEvaluationFailure(CX, eval_promise, JS::ModuleErrorBehaviour::ThrowModuleErrorsSync)) {
</code></pre>
<p>in order to get the top-level evaluation error thrown synchronously</p>
</blockquote></mx-reply>Nice -- glad to hear you figured that out</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Feb 01 2023 14:11:07 GMT-0800 (Pacific Standard Time)">22:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and it's not that uncommon to want to be able to GC in a destructor. If it causes trouble, we'll usually use an outparam in the form of a <code>MutableHandle&lt;JSObject*&gt;</code> or whatever.</td></tr>

</tbody></table></div></div></div>
</body></html>