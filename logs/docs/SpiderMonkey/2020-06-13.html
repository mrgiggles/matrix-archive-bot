<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2020-06-13</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2020-06-13<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2020-06-12" class="nav-link"><span>prev</span></a>
<a href="2020-06-14" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Jun 12 2020 17:44:21 GMT-0700 (Pacific Daylight Time)">00:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@froydnj:mozilla.org">froydnj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I resemble that comment</blockquote></mx-reply>so say we all</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Jun 12 2020 19:03:27 GMT-0700 (Pacific Daylight Time)">02:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@crazypython:mozilla.org">crazypython</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p><span class="nick-13">crazypython</span>: I'm guessing 0AD again? <span class="nick-8">shawnjohnjr</span> was going to file a related bug, not that I was really able to come up with much for them.</p>
</blockquote>
<p>no, different open-source game. I've skimmed the hacking tips on the jsshell, surely there's a way to trigger a nursery collection, and <em>surely</em> there is a series of commands I can use to get unreachable objects?</p>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Jun 12 2020 20:11:19 GMT-0700 (Pacific Daylight Time)">03:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the JS shell has a minorgc() test function for the first. You'd need to either expose your own, or it's part of the test function collection if you've called js::DefineTestingFunctions() at some point.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Jun 12 2020 20:12:53 GMT-0700 (Pacific Daylight Time)">03:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">For the second, no, nothing exposes unreachable objects.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Jun 12 2020 20:14:39 GMT-0700 (Pacific Daylight Time)">03:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">necromancy is a dangerous game</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Jun 12 2020 20:19:52 GMT-0700 (Pacific Daylight Time)">03:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">let's see... you'd need to do it after marking but before sweeping or finalizing anything. It would be interesting to have a mode where you never actually collect anything, just pile everything into a deadStuff list. I imagine something would break, but I'm not sure what. Some of the objects would be internal objects.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Jun 12 2020 20:28:13 GMT-0700 (Pacific Daylight Time)">03:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@crazypython:mozilla.org">crazypython</span>&gt;</div></td><td class="msg-cell">Hmmm. Is there 1)  a mode that calls finalizers backed by FinalizationRegistry immediately after sweeping 2) a thing that calls a function for every created object?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Jun 12 2020 21:16:03 GMT-0700 (Pacific Daylight Time)">04:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><ol>
<li>no 2) not exactly. There is an "object metadata builder" that will capture a stack for allocated objects. It looks like it supports sampling some percentage.</li>
</ol>
</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Jun 12 2020 21:16:50 GMT-0700 (Pacific Daylight Time)">04:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in the shell, it looks like you access it with <code>enableShellAllocationMetadataBuilder()</code> and then <code>getAllocationMetadata(obj)</code> -- so it's still only going to work for live objects.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Jun 12 2020 21:17:32 GMT-0700 (Pacific Daylight Time)">04:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(oh, and I know one reason why exposing all dead objects would be problematic -- it would expose ones that were partly initialized and then discarded, so you'd probably end up crashing if you iterated over all of them to histogram them or something)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Jun 12 2020 21:19:40 GMT-0700 (Pacific Daylight Time)">04:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://developer.mozilla.org/en-US/docs/Tools/Debugger-API/Debugger.Memory">https://developer.mozilla.org/en-US/docs/Tools/Debugger-API/Debugger.Memory</a> looks like the real user of it. That sounds promising.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Jun 12 2020 21:22:03 GMT-0700 (Pacific Daylight Time)">04:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it seems like we ought to be able to provide <em>something</em> to embedders for identifying leaks or excessive allocation.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Jun 12 2020 21:22:07 GMT-0700 (Pacific Daylight Time)">04:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but for now, it's my bedtime</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Jun 12 2020 21:24:02 GMT-0700 (Pacific Daylight Time)">04:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@rockon999:matrix.org">rockon999</span>&gt;</div></td><td class="msg-cell">ptomato gjs has work on detecting leaks and generating heap graphs, the latter was andyholmes work I believe?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sat Jun 13 2020 07:08:33 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@crazypython:mozilla.org">crazypython</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>:  If I could get a callback on every object I could store a weakref to everything, then call minorgc(), then fork the process, then trigger major gc (How?) and check which indices.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sat Jun 13 2020 07:42:42 GMT-0700 (Pacific Daylight Time)">14:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">crazypython</span>: there's really no way to hook things at that level in a way that would allow executing JS code. Ignoring the infinite loop from the objects allocated during weakref registration, which is fixable by filtering them out, many objects are allocated at internal points that can't just suspend and resume well enough to run JS code.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sat Jun 13 2020 07:43:05 GMT-0700 (Pacific Daylight Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think the basic idea of recording things before they're dead, and then identifying which ones are gone later, is good.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sat Jun 13 2020 07:43:25 GMT-0700 (Pacific Daylight Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but I think that's what the Debugger.Memory stuff does (?)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sat Jun 13 2020 07:43:42 GMT-0700 (Pacific Daylight Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or you could do it manually by dumping the entire heap and doing some sort of diff</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sat Jun 13 2020 07:43:54 GMT-0700 (Pacific Daylight Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">see dumpHeap() in the shell</td></tr>

</tbody></table></div></div></div>
</body></html>