<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-11-16</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-11-16<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-11-15" class="nav-link"><span>prev</span></a>
<a href="2022-11-17" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Nov 15 2022 22:18:54 GMT-0800 (Pacific Standard Time)">06:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">ewang21</span>: <a href="https://searchfox.org/mozilla-central/rev/d7d2cc647772de15c4c5aa47f74d25d0e379e404/js/public/GCAPI.h#1222-1223"><code>JS_SetGCParameter</code></a> can set GC behavior.  See <a href="https://searchfox.org/mozilla-central/rev/d7d2cc647772de15c4c5aa47f74d25d0e379e404/js/public/GCAPI.h#69"><code>JSGCParamKey</code></a> for parameters</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Nov 16 2022 00:13:06 GMT-0800 (Pacific Standard Time)">08:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>has anyone experienced <code>JSRuntime</code> leak in reftest?  I'm looking into the failure that:</p>
<ul>
<li><a href="https://treeherder.mozilla.org/jobs?repo=try&amp;revision=4396f720d77a91bf170905221be6aa15f33feb13">happens with my patch, on automation</a></li>
<li><a href="https://treeherder.mozilla.org/jobs?repo=try&amp;revision=53b8da707b04409db923897c51aa273beb3c215c">doesn't happen without my patch on automation</a></li>
<li>happens without my patch locally</li>
</ul>
<p>and wondering if it's pre-existing issue or not</p>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Nov 16 2022 02:30:48 GMT-0800 (Pacific Standard Time)">10:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@luyahan:mozilla.org">luyahan</span>&gt;</div></td><td class="msg-cell">done</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Nov 16 2022 03:42:19 GMT-0800 (Pacific Standard Time)">11:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">luyahan</span>: Thanks for writing it, I will raise this submission in our next team meeting.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Nov 16 2022 07:05:55 GMT-0800 (Pacific Standard Time)">15:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>has anyone experienced <code>JSRuntime</code> leak in reftest?  I'm looking into the failure that:</p>
<ul>
<li><a href="https://treeherder.mozilla.org/jobs?repo=try&amp;revision=4396f720d77a91bf170905221be6aa15f33feb13">happens with my patch, on automation</a></li>
<li><a href="https://treeherder.mozilla.org/jobs?repo=try&amp;revision=53b8da707b04409db923897c51aa273beb3c215c">doesn't happen without my patch on automation</a></li>
<li>happens without my patch locally</li>
</ul>
<p>and wondering if it's pre-existing issue or not</p>
</blockquote></mx-reply>FWIW that's probably just a regular leak. We don't do leak checking in reftests so that'll be the only sign of it.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Nov 16 2022 07:07:33 GMT-0800 (Pacific Standard Time)">15:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Well, not all leaks will leak a runtime, I suppose.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Nov 16 2022 07:47:57 GMT-0800 (Pacific Standard Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: what do you mean by regular leak?  reftest is supposed to leak?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Nov 16 2022 07:55:20 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">No, I just meant that that is a sign of a leak, and you won't get the usual leakcheck failures.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Nov 16 2022 07:55:55 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">It is possible there is an existing leak that your change is turning into a runtime leak that is an assert but it is hard to guess whether that's really what is going on or not.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Nov 16 2022 08:03:34 GMT-0800 (Pacific Standard Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I see. I'll continue investigating the details</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Nov 16 2022 08:09:38 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Looks like there's also an assertion failure.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Nov 16 2022 08:27:09 GMT-0800 (Pacific Standard Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, the assertion failure seems to be caused by the runtime leak</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Nov 16 2022 08:27:33 GMT-0800 (Pacific Standard Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's self-hosted JS's file name string getting freed while there's still a reference, possibly from the leaked runtime</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Nov 16 2022 08:33:04 GMT-0800 (Pacific Standard Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">How exactly does <code>PropertyKey</code> work on 32b platforms? there's no spare bits for symbol or string pointers, and the tags in total use 4 bits</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Nov 16 2022 08:33:18 GMT-0800 (Pacific Standard Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, just realized that the leak happens even without patch on automation. just that it's not treated as job failure <a href="https://treeherder.mozilla.org/jobs?repo=try&amp;revision=53b8da707b04409db923897c51aa273beb3c215c&amp;selectedTaskRun=SBDFdP9wSBaEUmiLraUJnA.0">https://treeherder.mozilla.org/jobs?repo=try&amp;revision=53b8da707b04409db923897c51aa273beb3c215c&amp;selectedTaskRun=SBDFdP9wSBaEUmiLraUJnA.0</a></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Nov 16 2022 08:34:40 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, the leak itself isn't a problem (at least not my patch's problem)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Nov 16 2022 08:35:10 GMT-0800 (Pacific Standard Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Redfire</span>: There are <a href="https://searchfox.org/mozilla-central/source/js/public/Id.h#56">three tag bits</a>. We guarantee that everything is allocated with 8-byte alignment, and tag the low bits.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Nov 16 2022 08:36:17 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I just need to figure out what to do when runtime lives longer than JS_Shutdown</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Nov 16 2022 08:37:41 GMT-0800 (Pacific Standard Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>:  Oh, it's the low bits. I didn't see that one coming. I hadn't even considered abusing alignment for tagging on a pointer</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Nov 16 2022 08:38:21 GMT-0800 (Pacific Standard Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We do all sorts of code crimes here</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Nov 16 2022 08:39:10 GMT-0800 (Pacific Standard Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">All in the name of optimisation 😛</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Nov 16 2022 08:39:44 GMT-0800 (Pacific Standard Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@ms2ger:igalia.com">Ms2ger 💉💉💉</span>&gt;</div></td><td class="msg-cell">I thought the main goal was giving the c++ committee nightmares</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Nov 16 2022 08:40:29 GMT-0800 (Pacific Standard Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I was working on adding the  PropertyKey methods on the rust wrapper, which is why I was even looking at this</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Nov 16 2022 08:41:33 GMT-0800 (Pacific Standard Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We used to have some functions that were called with low bits tagged in the <code>this</code> pointer, but we managed to get rid of that nonsense</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Nov 16 2022 08:47:31 GMT-0800 (Pacific Standard Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(<a href="https://searchfox.org/mozilla-esr78/source/js/src/vm/TypeSet.h#282">https://searchfox.org/mozilla-esr78/source/js/src/vm/TypeSet.h#282</a>)</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Nov 16 2022 11:02:01 GMT-0800 (Pacific Standard Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> We do all sorts of code crimes here</blockquote></mx-reply>This should be a sticker or a shirt 😄</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Nov 16 2022 11:02:51 GMT-0800 (Pacific Standard Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">"SpiderMonkey: Purveyors of Fine Code Crimes since 1996"</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Nov 16 2022 11:06:26 GMT-0800 (Pacific Standard Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: halp! I keep trying to write a comment on <a href="https://phabricator.services.mozilla.com/D161962#5325327">the phab rev for AddAndStoreSlot prebarriering removal</a>, and I keep realizing I'm misunderstanding what's going on. Are you around for a quick <a href="https://mozilla.zoom.us/my/sfink">zoom call</a>?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Nov 16 2022 11:22:44 GMT-0800 (Pacific Standard Time)">19:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I'm working with C++ exceptions, and I would like to know what would be the best way to store info about the JS object that caused the exception.  I'd like to include a reference to the object in the exception, but I'm not sure how that would affect rooting.  My first thought was to use persistentrooted, but I'm not sure if that's a good idea.  Thoughts?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Nov 16 2022 11:25:27 GMT-0800 (Pacific Standard Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Concept art: </td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Nov 16 2022 11:32:21 GMT-0800 (Pacific Standard Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: if the lifetime of the C++ exception is short, then <code>PersistentRooted</code> makes sense to me.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Nov 16 2022 11:32:26 GMT-0800 (Pacific Standard Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">But I guess the way I would assume exceptions would work is that any JSNative would execute in a try block to catch exceptions, and then the C++ exception would be wrapped into a JS <code>ErrorObject</code> that would be thrown by the JSNative (as in, it would be set as the pending exception on the cx, and then the JSNative would return false.) In that case, you would have an ErrorObject pointing to a C++ exception object of some sort, which points to your JS object that somehow caused the problem. A PersistentRooted in that C++ exception object would then hold the JS object alive which would hold the global alive. If there is any way to reach that ErrorObject from the global, then you'd have an uncollectable cycle.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Nov 16 2022 11:33:30 GMT-0800 (Pacific Standard Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if that is at all possible, then it would be better for your c++ exception object to store the detail object in a <code>Heap&lt;JSObject*&gt;</code> and have a <code>trace()</code> method that your <code>ErrorObject</code> would invoke.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Nov 16 2022 11:33:44 GMT-0800 (Pacific Standard Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(I'm handwaving here.)</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Nov 16 2022 11:52:30 GMT-0800 (Pacific Standard Time)">19:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Thanks.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Nov 16 2022 12:16:51 GMT-0800 (Pacific Standard Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-7">ewang21</span>: <a href="https://searchfox.org/mozilla-central/rev/d7d2cc647772de15c4c5aa47f74d25d0e379e404/js/public/GCAPI.h#1222-1223"><code>JS_SetGCParameter</code></a> can set GC behavior.  See <a href="https://searchfox.org/mozilla-central/rev/d7d2cc647772de15c4c5aa47f74d25d0e379e404/js/public/GCAPI.h#69"><code>JSGCParamKey</code></a> for parameters</blockquote></mx-reply>Thank you very much!</td></tr>

</tbody></table></div></div></div>
</body></html>