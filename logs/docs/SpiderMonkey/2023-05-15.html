<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-05-15</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-05-15<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-05-12" class="nav-link"><span>prev</span></a>
<a href="2023-05-16" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon May 15 2023 05:24:18 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">If two objects each store a <code>Heap&lt;JSObject*&gt;</code> with the other object and trace it in their trace hooks, does that cause a memory leak or something?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon May 15 2023 05:24:48 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Particularly I'm implementing URLSearchParams currently, in which URL needs to store the former and the former needs to store URL to access it</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon May 15 2023 05:51:41 GMT-0700 (Pacific Daylight Time)">12:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">They will be gced if they are unreachable from anywhere else</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon May 15 2023 06:13:18 GMT-0700 (Pacific Daylight Time)">13:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Yet again the GC is smarter than I gave it credit.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon May 15 2023 06:13:36 GMT-0700 (Pacific Daylight Time)">13:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Didn't realise it accounted for cylic dependencies </td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon May 15 2023 07:50:02 GMT-0700 (Pacific Daylight Time)">14:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">It won't work if the cycle goes through C++, but a pure JS cycle should be fine. (In Firefox, we have a separate GC-ish thing called the cycle collector to deal with cycles through C++ and JS.)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon May 15 2023 08:10:01 GMT-0700 (Pacific Daylight Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">uhh it goes through C++, both in private values in reserved slots and traced with trace hooks</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon May 15 2023 08:28:55 GMT-0700 (Pacific Daylight Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> uhh it goes through C++, both in private values in reserved slots and traced with trace hooks</blockquote></mx-reply>Ah. If you are implementing this in Firefox, you'll need to make your C++ classes participate in cycle collection. <a href="https://firefox-source-docs.mozilla.org/xpcom/cc-macros.html">https://firefox-source-docs.mozilla.org/xpcom/cc-macros.html</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon May 15 2023 09:01:28 GMT-0700 (Pacific Daylight Time)">16:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Not in Firefox, and its in rust too so technically doesn't apply ðŸ˜­</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon May 15 2023 09:02:03 GMT-0700 (Pacific Daylight Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">What's the solution then?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon May 15 2023 09:06:52 GMT-0700 (Pacific Daylight Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> What's the solution then?</blockquote></mx-reply>The solution is either to never have cycles go through non-JS (I think Servo does this by always having JS reflectors and having ownership only apply to the reflectors?) or to break the cycles yourself, which is going to be difficult in general.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon May 15 2023 09:08:35 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-rs">pub struct URL {
	url: Url,
	heap: Box&lt;Heap&lt;*mut JSObject&gt;&gt;, // URLSearchParams
}
pub struct URLSearchParams {
	url: *mut Url,
 	heap: Box&lt;Heap&lt;*mut JSObject&gt;&gt;, // URL
}
</code></pre>
<p>Basically the structure I'm working with, each of these structs is stored in the reserved slot as a private value.</p>
</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon May 15 2023 09:10:45 GMT-0700 (Pacific Daylight Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I guess I could do an <code>Rc&lt;RefCell&lt;Url&gt;&gt;</code> so it wouldn't kill itself unnecessarily</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon May 15 2023 09:50:38 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>I know that <code>undefined</code> is a binding in JS -- so you can construct a shadowing. As well, I know <code>undefined</code> if not shadowed lives in the global lexical environment. Some comments suggest further that the global lexical environment is mutable; but I can't figure out -how- to actually mutate the <code>undefined</code> binding.</p>
<p>Essentially, what I'm trying to figure out is how it would be observable if instead of doing a <code>GetGName 'undefined'</code> (assuming no shadowing) we instead just pushed the op <code>Undefined</code></p>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon May 15 2023 10:38:05 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: The trick I used when <a href="https://phabricator.services.mozilla.com/D170962">testing generation counts for global variables</a> was <code>evaluate</code> to add new bindings to the lexical global, but <code>evaluate("let undefined = 3")</code> gives an error message about redeclaring a non-configurable global property, so that doesn't seem to get anywhere.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon May 15 2023 10:38:37 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Are you sure about <code>undefined</code> being on the global lexical? It looks to me like it lives on the global itself, although I'm not sure that makes a concrete difference)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon May 15 2023 10:39:29 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So if it lived on the global, I would have expected <code>function f(x) { return x == undefined; }; window.undefined = 10; f(10)</code> to return true... but so far that didn't work</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon May 15 2023 10:39:37 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's not writable</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon May 15 2023 10:39:40 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">so I thought it was the global lexical </td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon May 15 2023 10:39:53 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><pre><code>js&gt; Object.getOwnPropertyDescriptors(this).undefined
({value:(void 0), writable:false, enumerable:false, configurable:false})
</code></pre>
</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon May 15 2023 10:41:11 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. But it's not configurable.... can that be bypassed at all? </td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon May 15 2023 10:42:19 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(So far, patching NameOpEmitter to just emit <code>Undefined</code> is working on jstests and jit-tests..._</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon May 15 2023 10:45:12 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(For context, I was looking into how we could emit <code>IsNullOrUndefined</code> for user code, but the fact that undefined is a binding has caused some consternation. The fact that we seem to be able to tell when undefined is actually the <code>undefined</code> we expect is thus-far helpful. I do however keep waiting for the language to jump out from behind a corner and beat me senseless with something tho)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon May 15 2023 11:13:39 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In WarpBuilder we special-case <code>undefined</code>, <code>Infinity</code>, and <code>NaN</code> to avoid looking them up on the global: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpBuilder.cpp#1852-1863">https://searchfox.org/mozilla-central/source/js/src/jit/WarpBuilder.cpp#1852-1863</a></td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon May 15 2023 11:14:46 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I can't think of a reason off the top of my head that we couldn't do that in the parser</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon May 15 2023 11:14:54 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Maybe something terrible debugger-related?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon May 15 2023 12:20:58 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Interesting pointer. Thank you for that :) </td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon May 15 2023 12:30:48 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: I'm assuming that we know at parse time whether non-syntactic scopes are involved?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon May 15 2023 12:30:57 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yes </td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon May 15 2023 12:31:05 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">and we generate different bytecode as a result</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon May 15 2023 12:38:17 GMT-0700 (Pacific Daylight Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">After a bit more code archaeology, the oldest version of this logic I can find is <a href="https://searchfox.org/mozilla-esr78/rev/82c1487dc74e020cd8f50f52a601c169dd28f87a/js/src/ion/IonBuilder.cpp#1986-1991">here</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon May 15 2023 12:39:17 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Unfortunately there's no real discussion about it</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon May 15 2023 12:40:31 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Note that baseline <a href="https://searchfox.org/mozilla-central/source/js/src/jit/BaselineCodeGen.cpp#3230-3248">also optimizes this</a></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon May 15 2023 12:40:42 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(But not blinterp)</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon May 15 2023 12:45:03 GMT-0700 (Pacific Daylight Time)">19:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">This feels like something we can fix in bytecode emission for sure. 

I have an idea on how to do the conditional folding still. Just have to write it out. </td></tr>

</tbody></table></div></div></div>
</body></html>