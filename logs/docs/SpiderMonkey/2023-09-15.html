<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-09-15</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-09-15<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-09-14" class="nav-link"><span>prev</span></a>
<a href="2023-09-18" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Sep 15 2023 10:31:04 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>or maybe <span class="nick-16">mccr8</span>: I remember with WeakMap stuff I ran into the case where a CCW could get nuked but then un-nuked. I'm not sure what it corresponds to in Firefox termsâ€”something like changing the domain to something inaccessible and then changing it back? Does that even nuke in the first place? Anyway, I'm wondering (1) is that actually a thing or am I making it up, and (2) do we have a way to trigger it in a JS shell test?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Sep 15 2023 10:31:35 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I was thinking about it in relation to bug 1852729. Do we need to do something for the un-nuking case?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Sep 15 2023 10:31:36 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1852729">https://bugzil.la/1852729</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Sep 15 2023 10:32:16 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and is there a more colorful term than "un-nuking"? "Nuclear zombies"? "Radioactive revivified wrappers"?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Sep 15 2023 10:37:20 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> and is there a more colorful term than "un-nuking"? "Nuclear zombies"? "Radioactive revivified wrappers"?</blockquote></mx-reply>I'm not sure what you mean. A CCW to an outer window proxy can be turned into a remote window proxy (in the current compartment) via transplanting, if an iframe navigates to a non-same-site page, and then we do the reverse if it navigates back to a same site page.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Sep 15 2023 10:38:42 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Yeah, I may be mixing up transplanting and nuking. I'm really thinking of the nuking and un-nuking cases, which may have nothing to do with domains or navigation.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Sep 15 2023 10:39:14 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I'm not sure what un-nuking is.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Sep 15 2023 10:40:04 GMT-0700 (Pacific Daylight Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, I'd better go crawl through to code to find what it is I'm talking about.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Sep 15 2023 10:41:08 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> ok, I'd better go crawl through to code to find what it is I'm talking about.</blockquote></mx-reply>In the browser, I think the only nuking we do is turning CCWs from chrome into content into dead wrappers, when the window is closed. At least that's all I can think of. We wouldn't undo that.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Sep 15 2023 10:41:21 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm, <a href="https://searchfox.org/mozilla-central/source/js/src/proxy/CrossCompartmentWrapper.cpp#528">https://searchfox.org/mozilla-central/source/js/src/proxy/CrossCompartmentWrapper.cpp#528</a> seems relevant</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Sep 15 2023 10:43:49 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">ugh looks like this is related to xray waivers. Uhh let's see if I can remember any of this. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1582568">https://bugzilla.mozilla.org/show_bug.cgi?id=1582568</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Sep 15 2023 10:45:30 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Ah, I ran into it <a href="https://searchfox.org/mozilla-central/rev/b741ddde6c678ca7025858952202d20664491555/js/src/gc/Marking.cpp#817-821">here</a> for bug 1667913</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Sep 15 2023 10:45:31 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1667913">https://bugzil.la/1667913</a> â€” RESOLVED (sfink) â€” Enable incremental weakmap marking in the browser</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Sep 15 2023 10:47:08 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Well, that's the only occurrence of "un-nuke" in the entire codebase. ðŸ˜‰</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Sep 15 2023 10:47:28 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">So I think you are the expert here.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Sep 15 2023 10:47:39 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Module owner for un-nuking</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Sep 15 2023 10:48:29 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it seems like it's <code>js::RemapDeadWrapper</code> that I'm thinking of.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Sep 15 2023 10:51:22 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the most relevant caller seems to be <a href="https://searchfox.org/mozilla-central/rev/b741ddde6c678ca7025858952202d20664491555/dom/base/nsGlobalWindowOuter.cpp#2207">nsGlobalWindowOuter::SetNewDocument, here</a></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Sep 15 2023 11:00:03 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I still don't understand what this has to do with unnuking.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Sep 15 2023 11:00:20 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ouch. I read through bug 1582568. If anyone is wanting to melt their brain, it's great reading. Comment 55 kind of lays it out.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Sep 15 2023 11:00:21 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1582568">https://bugzil.la/1582568</a> â€” RESOLVED (mccr8) â€” Intermittent GECKO(1150) | Assertion failure: !JS_IsDeadWrapper(js::UncheckedUnwrap(&amp;obj.toObject())), at /builds/worker/workspace/build/src/js/xpconnect/src/XPCComponents.cpp:1911</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Sep 15 2023 11:01:54 GMT-0700 (Pacific Daylight Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it seems like there's a case where we have a CCW that turns into a DeadObjectProxy and then turns back into a CCW?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Sep 15 2023 11:03:24 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> it seems like there's a case where we have a CCW that turns into a DeadObjectProxy and then turns back into a CCW?</blockquote></mx-reply>Ah, it sounds like maybe that happens if the target of the CCW is an Xray waiver.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Sep 15 2023 11:03:42 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I'm not sure about the "turn back" part of that</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Sep 15 2023 11:06:49 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I do see <code>MOZ_ASSERT(!newTarget-&gt;is&lt;FinalizationRecordObject&gt;());</code> with the comment <code>These are not exposed</code>, which maybe addresses my concern in this case? As in, this would only be a problem if this CCW were the target of a <code>WeakRef</code>, and it sounds like that may be impossible.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Sep 15 2023 11:08:05 GMT-0700 (Pacific Daylight Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I don't know enough about WeakRefs to know if that is allowed or not.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Sep 15 2023 11:08:25 GMT-0700 (Pacific Daylight Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">anyway, I'm getting some hits when I add a <code>MOZ_CRASH</code> to <code>js::RemapDeadWrapper</code>, so maybe I have a way to look into this.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Sep 15 2023 11:29:08 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1853398">https://bugzilla.mozilla.org/show_bug.cgi?id=1853398</a> I see an GetElem IonIC when running stanford-crypto-pbkdf2 but not when running stanford-crypto-sha256. What's the easiest way to find out why I'm getting an IonIC?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Sep 15 2023 11:29:27 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><p>the IR for the IonIC is:</p>
<pre><code>GuardToObject
GuardShape
GuardToInt32
Int32ToIntPtr
LoadTypedArrayElementResult
ReturnFromIC
</code></pre>
</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Sep 15 2023 11:34:06 GMT-0700 (Pacific Daylight Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: Are you running in the shell? You can set CACHEIR_LOGS=1 as an environment variable, which should dump a cacheir&lt;pid&gt;.json file into /tmp, and then open it up here: <a href="http://tomschuster.name/cacheir-tools/">http://tomschuster.name/cacheir-tools/</a></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Sep 15 2023 11:34:17 GMT-0700 (Pacific Daylight Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: perfect</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Sep 15 2023 11:34:59 GMT-0700 (Pacific Daylight Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The most likely reason is that we had more than one active IC, so you should be able to see the CacheIR for all the ICs we attached at that point</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Sep 15 2023 11:36:09 GMT-0700 (Pacific Daylight Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If I had to guess, I would guess that we occasionally see a regular array (instead of a typed array) at that location</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Sep 15 2023 11:40:39 GMT-0700 (Pacific Daylight Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: While we're vaguely on the topic: do we have any reason to think stanford-crypto-pbkdf2 is a particularly relevant sub-benchmark, or is just easy to analyze? That kind of number-crunchy array access code is one of the things that we knowingly took a hit on when we moved from IonBuilder to WarpBuilder, and we didn't put a lot of effort into improving it because we didn't think it mattered much for web usage.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Sep 15 2023 11:42:34 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: I don't think it's a good benchmark (in fact, I think it is bad), but it's easy to analyze and it's possible it's low hanging fruit</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Sep 15 2023 11:43:14 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">It looks like part of the performance problem is that it runs the same code on a typed array and a regular array</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Sep 15 2023 11:43:23 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">(that's the likely cause of the IonIC)</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Sep 15 2023 11:44:10 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">normally this is unwise but <span class="nick-1">mstange</span>  says the same thing is happening in the segmentation sp3 test</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Sep 15 2023 11:45:36 GMT-0700 (Pacific Daylight Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">When I looked at segmentation I apparently found that we got 10-15% faster if we didn't mix types: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1844857#c4">https://bugzilla.mozilla.org/show_bug.cgi?id=1844857#c4</a></td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Sep 15 2023 11:45:51 GMT-0700 (Pacific Daylight Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Is the same sort of thing true here? Does it close the gap with V8 at all?</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Sep 15 2023 11:46:51 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">I'm going to try to adjust the test case to always use a TypeArray</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Sep 15 2023 13:45:39 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: can someone explain where the proxy in this case comes from: <a href="https://share.firefox.dev/3RqeAlW">https://share.firefox.dev/3RqeAlW</a></td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Sep 15 2023 13:46:23 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><a href="https://browserbench.org/JetStream2.0/SunSpider/3d-cube.js">https://browserbench.org/JetStream2.0/SunSpider/3d-cube.js</a></td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Sep 15 2023 13:46:54 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/WebKit/WebKit/blob/68ac9887adc95fe820ffa87d93ee4fef7c485bf8/PerformanceTests/JetStream2/SunSpider/3d-cube.js#L100">https://github.com/WebKit/WebKit/blob/68ac9887adc95fe820ffa87d93ee4fef7c485bf8/PerformanceTests/JetStream2/SunSpider/3d-cube.js#L100</a></td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Sep 15 2023 13:47:23 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">In the browser this has something with <code>nsOuterWindowProxy</code> in it in the stack</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Sep 15 2023 13:49:02 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Is the same sort of thing true here? Does it close the gap with V8 at all?</blockquote></mx-reply>It does</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Sep 15 2023 13:50:45 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: Specifically, it looks like <a href="https://github.com/WebKit/WebKit/blob/68ac9887adc95fe820ffa87d93ee4fef7c485bf8/PerformanceTests/JetStream2/SunSpider/3d-cube.js#L320">here</a> we are calling <code>CreateP</code> without <code>new</code>, in which case <code>this</code> is the global.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Sep 15 2023 13:51:02 GMT-0700 (Pacific Daylight Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">ah</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Sep 15 2023 13:51:04 GMT-0700 (Pacific Daylight Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: Intriguing. How much of the gap is closed?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Sep 15 2023 13:54:19 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: on that function it goes from 58% to 12%</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Sep 15 2023 14:40:27 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Huh. I would not have expected that. Digging into this a bit, I think this is what's going on: <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/compiler/js-native-context-specialization.cc;l=2287-2372;drc=31fb07c05718d671d96c227855bfe97af9e3fb20;bpv=0;bpt=1">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/compiler/js-native-context-specialization.cc;l=2287-2372;drc=31fb07c05718d671d96c227855bfe97af9e3fb20;bpv=0;bpt=1</a></td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Sep 15 2023 14:41:27 GMT-0700 (Pacific Daylight Time)">21:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Roughly speaking: if a property access has multiple IC stubs (but not so many that it goes megamorphic), we generate an Ion IC, whereas in V8 it looks like they generate polymorphic code covering all the cases they've seen.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Sep 15 2023 14:46:20 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In general, our expectation is that it's not all that useful to do so, because the code you generate/execute if you inline all the stubs isn't going to be very different than the code you generate/execute for the Ion IC.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Sep 15 2023 14:49:53 GMT-0700 (Pacific Daylight Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The more I think about it, the more I think that the CFG you end up generating would be gross and maybe hard to optimize. I wonder if it is less ugly in sea-of-nodes? Presumably not so much less ugly that V8 is willing to stick with sea-of-nodes.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Sep 15 2023 15:02:06 GMT-0700 (Pacific Daylight Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">There's another reason why the gap shrinks, and that's because using typed arrays for all calls makes Chrome slower. It caused Chrome to do some allocation whose purpose Jeff didn't understand.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Sep 15 2023 15:04:20 GMT-0700 (Pacific Daylight Time)">22:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Huh. So maybe the gap closing is less that they're doing something smart in the polymorphic case, and more that they're doing something dumb in the monomorphic case? </td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Sep 15 2023 15:08:33 GMT-0700 (Pacific Daylight Time)">22:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">It's possible... though actually I may have misspoken - the allocation happened during a call to subarray, but that call is in a different function, so it wouldn't have affected the gap "on this function"</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Sep 15 2023 15:09:09 GMT-0700 (Pacific Daylight Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">I'll let Jeff fill in the details at his convenience</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Sep 15 2023 15:27:59 GMT-0700 (Pacific Daylight Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p>I find it difficult to understand Turbolizer, but from what I can tell by squinting at a much simpler testcase, V8 isn't unlocking a huge pile of optimization opportunities by generating polymorphic code here. Specifically: for a function <code>foo(arr) { arr[0] = arr[1] + arr[2]; }</code>, V8 generates code that is roughly:</p>
<pre><code>tmp1 = isTypedArray(arr) ? typedLoad(arr,1) : regularLoad(arr,1);
tmp2 = isTypedArray(arr) ? typedLoad(arr,2) : regularLoad(arr,2);
sum = tmp1 + tmp2
if (isTypedArray(arr)) { typedStore(arr, 0, sum) } else { regularStore(arr, 0, sum); }
</code></pre>
<p>You can imagine an optimization that would notice the structure there and turn it into something like:</p>
<pre><code>if (isTypedArray(arr) { 
  /* do the typed version */ 
} else { 
  /* do the normal version */ 
}
</code></pre>
</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Sep 15 2023 15:28:27 GMT-0700 (Pacific Daylight Time)">22:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But it does not look like V8 has such an optimization.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Sep 15 2023 16:20:41 GMT-0700 (Pacific Daylight Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> There's another reason why the gap shrinks, and that's because using typed arrays for all calls makes Chrome slower. It caused Chrome to do some allocation whose purpose Jeff didn't understand.</blockquote></mx-reply>This was overall gap on the test. Chrome still does better with the only typed array case on the _block function</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Sep 15 2023 16:21:02 GMT-0700 (Pacific Daylight Time)">23:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">_block before: sm 6146, v8 2179 </td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Sep 15 2023 16:21:17 GMT-0700 (Pacific Daylight Time)">23:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">_block after: sm 2669, v8 1894</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Sep 15 2023 16:21:37 GMT-0700 (Pacific Daylight Time)">23:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">the weird allocation mystery is happening in the caller</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Sep 15 2023 16:51:09 GMT-0700 (Pacific Daylight Time)">23:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Okay, so we benefit much more from a single array type here than V8 does. Interesting.</td></tr>

</tbody></table></div></div></div>
</body></html>