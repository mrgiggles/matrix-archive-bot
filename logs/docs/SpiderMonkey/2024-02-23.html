<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-02-23</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-02-23<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-02-22" class="nav-link"><span>prev</span></a>
<a href="2024-02-26" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Feb 22 2024 16:24:42 GMT-0800 (Pacific Standard Time)">00:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">ah, it turns out that the config JSON blob just didn't have the right settings -- <code>"optimize": false</code> and also <code>"debug": true</code> (only had the former) -- that seems to be the magic to disable that check. (<a href="https://hg.mozilla.org/try/rev/33b2e91d964e8e34faddf65a56f73f4a07ae8e56">https://hg.mozilla.org/try/rev/33b2e91d964e8e34faddf65a56f73f4a07ae8e56</a> gives a clean build)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Feb 22 2024 16:24:50 GMT-0800 (Pacific Standard Time)">00:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">thanks in any case!</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Feb 22 2024 23:17:19 GMT-0800 (Pacific Standard Time)">07:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I'm getting errors when using mozilla::EnumSet, presumably because of integer overflows. If I add 0 to the set, 32 also gets "added". Here is a simple example: <a href="https://paste.mozilla.org/TEb1Ckas">https://paste.mozilla.org/TEb1Ckas</a>

Using mozilla::EnumSet&lt;Enum, std::uint64_t&gt; fixes the problem.

Is anyone maintaining this class? Seems like this should be a simple thing to fix.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Feb 22 2024 23:54:29 GMT-0800 (Pacific Standard Time)">07:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: which revision of the source do you use on which environment/architecture?  I don't observe the issue locally with today's m-c tip</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Feb 22 2024 23:57:06 GMT-0800 (Pacific Standard Time)">07:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">on macOS 64bit</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Feb 22 2024 23:58:55 GMT-0800 (Pacific Standard Time)">07:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I have mozjs 102 a1.  I'm running on Windows, x86.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Feb 23 2024 00:00:25 GMT-0800 (Pacific Standard Time)">08:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">which compiler do you use?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Feb 23 2024 00:00:38 GMT-0800 (Pacific Standard Time)">08:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Sorry, x86!</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Feb 23 2024 00:01:16 GMT-0800 (Pacific Standard Time)">08:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, let me check with 32-bit arch</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Feb 23 2024 00:01:38 GMT-0800 (Pacific Standard Time)">08:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I compiled with Clang. This was a long time ago, and I remember there being some compiler errors which I had to kind of force through.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Feb 23 2024 00:08:56 GMT-0800 (Pacific Standard Time)">08:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">still not reproducible with esr102 tip, x86, linux, clang</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Feb 23 2024 00:12:14 GMT-0800 (Pacific Standard Time)">08:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can you check if your code matches to <a href="http://searchfox.org/mozilla-esr102/source/mfbt/EnumSet.h">http://searchfox.org/mozilla-esr102/source/mfbt/EnumSet.h</a> ? I'm not sure what the a1 in your version number actually means</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Feb 23 2024 00:14:31 GMT-0800 (Pacific Standard Time)">08:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hm, it might be something related to the difference in the size of standard types between linux vs windows?  I'll see if I can reproduce on windows</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Feb 23 2024 00:20:49 GMT-0800 (Pacific Standard Time)">08:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hm, not reproducible with esr102 tip, x86, windows, clang 17.0.1</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Feb 23 2024 00:33:45 GMT-0800 (Pacific Standard Time)">08:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><p>I compared the code, and it looks like I fiddled with the sourcecode here when I was compiling. Looks like I couldn't get the following line to compile:</p>
<p><code> static constexpr size_t kMaxBits = MaxBits();</code>, so I just hard-coded it to 64.</p>
</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Feb 23 2024 00:33:50 GMT-0800 (Pacific Standard Time)">08:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Sorry for the wild goose chase.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Feb 23 2024 00:38:13 GMT-0800 (Pacific Standard Time)">08:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">So now the question is, why doesn't this line compile? I get the following error message:<br><code>MaxBits': a call of a non-static member function requires an object</code></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Feb 23 2024 00:38:39 GMT-0800 (Pacific Standard Time)">08:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Which seems reasonable: <code>MaxBits()</code> is not a static function.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Feb 23 2024 00:39:30 GMT-0800 (Pacific Standard Time)">08:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can you provide the entire output?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Feb 23 2024 00:39:41 GMT-0800 (Pacific Standard Time)">08:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Oh wait, on your version of the source-code, MaxBits() is static...</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Feb 23 2024 00:45:43 GMT-0800 (Pacific Standard Time)">08:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I just copied your version of the source-code and it works. Who knows where the error came from (probably me).</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Feb 23 2024 04:20:03 GMT-0800 (Pacific Standard Time)">12:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: <span class="nick-12">denispal</span> When bug 1881303 lands it will expose some prefs to control idle time nursery collection to enable experiments to be done with these</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Feb 23 2024 04:20:05 GMT-0800 (Pacific Standard Time)">12:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1881303">https://bugzil.la/1881303</a> â€” NEW (jonco) â€” Expose GC scheduling tunables for eager nursery collection as prefs</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Feb 23 2024 04:25:05 GMT-0800 (Pacific Standard Time)">12:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">ah, ok, this affects <a href="https://searchfox.org/mozilla-central/rev/da49863c3d6f34038d00f5ba701b9a2ad9cbadba/dom/base/nsJSEnvironment.cpp#1757,1760">https://searchfox.org/mozilla-central/rev/da49863c3d6f34038d00f5ba701b9a2ad9cbadba/dom/base/nsJSEnvironment.cpp#1757,1760</a></td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Feb 23 2024 04:36:26 GMT-0800 (Pacific Standard Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Tweaking those might not affect sp3 too much, I think, since there the issue is that even though PREPARE_FOR_PAGELOAD has run minorGC and given good size nursery, then lots of gcthings are allocated and minor gc runs. Then Nursery::targetSize ends up shrinking nursery and we run the next minor gc sooner.  But I think tweaking those prefs could affect real world pages, kind of giving some of the benefits of PREPARE_FOR_PAGELOAD in cases when there isn't any page load happening.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Feb 23 2024 04:51:08 GMT-0800 (Pacific Standard Time)">12:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: could we use EAGER_NURSERY_COLLECTIONs as a hint that we've had idle time recently, and if so, don't shrink nursery so quickly when doing other kinds of minorGCs?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Feb 23 2024 04:52:34 GMT-0800 (Pacific Standard Time)">12:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'm not sure if we use that same reason also for non-idle stuff though</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Feb 23 2024 04:53:56 GMT-0800 (Pacific Standard Time)">12:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I would rather expose an API to supply the hint directly, or expose prefs for changing the rate of shrinking</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Feb 23 2024 04:55:36 GMT-0800 (Pacific Standard Time)">12:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: ok. When would you like to get JS side to be notified about idleness?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Feb 23 2024 04:58:24 GMT-0800 (Pacific Standard Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">would it be useful to notify js engine always when the main thread finds that there is idle time? (only pending idle tasks, or no tasks at all, and no refreshdriver nor timers expected to run real soon)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Feb 23 2024 05:01:38 GMT-0800 (Pacific Standard Time)">13:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Or maybe Gecko side could keep track of the previous idle period start time, and js engine had just a callback to query that information </td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Feb 23 2024 05:01:50 GMT-0800 (Pacific Standard Time)">13:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">That would be more efficient</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Feb 23 2024 05:04:32 GMT-0800 (Pacific Standard Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">There are bunch of parameters used when calculating the nursery size that could be exposed too, that may be worth doing</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Feb 23 2024 05:07:11 GMT-0800 (Pacific Standard Time)">13:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: do you know how much difference allocating DOM wrappers in the nursery makes to sp3?  These longer collections may indicate we're allocating too much stuff in the nursery and there may be something going wrong that causes too many of them to get tenured.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Feb 23 2024 05:09:59 GMT-0800 (Pacific Standard Time)">13:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: I've played with that. Allocating even more wrappers from nursery does affect perf negatively</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Feb 23 2024 05:10:55 GMT-0800 (Pacific Standard Time)">13:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">but IIRC using ProbablyShortLivingWrapper less didn't improve</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Feb 23 2024 05:12:48 GMT-0800 (Pacific Standard Time)">13:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">It is about balancing many things. We should get unused stuff released sooner, so that the memory can be reused, but releasing soon may mean running minor GC at problematic  time.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Feb 23 2024 05:16:33 GMT-0800 (Pacific Standard Time)">13:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">for what it's worth, a few days ago I collected some data on what objects get tenured on sp3: <a href="https://paste.mozilla.org/j80RXJDR">https://paste.mozilla.org/j80RXJDR</a></td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Feb 23 2024 05:20:24 GMT-0800 (Pacific Standard Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: nice</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Feb 23 2024 05:22:00 GMT-0800 (Pacific Standard Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">One thing that could help minor GC times a lot is to pretenure more things. We currently support objects and arrays only. That data shows Function, Call and Set in the top five - all things we don't pretenure.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Feb 23 2024 05:24:13 GMT-0800 (Pacific Standard Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: in which case do we pretenure?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Feb 23 2024 05:25:20 GMT-0800 (Pacific Standard Time)">13:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: hmm, *Prototype objects are nursery allocated o_O</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Feb 23 2024 05:25:55 GMT-0800 (Pacific Standard Time)">13:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">For objects and arrays created by scripts </td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Feb 23 2024 05:26:15 GMT-0800 (Pacific Standard Time)">13:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I suspect that may mean objects with that prototype in the pastebin</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Feb 23 2024 05:29:51 GMT-0800 (Pacific Standard Time)">13:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I think this is where we allocate those prototypes? <a href="https://searchfox.org/mozilla-central/rev/da49863c3d6f34038d00f5ba701b9a2ad9cbadba/dom/bindings/BindingUtils.cpp#1024-1025">https://searchfox.org/mozilla-central/rev/da49863c3d6f34038d00f5ba701b9a2ad9cbadba/dom/bindings/BindingUtils.cpp#1024-1025</a></td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Feb 23 2024 05:31:30 GMT-0800 (Pacific Standard Time)">13:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">huh, I guess not</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Feb 23 2024 05:38:09 GMT-0800 (Pacific Standard Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: it would be nice if we had space in the nursery cell header for the alloc kind instead of the trace kind, but we're probably just a few bits short?</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Feb 23 2024 05:39:40 GMT-0800 (Pacific Standard Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: yeah, and also alloc kind doesn't apply so much to nursery things as it includes background/foreground finalization, object size etc</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Feb 23 2024 05:40:52 GMT-0800 (Pacific Standard Time)">13:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah.. but it would be nice for tenuring if we could read the alloc kind from there instead of computing it based on other state</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Feb 23 2024 05:41:05 GMT-0800 (Pacific Standard Time)">13:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">What would be the best way to prevent nursery allocation?  I guess webidl stuff rely on JSCLASS_FOREGROUND_FINALIZE without JSCLASS_SKIP_NURSERY_FINALIZE. But what if the object can be finalized in background?</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Feb 23 2024 05:41:49 GMT-0800 (Pacific Standard Time)">13:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: I'm not sure it's always the same... at one point we could change object layout when we tenured although I don't remember if that still happens</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Feb 23 2024 05:42:26 GMT-0800 (Pacific Standard Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">oh, <a href="https://searchfox.org/mozilla-central/source/js/public/Class.h#826">https://searchfox.org/mozilla-central/source/js/public/Class.h#826</a></td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Feb 23 2024 05:42:33 GMT-0800 (Pacific Standard Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I saw some code for arrays, but I expect it's the same in most cases</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Feb 23 2024 05:42:50 GMT-0800 (Pacific Standard Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">IMO it would be more beneficial to pretenure more rather than making tenuring slightly more efficient</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Feb 23 2024 05:43:33 GMT-0800 (Pacific Standard Time)">13:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: that's fair</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Feb 23 2024 05:43:51 GMT-0800 (Pacific Standard Time)">13:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: we should expose a flag like we have inside the engine</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Feb 23 2024 05:44:22 GMT-0800 (Pacific Standard Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">(also adding a either kind of finalizer and not setting JSCLASS_SKIP_NURSERY_FINALIZE will do it)</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Feb 23 2024 06:02:48 GMT-0800 (Pacific Standard Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: great! I'll add a bunch of gc prefs into the manifest so we can start an experiment in nightly asap</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Feb 23 2024 06:03:38 GMT-0800 (Pacific Standard Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: <span class="nick-4">smaug</span>:  I did a run yesterday that sets nursery to 64mb just to get an idea of the ceiling for sp3 improvement:  <a href="https://treeherder.mozilla.org/perfherder/compare?originalProject=try&amp;newProject=try&amp;newRevision=1019a695e9983d228fbe953da440e532cc023c52&amp;framework=13&amp;originalRevision=c3ed4d02a7742e0dc829d4cb1c754c2a9c81eeab&amp;page=1">results here</a></td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Feb 23 2024 06:04:10 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">that is a lot</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Feb 23 2024 06:04:49 GMT-0800 (Pacific Standard Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">I did <a href="https://treeherder.mozilla.org/perfherder/compare?originalProject=try&amp;newProject=try&amp;newRevision=411c9ffa9660c9efd06e2b69560b0e1e0332e833&amp;framework=13&amp;originalRevision=c3ed4d02a7742e0dc829d4cb1c754c2a9c81eeab&amp;page=1">another run</a> that sets only the max to 64mb.  Also good results, but I think shrinking is impacting is a bit here.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Feb 23 2024 06:05:06 GMT-0800 (Pacific Standard Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I meant the perf improvements, but also the nursery size is perhaps a lot ðŸ™‚ </td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Feb 23 2024 06:05:15 GMT-0800 (Pacific Standard Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">nice, 2% improvement</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Feb 23 2024 06:05:57 GMT-0800 (Pacific Standard Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">nursery size is also a lot! but v8 uses 72MB nursery according to: <a href="https://wingolog.org/archives/2023/12/08/v8s-mark-sweep-nursery">https://wingolog.org/archives/2023/12/08/v8s-mark-sweep-nursery</a></td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Feb 23 2024 06:08:17 GMT-0800 (Pacific Standard Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Interesting that M2-Mac is affected quite a bit less. It is way faster than the ancient machines used for Windows and Linux.</td></tr>

</tbody></table></div></div></div>
</body></html>