<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-03-03</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-03-03<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-03-02" class="nav-link"><span>prev</span></a>
<a href="2022-03-04" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Mar 03 2022 00:17:57 GMT-0800 (Pacific Standard Time)">08:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell"><p>Hello folks, I'm trying to implement some changes to the DebuggerObject and I would need some help.</p>
<p>Basically we have this <code>getOwnPropertyNamesMethod</code> function <a href="https://searchfox.org/mozilla-central/rev/ad7ecfa618ec3a65db8405d9f1125059fe4a6a15/js/src/debugger/Object.cpp#770-783">https://searchfox.org/mozilla-central/rev/ad7ecfa618ec3a65db8405d9f1125059fe4a6a15/js/src/debugger/Object.cpp#770-783</a><br>that returns an array of strings representing the property names of an object.<br>Instead of getting an array directly, I'd like to get an ArrayIterator as the function can be costly on objects with lots of properties (e.g. <code>window</code>) and the DevTools callsite might not need it <em>all</em> the names anyway.</p>
<p>I guess what I could do is have something similar to <code>IdVectorToArray</code> <a href="https://searchfox.org/mozilla-central/source/js/src/debugger/Frame.cpp#1924">https://searchfox.org/mozilla-central/source/js/src/debugger/Frame.cpp#1924</a> , but that would return an ArrayIterator (e.g. <code>IdVectorToArrayIterator</code>).<br>I came across&nbsp;<code>NewArrayIterator</code> <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Iteration.cpp#1281">https://searchfox.org/mozilla-central/source/js/src/vm/Iteration.cpp#1281</a> but I'm not sure how to use it / if this is the appropriate function I should be using.<br>It would be great if someone could point me into the right direction :)</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Mar 03 2022 00:55:30 GMT-0800 (Pacific Standard Time)">08:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">nchevobbe</span>: is the expensive part the <code>IdVectorToArray</code> call? that seems a bit surprising to me. That said, <code>IdVectorToArray</code> is inefficient because it does two copies</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Mar 03 2022 00:55:50 GMT-0800 (Pacific Standard Time)">08:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">let me try rewriting that to be more efficient</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Mar 03 2022 01:00:06 GMT-0800 (Pacific Standard Time)">09:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">I'm not sure what's the expensive part, but in a previous patch that I wrote, I got positive performance improvement not returning an array (see <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1756941">https://bugzilla.mozilla.org/show_bug.cgi?id=1756941</a>)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Mar 03 2022 01:00:51 GMT-0800 (Pacific Standard Time)">09:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">and the function does show up in profiles . you can run <code>./mach talos-test --suite damp --subtests console.bulklog --cycles 1 --tpcycles 1 --gecko-profile --gecko-profile-entries 100000000</code> on latest central and check the content process</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Mar 03 2022 01:05:15 GMT-0800 (Pacific Standard Time)">09:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">nchevobbe</span>: it'd also be interesting to know if we often have integers there (for array objects for example). We currently convert these to strings similar to <code>Object.getOwnPropertyNames</code> etc, but we could also leave them as integers for devtools for perf reasons</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Mar 03 2022 01:43:44 GMT-0800 (Pacific Standard Time)">09:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-14">nchevobbe</span>: it'd also be interesting to know if we often have integers there (for array objects for example). We currently convert these to strings similar to <code>Object.getOwnPropertyNames</code> etc, but we could also leave them as integers for devtools for perf reasons</blockquote></mx-reply>so, I guess we may depending on the object we're handling. we already have different branches for arrays in devtools js code as we probably noticed at some point that calling <code>getOwnPropertyNames</code> was too slow (see <a href="https://searchfox.org/mozilla-central/rev/ad7ecfa618ec3a65db8405d9f1125059fe4a6a15/devtools/server/actors/object.js#197-204">https://searchfox.org/mozilla-central/rev/ad7ecfa618ec3a65db8405d9f1125059fe4a6a15/devtools/server/actors/object.js#197-204</a>)</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Mar 03 2022 01:44:15 GMT-0800 (Pacific Standard Time)">09:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">ah nice</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Mar 03 2022 01:45:12 GMT-0800 (Pacific Standard Time)">09:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">I don't think the perf test we have is stressing logging big arrays, we were discussing having individual perf test for each js types so we could monitor performance of each of them.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Mar 03 2022 01:45:36 GMT-0800 (Pacific Standard Time)">09:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">for now, the one we have is logging a window, an object with thousand of properties, whose value is also an object with 10000 properties: <a href="https://profiler.firefox.com/public/1j9tmk3j0fder1vh9pyfdpjg1772edfdkfxaew8/flame-graph/?globalTrackOrder=0&amp;localTrackOrderByPid=54815-0&amp;profileName=page_0_pagecycle_2%2Fcycle_0.profile&amp;thread=0&amp;timelineType=cpu-category&amp;v=6">https://profiler.firefox.com/public/1j9tmk3j0fder1vh9pyfdpjg1772edfdkfxaew8/flame-graph/?globalTrackOrder=0&amp;localTrackOrderByPid=54815-0&amp;profileName=page_0_pagecycle_2%2Fcycle_0.profile&amp;thread=0&amp;timelineType=cpu-category&amp;v=6</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Mar 03 2022 02:29:07 GMT-0800 (Pacific Standard Time)">10:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">patches in bug 1757899 should help a bit, but there's still some other overhead in the profiles</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Mar 03 2022 02:29:09 GMT-0800 (Pacific Standard Time)">10:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1757899">https://bugzil.la/1757899</a> — ASSIGNED (jandem) — Get rid of some unnecessary vector copies in the debugger code</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Mar 03 2022 05:24:38 GMT-0800 (Pacific Standard Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> patches in bug 1757899 should help a bit, but there's still some other overhead in the profiles</blockquote></mx-reply>Thanks a lot. I pushed to our perf test see what kind of gain we'll get from it. We have other patches in flight to reduce time spent in console.log in the content process, so we might record new profiles after everything landed</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Mar 03 2022 05:26:21 GMT-0800 (Pacific Standard Time)">13:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">nchevobbe</span>: thanks for checking</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Mar 03 2022 06:53:20 GMT-0800 (Pacific Standard Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">confession: Treeherder fails to load properly when using concurrent delazification. Let's build a differential test case which will attempt to minimize 1.9 MB of JavaScript as long as errors are different.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Mar 03 2022 06:53:24 GMT-0800 (Pacific Standard Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Mar 03 2022 11:19:35 GMT-0800 (Pacific Standard Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: debugger + bailout + exceptions... it feels like you are handing me a sandwich I forgot in my locker before my leave</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Mar 03 2022 11:20:25 GMT-0800 (Pacific Standard Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Agree that making the excInfo more self-contained seems the right path forward to decouple bailout from the cx</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Mar 03 2022 11:20:43 GMT-0800 (Pacific Standard Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: Okay, cool, I can probably write up a quick patch</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Mar 03 2022 14:32:00 GMT-0800 (Pacific Standard Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">Speaking of Spidermonkey debugging.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Mar 03 2022 14:33:08 GMT-0800 (Pacific Standard Time)">22:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">Is there a minimal example of writing a C++ NewGlobalObject function?   I've gotten frustrated wading through the example in the JSShell example.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Mar 03 2022 14:34:09 GMT-0800 (Pacific Standard Time)">22:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">In particular I'd love to get a JS stack trace in either a script or C++, because the TypeScript compiler seems to be doing something insane and I can't work out how/where it's happening.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Mar 03 2022 14:57:57 GMT-0800 (Pacific Standard Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">chaircrusher</span>: jsshell "sandbox" is pretty minimal <a href="https://searchfox.org/mozilla-central/rev/d6850ecec549f9a1b10dd8ec8823db3791cf81fd/js/src/shell/js.cpp#4286">https://searchfox.org/mozilla-central/rev/d6850ecec549f9a1b10dd8ec8823db3791cf81fd/js/src/shell/js.cpp#4286</a></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Mar 03 2022 14:58:59 GMT-0800 (Pacific Standard Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">And another minimal example: <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/d9a734321de9394ac4cd30cb2889970622c12136/examples/repl.cpp#L131-L145">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/d9a734321de9394ac4cd30cb2889970622c12136/examples/repl.cpp#L131-L145</a></td></tr>

</tbody></table></div></div></div>
</body></html>