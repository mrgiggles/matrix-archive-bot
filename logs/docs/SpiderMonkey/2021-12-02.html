<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-12-02</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-12-02<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-12-01" class="nav-link"><span>prev</span></a>
<a href="2021-12-03" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Dec 02 2021 01:40:21 GMT-0800 (Pacific Standard Time)">09:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@zjiaz:mozilla.org">zjiaz</span>&gt;</div></td><td class="msg-cell">Hi, may I ask how does the emulator (arm64/mips64) get c++ functions' signature information? Could the function's return type be int32_t? Thanks!</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Dec 02 2021 01:40:30 GMT-0800 (Pacific Standard Time)">09:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@zjiaz:mozilla.org">zjiaz</span>&gt;</div></td><td class="msg-cell">I found that when emulator calls <a href="https://searchfox.org/mozilla-central/source/js/src/jit/VMFunctions.cpp#941">GetIndexFromString</a> function, it will assume the function returns an <code>int64_t</code> value, but it actually returns <code>int32_t</code>, which leading to some jit-tests failed on mips64 emulator.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Dec 02 2021 02:05:45 GMT-0800 (Pacific Standard Time)">10:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">oh does mips64 return -1 (presumably that's the value causing problems) as int64_t? hm</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Dec 02 2021 02:21:13 GMT-0800 (Pacific Standard Time)">10:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@zjiaz:mozilla.org">zjiaz</span>&gt;</div></td><td class="msg-cell">yes, mips64 need it is sign-extended, but on emulator the value's high 32 bits are all zero.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Dec 02 2021 07:51:18 GMT-0800 (Pacific Standard Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">A sincere congratulations and thank you to <span class="nick-5">jon4t4n</span> for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1736060">landing the initial implementation of Import Assertions</a>. 游꿀</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Dec 02 2021 07:55:42 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger 游눌游눌</span>&gt;</div></td><td class="msg-cell">Oh huh, I thought that was done already</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Dec 02 2021 07:55:52 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger 游눌游눌</span>&gt;</div></td><td class="msg-cell">Yay for <span class="nick-5">jon4t4n</span> !</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Dec 02 2021 07:57:45 GMT-0800 (Pacific Standard Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger 游눌游눌</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">jon4t4n</span>: does this handle <a href="https://github.com/whatwg/html/issues/7342">https://github.com/whatwg/html/issues/7342</a> correctly, btw, since it just landed?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Dec 02 2021 08:05:24 GMT-0800 (Pacific Standard Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-5">jon4t4n</span>: does this handle <a href="https://github.com/whatwg/html/issues/7342">https://github.com/whatwg/html/issues/7342</a> correctly, btw, since it just landed?</blockquote></mx-reply>Huh. I hadn't seen that -- almost certainly not handled at the moment.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Dec 02 2021 08:05:40 GMT-0800 (Pacific Standard Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">will open a bug</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Dec 02 2021 08:08:29 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1744082">https://bugzilla.mozilla.org/show_bug.cgi?id=1744082</a> </td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Dec 02 2021 08:28:51 GMT-0800 (Pacific Standard Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@jon4t4n:mozilla.org">jon4t4n</span>&gt;</div></td><td class="msg-cell">Oh, completely missed that. I'll take a look and submit a patch. Thanks <span class="nick-6">Ms2ger 游눌游눌</span> for pointing it out.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Dec 02 2021 08:38:05 GMT-0800 (Pacific Standard Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger 游눌游눌</span>&gt;</div></td><td class="msg-cell">Thanks!</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Dec 02 2021 13:27:06 GMT-0800 (Pacific Standard Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">confession: Never thought I'd be happy to see a compartment mismatch assertion, but this means that I am on the right track by porting jit-tests to xpcshell tests to test the new Streams implementation. </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Dec 02 2021 13:33:43 GMT-0800 (Pacific Standard Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> confession: Never thought I'd be happy to see a compartment mismatch assertion, but this means that I am on the right track by porting jit-tests to xpcshell tests to test the new Streams implementation. </blockquote></mx-reply>what is xpcshell? Cross-platform connect shell? Another shell like JSShell?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Dec 02 2021 13:38:37 GMT-0800 (Pacific Standard Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@dereknongeneric:mozilla.org">DerekNonGeneric</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: more shell for you to teach me about ^</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Dec 02 2021 13:50:08 GMT-0800 (Pacific Standard Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Now I'm getting into compartment questions. So, if I have a stream in one compartment, which has objects from that compartment enqueued, and I'm reading the queue from another compartment, I need to make sure I wrap the value before returning that to the reading-compartment. That sounds reasonable right?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Dec 02 2021 13:51:49 GMT-0800 (Pacific Standard Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(makes the test case pass... but I always have to page compartments back into my head whenever I run into them) </td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Dec 02 2021 13:52:19 GMT-0800 (Pacific Standard Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">This is where it gets painful and I was hoping that WebIDL would somehow magically make all the problems go away. Whenever you have objects from multiple compartments involved, it's not always clear which compartment to be in and which one to wrap things into. And our spidermonkey happy path not only doesn't help here, it actively makes things harder.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Dec 02 2021 13:52:27 GMT-0800 (Pacific Standard Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that said, in the example you give, that sounds 100% correct to me</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Dec 02 2021 13:52:56 GMT-0800 (Pacific Standard Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">since if you're returning it to or storing it into something in the reading compartment, then it'll need to be wrapped in that compartment</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Dec 02 2021 13:54:00 GMT-0800 (Pacific Standard Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if there's an error during the process, I have no idea which compartment the error should be in. (As in, if Error.prototype is completely different in the various compartments, which one does the error object inherit from?)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Dec 02 2021 13:55:42 GMT-0800 (Pacific Standard Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hrm. Fair point. In <a href="https://searchfox.org/mozilla-central/source/dom/streams/ReadableStreamDefaultReader.cpp#129-146">this case</a> I am allocating the object too... so I suppose an alternative (not saying right) solution would be to allocate the done-value-pair object in the compartment of the stream... though that seems extra wrong, now that I think about it (if the stream is nuked, it seems perfectly fine to have <code>{done: false, value: DeadObjectProxy}</code>, but less reasonable to have <code>DeadObjectProxy</code>)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Dec 02 2021 13:56:13 GMT-0800 (Pacific Standard Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">eeep. I, uh, hadn't really thought about error at all yet. :S</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Dec 02 2021 13:57:01 GMT-0800 (Pacific Standard Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>probably has useful insight there, since I think he worked with <span class="nick-6">jorendorff</span> on that before?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Dec 02 2021 13:57:28 GMT-0800 (Pacific Standard Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah, this test case was written up during their collaboration on streams</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Dec 02 2021 13:58:39 GMT-0800 (Pacific Standard Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that code you linked is probably fine, but you'll still have to choose which realm to be in when calling it.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Dec 02 2021 14:03:35 GMT-0800 (Pacific Standard Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@mgaudet:mozilla.org">mgaudet|bbiab</span>&gt;</div></td><td class="msg-cell">Looking at my callstack here, I don't see a lot of sensible places to change realms... so just wrapping here makes sense to me. Definitely need to audit for more opportunities like this that could have popped up </td></tr>

</tbody></table></div></div></div>
</body></html>