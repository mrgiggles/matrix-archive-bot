<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-07-19</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-07-19<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-07-18" class="nav-link"><span>prev</span></a>
<a href="2022-07-20" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jul 19 2022 03:03:18 GMT-0700 (Pacific Daylight Time)">10:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>if it's falling back to the timestamp, it might be that because we're using the same value for lower and higher 32bits <a href="https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/js/src/jsmath.cpp#491-494">https://searchfox.org/mozilla-central/rev/3e1a721bce1da3ae04675539b39a4e95b25a046d/js/src/jsmath.cpp#491-494</a></p>
<pre><code class="language-cpp">return maybeSeed.valueOrFrom([] {
  // Use PRMJ_Now() in case we couldn't read random bits from the OS.
  uint64_t timestamp = PRMJ_Now();
  return timestamp ^ (timestamp &lt;&lt; 32);
</code></pre>
</blockquote></mx-reply>When compiling SpiderMonkey to Wasi - does SpiderMonkey assume the existence of wasi-libc at all?<br>This line makes me think yes but I wanted to get confirmation in this channel if possible: <a href="https://searchfox.org/mozilla-central/source/taskcluster/scripts/misc/build-sysroot-wasi.sh#25">https://searchfox.org/mozilla-central/source/taskcluster/scripts/misc/build-sysroot-wasi.sh#25</a><br>The reason I ask is because we can avoid using the timestamp fallback seeds for Math.random if SpiderMonkey requires wasi-libc by adding an <code>|| defined(__wasi__)</code> on this line <a href="https://searchfox.org/mozilla-central/source/mfbt/RandomNum.cpp#96">https://searchfox.org/mozilla-central/source/mfbt/RandomNum.cpp#96</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jul 19 2022 03:04:12 GMT-0700 (Pacific Daylight Time)">10:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't know much about wasi setup.  I'll look into it but it might take some time</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jul 19 2022 04:54:31 GMT-0700 (Pacific Daylight Time)">11:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, it looks like SpiderMonkey assumes wasi-libc.  at least with the current setup</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jul 19 2022 05:32:33 GMT-0700 (Pacific Daylight Time)">12:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">What's the preferred way to use JSStrings with other non-spidermonkey APIs which require string input? I don't see any obvious methods in the jsapi which extract or reinterpret the string as e.g. const char*</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jul 19 2022 05:33:38 GMT-0700 (Pacific Daylight Time)">12:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> yeah, it looks like SpiderMonkey assumes wasi-libc.  at least with the current setup</blockquote></mx-reply>I'll submit a patch for GenerateRandomBytesFromOS to use arc4random when compiled to wasi üëçÔ∏è</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jul 19 2022 05:33:44 GMT-0700 (Pacific Daylight Time)">12:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">(oh wait, maybe I missed things like <code>JS_GetTwoByteStringCharsAndLength</code> ?)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jul 19 2022 05:33:53 GMT-0700 (Pacific Daylight Time)">12:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-4">mbroadst</span>: <a href="https://searchfox.org/mozilla-central/rev/fa71140041c5401b80a11f099cc0cd0653295e2c/js/src/jsapi-tests/testScriptSourceCompression.cpp#171,194-195,198">https://searchfox.org/mozilla-central/rev/fa71140041c5401b80a11f099cc0cd0653295e2c/js/src/jsapi-tests/testScriptSourceCompression.cpp#171,194-195,198</a></p>
<pre><code class="language-cpp">JS::AutoAssertNoGC nogc(cx);
...
if (JS::StringHasLatin1Chars(str)) {
  const JS::Latin1Char* chars = JS::GetLatin1LinearStringChars(nogc, lstr);
...
  const char16_t* chars = JS::GetTwoByteLinearStringChars(nogc, lstr);
</code></pre>
</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jul 19 2022 05:34:49 GMT-0700 (Pacific Daylight Time)">12:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">Thanks @arai, is the AutoAssertNoGC highlighted intentionally there? </td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jul 19 2022 05:35:06 GMT-0700 (Pacific Daylight Time)">12:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">Oh, I see it's needed for the utility methods</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jul 19 2022 05:35:31 GMT-0700 (Pacific Daylight Time)">12:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes. you can use the returned pointer only in the <code>nogc</code>'s scope</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jul 19 2022 05:37:11 GMT-0700 (Pacific Daylight Time)">12:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">string content can be moved by GC.  <code>AutoAssertNoGC</code> asserts that there's no GC during its lifetime.  and you shouldn't call any SpiderMonkey API that can perform GC there</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jul 19 2022 05:38:00 GMT-0700 (Pacific Daylight Time)">12:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">jakechampion</span>: I can look into the <code>Math.random()</code> thing, I have the wasi build set up locally. I can repro it on the wasi demo <a href="https://jandem.github.io/sm-wasi/?source=for%20(let%20i%20%3D%200%3B%20i%20%3C%205%3B%20i%2B%2B)%0A%20%20%20%20print(Math.random())%3B%0A">here</a></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jul 19 2022 05:39:10 GMT-0700 (Pacific Daylight Time)">12:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-16">jakechampion</span>: I can look into the <code>Math.random()</code> thing, I have the wasi build set up locally. I can repro it on the wasi demo <a href="https://jandem.github.io/sm-wasi/?source=for%20(let%20i%20%3D%200%3B%20i%20%3C%205%3B%20i%2B%2B)%0A%20%20%20%20print(Math.random())%3B%0A">here</a></blockquote></mx-reply>Thanks - I think I've confirmed the bug and that the fix in GenerateRandomBytesFromOS works, could I tag you as a reviewer?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jul 19 2022 05:39:35 GMT-0700 (Pacific Daylight Time)">12:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell">I'm just setting up my new laptop for spidermonkey development, may take a while :D</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jul 19 2022 05:40:09 GMT-0700 (Pacific Daylight Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">jakechampion</span>: sure! good find btw</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jul 19 2022 05:40:18 GMT-0700 (Pacific Daylight Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I see. I'm trying to use std::filesystem to check paths in my module loader, it seems I hadn't considered the challenges of strings between JS and C++ fully.. I don't think I can easily extract these into a std::string?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jul 19 2022 05:40:18 GMT-0700 (Pacific Daylight Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: this is really nice! <a href="https://jandem.github.io/sm-wasi/">https://jandem.github.io/sm-wasi/</a></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jul 19 2022 05:40:44 GMT-0700 (Pacific Daylight Time)">12:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">thanks! I still have to move it to <a href="http://spidermonkey.dev">spidermonkey.dev</a> and make it use the latest build from CI :)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jul 19 2022 05:44:30 GMT-0700 (Pacific Daylight Time)">12:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">mbroadst</span>: if you want to copy the content to <code>std::string</code>, I think what you want is to <a href="https://searchfox.org/mozilla-central/rev/fa71140041c5401b80a11f099cc0cd0653295e2c/js/public/CharacterEncoding.h#383-384">JS_EncodeStringToUTF8</a></td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jul 19 2022 05:45:31 GMT-0700 (Pacific Daylight Time)">12:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">JSString's internal representation has 2 variants Latin1 and UTF-16. and this converts both to UTF-8 and returns newly allocated buffer</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jul 19 2022 05:45:59 GMT-0700 (Pacific Daylight Time)">12:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think you can assign it to <code>std::string</code> variable</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jul 19 2022 05:48:08 GMT-0700 (Pacific Daylight Time)">12:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">oh I see, it handles encoding for me</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jul 19 2022 05:56:13 GMT-0700 (Pacific Daylight Time)">12:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">wait, I don't think you can just jam those char16_ts into a std::string ü§î</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jul 19 2022 05:56:46 GMT-0700 (Pacific Daylight Time)">12:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes. and you don't have to touch <code>char16_t</code> if you use JS_EncodeStringToUTF8</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jul 19 2022 05:57:37 GMT-0700 (Pacific Daylight Time)">12:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS::GetLatin1LinearStringChars</code> and <code>JS::GetTwoByteLinearStringChars</code> are for the case that you don't want to perform copy</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jul 19 2022 05:57:43 GMT-0700 (Pacific Daylight Time)">12:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, just an optimization</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jul 19 2022 05:57:51 GMT-0700 (Pacific Daylight Time)">12:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@mbroadst:mozilla.org">mbroadst</span>&gt;</div></td><td class="msg-cell">Oh I see, I missed that method. Thank you!</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jul 19 2022 05:58:52 GMT-0700 (Pacific Daylight Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if you need copy, and also if you need char array, <code>JS_EncodeStringToUTF8</code> is what you want.  it returns an unique pointer for UTF-8 code units array</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jul 19 2022 06:40:59 GMT-0700 (Pacific Daylight Time)">13:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@jakechampion:mozilla.org">jakechampion</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-16">jakechampion</span>: sure! good find btw</blockquote></mx-reply>I opened <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1780215">https://bugzilla.mozilla.org/show_bug.cgi?id=1780215</a> and the patch is at <a href="https://phabricator.services.mozilla.com/D152180">https://phabricator.services.mozilla.com/D152180</a> (hopefully)</td></tr>

</tbody></table></div></div></div>
</body></html>