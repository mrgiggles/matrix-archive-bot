<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-04-27</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-04-27<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-04-26" class="nav-link"><span>prev</span></a>
<a href="2023-04-28" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Apr 26 2023 20:38:20 GMT-0700 (Pacific Daylight Time)">03:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Is it possible to set the prototype of the global object?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Apr 26 2023 22:21:33 GMT-0700 (Pacific Daylight Time)">05:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: sure, you should be able to mutate it after creating the global. In the browser we use JS_SetImmutablePrototype to make it immutable though</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Apr 26 2023 22:42:15 GMT-0700 (Pacific Daylight Time)">05:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">Are the servo bindings the only way into the JS parser code from Rust? It's looking like building the language server in Rust would be pretty feasible and it looks like I can access XPCOM that way for some things like resource: resolution, but the sticking point is I can't find a way to call the <code>Parser</code> except from C++.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Apr 26 2023 22:42:35 GMT-0700 (Pacific Daylight Time)">05:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">(Even the servo bindings don't seem to support <code>Parser</code>.)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Apr 26 2023 22:46:31 GMT-0700 (Pacific Daylight Time)">05:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I was about to say, they don't support <code>Parser</code></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Apr 26 2023 22:47:03 GMT-0700 (Pacific Daylight Time)">05:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">A lot of C++ stuff doesn't get bindings specifically generated</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Apr 26 2023 22:48:44 GMT-0700 (Pacific Daylight Time)">05:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-12">liam_g</span>: sure, you should be able to mutate it after creating the global. In the browser we use JS_SetImmutablePrototype to make it immutable though</blockquote></mx-reply>I suppose I was looking to create a global object with a given prototype. Isn't it a bad idea to change the prototype after the object has already been created?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Apr 26 2023 22:52:43 GMT-0700 (Pacific Daylight Time)">05:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: that's not possible. It'd also be a bit tricky because the global has to be allocated first for a realm. The good news is that changing the prototype right after you create an object should be fine in modern SpiderMonkey (since version 83-85 or so)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Apr 26 2023 22:53:44 GMT-0700 (Pacific Daylight Time)">05:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Great, thanks for the tip. I'll give it a go.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Apr 26 2023 22:58:23 GMT-0700 (Pacific Daylight Time)">05:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">leftmostcat</span>: Is it even possible to access XPCOM using the servo bindings?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Apr 26 2023 23:04:49 GMT-0700 (Pacific Daylight Time)">06:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">From what I can tell, xpcom basically doesn't exist in the patched version of mozjs it uses<br><a href="https://github.com/servo/mozjs/tree/master/mozjs/mozjs/xpcom/">https://github.com/servo/mozjs/tree/master/mozjs/mozjs/xpcom/</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Apr 26 2023 23:06:56 GMT-0700 (Pacific Daylight Time)">06:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-8">leftmostcat</span>: Is it even possible to access XPCOM using the servo bindings?</blockquote></mx-reply>I don't think so; I'm not thinking about the servo bindings, though. Probably what I'm looking at is compiling and running from within the Firefox tree, just using Ruat as an entry point.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Apr 26 2023 23:09:40 GMT-0700 (Pacific Daylight Time)">06:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">All I really want is to be able to provide decent JS tooling for Firefox/Thunderbird in an IDE, but the resource: paths and <code>ChromeUtils</code>/<code>XPCOMUtils</code> imports make that difficult. But hey, Firefox has its own JS parser and I can be pretty sure that the results it gives will match up with how things parse in the browser. ðŸ˜…</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Apr 26 2023 23:20:56 GMT-0700 (Pacific Daylight Time)">06:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">well, there goes my tiny amount of expertise</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Apr 26 2023 23:25:07 GMT-0700 (Pacific Daylight Time)">06:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Redfire</span>: How much do you know about rust-mozjs? Do you know if there's a particular reason <code>Parser</code> isn't supported?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Apr 26 2023 23:26:40 GMT-0700 (Pacific Daylight Time)">06:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><ol>
<li>Wasn't even aware the <code>Parser</code> API was public till just now</li>
<li>It probably isn't supported for the same reason stuff like <code>Debugger</code> isn't, it's not important for the servo project (for now at least). rust-mozjs is primarily a servo thing after all.</li>
</ol></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Apr 26 2023 23:27:09 GMT-0700 (Pacific Daylight Time)">06:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">Fair.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Apr 26 2023 23:27:54 GMT-0700 (Pacific Daylight Time)">06:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I'll be PR'ing debugger support eventually, but it'll take a while for me to need it either</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Apr 26 2023 23:28:59 GMT-0700 (Pacific Daylight Time)">06:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">Anything I can look at to get a sense of what would be needed to add parser support?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Apr 26 2023 23:31:04 GMT-0700 (Pacific Daylight Time)">06:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I'd need to know the public parser API, which I'm having trouble finding. But most of the custom logic is in <a href="https://github.com/servo/mozjs/blob/master/mozjs/src/jsglue.cpp">https://github.com/servo/mozjs/blob/master/mozjs/src/jsglue.cpp</a> or in <a href="https://github.com/servo/mozjs/blob/master/rust-mozjs/src/jsglue.cpp">https://github.com/servo/mozjs/blob/master/rust-mozjs/src/jsglue.cpp</a></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Apr 26 2023 23:36:02 GMT-0700 (Pacific Daylight Time)">06:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/frontend/Parser.h#1515">https://searchfox.org/mozilla-central/source/js/src/frontend/Parser.h#1515</a> is the definition.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Apr 26 2023 23:37:08 GMT-0700 (Pacific Daylight Time)">06:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">That doesn't seem to be exposed with <code>JS_PUBLIC_API</code> or anything, so how does that work</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Apr 26 2023 23:38:00 GMT-0700 (Pacific Daylight Time)">06:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">Oh, that's a detail I wasn't aware of. Could be that it isn't public. I'm not familiar at all with the JS code.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Apr 26 2023 23:39:39 GMT-0700 (Pacific Daylight Time)">06:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">(I'm a simple man. I see a class defined in a header and I think "I can call that API!")</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Apr 26 2023 23:41:34 GMT-0700 (Pacific Daylight Time)">06:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">There is <a href="https://searchfox.org/mozilla-central/source/js/src/builtin/ReflectParse.cpp#3777">https://searchfox.org/mozilla-central/source/js/src/builtin/ReflectParse.cpp#3777</a> which also isn't supported by mozjs. It'd mean having to stand up a JS runtime, but that at least seems doable via servo.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Apr 26 2023 23:44:10 GMT-0700 (Pacific Daylight Time)">06:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I'm not sure starting up a JS runtime is the smartest idea in an IDE but that's your decision</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Apr 26 2023 23:54:50 GMT-0700 (Pacific Daylight Time)">06:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-ts">interface Config {
  loc: boolean, // to read config for location
  source: string, // file name
  lineno: number, // line number
  target: string, // script or module
}
Reflect.parse(source: string, config: Config);
</code></pre>
<p>This seems to be the API of Reflect.parse. Returns some form of AST</p></td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Apr 27 2023 00:03:20 GMT-0700 (Pacific Daylight Time)">07:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm not sure starting up a JS runtime is the smartest idea in an IDE but that's your decision</blockquote></mx-reply>Not my favorite plan ever, but this is new territory for me and unfamiliar APIs that aren't intended to do what I'm trying to do, heh. Anything to avoid having to write a new parser.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Apr 27 2023 00:06:55 GMT-0700 (Pacific Daylight Time)">07:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">jsparagus exists, but it's kinda unmaintained right now and not complete</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Apr 27 2023 00:07:20 GMT-0700 (Pacific Daylight Time)">07:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/mozilla-spidermonkey/jsparagus">https://github.com/mozilla-spidermonkey/jsparagus</a></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Apr 27 2023 00:09:41 GMT-0700 (Pacific Daylight Time)">07:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">I did come across that, but the list of limitations does make it a tough sell at the moment.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Apr 27 2023 00:11:02 GMT-0700 (Pacific Daylight Time)">07:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><p>It's main goal was indefinitely postponed<br>From discord:</p>
<blockquote>
<p>One of the reasons is that our hand made parser appeared to be way more competitive than we had estimated, and more than the generated parser, which exhibit different cache behaviours.</p>
</blockquote></td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Apr 27 2023 00:15:51 GMT-0700 (Pacific Daylight Time)">07:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@leftmostcat:matrix.org">leftmostcat</span>&gt;</div></td><td class="msg-cell">I wonder if it'd be easier to get the parser made public. :P</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Apr 27 2023 00:16:33 GMT-0700 (Pacific Daylight Time)">07:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">You can try making a bug for that, or asking here first ig</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Apr 27 2023 10:34:00 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell"> * <p>class A {<br>public:<br>static bool DefineClass(JSContext* ctx, JS::HandleObject global);<br>...<br>private:<br>...<br>};</p>
<p>class B {<br>public:<br>static bool DefineClass(JSContext* ctx, JS::HandleObject global);</p>
<p>B(A const&amp; a, ...)<br>: m_a{a},... {}</p>
<p>A const&amp; getA() const noexcept { return m_a; }<br>...</p>
<p>private:<br>A const&amp; m_a;<br>...<br>};</p>
<pre><code>getA() of the class B will return the reference member variable(m\_a) of the class B. How do I bind the getA()?  Or how to set rval() in the binding implementation?
</code></pre>
</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Apr 27 2023 10:34:16 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell"> * <pre><code>class A {
public:
static bool DefineClass(JSContext\* ctx, JS::HandleObject global);
...
private:
...
};

class B {
public:
static bool DefineClass(JSContext\* ctx, JS::HandleObject global);

B(A const&amp; a, ...)
: m\_a{a},... {}

A const&amp; getA() const noexcept { return m\_a; }
...

private:
A const&amp; m\_a;
...
};

</code></pre>
<p>getA() of the class B will return the reference member variable(m_a) of the class B. How do I bind the getA()?  Or how to set rval() in the binding implementation?</p>
</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Apr 27 2023 10:34:45 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell"> * <pre><code>class A {
public:
static bool DefineClass(JSContext\* ctx, JS::HandleObject global);
...
private:
...
};

class B {
public:
static bool DefineClass(JSContext\* ctx, JS::HandleObject global);

B(A const&amp; a, ...)
: m_a{a},... {}

A const&amp; getA() const noexcept { return m_a; }
...

private:
A const&amp; m_a;
...
};

</code></pre>
<p>getA() of the class B will return the reference member variable(m_a) of the class B. How do I bind the getA()?  Or how to set rval() in the binding implementation?</p>
</td></tr>

</tbody></table></div></div></div>
</body></html>