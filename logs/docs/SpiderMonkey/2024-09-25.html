<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-09-25</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-09-25<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-09-22" class="nav-link"><span>prev</span></a>
<a href="2024-09-26" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Sep 24 2024 21:58:51 GMT-0700 (Pacific Daylight Time)">04:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mayankleoboy1:mozilla.org">mayankleoboy1</span>&gt;</div></td><td class="msg-cell">There is a ~
40ms improvement (660ms -&gt; 620ms)  on AWFY-WASM-Godot-wasm-instantiate (Firefox (wasm-optimizing)) since 14Sep2024 on mozilla-central.
I dont know how to pinpoint this further. (The recent work on lazy-tiering and ONNX perf work come to mind)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Sep 24 2024 23:20:42 GMT-0700 (Pacific Daylight Time)">06:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">mayankleoboy1</span>: the mac chart is less noisy and points to 1918970?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Sep 25 2024 00:00:52 GMT-0700 (Pacific Daylight Time)">07:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mayankleoboy1:mozilla.org">mayankleoboy1</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-3">mayankleoboy1</span>: the mac chart is less noisy and points to 1918970?</blockquote></mx-reply>Correct. Macos has very clear improvements in all the webasswmbly-godot-* numbers in that range.<br>The range does include both bug 1918970 and bug 1911071, which is where i am not certain what caused it.<br>In any case, i just wanted to point out improvements (that may/may not be captured in automated perf-sheriffing)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Sep 25 2024 00:00:53 GMT-0700 (Pacific Daylight Time)">07:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1918970">https://bugzil.la/1918970</a> — RESOLVED (jandem) — Use a vector instead of linked list for VirtualRegister ranges</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Sep 25 2024 00:00:53 GMT-0700 (Pacific Daylight Time)">07:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1911071">https://bugzil.la/1911071</a> — RESOLVED (jseward) — Initial tunables and heuristics for wasm lazy tiering and speculative inlining</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Sep 25 2024 00:02:35 GMT-0700 (Pacific Daylight Time)">07:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">mayankleoboy1</span>: I would be surprised if this improvement was caused by lazy tiering, since it is not enabled by default yet.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Sep 25 2024 00:19:46 GMT-0700 (Pacific Daylight Time)">07:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">mayankleoboy1</span>: thanks. We often wouldn't know about perf improvements/regressions on subtests if not for your (bug) comments</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Sep 25 2024 03:49:59 GMT-0700 (Pacific Daylight Time)">10:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mayankleoboy1:mozilla.org">mayankleoboy1</span>&gt;</div></td><td class="msg-cell">Also 25% improvement on jetstream2 - float-mm but *only* on mac (which is surprising to me) </td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Sep 25 2024 04:17:01 GMT-0700 (Pacific Daylight Time)">11:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">that is curious but I think many of these wasm tests in JetStream are micro-benchmarks so they might be more sensitive to relatively small changes</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Sep 25 2024 04:19:40 GMT-0700 (Pacific Daylight Time)">11:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">if Godot is the 9.4 MB godot.wasm file we have in tree, it might benefit from some of the other changes I have in flight because that's pretty large. Fingers crossed</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Sep 25 2024 06:55:36 GMT-0700 (Pacific Daylight Time)">13:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I'm noticing issues where I cannot execute a stencil that's decoded from a given given <code>JS::TranscodeBuffer</code> where the encoded stencil variable isn't carried over from encoding as I don't want to carry it over.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Sep 25 2024 07:01:19 GMT-0700 (Pacific Daylight Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can you describe more about what you observe?  what do you observe with "cannot execute" ?  what do you mean by "isn't carried over" ?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Sep 25 2024 07:04:02 GMT-0700 (Pacific Daylight Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>Calling this class function where I just pass in the stencil after it has been decoded in a separate function. The JSContext, global, and autorealm is all made and working way above in the call stack.</p>
<pre><code class="language-cpp">void StencilProcessor::execute(JSContext* ctx, RefPtr&lt;JS::Stencil&gt;&amp; stencil) const {
    if (stencil == nullptr) {
        LOG("Given stencil is a nullptr");
        return;
    }

    JS::InstantiateOptions opts;
    JS::RootedScript script(ctx, JS::InstantiateGlobalStencil(ctx, opts, stencil));
    if (!script) {
        LOG("RootedScript is invalid");
        return;
    }

    JS::RootedValue rval(ctx);
    if (!JS_ExecuteScript(ctx, script, &amp;rval)) {
        LOG("Unable to execute stencil");
        return;
    }
    return;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Sep 25 2024 07:07:29 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>Where the <code>RefPtr&lt;JS::Stencil&gt;</code> is initialized above this call as a fresh variable. And <code>JS::TranscodeBuffer</code> was manually initialized from reading a binary file.</p>
<pre><code class="language-cpp">void StencilProcessor::decode(JSContext* ctx, const JS::TranscodeBuffer&amp; buffer,
                                                 RefPtr&lt;JS::Stencil&gt;&amp; stencil) const {
    if (buffer.empty()) {
        LOG("Given JS::TranscodeBuffer is empty");
        return;
    }
    JS::TranscodeRange range(buffer.begin(), buffer.length());
    JS::DecodeOptions decodeOptions;

    if (JS::DecodeStencil(ctx, decodeOptions, range, getter_AddRefs(stencil)) != JS::TranscodeResult::Ok) {
        LOG("Unable to decode Stencil");
        return;
    }

    if (stencil == nullptr) {
        LOG("Decoded Stencil is a nullptr");
        return;
    }
    return;
}}
</code></pre>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Sep 25 2024 07:09:50 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">it fails on <code>JS_ExecuteScript(ctx, script, &amp;rval)</code> in <code>execute(..)</code></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Sep 25 2024 07:12:53 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay. and what do you mean with "carried over" part?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Sep 25 2024 07:13:51 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, have you checked the pending exception when <code>execute</code> fails?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Sep 25 2024 07:13:57 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">like this is thrown away <code>RefPtr&lt;JS::Stencil&gt; stencil = JS::CompileGlobalScriptToStencil(ctx, opts, source);</code> from encoding and compilation and not given to decoding and execution as I want it purely reliant on the binary files.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Sep 25 2024 07:15:55 GMT-0700 (Pacific Daylight Time)">14:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, so you don't observe the issue when you instantiate the stencil from <code>JS::CompileGlobalScriptToStencil</code>, but you observe when you instantiate the decoded stencil?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Sep 25 2024 07:16:10 GMT-0700 (Pacific Daylight Time)">14:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the pending exception would have some hint what's going on</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Sep 25 2024 07:16:15 GMT-0700 (Pacific Daylight Time)">14:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">try checking the error message</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Sep 25 2024 07:22:53 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">oh wow, i overlooked something...</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Sep 25 2024 07:23:02 GMT-0700 (Pacific Daylight Time)">14:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Yeah that exception explains things now...</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Sep 25 2024 07:26:26 GMT-0700 (Pacific Daylight Time)">14:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">good to hear that you've figured it out :)  feel free to ping me when you hit any other issue with stencil or transcoding</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Sep 25 2024 07:27:36 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">it was a very dumb issue where obviously I assumed something to have existed in the JS code but wasn't defined 🤦‍♂️</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Sep 25 2024 07:31:48 GMT-0700 (Pacific Daylight Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">haha</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Sep 25 2024 07:38:26 GMT-0700 (Pacific Daylight Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Also I wasn't sure to use <code>RefPtr&lt;JS::Stencil&gt;</code> as a reference, but I noticed it wasn't modifying the original variable without it. I assumed it was some implied pointer where I didn't need to use <code>&amp;</code>.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Sep 25 2024 07:43:05 GMT-0700 (Pacific Daylight Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the <code>Ref</code> is for reference count, where <code>RefPtr</code> manages incrementing/decrementing the reference count of the target object when adding new reference or removing reference.  if you want an out parameter, you indeed need <code>&amp;</code>.  you can also return <code>already_AddRefed&lt;JS::Stencil&gt;</code> as return value (see <a href="https://searchfox.org/mozilla-central/rev/af3eccb4999427e42fdcea558297f1cec70dc4db/mfbt/AlreadyAddRefed.h">AlreadyAddRefed.h</a> for more details) if out parameter doesn't fit</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Sep 25 2024 08:47:32 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: ping</td></tr>

</tbody></table></div></div></div>
</body></html>