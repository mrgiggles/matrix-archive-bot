<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-04-12</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-04-12<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-04-11" class="nav-link"><span>prev</span></a>
<a href="2023-04-13" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Apr 12 2023 08:55:16 GMT-0700 (Pacific Daylight Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">I'm calling JS::CallArgs.computeThis() on a proxy object. The proxy object has a BaseProxyHandler called CellProxy. ComputeThis() returns an object with class Proxy, and a prototype object of the CellProxy class. Is this expected behaviour?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Apr 12 2023 08:57:18 GMT-0700 (Pacific Daylight Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">I was assuming I'd get an object of the CellProxy class itself. I'm not sure whether this was the wrong assumption, or whether I've done something wrong to be getting back an object of the Proxy class.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Apr 12 2023 08:59:20 GMT-0700 (Pacific Daylight Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: I think <code>ComputeThis</code> will just return the <code>this</code> object, if you passed an object. It's used to convert primitives to object</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Apr 12 2023 09:01:57 GMT-0700 (Pacific Daylight Time)">16:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">In my case, the "this" object is a proxy.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Apr 12 2023 09:03:04 GMT-0700 (Pacific Daylight Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah it will return that unchanged. What kind of behavior are you looking for? unwrapping the proxy?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Apr 12 2023 09:06:03 GMT-0700 (Pacific Daylight Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">In this case, all i need to do is check if the object belongs to the right class. It's failing because it belongs to the Proxy class and not the CellProxy class, as i had expected. I can unwrap the object and then check, as you suggested. But since I'm in this situation, i was wondering if it means that I've gone wrong somewhere else.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Apr 12 2023 09:06:16 GMT-0700 (Pacific Daylight Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Sorry, this is probably a bit obscure </td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Apr 12 2023 09:15:12 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: something like <code>IsProxy(obj) &amp;&amp; GetProxyHandler(obj) == &amp;CellProxy</code> maybe?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Apr 12 2023 09:18:05 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Yes, i have a function that does exactly that, but it's failing on the object returned by ComputeThis. To make it work, i have to do GetPrototype() and the run the prototype through the same check.  Which seems weird.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Apr 12 2023 09:19:05 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>CellProxy</code> is a subclass of <code>JSObject</code>?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Apr 12 2023 09:19:28 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">how is that object being created? (The <code>this</code> object, the <code>Proxy</code> with a <code>CellProxy</code> prototype)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Apr 12 2023 09:20:24 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, you already said <code>CellProxy</code> is a <code>BaseProxyHandler</code>.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Apr 12 2023 09:23:12 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">then I'm confused. Are <code>Proxy</code> and <code>CellProxy</code> your things? They're both <code>BaseProxyHandler</code> subclasses? What is the <code>this</code> object's JSClass?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Apr 12 2023 09:29:14 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">
To create the proxy object, I'm doing this:

`````
    static const auto cellProxy = CellProxyObject();
    auto ops = js::ProxyOptions();
    ops.setClass(&amp;cellClass);
    const auto proxy = js::NewProxyObject(cx, &amp;cellProxy, JS::RootedValue(cx), nullptr, ops);
`````

`CellProxyObject` derives from `js::BaseProxyHandler`.
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Apr 12 2023 09:31:02 GMT-0700 (Pacific Daylight Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">CellProxy /CellProxyObject are my things. (I think I've been equivocating them above). By "Proxy" i mean the native JS class called "Proxy"</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Apr 12 2023 09:32:16 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I would suggest renaming your <code>CellProxyObject</code> to <code>CellProxyHandler</code>, since <code>*Object</code> things are usually <code>JSObject</code> subclasses. (Though the proxy/proxyhandler/... stuff always confuses me, so hopefully someone will chime in if I'm saying something stupid.)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Apr 12 2023 09:33:14 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">You're right. You don't even know the half of what I've named "object" !</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Apr 12 2023 09:36:19 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that looks like it should be creating an object with the default prototype. But it seems like somehow you're ending up with a <code>ProxyObject</code> with its prototype set to the return value of <code>js::NewProxyObject</code> from your code above. I can never keep track of how proxy prototypes work, or I might have an idea of where that could be happening.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Apr 12 2023 09:40:37 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">personally, I'd probably find the memory location for the proxy object's shape and watch that in rr to see where it's assigned (the shape stores the prototype). But there are probably better ways.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Apr 12 2023 09:45:12 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">I don't know this type of debugging. What is rr?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Apr 12 2023 09:50:43 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: <a href="https://rr-project.org/">https://rr-project.org/</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Apr 12 2023 09:54:30 GMT-0700 (Pacific Daylight Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I want to use private slots on binding a function to JS and I need to create a class that traces my custom memory like holding a std::function. So would I first root my class to the same context then <code>js::SetFunctionNativeReserved</code> on the rooted class instance? Will the function then own the class instance? Or will the the class instance trace/finalize/deconstruct on the c++ stack variable falling off scope or the context closing?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Apr 12 2023 09:57:45 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-13">davidj361</span>: yeah so what I said above doesn't apply to functions; you'd need to make your own class with a finalizer to hold the native allocation, and put a pointer to that in the JSFunction</blockquote></mx-reply>I'm referencing this</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Apr 12 2023 10:03:03 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: rr is probably overkill if you're just using it for this. It's also linux-only.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Apr 12 2023 10:03:16 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: trace/finalize happens on GC and is not related to stack variables going out of scope (Rooted ensures that if a GC happens while it is in scope then it is traced as a root)</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Apr 12 2023 10:04:43 GMT-0700 (Pacific Daylight Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: calling SetFunctionNativeReserved on a JS extended function object can be used to add a pointer to your custom class that holds whatever you like</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Apr 12 2023 10:05:01 GMT-0700 (Pacific Daylight Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">your class will then live at least as long as the function object</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Apr 12 2023 10:05:24 GMT-0700 (Pacific Daylight Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">traced as a root?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Apr 12 2023 10:06:31 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Do I basically have to define a class like <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr102/examples/cookbook.cpp#L705">this</a>? Haven't created a custom class</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Apr 12 2023 10:07:03 GMT-0700 (Pacific Daylight Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: where are you calling <code>computeThis</code> from? What makes you think the prototype is what has the <code>CellProxy</code> handler rather than the <code>this</code> object? (I'm asking because you said "...and a prototype object of the CellProxy class", but <code>CellProxy</code> is not a JSClass, so I'm not sure if you meant "...and a prototype object that is also a <code>ProxyObject</code> with a handler of <code>CellProxyObject</code>" or something else.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Apr 12 2023 10:13:41 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: you should be able to use JS_NewObject to create your custom class instance, you don't need all that</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Apr 12 2023 10:14:51 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">you'll need a JSClass</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Apr 12 2023 10:14:55 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Why the static here? <code>static JSClass myClass = {"MyClass", JSCLASS_HAS_RESERVED_SLOTS(2), nullptr};</code></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Apr 12 2023 10:15:46 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Most of the cookbook code has things declared as static, which I haven't understood why.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Apr 12 2023 10:20:41 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">just a habit, if it doesn't need to be used outside that file</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Apr 12 2023 10:21:53 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">^ yeah.  It probably should be const too.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Apr 12 2023 10:26:14 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-12">liam_g</span>: where are you calling <code>computeThis</code> from? What makes you think the prototype is what has the <code>CellProxy</code> handler rather than the <code>this</code> object? (I'm asking because you said "...and a prototype object of the CellProxy class", but <code>CellProxy</code> is not a JSClass, so I'm not sure if you meant "...and a prototype object that is also a <code>ProxyObject</code> with a handler of <code>CellProxyObject</code>" or something else.</blockquote></mx-reply>You're right, I've been getting ProxyHandler and Classes all mixed up. The object has a prototype of CellClass, which is a JSClass, not a BaseProxyHandler.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Apr 12 2023 10:27:34 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Give me a sec and I'll try to answer your question.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Apr 12 2023 10:48:08 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><p>So when I create and print the object like this:</p>
<p><code>const auto proxy = js::NewProxyObject(cx, &amp;cellProxy, JS::RootedValue(cx), nullptr, ops); js::DumpObject(proxy);</code></p>
<p>I get this outout:</p>
<p><code>object 254824d4d040 global 254824d3f030 [StandardGlobal] class 7ff759603fe8 cellClass handler 7ff75936a268 shape 254824d4a380 flags: maybe_has_interesting_symbol not_native proto null</code></p>
</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Apr 12 2023 10:48:30 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><p>Then from a JSNative function like this:</p>
<p><code>static bool someFunction(JSContext* cx, unsigned argc, JS::Value* vp) {  const auto args = JS::CallArgsFromVp(argc, vp); JS::RootedObject rOb(cx);      a    args.computeThis(cx, &amp;rOb); js::DumpObject(rOb); return true; }</code></p>
<p>I get this output:</p>
<p><code>object 38ec0304d510 global 38ec0303f030 [StandardGlobal] class 7ffe7b6552c0 Proxy handler 7ff7a4e09fe0 private &lt;Object at 102db4503f80&gt; shape 38ec0305b7e0 flags: maybe_has_interesting_symbol not_native proto &lt;cellClass object at 38ec0304d2e0&gt;</code></p>
</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Apr 12 2023 11:21:28 GMT-0700 (Pacific Daylight Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Meaning I'll need <code>JSCLASS_HAS_RESERVED_SLOTS(1)</code> as a field to <code>JSClass</code> and use <code>JS::SetReservedSlot</code>? Not sure how to make a finalizer and assign the dynamic memory via JSClass and JS_NewObject</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Apr 12 2023 11:29:31 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Or I need to create a function and link to it as a finalizer via a provided JSClassOps? Where I manually deconstruct the ReservedSlot with the provided finalizer function?</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Apr 12 2023 11:30:41 GMT-0700 (Pacific Daylight Time)">18:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Would it not be similar to this which you said I don't need to do? <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr102/examples/cookbook.cpp#L705">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr102/examples/cookbook.cpp#L705</a></td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Apr 12 2023 12:04:54 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">also why doesn't <a href="https://searchfox.org/mozilla-esr102/rev/e6968a2690c3ced63366d7f18b643392faa59c14/js/src/builtin/TestingFunctions.cpp#2978">this</a> complain about missing field initializers for spec, ext, and oOps? I assume it's because of compiler options being different like those warnings are disabled.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Apr 12 2023 13:07:17 GMT-0700 (Pacific Daylight Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>Do I need to do something like this?</p>
<pre><code class="language-c++">    JS::SetReservedSlot(obj, FUNC_SLOT, JS::PrivateValue(static_cast&lt;void*&gt;(new std::function&lt;Ret(Args...)&gt;(inFunc))));
    js::SetFunctionNativeReserved(JS_GetFunctionObject(func), FUNC_SLOT, JS::ObjectValue(*obj));
</code></pre>
</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Apr 12 2023 13:08:05 GMT-0700 (Pacific Daylight Time)">20:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>Where you finalize after with this?</p>
<pre><code class="language-c++">        std::function&lt;Ret(Args...)&gt;* func =
            JS::GetMaybePtrFromReservedSlot&lt;std::function&lt;Ret(Args...)&gt;&gt;(obj, FUNC_SLOT);
        delete func;
</code></pre>
</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Apr 12 2023 14:40:25 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">using <code>FUNC_SLOT</code> for both seems a little sketchy. I would probably make a <code>FUNC_SLOT</code> and use it, exactly as you did, for the <code>JS::SetReservedSlot</code> call. Then I would have a <code>FUNC_HOLDER_SLOT</code> or <code>FINALIZER_OBJ_SLOT</code> or something for the <code>js::SetFunctionNativeReserved</code> call, even if they both happen to be zero.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Apr 12 2023 14:40:42 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(I would also be tempted to use <code>auto* func = ...</code> because you've already spelled out the messy type once, but that's debatable.)</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Apr 12 2023 14:46:18 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm, actually you don't know whether the <code>js::SetFunctionNativeReserved</code> maps directly to a slot offset, so maybe it's better not to use <code>_SLOT</code> in the name. The parameter is called <code>which</code>. <code>FUNC_HOLDER_RESERVED</code>? Bleh, I don't know what to call it. You could be forgiven for just using the constant <code>0</code>. Then again, I notice that our code uses a mixture of <code>something_SLOT</code> and <code>SLOT_something</code>, so... meh, call it whatever you want, but using the same <code>FUNC_SLOT</code> for both is deceptive.</td></tr>

</tbody></table></div></div></div>
</body></html>