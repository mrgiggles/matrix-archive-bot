<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-11-15</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-11-15<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-11-14" class="nav-link"><span>prev</span></a>
<a href="2024-11-18" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Nov 15 2024 00:31:04 GMT-0800 (Pacific Standard Time)">08:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, iiuc the comments are protected data.  then we'll need to ask someone else</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Nov 15 2024 07:15:09 GMT-0800 (Pacific Standard Time)">15:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">I filed an request to get those yesterday, so hopefully I can get those data soon </td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Nov 15 2024 08:31:52 GMT-0800 (Pacific Standard Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-16">Ryan Hunt</span>: <span class="nick-2">nika</span> so I created a worker dedicated to compiling the wasm module, that the inference process runs. But when the worker calls postMessage to send it back to the main thread, I get <code>console.error: ML:EngineChild: "Could not initalize the engine" (new Error("DataCloneError: DedicatedWorkerGlobalScope.postMessage: invalid transferable array for structured clone", "chrome://global/content/ml/WASMCompile.worker.mjs", 48))</code></p>
<p>Is <code>postMessage</code> of <code>WebAssembly.Module</code> only allowed from main thread to workers? Because if I compile it from the main thread I get a CSP error.</p>
</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Nov 15 2024 08:33:13 GMT-0800 (Pacific Standard Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">lmk if you want to see the patch (I used a BasePromiseWorker with the transferrable stuff I recently added there to allow bi-directional communication)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Nov 15 2024 08:33:57 GMT-0800 (Pacific Standard Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">The message is not the Module alone, it's a more complex object comtaining the Module</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Nov 15 2024 08:35:06 GMT-0800 (Pacific Standard Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p><span class="nick-16">Ryan Hunt</span>: <span class="nick-2">nika</span> so I created a worker dedicated to compiling the wasm module, that the inference process runs. But when the worker calls postMessage to send it back to the main thread, I get <code>console.error: ML:EngineChild: "Could not initalize the engine" (new Error("DataCloneError: DedicatedWorkerGlobalScope.postMessage: invalid transferable array for structured clone", "chrome://global/content/ml/WASMCompile.worker.mjs", 48))</code></p>
<p>Is <code>postMessage</code> of <code>WebAssembly.Module</code> only allowed from main thread to workers? Because if I compile it from the main thread I get a CSP error.</p>
</blockquote></mx-reply>are you sending the WA.Module in the <code>message</code> or <code>transfer</code> part of the postMessage call?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Nov 15 2024 08:35:29 GMT-0800 (Pacific Standard Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">I can look at the patch if you'd like</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Nov 15 2024 08:35:53 GMT-0800 (Pacific Standard Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nika:mozilla.org">nika</span>&gt;</div></td><td class="msg-cell">(also I'm trying to remember what solution you ended up going with for allowing SAB in the inference process)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Nov 15 2024 08:36:02 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">let me push it</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Nov 15 2024 08:37:04 GMT-0800 (Pacific Standard Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">I think from skimming some code that the module needs to be in the message part, not the transfer part</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Nov 15 2024 08:37:49 GMT-0800 (Pacific Standard Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">It's in both (that's what I saw in some code) if not in transferrable, it chokes</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Nov 15 2024 08:38:00 GMT-0800 (Pacific Standard Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><a href="https://phabricator.services.mozilla.com/D229165">https://phabricator.services.mozilla.com/D229165</a></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Nov 15 2024 08:38:51 GMT-0800 (Pacific Standard Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">see <code>const res = new lazy.PromiseWorker.Meta([compiledModule], { transfers: [compiledModule], });</code></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Nov 15 2024 08:39:38 GMT-0800 (Pacific Standard Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">of course it would be easier to compile it directly in the main thread because that's where I'll keep it and send it around on each new worker</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Nov 15 2024 08:40:52 GMT-0800 (Pacific Standard Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nika</span>: yeah the architecture is kind of weird. the inference process starts with an empty HTML just to use the JSActor stuff, and then the Actor Child creates a chrome worker</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Nov 15 2024 08:48:18 GMT-0800 (Pacific Standard Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It's in both (that's what I saw in some code) if not in transferrable, it chokes</blockquote></mx-reply>what sort of error are you seeing if it's not in transferrable? The tests I see for postMessage of wasm module don't send it in transferrable</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Nov 15 2024 08:48:41 GMT-0800 (Pacific Standard Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">let me remove it from <code>transfers</code> and run again</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Nov 15 2024 08:48:43 GMT-0800 (Pacific Standard Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/testing/web-platform/tests/wasm/serialization/module/resources/test-incrementer.js#41">https://searchfox.org/mozilla-central/source/testing/web-platform/tests/wasm/serialization/module/resources/test-incrementer.js#41</a></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Nov 15 2024 08:49:15 GMT-0800 (Pacific Standard Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">but also I don't know how PromiseWorker.Meta is doing things, I'm not familiar with the chrome only interfaces</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Nov 15 2024 08:50:50 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">Promise.Meta is just a trick to decide how to call postMessage when using the PromiseWorker class that dispatches messages to class methods</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Nov 15 2024 08:51:42 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">that class detects if it's a Meta and converts it to a postMessage call</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Nov 15 2024 08:52:12 GMT-0800 (Pacific Standard Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/toolkit/components/promiseworker/PromiseWorker.sys.mjs#246-267">https://searchfox.org/mozilla-central/source/toolkit/components/promiseworker/PromiseWorker.sys.mjs#246-267</a></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Nov 15 2024 09:08:02 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>Storing a JS::Rooted&lt;T&gt; on the heap. It would be very easy to violate the LIFO constraint if you did this. Use JS::Heap&lt;T&gt; (see below) if you store a GC thing pointer on the heap.</p>
</blockquote>
<p>Does this mean the C++ heap? So I cannot have a unique_ptr C++ object that holds a RootedObject?</p>
</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Nov 15 2024 09:12:12 GMT-0800 (Pacific Standard Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">can't get it to work yet, the worker posts the message then nothing gets back to the main thread. I am trying to debug, but so far no luck  </td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Nov 15 2024 09:13:16 GMT-0800 (Pacific Standard Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: Correct.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Nov 15 2024 09:15:01 GMT-0800 (Pacific Standard Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If the lifetime of your heap-allocated object is guaranteed not to depend on any garbage-collected objects, then you can use PersistentRooted, which will unconditionally root something for the lifetime of the PersistentRooted.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Nov 15 2024 09:17:09 GMT-0800 (Pacific Standard Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The problem with PersistentRooted is that cycles can cause memory leaks. If your C++ object points to a JSObject that (directly or indirectly) points back to your C++ object (in a way that keeps it alive), then that cycle will never be collected even if it's otherwise unreachable.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Nov 15 2024 09:17:33 GMT-0800 (Pacific Standard Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In that case you need to look into JS::Heap&lt;T&gt; and setting up tracing methods.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Nov 15 2024 10:26:10 GMT-0800 (Pacific Standard Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nika:mozilla.org">nika</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-2">nika</span>: yeah the architecture is kind of weird. the inference process starts with an empty HTML just to use the JSActor stuff, and then the Actor Child creates a chrome worker</blockquote></mx-reply>You made a change to allow it to be considered <code>CrossOriginIsolated</code> right?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Nov 15 2024 10:26:49 GMT-0800 (Pacific Standard Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nika:mozilla.org">nika</span>&gt;</div></td><td class="msg-cell">I have a vague memory that you might've only done that for workers or something like that, and maybe the module somehow is violating the sab restrictions (this is probably nonsense)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Nov 15 2024 10:48:03 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nika</span>: that was here <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1916465">https://bugzilla.mozilla.org/show_bug.cgi?id=1916465</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Nov 15 2024 10:48:25 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">Yeah I would not mind being able to do it directly in the main thread, less back and forth :)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Nov 15 2024 11:00:11 GMT-0800 (Pacific Standard Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nika:mozilla.org">nika</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span> It might actually be something to do with the fact you're using chrome workers.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Nov 15 2024 11:00:31 GMT-0800 (Pacific Standard Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nika:mozilla.org">nika</span>&gt;</div></td><td class="msg-cell">Because a chrome worker IIRC isn't bound to a parent document, so a <code>postMessage</code> from the chrome worker probably doesn't have a proper place to go</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Nov 15 2024 11:07:40 GMT-0800 (Pacific Standard Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">Oh mmm. I will try with a normal worker</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Nov 15 2024 12:20:19 GMT-0800 (Pacific Standard Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">same behavior with a plain Worker. The postMessage() sends the data, but the main thread never gets it. (messages without Module are going through). So it seems to be specific to WebAssembly.Module it's weird because I don't get any errors or logs. I might need to on the C++ side to log.. </td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Nov 15 2024 13:32:26 GMT-0800 (Pacific Standard Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Somehow I'd not run into <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1817092">https://bugzilla.mozilla.org/show_bug.cgi?id=1817092</a> in the last 1.5 years... but wow. hazards.html is pretty awesome</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Nov 15 2024 14:51:52 GMT-0800 (Pacific Standard Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I have a patch that stops compressing it, so that you can go to it straight from the artifacts pane.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Nov 15 2024 14:52:05 GMT-0800 (Pacific Standard Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">at least, I don't think I pushed that yet</td></tr>

</tbody></table></div></div></div>
</body></html>