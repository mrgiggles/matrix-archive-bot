<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-02-13</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-02-13<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-02-12" class="nav-link"><span>prev</span></a>
<a href="2024-02-14" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Feb 12 2024 20:32:48 GMT-0800 (Pacific Standard Time)">04:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ptomato:gnome.org">ptomato</span>&gt;</div></td><td class="msg-cell">if anyone has time to do a review of <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/75">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/75</a> - it's been open for a while and there are definitely some questions about how to use ClearKeptObjects in embeddings, that I'm not sure how to answer!</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Feb 12 2024 22:58:39 GMT-0800 (Pacific Standard Time)">06:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm looking into it, but it can take some time investigating the API</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Feb 13 2024 00:05:33 GMT-0800 (Pacific Standard Time)">08:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">posted comments</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Feb 13 2024 10:51:28 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">hi all -- I'm trying to re-enliven a SpiderMonkey build after three months away and hitting a "libclang is too old" error. I've blown away <code>~/.mozbuild</code> and done a <code>./mach clobber</code>, and checked that I'm at a recent checkout and nothing else is dirty. <code>./mach build</code> keeps downloading the same version of libclang (<code>7529fab0fd8b7596-clang.tar.zst</code> in <code>~/.mozbuild/toolchains</code>). Feels sort of silly I can't get this to work; does my system LLVM version perhaps influence things (I'm on Ubuntu 20.04 LTS)? Any thoughts?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Feb 13 2024 12:23:07 GMT-0800 (Pacific Standard Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">anything weird about your mozconfig?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Feb 13 2024 12:23:54 GMT-0800 (Pacific Standard Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe try <code>mach bootstrap</code>? Though it seems like it's already installing a clang for you in ~/.mozbuild</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Feb 13 2024 12:24:23 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell"><pre><code>% cat mozconfig
# Build only the SpiderMonkey JS test shell
ac_add_options --enable-project=js
</code></pre>
<p>and I've re-<code>bootstrap</code>'d already too</p>
</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Feb 13 2024 12:24:24 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">your system LLVM <em>shouldn't</em> interfere</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Feb 13 2024 12:24:43 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">I'll try a fresh clone next to see if there's any hidden state</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Feb 13 2024 12:26:36 GMT-0800 (Pacific Standard Time)">20:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">cfallin</span>: Welcome back!</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Feb 13 2024 12:26:50 GMT-0800 (Pacific Standard Time)">20:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: thanks!</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Feb 13 2024 12:35:29 GMT-0800 (Pacific Standard Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">cfallin</span>: maybe post the build output? (You can use <code>mach pastebin</code> or whatever.) Specifically, I'm looking at these lines of my build output:<br><code>checking for the target C++ compiler... /home/sfink/.mozbuild/clang/bin/clang++</code><br><code>checking for libclang for bindgen... /home/sfink/.mozbuild/clang/lib/<a href="http://libclang.so">libclang.so</a></code></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Feb 13 2024 12:35:52 GMT-0800 (Pacific Standard Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(that 2nd is probably just before the failure you get from <code>checking that libclang is new enough...</code>)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Feb 13 2024 12:37:48 GMT-0800 (Pacific Standard Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I seem to have <code>3a07d81d13248b8a-clang.tar.zst</code>, though I'm not sure how to tell which one it's actually using</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Feb 13 2024 12:38:25 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and <code>f249c9fba4d589ea-cbindgen.tar.zst</code></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Feb 13 2024 13:08:28 GMT-0800 (Pacific Standard Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">I have a bunch of JSStrings I'd like to allocate all at once, such as for storing in an array or Vector. Is there a way to do that, or will I have to allocate them individually?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Feb 13 2024 13:11:56 GMT-0800 (Pacific Standard Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(I don't 100% follow the use case; maybe elaborate a bit, doubly so about what cost you're trying to avoid; my intuition says you're going to have to do this individually, but perhaps with the usage someone else has something clever)</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Feb 13 2024 13:15:52 GMT-0800 (Pacific Standard Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: here's the failing build, after a clobber and an <code>rm -r ~/.mozbuild</code>: <a href="https://paste.mozilla.org/HtXd139c">https://paste.mozilla.org/HtXd139c</a> (seems to fetch <code>ff65ffd749ff7d7d-clang.tar.zst</code> now)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Feb 13 2024 13:16:39 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">this is on an up-to-date commit (<code>90cdd721</code> from mozilla/gecko-dev mirror, commit from today)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Feb 13 2024 13:22:06 GMT-0800 (Pacific Standard Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">mysterious. Here's where I should probably redirect you to @glandium on #build but what do you get for <code>nm ~/.mozbuild/clang/lib/<a href="http://libclang.so">libclang.so</a> | grep getAddressSpace</code>?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Feb 13 2024 13:26:18 GMT-0800 (Pacific Standard Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-12">sfink</span>:</p>
<pre><code>% nm ~/.mozbuild/clang/lib/libclang.so | grep getAddressSpace
00000000012e08e0 T clang\_getAddressSpace
000000000130be60 t \_ZNK5clang10ASTContext21getTargetAddressSpaceENS\_6LangASE
% nm ~/.mozbuild/clang/lib/libclang.so | grep getAddressSpace | c++filt
00000000012e08e0 T clang\_getAddressSpace
000000000130be60 t clang::ASTContext::getTargetAddressSpace(clang::LangAS) const
</code></pre>
</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Feb 13 2024 13:27:56 GMT-0800 (Pacific Standard Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Huh. The C symbol <code>clang_getAddressSpace</code> is exactly <a href="https://searchfox.org/mozilla-central/source/build/moz.configure/bindgen.configure#290-296">what it's looking for</a>  when testing whether libclang is new enough</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Feb 13 2024 13:29:31 GMT-0800 (Pacific Standard Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if you want to dig into it, maybe print out the text of the python exception for that failure? Maybe something stupid is going wrong.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Feb 13 2024 13:30:02 GMT-0800 (Pacific Standard Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">ok, cool, I'll dig further, this is good direction at least</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Feb 13 2024 13:30:02 GMT-0800 (Pacific Standard Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but really this is looking like a <a href="https://matrix.to/#/#build:mozilla.org">#build:mozilla.org</a>  problem</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Feb 13 2024 13:30:03 GMT-0800 (Pacific Standard Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Feb 13 2024 13:35:20 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it might have something to do with the line <code>if os.getlogin() == 'cfallin': throw Exception("unwanted")</code> but I doubt it</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Feb 13 2024 13:35:48 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">standard addition for anyone who leaves the team I guess <em>shrug</em></td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Feb 13 2024 13:54:17 GMT-0800 (Pacific Standard Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-12">sfink</span>: I think I've got it narrowed down:</p>
<pre><code>% ldd ~/.mozbuild/clang/lib/libclang.so
ldd: $warning: you do not have execution permission for `/home/cfallin/.mozbuild/clang/lib/libclang.so'
        linux-vdso.so.1 (0x00007ffc4c653000)
        libdl.so.2 =&gt; /nix/store/j6mwswpa6zqhdm1lm2lv9iix3arn774g-glibc-2.38-27/lib/libdl.so.2 (0x00007fe9b5d6c000)
        libLLVM-17.so =&gt; /home/cfallin/.mozbuild/clang/lib/../lib/libLLVM-17.so (0x00007fe9af400000)
        libstdc++.so.6 =&gt; not found
        libm.so.6 =&gt; /nix/store/j6mwswpa6zqhdm1lm2lv9iix3arn774g-glibc-2.38-27/lib/libm.so.6 (0x00007fe9b5c8c000)
        libgcc_s.so.1 =&gt; /nix/store/fhws3x2s9j5932r6ah660nsh41bkrq27-xgcc-12.3.0-libgcc/lib/libgcc_s.so.1 (0x00007fe9b5c6b000)
        libc.so.6 =&gt; /nix/store/j6mwswpa6zqhdm1lm2lv9iix3arn774g-glibc-2.38-27/lib/libc.so.6 (0x00007fe9af218000)
        /nix/store/j6mwswpa6zqhdm1lm2lv9iix3arn774g-glibc-2.38-27/lib64/ld-linux-x86-64.so.2 (0x00007fe9b5d73000)
        librt.so.1 =&gt; /nix/store/j6mwswpa6zqhdm1lm2lv9iix3arn774g-glibc-2.38-27/lib/librt.so.1 (0x00007fe9b5c64000)
        libpthread.so.0 =&gt; /nix/store/j6mwswpa6zqhdm1lm2lv9iix3arn774g-glibc-2.38-27/lib/libpthread.so.0 (0x00007fe9b5c5f000)
        libz.so.1 =&gt; not found
        libxml2.so.2 =&gt; not found
        libstdc++.so.6 =&gt; not found
</code></pre>
<p>this is "idealistic developer adopts Nix and his life gets Interesting" territory; sorry for the trouble :-)</p>
</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Feb 13 2024 14:41:50 GMT-0800 (Pacific Standard Time)">22:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (I don't 100% follow the use case; maybe elaborate a bit, doubly so about what cost you're trying to avoid; my intuition says you're going to have to do this individually, but perhaps with the usage someone else has something clever)</blockquote></mx-reply>I have about 500 JSStrings to allocate. If I can do that with a single allocation, that would be faster than 500 allocations. Is there a convenient way to allocate them all together?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Feb 13 2024 15:03:01 GMT-0800 (Pacific Standard Time)">23:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: Strings are garbage-collected individually, so in general you can't store them in a single allocation (or else how would you free a single string?)</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Feb 13 2024 15:04:17 GMT-0800 (Pacific Standard Time)">23:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you have a strong reason to believe that they'll all have a similar lifetime, I guess you could make one long backing string and a bunch of dependent strings pointing to that, but you still need to do a nursery allocation for the dependent string itself, so it's not clear that wins you anything</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Feb 13 2024 15:06:17 GMT-0800 (Pacific Standard Time)">23:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Yeah, that wouldn't win me anything ☹️
Oh well</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Feb 13 2024 15:07:23 GMT-0800 (Pacific Standard Time)">23:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Nursery allocations are pretty cheap</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Feb 13 2024 15:09:13 GMT-0800 (Pacific Standard Time)">23:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: do you do anything special to get builds to work on NixOS? (See <span class="nick-3">cfallin</span> 's problem ^ )</td></tr>

</tbody></table></div></div></div>
</body></html>