<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-03-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-03-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-03-06" class="nav-link"><span>prev</span></a>
<a href="2025-03-09" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Mar 06 2025 16:13:52 GMT-0800 (Pacific Standard Time)">00:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, I should at least try squeezing in a quick patch for that, using some randomly chosen threshold.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Mar 06 2025 16:16:10 GMT-0800 (Pacific Standard Time)">00:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I could imagine un-depending these only during tenuring, except that the straightforward implementation would then need the following major GC to free the big string, which would be unfortunate.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Mar 06 2025 17:27:08 GMT-0800 (Pacific Standard Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">The hard part turns out to be adjusting the byteSize-of-string test to add in the new cases.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Mar 07 2025 02:33:39 GMT-0800 (Pacific Standard Time)">10:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><p>can it so happen that <code>masm.fallibleUnboxBoolean(</code> can behave differently in in Baseline compiler and baseline interpreter, I have code like this</p>
<p>in BaselineCompiler:</p>
<pre><code>case JS::ValueType::Boolean: {
      bool val = data.toBoolean();
      Register boolUnboxed = R1.scratchReg();
      masm.fallibleUnboxBoolean(value, boolUnboxed,
                                op == JSOp::StrictEq ? &amp;fail : &amp;pass);
      masm.branch32(JSOpToCondition(op, true), boolUnboxed, Imm32(val), &amp;pass);
      masm.jump(&amp;fail);
      break;
    }
</code></pre>
<p>and in BaselineInterpreter:</p>
<pre><code>
  masm.bind(&amp;isBool);
  {
    Register boolUnboxed = R1.scratchReg();
    masm.fallibleUnboxBoolean(value, boolUnboxed,
                              op == JSOp::StrictEq ? &amp;fail : &amp;pass);
    masm.branch32(JSOpToCondition(op, true), boolUnboxed, payload, &amp;pass);
    masm.jump(&amp;fail);
  }

</code></pre>
<p>for the case of val === true where say val = 1 it works correct in baseline interpreter but in baseline compiler it does seem to unbox the integer to a boolean? (checked with masm.printf) ðŸ˜…ðŸ˜…ðŸ˜…</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Mar 07 2025 03:55:48 GMT-0800 (Pacific Standard Time)">11:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">debadree25</span>: in which situation does it happen? for example, what's op?  and what's the exact value bit pattern?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Mar 07 2025 04:07:09 GMT-0800 (Pacific Standard Time)">12:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell"><p>hmm its a new set of ops i am working on in <a href="https://phabricator.services.mozilla.com/D238660">https://phabricator.services.mozilla.com/D238660</a> its caused by a test case like this:</p>
<pre><code>function f(i) {
  return i === true;
}

console.log(f(true));
console.log(f(1));

let res;
for (let i = 0; i &lt; 1e6; i++) {
  res = f(1);
}
console.log(res);

console.log(f(true));
console.log(f(1));

</code></pre>
<p>where f(1) is returning true, i confirmed that that the code is indeed generated for JS::ValueType::Boolean and the encoding of constants and everything is correct it just that when baseline compiled it gives this wrong result but is correct in baseline interpreter</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Mar 07 2025 04:12:26 GMT-0800 (Pacific Standard Time)">12:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">debadree25</span>: have you checked the behavior with disabling each JIT layers?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Mar 07 2025 04:13:15 GMT-0800 (Pacific Standard Time)">12:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">locally, the behavior looks correct with <code>--no-ion</code>.  so I wonder if it's caused by Ion/warp layer, instead of baseline</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Mar 07 2025 04:14:42 GMT-0800 (Pacific Standard Time)">12:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">Try running with <code>--no-blinterp</code>, <code>--blinterp-eager</code>, <code>--no-baseline</code>, <code>--baseline-eager</code>, <code>--no-ion</code>, and <code>--ion-eager</code> options</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Mar 07 2025 04:15:36 GMT-0800 (Pacific Standard Time)">12:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">oh hmm i thought i was noticing it having wrong behaviour by printing out thing in baseline, let me check out using each of the flags</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Mar 07 2025 04:36:13 GMT-0800 (Pacific Standard Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">at least <code>Compare_Int32</code> in <code>WarpBuilder::buildStrictConstantEqOp</code> looks suspicious.    the <a href="https://searchfox.org/mozilla-central/rev/912300ad871cef38b8ab948a410510cab714b547/js/src/jit/MIR.h#2727-2729">definition</a> says <code>Int32   compared to Int32</code> and <code>Boolean compared to Boolean</code>.    it doesn't say anything about different combination</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Mar 07 2025 04:36:48 GMT-0800 (Pacific Standard Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, iiuc, there should be a typecheck against the <code>value</code></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Mar 07 2025 04:58:06 GMT-0800 (Pacific Standard Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">yes indeed there should be unbox instruction which i missed thats why i guess no unboxing being done in case of booleans </td></tr>

</tbody></table></div></div></div>
</body></html>