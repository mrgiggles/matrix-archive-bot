<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-10-28</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-10-28<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-10-27" class="nav-link"><span>prev</span></a>
<a href="2024-10-29" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Oct 28 2024 07:18:08 GMT-0700 (Pacific Daylight Time)">14:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: Hi! Am I right when I suspect that there's no way to unload ESMs like <a href="https://searchfox.org/mozilla-central/rev/b655023a1978bcad8cc2fb038b89a058b45e91a7/js/xpconnect/idl/xpccomponents.idl#362-373">there is for JSMs</a>? And is there a reason why we wouldn't want to introduce an <code>unload</code> for ESMs? I ask, because I'm investigating going down the route of (once again) packaging up the New Tab code as a bundled privileged WebExtension... New Tab makes heavy use of ESMs, and I'm wondering how updating those ESMs (basically hotswapping) at runtime is going to work.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Oct 28 2024 07:19:10 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">Because this feels like one of the trickier parts of this proposal - runtime upgrade.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Oct 28 2024 07:19:37 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, unload is not supported. the reason is that the standard ESM itself has no concept of unload</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Oct 28 2024 07:20:48 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">iiuc, some part of the code emulates upgrade by adding query to the ESM's URL</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Oct 28 2024 07:21:05 GMT-0700 (Pacific Daylight Time)">14:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">Oh that's interesting</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Oct 28 2024 07:21:49 GMT-0700 (Pacific Daylight Time)">14:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">Do you remember where we do that? I'd love to see that.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Oct 28 2024 07:22:21 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">somewhere around XPI things</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Oct 28 2024 07:22:35 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">And I guess in that case, we keep the old parsed ESMs in memory until restart, even though they're no longer going to be used?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Oct 28 2024 07:23:02 GMT-0700 (Pacific Daylight Time)">14:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, the old one is kept</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Oct 28 2024 07:23:30 GMT-0700 (Pacific Daylight Time)">14:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">one of the case I saw was only about automated testing.  so that part doesn't expect long lifetime</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Oct 28 2024 07:24:18 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">I see, okay</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Oct 28 2024 07:24:41 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">This I guess?: <a href="https://searchfox.org/mozilla-central/rev/b655023a1978bcad8cc2fb038b89a058b45e91a7/services/settings/test/unit/test_remote_settings_release_prefs.js#6">https://searchfox.org/mozilla-central/rev/b655023a1978bcad8cc2fb038b89a058b45e91a7/services/settings/test/unit/test_remote_settings_release_prefs.js#6</a></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Oct 28 2024 07:24:42 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/b655023a1978bcad8cc2fb038b89a058b45e91a7/toolkit/mozapps/extensions/internal/AddonTestUtils.sys.mjs#206-233">AddonTestUtils.sys.mjs</a>  this does a kind of "reload"</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Oct 28 2024 07:25:12 GMT-0700 (Pacific Daylight Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, that one also looks like doing similar thing</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Oct 28 2024 07:25:34 GMT-0700 (Pacific Daylight Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">I guess in this model, I could append some kind of build ID as the suffix</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Oct 28 2024 07:26:22 GMT-0700 (Pacific Daylight Time)">14:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, that sounds reasonable</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Oct 28 2024 07:27:00 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">Okay, thank you!</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Oct 28 2024 07:28:12 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">willdurand</span>: The mozExtensionHostname doesn't get regenerated each time a WebExtension updates, right?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Oct 28 2024 07:34:37 GMT-0700 (Pacific Daylight Time)">14:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@willdurand:mozilla.org">willdurand</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">mconley</span>: yes, it's the same uuid as long as the extension is installed</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Oct 28 2024 07:38:20 GMT-0700 (Pacific Daylight Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@mconley:mozilla.org">mconley</span>&gt;</div></td><td class="msg-cell">Okay, thanks!</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Oct 28 2024 10:47:39 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">so I lando'd a big PBL patchset and appear to have broken some non-PBL builds because of a missing ifdef (sorry!) -- could someone review this real quick? <a href="https://phabricator.services.mozilla.com/D227067">https://phabricator.services.mozilla.com/D227067</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Oct 28 2024 10:51:42 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">cfallin</span>: stamped</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Oct 28 2024 10:52:39 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">thanks very much!</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Oct 28 2024 14:04:03 GMT-0700 (Pacific Daylight Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: do we have ways to do only marking, but not sweeping. Thinking about the CC related marking especially here.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Oct 28 2024 14:07:38 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">there are some types that don't do anything for sweeping, but that's not what you're talking about. But there's nothing that forces sweeping to have to happen. Mark-only would be straightforward, I think?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Oct 28 2024 14:16:59 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'm just thinking ways to get the marking bits updated right before CC</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Oct 28 2024 14:36:35 GMT-0700 (Pacific Daylight Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">right. When working on the worker gc scheduling, it seemed like it would be nice to drive the decision to compact or not based on how many allocations the GC heap has seen. Similarly, if there hasn't been a lot of JS heap activity, I could definitely see value in doing a mark-only GC for the CC. It'd save less than half the time, but I've seen quite a few situations where we keep doing GCs that don't collect much of anything.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Oct 28 2024 14:37:34 GMT-0700 (Pacific Daylight Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we don't have a direct signal for garbage creation like refcounting does (the number of decrefs)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Oct 28 2024 15:20:39 GMT-0700 (Pacific Daylight Time)">22:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'm mostly thinking this in context of sp3, which is generating garbage as fast as possible. So there are lots of subtest runs between the start of a GC and start of the next CC</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Oct 28 2024 16:17:24 GMT-0700 (Pacific Daylight Time)">23:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Oh, interesting. My usual test GCs have sweep time well under 1% of total GC time. On my sp3 run, sweep time is 97% of the total major GC time.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Oct 28 2024 16:24:35 GMT-0700 (Pacific Daylight Time)">23:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I mean, we also collect 152MB total over the sp3 run (heap max size is 218MB). So we still want to collect <em>sometimes</em>.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Oct 28 2024 16:32:07 GMT-0700 (Pacific Daylight Time)">23:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">we want to collect more often, I think</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Oct 28 2024 16:35:14 GMT-0700 (Pacific Daylight Time)">23:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">collect as in, CC or GC? I thought you wanted more CC, less GC</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Oct 28 2024 16:37:41 GMT-0700 (Pacific Daylight Time)">23:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I want more both, I think, and faster. Or combine them somehow. Run GC marking, then CC, during which CC marks JS garbage with some flag (or does some kind of minor marking) and then sweep GC things</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Oct 28 2024 16:42:08 GMT-0700 (Pacific Daylight Time)">23:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm trying to get my head around "marking JS garbage". We don't really do much with things we know are dead, only with things we know are live.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Oct 28 2024 16:44:27 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">yeah, it would need to be something a bit different. Somehow tell to GC that from CC point of view certain GCthings are garbage </td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Oct 28 2024 16:44:30 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">So GC marking would produce a set of mark bits where the white things are definitely dead, the gray things are maybe dead. CC would mark some gray things white. Then we do a GC sweep to throw out white.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Oct 28 2024 16:50:54 GMT-0700 (Pacific Daylight Time)">23:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I guess I could try first some kind of extra marking right before CC</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Oct 28 2024 16:51:26 GMT-0700 (Pacific Daylight Time)">23:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I should try first just extra sync GC right before the first CC slice. Totally unrealistic, but easy to test</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Oct 28 2024 16:55:24 GMT-0700 (Pacific Daylight Time)">23:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we have code already for "resetting" an incremental GC. It would probably just be a matter of arranging for <code>abortSweepAfterCurrentGroup</code> to be set to true at the beginning of sweeping, and then it'll cancel the whole GC without sweeping. So it might not be too hard to prototype a mark-only GC.</td></tr>

</tbody></table></div></div></div>
</body></html>