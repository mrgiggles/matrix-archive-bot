<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-01-19</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-01-19<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-01-18" class="nav-link"><span>prev</span></a>
<a href="2023-01-20" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Jan 18 2023 17:42:23 GMT-0800 (Pacific Standard Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: we seem to spend noticeably more time in the kernel than d8</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Jan 18 2023 17:42:37 GMT-0800 (Pacific Standard Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">what sort of syscalls?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Jan 18 2023 17:42:51 GMT-0800 (Pacific Standard Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">malloc, mprotect, other?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Jan 18 2023 17:43:13 GMT-0800 (Pacific Standard Time)">01:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><a href="https://share.firefox.dev/3J3MQ2l">https://share.firefox.dev/3J3MQ2l</a></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Jan 18 2023 17:44:09 GMT-0800 (Pacific Standard Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">page faults and mmap I think</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Jan 18 2023 17:45:01 GMT-0800 (Pacific Standard Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: actually this shows it well: <a href="https://share.firefox.dev/3XIX9wS">https://share.firefox.dev/3XIX9wS</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Jan 18 2023 17:45:25 GMT-0800 (Pacific Standard Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">46% page faults</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jan 18 2023 17:45:33 GMT-0800 (Pacific Standard Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">15% mprotect</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jan 18 2023 17:45:45 GMT-0800 (Pacific Standard Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">7.6% madvise</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jan 18 2023 17:47:02 GMT-0800 (Pacific Standard Time)">01:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">interesting...</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jan 18 2023 17:52:33 GMT-0800 (Pacific Standard Time)">01:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">In a way it seems like we are churning memory in and out of the process much faster rather than managing free pools</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jan 18 2023 17:52:55 GMT-0800 (Pacific Standard Time)">01:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jan 18 2023 17:53:13 GMT-0800 (Pacific Standard Time)">01:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">I will try disabling jemalloc</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jan 18 2023 17:53:45 GMT-0800 (Pacific Standard Time)">01:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">this could also be GC memory</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jan 18 2023 17:53:57 GMT-0800 (Pacific Standard Time)">01:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">this interleaved kernel/js profile is nice</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jan 18 2023 17:54:07 GMT-0800 (Pacific Standard Time)">01:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">how is GC memory allocated?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Jan 18 2023 17:54:21 GMT-0800 (Pacific Standard Time)">01:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">with malloc or something else?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Jan 18 2023 17:54:52 GMT-0800 (Pacific Standard Time)">01:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">something else</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jan 18 2023 17:57:26 GMT-0800 (Pacific Standard Time)">01:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">ah good, sfink has better answers</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jan 18 2023 17:57:28 GMT-0800 (Pacific Standard Time)">01:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">a custom allocator on top of mmap (on linux, osx)</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jan 18 2023 17:58:47 GMT-0800 (Pacific Standard Time)">01:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">do we have a free-pool of chunks?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jan 18 2023 18:00:17 GMT-0800 (Pacific Standard Time)">02:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">here's a view of where we're page faulting: <a href="https://share.firefox.dev/3XnLpzN">https://share.firefox.dev/3XnLpzN</a></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jan 18 2023 18:02:15 GMT-0800 (Pacific Standard Time)">02:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">it seems like a lot of it gcish stuff</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jan 18 2023 18:04:48 GMT-0800 (Pacific Standard Time)">02:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">under what conditions would jit code be faulting?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jan 18 2023 18:06:29 GMT-0800 (Pacific Standard Time)">02:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">I guess when it does an object allocation it will touch fresh pages for the first time?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jan 18 2023 18:06:49 GMT-0800 (Pacific Standard Time)">02:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, we have a free list, that goes through a lifecycle of being decommited, released, etc.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jan 18 2023 18:08:15 GMT-0800 (Pacific Standard Time)">02:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yeah, jitcode can setup gc objects directly after getting new pages</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jan 18 2023 18:08:56 GMT-0800 (Pacific Standard Time)">02:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think that looks like a new <code>JitCode*</code>, which is a GC object itself.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Jan 18 2023 18:09:02 GMT-0800 (Pacific Standard Time)">02:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(sorry, only half here)</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Jan 18 2023 18:11:04 GMT-0800 (Pacific Standard Time)">02:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><p>here's an example piece of assembly that's faulting:</p>
<pre><code>mov rdx, -0x6800000000000
mov qword [rax + 0x18], rdx
mov qword [rax + 0x20], rdx
mov qword [rax + 0x28], rdx
mov qword [rax + 0x30], rdx
mov qword [rax + 0x38], rdx
mov qword [rax + 0x40], rdx
mov qword [rax + 0x48], rdx
</code></pre>
</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Jan 18 2023 18:11:43 GMT-0800 (Pacific Standard Time)">02:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">is <code>-0x6800000000000</code> special?</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Jan 18 2023 18:11:51 GMT-0800 (Pacific Standard Time)">02:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">probably UndefinedValue</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Jan 18 2023 18:12:08 GMT-0800 (Pacific Standard Time)">02:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't think it is</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Jan 18 2023 18:12:22 GMT-0800 (Pacific Standard Time)">02:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Boxed values start with ff</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Jan 18 2023 18:12:34 GMT-0800 (Pacific Standard Time)">02:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, wait, -0x68</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Jan 18 2023 18:12:38 GMT-0800 (Pacific Standard Time)">02:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">"-" </td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Jan 18 2023 18:12:48 GMT-0800 (Pacific Standard Time)">02:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yeah, assembly views are weird</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Jan 18 2023 18:13:06 GMT-0800 (Pacific Standard Time)">02:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">0xfff9800000000000</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Jan 18 2023 18:13:17 GMT-0800 (Pacific Standard Time)">02:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, that's undef</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Jan 18 2023 18:13:51 GMT-0800 (Pacific Standard Time)">02:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">so the faults there make a lot of sense then? we're basically initializing some object?</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Jan 18 2023 18:15:38 GMT-0800 (Pacific Standard Time)">02:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Probably comes from here: <a href="https://searchfox.org/mozilla-central/source/js/src/jit/MacroAssembler.cpp#474-477">https://searchfox.org/mozilla-central/source/js/src/jit/MacroAssembler.cpp#474-477</a></td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Jan 18 2023 18:15:44 GMT-0800 (Pacific Standard Time)">02:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">Does it makes sense that <code>NewCallObject</code> and <code>Lambda</code> ops would be the ones faulting?</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Jan 18 2023 18:16:54 GMT-0800 (Pacific Standard Time)">02:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#7238">NewCallObject</a> and <a href="https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#3532">Lambda</a> both generate code to allocate objects</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Jan 18 2023 18:17:45 GMT-0800 (Pacific Standard Time)">02:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But that's a hint that maybe we could do better with calls</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Jan 18 2023 18:18:06 GMT-0800 (Pacific Standard Time)">02:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: do we have any knobs that control how aggressively we return pages to the OS?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Jan 18 2023 18:18:11 GMT-0800 (Pacific Standard Time)">02:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In particular with closures</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Jan 18 2023 18:20:00 GMT-0800 (Pacific Standard Time)">02:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">the code in question is the self hosted implementation of <code>bind</code>.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Jan 18 2023 18:20:26 GMT-0800 (Pacific Standard Time)">02:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">it's the 5th hotest function</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Jan 18 2023 18:20:27 GMT-0800 (Pacific Standard Time)">02:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">An item floating around near the bottom of my todo list has just made a sudden rise</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Jan 18 2023 18:20:39 GMT-0800 (Pacific Standard Time)">02:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This is very useful information</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Jan 18 2023 18:20:39 GMT-0800 (Pacific Standard Time)">02:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">but only takes 1.8% of the time</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Jan 18 2023 18:21:19 GMT-0800 (Pacific Standard Time)">02:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Admittedly that item was just "look at function.bind")</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Jan 18 2023 18:21:28 GMT-0800 (Pacific Standard Time)">02:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">ðŸ™‚</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Jan 18 2023 18:22:09 GMT-0800 (Pacific Standard Time)">02:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">about 15% of the time in function.bind is page faulting</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Jan 18 2023 18:41:26 GMT-0800 (Pacific Standard Time)">02:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: this is running <a href="https://github.com/jrmuizel/Speedometer/blob/shell-react-todomvc/resources/todomvc/architecture-examples/react/index.js">https://github.com/jrmuizel/Speedometer/blob/shell-react-todomvc/resources/todomvc/architecture-examples/react/index.js</a> which is a shell version of the first section of react-todomvc</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Jan 18 2023 18:46:57 GMT-0800 (Pacific Standard Time)">02:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-12">sfink</span>: do we have any knobs that control how aggressively we return pages to the OS?</blockquote></mx-reply>There are prefs (or in the shell, GC parameters) that control the minimum and maximum number of empty 1MB chunks we have lying around. We also skip decommitting empty chunks if the allocation rate is high, and the thresholds for what counts as high are controllable.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Jan 18 2023 18:47:35 GMT-0800 (Pacific Standard Time)">02:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/daf613efc5c358f3a94961d73b90472c00703838/js/public/GCAPI.h#254-270">empty chunk min/max controls</a></td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Jan 18 2023 18:49:45 GMT-0800 (Pacific Standard Time)">02:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think <a href="https://searchfox.org/mozilla-central/rev/daf613efc5c358f3a94961d73b90472c00703838/js/public/GCAPI.h#155-162">javascript.options.mem.gc_high_frequency_time_limit_ms</a> controls whether we decide we're in high frequency gc mode</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Jan 18 2023 18:51:38 GMT-0800 (Pacific Standard Time)">02:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so maybe bumping up JSGC_MAX_EMPTY_CHUNK_COUNT to something really high might be interesting?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Jan 18 2023 18:53:51 GMT-0800 (Pacific Standard Time)">02:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in the shell, <code>gcparam("maxEmptyChunkCount", 10000)</code> ought to do it.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Jan 18 2023 19:16:14 GMT-0800 (Pacific Standard Time)">03:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: thanks</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Jan 19 2023 09:20:33 GMT-0800 (Pacific Standard Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">When converting an <code>enum class</code> to SpiderMonkey, should I just convert it to its underlying type then to the SpiderMonkey equivalent primitive?</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Jan 19 2023 09:21:47 GMT-0800 (Pacific Standard Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I'm already doing so but wasn't sure if that's incorrect where SpiderMonkey has a <code>enum class</code> equivalent</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Jan 19 2023 09:35:20 GMT-0800 (Pacific Standard Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">The basic approach will be to store it as an int32. That won't give you a string &lt;-&gt; enum value at all, but you'll have to do that separately if you want it.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Jan 19 2023 09:35:38 GMT-0800 (Pacific Standard Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"> Gecko's webidl bindings generator does a bunch of extra stuff.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Jan 19 2023 09:37:22 GMT-0800 (Pacific Standard Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">an example fragment is <a href="https://searchfox.org/mozilla-central/source/__GENERATED__/__linux64__/dom/bindings/ChromeUtilsBinding.cpp#57-95">https://searchfox.org/mozilla-central/source/__GENERATED__/__linux64__/dom/bindings/ChromeUtilsBinding.cpp#57-95</a></td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Jan 19 2023 09:38:06 GMT-0800 (Pacific Standard Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and <a href="https://searchfox.org/mozilla-central/source/__GENERATED__/__linux64__/dist/include/mozilla/dom/ChromeUtilsBinding.h#86-103">https://searchfox.org/mozilla-central/source/__GENERATED__/__linux64__/dist/include/mozilla/dom/ChromeUtilsBinding.h#86-103</a></td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Jan 19 2023 09:38:50 GMT-0800 (Pacific Standard Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I thought there was a string -&gt; id lookup generated somehow, but I'm not seeing it.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Jan 19 2023 12:48:31 GMT-0800 (Pacific Standard Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: that's ReactElement.createElement before and after your <code>for in</code> changes</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Jan 19 2023 12:50:42 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: Yeah, that looks correct. We are adding a fastpath guarded by IteratorHasIndicesAndBranch</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Jan 19 2023 12:51:09 GMT-0800 (Pacific Standard Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Hopefully performance is better?</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Jan 19 2023 12:54:30 GMT-0800 (Pacific Standard Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">have not tried to measure it yet</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Jan 19 2023 12:56:59 GMT-0800 (Pacific Standard Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Doug said it looks like Matrix React is hovering around 3-4% faster</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Jan 19 2023 12:57:24 GMT-0800 (Pacific Standard Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Not sure where he was measuring that</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Jan 19 2023 12:58:29 GMT-0800 (Pacific Standard Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Does anyone know if there is a way to share JSObjects between different JSContexts?</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Jan 19 2023 12:59:28 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: I just ran the test cases from here: <a href="https://benediktmeurer.de/2017/09/07/restoring-for-in-peak-performance/">https://benediktmeurer.de/2017/09/07/restoring-for-in-peak-performance/</a></td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Jan 19 2023 12:59:41 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">it does not seem like performance was improved by your patch</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Jan 19 2023 13:04:46 GMT-0800 (Pacific Standard Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, right. My optimization only kicks in when we see a variety of object shapes, and in those microbenchmarks there's only one shape</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Jan 19 2023 13:05:11 GMT-0800 (Pacific Standard Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In the real world I think that probably shouldn't matter much, but maybe I should try fixing it anyway</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Jan 19 2023 13:06:12 GMT-0800 (Pacific Standard Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: maybe at least have a bug on file about it</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Jan 19 2023 13:06:21 GMT-0800 (Pacific Standard Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">it may not matter much</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Jan 19 2023 13:07:53 GMT-0800 (Pacific Standard Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: would it be easy to know when the optimization could fire but isn't currently?</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Jan 19 2023 13:08:56 GMT-0800 (Pacific Standard Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">i.e. run on react-todomvc and see how often we have unoptimized for..in loops</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Jan 19 2023 13:11:04 GMT-0800 (Pacific Standard Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: There is no way. Generally a different context is a different GC-heap and runs on a different thread, objects cannot be shared. In the browser we use Structured-Clone to serialize and deserialize objects between different JSContext</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Thu Jan 19 2023 13:18:46 GMT-0800 (Pacific Standard Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: I think it correlates with the number of times we hit <a href="https://searchfox.org/mozilla-central/source/js/src/jit/WarpBuilder.cpp#3274">this code</a></td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Thu Jan 19 2023 13:31:00 GMT-0800 (Pacific Standard Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: running the before and after on react-todomvc don't show a noticeable difference when just eyeballing the numbers</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Thu Jan 19 2023 13:31:27 GMT-0800 (Pacific Standard Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The quick hacky way to "fix" this is to get rid of <code>tryAttachNativeIterator</code> and <code>tryAttachNullOrUndefined</code><a href="https://searchfox.org/mozilla-central/source/js/src/jit/CacheIR.cpp#5313-5319">here</a> and instead always call <code>tryAttachMegamorphic</code> (even in specialized mode)</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Thu Jan 19 2023 13:31:29 GMT-0800 (Pacific Standard Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">I'll try comparing it more scientifically in the future</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Thu Jan 19 2023 13:32:16 GMT-0800 (Pacific Standard Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't know if that will affect the numbers on react-todomvc, but I <em>think</em> it should cause the optimization to kick in on the microbenchmarks</td></tr>

</tbody></table></div></div></div>
</body></html>