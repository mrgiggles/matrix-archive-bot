<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-09-05</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-09-05<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-09-04" class="nav-link"><span>prev</span></a>
<a href="2023-09-06" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Sep 05 2023 00:57:00 GMT-0700 (Pacific Daylight Time)">07:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@luyahan:mozilla.org">luyahan</span>&gt;</div></td><td class="msg-cell">Hi all~ I don't know why ci failed on this patch? <a href="https://phabricator.services.mozilla.com/D187164">https://phabricator.services.mozilla.com/D187164</a> </td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Sep 05 2023 00:57:11 GMT-0700 (Pacific Daylight Time)">07:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@luyahan:mozilla.org">luyahan</span>&gt;</div></td><td class="msg-cell">Who can help me?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Sep 05 2023 01:32:57 GMT-0700 (Pacific Daylight Time)">08:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">luyahan</span>: where do you see it failed?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Sep 05 2023 01:34:34 GMT-0700 (Pacific Daylight Time)">08:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">once D187165 has been reviewed, y.ury or j.seward can land these 3 patches for you</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Sep 05 2023 01:35:38 GMT-0700 (Pacific Daylight Time)">08:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">also don't worry about changing the reviewer in the commit message, lando will change that automatically when landing the patch</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Sep 05 2023 04:28:03 GMT-0700 (Pacific Daylight Time)">11:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Should <code>BigInt*</code> be added to the GC Rooting Guide?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Sep 05 2023 05:06:33 GMT-0700 (Pacific Daylight Time)">12:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah if there's a list of all GC types somewhere we should add it</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Sep 05 2023 05:10:21 GMT-0700 (Pacific Daylight Time)">12:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">This is a list. <a href="https://searchfox.org/mozilla-central/source/js/public/TraceKind.h#91">https://searchfox.org/mozilla-central/source/js/public/TraceKind.h#91</a>
Not sure about which are public and alll</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Sep 05 2023 08:31:26 GMT-0700 (Pacific Daylight Time)">15:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: What's the bug for the property hook work?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Sep 05 2023 08:32:29 GMT-0700 (Pacific Daylight Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1844878">https://bugzilla.mozilla.org/show_bug.cgi?id=1844878</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Sep 05 2023 08:33:12 GMT-0700 (Pacific Daylight Time)">15:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Sep 05 2023 09:35:47 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-12">sfink</span>: if I understand correctly the stack, we create a JS object, some of which might be using a malloc-based allocation to hold the slots of the object.<br>What happens in case of a nursery allocated objects needs an allocated buffer to hold its slots?</p>
<p>As we never iterate over the dead objects, don't we accidentally leak memory?<br>(related to Bug 1832153)</p>
</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Sep 05 2023 09:35:52 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1832153">https://bugzil.la/1832153</a> — NEW (nobody) — Perma Linux valgrind-test | 16 bytes in 1 blocks are definitely lost at malloc / js_arena_malloc / js_pod_arena_malloc / maybe_pod_arena_malloc</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Sep 05 2023 09:40:54 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Also we do not have a meta bug for xpconnect stuff :/</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Sep 05 2023 13:02:29 GMT-0700 (Pacific Daylight Time)">20:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">While investigating sp3, we noticed a case where JS code calls into the DOM repeatedly with a particular string as an argument. On the DOM side, the string has to be converted to their own representation. It would be faster if it were an external string, but the string originates in JS code. Perf people were wondering whether it would be possible for us to expose the ability to take an arbitrary JSString and convert it into an external string in-place, so that subsequent calls with the same string would not require the conversion. </td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Sep 05 2023 13:03:41 GMT-0700 (Pacific Daylight Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">My first reaction was "that seems terrifying". My second reaction was "maybe it's no more terrifying than the extensible-&gt;dependent conversion we do <a href="https://searchfox.org/mozilla-central/source/js/src/vm/StringType.h#102-109">here</a>". My third reaction was "wait, how would that ever work for an atom?"</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Sep 05 2023 13:04:01 GMT-0700 (Pacific Daylight Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Does anybody have any more informed thoughts? <span class="nick-12">sfink</span>, you know things about string representation, right?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Sep 05 2023 13:07:21 GMT-0700 (Pacific Daylight Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Don't we have some kind of string cache for something like that already? I worked on it like 8 years ago so maybe it is gone or I'm confused.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Sep 05 2023 13:07:48 GMT-0700 (Pacific Daylight Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I guess something like you are suggesting has the advantage that it doesn't need to worry about cache entries getting displaced.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Sep 05 2023 13:13:41 GMT-0700 (Pacific Daylight Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We do have a <a href="https://searchfox.org/mozilla-central/source/js/src/gc/Zone.h#77">cache</a>, but IIUC  it's for the case where we have a string on the gecko side and we want to efficiently convert it into a JSString. The case where we're looking at starts with a JSString and wants to convert it efficiently to a gecko-side string.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Sep 05 2023 13:20:20 GMT-0700 (Pacific Daylight Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Ah, right.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Sep 05 2023 14:35:42 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p><span class="nick-12">sfink</span>: if I understand correctly the stack, we create a JS object, some of which might be using a malloc-based allocation to hold the slots of the object.<br>What happens in case of a nursery allocated objects needs an allocated buffer to hold its slots?</p>
<p>As we never iterate over the dead objects, don't we accidentally leak memory?<br>(related to Bug 1832153)</p>
</blockquote></mx-reply>We cheat. Any malloc allocation owned by a nursery object is registered in a separate list. If the object gets tenured, we remove the pointer from the list. After collecting the nursery, we iterate over the list and free everything left over.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Sep 05 2023 14:36:07 GMT-0700 (Pacific Daylight Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so we're actually iterating over dead stuff in that case, for the purpose of freeing it all.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Sep 05 2023 14:54:45 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Does anybody have any more informed thoughts? <span class="nick-12">sfink</span>, you know things about string representation, right?</blockquote></mx-reply>I'm looking at it. My concerns arise from the fact that external strings have their own <code>AllocKind</code>, and <code>AllocKinds</code> are common to all strings in an arena.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Sep 05 2023 14:56:17 GMT-0700 (Pacific Daylight Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">on a related note, external strings are not nursery-allocatable because they have finalizers, though that could be finessed.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Sep 05 2023 14:56:38 GMT-0700 (Pacific Daylight Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">question: would this be useful if it worked for only nursery strings? Only tenured strings?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Sep 05 2023 15:48:52 GMT-0700 (Pacific Daylight Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: IIUC, the pattern is something like <code>callADOMFunction("enter", ...)</code>, so I suspect that the string in question here is likely to be an atom. Which is probably the worst case for us being able to do anything?</td></tr>

</tbody></table></div></div></div>
</body></html>