<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-03-06</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-03-06<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-03-05" class="nav-link"><span>prev</span></a>
<a href="2025-03-07" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Mar 05 2025 16:04:26 GMT-0800 (Pacific Standard Time)">00:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: didn't you patch have that suspected check?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Mar 05 2025 16:05:16 GMT-0800 (Pacific Standard Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, but it was comparing against a moderate level of suspected objects -- meaning, we should start doing a CC eagerly.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Mar 05 2025 16:05:20 GMT-0800 (Pacific Standard Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: there is also this very magical limit <a href="https://searchfox.org/mozilla-central/source/dom/base/CCGCScheduler.h#51">https://searchfox.org/mozilla-central/source/dom/base/CCGCScheduler.h#51</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Mar 05 2025 16:05:38 GMT-0800 (Pacific Standard Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">which is different in my mind from "we should do a CC within 2 minutes" or whatever.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Mar 05 2025 16:05:43 GMT-0800 (Pacific Standard Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but I guess that's partly the question.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Mar 05 2025 16:05:57 GMT-0800 (Pacific Standard Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">IIRC from FFOS time to prevent running CC when something triggers just a tiny bit of suspected objects</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Mar 05 2025 16:06:09 GMT-0800 (Pacific Standard Time)">00:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">2 mins sounds a lot</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Mar 05 2025 16:06:30 GMT-0800 (Pacific Standard Time)">00:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I guess on the main thread there is the compacting GC, which will likely trigger CC</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Mar 05 2025 16:06:56 GMT-0800 (Pacific Standard Time)">00:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah I guess I can imagine 3 suspected count thresholds: (1) we've done <em>something</em>, be sure to CC eventually. (2) we've seen a decent amount of activity, time to start a CC when it seems like a decent time. (3) we're reaching some sort of limit, we'd better CC now.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Mar 05 2025 16:07:52 GMT-0800 (Pacific Standard Time)">00:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">We long had that threshold, but I think for FxOS we had to increase it a bit.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Mar 05 2025 16:08:05 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">GC has similar limits, though there are kind of existing threshold for that already. There's an eager threshold, and a threshold where we've hit a limit and start a GC immediately.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Mar 05 2025 16:08:17 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that's the equivalent of my (2) and (3) for CC</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Mar 05 2025 16:08:25 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">CC is weird because you can suspect objects without allocating anything.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Mar 05 2025 16:08:35 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I was thinking of a (1) equivalent being: we've done at least one minor GC.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Mar 05 2025 16:08:52 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, that's why I was thinking it'd have to be a higher threshold than 1.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Mar 05 2025 16:10:07 GMT-0800 (Pacific Standard Time)">00:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'd like Workers to not CC/GC at all if they've been truly idle or close to it. Especially since that would mean the last thing they did was probably an idle GC and very possibly a CC at the end of it. (Though perhaps not a compacting one, I'm not sure about that.)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Mar 05 2025 16:10:20 GMT-0800 (Pacific Standard Time)">00:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Do workers have as large nursery as the main thread?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Mar 05 2025 16:10:55 GMT-0800 (Pacific Standard Time)">00:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'll need to check. I'm pretty sure it used to be different, but we might have removed the distinction. We removed some such distinctions, just to simplify the set of prefs.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Mar 05 2025 16:11:59 GMT-0800 (Pacific Standard Time)">00:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm not seeing a separate worker pref anymore for it</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Mar 05 2025 16:12:08 GMT-0800 (Pacific Standard Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">do you think that would be useful?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Mar 05 2025 16:12:09 GMT-0800 (Pacific Standard Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">just wondering if with the large nursery it is possible that minor gc happens rather rarely in some cases</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Mar 05 2025 16:12:53 GMT-0800 (Pacific Standard Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, that's fair. It wouldn't be too hard to make it more granular, like we've used up X kb of nursery space.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Mar 05 2025 16:13:03 GMT-0800 (Pacific Standard Time)">00:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">even in the absence of a minor GC</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Mar 05 2025 16:13:52 GMT-0800 (Pacific Standard Time)">00:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(and in fact, it might be worth using that even if a minor GC or three have happened, since they are sometimes forced for reasons that don't imply any heap activity)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Mar 05 2025 16:15:43 GMT-0800 (Pacific Standard Time)">00:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">In workers specifically minorGC might be quite effective. I'd expect MessageEvent being rather common garbage object, and it should have nursery allocated wrapper</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Mar 05 2025 16:16:59 GMT-0800 (Pacific Standard Time)">00:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">though I suppose from a GC perspective, it doesn't matter if a giant nursery is half full; you haven't created any tenured objects to clean up. It would be better to use the increase in the size of the tenured heap, whether that is from minor collections or pretenured allocations.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Mar 05 2025 16:17:52 GMT-0800 (Pacific Standard Time)">00:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but if there have been lots of now-dead MessageEvents allocated, then triggering a major GC still won't do anything.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Mar 05 2025 16:18:02 GMT-0800 (Pacific Standard Time)">00:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(unless some of them survived)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Mar 05 2025 16:18:42 GMT-0800 (Pacific Standard Time)">00:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or is that wrong? Do they somehow potentially create garbage cycles even if they die young?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Mar 05 2025 16:20:29 GMT-0800 (Pacific Standard Time)">00:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">worker CC should be interesting because it doesn't churn through as much CC'ed stuff as the main thread</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Mar 05 2025 16:23:27 GMT-0800 (Pacific Standard Time)">00:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in my (totally artificial and bogus) test case, the suspected count still grows fairly quickly. I haven't actually looked to see if it ends up unlinking anything.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Mar 05 2025 16:25:00 GMT-0800 (Pacific Standard Time)">00:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'd expect most of MessageEvent die when minorGC runs. having expandos on them should be very rare.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Mar 05 2025 16:25:11 GMT-0800 (Pacific Standard Time)">00:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Hmm, I wonder if mData there is nursery allocated </td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Mar 05 2025 16:25:17 GMT-0800 (Pacific Standard Time)">00:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">That is coming from structured cloning</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Mar 05 2025 16:26:20 GMT-0800 (Pacific Standard Time)">00:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Heh. I wonder if the ratio of suspected objects to cycles found (or edges unlinked) is at all stable in practice. Obviously, it would be trivial to construct extreme examples one way or the other.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Mar 05 2025 16:29:55 GMT-0800 (Pacific Standard Time)">00:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I don't think I nursery allocate those, but I'm tracing through...</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Mar 05 2025 16:32:03 GMT-0800 (Pacific Standard Time)">00:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm wrong. Those can definitely be nursery allocated.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Mar 05 2025 16:33:40 GMT-0800 (Pacific Standard Time)">00:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Sounds like something we could solve with AI</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Mar 05 2025 16:33:52 GMT-0800 (Pacific Standard Time)">00:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">then we'd have 2 problems</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Mar 05 2025 16:40:35 GMT-0800 (Pacific Standard Time)">00:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: unrelated to this, do we still have that code which doesn't immediately move objects to tenured heap (or something like that). Can't remember the name</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Mar 05 2025 16:41:03 GMT-0800 (Pacific Standard Time)">00:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm not sure what you mean. There's pretenuring, but that's kind of the other way around.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Mar 05 2025 16:41:27 GMT-0800 (Pacific Standard Time)">00:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The thing where you have to survive two nursery allocations to be tenured</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Mar 05 2025 16:41:47 GMT-0800 (Pacific Standard Time)">00:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">yeah, that thingie</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Mar 05 2025 16:43:39 GMT-0800 (Pacific Standard Time)">00:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, the semi-space nursery</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Mar 05 2025 16:44:10 GMT-0800 (Pacific Standard Time)">00:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think that's implemented but disabled.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Mar 05 2025 16:44:54 GMT-0800 (Pacific Standard Time)">00:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(I'm just playing a bit with ImageData and its wrapper allocation but the native object also keeps an Uint8ClampedArray alive)</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Mar 05 2025 16:45:27 GMT-0800 (Pacific Standard Time)">00:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/9a6de74c050b5fe7079b1302b9eed5c29453867a/modules/libpref/init/all.js#933">https://searchfox.org/mozilla-central/rev/9a6de74c050b5fe7079b1302b9eed5c29453867a/modules/libpref/init/all.js#933</a></td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Mar 06 2025 08:00:33 GMT-0800 (Pacific Standard Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">that flag is used everywhere, so is it actually that edge case? <a href="https://searchfox.org/mozilla-central/search?q=JSCLASS_SKIP_NURSERY_FINALIZE&amp;path=">https://searchfox.org/mozilla-central/search?q=JSCLASS_SKIP_NURSERY_FINALIZE&amp;path=</a> </td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Mar 06 2025 08:03:16 GMT-0800 (Pacific Standard Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">it is not an edge case indeed. It gets used when ProbablyShortLivingWrapper is in the webidl</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Mar 06 2025 12:51:36 GMT-0800 (Pacific Standard Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">do JSObjects have some spare slots to dump random stuff?</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Mar 06 2025 12:52:28 GMT-0800 (Pacific Standard Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(though, I think I should just use the slots webidl bindings want)</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Mar 06 2025 12:54:49 GMT-0800 (Pacific Standard Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The minimal JSObject is a shape pointer, a pointer to a slots array, and a pointer to an elements array. If we know the number of properties it will have early enough, we may allocate some additional storage for fixed slots or fixed elements as a trailing array.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Mar 06 2025 12:56:20 GMT-0800 (Pacific Standard Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you are defining your own objects, you can use the reserved slot mechanism to store data. If you want to dump random information on arbitrary objects, that's harder.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Mar 06 2025 12:56:32 GMT-0800 (Pacific Standard Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: but there doesn't happen to be some spare ones by default (I'd just test something before tweaking codegen)</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Mar 06 2025 12:57:30 GMT-0800 (Pacific Standard Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We have a fixed set of size classes (0/2/4/8/12/16 slots). When we allocate an object, we round up to the next size class. Overflow goes in dynamic slots.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Mar 06 2025 12:59:45 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So for example there are three spare slots on an object with five initial properties, but none on an object with four.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Mar 06 2025 13:00:29 GMT-0800 (Pacific Standard Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">actually, I think I can just take some const values for now from generated code and test stuff</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Mar 06 2025 13:00:36 GMT-0800 (Pacific Standard Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">still pondering this ImageData case</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Mar 06 2025 13:01:44 GMT-0800 (Pacific Standard Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I want the wrapper in nursery and the .data should be owned by the wrapper asap wrapper is created, and native side wouldn't have directly pointer to data anymore</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Mar 06 2025 13:04:11 GMT-0800 (Pacific Standard Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Is Uint8ClampedArray and such nursery allocated (I assume the underlying larger data block isn't, but maybe that is allocated in some special way which doesn't require majorgc)?</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Mar 06 2025 13:21:34 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Looking at the code, I think that if you allocate a typed array (eg <code>new Uint8ClampedArray(100)</code>), then we can allocate both the arrayobject and the underlying buffer in the nursery, and copy the buffer out of the nursery if we promote it.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Mar 06 2025 13:22:09 GMT-0800 (Pacific Standard Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But there might be a limit somewhere on how big a buffer we will allocate in the nursery</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Mar 06 2025 14:18:40 GMT-0800 (Pacific Standard Time)">22:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I think in this case the arrays are super tiny <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1943811#c5">https://bugzilla.mozilla.org/show_bug.cgi?id=1943811#c5</a></td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Mar 06 2025 14:19:05 GMT-0800 (Pacific Standard Time)">22:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">That is a totally unrealistic testcase, but I was curious to see how to tweak ImageData and GC/CC etc scheduling to improve it</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Mar 06 2025 14:24:58 GMT-0800 (Pacific Standard Time)">22:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The buffer for small typed arrays can be allocated inline in the object if it fits inside the maximum 16 slots.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Mar 06 2025 14:25:44 GMT-0800 (Pacific Standard Time)">22:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I'm not sure whether the buffers allocated by getImageData qualify; they might be backed by an existing buffer.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Mar 06 2025 14:26:37 GMT-0800 (Pacific Standard Time)">22:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But I would expect that we would be able to nursery-allocate the typed array.</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Mar 06 2025 14:39:55 GMT-0800 (Pacific Standard Time)">22:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">those small 1x1 arrays should be fine. They're <a href="https://searchfox.org/mozilla-central/rev/d5cbb5b26c2fe8639da9ea0b0f225018d3697c59/dom/canvas/CanvasRenderingContext2D.cpp#6323">regular Uint8ClampedArrays</a> it looks like, so they'll be nursery allocated with inline data. As long as nothing tries to get their imaginary <code>ArrayBuffer</code> out of them; that would allocate a new <code>ArrayBuffer</code> and copy the data over.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Mar 06 2025 14:42:27 GMT-0800 (Pacific Standard Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">question for the channel: is it a bad idea to recommend a really sketchy workaround to trigger SM's atomization codepath? I've pointed people at <code>Object.keys({[str]:0})[0]</code> in the past, which works but is kind of horrific.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Mar 06 2025 14:42:34 GMT-0800 (Pacific Standard Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I just found a version that goes 3x faster once it hits the JIT: <code>var dummy = {}; function internString(s) { return dummy[s] ? s : s; }</code>.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Mar 06 2025 14:43:43 GMT-0800 (Pacific Standard Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but until it hits the JIT, it doesn't return an atom! (Thanks to <span class="nick-16">alexical</span>, it at least returns a string with a stored atom pointer.) It seems like a really brittle pattern that we could easily optimize away accidentally.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Mar 06 2025 14:43:46 GMT-0800 (Pacific Standard Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but... 3x faster!</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Mar 06 2025 14:44:30 GMT-0800 (Pacific Standard Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(it works because s is used as a property key, and the jit sort of flows that information back.)</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Mar 06 2025 14:44:44 GMT-0800 (Pacific Standard Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">this is for bug 1834526, fwiw.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Mar 06 2025 14:44:45 GMT-0800 (Pacific Standard Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1834526">https://bugzil.la/1834526</a> — NEW (nobody) — Large fetch in Web Worker in extension causes hang in Firefox extension process</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Mar 06 2025 14:45:28 GMT-0800 (Pacific Standard Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think I'll post the slower variant for now, which of course we could theoretically also "optimize" away, but at least it sort of makes sense in its intent.</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Mar 06 2025 14:50:44 GMT-0800 (Pacific Standard Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">this works too: <code>function internString(s) { internString[s]; return s; }</code></td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Mar 06 2025 14:53:06 GMT-0800 (Pacific Standard Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or <code>function intern(s) { Object[s]; return s; }</code></td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Mar 06 2025 14:53:06 GMT-0800 (Pacific Standard Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It would be nice if we could figure out good heuristics to atomize these strings automatically, instead of recommending hacks</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Mar 06 2025 14:53:48 GMT-0800 (Pacific Standard Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But it's not at all obvious to me that there's anything going on in that code that we could detect from inside the engine to say "oh, yeah, these strings really want to be atomized"</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Mar 06 2025 14:54:15 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, it's not at all obvious</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Mar 06 2025 15:27:43 GMT-0800 (Pacific Standard Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Is there anything technically difficult about implementing the heuristic in bug 727615? I feel like we keep looking at dependent strings and saying "welp, yeah, it sure would be good if we didn't keep huge strings alive because tiny strings are pointing at them", but we have what seems like it should be a 3 line fix in our back pocket.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Mar 06 2025 15:27:45 GMT-0800 (Pacific Standard Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/727615">https://bugzil.la/727615</a> — NEW (nobody) — Do small dependent strings effectively leak large strings?</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Mar 06 2025 15:28:08 GMT-0800 (Pacific Standard Time)">23:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I guess we would have to put some thought into what x% should be?</td></tr>

</tbody></table></div></div></div>
</body></html>