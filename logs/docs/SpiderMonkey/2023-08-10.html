<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-08-10</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-08-10<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-08-09" class="nav-link"><span>prev</span></a>
<a href="2023-08-13" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Aug 09 2023 17:25:16 GMT-0700 (Pacific Daylight Time)">00:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>I was previously referred to this script as an example of how to make a module wrap around some native functions: <a href="https://searchfox.org/mozilla-esr102/rev/d2f5f3fdc3faf117b3ffe62ba2f327f8bf337ef7/toolkit/modules/Services.jsm#7">https://searchfox.org/mozilla-esr102/rev/d2f5f3fdc3faf117b3ffe62ba2f327f8bf337ef7/toolkit/modules/Services.jsm#7</a></p>
<pre><code>/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

var EXPORTED_SYMBOLS = ["Services"];

var Services = Cu.createServicesCache();
</code></pre>
<p>If I were to load and instantiate this module, where would I set the value of "Cu"?</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Aug 09 2023 17:42:22 GMT-0700 (Pacific Daylight Time)">00:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">where you create the global object, define the property on the global object</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Aug 09 2023 17:58:23 GMT-0700 (Pacific Daylight Time)">00:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I thought that modules were evaluated independently of global objects</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Aug 09 2023 17:59:41 GMT-0700 (Pacific Daylight Time)">00:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">module is evaluated in the current global, with module's own environment inside the global</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Aug 09 2023 18:00:34 GMT-0700 (Pacific Daylight Time)">01:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">variables declared in the module are stored into the module's environment, but it can read the global's variable</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Aug 09 2023 18:04:18 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Is there a way to insert something into the module's environment?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Aug 09 2023 18:07:50 GMT-0700 (Pacific Daylight Time)">01:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'm not aware of any</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Aug 10 2023 10:52:57 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">What exactly is the purpose of the Set/GetModulePrivate functions?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Aug 10 2023 13:04:08 GMT-0700 (Pacific Daylight Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">my guess is: whatever you want, but probably something that your module loader implementation is going to need. It looks like that's what Gecko uses it for.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Aug 10 2023 14:32:09 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I thought this was an interesting read <a href="https://pointieststick.com/2023/08/05/bug-fixes-are-a-good-thing-not-a-bad-thing/">https://pointieststick.com/2023/08/05/bug-fixes-are-a-good-thing-not-a-bad-thing/</a> 

The idea of an 'unbounded problem space' is an idea I'll be sitting with for a while</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Aug 10 2023 14:40:01 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> module is evaluated in the current global, with module's own environment inside the global</blockquote></mx-reply>I'm trying to find a way to have a module be able to access certain data without having it accessible from the global object.  Is there any way to do that?  Any variable or function that could be accessible within a module's environment that is not visible from the global scope?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Aug 10 2023 14:40:40 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm trying to find a way to have a module be able to access certain data without having it accessible from the global object.  Is there any way to do that?  Any variable or function that could be accessible within a module's environment that is not visible from the global scope?</blockquote></mx-reply>Or even a way to modify a module's variables after the module is compiled/initialized/evaluated?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Aug 10 2023 14:40:58 GMT-0700 (Pacific Daylight Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you mean, accessing certain data from module's script?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Aug 10 2023 14:44:36 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Yeah.  Basically, what I'm trying to do is have modules that provide bindings to C++ API's.  We already have the code that generates those bindings.  But at the moment, they're generated in the global scope.  I want to change them so they can be loaded from modules.  But, since it appears that we can't currently add our own functions to modules, the workaround is to have a short module script that wraps around calls to some internal implementation.

But I would prefer if that internal implementation function was not accessible from anywhere other than the module.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Aug 10 2023 14:47:36 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">let me do some experiment</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Aug 10 2023 14:55:32 GMT-0700 (Pacific Daylight Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hmm, actually it's possible to inject a value into module's environment with the current APIs, but not guaranteed to keep working</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Aug 10 2023 14:57:59 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> hmm, actually it's possible to inject a value into module's environment with the current APIs, but not guaranteed to keep working</blockquote></mx-reply>How?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Aug 10 2023 14:58:01 GMT-0700 (Pacific Daylight Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there's <a href="https://searchfox.org/mozilla-central/rev/778df10b835ea87def2bfdbb83810ee36bc22c94/js/public/Modules.h#294-295">JS::GetModuleEnvironment</a> function, which returns an environment object of given module.  if a module has <code>var foo</code>, the environment object has <code>foo</code> property with <code>undefined</code> value at the point of immediately before evaluating.  setting the property can change the initial value</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Aug 10 2023 14:58:33 GMT-0700 (Pacific Daylight Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the API was added only for read-only usage, but actually the environment object can be modified :P</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Aug 10 2023 14:58:46 GMT-0700 (Pacific Daylight Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, maybe I'll try it.  But, you say there's no guarantee that it keeps working.  Is there some upcoming breaking change in new versions?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Aug 10 2023 14:59:16 GMT-0700 (Pacific Daylight Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">no planned change, but it's not expected way of using the API</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Aug 10 2023 15:00:43 GMT-0700 (Pacific Daylight Time)">22:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, for example, some optimization can break it</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Aug 10 2023 15:01:54 GMT-0700 (Pacific Daylight Time)">22:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">What about putting something in the module metadata?  That also seems like kind of a hack, but could potentially work.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Aug 10 2023 15:04:24 GMT-0700 (Pacific Daylight Time)">22:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the currently-executing module object can be retrieved, I think you can have a built-in function that returns the currently-executing module's data, such as property.  so that the data is accessible only within the module</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Aug 10 2023 15:06:33 GMT-0700 (Pacific Daylight Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">How could that be retrieved?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Aug 10 2023 15:14:44 GMT-0700 (Pacific Daylight Time)">22:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hmm, I'm looking into a way to get the current script or current module, but so far I don't see it</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Aug 10 2023 15:19:34 GMT-0700 (Pacific Daylight Time)">22:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: okay, there is.   <a href="https://searchfox.org/mozilla-central/rev/778df10b835ea87def2bfdbb83810ee36bc22c94/js/public/ScriptPrivate.h#33">JS::GetScriptedCallerPrivate</a> can get the value of the currently executing top-level module script's private value, which is set by <a href="https://searchfox.org/mozilla-central/rev/778df10b835ea87def2bfdbb83810ee36bc22c94/js/public/Modules.h#188">JS::SetModulePrivate</a></td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Aug 10 2023 15:22:09 GMT-0700 (Pacific Daylight Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, add a global function that gets currently executing module's private data and return it or some property</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Aug 10 2023 15:22:21 GMT-0700 (Pacific Daylight Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">this is safer than modifying the environment object</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Aug 10 2023 15:23:03 GMT-0700 (Pacific Daylight Time)">22:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the function just need to verify the private value is valid or not.  in order to avoid crash when it's called outside of module top-level</td></tr>

</tbody></table></div></div></div>
</body></html>