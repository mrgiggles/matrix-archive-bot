<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-09-28</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-09-28<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-09-27" class="nav-link"><span>prev</span></a>
<a href="2023-09-29" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Sep 28 2023 03:34:04 GMT-0700 (Pacific Daylight Time)">10:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-2">mgaudet</span>: Have you figured out anything more after <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1849860#c29">https://bugzilla.mozilla.org/show_bug.cgi?id=1849860#c29</a> ?</p>
<p>DOM people argued that <code>const stream</code> inside the function is not guaranteed to be alive as the JS engine doesn't know the script will ever get back to the scope, is it true?</p>
<p>Per the attached GC log it's indeed marked as gray</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Sep 28 2023 03:39:28 GMT-0700 (Pacific Daylight Time)">10:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><p>The question tl;dr:</p>
<pre><code class="language-js">async function foo() {
  const bar = new Bar(); // Is this guaranteed to be alive until run() finishes?
  await bar.run(); // (Say this takes enough time to get some GC runs before it finishes)
  console.log("finished"); // Is this guaranteed to run?
}
foo();
</code></pre>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Sep 28 2023 05:43:44 GMT-0700 (Pacific Daylight Time)">12:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">I sure would hope so</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Sep 28 2023 07:43:50 GMT-0700 (Pacific Daylight Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">krosylight</span>: Does something in <code>Bar::run</code> internally add a strong reference that will not be traversed/traced by cycle collection?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Sep 28 2023 08:19:25 GMT-0700 (Pacific Daylight Time)">15:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>Semantically I don't see any way it couldn't run unless the promise returned by <code><a href="http://bar.run">bar.run</a>()</code> never resolves -- which is currently the case in that test case. Right now that promise is never being run because the GC/CC is collecting an object cycle that I don't think should be collected.</p>
<p>If we're concerned about grey marking, one option would be to run the test case under the environment variable <a href="https://searchfox.org/mozilla-central/source/js/src/gc/GC.cpp#596"><code>JS_GC_ZEAL=18</code></a> -- it may be that we could get something else out of other zeal commands.</p>
<p>My understanding of liveness of that snippet is that bar should be stored either in the frame, or in the captured environment object; either way, it should be captured at suspend and restored on resume, and must be traced by the GC.</p>
</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Sep 28 2023 08:20:00 GMT-0700 (Pacific Daylight Time)">15:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Ugh... but then actually, are we talking grey or gray -- two different things</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Sep 28 2023 08:20:21 GMT-0700 (Pacific Daylight Time)">15:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">GC says just G</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Sep 28 2023 08:29:11 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Unfortunately, I'm not a good person to really dig this one down because I don't understand well enough how the GC and CC interact; it would be good if someone else could comment on 1) whether I'm right that bar should 100% be kept alive across the await, 2) if there's a good reason that <code>bar</code> would be grey during a CC that happens while that frame is suspended, and if that means that bar can be collected.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Sep 28 2023 08:29:20 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(shit. Grey or gray. One or the other :S ) </td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Sep 28 2023 08:30:15 GMT-0700 (Pacific Daylight Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span> would be my preferred victim here; this is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1849860">https://bugzilla.mozilla.org/show_bug.cgi?id=1849860</a> which is a streams regression where it seems like internal data structures ofa stream are getting collected causing it to fail</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Sep 28 2023 08:37:24 GMT-0700 (Pacific Daylight Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'll dig into it. I guess my naive understanding is unsure: it seems like <code>await <a href="http://bar.run">bar.run</a>()</code> would immediately invoke <code><a href="http://bar.run">bar.run</a>()</code>, which returns a Promise with a <code>then</code> callback that runs the <code>console.log</code> in a scope that contains <code>bar</code> but does not use or capture <code>bar</code>. So my conclusion would be: ?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Sep 28 2023 08:40:29 GMT-0700 (Pacific Daylight Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but I guess I'm only talking about whether <code>bar</code> could be collected. I would definitely assume that <code>console.log</code> would run iff <code><a href="http://bar.run">bar.run</a>()</code> resolves.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Sep 28 2023 08:40:48 GMT-0700 (Pacific Daylight Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">that would be true if we did a promisification compilation of an async method; but we don't convert async code to promises </td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Sep 28 2023 08:41:23 GMT-0700 (Pacific Daylight Time)">15:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, uh oh, I don't actually know how any of this works</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Sep 28 2023 08:41:35 GMT-0700 (Pacific Daylight Time)">15:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">We save and restore our stack frame... unless <span class="nick-15">arai</span> we don't have some sort of optimization where we don't save/restore frame slots that aren't referenced later?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Sep 28 2023 08:42:47 GMT-0700 (Pacific Daylight Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">best to think of an async function as a special form of a generator; we recycle a lot of the machinery for generators (which I described a few years ago <a href="https://www.mgaudet.ca/technical/2020/9/1/how-do-generators-generate-in-spidermonkey">here</a>)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Sep 28 2023 08:44:59 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I will read that again, I remember liking that. And thinking of it as generators makes sense. I should read the bug to answer this, but why <em>should</em> <code>bar</code> be kept alive while <code><a href="http://console.run">console.run</a>()</code> happens? What is it breaking.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Sep 28 2023 08:45:03 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-12" title="@sfink:mozilla.org">sfink</span></div></td><td class="msg-cell">reads the bug</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Sep 28 2023 08:51:27 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Hmm. Maybe you're right; maybe the problem here is that the streams code is relying on the reflector keep the stream alive, but that's actually a bad assumption. Something else should be guaranteeing the stream stays alive while there's a pending promise waiting stream resolution. <span class="nick-1">krosylight</span> perhaps a <code>ReadRequest</code> needs to hold a strong reference to the stream?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Sep 28 2023 08:51:31 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, skimmed the bug. Definitely getting the impression that some internal stream machinery should be keeping a reference and keeping enough alive to complete the operation. In the simplified example above, that would mean that perhaps the whole of <code>bar</code> would not survive, but any internals necessary for the read to complete should.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Sep 28 2023 08:51:58 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think I'm saying the same thing with dumber words. :-)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Sep 28 2023 08:52:33 GMT-0700 (Pacific Daylight Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Just looking at the <a href="https://asuth.searchfox.org/mozilla-central/query/default?q=class-diagram%3A%27mozilla%3A%3Adom%3A%3AReadableStreamDefaultReader%27%20depth%3A4">class diagram</a>, it seems like it's easy enough to have a promise which depends on a collected cycle...</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Sep 28 2023 08:53:23 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">since a ReadRequest only holds the promise alive, but not the 'thing-which-will-resolve-the-promise'</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Sep 28 2023 09:00:34 GMT-0700 (Pacific Daylight Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(Now, why the refactor broke this... I've no idea; perhaps we used to get lucky?)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Sep 28 2023 09:05:06 GMT-0700 (Pacific Daylight Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">It looks like BodyStreamHolder only cycle collector traversed its mReadableStreamBody which left a ton of strong references in BodyStream that weren't cycle collected?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Sep 28 2023 09:14:40 GMT-0700 (Pacific Daylight Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(haven't yet read whole backlog) at least this link should exist, but I haven't yet checked who makes the promise alive: <code><a href="http://bar.run">bar.run</a>()</code>'s promise -&gt; <code>PromiseReactionRecord</code> -&gt; <code>AsyncFunctionGeneratorObject</code> -&gt; environment chain -&gt; <code>foo</code>'s top-level lexical environment -&gt; <code>bar</code> -&gt; <code>new Bar()</code></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Sep 28 2023 09:18:13 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Hmm. Maybe you're right; maybe the problem here is that the streams code is relying on the reflector keep the stream alive, but that's actually a bad assumption. Something else should be guaranteeing the stream stays alive while there's a pending promise waiting stream resolution. <span class="nick-1">krosylight</span> perhaps a <code>ReadRequest</code> needs to hold a strong reference to the stream?</blockquote></mx-reply>Hmm, so <code><a href="http://bar.run">bar.run</a>()</code> may not keep <code>bar</code> alive? Somehow my intuition says it should be kept as <code>run()</code> can't run alone without <code>bar</code></td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Sep 28 2023 09:19:13 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><p>btw, a potentially useful secret option that you can use for things that can sometimes help or not help is the <code>hier</code> mechanism:</p>
<ul>
<li><a href="https://asuth.searchfox.org/mozilla-central/query/default?q=class-diagram%3A%27mozilla%3A%3Adom%3A%3AReadableStreamDefaultReader%27+depth%3A4+hier%3Asubsystem">that with hier:subsystem</a></li>
<li><a href="https://asuth.searchfox.org/mozilla-central/query/default?q=class-diagram%3A%27mozilla%3A%3Adom%3A%3AReadableStreamDefaultReader%27+depth%3A4+hier%3Adir">hier:dir</a></li>
<li><a href="https://asuth.searchfox.org/mozilla-central/query/default?q=class-diagram%3A%27mozilla%3A%3Adom%3A%3AReadableStreamDefaultReader%27+depth%3A4+hier%3Afile">hier:file</a></li>
</ul>
</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Sep 28 2023 09:20:08 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code><a href="http://bar.run">bar.run</a>()</code> immediately exits and returns a promise , right?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Sep 28 2023 09:20:32 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Oh, hmm</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Sep 28 2023 09:21:11 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if so, unless the returned promise is kept alive somewhere else, the whole things will be GCed</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Sep 28 2023 09:21:12 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">yeah, so it's then effectively <code>await promise; console.log("finished")</code></td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Sep 28 2023 09:21:21 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I guess I see it now...</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Sep 28 2023 09:22:23 GMT-0700 (Pacific Daylight Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">A fancy term I like to use as much as possible is "symmetry breaking", so in a case like this, I think there's the question of how can we tell the difference between a situation where nothing will ever happen and we should GC versus when something will definitely happen and we should not GC.  (I'm stretching a distributed computing term, I guess.)</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Sep 28 2023 09:25:11 GMT-0700 (Pacific Daylight Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, in the actual code, the <code>reader</code> is referenced only from the async function's lexical environment?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Sep 28 2023 09:26:40 GMT-0700 (Pacific Daylight Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I think yes</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Sep 28 2023 09:27:05 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and the promise is held only by reader?</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Sep 28 2023 09:27:46 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">it's held by some other internal class</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Sep 28 2023 09:28:06 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Namely as InputToReadableStreamAlgorithms::mPullPromise</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Sep 28 2023 09:28:46 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">and that class is held by ReadableStream (<code>const stream</code> here)</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Sep 28 2023 09:29:11 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Uh, hmm, maybe the stream doesn't hold the reader</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Sep 28 2023 09:29:40 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Ah it does, ReadableStream:mReader</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Sep 28 2023 09:30:00 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">That's cycle collected too though</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Sep 28 2023 09:30:17 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">who's supposed to make the stream alive?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Sep 28 2023 09:31:15 GMT-0700 (Pacific Daylight Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">In <a href="https://bugzilla.mozilla.org/attachment.cgi?id=9354286&amp;action=edit">https://bugzilla.mozilla.org/attachment.cgi?id=9354286&amp;action=edit</a> I would say the <code>stream</code> should be kept alive, it's definitely needed to run the loop, right?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Sep 28 2023 09:32:02 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Who's supposed to be, so I'd say whatever JS engine thing</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Sep 28 2023 09:32:12 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">What's the static root that leads there?</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Sep 28 2023 09:34:30 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the loop is basically: 1. get a promise from <code>stream</code>, 2. internally perform <code>then</code> on it, 3. suspend and wait for fulfillment, 4. resume on fulfillment.  And, in the step 3, nothing keeps the suspended async function alive except for the promise</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Sep 28 2023 09:35:31 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and if the promise is held only by <code>stream</code>, which is held only by the async function's lexical environment slot, it goes wrong?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Sep 28 2023 09:36:01 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><p>I expected from 1849860-3.html:</p>
<ol>
<li>get an async iterator from <code>stream</code>, which grabs <code>reader</code>, which then grabs <code>stream</code></li>
<li>runs the loop, which should grab the async iterator and thus <code>stream</code>?</li>
</ol>
</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Sep 28 2023 09:36:53 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, but all those things are referred only from async function's environment (variables)?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Sep 28 2023 09:37:04 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I think that's true</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Sep 28 2023 09:37:05 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">isn't there anything that keeps the <code>stream</code> alive?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Sep 28 2023 09:37:19 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Currently no</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Sep 28 2023 09:37:42 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">are there situations where we would <em>want</em> a pending or incomplete stream to be dropped on the floor? In the current situation, it seems like it is very user-visible, and ownership should somehow follow that. But I don't know if there are other situations where discarding things would be the desired behavior.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Sep 28 2023 09:37:52 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">(There should be, because as asuth mentioned elsewhere the user may keep only the promise and throw everything else)</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Sep 28 2023 09:38:10 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">But I don't think that directly matters here, IMO JS still should grab the stream...</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Sep 28 2023 09:38:58 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Then we shouldn't mark all the fields as cycle collected in the streams impl?</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Sep 28 2023 09:39:30 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(I think I've seen similar situation some times in browser frontend, or maybe testcase, which requires storing a promise or its owner in global scope)</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Sep 28 2023 09:39:42 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">We'll need an extra non-cc'ed thing for that situation, yes</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Sep 28 2023 09:40:35 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ahh</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Sep 28 2023 09:40:35 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">But for this situation, we do still have access to AsyncIterableIterator&lt;ReadableStream&gt;</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Sep 28 2023 09:40:54 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I forgot about the returned promise of the async function itself</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Sep 28 2023 09:41:08 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the testcase discards it</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Sep 28 2023 09:42:24 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it would become different behavior when the <code>readFile</code>'s returned promise is held somewhere</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Sep 28 2023 09:43:06 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe I'm wrong</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Sep 28 2023 09:45:12 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Also, for anyone else looking at the diagram, I messed up when I decided which base class to use to infer cycle collection, so the dom::Promise erroneously does not mark mPromiseObj as traced or mGlobal as traversed, but they both are.  Fixing the heuristics now.</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Sep 28 2023 09:45:47 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><p>specifically</p>
<pre><code class="language-diff">-[[pretty."nsXPCOMCycleCollectionParticipant".label_containing_class.labels]]
+[[pretty."nsCycleCollectionParticipant".label_containing_class.labels]]
 label = "cc"
 
-[[pretty."nsXPCOMCycleCollectionParticipant".label_containing_class_field_uses.labels]]
+[[pretty."nsCycleCollectionParticipant".label_containing_class_field_uses.labels]]
 context_sym_suffix = "::cycleCollection::Trace"
 label = "cc-trace"
-[[pretty."nsXPCOMCycleCollectionParticipant".label_containing_class_field_uses.labels]]
+[[pretty."nsCycleCollectionParticipant".label_containing_class_field_uses.labels]]
 context_sym_suffix = "::cycleCollection::TraverseNative"
 label = "cc-traverse"
-[[pretty."nsXPCOMCycleCollectionParticipant".label_containing_class_field_uses.labels]]
+[[pretty."nsCycleCollectionParticipant".label_containing_class_field_uses.labels]]
 context_sym_suffix = "::cycleCollection::Unlink"
 label = "cc-unlink"
</code></pre>
</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Sep 28 2023 09:46:03 GMT-0700 (Pacific Daylight Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">(Quickly tried that and it didn't help)</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Sep 28 2023 09:46:18 GMT-0700 (Pacific Daylight Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sorry, never mind, the it was opposite direction</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Sep 28 2023 09:50:17 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><p>From the attached cc log:</p>
<pre><code>000003FCCD28D268 [gc] JS Object (ReadableStream AsyncIterator)
&gt; 000001D6BBD80510 UnwrapDOMObject(obj)

000001D6BBD80510 [garbage]
</code></pre>
<p>So the iterator is getting garbage collected while running the loop, and 000003FCCD28D268 is marked as G</p>
</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Sep 28 2023 09:54:16 GMT-0700 (Pacific Daylight Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, compared to regular generator, the async function's internal "generator object" is held only by the promise reaction created internally for <code>await</code> operation, which is added to the <code>await</code>'s operand promise. in non-stream case, the promise is supposed to be held and resolved by some thing that will be executed later. such as other function.  in the stream case, the promise is supposed to be resolved by the stream itself, and there's no other actor which is related to the promise or "read" operation ?</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Sep 28 2023 09:56:07 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe my question isn't appropriate</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Sep 28 2023 09:57:15 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the reader's promise is left in "pending" state while it's actually reading the file from disk, and once the "read" operation finishes, the promise is resolved?</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Sep 28 2023 09:57:48 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">I guess historically if we were using an nsIInputStreamPump, that would presumably hold a strong reference, but here in <a href="https://bugzilla.mozilla.org/attachment.cgi?id=9354286&amp;action=edit">https://bugzilla.mozilla.org/attachment.cgi?id=9354286&amp;action=edit</a> the pump is all in JS space and we're missing a static root for it?</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Sep 28 2023 09:59:37 GMT-0700 (Pacific Daylight Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Conceptually, I think it would make sense for <code><a href="http://file.stream">file.stream</a>()</code> to provide a strong reference until it runs out of data to provide?</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Sep 28 2023 10:00:15 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">So like when the iterator runs out of data and is "done" we drop the strong ref that serves as a "static root"?</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Sep 28 2023 10:00:38 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">In cycle collection I guess it's not really a static root since it's just a RefPtr strong ref that isn't traversed.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Sep 28 2023 10:01:07 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">why can a reader (the C++ side) be CCed while the "read" operation is in progress?</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Sep 28 2023 10:02:21 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">maybe I'm misunderstanding what "read" operation is</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Sep 28 2023 10:06:28 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><p>Hm, so spec-wise, the spec has the following references to GC:</p>
<p><a href="https://streams.spec.whatwg.org/#readable-stream-default-controller-clear-algorithms">https://streams.spec.whatwg.org/#readable-stream-default-controller-clear-algorithms</a></p>
<blockquote>
<p>ReadableStreamDefaultControllerClearAlgorithms(controller) is called once the stream is closed or errored and the algorithms will not be executed any more. By removing the algorithm references it permits the underlying source object to be garbage collected even if the ReadableStream itself is still referenced.</p>
</blockquote>
<p><a href="https://streams.spec.whatwg.org/#readable-byte-stream-controller-clear-algorithms">https://streams.spec.whatwg.org/#readable-byte-stream-controller-clear-algorithms</a></p>
<blockquote>
<p>ReadableByteStreamControllerClearAlgorithms(controller) is called once the stream is closed or errored and the algorithms will not be executed any more. By removing the algorithm references it permits the underlying byte source object to be garbage collected even if the ReadableStream itself is still referenced.</p>
</blockquote>
<p><a href="https://streams.spec.whatwg.org/#writable-stream-default-controller-clear-algorithms">https://streams.spec.whatwg.org/#writable-stream-default-controller-clear-algorithms</a></p>
<blockquote>
<p>WritableStreamDefaultControllerClearAlgorithms(controller) is called once the stream is closed or errored and the algorithms will not be executed any more. By removing the algorithm references it permits the underlying sink object to be garbage collected even if the WritableStream itself is still referenced.</p>
</blockquote>
<p><a href="https://streams.spec.whatwg.org/#transform-stream-default-controller-clear-algorithms">https://streams.spec.whatwg.org/#transform-stream-default-controller-clear-algorithms</a></p>
<blockquote>
<p>TransformStreamDefaultControllerClearAlgorithms(controller) is called once the stream is closed or errored and the algorithms will not be executed any more. By removing the algorithm references it permits the transformer object to be garbage collected even if the TransformStream itself is still referenced.</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Sep 28 2023 10:07:04 GMT-0700 (Pacific Daylight Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">so maybe ReadableStream::mController should not be traversed? edit: wait, maybe that's wrong</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Sep 28 2023 10:07:55 GMT-0700 (Pacific Daylight Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>my understanding is:</p>
<ol>
<li>when the reader is created and stored into lexical variable, async function's environment keeps it alive</li>
<li>when the <code><a href="http://reader.read">reader.read</a>()</code> operation is performed, the "actor" which performs <code>read</code> operation should keep the promise alive</li>
<li>when async function awaits on it and suspends, the same "actor" keeps the promise and the async function alive</li>
<li>when the <code>read</code> operation finishes, the promise is resolved and reaction job is enqueued. the reaction job keeps the async function alive</li>
<li>when the reaction job is executed, the async function resumes, and goes to step 2</li>
</ol>
</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Sep 28 2023 10:08:58 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(to be clear, it's not from the spec)</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Thu Sep 28 2023 10:10:17 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">where's the code that performs the <code>read</code> operation, and what's the interaction between it and the situation "the reader is CCed" ?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Thu Sep 28 2023 10:13:24 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, yeah, the whole stream, reader, related pending-promises should be kept alive by the fact that "the stream is still open"</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Thu Sep 28 2023 10:14:24 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, something like a <code>RefPtr</code> from the global</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Thu Sep 28 2023 10:16:32 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(It still feels to me like the it's a pending ReadRequest which should keep the stream alive, as it is the ReadRequest which maps from internal streams machinery to the promise wrapper sent to JS code) </td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Thu Sep 28 2023 10:18:53 GMT-0700 (Pacific Daylight Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><p>That makes sense; right now the IteratorReadRequest is itself cycle collected and cycle collects its mReader: <a href="https://asuth.searchfox.org/mozilla-central/rev/3ce9cb622495a187128d3a874e07f7bc75369561/dom/streams/ReadableStream.cpp#1123-1124">https://asuth.searchfox.org/mozilla-central/rev/3ce9cb622495a187128d3a874e07f7bc75369561/dom/streams/ReadableStream.cpp#1123-1124</a></p>
<pre><code class="language-cpp">NS_IMPL_CYCLE_COLLECTION_INHERITED(IteratorReadRequest, ReadRequest, mPromise,
                                   mReader)
</code></pre>
</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Thu Sep 28 2023 10:20:18 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">(I'll see if I can help the class-diagram functionality maybe understand this situation better; the ReadRequest subclasses aren't helping out a ton, but I think there's something else going on too.)</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Thu Sep 28 2023 10:25:54 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, letting a pending ReadRequest to keep things alive means, stream and reader can be GCed/CCed when a user reads some data and throws them away without closing the stream?</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Thu Sep 28 2023 10:30:39 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: i like your idea in <a href="https://github.com/WebKit/Speedometer/issues/317">https://github.com/WebKit/Speedometer/issues/317</a> (at least, the ?report parameter bit). I believe <span class="nick-12">denispal</span> has thought about some similar ideas in terms of making it easy for to solicit scores from internal testers</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Thu Sep 28 2023 10:31:01 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">we could always stand this up in a branch on our fork if nothing else</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Thu Sep 28 2023 10:31:32 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, so, <code>close()</code> operation is not something the user is responsible to perform, but just an operation that lets things GCed earlier.</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Thu Sep 28 2023 10:31:33 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it works nicely for my purpose, though I'm not sure what the format of the returned data really ought to be</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Thu Sep 28 2023 10:31:49 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">now I agree that the pending requests should keep things alive</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Thu Sep 28 2023 10:31:56 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">it exposes a CSV and JSON format, I think we'd just pick one or the other and send it</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Thu Sep 28 2023 10:32:14 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">i typically just use csv since it's easy to ingest in a spreadsheet</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Thu Sep 28 2023 10:32:38 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(I'm just dumping out the raw <code>measuredValues</code>, which gives the test name and things, but nothing else)</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Thu Sep 28 2023 10:33:03 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">where are you dumping them out?</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Thu Sep 28 2023 10:33:24 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the server appends to a file</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Thu Sep 28 2023 10:33:41 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">what server? have you already built the thing you are talking about in the issue?</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Thu Sep 28 2023 10:33:47 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Thu Sep 28 2023 10:33:54 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">do you have a branch / diff?</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Thu Sep 28 2023 10:34:33 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">no, just a local change <a href="https://paste.mozilla.org/qyLEtWL9">https://paste.mozilla.org/qyLEtWL9</a></td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Thu Sep 28 2023 10:34:57 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oops, that doesn't include the server</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Thu Sep 28 2023 10:35:21 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://paste.mozilla.org/Vgw08yyJ">https://paste.mozilla.org/Vgw08yyJ</a></td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Thu Sep 28 2023 10:36:06 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the default stats dump filename should be made platform-independent (I'm using <code>/tmp</code> now)</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Thu Sep 28 2023 10:37:48 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">i was thinking you could do <code>?report=<a href="http://localhost:8000/ingest">http://localhost:8000/ingest</a></code> (to whatever URL you wanted) to decouple the server from static file hosting</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Thu Sep 28 2023 10:37:58 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">at least, that's what would be most speedometer-shaped if we wanted to get something in main</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Thu Sep 28 2023 10:38:39 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah, good point</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Thu Sep 28 2023 10:39:24 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">you can put whatever we want in a branch on <a href="https://github.com/mozilla/Speedometer">https://github.com/mozilla/Speedometer</a> (including e.g. having a nodejs server that writes to a file etc) to be convenient and more portable for your development needs</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Thu Sep 28 2023 10:40:56 GMT-0700 (Pacific Daylight Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">do you want push access to that repo?</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Thu Sep 28 2023 10:41:11 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, will do. I've already run into problems with needing to check out a different revision in order to run certain tests, so I like your approach of decoupling the static hosting from the reporting</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Thu Sep 28 2023 10:41:34 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">uh... yes, I guess I do. If I'm poking at this stuff, I'll probably end up with other little things.</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Thu Sep 28 2023 10:42:39 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">one other option you might look at is crossbench (developed by chrome folks), which automates the selenium and result aggregation / reporting bit. not sure if it supports headless, but you can point it at a custom firefox binary <a href="https://docs.google.com/document/d/1rNoyrVQwW6LpSj5LoN8RmelzSq4PDqIDbDIcCx_g7go/edit">https://docs.google.com/document/d/1rNoyrVQwW6LpSj5LoN8RmelzSq4PDqIDbDIcCx_g7go/edit</a></td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Thu Sep 28 2023 10:42:56 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ooh, thanks</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Thu Sep 28 2023 10:44:41 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(this really came up because I needed to look at a non-shell sp3 test while I was sitting in a student lounge above my son's Japanese class many miles away from my build workstation, and rebuilding firefox and copying the bits over the network to my laptop is slow even when it's local)</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Thu Sep 28 2023 10:44:58 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@bgrins:mozilla.org">bgrins</span>&gt;</div></td><td class="msg-cell">alright, i've added you to the repo. don't push to main but otherwise feel free to push at will to a branch. note it will also be hosted at <a href="https://branchname--speedometer-preview.netlify.app">https://branchname--speedometer-preview.netlify.app</a></td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Thu Sep 28 2023 11:52:19 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-2">mgaudet</span>: Brief class-diagram feedback question thread, since I saw you are a forward thinking individual who values the finer things in life such as searchfox class diagrams.  Here's sorta an A/B test question between:</p>
<ul>
<li>A: using the "dot" ranked-based layout where I've turned down the opacity on the edges since they're very distracting and a fundamental problem in the "B" case.  (And noting that I should shortly have hover logic that highlights the node you're looking at, plus its inbound and outbound edges in different colors, and then the nodes at the other end of the edges since it's like physically impossible to follow most of the edges.)</li>
<li>B: using "neato" for layout which in more recent releases seems to understand the HTML label syntax and I love.</li>
</ul>
<p>Which better?  (I'm gonna reply to this to make this a thread imminently.)</p>
</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Thu Sep 28 2023 11:52:44 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">whoops, forgot only slack lets me paste into my message/thread, at least as how I understand to do it</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Thu Sep 28 2023 11:55:31 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">I guess for the rank-based display the class "is-a" relationship is fundamentally going in the wrong direction which probably doesn't help</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Thu Sep 28 2023 11:55:53 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">do we have any optimizations to prevent a small JSDependentString from keeping a very large string alive?</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Thu Sep 28 2023 12:13:03 GMT-0700 (Pacific Daylight Time)">19:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: I don't know, but if we do, somebody should mention them in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=727615">https://bugzilla.mozilla.org/show_bug.cgi?id=727615</a></td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Thu Sep 28 2023 12:14:45 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: nice find! Context here is that a V8'er mentioned they added an optimization to prevent that from happening recently, thought I'd check if it'd be useful for us too</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Thu Sep 28 2023 12:15:37 GMT-0700 (Pacific Daylight Time)">19:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">Skimming through our slicing code, it doesn't look like we're doing it, but it could be done during GC somewhere I haven't seen</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Thu Sep 28 2023 12:32:42 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So, if the top image is the dot ranked layout, and the bottom is neato, I find the neato layout a little stressful, but easier to follow, and the dot ranked less stressful, but not so meaningful. I think the edges have gotten turned down a bit -too- much as well; I appreciate the turning down, but it's hard to follow them with that level of opacity</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Thu Sep 28 2023 12:32:59 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(perhaps if the edges highlighted on hover it would be different than just a static screenshot)</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Thu Sep 28 2023 12:33:54 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Thanks!  Yes, I am hoping the hover states will help out a lot.  Also, both modes would still be accessible (<code>graph-layout:neato</code> versus <code>graph-layout:dot</code>), but I am thinking I might change the default to neato.</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Thu Sep 28 2023 12:34:41 GMT-0700 (Pacific Daylight Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">In neato the opacity is a more significant problem because the edges go straight over the nodes and altering the opacity was the fastest way to moot that problem.</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Thu Sep 28 2023 12:35:30 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">I could probably do more in terms of hiding the edges behind the nodes or making them have some kind of paint magic when they're atop a node, etc.</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Thu Sep 28 2023 12:35:36 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">But those are potentially more involved.</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Thu Sep 28 2023 12:36:12 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I do think hover practically solves a number of these issues, particularly since this tends to be an interactive interface I suspect</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Thu Sep 28 2023 12:36:22 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">so it's OK not to solve the general issue IMO</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Thu Sep 28 2023 12:37:28 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> so, letting a pending ReadRequest to keep things alive means, stream and reader can be GCed/CCed when a user reads some data and throws them away without closing the stream?</blockquote></mx-reply>The pending read request would then keep something in the machinery alive, enough that the promise associated with the read request either gets resolved or rejected, but not just left hanging like currently happens</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Thu Sep 28 2023 13:31:53 GMT-0700 (Pacific Daylight Time)">20:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The pending read request would then keep something in the machinery alive, enough that the promise associated with the read request either gets resolved or rejected, but not just left hanging like currently happens</blockquote></mx-reply>This makes sense when stream is not kept alive by anything else, and my remaining question is about why <code>for await</code> can't keep the AsyncIterator alive</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Thu Sep 28 2023 13:47:26 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">krosylight</span>: I'm about to take off for the day, and I'm gone tomorrow, but could you expand on that question (either here or in the bug) -- i'm not quite sure what you mean</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Thu Sep 28 2023 13:49:46 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Sure, in <a href="https://bugzilla.mozilla.org/attachment.cgi?id=9354286&amp;action=edit">https://bugzilla.mozilla.org/attachment.cgi?id=9354286&amp;action=edit</a> there's <code>for await (const value of stream)</code> which has the same lifetime problem. In this case the for-await loop must keep the reference to the async iterator from <code>stream</code> as it's required to run the loop</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Thu Sep 28 2023 13:50:22 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">But it's being gone as noted here <a href="https://matrix.to/#/!CZEbuMfGYVdQMIBKeP:mozilla.org/$WHDVHMBsEJgHnW7vjB1OWEZHKb3Wjhrr1PNfx5NJ4Hs?via=mozilla.org&amp;via=matrix.org&amp;via=igalia.com">https://matrix.to/#/!CZEbuMfGYVdQMIBKeP:mozilla.org/$WHDVHMBsEJgHnW7vjB1OWEZHKb3Wjhrr1PNfx5NJ4Hs?via=mozilla.org&amp;via=matrix.org&amp;via=igalia.com</a></td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Thu Sep 28 2023 13:53:40 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Maybe it's me not following the conversation, because I still can't understand how ReadRequest strong reference is needed for the original test case with <code>.read()</code> either, because to run the loop a reference to <code>reader</code> is still required AFAICT?</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Thu Sep 28 2023 13:56:37 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">(Just to disambiguate: I agree ReadRequest should keep a reference, but I still think something else should keep a reference to the stream in the test cases)</td></tr>

</tbody></table></div></div></div>
</body></html>