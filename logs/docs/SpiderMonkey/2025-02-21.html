<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-02-21</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-02-21<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-02-20" class="nav-link"><span>prev</span></a>
<a href="2025-02-22" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Feb 20 2025 16:00:48 GMT-0800 (Pacific Standard Time)">00:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: FWIW, I can always invite more Mozillians to WHATNOT</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Feb 20 2025 16:01:30 GMT-0800 (Pacific Standard Time)">00:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">Oh nice thanks, I wasn’t sure the best way to go about that</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Feb 20 2025 16:02:26 GMT-0800 (Pacific Standard Time)">00:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">Asking in the meeting spec issue is fine too, but in case someone doesn't want to share email address there, just ping me</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Feb 20 2025 16:12:22 GMT-0800 (Pacific Standard Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Ryan Hunt</span>: it isn't super clear to me what is asked in <a href="https://github.com/whatwg/html/issues/11031">https://github.com/whatwg/html/issues/11031</a> What sorts of changes would be needed to HTML spec (or other WhatWG specs)?  Add the implementation from <a href="https://github.com/WebAssembly/js-string-builtins/blob/main/proposals/js-string-builtins/Overview.md#using-builtins">https://github.com/WebAssembly/js-string-builtins/blob/main/proposals/js-string-builtins/Overview.md#using-builtins</a> ?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Feb 20 2025 16:13:28 GMT-0800 (Pacific Standard Time)">00:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: there’s some backstory, but I’m AFK right now. Will respond tomorrow</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Feb 21 2025 03:03:51 GMT-0800 (Pacific Standard Time)">11:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-16">Ryan Hunt</span>: <span class="nick-2">padenot</span> for wasm I am not sure what's the proper way to compare the resulting compiled code.  I have tried to load the wat file in <a href="https://godbolt.org/">https://godbolt.org/</a> but I don't really know how to use that tool with WASM.</p>
<p>What I am trying to do right now is to extract for a given function what the compiler decided to do for a given function. From the test we worked on with Paul, using -O3 with clang resulted in C++ in a nice and fast simd usage. I am trying to find out how the very same function ends up in WASM, and if emcc ends up using some wasm simd operations, and if so, how that compares to the one in native.</p>
<p>That'll drive my work in : now that we know the wasm builtin overhead is stable between 500ns and 1000ns with Ryan's patch, is it worth deporting a function? e.g. how good is the wasm version etc</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Feb 21 2025 04:54:48 GMT-0800 (Pacific Standard Time)">12:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">oh I missed that message</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Feb 21 2025 04:55:47 GMT-0800 (Pacific Standard Time)">12:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><p>I used</p>
<pre><code>wasm2wat --enable-threads test_builtins.wasm -o test_builtins.wat
</code></pre>
</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Feb 21 2025 07:42:32 GMT-0800 (Pacific Standard Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">Yeah, if you're able to build the JS shell and manually load the wasm and use the wasmDis function, it can show you how well our compilers JIT the wasm code. Be sure to set <code>--wasm-compiler=ion</code> to ensure you're looking at optimized code</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Feb 21 2025 07:43:10 GMT-0800 (Pacific Standard Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@rhunt:mozilla.org">Ryan Hunt</span>&gt;</div></td><td class="msg-cell">It'd be nice to have an easier way to view the disassembly like godbolt. But we've never had the time/motivation to do it</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Feb 21 2025 07:44:24 GMT-0800 (Pacific Standard Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">can it really do anything substantial in this case tough, it's like a triple for loop already autovectorized by emscripten</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Feb 21 2025 07:45:19 GMT-0800 (Pacific Standard Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">looking the WAT shows that it's quite reasonable. The native c++ version of the same function (also autovectorized) beats WASM by about 2x</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Feb 21 2025 07:45:57 GMT-0800 (Pacific Standard Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/tarekziade/test-wasm/blob/main/main.cpp#L27-L39">https://github.com/tarekziade/test-wasm/blob/main/main.cpp#L27-L39</a> is the function</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Feb 21 2025 07:46:10 GMT-0800 (Pacific Standard Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">if compiled right, llvm can do autovectorization for wasm (using wasmsimd)</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Feb 21 2025 07:46:35 GMT-0800 (Pacific Standard Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">yes we've verified that we have simd instruction in the wasm program, that works well</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Feb 21 2025 07:47:47 GMT-0800 (Pacific Standard Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">clang++ + -O3 + -march=native is able to do more tricks, so we might look into getting a custom kernel not relying on auto-vectorization, e.g. something using AVX and saturating all the registers</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Feb 21 2025 07:48:36 GMT-0800 (Pacific Standard Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">since the overhead of calling into those native builtin is reduced, that become quite an appealing option, even for "small" matrix operations</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Feb 21 2025 07:49:35 GMT-0800 (Pacific Standard Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">yep, that's why we introduced builtins, for kernel-like operations/stuff, it is better to have and use natively available accelerators </td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Feb 21 2025 07:50:23 GMT-0800 (Pacific Standard Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">we hadn't measured the duration of most of those builtins operations though, it isn't unusual to have the overhead of the call comparable to the duration of the builtin</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Feb 21 2025 07:50:28 GMT-0800 (Pacific Standard Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">it does not make sense to use builtins for short-running operations</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Feb 21 2025 07:51:03 GMT-0800 (Pacific Standard Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">yeah, but with ryan's patch dividing the call overhead by 2 to 4 it becomes viable in more cases</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Feb 21 2025 07:53:42 GMT-0800 (Pacific Standard Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">my expectations that you will have at most 10-100 such calls per 1 second, what is yours?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Feb 21 2025 07:54:17 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I don't have expectations</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Feb 21 2025 07:54:24 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">because we could run any AI model</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Feb 21 2025 07:54:29 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">and those can do wild things</td></tr>

</tbody></table></div></div></div>
</body></html>