<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-09-29</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-09-29<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-09-28" class="nav-link"><span>prev</span></a>
<a href="2023-10-02" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Sep 28 2023 23:40:01 GMT-0700 (Pacific Daylight Time)">06:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>for-await-of</code> puts the async iterator into the value stack (similar to local variable) while it's running, and when it <code>await</code>s on a promise, value stack is moved to the suspended internal generator object's slot, and a reaction record is created for resuming the async function when the promise resolves, and the reaction record is added to the (pending) promise.  So, at this point, everything around the async function is reachable only from the promise, and if the promise goes away, the suspended async function will be GCed, because the async function won't be resumed in that case</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Sep 28 2023 23:42:46 GMT-0700 (Pacific Daylight Time)">06:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and from the JS engine's point of view, there's no guarantee that the promise will eventually be resolved.  so, it's up to stream's side whether to keep the promise alive or not</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Sep 28 2023 23:43:40 GMT-0700 (Pacific Daylight Time)">06:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">to be clear, async function keeps the async interator alive while it's running.  the problem is when the async function is suspended</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Sep 28 2023 23:46:31 GMT-0700 (Pacific Daylight Time)">06:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in the example case, there's guarantee that the async function is eventually resumed, because  the async function is waiting on the stream's promise, which is in "pending" state while the async function is suspended, and the promise is eventually be either fulfilled or rejected, depending on whether the in-flight "read" operation succeeds or not. then, regardless of fulfill/reject, once the promise is resolved, a reaction job is created with the reaction record's data, and it's put into job queue.  at this point, the job queue keeps the async function alive</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Sep 28 2023 23:46:50 GMT-0700 (Pacific Daylight Time)">06:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and once the job is executed at the next microtask checkpoint, the async function gets resumed</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Sep 29 2023 03:20:32 GMT-0700 (Pacific Daylight Time)">10:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> and once the job is executed at the next microtask checkpoint, the async function gets resumed</blockquote></mx-reply><p>Thank you for the great explanation! I think I finally got it.</p>
<p>One issue is that the stream doesn't know whether the promise will be resolved or not, as its underlying source may just stop responding. In that case explicitly grabbing the promise will leak.</p>
<p>Is there a way to tell whether the JS engine has "weak reference" to the promise so that the GC can happen if that reference goes away?</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Sep 29 2023 06:00:40 GMT-0700 (Pacific Daylight Time)">13:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">krosylight</span>: then, the "underlying source" should know it?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Sep 29 2023 06:00:52 GMT-0700 (Pacific Daylight Time)">13:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">who's actually performing the read operation in the file's case?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Sep 29 2023 06:01:56 GMT-0700 (Pacific Daylight Time)">13:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">shouldn't there be something that's blocking on read, or polling for the read?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Sep 29 2023 06:03:18 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in the bug comment's <code>new ReadableStream().getReader().read().then(() =&gt; console.log("foo"));</code> case, it's guarantee NOT to resolve, because there's no one who's actually performing the read operation, right?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Sep 29 2023 06:03:57 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if <code>ReadRequest</code> is created for the example's case, then <code>ReadRequest</code> might not be the right class to keep the promise alive</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Sep 29 2023 06:04:24 GMT-0700 (Pacific Daylight Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but someone who's actually going to resolve the promise should keep it alive</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Sep 29 2023 06:11:29 GMT-0700 (Pacific Daylight Time)">13:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-1">krosylight</span>: then, the "underlying source" should know it?</blockquote></mx-reply>The underlying source can be user-provided JS script, we can't require scripts to grab promise</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Sep 29 2023 06:11:58 GMT-0700 (Pacific Daylight Time)">13:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">It could also be some network thing, although in that case I'd expect it to time out</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Sep 29 2023 06:12:12 GMT-0700 (Pacific Daylight Time)">13:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the underlying source is user-provided JS object, then it's responsible for keeping it alive</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Sep 29 2023 06:12:52 GMT-0700 (Pacific Daylight Time)">13:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and if the source is not reachable from anywhere, the the stream and depending things should be GCed</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Sep 29 2023 06:13:39 GMT-0700 (Pacific Daylight Time)">13:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and if the underlying source is file, something that's actually reading from the file is responsible for keeping the promise alive, isn't it?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Sep 29 2023 06:15:01 GMT-0700 (Pacific Daylight Time)">13:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">The resulting promise is not the promise returned by the script but a new promise that is ultimately resolved when it resolves</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Sep 29 2023 06:15:07 GMT-0700 (Pacific Daylight Time)">13:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">They way we setup RealmOptions in the browser seems so ad-hoc. Seems very easy to miss initializing something important</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Sep 29 2023 06:16:19 GMT-0700 (Pacific Daylight Time)">13:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">krosylight</span>: can you provide an example around those 2 promises?  where are they and who holds references?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Sep 29 2023 06:19:15 GMT-0700 (Pacific Daylight Time)">13:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">evilpie</span>: is it about <code>xpc::SetPrefableRealmOptions</code> ?  or other options set before/after calling it?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Sep 29 2023 06:20:07 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Other options that are specific to the global, like "secure context". <code>xpc::SetPrefableRealmOptions</code> basically apply to anything</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Sep 29 2023 06:21:52 GMT-0700 (Pacific Daylight Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah I've noticed that too. The more we can move into <code>SetPrefableRealmOptions</code> the better. Ideally some of these prefs would be context-wide or process-wide too</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Sep 29 2023 06:22:34 GMT-0700 (Pacific Daylight Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">would it be nice if we have a single method that takes all options as separate parameter, with "false, true, or default" variants ?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Sep 29 2023 06:24:44 GMT-0700 (Pacific Daylight Time)">13:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-1">krosylight</span>: can you provide an example around those 2 promises?  where are they and who holds references?</blockquote></mx-reply><p>Consider this:</p>
<pre><code>const stream = new ReadableStream({
  async pull(c) {
    await new Promise(r =&gt; setTimeout(r, 2000));
    c.enqueue('foo');
  }
});
const reader = stream.getReader();
console.log(await reader.read());
</code></pre>
<p>The C++ part receives the promise generated by async function here: <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.cpp#90-94">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.cpp#90-94</a></p>
<p>But what resolves the read() promise is the <code>c.enqueue()</code> part that's not managed by the script at all</p>
</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Sep 29 2023 06:26:44 GMT-0700 (Pacific Daylight Time)">13:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in that scenario, setTimeout's reaction keeps the <code>new Promise</code> alive, and the promise's reaction record keeps the async function alive, and the async function's arguments keeps the controller alive</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Sep 29 2023 06:27:13 GMT-0700 (Pacific Daylight Time)">13:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and the controller has a reference to the promise returned by <code><a href="http://reader.read">reader.read</a>()</code> ?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Sep 29 2023 06:27:50 GMT-0700 (Pacific Daylight Time)">13:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Here, yes <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamDefaultReader.h#32">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamDefaultReader.h#32</a></td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Sep 29 2023 06:28:51 GMT-0700 (Pacific Daylight Time)">13:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">A single method that initialized the important stuff might be good. We have <code>xpc::InitGlobalObjectOptions</code>, but that only has two uses right now</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Sep 29 2023 06:31:05 GMT-0700 (Pacific Daylight Time)">13:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">controller holds a seqneuce of <code>ReadRequest</code> ?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Sep 29 2023 06:32:14 GMT-0700 (Pacific Daylight Time)">13:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">reader does <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamDefaultReader.h#98">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamDefaultReader.h#98</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Sep 29 2023 06:33:21 GMT-0700 (Pacific Daylight Time)">13:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, the reference is controller -&gt; reader -&gt; ReadRequest -&gt; promise ?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Sep 29 2023 06:35:15 GMT-0700 (Pacific Daylight Time)">13:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">stream -&gt; reader -&gt; ReadRequest -&gt; promise I'd say, the stream -&gt; reader link is here <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStream.h#249">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStream.h#249</a></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Sep 29 2023 06:36:03 GMT-0700 (Pacific Daylight Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, controller -&gt; stream -&gt; reader -&gt; ReadRequest -&gt; promise ?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Sep 29 2023 06:36:33 GMT-0700 (Pacific Daylight Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and in the file's case, "something that reads file and enqueues" -&gt; controller ?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Sep 29 2023 06:38:03 GMT-0700 (Pacific Daylight Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if so, something that holds a reference to controller is responsible for keeping things alive in both cases</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Sep 29 2023 06:38:35 GMT-0700 (Pacific Daylight Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and in the above user-provided case, that's JS code which is kept alive by timer</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Sep 29 2023 06:38:56 GMT-0700 (Pacific Daylight Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and in the <code>new ReadableStream().getReader().read().then(() =&gt; console.log("foo"));</code> case, there's no such thing and everything should be GCed</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Sep 29 2023 06:40:49 GMT-0700 (Pacific Daylight Time)">13:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">stream and controller is paired and grabs each other (<a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamController.h#66">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamController.h#66</a>, <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStream.h#247">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStream.h#247</a>)

Controller delegates the pull operation to the underlying source (any subclass of UnderlyingSourceAlgorithmsBase) so the underlying source is the core</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Sep 29 2023 06:42:23 GMT-0700 (Pacific Daylight Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">And the controller holds the source <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamController.h#64">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamController.h#64</a></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Sep 29 2023 06:42:58 GMT-0700 (Pacific Daylight Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">does underlying source holds anything to the above graph?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Sep 29 2023 06:43:14 GMT-0700 (Pacific Daylight Time)">13:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or is it purely an internal implementation of the controller?</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Sep 29 2023 06:44:44 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Anything doing asynchronous read needs to grab the stream <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.h#270">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.h#270</a> to eventually call EnqueueNative on it</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Sep 29 2023 06:46:40 GMT-0700 (Pacific Daylight Time)">13:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, <code>EnqueueNative</code> is the method that's called by <code>c.enqueue</code> above ?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Sep 29 2023 06:46:53 GMT-0700 (Pacific Daylight Time)">13:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and also the method that's called when the file's read operation finishes?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Sep 29 2023 06:51:00 GMT-0700 (Pacific Daylight Time)">13:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Those two are basically same in this context, yes

and yes, when the read operation (backed by nsIInputStream) calls OnInputStreamReady then it calls enqueue function <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.cpp#460">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.cpp#460</a> (not exactly EnqueueNative but anyway does the same)</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Sep 29 2023 06:51:56 GMT-0700 (Pacific Daylight Time)">13:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Sep 29 2023 06:53:01 GMT-0700 (Pacific Daylight Time)">13:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the <code>mInput-&gt;Read</code> there is blocking operation which is taking time in the example case?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Sep 29 2023 06:53:04 GMT-0700 (Pacific Daylight Time)">13:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p><a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.cpp#440">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.cpp#440</a></p>
<pre><code class="language-cpp">nsresult rv = mInput-&gt;Read((char*)buffer.get(), pullSize, &amp;bytesWritten);
</code></pre>
</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Sep 29 2023 06:53:24 GMT-0700 (Pacific Daylight Time)">13:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">to be clear, I'm still not sure why the file's case goes wrong.  what happens when the read operation finishes if related things are CCed/GCed?</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Sep 29 2023 06:56:41 GMT-0700 (Pacific Daylight Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">The destructor of underlying source class unsubscribes from nsIInputStream in this case by closing it down
<a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.h#235">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.h#235</a>
<a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.cpp#190">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.cpp#190</a></td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Sep 29 2023 06:57:59 GMT-0700 (Pacific Daylight Time)">13:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, okay, so the above <code>Read</code> isn't something blocks on read, but called only when the data is already available.  and the issue happens before the callback is called</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Sep 29 2023 06:58:34 GMT-0700 (Pacific Daylight Time)">13:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>InputToReadableStreamAlgorithms::OnInputStreamReady</code> callback I mean</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Sep 29 2023 06:59:52 GMT-0700 (Pacific Daylight Time)">13:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, so far, the something that's actually performing the read operation is <code>nsIAsyncInputStream</code> which is held by <code>InputStreamHolder</code> ?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Sep 29 2023 07:00:19 GMT-0700 (Pacific Daylight Time)">14:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and it doesn't keep the callback alive?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Sep 29 2023 07:01:05 GMT-0700 (Pacific Daylight Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or, because the input stream is also in the cycle which is CCed ?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Sep 29 2023 07:01:45 GMT-0700 (Pacific Daylight Time)">14:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can we add a strong reference to the input stream while the read operation is in progress?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Sep 29 2023 07:02:48 GMT-0700 (Pacific Daylight Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">at least for the file's case</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Sep 29 2023 07:03:34 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there should be something that's actually reading from the file, which shouldn't be collected until the read operation finishes, either successfully or with failure</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Sep 29 2023 07:05:03 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(err, to my understanding, we haven't yet reached to the actual code that's actually reading)</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Sep 29 2023 07:05:14 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(everything there is callback or wrapper around that)</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Sep 29 2023 07:06:05 GMT-0700 (Pacific Daylight Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I mean, for the file case we do know it'll come back with some data, but for random nsIInputStream or script source I don't think that's always the case</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Sep 29 2023 07:06:52 GMT-0700 (Pacific Daylight Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">The data in in the disk so there's something to get already, but for network?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Sep 29 2023 07:07:05 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is there any problem with non-file case right now?</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Sep 29 2023 07:07:24 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">We share the same class with WebTransport</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Sep 29 2023 07:07:55 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">(I need to check whether it's actually affected though)</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Sep 29 2023 07:08:21 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the network case is done by C++ (not user-provided JS), right?</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Sep 29 2023 07:08:31 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">As the file case is, yes</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Sep 29 2023 07:08:34 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and it will eventually hit timeout if the data doesn't arrive?</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Sep 29 2023 07:09:11 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, if no timeout happens, then it would also be fine given it's waiting for the data that will come in future</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Sep 29 2023 07:09:40 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and that should keep things alive</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Sep 29 2023 07:11:27 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">That's something @jesup will know, I don't immediately see anything about timeout in <a href="https://w3c.github.io/webtransport/">https://w3c.github.io/webtransport/</a>

The case I worry is that the stream and the promise is thrown away, the source doesn't respond, nobody cares nothing but we still keep things around because there's the promise that hasn't been resolved</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Sep 29 2023 07:11:57 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">(If we add a strong reference, I mean)</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Sep 29 2023 07:13:08 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't think we should care about "the source doesn't respond" case</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Sep 29 2023 07:13:53 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"the source" is the something that's actually performing the read operation, right?</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Sep 29 2023 07:14:28 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">"something that provides the data" in general, in this case it happens to be a file reader</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Sep 29 2023 07:14:41 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">But it can just generate some data on demand</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Sep 29 2023 07:15:13 GMT-0700 (Pacific Daylight Time)">14:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, then it should keep things alive</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Sep 29 2023 07:15:33 GMT-0700 (Pacific Daylight Time)">14:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">at least the promise should be kept alive as long as the source is alive</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Sep 29 2023 07:18:05 GMT-0700 (Pacific Daylight Time)">14:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, the existence of the pending promise is not the reason why things needs to be kept alive.  those promises are kept alive by the existence of the source that will possibly eventually resolve them</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Sep 29 2023 07:19:46 GMT-0700 (Pacific Daylight Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hmm, I guess I should look into the file's case specifically, how the read operation is done and how the result data is passed to stream</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Sep 29 2023 07:20:13 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I still don't get why the input stream or something around that can be CCed while the read operation is in progress</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Sep 29 2023 07:22:12 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that should be completely unrelated to stream or async function</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Sep 29 2023 07:22:52 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><p>IMO even the stream itself may not know when it will get the data:</p>
<pre><code>const element = document.createElement("x-foo");
const stream = new ReadableStream(({
  start(c) {
    element.onclick = ev =&gt; c.enqueue(ev);
  }
})

const reader = c.getReader();
reader.read();
</code></pre>
<p>In this case the stream will absolutely stop if <code>element</code> goes out of any scope, but it can't really track that</p>
</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Sep 29 2023 07:24:35 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what does "goes out of scope" mean?  removed from the document?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Sep 29 2023 07:24:45 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-1">krosylight</span>: I don't know if you'd seen my comment about the spec GC language before at <a href="https://streams.spec.whatwg.org/#readable-stream-default-controller-clear-algorithms">https://streams.spec.whatwg.org/#readable-stream-default-controller-clear-algorithms</a> (and in 3 other places that's basically identical):</p>
<blockquote>
<p>ReadableStreamDefaultControllerClearAlgorithms(controller) is called once the stream is closed or errored and the algorithms will not be executed any more. By removing the algorithm references it permits the underlying source object to be garbage collected even if the ReadableStream itself is still referenced.</p>
</blockquote>
<p>This seems to correspond in our code to <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamDefaultController.cpp#187-206">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamDefaultController.cpp#187-206</a></p>
<pre><code class="language-cpp">// https://streams.spec.whatwg.org/#readable-stream-default-controller-clear-algorithms
//
// Note: nullptr is used to indicate we run the default algorithm at the
//       moment,
//       so the below doesn't quite match the spec, but serves the correct
//       purpose for disconnecting the algorithms from the object graph to allow
//       collection.
//
//       As far as I know, this isn't currently visible, but we need to keep
//       this in mind. This is a weakness of this current implementation, and
//       I'd prefer to have a better answer here eventually.
void ReadableStreamDefaultControllerClearAlgorithms(
    ReadableStreamDefaultController* aController) {
  // Step 1.
  // Step 2.
  aController-&gt;ClearAlgorithms();

  // Step 3.
  aController-&gt;setStrategySizeAlgorithm(nullptr);
}
</code></pre>
<p>But notably our mAlgorithms <a href="http://localhost:16995/mozilla-central/rev/f4174cfafb4fd0a39a466afb66e7fca2344454a3/dom/streams/ReadableStreamDefaultController.cpp#30-31">is cycle-collected</a> which seems (edit: potentially[1] )inconsistent with the spec.</p>
<p>1: It could be nice to have specific comments in the code about the relationship of the field to cycle collection.</p>
</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Sep 29 2023 07:24:45 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or just that the JS execution leaves the function?</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Fri Sep 29 2023 07:25:49 GMT-0700 (Pacific Daylight Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p><span class="nick-1">krosylight</span>: I don't know if you'd seen my comment about the spec GC language before at <a href="https://streams.spec.whatwg.org/#readable-stream-default-controller-clear-algorithms">https://streams.spec.whatwg.org/#readable-stream-default-controller-clear-algorithms</a> (and in 3 other places that's basically identical):</p>
<blockquote>
<p>ReadableStreamDefaultControllerClearAlgorithms(controller) is called once the stream is closed or errored and the algorithms will not be executed any more. By removing the algorithm references it permits the underlying source object to be garbage collected even if the ReadableStream itself is still referenced.</p>
</blockquote>
<p>This seems to correspond in our code to <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamDefaultController.cpp#187-206">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/ReadableStreamDefaultController.cpp#187-206</a></p>
<pre><code class="language-cpp">// https://streams.spec.whatwg.org/#readable-stream-default-controller-clear-algorithms
//
// Note: nullptr is used to indicate we run the default algorithm at the
//       moment,
//       so the below doesn't quite match the spec, but serves the correct
//       purpose for disconnecting the algorithms from the object graph to allow
//       collection.
//
//       As far as I know, this isn't currently visible, but we need to keep
//       this in mind. This is a weakness of this current implementation, and
//       I'd prefer to have a better answer here eventually.
void ReadableStreamDefaultControllerClearAlgorithms(
    ReadableStreamDefaultController* aController) {
  // Step 1.
  // Step 2.
  aController-&gt;ClearAlgorithms();

  // Step 3.
  aController-&gt;setStrategySizeAlgorithm(nullptr);
}
</code></pre>
<p>But notably our mAlgorithms <a href="http://localhost:16995/mozilla-central/rev/f4174cfafb4fd0a39a466afb66e7fca2344454a3/dom/streams/ReadableStreamDefaultController.cpp#30-31">is cycle-collected</a> which seems inconsistent with the spec.</p>
</blockquote></mx-reply>It doesn't say "if and only if"?</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Fri Sep 29 2023 07:26:31 GMT-0700 (Pacific Daylight Time)">14:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think, it's for the case when the stream is kept alive by something else?</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Fri Sep 29 2023 07:27:04 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> what does "goes out of scope" mean?  removed from the document?</blockquote></mx-reply>removed from the document, thrown away, can't added ever anymore</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Fri Sep 29 2023 07:28:11 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think, it's for the case when the stream is kept alive by something else?</blockquote></mx-reply>Yup, if we do keep the stream until the promise is resolved/rejected</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Fri Sep 29 2023 07:29:00 GMT-0700 (Pacific Daylight Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I mean we can do that, that was the previous behavior anyway, but wouldn't it be leaky</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Fri Sep 29 2023 07:29:14 GMT-0700 (Pacific Daylight Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if the element is removed and thrown away, the event handler is no longer reachable, and that means the controller is also not, which mean the stream can be collected</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Fri Sep 29 2023 07:29:47 GMT-0700 (Pacific Daylight Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">can be collected, but we are suggesting disallowing it to be collected, right?</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Fri Sep 29 2023 07:29:55 GMT-0700 (Pacific Daylight Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">because there's a pending read request</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Fri Sep 29 2023 07:31:14 GMT-0700 (Pacific Daylight Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, sorry, I should've clarified.  now I think that the existence of "pending read request" shouldn't keep things alive</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Fri Sep 29 2023 07:31:47 GMT-0700 (Pacific Daylight Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">my current understanding is that, things that grabs controller should keep things alive</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Fri Sep 29 2023 07:32:03 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">because that's going to enqueue data eventually</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Fri Sep 29 2023 07:32:49 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and in the file's case, the ultimate root should be the class that's actually reading the file.  which will call a callback on the listener or input stream or something, that will enqueue the data</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Fri Sep 29 2023 07:34:46 GMT-0700 (Pacific Daylight Time)">14:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, to my understanding, the class is CCed in the example case because it's reachable only from the cycle which is collected.  such as stream, reader, or the suspended async function</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Fri Sep 29 2023 07:35:16 GMT-0700 (Pacific Daylight Time)">14:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but it should be reachable from somewhere else because the read operation is in-flight</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Fri Sep 29 2023 07:35:44 GMT-0700 (Pacific Daylight Time)">14:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(I guess I should find the class, to make the discussion clearer...)</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Fri Sep 29 2023 07:36:43 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Hmm, so the file-reading nsIInputStream should keep the strong reference to the nsIIInputStreamCallback? I think I kinda agree...</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Fri Sep 29 2023 07:37:28 GMT-0700 (Pacific Daylight Time)">14:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, at least while the read operation is in progress</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Fri Sep 29 2023 07:37:31 GMT-0700 (Pacific Daylight Time)">14:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">We're referring to <a href="https://bugzilla.mozilla.org/attachment.cgi?id=9354286&amp;action=edit">1849860-3.html</a> for that?  (That makes sense)</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Fri Sep 29 2023 07:37:43 GMT-0700 (Pacific Daylight Time)">14:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">(that's the one with the Blob and <code><a href="http://file.stream">file.stream</a>()</code>)</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Fri Sep 29 2023 07:39:26 GMT-0700 (Pacific Daylight Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">when the read operation finishes, it doesn't have to keep strong reference, because there won't be any new event until the next read operation is triggered, which requires reference to the input stream elsewhere</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Fri Sep 29 2023 07:40:13 GMT-0700 (Pacific Daylight Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Right, so if someone stopped trying to iterate on the AsyncIterator under the hood, there would be no in-flight read requests for the nsIInputStream, and so it would not be holding the async-iterator-returned promise that would keep an iteration loop alive?</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Fri Sep 29 2023 07:40:54 GMT-0700 (Pacific Daylight Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Fri Sep 29 2023 07:44:36 GMT-0700 (Pacific Daylight Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">I guess an interesting complication would be this ReadableStreamTee class.</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Fri Sep 29 2023 07:45:01 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Like if in theory GC should be able to tear off one half of the tee.</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Fri Sep 29 2023 07:45:05 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or maybe, the file-reading nsIInputStream should be kept with strong reference outside from the cycle?</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Fri Sep 29 2023 07:45:38 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">nsIInputStream and its friends aren't/can't be cycle collected, so when we have calls into them, they'll generally hold a strong ref to themselves/what they're reading that can't go away, it's just a question of making sure their callbacks are holding a strong ref to the right thing.</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Fri Sep 29 2023 07:47:05 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what actually happens to the nsIInputStream in the problematic case?</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Fri Sep 29 2023 07:47:30 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's still reading the data while everything else are collected?</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Fri Sep 29 2023 07:48:09 GMT-0700 (Pacific Daylight Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">It's closed because everything else are collected</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Fri Sep 29 2023 07:48:46 GMT-0700 (Pacific Daylight Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ah, I see</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Fri Sep 29 2023 07:49:13 GMT-0700 (Pacific Daylight Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so the input stream doesn't keep the listener alive</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Fri Sep 29 2023 07:49:48 GMT-0700 (Pacific Daylight Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">even if the listener is waiting for the next data and the input stream is reading the data</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Fri Sep 29 2023 07:49:53 GMT-0700 (Pacific Daylight Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">?</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Fri Sep 29 2023 07:52:53 GMT-0700 (Pacific Daylight Time)">14:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Hmm, the input stream grabs the callback: <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/xpcom/io/NonBlockingAsyncInputStream.cpp#22">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/xpcom/io/NonBlockingAsyncInputStream.cpp#22</a>

The callback in this case is InputStreamHolder, which grabs the underlying source class in weak reference, maybe that was the fault?

It's kinda understandable here because InputStreamHolder is a generic class which does not assume whether the thing holding it will definitely respond</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Fri Sep 29 2023 07:53:50 GMT-0700 (Pacific Daylight Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Just like async function does not hold a promise because it doesn't know it will definitely respond....</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Fri Sep 29 2023 07:54:57 GMT-0700 (Pacific Daylight Time)">14:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what's the problematic case when the callback is strong reference?</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Fri Sep 29 2023 07:55:33 GMT-0700 (Pacific Daylight Time)">14:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe I'm wrong</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Fri Sep 29 2023 07:55:36 GMT-0700 (Pacific Daylight Time)">14:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">The code: <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.h#200">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.h#200</a></td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Fri Sep 29 2023 07:55:38 GMT-0700 (Pacific Daylight Time)">14:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>is it this field? <a href="https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.h#200">https://searchfox.org/mozilla-central/rev/2f5b657343ce18e4b8a56417f707022550f4b742/dom/streams/UnderlyingSourceCallbackHelpers.h#200</a></p>
<pre><code class="language-cpp">WeakPtr&lt;InputToReadableStreamAlgorithms&gt; mCallback;
</code></pre>
</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Fri Sep 29 2023 07:55:44 GMT-0700 (Pacific Daylight Time)">14:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Fri Sep 29 2023 07:55:44 GMT-0700 (Pacific Daylight Time)">14:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Yup</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Fri Sep 29 2023 07:58:17 GMT-0700 (Pacific Daylight Time)">14:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Maybe we could have an option to have a strong reference instead for file reading case</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Fri Sep 29 2023 07:59:48 GMT-0700 (Pacific Daylight Time)">14:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">let me check, having clycle with <code>RefPtr</code> between <code>InputStreamHolder</code> and <code>InputToReadableStreamAlgorithms</code> is problematic?</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Fri Sep 29 2023 08:00:37 GMT-0700 (Pacific Daylight Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">InputStreamHolder is held by random nsIInputStream and can't be cycle collected</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Fri Sep 29 2023 08:00:54 GMT-0700 (Pacific Daylight Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">So it needs to be either cut manually or just not make a cycle</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Fri Sep 29 2023 08:01:11 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">I assume we use nsIInputStream in the case where JS is generating the stream of data?</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Fri Sep 29 2023 08:01:33 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">In the JS-made ReadableStream case we don't use nsIInputStream</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Fri Sep 29 2023 08:01:58 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">The whole InputToReadableStreamAlgorithms and InputStreamHolder work is done for <a href="http://blob.stream">blob.stream</a>() and WebTransport</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Fri Sep 29 2023 08:02:20 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Which do use nsIInputStream</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Fri Sep 29 2023 08:02:30 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">It seems like in both those cases we want a strong ref then?</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Fri Sep 29 2023 08:02:52 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">For blob yes, for WT I'm not sure, I can ping <span class="nick-7">jesup</span></td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Fri Sep 29 2023 08:03:19 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">If WT is okay with it then we can just convert it to RefPtr</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Fri Sep 29 2023 08:03:32 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">A network connection is like a MessagePort (where the other end is in another global), as long as it's open, we need to assume it can generate data, and I don't think it itself would be eligible for GC.</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Fri Sep 29 2023 08:05:30 GMT-0700 (Pacific Daylight Time)">15:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Even if it may not be observable by anyone?</td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Fri Sep 29 2023 08:06:03 GMT-0700 (Pacific Daylight Time)">15:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">The script may just throw the whole WT thing away after a read request</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Fri Sep 29 2023 08:06:12 GMT-0700 (Pacific Daylight Time)">15:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">without closing it</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Fri Sep 29 2023 08:06:28 GMT-0700 (Pacific Daylight Time)">15:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I wonder what fetch does</td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Fri Sep 29 2023 08:06:32 GMT-0700 (Pacific Daylight Time)">15:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">If there's no listener, then the things could be GCed, yeah.</td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Fri Sep 29 2023 08:07:31 GMT-0700 (Pacific Daylight Time)">15:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">If we grab a strong reference in InputStreamHolder then the cycle will be kept until the read request is resolved</td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Fri Sep 29 2023 08:08:14 GMT-0700 (Pacific Daylight Time)">15:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">At least for classical DOMEventTargetHelper subclasses, in particular, we have <a href="https://searchfox.org/mozilla-central/search?q=symbol:_ZN7mozilla20DOMEventTargetHelper26KeepAliveIfHasListenersForEP6nsAtom&amp;redirect=false">KeepAliveIfHasListenersFor</a> which marks like "onmessage" magical for BroadcastChannel.</td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Fri Sep 29 2023 08:09:38 GMT-0700 (Pacific Daylight Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I think it's not clear for streams whether there's a listener, the only clue is a JS-side reference to promise but turns out we can't guarantee it here</td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Fri Sep 29 2023 08:11:19 GMT-0700 (Pacific Daylight Time)">15:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">(And even it was guaranteed it would only work for async iterator case but not for <code>.read()</code> case)</td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Fri Sep 29 2023 08:11:44 GMT-0700 (Pacific Daylight Time)">15:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Can you elaborate on that more / the specific test case it corresponds to?</td></tr>
  <tr class="msg" id="L150"><td class="ts-cell"><a class="ts" href="#L150" alt="Fri Sep 29 2023 08:12:06 GMT-0700 (Pacific Daylight Time)">15:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Not sure I follow</td></tr>
  <tr class="msg" id="L151"><td class="ts-cell"><a class="ts" href="#L151" alt="Fri Sep 29 2023 08:12:54 GMT-0700 (Pacific Daylight Time)">15:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">which case you mean?</td></tr>
  <tr class="msg" id="L152"><td class="ts-cell"><a class="ts" href="#L152" alt="Fri Sep 29 2023 08:13:18 GMT-0700 (Pacific Daylight Time)">15:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Okay, I think I parsed what you mean now.</td></tr>
  <tr class="msg" id="L153"><td class="ts-cell"><a class="ts" href="#L153" alt="Fri Sep 29 2023 08:14:04 GMT-0700 (Pacific Daylight Time)">15:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">For WebTransport I think that translates into WebTransport should be holding any stream it enqueues with a strong reference.</td></tr>
  <tr class="msg" id="L154"><td class="ts-cell"><a class="ts" href="#L154" alt="Fri Sep 29 2023 08:14:34 GMT-0700 (Pacific Daylight Time)">15:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">And that strong reference would then hold the stream alive such that it would hold anything that's actively trying to read from that stream via AsyncIterator/promise.</td></tr>
  <tr class="msg" id="L155"><td class="ts-cell"><a class="ts" href="#L155" alt="Fri Sep 29 2023 08:15:21 GMT-0700 (Pacific Daylight Time)">15:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">If there is nothing listening via AsyncIterator/promise and there's no way to add a new AsyncIterator/promise then that's fine, there's nothing benefiting from that strong reference.</td></tr>
  <tr class="msg" id="L156"><td class="ts-cell"><a class="ts" href="#L156" alt="Fri Sep 29 2023 08:15:54 GMT-0700 (Pacific Daylight Time)">15:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Which is to say, the WebTransport could still be GCed if no one retains a reference to it  or a way to hook up to its output stream</td></tr>
  <tr class="msg" id="L157"><td class="ts-cell"><a class="ts" href="#L157" alt="Fri Sep 29 2023 08:16:17 GMT-0700 (Pacific Daylight Time)">15:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">But if there was a reference to it from within the AsyncIterator/read promise, the WebTransport could be kept alive.</td></tr>
  <tr class="msg" id="L158"><td class="ts-cell"><a class="ts" href="#L158" alt="Fri Sep 29 2023 08:16:50 GMT-0700 (Pacific Daylight Time)">15:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"whether there's a listener or not" in that context would correspond to whether the promise returned by the stream has any reaction record, I think?</td></tr>
  <tr class="msg" id="L159"><td class="ts-cell"><a class="ts" href="#L159" alt="Fri Sep 29 2023 08:17:27 GMT-0700 (Pacific Daylight Time)">15:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(currently there's no API to query it tho)</td></tr>
  <tr class="msg" id="L160"><td class="ts-cell"><a class="ts" href="#L160" alt="Fri Sep 29 2023 08:17:57 GMT-0700 (Pacific Daylight Time)">15:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">we wouldn't need to query it; it would just be an emergent property of the cycle collection</td></tr>
  <tr class="msg" id="L161"><td class="ts-cell"><a class="ts" href="#L161" alt="Fri Sep 29 2023 08:18:19 GMT-0700 (Pacific Daylight Time)">15:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ah, okay</td></tr>
  <tr class="msg" id="L162"><td class="ts-cell"><a class="ts" href="#L162" alt="Fri Sep 29 2023 08:18:57 GMT-0700 (Pacific Daylight Time)">15:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@jesup:mozilla.org">jesup</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">krosylight</span>: that sounds reasonable, so long as we don't leak webtransports</td></tr>
  <tr class="msg" id="L163"><td class="ts-cell"><a class="ts" href="#L163" alt="Fri Sep 29 2023 08:19:30 GMT-0700 (Pacific Daylight Time)">15:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>so long as we don't leak webtransports</p>
</blockquote>
<p>Yeah, this is the core part of this discussion 🥲</p>
</td></tr>
  <tr class="msg" id="L164"><td class="ts-cell"><a class="ts" href="#L164" alt="Fri Sep 29 2023 08:20:04 GMT-0700 (Pacific Daylight Time)">15:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">(still trying to understand what asuth said)</td></tr>
  <tr class="msg" id="L165"><td class="ts-cell"><a class="ts" href="#L165" alt="Fri Sep 29 2023 08:23:18 GMT-0700 (Pacific Daylight Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> For WebTransport I think that translates into WebTransport should be holding any stream it enqueues with a strong reference.</blockquote></mx-reply>And when does it purge the streams?</td></tr>
  <tr class="msg" id="L166"><td class="ts-cell"><a class="ts" href="#L166" alt="Fri Sep 29 2023 08:26:51 GMT-0700 (Pacific Daylight Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">krosylight</span>: Hm, so, looking at webtransport a bit more, I guess it's again a question of just having an active AsyncInterator/read promise on the webtransport stream, and maybe webtransport doesn't magically have an internal strong ref.</td></tr>
  <tr class="msg" id="L167"><td class="ts-cell"><a class="ts" href="#L167" alt="Fri Sep 29 2023 08:29:31 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">That again leads to a question of whether that active iterator/promise is referenced by anything else, right?</td></tr>
  <tr class="msg" id="L168"><td class="ts-cell"><a class="ts" href="#L168" alt="Fri Sep 29 2023 08:29:45 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Because otherwise it's just useless</td></tr>
  <tr class="msg" id="L169"><td class="ts-cell"><a class="ts" href="#L169" alt="Fri Sep 29 2023 08:31:43 GMT-0700 (Pacific Daylight Time)">15:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">No?  The threshold for GC is observability, not utility.  If there's code that will <code>console.log("blah")</code> if we don't run GC but doesn't print if we do GC and it doesn't involve WeakRefs/etc., then we (usually) have a bug.</td></tr>
  <tr class="msg" id="L170"><td class="ts-cell"><a class="ts" href="#L170" alt="Fri Sep 29 2023 08:32:25 GMT-0700 (Pacific Daylight Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Hm, I think I parsed wrong again.</td></tr>
  <tr class="msg" id="L171"><td class="ts-cell"><a class="ts" href="#L171" alt="Fri Sep 29 2023 08:32:38 GMT-0700 (Pacific Daylight Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Let me restate</td></tr>
  <tr class="msg" id="L172"><td class="ts-cell"><a class="ts" href="#L172" alt="Fri Sep 29 2023 08:35:01 GMT-0700 (Pacific Daylight Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Ah, okay, I think my brain just leveled up one level in the galaxy brain setup to understand more what you're talking about.</td></tr>
  <tr class="msg" id="L173"><td class="ts-cell"><a class="ts" href="#L173" alt="Fri Sep 29 2023 08:35:49 GMT-0700 (Pacific Daylight Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">:galaxy-brain:</td></tr>
  <tr class="msg" id="L174"><td class="ts-cell"><a class="ts" href="#L174" alt="Fri Sep 29 2023 08:38:42 GMT-0700 (Pacific Daylight Time)">15:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">krosylight</span>: <span class="nick-15">arai</span> What I now understand to be the central issue is that if we have some code that is waiting on an AsyncIterator/read promise, but that code is not holding a reference to the WebTransport or the stream somehow, then from a GC absolutist perspective, we should GC everything, even though that code can have side effects.  And there's no good way to know if there's something actually listening there because we don't have a primitive that lets us decorate the AsyncIterator/read promise-listener, but we want one?</td></tr>
  <tr class="msg" id="L175"><td class="ts-cell"><a class="ts" href="#L175" alt="Fri Sep 29 2023 08:40:18 GMT-0700 (Pacific Daylight Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Thank you for writing a great feature request description for me</td></tr>
  <tr class="msg" id="L176"><td class="ts-cell"><a class="ts" href="#L176" alt="Fri Sep 29 2023 08:40:49 GMT-0700 (Pacific Daylight Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">to my understanding, whether there's a reaction on the promise isn't the essential part.  GC-ing those promises is only a kind of optimization</td></tr>
  <tr class="msg" id="L177"><td class="ts-cell"><a class="ts" href="#L177" alt="Fri Sep 29 2023 08:43:31 GMT-0700 (Pacific Daylight Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Is the situation that if someone has an outstanding read() request but didn't put a reaction on the resulting promise, we should keep the underlying thing alive even though if that promise resolves then we would want to GC the underlying ex: WebTransport?</td></tr>
  <tr class="msg" id="L178"><td class="ts-cell"><a class="ts" href="#L178" alt="Fri Sep 29 2023 08:43:44 GMT-0700 (Pacific Daylight Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I think whether the JS has the access to the promise can be considered as having a listener, because one can always call <code>.then()</code> and get the value</td></tr>
  <tr class="msg" id="L179"><td class="ts-cell"><a class="ts" href="#L179" alt="Fri Sep 29 2023 08:44:48 GMT-0700 (Pacific Daylight Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">my understanding is that the WebTransport or stream which is "actively" reading the data and which is going to resolve the promise should keep the promise and depending things alive, regardless of whether there's some reference to them or those promises</td></tr>
  <tr class="msg" id="L180"><td class="ts-cell"><a class="ts" href="#L180" alt="Fri Sep 29 2023 08:45:14 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if those promises are not collected until the stream releases the reference, it's still not a problem</td></tr>
  <tr class="msg" id="L181"><td class="ts-cell"><a class="ts" href="#L181" alt="Fri Sep 29 2023 08:46:09 GMT-0700 (Pacific Daylight Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">For file reading we can say it's "active reading", but for WT it's just waiting for potential data, there may or may not be one</td></tr>
  <tr class="msg" id="L182"><td class="ts-cell"><a class="ts" href="#L182" alt="Fri Sep 29 2023 08:46:26 GMT-0700 (Pacific Daylight Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">I think that's fine</td></tr>
  <tr class="msg" id="L183"><td class="ts-cell"><a class="ts" href="#L183" alt="Fri Sep 29 2023 08:46:33 GMT-0700 (Pacific Daylight Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"potential data" means it should be kept alive</td></tr>
  <tr class="msg" id="L184"><td class="ts-cell"><a class="ts" href="#L184" alt="Fri Sep 29 2023 08:46:58 GMT-0700 (Pacific Daylight Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">And we could potentially then write a glass-box test where we do a read() on a WebTransport where we don't add a reaction to the promise and where our server will never write anymore data to the WT stream, and we run some GCs and we make sure that the WT stays alive.</td></tr>
  <tr class="msg" id="L185"><td class="ts-cell"><a class="ts" href="#L185" alt="Fri Sep 29 2023 08:47:07 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> "potential data" means it should be kept alive</blockquote></mx-reply>if it's observable by anyone, is my argument</td></tr>
  <tr class="msg" id="L186"><td class="ts-cell"><a class="ts" href="#L186" alt="Fri Sep 29 2023 08:47:31 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">otherwise I'd say it's leaky</td></tr>
  <tr class="msg" id="L187"><td class="ts-cell"><a class="ts" href="#L187" alt="Fri Sep 29 2023 08:47:45 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't think it's leak in term of platform, it's just a bug in the user-side code</td></tr>
  <tr class="msg" id="L188"><td class="ts-cell"><a class="ts" href="#L188" alt="Fri Sep 29 2023 08:49:14 GMT-0700 (Pacific Daylight Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">In terms of specs, we generally already accept that if you have 2 agents communicating by MessageChannel and they each have a "message" event listener but neither end has an active reference to the MessagePort and so can never call postMessage(), we will leak them because we can't do cross-agent GC.</td></tr>
  <tr class="msg" id="L189"><td class="ts-cell"><a class="ts" href="#L189" alt="Fri Sep 29 2023 08:49:34 GMT-0700 (Pacific Daylight Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">And similarly, yeah, there's no way for the browser to know whether the other end of a connection will ever write data again</td></tr>
  <tr class="msg" id="L190"><td class="ts-cell"><a class="ts" href="#L190" alt="Fri Sep 29 2023 08:50:23 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">So far we are saying file reading case but the issue is applicable in general streams like <a href="https://matrix.to/#/!CZEbuMfGYVdQMIBKeP:mozilla.org/$vfFkpjLd48qesG_wZWF3GOVJcwgfu_eIKFQFV41x5lc?via=mozilla.org&amp;via=matrix.org&amp;via=igalia.com">https://matrix.to/#/!CZEbuMfGYVdQMIBKeP:mozilla.org/$vfFkpjLd48qesG_wZWF3GOVJcwgfu_eIKFQFV41x5lc?via=mozilla.org&amp;via=matrix.org&amp;via=igalia.com</a>

Non-actively-reading streams also need to be kept in some way</td></tr>
  <tr class="msg" id="L191"><td class="ts-cell"><a class="ts" href="#L191" alt="Fri Sep 29 2023 08:51:30 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">(Matrix broke the line break for me?)</td></tr>
  <tr class="msg" id="L192"><td class="ts-cell"><a class="ts" href="#L192" alt="Fri Sep 29 2023 08:51:52 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">(sometimes weird stuff happens with pasting and maybe contenteditable.)</td></tr>
  <tr class="msg" id="L193"><td class="ts-cell"><a class="ts" href="#L193" alt="Fri Sep 29 2023 08:53:59 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So far we are saying file reading case but the issue is applicable in general streams like <a href="https://matrix.to/#/!CZEbuMfGYVdQMIBKeP:mozilla.org/$vfFkpjLd48qesG_wZWF3GOVJcwgfu_eIKFQFV41x5lc?via=mozilla.org&amp;via=matrix.org&amp;via=igalia.com">https://matrix.to/#/!CZEbuMfGYVdQMIBKeP:mozilla.org/$vfFkpjLd48qesG_wZWF3GOVJcwgfu_eIKFQFV41x5lc?via=mozilla.org&amp;via=matrix.org&amp;via=igalia.com</a>

Non-actively-reading streams also need to be kept in some way</blockquote></mx-reply>My point is, we can't always say that not fulfilling read request is a user code error</td></tr>
  <tr class="msg" id="L194"><td class="ts-cell"><a class="ts" href="#L194" alt="Fri Sep 29 2023 08:56:14 GMT-0700 (Pacific Daylight Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the user code is responsible for resolving the promise (fulfill or reject), or just close the entire stream?</td></tr>
  <tr class="msg" id="L195"><td class="ts-cell"><a class="ts" href="#L195" alt="Fri Sep 29 2023 08:57:02 GMT-0700 (Pacific Daylight Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"keeping things alive when it's still open" doesn't sound like a "leak"</td></tr>
  <tr class="msg" id="L196"><td class="ts-cell"><a class="ts" href="#L196" alt="Fri Sep 29 2023 08:57:49 GMT-0700 (Pacific Daylight Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">we could GC those things if there's no reference, but it's not for correctness</td></tr>
  <tr class="msg" id="L197"><td class="ts-cell"><a class="ts" href="#L197" alt="Fri Sep 29 2023 08:58:05 GMT-0700 (Pacific Daylight Time)">15:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I mean, in <a href="https://matrix.to/#/!CZEbuMfGYVdQMIBKeP:mozilla.org/$vfFkpjLd48qesG_wZWF3GOVJcwgfu_eIKFQFV41x5lc?via=mozilla.org&amp;via=matrix.org&amp;via=igalia.com">https://matrix.to/#/!CZEbuMfGYVdQMIBKeP:mozilla.org/$vfFkpjLd48qesG_wZWF3GOVJcwgfu_eIKFQFV41x5lc?via=mozilla.org&amp;via=matrix.org&amp;via=igalia.com</a> case, when can the stream be closed? I don't think there's any stable way to do that unless there's a GC tracker to periodically check <code>element</code> is alive</td></tr>
  <tr class="msg" id="L198"><td class="ts-cell"><a class="ts" href="#L198" alt="Fri Sep 29 2023 08:58:22 GMT-0700 (Pacific Daylight Time)">15:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">Cycle collection is the tracker?</td></tr>
  <tr class="msg" id="L199"><td class="ts-cell"><a class="ts" href="#L199" alt="Fri Sep 29 2023 08:58:54 GMT-0700 (Pacific Daylight Time)">15:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">But here we want to not cycle collect it when there's a request, right?</td></tr>
  <tr class="msg" id="L200"><td class="ts-cell"><a class="ts" href="#L200" alt="Fri Sep 29 2023 08:59:56 GMT-0700 (Pacific Daylight Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">When the element is detached from the document, its refcount will be manipulated which will make the cycle collector interested in it.  The click handler will be GC'ed and that can then GC the controller reference which should have been holding the stream open</td></tr>
  <tr class="msg" id="L201"><td class="ts-cell"><a class="ts" href="#L201" alt="Fri Sep 29 2023 09:00:05 GMT-0700 (Pacific Daylight Time)">16:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">When the stream gets closed the read request and its strong ref would be invalidated.</td></tr>
  <tr class="msg" id="L202"><td class="ts-cell"><a class="ts" href="#L202" alt="Fri Sep 29 2023 09:01:52 GMT-0700 (Pacific Daylight Time)">16:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">And where do we add the strong reference?</td></tr>
  <tr class="msg" id="L203"><td class="ts-cell"><a class="ts" href="#L203" alt="Fri Sep 29 2023 09:03:38 GMT-0700 (Pacific Daylight Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><p>In that example, I think at the end of the code snippet (and start() is run) the static roots are:</p>
<ol>
<li>The Element is in the DOM tree which holds it strongly, it holds the click handler which holds a reference to the controller and keeps the stream open.  The stream closes if the reference to the controller goes away?</li>
<li>The read() request gets added to the stream and holds a strong, un-traced reference to the stream.  It gets closed out when the stream gets closed because no one holds a reference to the controller anymore.</li>
</ol>
</td></tr>
  <tr class="msg" id="L204"><td class="ts-cell"><a class="ts" href="#L204" alt="Fri Sep 29 2023 09:05:43 GMT-0700 (Pacific Daylight Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>The stream closes if the reference to the controller goes away?</p>
</blockquote>
<p>Both owns each other; have the same lifetime</p>
</td></tr>
  <tr class="msg" id="L205"><td class="ts-cell"><a class="ts" href="#L205" alt="Fri Sep 29 2023 09:07:00 GMT-0700 (Pacific Daylight Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think "there's a request" isn't a condition which should be used</td></tr>
  <tr class="msg" id="L206"><td class="ts-cell"><a class="ts" href="#L206" alt="Fri Sep 29 2023 09:07:44 GMT-0700 (Pacific Daylight Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, if the above example case is considered "valid", then I agree that the user is responsible for closing the stream, but the user is still responsible for releasing the reference if they want the stream to be collected</td></tr>
  <tr class="msg" id="L207"><td class="ts-cell"><a class="ts" href="#L207" alt="Fri Sep 29 2023 09:08:29 GMT-0700 (Pacific Daylight Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think "there's a request" isn't a condition which should be used</blockquote></mx-reply>Do you mean read() doesn't ever count as adding a strong reference to the stream?</td></tr>
  <tr class="msg" id="L208"><td class="ts-cell"><a class="ts" href="#L208" alt="Fri Sep 29 2023 09:09:23 GMT-0700 (Pacific Daylight Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><code>new ReadableStream().getReader().read()</code> will leak if we do that</td></tr>
  <tr class="msg" id="L209"><td class="ts-cell"><a class="ts" href="#L209" alt="Fri Sep 29 2023 09:09:58 GMT-0700 (Pacific Daylight Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>read()</code> will add reference, but it will be part of cycle which can be collected</td></tr>
  <tr class="msg" id="L210"><td class="ts-cell"><a class="ts" href="#L210" alt="Fri Sep 29 2023 09:10:07 GMT-0700 (Pacific Daylight Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the someone who's actually going to write to the controller should be outside of the cycle</td></tr>
  <tr class="msg" id="L211"><td class="ts-cell"><a class="ts" href="#L211" alt="Fri Sep 29 2023 09:10:09 GMT-0700 (Pacific Daylight Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">If the controller's not accessible to enqueue data it seems fair to GC</td></tr>
  <tr class="msg" id="L212"><td class="ts-cell"><a class="ts" href="#L212" alt="Fri Sep 29 2023 09:10:24 GMT-0700 (Pacific Daylight Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">it's a bit confusing, let's say non-cc'ed reference instead of strong reference</td></tr>
  <tr class="msg" id="L213"><td class="ts-cell"><a class="ts" href="#L213" alt="Fri Sep 29 2023 09:11:12 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, I wasn't aware of the difference between them</td></tr>
  <tr class="msg" id="L214"><td class="ts-cell"><a class="ts" href="#L214" alt="Fri Sep 29 2023 09:11:50 GMT-0700 (Pacific Daylight Time)">16:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">cc'ed strong reference can be cycle collected</td></tr>
  <tr class="msg" id="L215"><td class="ts-cell"><a class="ts" href="#L215" alt="Fri Sep 29 2023 09:14:31 GMT-0700 (Pacific Daylight Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><p>If it helps for understanding the DOM code <a href="https://asuth.searchfox.org/mozilla-central/query/default?q=class-diagram%3A%27mozilla%3A%3Adom%3A%3AReadableStreamDefaultReader%27%20depth%3A4">in the class diagrams like this one</a> mReadRequests   💪 🔗🔍 ⛓️‍💥 means:</p>
<ul>
<li>💪 is a RefPtr which is technically a strong reference</li>
<li>🔗🔍 means that the CycleCollector helper Traverse method directly references the field</li>
<li>⛓️‍💥 means the CycleCollector helper Unlink method directly references the field</li>
</ul>
<p>and then for mStoredError   🫚 🔗✏️ ⛓️‍💥:</p>
<ul>
<li>🫚 means it's a JS::Heap/Root/whatever</li>
<li>🔗✏️ means the CycleCollector helper Trace method directly references the field.</li>
</ul>
</td></tr>
  <tr class="msg" id="L216"><td class="ts-cell"><a class="ts" href="#L216" alt="Fri Sep 29 2023 09:16:10 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">krosylight</span>: From an abstract perspective (like, ignoring the spec), for streams where JS is generating the data, I think it matters whether there are any references to the controller that can call enqueue() or that there are ways to get new references to the controller.</td></tr>
  <tr class="msg" id="L217"><td class="ts-cell"><a class="ts" href="#L217" alt="Fri Sep 29 2023 09:16:58 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, I agree that the reference to the controller matters</td></tr>
  <tr class="msg" id="L218"><td class="ts-cell"><a class="ts" href="#L218" alt="Fri Sep 29 2023 09:18:36 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-1">krosylight</span>: From an abstract perspective (like, ignoring the spec), for streams where JS is generating the data, I think it matters whether there are any references to the controller that can call enqueue() or that there are ways to get new references to the controller.</blockquote></mx-reply>pull callback will provide a new reference</td></tr>
  <tr class="msg" id="L219"><td class="ts-cell"><a class="ts" href="#L219" alt="Fri Sep 29 2023 09:19:17 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">(That's how they own each other)</td></tr>
  <tr class="msg" id="L220"><td class="ts-cell"><a class="ts" href="#L220" alt="Fri Sep 29 2023 09:19:26 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">performing <code>read()</code> method, or having a pending <code>ReadReqeust</code> shouldn't add non-cc'ed reference, but when something is notified by <code>read()</code> and it's going to write to the controller, it should have non-cc'ed reference to the controller, so that when the data arrives to the something, it can write to the controller even if the controller is reachable only from it</td></tr>
  <tr class="msg" id="L221"><td class="ts-cell"><a class="ts" href="#L221" alt="Fri Sep 29 2023 09:20:12 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>but when something is notified by read()</p>
</blockquote>
<p>What do you mean by notified by read?</p>
</td></tr>
  <tr class="msg" id="L222"><td class="ts-cell"><a class="ts" href="#L222" alt="Fri Sep 29 2023 09:20:45 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I guess it means pull callback </td></tr>
  <tr class="msg" id="L223"><td class="ts-cell"><a class="ts" href="#L223" alt="Fri Sep 29 2023 09:20:50 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">told to read a data and eventually enqueue a data to controller and resolve the promise</td></tr>
  <tr class="msg" id="L224"><td class="ts-cell"><a class="ts" href="#L224" alt="Fri Sep 29 2023 09:21:07 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, input stream or holder?</td></tr>
  <tr class="msg" id="L225"><td class="ts-cell"><a class="ts" href="#L225" alt="Fri Sep 29 2023 09:22:22 GMT-0700 (Pacific Daylight Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">What if the pull callback (input stream or holder if non-JS case) needs to just wait for others and don't know whether they can be fulfilled?</td></tr>
  <tr class="msg" id="L226"><td class="ts-cell"><a class="ts" href="#L226" alt="Fri Sep 29 2023 09:23:05 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"wait for others" means the other holds a reference?</td></tr>
  <tr class="msg" id="L227"><td class="ts-cell"><a class="ts" href="#L227" alt="Fri Sep 29 2023 09:24:21 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">pull callback can also just end without doing anything, that's what <code>new ReadableStream()</code> does, a no-op stream. If we go this road I think we'll have to make many special cases...</td></tr>
  <tr class="msg" id="L228"><td class="ts-cell"><a class="ts" href="#L228" alt="Fri Sep 29 2023 09:25:08 GMT-0700 (Pacific Daylight Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sorry, what's <code>pull()</code> ?</td></tr>
  <tr class="msg" id="L229"><td class="ts-cell"><a class="ts" href="#L229" alt="Fri Sep 29 2023 09:25:14 GMT-0700 (Pacific Daylight Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">pull callback, sorry</td></tr>
  <tr class="msg" id="L230"><td class="ts-cell"><a class="ts" href="#L230" alt="Fri Sep 29 2023 09:26:36 GMT-0700 (Pacific Daylight Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ending without doing anything would mean that it says it's fine to be collected</td></tr>
  <tr class="msg" id="L231"><td class="ts-cell"><a class="ts" href="#L231" alt="Fri Sep 29 2023 09:26:39 GMT-0700 (Pacific Daylight Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">In the onclick example, we can't ask <code>element</code> to grab our stream</td></tr>
  <tr class="msg" id="L232"><td class="ts-cell"><a class="ts" href="#L232" alt="Fri Sep 29 2023 09:27:14 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it grabs the stream via event handler?  doesn't it keep things alive across cc ?</td></tr>
  <tr class="msg" id="L233"><td class="ts-cell"><a class="ts" href="#L233" alt="Fri Sep 29 2023 09:28:06 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">hmm, yeah</td></tr>
  <tr class="msg" id="L234"><td class="ts-cell"><a class="ts" href="#L234" alt="Fri Sep 29 2023 09:28:17 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in the onlick example, there's explicit route to the stream, which is global -&gt; document -&gt; element -&gt; event handler -&gt; variables</td></tr>
  <tr class="msg" id="L235"><td class="ts-cell"><a class="ts" href="#L235" alt="Fri Sep 29 2023 09:29:59 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, the file's case, file-reading input stream is responsible for keeping the listener alive, and actually it does.  the issue happens because the holder uses weak ref, which is the special case which needs fix?</td></tr>
  <tr class="msg" id="L236"><td class="ts-cell"><a class="ts" href="#L236" alt="Fri Sep 29 2023 09:32:32 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Right.

So that way we figured out the file and WT (I feel like I need to think more about WT though, and it's not urgent to change it in any way), and the JS case seems fine with it, so case closed?</td></tr>
  <tr class="msg" id="L237"><td class="ts-cell"><a class="ts" href="#L237" alt="Fri Sep 29 2023 09:33:03 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think so</td></tr>
  <tr class="msg" id="L238"><td class="ts-cell"><a class="ts" href="#L238" alt="Fri Sep 29 2023 09:33:07 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Yay!</td></tr>
  <tr class="msg" id="L239"><td class="ts-cell"><a class="ts" href="#L239" alt="Fri Sep 29 2023 09:34:28 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">krosylight</span>: do you want to talk more about the WT case back in Workers &amp; Storage?</td></tr>
  <tr class="msg" id="L240"><td class="ts-cell"><a class="ts" href="#L240" alt="Fri Sep 29 2023 09:34:46 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">I'll briefly describe the conclusion and call it a day, thank you <span class="nick-15">arai</span>  and <span class="nick-2">asuth</span> !</td></tr>
  <tr class="msg" id="L241"><td class="ts-cell"><a class="ts" href="#L241" alt="Fri Sep 29 2023 09:34:59 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">oh right, time zones!</td></tr>
  <tr class="msg" id="L242"><td class="ts-cell"><a class="ts" href="#L242" alt="Fri Sep 29 2023 09:35:02 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-1">krosylight</span>: do you want to talk more about the WT case back in Workers &amp; Storage?</blockquote></mx-reply>Maybe next week, I feel alone in the office</td></tr>
  <tr class="msg" id="L243"><td class="ts-cell"><a class="ts" href="#L243" alt="Fri Sep 29 2023 09:35:36 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@asuth:mozilla.org">asuth</span>&gt;</div></td><td class="msg-cell">calling it a day is good; I think my understanding is improved too... especially how we could have more useful diagrams! moo hoo ha ha ha!</td></tr>
  <tr class="msg" id="L244"><td class="ts-cell"><a class="ts" href="#L244" alt="Fri Sep 29 2023 09:35:57 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@krosylight:mozilla.org">krosylight</span>&gt;</div></td><td class="msg-cell">Yay searchfox!</td></tr>

</tbody></table></div></div></div>
</body></html>