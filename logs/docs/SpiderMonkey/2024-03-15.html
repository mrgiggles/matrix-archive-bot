<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-03-15</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-03-15<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-03-14" class="nav-link"><span>prev</span></a>
<a href="2024-03-16" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Mar 14 2024 22:35:30 GMT-0700 (Pacific Daylight Time)">05:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gkw:mozilla.org">gkw</span>&gt;</div></td><td class="msg-cell">how often are sec-approvals looked at now? Hoping for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1884427">https://bugzilla.mozilla.org/show_bug.cgi?id=1884427</a> to be landed by the end of the week</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Mar 14 2024 22:37:50 GMT-0700 (Pacific Daylight Time)">05:37</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-5" title="@gkw:mozilla.org">gkw</span></div></td><td class="msg-cell">reads <a href="https://firefox-source-docs.mozilla.org/bug-mgmt/processes/security-approval.html">https://firefox-source-docs.mozilla.org/bug-mgmt/processes/security-approval.html</a> but sees "daily" and references to a team from eons ago</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Mar 15 2024 01:55:57 GMT-0700 (Pacific Daylight Time)">08:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">gkw</span>: for something urgent I'd do a friendly ping to <span class="nick-4">tjr</span>, you know how it is, sometimes life gets in the way of triage</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Mar 15 2024 01:57:13 GMT-0700 (Pacific Daylight Time)">08:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gkw:mozilla.org">gkw</span>&gt;</div></td><td class="msg-cell">thanks, I know <span class="nick-4">tjr</span> may have been the one but wasn't entirely sure. Whenever he gets around to it then!</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Mar 15 2024 02:10:17 GMT-0700 (Pacific Daylight Time)">09:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it's possible they're waiting for the next release cycle (starts on Monday)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Mar 15 2024 05:21:21 GMT-0700 (Pacific Daylight Time)">12:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@sonarshroom:mozilla.org">sonarshroom</span>&gt;</div></td><td class="msg-cell"><p>Hey all! A while back I was here with questions during an upgrade to SM91. The upgrade has proceeded well with only a few bumps along the way. One of the ones that's currently hitting us is specific to windows: we have to sometimes do something along the lines of:</p>
<pre><code class="language-cpp">JS::Rooted&lt;JS:IdVector&gt; ids(cx);
JS_Enumerate(cx, targetObj, &amp;ids);
</code></pre>
<p>In testing however, the code is always crashing on the <code>ids</code> destructor. I've even tried to do an enumerate at an earlier stage of the game engines startup, right after building the global, but it will still crash, only on windows, when exiting the function, on said <code>JS::Rooted&lt;JS::IdVector&gt;</code> destructor. Could this be an issue specific to SM91, or would this be something about my setup?</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Mar 15 2024 05:43:13 GMT-0700 (Pacific Daylight Time)">12:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">All the code that does this in mozilla-central seems to use <code>JS::Rooted&lt;JS::IdVector&gt; ids(cx, JS::IdVector(cw));</code></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Mar 15 2024 06:45:21 GMT-0700 (Pacific Daylight Time)">13:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@tjr:mozilla.org">tjr</span>&gt;</div></td><td class="msg-cell">RE: sec-approval, yes they get paused after last beta uplift.  <a href="https://whattrainisitnow.com/">https://whattrainisitnow.com/</a> has the schedule</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Mar 15 2024 07:21:50 GMT-0700 (Pacific Daylight Time)">14:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@sonarshroom:mozilla.org">sonarshroom</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> All the code that does this in mozilla-central seems to use <code>JS::Rooted&lt;JS::IdVector&gt; ids(cx, JS::IdVector(cw));</code></blockquote></mx-reply>After doing some searching with searchfox I arrived at the same conclusion. However after switching to that initialization it still crashes unfortunately. It seems to me that it is a freeing issue, since the last call in the chain is a js_free call</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Mar 15 2024 07:28:17 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">sonarshroom</span>: it's likely bug 1243367</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Mar 15 2024 07:28:21 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1243367">https://bugzil.la/1243367</a> — ASSIGNED (sfink) — Deal with remaining js_free instances inlined into JSAPI</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Mar 15 2024 07:31:12 GMT-0700 (Pacific Daylight Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">you could try the patch there or maybe link SM statically</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Mar 15 2024 07:35:52 GMT-0700 (Pacific Daylight Time)">14:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">maybe an ASAN build can help identify the issue? not sure whether this is easily possible on windows; but even a linux build could pinpoint the issue</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Mar 15 2024 07:45:22 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">How does GC work with cross compartment wrappers? Does ownership work like shared pointers?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Mar 15 2024 07:47:25 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> maybe an ASAN build can help identify the issue? not sure whether this is easily possible on windows; but even a linux build could pinpoint the issue</blockquote></mx-reply><a href="https://firefox-source-docs.mozilla.org/tools/sanitizer/asan.html#creating-local-builds-on-windows">https://firefox-source-docs.mozilla.org/tools/sanitizer/asan.html#creating-local-builds-on-windows</a> has instructions</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Mar 15 2024 07:47:29 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">it's very much possible</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Mar 15 2024 07:49:33 GMT-0700 (Pacific Daylight Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@sonarshroom:mozilla.org">sonarshroom</span>&gt;</div></td><td class="msg-cell">I'm going to try to compile it with that patch specifically, to see if the error goes away</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Mar 15 2024 07:53:56 GMT-0700 (Pacific Daylight Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> How does GC work with cross compartment wrappers? Does ownership work like shared pointers?</blockquote></mx-reply>What do you mean? References from another compartment are treated as a root, if the GC does not include that other compartment, I think. (There is some weirdness with CCWs used as weak map keys.)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Mar 15 2024 08:58:37 GMT-0700 (Pacific Daylight Time)">15:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Yeah, mainly the story is that CCWs have strong references to the target (the actual object), but not vice versa. But if you do a GC where you are not collecting all Zones, then the CCWs in the uncollected Zones are conservatively assumed to be live (and thus will keep the target alive).</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Mar 15 2024 09:02:38 GMT-0700 (Pacific Daylight Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">CCWs used as WeakMap keys are special because if a CCW key died and then was recreated, you'd want it to look up the same value. So the WeakMap entry will keep the CCW alive as long as both the target and WeakMap are live. But you probably don't need to worry about that for the most part.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Mar 15 2024 09:14:36 GMT-0700 (Pacific Daylight Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> After doing some searching with searchfox I arrived at the same conclusion. However after switching to that initialization it still crashes unfortunately. It seems to me that it is a freeing issue, since the last call in the chain is a js_free call</blockquote></mx-reply>It seems to be the same bug as the one I've encountered. Here is the patch that I'm using:<br><a href="https://github.com/TheQwertiest/foo_spider_monkey_panel/blob/8f3721a6a122b528e1317268f83474581dc06c84/scripts/patches/mozjs-1243367-mismatched_free_call.patch">https://github.com/TheQwertiest/foo_spider_monkey_panel/blob/8f3721a6a122b528e1317268f83474581dc06c84/scripts/patches/mozjs-1243367-mismatched_free_call.patch</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Mar 15 2024 09:18:26 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">PS: I apply this patch after building mozjs, thus mozjs itself still uses <code>free</code></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Mar 15 2024 09:42:02 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">davidj361</span>: Compartments are nested inside zones, and zones are the smallest unit of GC. If all the compartments are inside the same zone, then cross-compartment wrappers work the same way as regular references, because we're collecting both compartments at once. For CCWs between compartments in different zones, I believe we keep track of cross-zone edges. While collecting a single zone, we assume that all edges from outside the zone are alive. Less frequently, we do a multizone GC that can clean up cycles between zones.</td></tr>

</tbody></table></div></div></div>
</body></html>