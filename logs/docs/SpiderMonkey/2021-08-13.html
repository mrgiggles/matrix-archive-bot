<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-08-13</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-08-13<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-08-11" class="nav-link"><span>prev</span></a>
<a href="2021-08-14" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Aug 12 2021 20:52:55 GMT-0700 (Pacific Daylight Time)">03:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't see "JS Helper" in Profiler Threads list, and specifying it via configuration also doesn't capture it.  where do they go?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Aug 12 2021 20:59:54 GMT-0700 (Pacific Daylight Time)">03:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I've just done an "all threads" profiling, and I don't see "JS Helper" either. foxsearching "JS Helper" got me there: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/InternalThreadPool.cpp#211">https://searchfox.org/mozilla-central/source/js/src/vm/InternalThreadPool.cpp#211</a> .<br>Looks like a kind of virtual thread running in a thread pool? The profiler can only find "real" threads by their real thread names, and the threads must be registered, typically with <code>PROFILER_REGISTER_THREAD</code>. If you know the name of the threads in the pool, that would be a good start to find the code running on this virtual JS Helper thread.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Aug 12 2021 21:01:05 GMT-0700 (Pacific Daylight Time)">04:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, I'll try that. thanks :)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Aug 12 2021 21:01:43 GMT-0700 (Pacific Daylight Time)">04:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: If you know that code well, feel free to add <code>PROFILER_REGISTER_THREAD</code> where missing üòâ</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Aug 12 2021 21:02:49 GMT-0700 (Pacific Daylight Time)">04:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't know much. will try figuring it out and add that</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Aug 12 2021 21:04:55 GMT-0700 (Pacific Daylight Time)">04:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">bug 1715562 seems to be related</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Aug 12 2021 21:04:57 GMT-0700 (Pacific Daylight Time)">04:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1715562">https://bugzil.la/1715562</a> ‚Äî RESOLVED (jonco) ‚Äî Turn on use of XPCOM thread pool in the browser</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Aug 12 2021 21:14:15 GMT-0700 (Pacific Daylight Time)">04:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell">The depends-on bugs implement this internal thread pool.<br>Looks like <span class="nick-4">jonco</span> and <span class="nick-12">sfink</span> would know everything about them. üòÅ<br><span class="nick-15">arai</span> I see now that this code is in /js , which doesn't have access to most profiler functions, so it may be impossible to register these threads with the profiler, sorry.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Aug 12 2021 21:14:48 GMT-0700 (Pacific Daylight Time)">04:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell">(For now; I'm working towards something that could help, but it's many months away still.)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Aug 12 2021 21:15:40 GMT-0700 (Pacific Daylight Time)">04:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I find HelperThreadTask in "TaskController Thread" </td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Aug 12 2021 21:16:17 GMT-0700 (Pacific Daylight Time)">04:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can a function or virtual thread be factored out from other thread?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Aug 12 2021 21:16:28 GMT-0700 (Pacific Daylight Time)">04:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell">So I guess it's using an existing pool? Good find.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Aug 12 2021 21:16:53 GMT-0700 (Pacific Daylight Time)">04:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in profiler view</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Aug 12 2021 21:17:00 GMT-0700 (Pacific Daylight Time)">04:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> can a function or virtual thread be factored out from other thread?</blockquote></mx-reply>No, it's all or nothing per native thread.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Aug 12 2021 21:18:12 GMT-0700 (Pacific Daylight Time)">04:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, then I'll use that thread.  maybe we could add a hint next to the "TaskContoller" checkbox in about:profiling what's in there</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Aug 12 2021 21:19:43 GMT-0700 (Pacific Daylight Time)">04:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: Oh, you can filter by function/label name (top-right of the Call Tree view). And if you find an interesting function, you can right click and "Focus on function". But you'd still have to go to different native threads, if that thread pool moves the JS Helper virtual thread around.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Aug 12 2021 21:20:36 GMT-0700 (Pacific Daylight Time)">04:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I see.  I'll look around all TaskController threads</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Aug 12 2021 21:22:05 GMT-0700 (Pacific Daylight Time)">04:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> okay, then I'll use that thread.  maybe we could add a hint next to the "TaskContoller" checkbox in about:profiling what's in there</blockquote></mx-reply>Based on this one experience, it sounds like "TaskController" may be hosting a number of virtual threads. ü§î What kind of hint do you think would have helped you?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Aug 12 2021 21:24:16 GMT-0700 (Pacific Daylight Time)">04:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">example list of fairly heavy tasks used there, maybe?  if there's a hint that mentions JS helper thread is in it, it would've helped</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Aug 12 2021 21:24:47 GMT-0700 (Pacific Daylight Time)">04:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if we can automatically collect the list of "named" threads/tasks from the source, having a link to the generated list would also be nice</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Aug 12 2021 21:27:08 GMT-0700 (Pacific Daylight Time)">04:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell">Good idea. I'm looking at getting more threads listed in about:profiling, so that would also help in a similar way. üëç</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Aug 12 2021 21:31:27 GMT-0700 (Pacific Daylight Time)">04:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sounds nice :)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Aug 12 2021 21:43:11 GMT-0700 (Pacific Daylight Time)">04:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@gerald:mozilla.org">gerald</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I've captured some ideas there, feel free to add more üòâ <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1725543">https://bugzilla.mozilla.org/show_bug.cgi?id=1725543</a> (But don't expect this to be resolved quickly, sorry!)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Aug 12 2021 21:44:49 GMT-0700 (Pacific Daylight Time)">04:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">thank you!</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Aug 12 2021 23:23:47 GMT-0700 (Pacific Daylight Time)">06:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">this changeset:</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Aug 12 2021 23:23:49 GMT-0700 (Pacific Daylight Time)">06:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">changeset:   658042:4792c28298b3<br>user:        Andr√© Bargull <a href="mailto:andre.bargull@gmail.com">andre.bargull@gmail.com</a><br>date:        Thu Aug 12 17:08:03 2021 +0000<br>summary:     Bug 1725379 - Part 8: Introduce jit/ABIArgGenerator.h. r=jandem</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Aug 12 2021 23:23:51 GMT-0700 (Pacific Daylight Time)">06:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1725379">https://bugzil.la/1725379</a> ‚Äî RESOLVED (anba) ‚Äî Remove unnecessary includes in js/src/jit</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Aug 12 2021 23:24:38 GMT-0700 (Pacific Daylight Time)">06:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">royally breaks merges of changes to MacroAssembler.h because it attempts to merge MacroAssembler.h into ABIArgIterator.h for some reason (some renaming happened?)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Aug 12 2021 23:24:57 GMT-0700 (Pacific Daylight Time)">06:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">easy to work around manually but very confusing</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Aug 12 2021 23:28:49 GMT-0700 (Pacific Daylight Time)">06:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">hm that is annoying </td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Aug 13 2021 01:35:51 GMT-0700 (Pacific Daylight Time)">08:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>, <span class="nick-7">gerald</span> : InternalThreadPool is only used by the shell so probably doesn't need to be hooked up to the profiler. In the browser we use the XPCOM thread pool instead (this is the TaskController threads).</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Aug 13 2021 01:38:00 GMT-0700 (Pacific Daylight Time)">08:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">TaskController is used for a bunch of different stuff so more information in the profiler about what this means sounds like a good idea.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Aug 13 2021 05:00:32 GMT-0700 (Pacific Daylight Time)">12:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">does anyone know how i can dump some data to a file (ideally with a name of my choosing) from a firefox content process, in a release-debug build?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Aug 13 2021 05:00:40 GMT-0700 (Pacific Daylight Time)">12:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">fopen fails, presumably because of the sandbox</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Aug 13 2021 05:01:01 GMT-0700 (Pacific Daylight Time)">12:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">but i have some data in the process that is not available from the network and i need to see it.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Aug 13 2021 05:01:04 GMT-0700 (Pacific Daylight Time)">12:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>security.sandbox.content.level=0</code></td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Aug 13 2021 05:01:09 GMT-0700 (Pacific Daylight Time)">12:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell">aha, thank you!</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Aug 13 2021 05:39:03 GMT-0700 (Pacific Daylight Time)">12:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">when does wasmExceptionsEnabled()  return true, when false? The implementation seems to be rather well hidden</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Aug 13 2021 05:39:10 GMT-0700 (Pacific Daylight Time)">12:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">is it based on some pref or something else?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Aug 13 2021 05:57:16 GMT-0700 (Pacific Daylight Time)">12:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">ah, perhaps <a href="https://searchfox.org/mozilla-central/rev/36904ac58d2528fc59f640db57cc9429103368d3/modules/libpref/init/StaticPrefList.yaml#6057">https://searchfox.org/mozilla-central/rev/36904ac58d2528fc59f640db57cc9429103368d3/modules/libpref/init/StaticPrefList.yaml#6057</a></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Aug 13 2021 06:28:53 GMT-0700 (Pacific Daylight Time)">13:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: <a href="https://searchfox.org/mozilla-central/source/js/public/WasmFeatures.h#108-115">https://searchfox.org/mozilla-central/source/js/public/WasmFeatures.h#108-115</a></td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Aug 13 2021 06:35:43 GMT-0700 (Pacific Daylight Time)">13:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><p>this sounds indeed convoluted, the function returning based on <a href="https://searchfox.org/mozilla-central/source/js/src/builtin/TestingFunctions.cpp#873">this link</a>, <a href="https://searchfox.org/mozilla-central/source/js/src/wasm/WasmJS.cpp#340">this link</a> and <a href="https://searchfox.org/mozilla-central/source/js/src/wasm/WasmJS.cpp#114">this link</a></p>
<pre><code>  setBoolean(WASM_EXCEPTIONS_ENABLED &amp;&amp; (!IsFuzzingIon(cx) &amp;&amp; !IsFuzzingCranelift(cx)) &amp;&amp; cx-&gt;options().wasmExceptions() &amp;&amp; BaselineAvailable(cx))
</code></pre>
</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Aug 13 2021 06:38:31 GMT-0700 (Pacific Daylight Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: <a href="https://searchfox.org/mozilla-central/source/dom/base/test/test_script_loader_js_cache.html#158">https://searchfox.org/mozilla-central/source/dom/base/test/test_script_loader_js_cache.html#158</a> is your question?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Aug 13 2021 06:38:58 GMT-0700 (Pacific Daylight Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">So problem is that alternativeDataInputStream is now "sync" and weird stuff is happining</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Aug 13 2021 06:39:24 GMT-0700 (Pacific Daylight Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">like alt input stream needs to be cloned if response is</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Aug 13 2021 06:39:34 GMT-0700 (Pacific Daylight Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: This is testing that a script can run if it was recorded with an SRI (subressource Integrity hash), and re-executed with the same SRI hash</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Aug 13 2021 06:41:52 GMT-0700 (Pacific Daylight Time)">13:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: The test case was written such that we wait until the "fallback_bytecode_saved" is sent to the script and bubble up to JavaScript.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Aug 13 2021 06:41:55 GMT-0700 (Pacific Daylight Time)">13:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/dom/base/test/test_script_loader_js_cache.html#145">https://searchfox.org/mozilla-central/source/dom/base/test/test_script_loader_js_cache.html#145</a></td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Aug 13 2021 06:42:39 GMT-0700 (Pacific Daylight Time)">13:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">The fact that it is synchronous should not change, let me double check where this event is emitted.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Aug 13 2021 06:43:55 GMT-0700 (Pacific Daylight Time)">13:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: <a href="https://searchfox.org/mozilla-central/source/dom/script/ScriptLoader.cpp#3551,3582-3583">https://searchfox.org/mozilla-central/source/dom/script/ScriptLoader.cpp#3551,3582-3583</a></td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Aug 13 2021 06:44:23 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">here is part of log <a href="https://pastebin.mozilla.org/Y5Soc6mS">https://pastebin.mozilla.org/Y5Soc6mS</a> </td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Aug 13 2021 06:45:27 GMT-0700 (Pacific Daylight Time)">13:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">The TRACE_FOR_TEST_NONE macro is used to emit an event on the script tag which bubbles up. So the event should always happen after the alternate data output got written to, plus an extra event loop to get the event processed.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Aug 13 2021 06:45:51 GMT-0700 (Pacific Daylight Time)">13:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">Looks like OpenAlternativeOutputStream fails because input stream for alt data is still open (effect of D117360)</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Aug 13 2021 06:47:17 GMT-0700 (Pacific Daylight Time)">13:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This is unfortunately something we expect to happen on the Web.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Aug 13 2021 06:47:53 GMT-0700 (Pacific Daylight Time)">13:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">A user could have multiple tabs opened on the same page, or multiple iframe loading the same libraries.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Aug 13 2021 06:48:43 GMT-0700 (Pacific Daylight Time)">13:48</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-14" title="@yury:mozilla.org">yury</span></div></td><td class="msg-cell">wonders what his next steps will be</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Aug 13 2021 06:48:52 GMT-0700 (Pacific Daylight Time)">13:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: are the data not fully written by the time of the new opened channel?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Aug 13 2021 06:51:58 GMT-0700 (Pacific Daylight Time)">13:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">per comment at <a href="https://searchfox.org/mozilla-central/source/dom/base/test/test_script_loader_js_cache.html#152">https://searchfox.org/mozilla-central/source/dom/base/test/test_script_loader_js_cache.html#152</a> , cache shall not be changed</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Aug 13 2021 06:52:02 GMT-0700 (Pacific Daylight Time)">13:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Sounds like we would need to <code>await</code> something else which guarantee that the alternateDataOutputStream got written to before making a new request.<br>Apparently making alternativeDataInputStream synchronous caused it to happen too early, not giving enough time for the data to be saved by the alternateDataOutputStream.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Aug 13 2021 06:52:46 GMT-0700 (Pacific Daylight Time)">13:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">alright, i'll try to instrument more around these two</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Aug 13 2021 06:53:10 GMT-0700 (Pacific Daylight Time)">13:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: what seems to happen is that [3] has not finished saving the alternateData while [4] is started, causing it to fallback instead of loading the bytecode.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Aug 13 2021 06:56:20 GMT-0700 (Pacific Daylight Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">To make the test case work, you would need a way to return the fact that the altData is fully written and accessible before submitting a new TRACE_FOR_TEST* event.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Aug 13 2021 06:57:08 GMT-0700 (Pacific Daylight Time)">13:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Or to await some cache event</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Aug 13 2021 07:00:49 GMT-0700 (Pacific Daylight Time)">14:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1487113#c81">https://bugzilla.mozilla.org/show_bug.cgi?id=1487113#c81</a></td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Aug 13 2021 07:02:29 GMT-0700 (Pacific Daylight Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">What would be interesting is the reason of the fallback, is that because it is loading an old version of the altData which does not have the SRI, or because it was not provided by the channel?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Aug 13 2021 07:03:28 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>:  my other test was failing because two consumers where using the same alt input stream</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Aug 13 2021 07:03:48 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This is an expected feature</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Aug 13 2021 07:04:33 GMT-0700 (Pacific Daylight Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">yeah, it was exactly the same stream, not a clone</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Aug 13 2021 07:06:03 GMT-0700 (Pacific Daylight Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">I had to clone alt input stream when response is cloned. Shall I do the same somewhere in JS script request/response logic?</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Aug 13 2021 07:07:47 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I do not think the script loader is cloning the channels (or I do not know enough of these internals)</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Aug 13 2021 07:08:08 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">The ScriptLoader create a new channel each time.</td></tr>

</tbody></table></div></div></div>
</body></html>