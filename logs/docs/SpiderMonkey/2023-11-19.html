<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-11-19</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-11-19<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-11-17" class="nav-link"><span>prev</span></a>
<a href="2023-11-20" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sat Nov 18 2023 18:02:11 GMT-0800 (Pacific Standard Time)">02:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Is there a way of calling <code>Function.toString()</code> from within the C++ API?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sat Nov 18 2023 18:31:55 GMT-0800 (Pacific Standard Time)">02:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: <a href="https://searchfox.org/mozilla-central/rev/2d5606f76a38d0907ea11d7a72ee3e3dbb69c1f7/js/public/Conversions.h#256">JS::ToString</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sat Nov 18 2023 18:51:13 GMT-0800 (Pacific Standard Time)">02:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">There should also be <code>JS_DecompileFunction</code></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sat Nov 18 2023 18:56:14 GMT-0800 (Pacific Standard Time)">02:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, indeed. that's more straightforward</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sat Nov 18 2023 19:18:44 GMT-0800 (Pacific Standard Time)">03:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Oh yes, I knew about that already. Thanks for the pointer.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sat Nov 18 2023 19:48:31 GMT-0800 (Pacific Standard Time)">03:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I have a question about async Promise resolution and error handing. The <code>enqueuePromiseJob()</code> override function gives me a job object, which I am later calling like this: <code>JS::Call(cx, ths, job, JS::HandleValueArray::empty(), &amp;rval)</code>. This seems to work fine, but if the awaited code in the async function throws an error, the <code>JS::Call</code> doesn't seem to return false. Is this expected, or am I doing something wrong? Ideally I'd like a way of catching all errors thrown from async code.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sat Nov 18 2023 19:51:22 GMT-0800 (Pacific Standard Time)">03:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the job function's result is unrelated to the reaction itself.  it fails only on internal error such like OOM.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sat Nov 18 2023 19:52:15 GMT-0800 (Pacific Standard Time)">03:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what kind of error are you thinking about?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sat Nov 18 2023 19:52:56 GMT-0800 (Pacific Standard Time)">03:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if you're targeting async function, any error inside it is propagated as rejection to the resulting promise</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sat Nov 18 2023 19:53:22 GMT-0800 (Pacific Standard Time)">03:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I was thinking about errors thrown in user written code. Checking the promise for rejection seems feasible.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sat Nov 18 2023 19:54:03 GMT-0800 (Pacific Standard Time)">03:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">maybe you want to check unhandled rejections?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sat Nov 18 2023 19:54:19 GMT-0800 (Pacific Standard Time)">03:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Yes, let me try that.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sat Nov 18 2023 19:55:52 GMT-0800 (Pacific Standard Time)">03:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>then, this can be used <a href="https://searchfox.org/mozilla-central/rev/2d5606f76a38d0907ea11d7a72ee3e3dbb69c1f7/js/public/Promise.h#268-273">https://searchfox.org/mozilla-central/rev/2d5606f76a38d0907ea11d7a72ee3e3dbb69c1f7/js/public/Promise.h#268-273</a></p>
<pre><code class="language-cpp">/**
 * Sets the callback that's invoked whenever a Promise is rejected without
 * a rejection handler, and when a Promise that was previously rejected
 * without a handler gets a handler attached.
 */
extern JS_PUBLIC_API void SetPromiseRejectionTrackerCallback(
</code></pre>
</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sat Nov 18 2023 19:56:13 GMT-0800 (Pacific Standard Time)">03:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>example: <a href="https://searchfox.org/mozilla-central/rev/2d5606f76a38d0907ea11d7a72ee3e3dbb69c1f7/xpcom/base/CycleCollectedJSContext.cpp#141-142">https://searchfox.org/mozilla-central/rev/2d5606f76a38d0907ea11d7a72ee3e3dbb69c1f7/xpcom/base/CycleCollectedJSContext.cpp#141-142</a></p>
<pre><code class="language-cpp">JS::SetPromiseRejectionTrackerCallback(mJSContext,
                                       PromiseRejectionTrackerCallback, this);
</code></pre>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sat Nov 18 2023 19:57:11 GMT-0800 (Pacific Standard Time)">03:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the API notifies "rejection with no handler", and also the later handling on the rejection"</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sat Nov 18 2023 19:57:35 GMT-0800 (Pacific Standard Time)">03:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you can track those events to generate a list of rejections which is not yet handled</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sat Nov 18 2023 20:15:43 GMT-0800 (Pacific Standard Time)">04:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Got it, this callback makes things pretty easy.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sat Nov 18 2023 20:16:13 GMT-0800 (Pacific Standard Time)">04:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">How do I get the debug info out of the rejected promise object?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sat Nov 18 2023 20:17:45 GMT-0800 (Pacific Standard Time)">04:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I can see it's there in a reserve slot...</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sat Nov 18 2023 20:18:47 GMT-0800 (Pacific Standard Time)">04:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">which debug info?  allocation site and resolution site?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Sat Nov 18 2023 20:19:02 GMT-0800 (Pacific Standard Time)">04:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>if so, <a href="https://searchfox.org/mozilla-central/rev/2d5606f76a38d0907ea11d7a72ee3e3dbb69c1f7/js/public/Promise.h#379,382">https://searchfox.org/mozilla-central/rev/2d5606f76a38d0907ea11d7a72ee3e3dbb69c1f7/js/public/Promise.h#379,382</a></p>
<pre><code class="language-cpp">extern JS_PUBLIC_API JSObject* GetPromiseAllocationSite(
...
extern JS_PUBLIC_API JSObject* GetPromiseResolutionSite(
</code></pre>
</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Sat Nov 18 2023 20:19:21 GMT-0800 (Pacific Standard Time)">04:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>also this is part of debug info <a href="https://searchfox.org/mozilla-central/rev/2d5606f76a38d0907ea11d7a72ee3e3dbb69c1f7/js/public/Promise.h#344">https://searchfox.org/mozilla-central/rev/2d5606f76a38d0907ea11d7a72ee3e3dbb69c1f7/js/public/Promise.h#344</a></p>
<pre><code class="language-cpp">JS_PUBLIC_API uint64_t GetPromiseID(JS::HandleObject promise);
</code></pre>
</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Sat Nov 18 2023 20:20:30 GMT-0800 (Pacific Standard Time)">04:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I'm just looking for an error message that I can print to the console. Maybe this is different than debug info.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Sat Nov 18 2023 20:32:27 GMT-0800 (Pacific Standard Time)">04:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><p>If I dig into the reserved slots like this, I can see all of relevant error information:</p>
<pre><code>    JS::RootedValue rv(cx, JS::GetReservedSlot(rejectedPromise, 1));
    js::DumpObject(rv.toObjectOrNull());
</code></pre>
</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Sat Nov 18 2023 20:33:41 GMT-0800 (Pacific Standard Time)">04:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">But doing <code>JS::GetReservedSlot</code> doesn't seem robust, and I'm wondering if there's a proper API function which generates the relevant error report.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Sat Nov 18 2023 20:39:11 GMT-0800 (Pacific Standard Time)">04:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS::GetPromiseResult</code> returns the rejection reason value</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Sat Nov 18 2023 20:39:59 GMT-0800 (Pacific Standard Time)">04:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that's what you get by <code>rejectedPromise.catch(e =&gt; { /* this e value */ })</code> in JS</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Sat Nov 18 2023 20:42:09 GMT-0800 (Pacific Standard Time)">04:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the value is what the user code throws or rejects.  it can be any value (not necessarily be <code>Error</code> object)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Sat Nov 18 2023 23:31:43 GMT-0800 (Pacific Standard Time)">07:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">It's working, thank you very much!</td></tr>

</tbody></table></div></div></div>
</body></html>