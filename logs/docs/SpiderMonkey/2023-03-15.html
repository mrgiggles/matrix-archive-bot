<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-03-15</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-03-15<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-03-14" class="nav-link"><span>prev</span></a>
<a href="2023-03-16" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Mar 15 2023 01:50:50 GMT-0700 (Pacific Daylight Time)">08:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Hello, I am using the Structured Clone stuff to serialize some <code>JSObjects</code> and save them to file. It's working well, however, sometimes the <code>JSObjects</code> contain <code>JSFunctions</code>, and these are not saved. I understand from the documentation that it's impossible to serialize functions. What I want to know is, err, how impossible is it? Because I really need a way of serializing functions in order for my app to work. Can anyone advise?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Mar 15 2023 01:53:05 GMT-0700 (Pacific Daylight Time)">08:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">function contains reference to enclosing environment, which is hard to serialize and deserialize, because it will conflict with the existing environment tree</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Mar 15 2023 01:54:01 GMT-0700 (Pacific Daylight Time)">08:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">how do you need to serialize function?  can it be done by some post-process on the deserialized object graph?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Mar 15 2023 01:55:35 GMT-0700 (Pacific Daylight Time)">08:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I don't understand yet what you mean, but I will describe my situation.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Mar 15 2023 01:59:21 GMT-0700 (Pacific Daylight Time)">08:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">for example, if the function is created by <code>new Function(...)</code> the enclosing scope is the global and has no closed over bindings.  they can be serialized by <code>toString()</code> and then indirect-<code>eval</code> on the stringified code will give you almost same function</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Mar 15 2023 02:01:08 GMT-0700 (Pacific Daylight Time)">09:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">So you mean I can take a compiled JSFunction, de-compile it to String and save the String for serialization and save the file. Then, when I open the file, I can re-compile the String to get the function. Is that correct?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Mar 15 2023 02:01:18 GMT-0700 (Pacific Daylight Time)">09:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but if the function is created by executing <code>function () { ... }</code> inside some other function, it can access to the enclosing function's environment, such as local variable.  e.g. <code>function outer() { var a = 0;  return function to_be_serialized() { return ++a; }; }</code>  it's almost impossible to keep that behavior across serialization</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Mar 15 2023 02:01:42 GMT-0700 (Pacific Daylight Time)">09:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Right, so closures and things are gone.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Mar 15 2023 02:02:07 GMT-0700 (Pacific Daylight Time)">09:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, so, you need to create your own way to serialize, depending on the requirements in your case</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Mar 15 2023 02:02:32 GMT-0700 (Pacific Daylight Time)">09:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I think I can live with that, but am I right in saying that the general approach outlined above should work?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Mar 15 2023 02:02:50 GMT-0700 (Pacific Daylight Time)">09:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I.e. converting functions to strings, and then back again?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Mar 15 2023 02:03:26 GMT-0700 (Pacific Daylight Time)">09:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, as long as the function doesn't try to access the non-local variable</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Mar 15 2023 02:04:26 GMT-0700 (Pacific Daylight Time)">09:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if it tries to access global variable, it will work as long as the global variable exists</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Mar 15 2023 02:06:11 GMT-0700 (Pacific Daylight Time)">09:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">but anything else, such as enclosing local variable, or bound variables (<code>.bind(...)</code>) won't work unless you apply some special handling</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Mar 15 2023 02:06:54 GMT-0700 (Pacific Daylight Time)">09:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I think I can live with that.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Mar 15 2023 02:07:12 GMT-0700 (Pacific Daylight Time)">09:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">What is the relevant method for stringifying a JSFunction?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Mar 15 2023 02:08:51 GMT-0700 (Pacific Daylight Time)">09:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">calling <code>fun.toString()</code> on it, or <code>JS_ValueToSource</code></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Mar 15 2023 02:08:57 GMT-0700 (Pacific Daylight Time)">09:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Thanks</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Mar 15 2023 02:08:59 GMT-0700 (Pacific Daylight Time)">09:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p><a href="https://searchfox.org/mozilla-central/rev/47aea2f603cc18144afcedbd604a418f11e90f9b/js/src/jsapi.h#134-135">https://searchfox.org/mozilla-central/rev/47aea2f603cc18144afcedbd604a418f11e90f9b/js/src/jsapi.h#134-135</a></p>
<pre><code class="language-cpp">extern JS_PUBLIC_API JSString* JS_ValueToSource(JSContext* cx,
                                                JS::Handle&lt;JS::Value&gt; v);
</code></pre>
</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Mar 15 2023 02:09:38 GMT-0700 (Pacific Daylight Time)">09:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p><a href="https://searchfox.org/mozilla-central/rev/47aea2f603cc18144afcedbd604a418f11e90f9b/js/src/jsapi.h#655-656">https://searchfox.org/mozilla-central/rev/47aea2f603cc18144afcedbd604a418f11e90f9b/js/src/jsapi.h#655-656</a></p>
<pre><code class="language-cpp">extern JS_PUBLIC_API JSString* JS_DecompileFunction(
    JSContext* cx, JS::Handle&lt;JSFunction*&gt; fun);
</code></pre>
</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Mar 15 2023 02:09:39 GMT-0700 (Pacific Daylight Time)">09:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Also, is there any way of identifying any locally-captured variables, so I can at least generate a warning?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Mar 15 2023 02:09:49 GMT-0700 (Pacific Daylight Time)">09:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS_DecompileFunction</code> looks like straightforward</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Mar 15 2023 02:11:57 GMT-0700 (Pacific Daylight Time)">09:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't know if there's simple way to check captured variables.   internally, it could be done by either checking each bytecode to see if it tries to access aliased variable, but it's likely not exposed as public API</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Mar 15 2023 02:14:22 GMT-0700 (Pacific Daylight Time)">09:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">OK. I have a good sense of how to proceed. I think that the captured-variable issue won't be that much of a problem in my use case.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Mar 15 2023 02:14:55 GMT-0700 (Pacific Daylight Time)">09:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Since you're here, I have another question. Hopefully an easy one.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Mar 15 2023 02:15:26 GMT-0700 (Pacific Daylight Time)">09:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I noticed that in jsfriendapi.h, there is a struct and some helpers for <code>JSFunctionSpecWithHelp</code></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Mar 15 2023 02:16:38 GMT-0700 (Pacific Daylight Time)">09:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Can I use this in place of <code>JSFunctionSpec</code> to define all of my global functions, but giving each function a help string, which I can then query later on?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Mar 15 2023 02:17:39 GMT-0700 (Pacific Daylight Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Is that the use-case for <code>JSFunctionSpecWithHelp</code> ?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Mar 15 2023 02:17:47 GMT-0700 (Pacific Daylight Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the implementation is in <a href="https://searchfox.org/mozilla-central/rev/47aea2f603cc18144afcedbd604a418f11e90f9b/js/src/jsfriendapi.cpp#198-235">jsfriendapi.cpp</a>, which just defines property on the created function</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Mar 15 2023 02:17:58 GMT-0700 (Pacific Daylight Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>usage</code> and <code>help</code> propeties</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Mar 15 2023 02:18:14 GMT-0700 (Pacific Daylight Time)">09:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, you can use the structure if that fits your case</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Mar 15 2023 02:20:14 GMT-0700 (Pacific Daylight Time)">09:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>in JS shell, those properties are accessed later just by getting those properties <a href="https://searchfox.org/mozilla-central/rev/47aea2f603cc18144afcedbd604a418f11e90f9b/js/src/shell/js.cpp#9610,9623">https://searchfox.org/mozilla-central/rev/47aea2f603cc18144afcedbd604a418f11e90f9b/js/src/shell/js.cpp#9610,9623</a></p>
<pre><code class="language-cpp">if (!JS_GetProperty(cx, funcObj, "help", &amp;v)) {
...
  if (!JS_GetProperty(cx, funcObj, "usage", &amp;v)) {
</code></pre>
</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Mar 15 2023 02:20:57 GMT-0700 (Pacific Daylight Time)">09:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if you need something different, defining your own struct and helper function to create the function with given properties would work</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Mar 15 2023 02:21:02 GMT-0700 (Pacific Daylight Time)">09:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I see, that makes a lot of sense. </td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Mar 15 2023 02:21:44 GMT-0700 (Pacific Daylight Time)">09:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Can I then use the  <code>JSFunctionSpecWithHelp[]</code> array in place of the normal <code> JSFunctionSpec[]</code> to define my global functtions?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Mar 15 2023 02:22:21 GMT-0700 (Pacific Daylight Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Mar 15 2023 02:23:03 GMT-0700 (Pacific Daylight Time)">09:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Great! I really like the possibility of defining help messages inline with the functions. I was getting ready to try to clobber together my own solution when I saw this one already.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Mar 15 2023 02:23:31 GMT-0700 (Pacific Daylight Time)">09:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Thanks for your help again! SpiderMonkey is awesome software.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Mar 15 2023 08:10:08 GMT-0700 (Pacific Daylight Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@bnjbvr:delire.party">bnjbvr</span>&gt;</div></td><td class="msg-cell">howdy! is there still some <code>perf</code> support for Spidermonkey JIT code?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Mar 15 2023 08:10:34 GMT-0700 (Pacific Daylight Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@bnjbvr:delire.party">bnjbvr</span>&gt;</div></td><td class="msg-cell">and in particular, could anyone point me to an entrypoint in the code that's generating the mapping of code regions to symbols?</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Mar 15 2023 08:11:59 GMT-0700 (Pacific Daylight Time)">15:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@bnjbvr:delire.party">bnjbvr</span>&gt;</div></td><td class="msg-cell">aaannd i actually found it lol <a href="https://searchfox.org/mozilla-central/source/js/src/jit/PerfSpewer.cpp">https://searchfox.org/mozilla-central/source/js/src/jit/PerfSpewer.cpp</a></td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Mar 15 2023 08:25:18 GMT-0700 (Pacific Daylight Time)">15:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">bnjbvr</span>: heh, I saw your mastodon post about <code>perf inject --jit</code>. We've recently started using <code>perf inject --jit</code> + <code>samply load <a href="http://jit.data">jit.data</a></code> to look at perf profiles of the JS shell in the Firefox profiler. I'm now working on jitdump parsing code so that we can avoid the <code>perf inject --jit</code> step and do <code>samply load <a href="http://perf.data">perf.data</a></code> directly</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Mar 15 2023 08:25:54 GMT-0700 (Pacific Daylight Time)">15:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">the <code>samply load <a href="http://perf.data">perf.data</a></code> work is happening in <a href="https://github.com/mstange/samply">https://github.com/mstange/samply</a></td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Mar 15 2023 08:41:52 GMT-0700 (Pacific Daylight Time)">15:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@bnjbvr:delire.party">bnjbvr</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">mstange</span>: ah, sweet, thanks for letting me know! any particular issue or PR where I could follow this work?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Mar 15 2023 08:45:03 GMT-0700 (Pacific Daylight Time)">15:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">bnjbvr</span>: I just filed <a href="https://github.com/mstange/samply/issues/33">https://github.com/mstange/samply/issues/33</a> for it</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Mar 15 2023 08:46:49 GMT-0700 (Pacific Daylight Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@bnjbvr:delire.party">bnjbvr</span>&gt;</div></td><td class="msg-cell">Awesome!</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Mar 15 2023 09:03:49 GMT-0700 (Pacific Daylight Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@bnjbvr:delire.party">bnjbvr</span>&gt;</div></td><td class="msg-cell">our wasmtime embedding running with <code>perf</code> support has generated a jitdump file of 108 MB</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Mar 15 2023 09:04:26 GMT-0700 (Pacific Daylight Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@bnjbvr:delire.party">bnjbvr</span>&gt;</div></td><td class="msg-cell">I've had to stop <code>perf inject</code>after it ran for 5 hours (at ~15% utilization of one CPU core, suggesting it could benefit from a RiiR) and generated around 175K .so files</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Mar 15 2023 09:28:18 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">whoa, that's a lot of jit code</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Mar 15 2023 10:23:44 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Does JSContext* or JS::Value* have anything like void* userdata?</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Mar 15 2023 10:26:05 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">have to create a function on the fly as needed for a template function that uses JS_DefineFunction, so I need the function pointer to the lambda which stops me from using capture list to pass in the function's argument which is a std::function instance</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Mar 15 2023 10:44:08 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">JSContext* does, (<code>JS::SetContextPrivate()</code>) JS::Value does not</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Mar 15 2023 10:46:19 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">interesting, this could work then</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Mar 15 2023 11:06:38 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> have to create a function on the fly as needed for a template function that uses JS_DefineFunction, so I need the function pointer to the lambda which stops me from using capture list to pass in the function's argument which is a std::function instance</blockquote></mx-reply>from reading this, if I understand correctly, if you generate the std::function instance on the fly, it sounds like you might also be able to have a JSNative implementation for this function, which generates the std::function and then calls it?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Mar 15 2023 11:07:20 GMT-0700 (Pacific Daylight Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">or does it need to cache the std::function for subsequent calls?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Mar 15 2023 11:09:21 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">if the situation is that the JS function generates the C++ functor on first call, and then calls the same functor again on subsequent calls, you might be able to stash the functor using <code>js::NewFunctionWithReserved</code></td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Mar 15 2023 11:27:40 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Does anyone know if the function JS_NewStringCopyZ could potentially be unsafe and lead to buffer overflows?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Mar 15 2023 12:42:21 GMT-0700 (Pacific Daylight Time)">19:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Yes I was going to use a wrapper to call the std::function<br><code>    auto* wrapper = +[](JSContext*, unsigned, JS::Value*) -&gt; bool {</code><br><code>    JSFunction* func = JS_DefineFunction(ctx, global, funcName.c_str(), wrapper, sizeof...(Args), 0);</code><br>Unfortunately the given/passed std::function doesn't follow JSNative signature, so it must be wrapped by a lambda that does.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Mar 15 2023 12:42:45 GMT-0700 (Pacific Daylight Time)">19:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">and yes the std::function needs to be cached for subsequent calls</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Mar 15 2023 12:47:58 GMT-0700 (Pacific Daylight Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">here's an example of using <code>js::NewFunctionWithReserved</code>: <a href="https://gitlab.gnome.org/GNOME/gjs/-/blob/master/gi/object.cpp#L768-787">https://gitlab.gnome.org/GNOME/gjs/-/blob/master/gi/object.cpp#L768-787</a></td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Mar 15 2023 12:49:26 GMT-0700 (Pacific Daylight Time)">19:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">you can stuff a pointer into the reserved slot with <code>JS::PrivateValue</code></td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Mar 15 2023 12:49:47 GMT-0700 (Pacific Daylight Time)">19:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">I guess the problem would be deallocating the pointer when it's no longer needed though</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Mar 15 2023 12:52:33 GMT-0700 (Pacific Daylight Time)">19:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">oh so you can create a JS function with its own reserved slot?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Mar 15 2023 12:56:46 GMT-0700 (Pacific Daylight Time)">19:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Why not <code>DefineFunctionWithReserved</code>?</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Mar 15 2023 12:57:03 GMT-0700 (Pacific Daylight Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">I think that'd be equivalent</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Mar 15 2023 13:03:18 GMT-0700 (Pacific Daylight Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">afaik with <code>js::SetFunctionNativeReserved</code> you cannot just put a <code>std::function</code> and whatever as it only takes JS::Value though</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Mar 15 2023 13:16:50 GMT-0700 (Pacific Daylight Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if it is convertible to a pointer, you can use <code>JS::PrivateValue(ptr)</code> to convert the pointer to a <code>JS::Value</code></td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Mar 15 2023 13:17:58 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">ahhh I see</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Mar 15 2023 13:37:55 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">now how can I get the native reserved slot within the lambda itself? <code>JS::GetMaybePtrFromReservedSlot&lt;T&gt;(obj, ACCESSOR_SLOT);</code></td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Mar 15 2023 13:38:34 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">as I don't think I can get the function object <code>obj</code> within the callback function that's defined/binded</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Mar 15 2023 14:20:24 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Does anyone know how to find out which Try jobs will run SpiderMonkey tests on an Android device?</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Mar 15 2023 14:23:37 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: jittest is executed on android. <code>Jit-1proc</code></td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Mar 15 2023 14:24:03 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">looks like jstest or jsreftest is not covered there</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Mar 15 2023 14:28:40 GMT-0700 (Pacific Daylight Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Thanks!
How can I find info like that in the future?</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Mar 15 2023 14:44:37 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">i clicked "add new jobs" on treeherder and then searched with jstest, jsreftest, and jittest from available jobs</td></tr>

</tbody></table></div></div></div>
</body></html>