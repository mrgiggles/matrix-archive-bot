<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-10-10</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-10-10<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-10-06" class="nav-link"><span>prev</span></a>
<a href="2023-10-11" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Oct 09 2023 22:28:16 GMT-0700 (Pacific Daylight Time)">05:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"> * In my embedding, I'm implementing <code>JS::JobQueue</code> so that I can use Promises. <code>enqueuePromiseJob()</code> gives me a <code>job</code> object, which I am then calling using<code>JS::Call()</code>. My question is this: is <code>JS::Call()</code> the right function to call to run the<code>job\</code>?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Oct 09 2023 22:28:23 GMT-0700 (Pacific Daylight Time)">05:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"> * In my embedding, I'm implementing <code>JS::JobQueue</code> so that I can use Promises. <code>enqueuePromiseJob()</code> gives me a <code>job</code> object, which I am then calling using<code>JS::Call()</code>. My question is this: is <code>JS::Call()</code> the right function to call to run the<code>job</code>?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Oct 09 2023 23:24:20 GMT-0700 (Pacific Daylight Time)">06:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"> * <del>It seems to be working fine, and my Promise job queue works. But when I stepped through, I noticed some behavior that I didn't expect. Running <code>JS::Call()</code> on <code>job</code> is actually queuing another Promise job, which then gets scheduled again. When the second one reaches <code>enqueuePromiseJob()</code>, <code>JS::Call()</code> gets called again, and this time it goes through. This makes me wonder if I should be unwrapping the first <code>job</code> somehow in order to avoid the redundant second promise.</del></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Oct 10 2023 01:02:05 GMT-0700 (Pacific Daylight Time)">08:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@standard8:mozilla.org">Standard8</span>&gt;</div></td><td class="msg-cell"><p>Does anyone know if the <a href="https://searchfox.org/mozilla-central/rev/1865e9fba4166ab2aa6c9d539913115723d9cc53/tools/lint/eslint/eslint-plugin-mozilla/lib/environments/jsm.js#24-29">globals referenced here</a> would be available in xpcshell?</p>
<p>Could it be that the BackstagePass is making them available <a href="https://searchfox.org/mozilla-central/rev/1865e9fba4166ab2aa6c9d539913115723d9cc53/js/xpconnect/src/XPCShellImpl.cpp#1334">because of this line</a>?</p>
<p>From testing they do seem to be available, but I just want to make sure I'm not missing anything.</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Oct 10 2023 01:03:13 GMT-0700 (Pacific Daylight Time)">08:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@standard8:mozilla.org">Standard8</span>&gt;</div></td><td class="msg-cell">Also, presumably, the <a href="https://searchfox.org/mozilla-central/rev/1865e9fba4166ab2aa6c9d539913115723d9cc53/tools/lint/eslint/eslint-plugin-mozilla/lib/environments/jsm.js">whole of that <code>jsm</code> environment</a> applies to sys.mjs files? Hence we could probably rename that environment now that we've got most jsms converted?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Oct 10 2023 01:44:13 GMT-0700 (Pacific Daylight Time)">08:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>crypto</code> etc are available from <a href="https://searchfox.org/mozilla-central/rev/1865e9fba4166ab2aa6c9d539913115723d9cc53/js/xpconnect/src/XPCWrappedNative.cpp#235">this line in XPCWrappedNative::WrapNewGlobal</a>, which is called by <a href="https://searchfox.org/mozilla-central/rev/1865e9fba4166ab2aa6c9d539913115723d9cc53/js/xpconnect/src/nsXPConnect.cpp#564">xpc::InitClassesWithNewWrappedGlobal</a>, from <a href="https://searchfox.org/mozilla-central/rev/1865e9fba4166ab2aa6c9d539913115723d9cc53/js/xpconnect/src/XPCShellImpl.cpp#1281">XRE_XPCShellMain</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Oct 10 2023 01:44:58 GMT-0700 (Pacific Daylight Time)">08:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and I agree with renaming the environment name</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Oct 10 2023 01:48:41 GMT-0700 (Pacific Daylight Time)">08:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@standard8:mozilla.org">Standard8</span>&gt;</div></td><td class="msg-cell">Aha, thank you. We might be able to remove some more of <code>importGlobalProperties</code> now ðŸ™‚</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Oct 10 2023 11:06:50 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: I wonder if there is some other good way to progress iGC than time or new allocations. (time, at least how we use it now, is problematic because it is the same regardless of the hardware.)  Could we estimate the speed by tracking how many objects a single slice can trace through in X ms or something like that. Though, that might be very inaccurate too, depending on the fragmentation and what else is happening in the system.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Oct 10 2023 11:24:41 GMT-0700 (Pacific Daylight Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Isn't the consistency of time good because ultimately we're trying to avoid being unresponsive to the user?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Oct 10 2023 11:31:46 GMT-0700 (Pacific Daylight Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">are we talking about a fallback if not enough idle time is found, or is this about even looking for idle time for iGC slices in the first place? I could definitely see targeting a percentage of (hopefully idle) time. eg: time the slices, then fire off another slice to make GC time at least 10% of total time (during an iGC).</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Oct 10 2023 11:31:59 GMT-0700 (Pacific Daylight Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: we're triggering slices way too often on slow machines where because of the speed there isn't much garbage</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Oct 10 2023 11:32:59 GMT-0700 (Pacific Daylight Time)">18:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, you want less frequent slices, not more</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Oct 10 2023 11:33:03 GMT-0700 (Pacific Daylight Time)">18:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: we're pretty good finding and using idle time. I recently tweaked that some more, so that we should have even more idle time</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Oct 10 2023 11:33:50 GMT-0700 (Pacific Daylight Time)">18:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">but when we're then running some code, and we "just" had idle time, we may still trigger a new slice because of the timer</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Oct 10 2023 11:34:23 GMT-0700 (Pacific Daylight Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">right</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Oct 10 2023 11:34:31 GMT-0700 (Pacific Daylight Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">on faster machine we often find idle time, but the same code runs slower on other machines, so that slice might get run in middle of something more critical</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Oct 10 2023 11:34:50 GMT-0700 (Pacific Daylight Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">...because the timer happened to fire</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Oct 10 2023 11:39:12 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">anyhow, considering what options we have here. Right now when running certain benchmarks especially on Android we do GC too much and at wrong time</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Oct 10 2023 11:41:01 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">is there a good example profile I could stare at? I'm working on something else, but I'd like to understand this better and be thinking about it.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Oct 10 2023 11:44:35 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">we could try adjusting <code>javascript_options_gc_delay_interslice</code> based on measured slice rate of progress, like you suggested. Have you experimented with bumping that up on Android? 250 -&gt; 1000 or something.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Oct 10 2023 11:56:53 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>:  I don't have a good profile at hand right now. I can create later. <a href="https://treeherder.mozilla.org/perfherder/comparesubtest?originalProject=try&amp;newProject=try&amp;newRevision=6a5669f7e4ebb6e6566408f0f6411055c36eda14&amp;originalSignature=4590278&amp;newSignature=4590278&amp;framework=13&amp;application=geckoview&amp;originalRevision=e7fdeb7b0e36678426d92779f74f2074a88aacbe&amp;page=1&amp;showOnlyConfident=1">This</a> has 1000 interslice  (and it also makes JS engine triggered slices increase the budget if there is a pending CC)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Oct 10 2023 12:00:00 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, that's good data</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Oct 10 2023 12:09:18 GMT-0700 (Pacific Daylight Time)">19:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(though adding in the replicates makes most of the changes go away)</td></tr>

</tbody></table></div></div></div>
</body></html>