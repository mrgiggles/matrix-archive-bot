<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-09-16</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-09-16<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-09-15" class="nav-link"><span>prev</span></a>
<a href="2022-09-17" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Sep 15 2022 18:04:49 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I see, I guess that's why it should just be a reaction</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Sep 15 2022 18:06:39 GMT-0700 (Pacific Daylight Time)">01:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">It seems that the promise object returned is weird.<br>It returns <code>true</code> for <code>IsPromiseObject</code>.<br>It returns <code>PromiseState::Rejected</code> for <code>GetPromiseState</code>.<br>Somehow it fails the <code>is&lt;PromiseObject&gt;</code> (in <code>as&lt;T&gt;</code>) assertion in <code>GetPromiseResult</code> though.<br>I'm very confused</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Sep 15 2022 18:07:38 GMT-0700 (Pacific Daylight Time)">01:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can you pastebin the code around those calls?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Sep 15 2022 18:09:55 GMT-0700 (Pacific Daylight Time)">01:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">do you call them in the same block, or do you call them in different places?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Sep 15 2022 18:11:16 GMT-0700 (Pacific Daylight Time)">01:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><a href="https://paste.gg/p/redfire/4e0a31932be24a16851371d85e731510">https://paste.gg/p/redfire/4e0a31932be24a16851371d85e731510</a><br>The <code>IsPromiseObject</code> is a separate block, but the other two are the same one</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Sep 15 2022 18:12:45 GMT-0700 (Pacific Daylight Time)">01:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">do you have multiple globals?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Sep 15 2022 18:12:59 GMT-0700 (Pacific Daylight Time)">01:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Nope, just 1</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Sep 15 2022 18:13:34 GMT-0700 (Pacific Daylight Time)">01:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>GetPromiseState</code> unwraps wrapper, so if the promise in <code>Promise::result</code> is wrapped, the assertion could fail</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Sep 15 2022 18:14:17 GMT-0700 (Pacific Daylight Time)">01:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p><a href="https://searchfox.org/mozilla-central/rev/0948667bc62415d48abff27e1405fb4ab4d65d75/js/src/jsapi.cpp#2605-2606">https://searchfox.org/mozilla-central/rev/0948667bc62415d48abff27e1405fb4ab4d65d75/js/src/jsapi.cpp#2605-2606</a></p>
<pre><code class="language-cpp">JS_PUBLIC_API JS::PromiseState JS::GetPromiseState(JS::HandleObject promise) {
  PromiseObject* promiseObj = promise-&gt;maybeUnwrapIf&lt;PromiseObject&gt;();
</code></pre>
</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Sep 15 2022 18:14:40 GMT-0700 (Pacific Daylight Time)">01:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">The <code>IsPromiseObject</code> at the start works though</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Sep 15 2022 18:15:00 GMT-0700 (Pacific Daylight Time)">01:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">which is just a <code>is&lt;PromiseObject&gt;</code> check</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Sep 15 2022 18:15:04 GMT-0700 (Pacific Daylight Time)">01:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can you check <code>IsPromiseObject</code> in <code>result</code> method?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Sep 15 2022 18:18:47 GMT-0700 (Pacific Daylight Time)">01:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, can you check the actual implementation of those 3 APIs in your copy of SpiderMonkey ?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Sep 15 2022 18:25:18 GMT-0700 (Pacific Daylight Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Actual implementation of those 3 is exactly the same</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Sep 15 2022 18:25:44 GMT-0700 (Pacific Daylight Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">i'll check <code>IsPromiseObject</code> in a sec</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Sep 15 2022 18:26:10 GMT-0700 (Pacific Daylight Time)">01:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">same?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Sep 15 2022 18:26:47 GMT-0700 (Pacific Daylight Time)">01:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">do you mean it's same as esr102 ?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Sep 15 2022 18:27:37 GMT-0700 (Pacific Daylight Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">same as esr102 yes</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Sep 15 2022 18:27:47 GMT-0700 (Pacific Daylight Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><p>anyway, output</p>
<pre><code>[cli\src\evaluate.rs:92] Promise::from(rt.cx(), promise.get()) = Some(
    Promise {
        obj: 0x000032c608602690,
    },
)
[ion\src\objects\promise.rs:156] IsPromiseObject(robj.handle().into()) = true
[ion\src\objects\promise.rs:160] GetPromiseState(robj.handle().into()) = Rejected
</code></pre>
</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Sep 15 2022 18:28:36 GMT-0700 (Pacific Daylight Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what's the backtrace of the assertion failure?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Sep 15 2022 18:29:25 GMT-0700 (Pacific Daylight Time)">01:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">That's weird, didn't happen</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Sep 15 2022 18:29:47 GMT-0700 (Pacific Daylight Time)">01:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">but also I messed up an <code>Err</code> so I need to recompile to check if it outputted the correct value</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Sep 15 2022 18:31:06 GMT-0700 (Pacific Daylight Time)">01:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Oh wait, the last time I had an assertion failure was with rooting twice and me running <code>promise.state(cx)</code> and <code>promise.result(cx)</code> separately</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Sep 15 2022 18:31:21 GMT-0700 (Pacific Daylight Time)">01:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">(rooted outside still though)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Sep 15 2022 18:31:53 GMT-0700 (Pacific Daylight Time)">01:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it looks like <code>Promise.obj</code> is not traced</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Sep 15 2022 18:31:59 GMT-0700 (Pacific Daylight Time)">01:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it might be the issue</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Sep 15 2022 18:32:02 GMT-0700 (Pacific Daylight Time)">01:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">uhh, its silentlly crashing</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Sep 15 2022 18:32:31 GMT-0700 (Pacific Daylight Time)">01:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">I'm right on time rn so I'll do that debug in like an hour</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Sep 15 2022 18:32:35 GMT-0700 (Pacific Daylight Time)">01:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">short on time*</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Sep 15 2022 18:33:04 GMT-0700 (Pacific Daylight Time)">01:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>Rooted</code> and <code>Handle</code> has 2 purposes.  one is to root the pointed object, to avoid getting GCed</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Sep 15 2022 18:33:20 GMT-0700 (Pacific Daylight Time)">01:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">other is to keep the pointer up-to-date when the pointed object is moved by GC</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Sep 15 2022 18:33:59 GMT-0700 (Pacific Daylight Time)">01:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if you have raw pointer around and GC moves the object while the raw pointer is alive, the raw pointer becomes dangling pointer</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Sep 15 2022 18:34:40 GMT-0700 (Pacific Daylight Time)">01:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Is it known/intended behaviour that <code>await</code> doesn't work inside <code>evalInWorker</code>? Unless I'm missing something, we never drain the job queue, so even something trivial like <code>await 3</code> never resolves.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Sep 15 2022 18:36:26 GMT-0700 (Pacific Daylight Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">at least I'm not aware of any code that handles promise inside shell worker</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Sep 15 2022 18:38:57 GMT-0700 (Pacific Daylight Time)">01:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>hm, it has job queue <a href="https://searchfox.org/mozilla-central/rev/0948667bc62415d48abff27e1405fb4ab4d65d75/js/src/shell/js.cpp#4082">https://searchfox.org/mozilla-central/rev/0948667bc62415d48abff27e1405fb4ab4d65d75/js/src/shell/js.cpp#4082</a></p>
<pre><code class="language-cpp">js::UseInternalJobQueues(cx);
</code></pre>
</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Sep 15 2022 18:40:47 GMT-0700 (Pacific Daylight Time)">01:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><pre><code>evalInWorker(`
Promise.resolve(4).then(x =&gt; console.log(x));
drainJobQueue();
`);
</code></pre>
</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Sep 15 2022 18:40:54 GMT-0700 (Pacific Daylight Time)">01:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><pre><code>evalInWorker(`
  (async () =&gt; {
    print(2);
    print(await 3);
   })()
`);
</code></pre>
<p>This prints "2", but adding <code>drainJobQueues</code> after the IIFE prints both 2 and 3.</p>
</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Sep 15 2022 18:41:36 GMT-0700 (Pacific Daylight Time)">01:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, explicit <code>drainJobQueue</code> inside the worker will be necessary</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Sep 15 2022 18:42:02 GMT-0700 (Pacific Daylight Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The problem is that I'm trying to get test262 testcases for waitAsync to pass</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Sep 15 2022 18:42:59 GMT-0700 (Pacific Daylight Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, I think, the problem is that the shell does not implicitly drain jobs in worker context when exitting</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Sep 15 2022 18:43:37 GMT-0700 (Pacific Daylight Time)">01:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or maybe when the worker thread exits</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Sep 15 2022 18:44:45 GMT-0700 (Pacific Daylight Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think it has to be when the worker thread exits, yeah</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Sep 15 2022 18:45:08 GMT-0700 (Pacific Daylight Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Is there a reason that we don't already drain the job queue?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Sep 15 2022 18:45:32 GMT-0700 (Pacific Daylight Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(As in, if I start draining the job queue implicitly, will things break?)</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Sep 15 2022 18:46:37 GMT-0700 (Pacific Daylight Time)">01:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I guess I can just try it out and see</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Sep 15 2022 18:47:08 GMT-0700 (Pacific Daylight Time)">01:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I assume simply because there was no consumer</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Sep 15 2022 19:48:00 GMT-0700 (Pacific Daylight Time)">02:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> uhh, its silentlly crashing</blockquote></mx-reply>Seems to just be repeatedly stuck on the <code>as&lt;PromiseObject&gt;</code> line, lldb step just stays there?</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Sep 15 2022 20:03:33 GMT-0700 (Pacific Daylight Time)">03:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><pre><code>Exception: Exception 0xc0000005 encountered at address 0x7ff6f3b4fac3: Access violation reading location 0x00000000
</code></pre>
<p>No idea</p>
</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Sep 15 2022 23:02:21 GMT-0700 (Pacific Daylight Time)">06:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell">I added a custom MIR instruction which calls into C++. in C++, I'm trying to serialize the MIR instructions parameter (via structured clone). the serialization might fail but I don't want to bubble the JS exception into the user script, so I'm calling <code>JS_ClearPendingException</code>. is this something that "should work" or am I missing something?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Sep 15 2022 23:18:38 GMT-0700 (Pacific Daylight Time)">06:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">l11d</span>: I would expect it to work. Is it failing?</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Sep 15 2022 23:25:17 GMT-0700 (Pacific Daylight Time)">06:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@l11d:mozilla.org">l11d</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: it works almost always. actually, it produced a weird result just once while fuzzing with this MIR instruction for 1.000.000&gt; CPU hours. the issue seems to be somehow related to the structured clone failing, which in turn creates an ErrorObject. this (somehow?) modifies the global object, causing a subsequent loaddynamicslot to return an incorrect result. if I use a vanilla version of the engine this is not an issue though, as the failing structured clone causes a bailout (which I suppressed via <code>JS_ClearPendingException</code>)</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Sep 16 2022 01:24:34 GMT-0700 (Pacific Daylight Time)">08:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ms2ger:igalia.com">Ms2ger ðŸ’‰ðŸ’‰</span>&gt;</div></td><td class="msg-cell">You sure it's not just bad ram?</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Sep 16 2022 02:04:25 GMT-0700 (Pacific Daylight Time)">09:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">If I use <code>JS_DeletePropertyById()</code>, I get a linker error. Other functions in the same header work fine. Do other people have the same problem?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Sep 16 2022 02:11:40 GMT-0700 (Pacific Daylight Time)">09:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">yeah the header is wrong, <a href="https://searchfox.org/mozilla-central/source/js/public/PropertyAndElement.h#408">https://searchfox.org/mozilla-central/source/js/public/PropertyAndElement.h#408</a></td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Sep 16 2022 02:11:46 GMT-0700 (Pacific Daylight Time)">09:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">jsid should be Handle&lt;jsid&gt;</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Sep 16 2022 02:16:41 GMT-0700 (Pacific Daylight Time)">09:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Redfire</span>: can you check backtrace?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Sep 16 2022 06:52:36 GMT-0700 (Pacific Daylight Time)">13:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">stacktrace and lldb bt are here
<a href="https://paste.gg/p/redfire/4e0a31932be24a16851371d85e731510">https://paste.gg/p/redfire/4e0a31932be24a16851371d85e731510</a></td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Sep 16 2022 07:32:13 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">I am having some issues with dead-locks in GC, In a child process after doing a fork. This is using ESR78 version. Basically I have a "fork" function, that can be called from JS, which does a fork. Typically my child process runs through its code and as the process is cleaning during exit, GC gets called, and it stalls in pthread_cond_signal. After some further testing.....basically it looks like anytime the GC gets called in the child process, it stalls in the same place. </td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Sep 16 2022 07:33:08 GMT-0700 (Pacific Daylight Time)">14:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">Is spider monkey "fork-safe" is this just something I need to avoid doing altogether?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Sep 16 2022 08:23:16 GMT-0700 (Pacific Daylight Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell"><p>I work with <span class="nick-3">dheitbrink</span> We do something that works with JS1.8.5 and is hanging up in JS78 (our current version):</p>
<p>We have a JS Native function that calls fork, to fork the whole process running the SM script.   It acts like Unix fork, it returns a different value to the parent and child scripts, so they can behave appropriately.</p>
</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Sep 16 2022 08:27:16 GMT-0700 (Pacific Daylight Time)">15:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jyanga:mozilla.org">jyanga</span>&gt;</div></td><td class="msg-cell">hi all....i was able to compile <code>spidermonkey</code>.  how do i know what version was compiled? how do i specify what version to compile?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Sep 16 2022 09:23:01 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Is there documentation somewhere about what exactly the rooting API does?  I'm not totally clear on it.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Sep 16 2022 09:28:41 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">u mean the rooting guide?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Sep 16 2022 09:28:43 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr78/docs/GC%20Rooting%20Guide.md">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr78/docs/GC%20Rooting%20Guide.md</a></td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Sep 16 2022 09:29:00 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">Is there something that doesn't explain?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Sep 16 2022 09:29:26 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I just wasn't aware of the guide.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Sep 16 2022 09:42:00 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: There's also <a href="https://searchfox.org/mozilla-central/source/js/public/RootingAPI.h#34">this</a></td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Sep 16 2022 11:44:42 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Is there any information on how to access the data of an ArrayBuffer object from spidermonkey?</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Sep 16 2022 11:55:48 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I see that there's an ArrayBuffer.h with lots of info about how to use it.  I'll just look into that.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Sep 16 2022 13:54:30 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@tcampbell:mozilla.org">tcampbell|ooo-thru-sept-24</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">chaircrusher</span> <span class="nick-3">dheitbrink</span> My understanding of <code>fork</code> is that it doesn't duplicate threads in the new process. The GC uses helper-threads that are allocated on startup. I suspect we didn't have these GC helper threads in 1.8.5, but do use them in 78.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Sep 16 2022 13:55:17 GMT-0700 (Pacific Daylight Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@tcampbell:mozilla.org">tcampbell|ooo-thru-sept-24</span>&gt;</div></td><td class="msg-cell"><a href="https://pubs.opengroup.org/onlinepubs/009604499/functions/pthread_atfork.html">https://pubs.opengroup.org/onlinepubs/009604499/functions/pthread_atfork.html</a></td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Sep 16 2022 13:59:49 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">yes, threads do not get replicated on fork. Is there anyway we can interact with the GC/ and or helper threads to deal with this? </td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Sep 16 2022 14:01:47 GMT-0700 (Pacific Daylight Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@tcampbell:mozilla.org">tcampbell|ooo-thru-sept-24</span>&gt;</div></td><td class="msg-cell">GlobalHelperThreadState centralizes a bunch of this, so you might be able to patch that using pthreads_atfork. The threads are work-queues, so you should be able to use the pre-fork hook to wait for them to go idle, and then post-fork might be able to create the new threads.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Sep 16 2022 14:04:03 GMT-0700 (Pacific Daylight Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@tcampbell:mozilla.org">tcampbell|ooo-thru-sept-24</span>&gt;</div></td><td class="msg-cell">Might also have to play with <code>TlsContext</code> which binds a JSContext to the thread. <a href="https://searchfox.org/mozilla-esr78/source/js/src/vm/JSContext.h#130">https://searchfox.org/mozilla-esr78/source/js/src/vm/JSContext.h#130</a></td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Sep 16 2022 14:05:12 GMT-0700 (Pacific Daylight Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@tcampbell:mozilla.org">tcampbell|ooo-thru-sept-24</span>&gt;</div></td><td class="msg-cell">Overall seems possible to acheive, but you'd be the first. The uses of <code>fork</code> that spidermonkey has supported to-date are very early in startup and are focused on sharing memory for .so file relocations.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Sep 16 2022 14:07:33 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">OK thanks. This will give me something to ponder over the weekend.</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Sep 16 2022 14:08:51 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@tcampbell:mozilla.org">tcampbell|ooo-thru-sept-24</span>&gt;</div></td><td class="msg-cell">The one complexity I can see is if you used Workers in your app it would be somewhat painful to figure this out, but if that is not the case it might not be that horrific.</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Sep 16 2022 14:10:31 GMT-0700 (Pacific Daylight Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">Our app is single threaded and we don't do anything with multiprocessing. The threading is all an issue of the SpiderMonkey interpreter-created threads.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Sep 16 2022 14:11:36 GMT-0700 (Pacific Daylight Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">We're trying to return from a JSNative function int he child process back to the currently running script context.  </td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Sep 16 2022 14:12:04 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@chaircrusher:mozilla.org">chaircrusher</span>&gt;</div></td><td class="msg-cell">In other words we want a fork SpiderMonkey function so that the parent can start a long process and then terminate</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Sep 16 2022 14:16:35 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">I don't think we typically have much in the way of JS that is run after said long native call typically.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Sep 16 2022 14:50:36 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@tcampbell:mozilla.org">tcampbell|ooo-thru-sept-24</span>&gt;</div></td><td class="msg-cell">might just be able to build spidermonkey as no-threads then</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Sep 16 2022 14:51:38 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@tcampbell:mozilla.org">tcampbell|ooo-thru-sept-24</span>&gt;</div></td><td class="msg-cell">There is a <code>js::DisableExtraThreads</code> API which might be what you need</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Sep 16 2022 14:54:58 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@tcampbell:mozilla.org">tcampbell|ooo-thru-sept-24</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">dheitbrink</span>: ^ might be an easy fix</td></tr>

</tbody></table></div></div></div>
</body></html>