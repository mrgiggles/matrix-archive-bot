<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2020-02-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2020-02-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2020-02-06" class="nav-link"><span>prev</span></a>
<a href="2020-02-10" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Feb 06 2020 20:27:19 GMT-0800 (Pacific Standard Time)">04:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@rampr:mozilla.org">rampr</span>&gt;</div></td><td class="msg-cell">We are using spidermonkey in a game engine(cocos2d-x) and we are getting crashes in spidermonkey and we haven't been able to get the javascript code causing the issue. We have managed to recompile spidermonkey and get the stacktrace. The stack trace is here -&gt; <a href="https://pastebin.com/vMir73ki">https://pastebin.com/vMir73ki</a>. Any pointers to help us dig would be very useful.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Feb 06 2020 20:28:23 GMT-0800 (Pacific Standard Time)">04:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@rampr:mozilla.org">rampr</span>&gt;</div></td><td class="msg-cell">Also is there any way to get the javascript code causing the crash? Thank you.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Feb 06 2020 20:30:05 GMT-0800 (Pacific Standard Time)">04:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">rampr</span>: If you jump up a few frames in a debugger to <code>Interpret</code>, there's probably a <code>JSScript*</code> or <code>RootedScript</code> or <code>Rooted&lt;JSScript*&gt;</code> local that you could dump, I think maybe with <code>DumpScript</code> or so, to find the script you're in.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Feb 06 2020 20:31:19 GMT-0800 (Pacific Standard Time)">04:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">rampr</span>: Past that, tho, I don't know that people here are likely to be able to offer terribly much help -- <code>js::PerThreadData</code> doesn't even exist in the current engine, so presumably you're using a somewhat older SpiderMonkey, and people's memories tend to fade quickly for stuff that doesn't exist in the current engine or in supported stable releases.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Feb 06 2020 20:33:01 GMT-0800 (Pacific Standard Time)">04:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">My assumption is that crash address is for some fixed, identifiable field in <em>presumably</em> <code>js::PerThreadData</code>, but I can't very well say what if it's not in current source.  Basically knowing what the null pointer access is into, and then figuring out why that pointer is null, is probably the right path of attack here.  But without the relevant SpiderMonkey source at hand, which you have and I do not, I couldn't say.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Feb 06 2020 20:36:38 GMT-0800 (Pacific Standard Time)">04:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@rampr:mozilla.org">rampr</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-15">Waldo</span>: Thanks. The spidermonkey is rather old. v33 is being used. The source code is at <a href="https://github.com/cocos2d/spidermonkey">https://github.com/cocos2d/spidermonkey</a>.<br>Also the crash isn't happening during our tests and it seems to be happening only with real users on android devices(Ours is a game that is using js, hence the game engine is using spidermonkey to interpret)<br>So we can't use debugger because it is happening only in live devices. So far we have been trying to send crash information to external tools like crashlytics and log events around.</p>
<p>We were wondering if we could send the javascript code that was probably executing and that lead to the crash and send it to these tools so we can understand better</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Feb 06 2020 20:43:49 GMT-0800 (Pacific Standard Time)">04:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">@rampr:<a href="http://mozilla.org">mozilla.org</a>: You probably should start instrumenting relevant SpiderMonkey code to figure out more details, I think. Log more info to a file, or something. And/or read the source of that <code>PerThreadData</code> function to figure out the answer to my suggestion. I don't think I can offer much more help than that, tho.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Feb 06 2020 20:54:58 GMT-0800 (Pacific Standard Time)">04:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@rampr:mozilla.org">rampr</span>&gt;</div></td><td class="msg-cell">Thanks <span class="nick-15">Waldo</span>. We have definitely some inputs from your suggestions above. We'll try those out and come back with specific questions later based on our investigations.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Feb 07 2020 02:48:33 GMT-0800 (Pacific Standard Time)">10:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">pbone</span>: What are you working on lately?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Feb 07 2020 07:00:46 GMT-0800 (Pacific Standard Time)">15:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell">tcampbell: the same time for stencil meetings works great for me! </td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Feb 07 2020 07:02:53 GMT-0800 (Pacific Standard Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>:</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Feb 07 2020 07:03:00 GMT-0800 (Pacific Standard Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@caroline:mozilla.org">caroline</span>&gt;</div></td><td class="msg-cell">^</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Feb 07 2020 07:04:01 GMT-0800 (Pacific Standard Time)">15:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">üëçÔ∏è</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Feb 07 2020 07:47:01 GMT-0800 (Pacific Standard Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: wednesdays work for me as before</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Feb 07 2020 07:47:19 GMT-0800 (Pacific Standard Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">so, I had some interesting results I was re-confirming with some browsing sessions.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Feb 07 2020 07:48:11 GMT-0800 (Pacific Standard Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">it seems like on the actual web, about 50% of identifier <em>uses</em> (or more) are of single-letter ids.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Feb 07 2020 07:48:57 GMT-0800 (Pacific Standard Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">heh</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Feb 07 2020 07:49:03 GMT-0800 (Pacific Standard Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">furthermore, independently, 2/3 to 3/4 ths of all atom uses are from a small fixed <em>independent</em> set.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Feb 07 2020 07:49:27 GMT-0800 (Pacific Standard Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">ok, but what can we use that for ...</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Feb 07 2020 07:50:16 GMT-0800 (Pacific Standard Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">so, given that our StencileScope structures will eventually need to at least have a minimally uint32_t (maximally uint64_t or pointer-sized) canonical reference to a string.  I think it's reasonable to consider reserving some of the reference numberspace for immediate encoding of at least length-1 atoms</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Feb 07 2020 07:50:47 GMT-0800 (Pacific Standard Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">also, for some reason, the atom ".this" shows up a lot</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Feb 07 2020 07:51:01 GMT-0800 (Pacific Standard Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">that's because of how we implement <code>this</code></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Feb 07 2020 07:51:06 GMT-0800 (Pacific Standard Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">and to be clear, by "uses" I mean uses in the parser - i.e. occurrences in the text that we need to materialize/represent</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Feb 07 2020 07:51:40 GMT-0800 (Pacific Standard Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">I suppose it will make sense to echo the optimizations we already have for atoms in this new thing</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Feb 07 2020 07:52:16 GMT-0800 (Pacific Standard Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">JSInlineString</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Feb 07 2020 08:03:34 GMT-0800 (Pacific Standard Time)">16:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">jorendorff</span>: which optimizations did you have in mind?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Feb 07 2020 08:04:38 GMT-0800 (Pacific Standard Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: just <code>StaticStrings</code> and <code>JSThinInlineString</code></td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Feb 07 2020 08:05:26 GMT-0800 (Pacific Standard Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: But it seems like that data might argue for still having a global pool of new-atoms, since we think we'll be new-atomizing the same strings a lot of times</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Feb 07 2020 08:05:36 GMT-0800 (Pacific Standard Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">in that case I don't know what we do</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Feb 07 2020 08:06:55 GMT-0800 (Pacific Standard Time)">16:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">so I was thinking a bit more aggressively on the optimizing identifiers bit.  I want to reserve the a high 8-bit space of any "parse-atom  table index" to represent an atom directly.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Feb 07 2020 08:07:13 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: that makes sense yes</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Feb 07 2020 08:07:28 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">that's what i was thinking too</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Feb 07 2020 08:07:44 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">oh, cool</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Feb 07 2020 08:07:58 GMT-0800 (Pacific Standard Time)">16:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i think by far the most common operations on these things</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Feb 07 2020 08:08:04 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">are equality testing and hashing</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Feb 07 2020 08:08:23 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">I say that because</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Feb 07 2020 08:08:30 GMT-0800 (Pacific Standard Time)">16:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">having a complicated representation for the <em>pointer</em> to the string really will complicate some stuff</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Feb 07 2020 08:09:20 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">but equality is unaffected, and for hashing, just adds a branch, it's probably fine</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Feb 07 2020 08:10:11 GMT-0800 (Pacific Standard Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">and for converting those to JSAtoms during JSScript::InitFromStencil, since we're echoing optimizations we already have, that could actually make things faster, depending</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Feb 07 2020 08:10:18 GMT-0800 (Pacific Standard Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i mean, not much faster. but whatever!</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Feb 07 2020 08:13:09 GMT-0800 (Pacific Standard Time)">16:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: tagged-pointers makes some of the new-atom type's Rust implementation need the <code>unsafe</code> keyword, I think, since by default <code>enum NewAtom { InlineString(u32), Heap(Box&lt;NewAtomData&gt;) }</code> will be two words, not one, and not ABI-compatible with C</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Feb 07 2020 08:13:14 GMT-0800 (Pacific Standard Time)">16:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">but I'm 100% ok with that</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Feb 07 2020 08:13:40 GMT-0800 (Pacific Standard Time)">16:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">that's what <code>unsafe</code> is for, when cycles matter</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Feb 07 2020 08:15:05 GMT-0800 (Pacific Standard Time)">16:15</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-13" title="@emilio:mozilla.org">emilio</span></div></td><td class="msg-cell">thinks of his terrible tagged pointer for the style system (<a href="https://searchfox.org/mozilla-central/rev/623de665034eee43a54ff02939b61385ffd5990d/servo/components/style/values/computed/length_percentage.rs#104">https://searchfox.org/mozilla-central/rev/623de665034eee43a54ff02939b61385ffd5990d/servo/components/style/values/computed/length_percentage.rs#104</a>) and cries thinking that it won't be a nice enum anymore :(</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Feb 07 2020 08:15:43 GMT-0800 (Pacific Standard Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">so, I'm keen on this mostly because I'd really like to justify per-body string tables in stencils, instead of some larger per-source mapping.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Feb 07 2020 08:16:35 GMT-0800 (Pacific Standard Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">the lifetime management and serialization issues become a lot simpler.  Not that they're unsolveable the other way, but they seem like unnecessary maintenance burden to impose on spidermonkey hackers going forward for the benefit (if any) that it provides.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Feb 07 2020 08:16:55 GMT-0800 (Pacific Standard Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">hmm</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Feb 07 2020 08:17:28 GMT-0800 (Pacific Standard Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">if we can stuff a good number of the identifier references into "canonical indexes" of one sort or another</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Feb 07 2020 08:17:52 GMT-0800 (Pacific Standard Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">but I don't think this would mess with the rust code's boxing in any way that the atoms work wouldn't have otherwise messed with.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Feb 07 2020 08:17:55 GMT-0800 (Pacific Standard Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">OK, how will we handle scope lookups during delazification?</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Feb 07 2020 08:18:55 GMT-0800 (Pacific Standard Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">what I mean is, suppose we're delazifying <code>function () { x++; }</code> where <code>x</code> is a local variable defined in an enclosing function.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Feb 07 2020 08:19:12 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">the code we want to emit uses <code>Aliased</code> instructions to access <code>x</code>.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Feb 07 2020 08:19:15 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">For the structures associated with a particular script body (module, function, eval, global), the StencilAtom references will be 32-bit "table indices"</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Feb 07 2020 08:20:15 GMT-0800 (Pacific Standard Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">sorry, please assume in this case that the identifier is <code>molybdenum</code> or something that we haven't specialized for</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Feb 07 2020 08:23:05 GMT-0800 (Pacific Standard Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">are we talking about delazifying from  a stencil into a function/script or about full-parsing some prior syntax parsed code?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Feb 07 2020 08:23:23 GMT-0800 (Pacific Standard Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">full-parsing prior syntax-parsed code.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Feb 07 2020 08:26:26 GMT-0800 (Pacific Standard Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">So the stencil we'd be building in that situation would use its own string table (transient) for that parse.  Serialized stencils would serialize the "indexes" into offset into the source where they first appeared (canonical location for the body)</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Feb 07 2020 08:26:43 GMT-0800 (Pacific Standard Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">ideally, we don't keep string tables around at all, except as transient mapping devices</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Feb 07 2020 08:27:34 GMT-0800 (Pacific Standard Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">I'm talking about how previously gathered information about the enclosing scope gets back into the frontend</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Feb 07 2020 08:28:00 GMT-0800 (Pacific Standard Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">is there a data structure that enables efficient scope lookups</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Feb 07 2020 08:28:12 GMT-0800 (Pacific Standard Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">if not, we can build a transient one</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Feb 07 2020 08:28:38 GMT-0800 (Pacific Standard Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">but we do have to build it <em>from</em> something</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Feb 07 2020 08:30:16 GMT-0800 (Pacific Standard Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">jorendorff</span>: prior compiled outer bodies, outer bodies in the same "compile session", or both?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Feb 07 2020 08:30:41 GMT-0800 (Pacific Standard Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">prior compiled outer bodies</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Feb 07 2020 08:30:51 GMT-0800 (Pacific Standard Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">(or, both)</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Feb 07 2020 08:31:11 GMT-0800 (Pacific Standard Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">their information will all be structured within in-heap variants which point to real jsatoms, right?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Feb 07 2020 08:31:13 GMT-0800 (Pacific Standard Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">but fundamentally my question is pretty classic: you're proposing isolated pools, and i'm saying there's a case where we need information that crosses those pools</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Feb 07 2020 08:31:54 GMT-0800 (Pacific Standard Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">oh right, I understand what you mean by "build it" now.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Feb 07 2020 08:32:35 GMT-0800 (Pacific Standard Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">we'd build them as needed from the internal references.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Feb 07 2020 08:33:10 GMT-0800 (Pacific Standard Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: ok, i'd like to understand how this will work -- to be clear I presently can't tell what's proposed at all</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Feb 07 2020 08:33:51 GMT-0800 (Pacific Standard Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: so, first, what are "internal references"</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Feb 07 2020 08:34:22 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i hope this is useful</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Feb 07 2020 08:34:43 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i don't mean to cavil, i just feel like i have not been able to pick up much of what you'd like me to understand</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Feb 07 2020 08:34:54 GMT-0800 (Pacific Standard Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">I need to get my ideas clear enough to explain after all :)</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Feb 07 2020 08:35:42 GMT-0800 (Pacific Standard Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">"cavil", good word.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Feb 07 2020 08:35:49 GMT-0800 (Pacific Standard Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">ok, so let me try again.  when we are full-parsing we are building a stencil structure which we'll materialize later.</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Feb 07 2020 08:35:58 GMT-0800 (Pacific Standard Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: yep</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Feb 07 2020 08:36:05 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">and the stencil structure contains some string tables</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Feb 07 2020 08:36:36 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">one per "body" (script, module, function, eval)</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Feb 07 2020 08:36:46 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">the strings in these tables do all get converted to JSAtoms before we run the script</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Feb 07 2020 08:36:48 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">while building the stencil structure (e.g. bytecode compiling, etc.) we'll need to materialize canonical string references that need to be compared to various things, for the most part.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Feb 07 2020 08:37:28 GMT-0800 (Pacific Standard Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">in the heap structures, these canonical references are just JSAtom*s</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Feb 07 2020 08:37:37 GMT-0800 (Pacific Standard Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">What heap structures?</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Feb 07 2020 08:37:50 GMT-0800 (Pacific Standard Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">gc-heap variants of the stencil structures (our regular scope objects and stuff)</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Feb 07 2020 08:37:57 GMT-0800 (Pacific Standard Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">ok</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Feb 07 2020 08:38:20 GMT-0800 (Pacific Standard Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">right, so as part of stencil-instantiation, we create real JSAtoms and js::Scope objects</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Feb 07 2020 08:40:20 GMT-0800 (Pacific Standard Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">For the corresponding StencilScope object (currently I think EmitterScope is the closest analogue), we need some canonical representation that's not JSAtom*, which will likely end up being some uint32_t index into <em>some</em> table with some lifetime/scope</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Fri Feb 07 2020 08:41:26 GMT-0800 (Pacific Standard Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">Hmm</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Fri Feb 07 2020 08:42:25 GMT-0800 (Pacific Standard Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">And as for lifetimes, that table owns the string characters, unless they're borrowed from the script source.</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Fri Feb 07 2020 08:43:44 GMT-0800 (Pacific Standard Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">The question is the lifetime of the table itself, it <em>can</em> be the lifetime of the source, but then you're keeping alive all the atoms in the source for the lifetime of the source (or adding some cache heuristic to clear it and recompute it or something)</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Fri Feb 07 2020 08:44:24 GMT-0800 (Pacific Standard Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">and that leads to asking whether you want to keep <em>parts</em> of the table alive depending on which parts are used, and it gets really messy</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Fri Feb 07 2020 08:44:39 GMT-0800 (Pacific Standard Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">thinking</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Fri Feb 07 2020 08:44:53 GMT-0800 (Pacific Standard Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">so I'd like a table that can live for the lifetime of a build or an instantiation</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Fri Feb 07 2020 08:45:12 GMT-0800 (Pacific Standard Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">but which disappears during encoding.</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Fri Feb 07 2020 08:45:55 GMT-0800 (Pacific Standard Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">if the table is consumed, that means no reusing any data gathered by one compilation in a later compilation (such as delazification)</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Fri Feb 07 2020 08:46:01 GMT-0800 (Pacific Standard Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">because almost all of it contains strings</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Fri Feb 07 2020 08:46:26 GMT-0800 (Pacific Standard Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i don't think we need to reuse much data, but for scopes it is nice</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Fri Feb 07 2020 08:46:33 GMT-0800 (Pacific Standard Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">scopes are the only thing</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Fri Feb 07 2020 08:46:36 GMT-0800 (Pacific Standard Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">well, no reusing that specific data - which is the association between atoms <em>after</em> they've been de-duplicated on a per-body basis</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Fri Feb 07 2020 08:46:59 GMT-0800 (Pacific Standard Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">most of the time when you're instantiating/compiling stencil data, the enclosing structures will be live</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Fri Feb 07 2020 08:47:29 GMT-0800 (Pacific Standard Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i don't understand the last 2 lines</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Fri Feb 07 2020 08:48:27 GMT-0800 (Pacific Standard Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">"the enclosing structures will be live" are you referring to the js::Scopes? I thought the frontend would not be allowed to see those directly</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Fri Feb 07 2020 08:49:04 GMT-0800 (Pacific Standard Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">directly or not they will need to be queried at some point, and they should be the ones you're most frequently interacting with anyway</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Fri Feb 07 2020 08:49:48 GMT-0800 (Pacific Standard Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">ok, so i think now you're suggesting that we just pass the pointers to these live js::Scopes into the frontend?</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Fri Feb 07 2020 08:49:53 GMT-0800 (Pacific Standard Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i'm not sure though</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Fri Feb 07 2020 08:49:59 GMT-0800 (Pacific Standard Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">I'm saying that it seems unlikely to me that when you're compiling a stencil, you'll be relying on an enclosing stencil that was produced during a prior compile.</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Fri Feb 07 2020 08:50:12 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">frontend needs scopes</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Fri Feb 07 2020 08:50:19 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">that's the only part it needs</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Fri Feb 07 2020 08:50:22 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">it has to get that data somehow</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Fri Feb 07 2020 08:50:37 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">reusing the output of an earlier compile would be one way to get it</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Fri Feb 07 2020 08:50:50 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">right, so I've been assuming it has at some point direct access to those outer scopes</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Fri Feb 07 2020 08:51:00 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i see</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Fri Feb 07 2020 08:51:10 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">and that the gc-free aspect of the stencil work was making it so that it never created GC objects</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Fri Feb 07 2020 08:51:14 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">except at well-defined points</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Fri Feb 07 2020 08:51:22 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">but it would still <em>consult</em> GC objects</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Fri Feb 07 2020 08:51:33 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">right</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Fri Feb 07 2020 08:51:43 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">if that's a bad assumption, it would be good to find out soon :)</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Fri Feb 07 2020 08:52:32 GMT-0800 (Pacific Standard Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">maybe we should just keep using JSAtom</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Fri Feb 07 2020 08:53:06 GMT-0800 (Pacific Standard Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">the main problem is keeping them rooted across threads</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Fri Feb 07 2020 08:53:25 GMT-0800 (Pacific Standard Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">no, no.  I think we can really build a neat, much improved thing here.  Like, just straight up eliminate gobs of hashtable lookups and table entry creations and stuff.</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Fri Feb 07 2020 08:53:45 GMT-0800 (Pacific Standard Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">don't we still need the hash table if it's per-compile?</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Fri Feb 07 2020 08:53:58 GMT-0800 (Pacific Standard Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">we eliminate the locking, but we still have the table</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Fri Feb 07 2020 08:54:20 GMT-0800 (Pacific Standard Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">an internal string table, per parse, which would be lazily populated as needed.</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Fri Feb 07 2020 08:54:57 GMT-0800 (Pacific Standard Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">that's where the whole "eliminate 50% of lookups on the table by just treating the 1-byte string as a virtual index into the table" bit came in</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Fri Feb 07 2020 08:55:15 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">oh, those lookups are already eliminated I think</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Fri Feb 07 2020 08:55:20 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">because of StaticStrings</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Fri Feb 07 2020 08:55:22 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">oh?</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Fri Feb 07 2020 08:55:59 GMT-0800 (Pacific Standard Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/StringType.h#1299">https://searchfox.org/mozilla-central/source/js/src/vm/StringType.h#1299</a></td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Fri Feb 07 2020 08:56:03 GMT-0800 (Pacific Standard Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i'm not 100% on this</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Fri Feb 07 2020 08:57:46 GMT-0800 (Pacific Standard Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">Is it an effort/value concern, or a fundamental workability concern?</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Fri Feb 07 2020 08:57:46 GMT-0800 (Pacific Standard Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: anyway -- suppose the frontend has access to the enclosing <code>js::Scope</code></td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Fri Feb 07 2020 08:58:21 GMT-0800 (Pacific Standard Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">actually, before that</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Fri Feb 07 2020 08:58:30 GMT-0800 (Pacific Standard Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">suppose the frontend does <em>not</em> have access ot the enclosing js::Scope</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Fri Feb 07 2020 08:58:52 GMT-0800 (Pacific Standard Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">I just want to understand roughly what you had in mind to do in that scenario</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Fri Feb 07 2020 08:58:57 GMT-0800 (Pacific Standard Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: two separate concerns, one of each: 1. cost/benefit of largely reimplementing JSAtom and then having two things</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Fri Feb 07 2020 08:59:18 GMT-0800 (Pacific Standard Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><ol start="2">
<li>fundamental workability of the new thing, for delazification (totally independent of 1)</li>
</ol>
</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Fri Feb 07 2020 08:59:20 GMT-0800 (Pacific Standard Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">yeah ok</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Fri Feb 07 2020 09:00:39 GMT-0800 (Pacific Standard Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: so, one of my assumptions has been that the output of stencil is not 100% flat; it's a tree of structs, some of which (like the bytecode blob) are gonna get adopted or shared by GC things when the stencil is instantiated</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Fri Feb 07 2020 09:01:32 GMT-0800 (Pacific Standard Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i was thinking the scope would be one of those things, the GC graph keeps it alive via the gc-Scope</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Fri Feb 07 2020 09:02:25 GMT-0800 (Pacific Standard Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">and then it's very easy to pass one of those back into the frontend later, it's probably refcounted anyway since we want to share this immutable thing, write it to cache and such</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Fri Feb 07 2020 09:02:32 GMT-0800 (Pacific Standard Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">so passing it back to the frontend is just an incref</td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Fri Feb 07 2020 09:02:59 GMT-0800 (Pacific Standard Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">the frontend can do lookups ---- i'm not married to this, understand, just kind of figured it could work that way, and be efficient</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Fri Feb 07 2020 09:03:41 GMT-0800 (Pacific Standard Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">so you'd have a scope chain skeleton corresponding to this thing live at any time?</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Fri Feb 07 2020 09:04:06 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I mean, we're pretty close to this today, except right now instead of shared ownership of the data, there's exclusive ownership </td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Fri Feb 07 2020 09:04:22 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">notably, it would be a bit of a splitting of functionality from the current gc-heap scope objects, into a shared chain skeleton that can be used by both stencils and the mutator?</td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Fri Feb 07 2020 09:04:43 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">but you could extend what are currently called ScopeCreationData to serve this role, (and add Shared ownership to the backing data) </td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Fri Feb 07 2020 09:05:09 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: yes, or, I don't know</td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Fri Feb 07 2020 09:05:30 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">@mgaudet: ScopeCreationData would basically become <code>StencilScope</code> in all but name, then?</td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Fri Feb 07 2020 09:06:02 GMT-0800 (Pacific Standard Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So bear in mind: the name <code>FooCreationData</code> predates stencils; in my mind, I already transliterate that directly</td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Fri Feb 07 2020 09:07:22 GMT-0800 (Pacific Standard Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">The difference I see here is one of lifetime and ownership. Today <code>ScopeCreationData aka StencilScope</code> are local to a top level stencil; what I'm sort of getting from Jason is that it might be nice to have them have a longer life time to support a parser that needn't ever reference GC objects;</td></tr>
  <tr class="msg" id="L150"><td class="ts-cell"><a class="ts" href="#L150" alt="Fri Feb 07 2020 09:08:06 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">uhhr, well</td></tr>
  <tr class="msg" id="L151"><td class="ts-cell"><a class="ts" href="#L151" alt="Fri Feb 07 2020 09:08:07 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So instead of providing the top level parse with an enclosing <code>Scope</code>, you'd provide it with an enclosing <code>StencilScope</code>; which could be referring to data that is also refered to by the GC <code>Scope</code>, just shared via refcounts</td></tr>
  <tr class="msg" id="L152"><td class="ts-cell"><a class="ts" href="#L152" alt="Fri Feb 07 2020 09:08:46 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">as long as I know what the new frontend is allowed to do, i'm ok with talking to GC <code>Scope</code>s</td></tr>
  <tr class="msg" id="L153"><td class="ts-cell"><a class="ts" href="#L153" alt="Fri Feb 07 2020 09:09:07 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">but, like, imagine I have this identifier <code>molybdenum</code> and I need to look it up in a <code>Scope</code></td></tr>
  <tr class="msg" id="L154"><td class="ts-cell"><a class="ts" href="#L154" alt="Fri Feb 07 2020 09:09:17 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">currently we atomize the string at that point, in order to do the lookup</td></tr>
  <tr class="msg" id="L155"><td class="ts-cell"><a class="ts" href="#L155" alt="Fri Feb 07 2020 09:09:24 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">is that ok?</td></tr>
  <tr class="msg" id="L156"><td class="ts-cell"><a class="ts" href="#L156" alt="Fri Feb 07 2020 09:09:36 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@bzbarsky:mozilla.org">bzbarsky</span>&gt;</div></td><td class="msg-cell">So I have a question about parsing</td></tr>
  <tr class="msg" id="L157"><td class="ts-cell"><a class="ts" href="#L157" alt="Fri Feb 07 2020 09:09:54 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: but, yes, you understand me correctly</td></tr>
  <tr class="msg" id="L158"><td class="ts-cell"><a class="ts" href="#L158" alt="Fri Feb 07 2020 09:09:57 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@bzbarsky:mozilla.org">bzbarsky</span>&gt;</div></td><td class="msg-cell">at some point here we are going to need a thing that we can run in the parent (or necko?) process which will be able to answer the following questions</td></tr>
  <tr class="msg" id="L159"><td class="ts-cell"><a class="ts" href="#L159" alt="Fri Feb 07 2020 09:10:05 GMT-0800 (Pacific Standard Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@bzbarsky:mozilla.org">bzbarsky</span>&gt;</div></td><td class="msg-cell"><ol>
<li>Does this data parse as JS?</li>
</ol>
</td></tr>
  <tr class="msg" id="L160"><td class="ts-cell"><a class="ts" href="#L160" alt="Fri Feb 07 2020 09:10:14 GMT-0800 (Pacific Standard Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@bzbarsky:mozilla.org">bzbarsky</span>&gt;</div></td><td class="msg-cell"><ol start="2">
<li>If it does, does it <em>fail</em> to parse as JSON?</li>
</ol>
</td></tr>
  <tr class="msg" id="L161"><td class="ts-cell"><a class="ts" href="#L161" alt="Fri Feb 07 2020 09:10:35 GMT-0800 (Pacific Standard Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@bzbarsky:mozilla.org">bzbarsky</span>&gt;</div></td><td class="msg-cell">Is this something the new frontend might be able to do?</td></tr>
  <tr class="msg" id="L162"><td class="ts-cell"><a class="ts" href="#L162" alt="Fri Feb 07 2020 09:10:49 GMT-0800 (Pacific Standard Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">bzbarsky</span>: i spoke with Anne about this a bit in Berlin. This is something the new frontend can do, yes.</td></tr>
  <tr class="msg" id="L163"><td class="ts-cell"><a class="ts" href="#L163" alt="Fri Feb 07 2020 09:10:52 GMT-0800 (Pacific Standard Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">jorendorff</span>: This does tie back a bit to a question we had about what is the actual representation of scopes. I'm sort of the opinion these days (and djvj can correct me if I'm wrong) we may want to change the table representation of scopes.</td></tr>
  <tr class="msg" id="L164"><td class="ts-cell"><a class="ts" href="#L164" alt="Fri Feb 07 2020 09:11:26 GMT-0800 (Pacific Standard Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Just because atomization is such a can of worms</td></tr>
  <tr class="msg" id="L165"><td class="ts-cell"><a class="ts" href="#L165" alt="Fri Feb 07 2020 09:11:32 GMT-0800 (Pacific Standard Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: It seems almost necessary if we want to avoid atomization</td></tr>
  <tr class="msg" id="L166"><td class="ts-cell"><a class="ts" href="#L166" alt="Fri Feb 07 2020 09:11:40 GMT-0800 (Pacific Standard Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">like, really really close to necessary</td></tr>
  <tr class="msg" id="L167"><td class="ts-cell"><a class="ts" href="#L167" alt="Fri Feb 07 2020 09:12:53 GMT-0800 (Pacific Standard Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">let me take a look at how the existing scope objects are structured.</td></tr>
  <tr class="msg" id="L168"><td class="ts-cell"><a class="ts" href="#L168" alt="Fri Feb 07 2020 09:14:15 GMT-0800 (Pacific Standard Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: there's lots of incidental complexity, but basically they consist of a pointer to a big table of atoms, that has a special organization based on a series of offsets (like <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Scope.h#535-537">this</a>)</td></tr>
  <tr class="msg" id="L169"><td class="ts-cell"><a class="ts" href="#L169" alt="Fri Feb 07 2020 09:14:22 GMT-0800 (Pacific Standard Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@bzbarsky:mozilla.org">bzbarsky</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">jorendorff</span>: Ah, great, Anne is who needs this bit.</td></tr>
  <tr class="msg" id="L170"><td class="ts-cell"><a class="ts" href="#L170" alt="Fri Feb 07 2020 09:14:38 GMT-0800 (Pacific Standard Time)">17:14</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-13" title="@bzbarsky:mozilla.org">bzbarsky</span></div></td><td class="msg-cell">butts out again.  :)</td></tr>
  <tr class="msg" id="L171"><td class="ts-cell"><a class="ts" href="#L171" alt="Fri Feb 07 2020 09:14:48 GMT-0800 (Pacific Standard Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">as well as things like the pointer to the enclosing scope, a potential environment shape, </td></tr>
  <tr class="msg" id="L172"><td class="ts-cell"><a class="ts" href="#L172" alt="Fri Feb 07 2020 09:14:57 GMT-0800 (Pacific Standard Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">and a flag to indicate 'kind' </td></tr>
  <tr class="msg" id="L173"><td class="ts-cell"><a class="ts" href="#L173" alt="Fri Feb 07 2020 09:17:44 GMT-0800 (Pacific Standard Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">so, one approach would be, when we need to compile a function,</td></tr>
  <tr class="msg" id="L174"><td class="ts-cell"><a class="ts" href="#L174" alt="Fri Feb 07 2020 09:17:56 GMT-0800 (Pacific Standard Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">just write down what we've got in the scope and ship that to the new frontend</td></tr>
  <tr class="msg" id="L175"><td class="ts-cell"><a class="ts" href="#L175" alt="Fri Feb 07 2020 09:18:12 GMT-0800 (Pacific Standard Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">like: whatever, math class is tough, we're making a copy</td></tr>
  <tr class="msg" id="L176"><td class="ts-cell"><a class="ts" href="#L176" alt="Fri Feb 07 2020 09:18:18 GMT-0800 (Pacific Standard Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">That will work for us for now</td></tr>
  <tr class="msg" id="L177"><td class="ts-cell"><a class="ts" href="#L177" alt="Fri Feb 07 2020 09:18:41 GMT-0800 (Pacific Standard Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">We'd have to represent the whole chain to the root right? </td></tr>
  <tr class="msg" id="L178"><td class="ts-cell"><a class="ts" href="#L178" alt="Fri Feb 07 2020 09:18:45 GMT-0800 (Pacific Standard Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L179"><td class="ts-cell"><a class="ts" href="#L179" alt="Fri Feb 07 2020 09:18:59 GMT-0800 (Pacific Standard Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">I think usually it'll literally be "the global environment"</td></tr>
  <tr class="msg" id="L180"><td class="ts-cell"><a class="ts" href="#L180" alt="Fri Feb 07 2020 09:19:09 GMT-0800 (Pacific Standard Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">for toplevel functions that's what it is</td></tr>
  <tr class="msg" id="L181"><td class="ts-cell"><a class="ts" href="#L181" alt="Fri Feb 07 2020 09:19:27 GMT-0800 (Pacific Standard Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">for leaf functions inside an iife, it's more; and that is not rare</td></tr>
  <tr class="msg" id="L182"><td class="ts-cell"><a class="ts" href="#L182" alt="Fri Feb 07 2020 09:20:04 GMT-0800 (Pacific Standard Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i have to take back that "usually"; i bet it will often be a lot of bindings</td></tr>
  <tr class="msg" id="L183"><td class="ts-cell"><a class="ts" href="#L183" alt="Fri Feb 07 2020 09:21:26 GMT-0800 (Pacific Standard Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I think the common case is going to be a non-zero chain of scopes; but you could reify a <code>ScopeStencil</code> chain at relatively low cost to pass in if you have shared ownership of the bindings tables</td></tr>
  <tr class="msg" id="L184"><td class="ts-cell"><a class="ts" href="#L184" alt="Fri Feb 07 2020 09:22:00 GMT-0800 (Pacific Standard Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">then longer lived <code>ScopeStencil</code>s could still happen, but as an optimization</td></tr>
  <tr class="msg" id="L185"><td class="ts-cell"><a class="ts" href="#L185" alt="Fri Feb 07 2020 09:23:01 GMT-0800 (Pacific Standard Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">ok, that doesn't sound bad</td></tr>
  <tr class="msg" id="L186"><td class="ts-cell"><a class="ts" href="#L186" alt="Fri Feb 07 2020 09:23:09 GMT-0800 (Pacific Standard Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">plus it's incremental</td></tr>
  <tr class="msg" id="L187"><td class="ts-cell"><a class="ts" href="#L187" alt="Fri Feb 07 2020 09:23:56 GMT-0800 (Pacific Standard Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">note what the frontend needs from this data structure, though:</td></tr>
  <tr class="msg" id="L188"><td class="ts-cell"><a class="ts" href="#L188" alt="Fri Feb 07 2020 09:24:04 GMT-0800 (Pacific Standard Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">we have to be able to query it</td></tr>
  <tr class="msg" id="L189"><td class="ts-cell"><a class="ts" href="#L189" alt="Fri Feb 07 2020 09:24:22 GMT-0800 (Pacific Standard Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">which maybe sounds stupid, but what I'm saying is, whatever those string keys are in that table</td></tr>
  <tr class="msg" id="L190"><td class="ts-cell"><a class="ts" href="#L190" alt="Fri Feb 07 2020 09:24:38 GMT-0800 (Pacific Standard Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">or .... chain of tables</td></tr>
  <tr class="msg" id="L191"><td class="ts-cell"><a class="ts" href="#L191" alt="Fri Feb 07 2020 09:24:58 GMT-0800 (Pacific Standard Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah, it's not stupid; in fact the query stuff is the most complicated set of this whole thing</td></tr>
  <tr class="msg" id="L192"><td class="ts-cell"><a class="ts" href="#L192" alt="Fri Feb 07 2020 09:25:08 GMT-0800 (Pacific Standard Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">BindingIter (both of them!) are magic.</td></tr>
  <tr class="msg" id="L193"><td class="ts-cell"><a class="ts" href="#L193" alt="Fri Feb 07 2020 09:25:13 GMT-0800 (Pacific Standard Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">whatever it is, we have to be able to actually really take a string of characters from source text and get at the data -- yes, perfect</td></tr>
  <tr class="msg" id="L194"><td class="ts-cell"><a class="ts" href="#L194" alt="Fri Feb 07 2020 09:25:24 GMT-0800 (Pacific Standard Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(which is to say, not magic, but... yeah. There's a lot going on there) </td></tr>
  <tr class="msg" id="L195"><td class="ts-cell"><a class="ts" href="#L195" alt="Fri Feb 07 2020 09:26:26 GMT-0800 (Pacific Standard Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I guess the concerning aspect of this is that there's a potential we end up with a <em>third</em> implementation of BindingIter... which I don't think we want</td></tr>
  <tr class="msg" id="L196"><td class="ts-cell"><a class="ts" href="#L196" alt="Fri Feb 07 2020 09:36:02 GMT-0800 (Pacific Standard Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">wcgr</td></tr>
  <tr class="msg" id="L197"><td class="ts-cell"><a class="ts" href="#L197" alt="Fri Feb 07 2020 09:42:25 GMT-0800 (Pacific Standard Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: the <code>StaticStrings</code> mechanism pre-computes all 2-char atoms at runtime initialization and they are pinned.</td></tr>
  <tr class="msg" id="L198"><td class="ts-cell"><a class="ts" href="#L198" alt="Fri Feb 07 2020 09:42:57 GMT-0800 (Pacific Standard Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">"all" in the sense of all the likely identifiers</td></tr>
  <tr class="msg" id="L199"><td class="ts-cell"><a class="ts" href="#L199" alt="Fri Feb 07 2020 09:46:39 GMT-0800 (Pacific Standard Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">Right, so we need to decide something here.</td></tr>
  <tr class="msg" id="L200"><td class="ts-cell"><a class="ts" href="#L200" alt="Fri Feb 07 2020 09:47:03 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">Design-wise, do we want stencils to be something largely associated with the lifetime bounds of a single JSScript</td></tr>
  <tr class="msg" id="L201"><td class="ts-cell"><a class="ts" href="#L201" alt="Fri Feb 07 2020 09:47:32 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">I'm happy because I feel like you and mgaudet understand exactly what I was going on about üëçÔ∏è</td></tr>
  <tr class="msg" id="L202"><td class="ts-cell"><a class="ts" href="#L202" alt="Fri Feb 07 2020 09:47:38 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">or have larger structural pieces (especially spanning multiple sentcil compilations) stay life and linked to each other?</td></tr>
  <tr class="msg" id="L203"><td class="ts-cell"><a class="ts" href="#L203" alt="Fri Feb 07 2020 09:47:42 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">and given that i'm sure we'll end up somewhere good</td></tr>
  <tr class="msg" id="L204"><td class="ts-cell"><a class="ts" href="#L204" alt="Fri Feb 07 2020 09:48:21 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">i think stencils definitely can't be <em>entirely</em> tied to a JSScript lifetime because we also want to be able to hand them off to some other system like the bytecode cache</td></tr>
  <tr class="msg" id="L205"><td class="ts-cell"><a class="ts" href="#L205" alt="Fri Feb 07 2020 09:48:37 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">seems like, atomic refcount?</td></tr>
  <tr class="msg" id="L206"><td class="ts-cell"><a class="ts" href="#L206" alt="Fri Feb 07 2020 09:49:48 GMT-0800 (Pacific Standard Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">but the question about whether there are shared pieces linked to each other</td></tr>
  <tr class="msg" id="L207"><td class="ts-cell"><a class="ts" href="#L207" alt="Fri Feb 07 2020 09:49:54 GMT-0800 (Pacific Standard Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">yeah, good question :-| don't know</td></tr>
  <tr class="msg" id="L208"><td class="ts-cell"><a class="ts" href="#L208" alt="Fri Feb 07 2020 09:50:27 GMT-0800 (Pacific Standard Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So, not saying this is the right answer, but I'll tell you how I've seen it so far: this is at least as much because this is how things -are- as much as it is where I think we're going: </td></tr>
  <tr class="msg" id="L209"><td class="ts-cell"><a class="ts" href="#L209" alt="Fri Feb 07 2020 09:51:19 GMT-0800 (Pacific Standard Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">A top level stencil (need a better name!) is created for parsing a top level script; it contains a tree of stencils covering all the inner functions. These may be lazy or non-lazy </td></tr>
  <tr class="msg" id="L210"><td class="ts-cell"><a class="ts" href="#L210" alt="Fri Feb 07 2020 09:51:37 GMT-0800 (Pacific Standard Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">In my view, this is what gets cached; </td></tr>
  <tr class="msg" id="L211"><td class="ts-cell"><a class="ts" href="#L211" alt="Fri Feb 07 2020 09:52:00 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">this tree is generated in whole at full-parse time?</td></tr>
  <tr class="msg" id="L212"><td class="ts-cell"><a class="ts" href="#L212" alt="Fri Feb 07 2020 09:52:02 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">when we do delazification, we create a new "top most stencil" that corresponds to a single function; we don't cache this. </td></tr>
  <tr class="msg" id="L213"><td class="ts-cell"><a class="ts" href="#L213" alt="Fri Feb 07 2020 09:52:09 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">or at syntax parse time?</td></tr>
  <tr class="msg" id="L214"><td class="ts-cell"><a class="ts" href="#L214" alt="Fri Feb 07 2020 09:52:35 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">oh wait, the "these may be lazy or non-lazy" likely answers that question</td></tr>
  <tr class="msg" id="L215"><td class="ts-cell"><a class="ts" href="#L215" alt="Fri Feb 07 2020 09:52:59 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: Whatever is seen is in the tree; so when we flip a child to syntax parse and complete, there's information that is not represented in the tree --- all the children of lazy nodes are invisible</td></tr>
  <tr class="msg" id="L216"><td class="ts-cell"><a class="ts" href="#L216" alt="Fri Feb 07 2020 09:53:33 GMT-0800 (Pacific Standard Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">and linkage is via parent pointers?</td></tr>
  <tr class="msg" id="L217"><td class="ts-cell"><a class="ts" href="#L217" alt="Fri Feb 07 2020 09:54:09 GMT-0800 (Pacific Standard Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">now this isn't perfect: There's definitely cool optimizations that could happen if we could -update- the tree later, just before leaving a page to indicate what got delazified, so that we could perhaps reify delazified functions on next page load.</td></tr>
  <tr class="msg" id="L218"><td class="ts-cell"><a class="ts" href="#L218" alt="Fri Feb 07 2020 09:54:44 GMT-0800 (Pacific Standard Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: So today, everything is table based. You can only start from the top and walk down. But this representation isn't nailed down today so is flexible</td></tr>
  <tr class="msg" id="L219"><td class="ts-cell"><a class="ts" href="#L219" alt="Fri Feb 07 2020 09:55:15 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(frankly, it's not properly represented just yet because I haven't gotten to it; right now we just point to functionboxes </td></tr>
  <tr class="msg" id="L220"><td class="ts-cell"><a class="ts" href="#L220" alt="Fri Feb 07 2020 09:55:24 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">but that will have to be altered in the not too distant future) </td></tr>
  <tr class="msg" id="L221"><td class="ts-cell"><a class="ts" href="#L221" alt="Fri Feb 07 2020 09:55:56 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">IIUC.. a syntax parse just picks up the linear ordering of all the function defs across the source and makes a lazily-initialized table for it</td></tr>
  <tr class="msg" id="L222"><td class="ts-cell"><a class="ts" href="#L222" alt="Fri Feb 07 2020 09:56:55 GMT-0800 (Pacific Standard Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yes, but also it keeps track of the appropriate enclosing scope</td></tr>
  <tr class="msg" id="L223"><td class="ts-cell"><a class="ts" href="#L223" alt="Fri Feb 07 2020 09:57:13 GMT-0800 (Pacific Standard Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">the offset + enclosing scope is all our current parser really needs to do delazification</td></tr>
  <tr class="msg" id="L224"><td class="ts-cell"><a class="ts" href="#L224" alt="Fri Feb 07 2020 09:57:49 GMT-0800 (Pacific Standard Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L225"><td class="ts-cell"><a class="ts" href="#L225" alt="Fri Feb 07 2020 09:58:52 GMT-0800 (Pacific Standard Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">syntax parsing will still be a tree of functions to instantiate</td></tr>
  <tr class="msg" id="L226"><td class="ts-cell"><a class="ts" href="#L226" alt="Fri Feb 07 2020 09:59:31 GMT-0800 (Pacific Standard Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">during delazification, the scopes do know what subset of bindings are closed-over</td></tr>
  <tr class="msg" id="L227"><td class="ts-cell"><a class="ts" href="#L227" alt="Fri Feb 07 2020 10:00:07 GMT-0800 (Pacific Standard Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(from the low-bit of the atom pointer in the scope binding list.. üò∂ )</td></tr>
  <tr class="msg" id="L228"><td class="ts-cell"><a class="ts" href="#L228" alt="Fri Feb 07 2020 10:01:55 GMT-0800 (Pacific Standard Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">sign, so syntax parsing has to look up names regardless</td></tr>
  <tr class="msg" id="L229"><td class="ts-cell"><a class="ts" href="#L229" alt="Fri Feb 07 2020 10:02:17 GMT-0800 (Pacific Standard Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">correct</td></tr>
  <tr class="msg" id="L230"><td class="ts-cell"><a class="ts" href="#L230" alt="Fri Feb 07 2020 10:03:11 GMT-0800 (Pacific Standard Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">so this question remains of the boundaries of the stencils system</td></tr>
  <tr class="msg" id="L231"><td class="ts-cell"><a class="ts" href="#L231" alt="Fri Feb 07 2020 10:03:15 GMT-0800 (Pacific Standard Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: ^--</td></tr>
  <tr class="msg" id="L232"><td class="ts-cell"><a class="ts" href="#L232" alt="Fri Feb 07 2020 10:03:20 GMT-0800 (Pacific Standard Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(there is a reason I said I don't know what the answer is and was happy for you to take on the problem üôÇ)</td></tr>
  <tr class="msg" id="L233"><td class="ts-cell"><a class="ts" href="#L233" alt="Fri Feb 07 2020 10:04:02 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">fine, I'll fight iain about it</td></tr>
  <tr class="msg" id="L234"><td class="ts-cell"><a class="ts" href="#L234" alt="Fri Feb 07 2020 10:04:08 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: Honestly I think it's most productive to think about a stencil being local to a single compile</td></tr>
  <tr class="msg" id="L235"><td class="ts-cell"><a class="ts" href="#L235" alt="Fri Feb 07 2020 10:04:17 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I'm in office too and am happy to whiteboard this</td></tr>
  <tr class="msg" id="L236"><td class="ts-cell"><a class="ts" href="#L236" alt="Fri Feb 07 2020 10:04:21 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">ok</td></tr>
  <tr class="msg" id="L237"><td class="ts-cell"><a class="ts" href="#L237" alt="Fri Feb 07 2020 10:04:21 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: Then we can work on how that works with caching and generalization later</td></tr>
  <tr class="msg" id="L238"><td class="ts-cell"><a class="ts" href="#L238" alt="Fri Feb 07 2020 10:04:25 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I have more cycles again</td></tr>
  <tr class="msg" id="L239"><td class="ts-cell"><a class="ts" href="#L239" alt="Fri Feb 07 2020 10:04:37 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">djvj</span>: the short term goal is that we get GC free parse off thread</td></tr>
  <tr class="msg" id="L240"><td class="ts-cell"><a class="ts" href="#L240" alt="Fri Feb 07 2020 10:04:50 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">all the other add ons can come later</td></tr>
  <tr class="msg" id="L241"><td class="ts-cell"><a class="ts" href="#L241" alt="Fri Feb 07 2020 10:04:57 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(I just meant that there isn't an obvious answer so don't be surprised if you find nothing clever)</td></tr>
  <tr class="msg" id="L242"><td class="ts-cell"><a class="ts" href="#L242" alt="Fri Feb 07 2020 10:05:27 GMT-0800 (Pacific Standard Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">I'm hoping we don't have to resort to anything clever.</td></tr>
  <tr class="msg" id="L243"><td class="ts-cell"><a class="ts" href="#L243" alt="Fri Feb 07 2020 10:06:05 GMT-0800 (Pacific Standard Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">I'm very happy with the broad boundaries of stencils being a single compile - roughly a single body.</td></tr>
  <tr class="msg" id="L244"><td class="ts-cell"><a class="ts" href="#L244" alt="Fri Feb 07 2020 10:06:15 GMT-0800 (Pacific Standard Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">refactoring scopes is not something that really tugs at my heartstrings</td></tr>
  <tr class="msg" id="L245"><td class="ts-cell"><a class="ts" href="#L245" alt="Fri Feb 07 2020 10:06:34 GMT-0800 (Pacific Standard Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">scopes are definitely the sticky issue with all this</td></tr>
  <tr class="msg" id="L246"><td class="ts-cell"><a class="ts" href="#L246" alt="Fri Feb 07 2020 10:06:35 GMT-0800 (Pacific Standard Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">+üíØ</td></tr>
  <tr class="msg" id="L247"><td class="ts-cell"><a class="ts" href="#L247" alt="Fri Feb 07 2020 10:08:31 GMT-0800 (Pacific Standard Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">but that does mean that "atom references" from the point of view of a stencil will need some representation that's canonical per-stencil</td></tr>
  <tr class="msg" id="L248"><td class="ts-cell"><a class="ts" href="#L248" alt="Fri Feb 07 2020 10:09:35 GMT-0800 (Pacific Standard Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">bytecode in stencil needs to bake in an index. The actual script-&gt;atoms() table can be built later though</td></tr>
  <tr class="msg" id="L249"><td class="ts-cell"><a class="ts" href="#L249" alt="Fri Feb 07 2020 10:09:46 GMT-0800 (Pacific Standard Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">it keeps things nice and clean - everything is self-contained.  But it means we need a good way of cross-checking those internal representations against real atoms when instantiating</td></tr>
  <tr class="msg" id="L250"><td class="ts-cell"><a class="ts" href="#L250" alt="Fri Feb 07 2020 10:10:01 GMT-0800 (Pacific Standard Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">yeah, I'm talking about the script-&gt;atoms table</td></tr>
  <tr class="msg" id="L251"><td class="ts-cell"><a class="ts" href="#L251" alt="Fri Feb 07 2020 10:10:40 GMT-0800 (Pacific Standard Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">well, the stencil thing that corresponds to it anyway</td></tr>
  <tr class="msg" id="L252"><td class="ts-cell"><a class="ts" href="#L252" alt="Fri Feb 07 2020 10:11:08 GMT-0800 (Pacific Standard Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">I think script-&gt;atoms currently holds only atoms used by bytecode</td></tr>
  <tr class="msg" id="L253"><td class="ts-cell"><a class="ts" href="#L253" alt="Fri Feb 07 2020 10:11:20 GMT-0800 (Pacific Standard Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">so for example the name of a variable won't be in there</td></tr>
  <tr class="msg" id="L254"><td class="ts-cell"><a class="ts" href="#L254" alt="Fri Feb 07 2020 10:11:49 GMT-0800 (Pacific Standard Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">true. it is largely property names and "literals"</td></tr>
  <tr class="msg" id="L255"><td class="ts-cell"><a class="ts" href="#L255" alt="Fri Feb 07 2020 10:11:51 GMT-0800 (Pacific Standard Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">that means stencil will want a string table, and then script-&gt;atoms is a simple array of indices into that string table</td></tr>
  <tr class="msg" id="L256"><td class="ts-cell"><a class="ts" href="#L256" alt="Fri Feb 07 2020 10:12:01 GMT-0800 (Pacific Standard Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">among others, like scopes</td></tr>
  <tr class="msg" id="L257"><td class="ts-cell"><a class="ts" href="#L257" alt="Fri Feb 07 2020 10:12:08 GMT-0800 (Pacific Standard Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">script-&gt;atoms is just one customer</td></tr>
  <tr class="msg" id="L258"><td class="ts-cell"><a class="ts" href="#L258" alt="Fri Feb 07 2020 10:12:28 GMT-0800 (Pacific Standard Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">right, this is what I had in mind.</td></tr>
  <tr class="msg" id="L259"><td class="ts-cell"><a class="ts" href="#L259" alt="Fri Feb 07 2020 10:12:40 GMT-0800 (Pacific Standard Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I'm not sure we need coordination of script-&gt;atoms and scopes during frontend though</td></tr>
  <tr class="msg" id="L260"><td class="ts-cell"><a class="ts" href="#L260" alt="Fri Feb 07 2020 10:12:51 GMT-0800 (Pacific Standard Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">to be clear: StencileScript-&gt;atoms to be precise, right?</td></tr>
  <tr class="msg" id="L261"><td class="ts-cell"><a class="ts" href="#L261" alt="Fri Feb 07 2020 10:13:01 GMT-0800 (Pacific Standard Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L262"><td class="ts-cell"><a class="ts" href="#L262" alt="Fri Feb 07 2020 10:14:10 GMT-0800 (Pacific Standard Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">EmitterScope, StencilScript-&gt;atoms, etc. (all stencilly things that currently refer to JSAtoms*) will need to be some index into table that's local to a compile (function body, global script body, etc.)</td></tr>
  <tr class="msg" id="L263"><td class="ts-cell"><a class="ts" href="#L263" alt="Fri Feb 07 2020 10:16:37 GMT-0800 (Pacific Standard Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">during instantiation, if we're assuming we can talk/walk gc-heap things directly, we build a temporary translation table from these indices to JSAtom*s</td></tr>
  <tr class="msg" id="L264"><td class="ts-cell"><a class="ts" href="#L264" alt="Fri Feb 07 2020 10:16:59 GMT-0800 (Pacific Standard Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Stencil::Instantiate has full sync access to gc-heap</td></tr>
  <tr class="msg" id="L265"><td class="ts-cell"><a class="ts" href="#L265" alt="Fri Feb 07 2020 10:17:58 GMT-0800 (Pacific Standard Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">during compile, we either need to snapshot and shuttle the scope data, always keep the scope data alive, or access the gc-heap directly to query the scope data.</td></tr>
  <tr class="msg" id="L266"><td class="ts-cell"><a class="ts" href="#L266" alt="Fri Feb 07 2020 10:18:23 GMT-0800 (Pacific Standard Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">if the scope info itself is relatively immutable (looks to be so), sharing that to a background thread for multi-read access doesn't seem like a big issue.</td></tr>
  <tr class="msg" id="L267"><td class="ts-cell"><a class="ts" href="#L267" alt="Fri Feb 07 2020 10:18:25 GMT-0800 (Pacific Standard Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">My feeling would be start with snapshot and shuttle</td></tr>
  <tr class="msg" id="L268"><td class="ts-cell"><a class="ts" href="#L268" alt="Fri Feb 07 2020 10:18:48 GMT-0800 (Pacific Standard Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">multi-read access is a gc issue similar to what got us into mess</td></tr>
  <tr class="msg" id="L269"><td class="ts-cell"><a class="ts" href="#L269" alt="Fri Feb 07 2020 10:19:07 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">+1</td></tr>
  <tr class="msg" id="L270"><td class="ts-cell"><a class="ts" href="#L270" alt="Fri Feb 07 2020 10:19:26 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">the nice part about snapshot is it forces us to be explicit about exactly what our uses are</td></tr>
  <tr class="msg" id="L271"><td class="ts-cell"><a class="ts" href="#L271" alt="Fri Feb 07 2020 10:19:42 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">we can then disolve that later for perf as we justify</td></tr>
  <tr class="msg" id="L272"><td class="ts-cell"><a class="ts" href="#L272" alt="Fri Feb 07 2020 10:19:46 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Agreed (though you can share the backing <em>data</em> without problem, because it's immutable)</td></tr>
  <tr class="msg" id="L273"><td class="ts-cell"><a class="ts" href="#L273" alt="Fri Feb 07 2020 10:19:58 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(98% confidence) </td></tr>
  <tr class="msg" id="L274"><td class="ts-cell"><a class="ts" href="#L274" alt="Fri Feb 07 2020 10:20:54 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">So there's some MakeStencilScope(Scope*) -&gt; StencilScope* here, which snapshots the scope on the main thread, for passing to a potential background compile.</td></tr>
  <tr class="msg" id="L275"><td class="ts-cell"><a class="ts" href="#L275" alt="Fri Feb 07 2020 10:21:09 GMT-0800 (Pacific Standard Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">probably the right starting point</td></tr>
  <tr class="msg" id="L276"><td class="ts-cell"><a class="ts" href="#L276" alt="Fri Feb 07 2020 10:21:46 GMT-0800 (Pacific Standard Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">I'm slightly concerned about that getting expensive.</td></tr>
  <tr class="msg" id="L277"><td class="ts-cell"><a class="ts" href="#L277" alt="Fri Feb 07 2020 10:21:55 GMT-0800 (Pacific Standard Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">are Scope-things even allocated on the gc-heap?</td></tr>
  <tr class="msg" id="L278"><td class="ts-cell"><a class="ts" href="#L278" alt="Fri Feb 07 2020 10:22:13 GMT-0800 (Pacific Standard Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">they are</td></tr>
  <tr class="msg" id="L279"><td class="ts-cell"><a class="ts" href="#L279" alt="Fri Feb 07 2020 10:22:21 GMT-0800 (Pacific Standard Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Scope is on gc-heap. Scope::Data is C++. </td></tr>
  <tr class="msg" id="L280"><td class="ts-cell"><a class="ts" href="#L280" alt="Fri Feb 07 2020 10:22:44 GMT-0800 (Pacific Standard Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">the ::Data contains bindings which are tagged jsatom* pointers</td></tr>
  <tr class="msg" id="L281"><td class="ts-cell"><a class="ts" href="#L281" alt="Fri Feb 07 2020 10:23:01 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">having stencil outlive scopes is probably important in long run</td></tr>
  <tr class="msg" id="L282"><td class="ts-cell"><a class="ts" href="#L282" alt="Fri Feb 07 2020 10:23:24 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">we also want a clear ser/des story which snapshoting helps with</td></tr>
  <tr class="msg" id="L283"><td class="ts-cell"><a class="ts" href="#L283" alt="Fri Feb 07 2020 10:24:25 GMT-0800 (Pacific Standard Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"> * </td></tr>
  <tr class="msg" id="L284"><td class="ts-cell"><a class="ts" href="#L284" alt="Fri Feb 07 2020 10:24:44 GMT-0800 (Pacific Standard Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">Scope::Data doesn't have parent info but that can probably be fixed</td></tr>
  <tr class="msg" id="L285"><td class="ts-cell"><a class="ts" href="#L285" alt="Fri Feb 07 2020 10:25:00 GMT-0800 (Pacific Standard Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I don't think we want to fix it?</td></tr>
  <tr class="msg" id="L286"><td class="ts-cell"><a class="ts" href="#L286" alt="Fri Feb 07 2020 10:26:07 GMT-0800 (Pacific Standard Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@djvj:mozilla.org">djvj</span>&gt;</div></td><td class="msg-cell">(fixed, assuming we wanted to use cross-thread pointers to Scope::Data for directly resolving enclosing scope info)</td></tr>
  <tr class="msg" id="L287"><td class="ts-cell"><a class="ts" href="#L287" alt="Fri Feb 07 2020 10:28:03 GMT-0800 (Pacific Standard Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">ah</td></tr>
  <tr class="msg" id="L288"><td class="ts-cell"><a class="ts" href="#L288" alt="Fri Feb 07 2020 10:50:40 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: what have we got to discuss today?</td></tr>
  <tr class="msg" id="L289"><td class="ts-cell"><a class="ts" href="#L289" alt="Fri Feb 07 2020 10:50:58 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">(we have a meeting coming up in 10 minutes)</td></tr>
  <tr class="msg" id="L290"><td class="ts-cell"><a class="ts" href="#L290" alt="Fri Feb 07 2020 10:51:02 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">could skip as far as i'm concerned.</td></tr>
  <tr class="msg" id="L291"><td class="ts-cell"><a class="ts" href="#L291" alt="Fri Feb 07 2020 10:55:20 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">jorendorff</span>: skipping works for me</td></tr>
  <tr class="msg" id="L292"><td class="ts-cell"><a class="ts" href="#L292" alt="Fri Feb 07 2020 10:55:31 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">ok.</td></tr>
  <tr class="msg" id="L293"><td class="ts-cell"><a class="ts" href="#L293" alt="Fri Feb 07 2020 10:55:42 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I've put the stencil meetings back on calendar next week which might be better use of time</td></tr>
  <tr class="msg" id="L294"><td class="ts-cell"><a class="ts" href="#L294" alt="Fri Feb 07 2020 10:55:51 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L295"><td class="ts-cell"><a class="ts" href="#L295" alt="Fri Feb 07 2020 12:40:28 GMT-0800 (Pacific Standard Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">+309/-580 .. this patch is nearly humane</td></tr>
  <tr class="msg" id="L296"><td class="ts-cell"><a class="ts" href="#L296" alt="Fri Feb 07 2020 12:58:38 GMT-0800 (Pacific Standard Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I've put the stencil meetings back on calendar next week which might be better use of time</blockquote></mx-reply>It seems on my calendar they don't start till week after next (20th rather than 13th)</td></tr>
  <tr class="msg" id="L297"><td class="ts-cell"><a class="ts" href="#L297" alt="Fri Feb 07 2020 12:59:48 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: thanks. fixed it</td></tr>
  <tr class="msg" id="L298"><td class="ts-cell"><a class="ts" href="#L298" alt="Fri Feb 07 2020 13:00:50 GMT-0800 (Pacific Standard Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Awesome. Yeah, I have added Modules to the agenda.... they're rapidly becoming the fast approaching blocker. </td></tr>
  <tr class="msg" id="L299"><td class="ts-cell"><a class="ts" href="#L299" alt="Fri Feb 07 2020 13:01:26 GMT-0800 (Pacific Standard Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Is the question still the same thing that blocked SSO?</td></tr>
  <tr class="msg" id="L300"><td class="ts-cell"><a class="ts" href="#L300" alt="Fri Feb 07 2020 13:02:33 GMT-0800 (Pacific Standard Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">So the thing that brought it back to my mind was that ModuleObject::init wants the script </td></tr>
  <tr class="msg" id="L301"><td class="ts-cell"><a class="ts" href="#L301" alt="Fri Feb 07 2020 13:02:39 GMT-0800 (Pacific Standard Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">which I'm trying to take away </td></tr>
  <tr class="msg" id="L302"><td class="ts-cell"><a class="ts" href="#L302" alt="Fri Feb 07 2020 13:03:09 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">but the cross-compartment offthread reference problem is definitely still there</td></tr>
  <tr class="msg" id="L303"><td class="ts-cell"><a class="ts" href="#L303" alt="Fri Feb 07 2020 13:03:50 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">ModuleObject shouldn't exist until stencil::Instantiate</td></tr>
  <tr class="msg" id="L304"><td class="ts-cell"><a class="ts" href="#L304" alt="Fri Feb 07 2020 13:03:52 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">SSO=ScriptSourceObject?</td></tr>
  <tr class="msg" id="L305"><td class="ts-cell"><a class="ts" href="#L305" alt="Fri Feb 07 2020 13:03:56 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I guess the summary of my concerns is that I've been largely able to ignore modules for the last few months, but it's going to become increasingly impossible. and they are peculiar</td></tr>
  <tr class="msg" id="L306"><td class="ts-cell"><a class="ts" href="#L306" alt="Fri Feb 07 2020 13:04:38 GMT-0800 (Pacific Standard Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(The SSO issue being that we considered hoisting initialization of the SSO object onto main thread before we actually do the compilation, but this ends up being hard due to cross compartment issues) </td></tr>
  <tr class="msg" id="L307"><td class="ts-cell"><a class="ts" href="#L307" alt="Fri Feb 07 2020 13:05:34 GMT-0800 (Pacific Standard Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The thing to keep in mind with modules is how they interact with caching</td></tr>
  <tr class="msg" id="L308"><td class="ts-cell"><a class="ts" href="#L308" alt="Fri Feb 07 2020 13:06:50 GMT-0800 (Pacific Standard Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah. We can talk next week. Mostly think we need an owner for Modules in stencil</td></tr>
  <tr class="msg" id="L309"><td class="ts-cell"><a class="ts" href="#L309" alt="Fri Feb 07 2020 13:31:21 GMT-0800 (Pacific Standard Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Hmm.. how horrified would people be if I made LazyScript derive JSScript for a little while...</td></tr>
  <tr class="msg" id="L310"><td class="ts-cell"><a class="ts" href="#L310" alt="Fri Feb 07 2020 13:31:33 GMT-0800 (Pacific Standard Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">"for a little while" lol</td></tr>
  <tr class="msg" id="L311"><td class="ts-cell"><a class="ts" href="#L311" alt="Fri Feb 07 2020 13:32:59 GMT-0800 (Pacific Standard Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The final form will need to invert the type hierarchy to remove LazyScript, make BaseScript the arena-type, and make JSScript a bucket of methods</td></tr>
  <tr class="msg" id="L312"><td class="ts-cell"><a class="ts" href="#L312" alt="Fri Feb 07 2020 13:33:38 GMT-0800 (Pacific Standard Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">it is just really hard to follow the patch that removes the lazyscript instances</td></tr>
  <tr class="msg" id="L313"><td class="ts-cell"><a class="ts" href="#L313" alt="Fri Feb 07 2020 13:33:56 GMT-0800 (Pacific Standard Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">perhaps I can stack in the same patch stack</td></tr>
  <tr class="msg" id="L314"><td class="ts-cell"><a class="ts" href="#L314" alt="Fri Feb 07 2020 13:34:17 GMT-0800 (Pacific Standard Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jorendorff:mozilla.org">jorendorff</span>&gt;</div></td><td class="msg-cell">within a stack, for the purpose of separating a big mechanical patch from the rest, it's fine, for sure. </td></tr>
  <tr class="msg" id="L315"><td class="ts-cell"><a class="ts" href="#L315" alt="Fri Feb 07 2020 13:34:57 GMT-0800 (Pacific Standard Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">neither part is very mechanical</td></tr>
  <tr class="msg" id="L316"><td class="ts-cell"><a class="ts" href="#L316" alt="Fri Feb 07 2020 13:35:13 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I just need to undo 20 years of code around JSScript being <em>the</em> script type</td></tr>
  <tr class="msg" id="L317"><td class="ts-cell"><a class="ts" href="#L317" alt="Fri Feb 07 2020 13:47:15 GMT-0800 (Pacific Standard Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">maybe I just need to remove more screws from this</td></tr>
  <tr class="msg" id="L318"><td class="ts-cell"><a class="ts" href="#L318" alt="Fri Feb 07 2020 13:49:08 GMT-0800 (Pacific Standard Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">Having a few screws loose is always a good approach.</td></tr>
  <tr class="msg" id="L319"><td class="ts-cell"><a class="ts" href="#L319" alt="Fri Feb 07 2020 15:03:28 GMT-0800 (Pacific Standard Time)">23:03</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span></div></td><td class="msg-cell">grumbles about CompileOptions</td></tr>
  <tr class="msg" id="L320"><td class="ts-cell"><a class="ts" href="#L320" alt="Fri Feb 07 2020 15:03:44 GMT-0800 (Pacific Standard Time)">23:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">?</td></tr>
  <tr class="msg" id="L321"><td class="ts-cell"><a class="ts" href="#L321" alt="Fri Feb 07 2020 15:04:20 GMT-0800 (Pacific Standard Time)">23:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">If I change the arena-type to js::BaseScript, then public headers no longer see that JSScript extends js::BaseScript</td></tr>
  <tr class="msg" id="L322"><td class="ts-cell"><a class="ts" href="#L322" alt="Fri Feb 07 2020 15:04:36 GMT-0800 (Pacific Standard Time)">23:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">which means I can't have Rooted&lt;JSScript&gt; in a public header easily</td></tr>
  <tr class="msg" id="L323"><td class="ts-cell"><a class="ts" href="#L323" alt="Fri Feb 07 2020 15:04:59 GMT-0800 (Pacific Standard Time)">23:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">in the future, we don't really want the introducer script, etc to be inputs to parser at all</td></tr>
  <tr class="msg" id="L324"><td class="ts-cell"><a class="ts" href="#L324" alt="Fri Feb 07 2020 15:16:42 GMT-0800 (Pacific Standard Time)">23:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@waldo:mozilla.org">Waldo</span>&gt;</div></td><td class="msg-cell">C++ doesn't make it easy (or really, possible) to expose inheritance relationships without exposing entire classes, unfortunately.</td></tr>

</tbody></table></div></div></div>
</body></html>