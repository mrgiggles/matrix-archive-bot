<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-03-28</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-03-28<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-03-27" class="nav-link"><span>prev</span></a>
<a href="2023-03-29" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Mar 27 2023 18:42:30 GMT-0700 (Pacific Daylight Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">hi, SpiderMonkey folks! So I'm doing some interpreter-speedup things in SpiderMonkey-on-WASI and hoping to find a way to force delazification of self-hosted code before we freeze a snapshot with Wizer. I don't suppose there's a hidden compilation setting to do this? I see all of the machinery for "lazy self-hosted functions" and off-thread delazification and such; WASI doesn't have helper threads so the off-thread delazification doesn't apply; I've been playing around with inserting calls to delazifySelfHostedFunction() [1] at various points but I seem to be missing some invariants somewhere, thus this question :-)

[1] <a href="https://searchfox.org/mozilla-central/source/js/src/vm/SelfHosting.cpp#2610">https://searchfox.org/mozilla-central/source/js/src/vm/SelfHosting.cpp#2610</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Mar 27 2023 23:26:30 GMT-0700 (Pacific Daylight Time)">06:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">cfallin</span>: self-hosted code uses a special kind of lazy functions. There's a shared stencil with all self-hosted functions that we instantiate from if needed; this creates some GC things but doesn't actually do any parsing or bytecode emission so is pretty fast</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Mar 27 2023 23:27:53 GMT-0700 (Pacific Daylight Time)">06:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">(the top-level self-hosted script we run if needed for some intrinsic, see <code>GetComputedIntrinsic</code>.. maybe you could force that to happen before snapshotting)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Mar 27 2023 23:29:28 GMT-0700 (Pacific Daylight Time)">06:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: that all makes sense; I'm not so much worried about the performance of parsing/bytecode emission, this is for feeding into ... other infra that needs the bytecode to exist in the snapshot</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Mar 27 2023 23:33:13 GMT-0700 (Pacific Daylight Time)">06:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">cfallin</span>: the bytecode for the functions should be in the snapshot as part of <code>runtime-&gt;selfHostStencil_</code>. If you want non-lazy scripts for them, maybe you can delazify them immediately in <code>instantiateSelfHostedLazyFunction</code></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Mar 27 2023 23:34:57 GMT-0700 (Pacific Daylight Time)">06:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">ah! it's possible that I'm not hooking things in the right place then (I've shoehorned a "register bytecode" step into the regular function allocation path that hangs an entry on a global linked list that a post-wizer tool can see)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Mar 27 2023 23:35:26 GMT-0700 (Pacific Daylight Time)">06:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">I've been poking at the "immediately delazify" approach, I'll keep trying that then</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Mar 27 2023 23:37:55 GMT-0700 (Pacific Daylight Time)">06:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">except for the top-level self-hosted script that we execute lazily for computed intrinsics, the bytecode for functions should be available in stencil format after runtime initialization. But yeah maybe it's simpler for now to force a delazify there</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Mar 27 2023 23:39:15 GMT-0700 (Pacific Daylight Time)">06:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@cfallin0:mozilla.org">cfallin</span>&gt;</div></td><td class="msg-cell">I actually might be able to just directly process bytecode out of the stencils; I hadn't connected the dots that the data is right there as well. Very helpful, thanks!</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Mar 27 2023 23:40:41 GMT-0700 (Pacific Daylight Time)">06:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">nice :) we've been pretty happy with this setup in the browser; it lets us share bytecode for self-hosted functions between processes using shared memory</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Mar 28 2023 02:36:43 GMT-0700 (Pacific Daylight Time)">09:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">cfallin</span>: I do not know if this might help, but self-hosted code is pre-parsed by the Parent process and given as a stencil to all children processes in Firefox. So there is a mechanism to load from a file a pre-parsed self-hosted code. This mechanism is also used to speed-up the test suite execution, by doing this pre-parse on the first test execution, and re-using it for follow-up test runs.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Mar 28 2023 11:51:07 GMT-0700 (Pacific Daylight Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">have we considered adding parallel minorGC? like V8's parallel scavenge.
On matrix-react-bench we spend 13,000 samples in minorGC vs V8's 2885 with parallel scavenge on and 20,000 samples with parallel scavenge off</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Mar 28 2023 11:54:50 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1795640">Like so</a>?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Mar 28 2023 11:56:14 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: isn't that for majorGC?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Mar 28 2023 11:56:57 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, right</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Mar 28 2023 11:59:59 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">IIRC matrix-react has weird nursery behaviour that we don't think is particularly representative of real-world code</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Mar 28 2023 12:00:33 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">ah</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Mar 28 2023 12:14:02 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">That would be bug 1518861, which we've considered but it's a bit of a worst case in terms of cross-thread memory traffic: you're gathering stuff scattered all over the nursery, and copying it into arenas that are scattered around the major heap (divided up by AllocKind), and the two scatterings are mostly uncorrelated. (Nursery objects are stored in order of allocation; tenured objects are stored by type, and every thread would fight over the same arenas unless you're willing to accept a bunch of fragmentation by doing per-thread arenas.)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Mar 28 2023 12:14:03 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1518861">https://bugzil.la/1518861</a> — NEW (nobody) — Investigate parallel nursery eviction</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Mar 28 2023 12:14:46 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">well, you can trade off fragmentation and synchronization overhead.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Mar 28 2023 12:15:39 GMT-0700 (Pacific Daylight Time)">19:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">even the parallel major GC is getting hit pretty hard by the synchronization, though, and it should have it a lot easier</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Mar 28 2023 12:59:26 GMT-0700 (Pacific Daylight Time)">19:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: how much do we know about how V8's parallel nursery eviction works?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Mar 28 2023 13:01:59 GMT-0700 (Pacific Daylight Time)">20:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">There are a few blog posts about it, though they are rather old at this point. <a href="https://v8.dev/blog/trash-talk">https://v8.dev/blog/trash-talk</a></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Mar 28 2023 13:28:31 GMT-0700 (Pacific Daylight Time)">20:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@dheitbrink:mozilla.org">dheitbrink</span>&gt;</div></td><td class="msg-cell">Is there a good was of preventing SpiderMonkey from overriding the system abort()? I am having issues with some errors getting misclassified.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Mar 28 2023 13:51:46 GMT-0700 (Pacific Daylight Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">jrmuizel</span>: I think jonco has looked at it some. If I recall correctly, they use a compatible heap layout between the nursery and tenured generations. I think sometimes they bulk-tenure an entire chunk of the heap without tracing liveness? But anyway, they don't have the same layout change that we do when tenuring.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Mar 28 2023 13:54:15 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">From skimming that doc, it looks like they have the intermediate generation that I was working on adding to SM. That could also help matrix-react.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Mar 28 2023 14:24:20 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Do we have a spare bit free in latin1 strings that we could use to indicate that they're actually valid ASCII?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Mar 28 2023 14:25:09 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">might have to steal one from the cached index</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Mar 28 2023 14:25:48 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">unfortunately, latin1/twobyte is orthogonal to everything else, so you can't hide it in a bit that's only used for some subtypes</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Mar 28 2023 14:29:46 GMT-0700 (Pacific Daylight Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">though in truth, the GC is only using 1 of the 3 bits it reserves. I don't think we use all 3 as a tag now? We do/did at some point.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Mar 28 2023 14:31:02 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/f9beb753a84aa297713d1565dcd0c5e3c66e4174/js/src/vm/StringType.h#277-345">https://searchfox.org/mozilla-central/rev/f9beb753a84aa297713d1565dcd0c5e3c66e4174/js/src/vm/StringType.h#277-345</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Mar 28 2023 14:34:14 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Sweet, thanks</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Mar 28 2023 14:34:30 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">oh, I think <a href="https://searchfox.org/mozilla-central/source/js/public/TraceKind.h#47">https://searchfox.org/mozilla-central/source/js/public/TraceKind.h#47</a> probably forbids using one of the GC bits.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Mar 28 2023 14:34:54 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">since TraceKind::String is one of the inline ones</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Mar 28 2023 14:35:14 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, good to know</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Mar 28 2023 14:35:51 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For context, I'm talking to Emilio, who would like a fast way to tell if strings are ASCII (aka "valid UTF8") without having to validate them</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Mar 28 2023 14:37:43 GMT-0700 (Pacific Daylight Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For now we're going to prototype "what if Latin1 strings were all valid ASCII by construction" and see how that goes</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Mar 28 2023 14:38:55 GMT-0700 (Pacific Daylight Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the French will hate you, I guess?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Mar 28 2023 14:39:28 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Zut alors!</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Mar 28 2023 14:46:42 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">actually, I think I'm wrong on the GC thing. That's the header word bits, not the pointer. I'm not sure if there's another reason to avoid them.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Mar 28 2023 14:47:06 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The traceKind thing?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Mar 28 2023 14:47:09 GMT-0700 (Pacific Daylight Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Mar 28 2023 14:49:19 GMT-0700 (Pacific Daylight Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: The bug is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1231541">here</a>; maybe double-check to make sure we are not full of lies</td></tr>

</tbody></table></div></div></div>
</body></html>