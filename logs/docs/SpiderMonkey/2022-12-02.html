<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-12-02</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-12-02<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-12-01" class="nav-link"><span>prev</span></a>
<a href="2022-12-05" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Dec 01 2022 16:48:23 GMT-0800 (Pacific Standard Time)">00:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">here's an attempt to set up a new <code>next</code> branch in spidermonkey-embedding-examples! <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/48">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/48</a> review appreciated</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Dec 01 2022 19:58:50 GMT-0800 (Pacific Standard Time)">03:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mayankleoboy1:mozilla.org">mayankleoboy1</span>&gt;</div></td><td class="msg-cell">One of the patches landed yesterday from :anba have improved scores by 20%-50% on some of the AWFY sub-benchmarks:
Jeststream:  base64-SP* , crypto-md5-SP*, crypto-sha1-SP*, pdfjs*</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Dec 01 2022 22:02:08 GMT-0800 (Pacific Standard Time)">06:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Is it possible to add your own "GC Thing" to the Garbage collector, which aren't derived from JSValue?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Dec 01 2022 22:26:04 GMT-0800 (Pacific Standard Time)">06:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: GC things inherit from <a href="https://searchfox.org/mozilla-central/source/js/src/gc/Cell.h#167-182">gc::Cell</a>. There's no inherent connection to JSValue, except that JSValue has a PrivateGCThing variant so that you can store pointers to GC things in reserved slots of objects, and they will be traced along with all the other object slots.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Dec 02 2022 02:53:38 GMT-0800 (Pacific Standard Time)">10:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">So if I inherit from gc::Cell and then do a tracing operation, will I automatically have garbage collection?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Dec 02 2022 02:54:02 GMT-0800 (Pacific Standard Time)">10:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">I'm guessing it's not that simple.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Dec 02 2022 02:55:40 GMT-0800 (Pacific Standard Time)">10:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">no you can't add your own GC things outside the engine</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Dec 02 2022 02:58:46 GMT-0800 (Pacific Standard Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the simplest option would be to use a JS object to 'wrap' your own data structure</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Dec 02 2022 03:03:17 GMT-0800 (Pacific Standard Time)">11:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">I was thinking about that also. My basic idea was if I could utilise the SM garbage collector for other parts of my program that don't have anything to do with javascript.  </td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Dec 02 2022 03:04:19 GMT-0800 (Pacific Standard Time)">11:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Seems like it might be possible by hooking into a jsobject, but it also seems like a design choice I might come to regret later. </td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Dec 02 2022 03:07:11 GMT-0800 (Pacific Standard Time)">11:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah this is an area we're thinking about improving</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Dec 02 2022 08:36:43 GMT-0800 (Pacific Standard Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Thanks for all the reviews!  Currently trying to work out why weak map marking is actually correct.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Dec 02 2022 09:28:28 GMT-0800 (Pacific Standard Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">is it possible to bundle subsets of the <code>dom</code> subtree in gecko-dev into a spidermonkey build? i work at fastly and we'd like to upgrade our javascript compute runtime to a newer version of spidermonkey, but we rely on the old implementation of the streams api which has since moved into the <code>dom</code> subtree.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Dec 02 2022 09:34:18 GMT-0800 (Pacific Standard Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> is it possible to bundle subsets of the <code>dom</code> subtree in gecko-dev into a spidermonkey build? i work at fastly and we'd like to upgrade our javascript compute runtime to a newer version of spidermonkey, but we rely on the old implementation of the streams api which has since moved into the <code>dom</code> subtree.</blockquote></mx-reply>We have aspirations to head in that direction one day, but there's nothing concrete possible at the moment.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Dec 02 2022 09:40:03 GMT-0800 (Pacific Standard Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: that makes a big assumption (that it is correct) ;-)</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Dec 02 2022 09:42:43 GMT-0800 (Pacific Standard Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: Firefox kind of does that, but it uses ref counting for the outside-of-SM objects and then has its own cycle collector that relies on the GC for finding cycles that go through the JS Cell graph</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Dec 02 2022 09:42:54 GMT-0800 (Pacific Standard Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it's... not simple</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Dec 02 2022 09:43:00 GMT-0800 (Pacific Standard Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> We have aspirations to head in that direction one day, but there's nothing concrete possible at the moment.</blockquote></mx-reply>do you know how far off that might be? also, is it the sort of project that a well-motivated external contributor could undertake?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Dec 02 2022 09:44:16 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you'd probably be better off with something more like what you're thinking of, using the SM mark/sweep collector somehow</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Dec 02 2022 09:44:43 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> do you know how far off that might be? also, is it the sort of project that a well-motivated external contributor could undertake?</blockquote></mx-reply>Can't promise things, but my guess would be 1-2 years from our side before we had anything super complete.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Dec 02 2022 09:46:45 GMT-0800 (Pacific Standard Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>could a contributor tackle something; the barrier is very high. This will need a lot of collaboration on the moving parts. The first cut version of this about what needs to be done to get started here:</p>
<ol>
<li>
<p>The cycle collector would need to be extracted into a library / module that can exist outside of gecko. This is because the Streams code uses the ref-counting cycle collector to figure out what is a live and what is dead on the C++ side.</p>
</li>
<li>
<p>The streams code needs to be isolated from gecko; so bits which talk about gecko internals would need to be turned into interfaces</p>
</li>
</ol>
</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Dec 02 2022 09:48:28 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">not having the cycle collector isn't a deal breaker for our use-case if it doesn't control closing streams -- we try very hard to avoid having the garbage collector run at all when running a javascript application at the edge</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Dec 02 2022 09:50:01 GMT-0800 (Pacific Standard Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Well. In that case. 

I would start by hacking the build system a bit to get the webIDL generator code to build you the interfaces required from the DOM streams code, then just start stubbing pieces out until you get something that compiles... ? </td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Dec 02 2022 09:50:34 GMT-0800 (Pacific Standard Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">It's deeply unclear to me where the cuts will actually be, but it certainly seems... potentially possible. </td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Dec 02 2022 09:50:58 GMT-0800 (Pacific Standard Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(ie, get <a href="https://searchfox.org/mozilla-central/source/__GENERATED__/dom/bindings/ReadableStreamBinding.cpp">https://searchfox.org/mozilla-central/source/__GENERATED__/dom/bindings/ReadableStreamBinding.cpp</a> generated) </td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Dec 02 2022 09:51:10 GMT-0800 (Pacific Standard Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">i'll start investigating, thank you so much for the pointers! :)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Dec 02 2022 09:52:21 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">is extracting the cycle collector separately something that mozilla is interested in doing, or would it only serve to help splitting out parts of dom as libraries?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Dec 02 2022 09:52:37 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">This, I expect, will be a big task. Nevertheless, I'd be interested in seeing what it looks like at the other end, as you're walking a bit ahead of where we'd potentially like to go. </td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Dec 02 2022 09:53:35 GMT-0800 (Pacific Standard Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">elliottt</span>: We think that making cycle collection something recyclable in other projects makes sense, but it's far from clear how soon we'd be able to get to it or how possible it'd be.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Dec 02 2022 09:55:09 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">if extracting the streams implementation from the dom tree proves to be too much, do you think it would be possible for us to back-port the old streams implementation to the current release, or has too much changed since it was moved?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Dec 02 2022 10:01:27 GMT-0800 (Pacific Standard Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">elliottt</span>: I expect reverting <a href="https://phabricator.services.mozilla.com/D159610">https://phabricator.services.mozilla.com/D159610</a> will remain almost trivial for a while yet.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Dec 02 2022 10:02:14 GMT-0800 (Pacific Standard Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">oh that's great to know, thank you!</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Dec 02 2022 10:03:48 GMT-0800 (Pacific Standard Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(<code>hg backout bf1bc477f95d</code> <em>just worked</em> for me)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Dec 02 2022 10:04:56 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">in the short-term that seems like it might be our best bet for getting to a more current spidermonkey</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Dec 02 2022 10:05:30 GMT-0800 (Pacific Standard Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Strongly agreed. It is absolutely the lowest energy path</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Dec 02 2022 10:20:57 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">my understanding is that changing sm -&gt; dom streams was more "rewrite" than "move"</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Dec 02 2022 10:33:36 GMT-0800 (Pacific Standard Time)">18:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Yeah; it's a totally separate implementation now hosted in gecko. 

It would be nice if we could take some pieces of CC'd interface and host them in an SM shell (and expose the underlying ability to have CC'd C++ objects to embedders) </td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Dec 02 2022 10:45:42 GMT-0800 (Pacific Standard Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">mgaudet</span>: do you foresee any problems with also reverting <a href="https://phabricator.services.mozilla.com/D139858">https://phabricator.services.mozilla.com/D139858</a>?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Dec 02 2022 10:46:57 GMT-0800 (Pacific Standard Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">elliottt</span>: Uh, AFAIK those were never in good shape. At best leaky, at worst potentially incorrect in places.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Dec 02 2022 10:47:19 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">elliottt</span>: But in principle... no reason they should rot any more than the rest of the streams code</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Dec 02 2022 10:47:47 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(Firefox never shipped Writable or PipeTo because they never hit our quality bar )</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Dec 02 2022 10:47:59 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell">well good to know. maybe we can use them in the short term and spin up some work in the background to get the dom streams without the cycle collector working</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Dec 02 2022 10:48:19 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@elliottt:mozilla.org">elliottt</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (Firefox never shipped Writable or PipeTo because they never hit our quality bar )</blockquote></mx-reply>that's helpful background, thank you!</td></tr>

</tbody></table></div></div></div>
</body></html>