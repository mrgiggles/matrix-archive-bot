<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-05-25</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-05-25<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-05-24" class="nav-link"><span>prev</span></a>
<a href="2022-05-26" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed May 25 2022 08:47:24 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: ping</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed May 25 2022 09:16:10 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">OK: Tailscale + vscode remote is pretty slick. Sitting at the mall waiting for a part to be replaced on my car, while working on my build machine from home over my cell phone tethered. </td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed May 25 2022 09:23:46 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">That's something I want to setup, but I do not want to trust someone else server to bridge between multiple WireGuard network.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed May 25 2022 09:33:24 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I am a big fan of easy. And tailscale was easy.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed May 25 2022 09:33:44 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">But yeah; some trust required I guess</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed May 25 2022 09:52:09 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">“Dear remote service, here is an UDP port which is talking to my server, feel free to poke at it once you get hacked. Cheers”</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed May 25 2022 09:52:21 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">you can run your own tailscale home server</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed May 25 2022 09:52:53 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">it's just for session establishment really</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed May 25 2022 09:56:10 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Well, if so then I would have to look at self-hosting it.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed May 25 2022 09:58:09 GMT-0700 (Pacific Daylight Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/juanfont/headscale">https://github.com/juanfont/headscale</a> seems to be it.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed May 25 2022 13:28:20 GMT-0700 (Pacific Daylight Time)">20:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell">Some number of years ago we noticed that features using itterators allocated and created quiet a bit of GC pressure if used in hot paths (namely things in the raf loop). We have since avoided using things like forEach, for of, filter, etc. It would be nice to be able to use these things, I think we may be operating out of fear on out of date info. Is this still something to be concerned about on modern SpiderMonkey/v8? I suspect its going to be a classic "it depends", but any pointers would still be helpful.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed May 25 2022 13:29:08 GMT-0700 (Pacific Daylight Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell">(Context, this is re Mozilla Hubs, threejs app, lots of stuff going on every frame in a raf loop)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed May 25 2022 13:39:27 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">Dom</span>: We have done some work in the last year or so to improve scalar replacement, with a major goal being the reduction of allocations for iterators. I can't guarantee that we got rid of all the allocations, but it's probably worth trying out some code using iterators and profiling it</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed May 25 2022 13:40:10 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you run into cases where we still allocate a lot of garbage, please open a bug</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed May 25 2022 13:41:58 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-4">Dom</span>: We have done some work in the last year or so to improve scalar replacement, with a major goal being the reduction of allocations for iterators. I can't guarantee that we got rid of all the allocations, but it's probably worth trying out some code using iterators and profiling it</blockquote></mx-reply>Ok, so it should essentially be considered an engine bug if iterators are allocating?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed May 25 2022 13:42:50 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell">Well I guess "allocating" is not accurate, but "creating garbage that outlives the itteration"</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed May 25 2022 13:45:39 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In a perfect world we would not allocate anything for iterators in hot code. I'm not sure how close we can get to that perfect world, but we are definitely closer than we were when you got that advice.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed May 25 2022 13:46:46 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There's some messiness around the edges when it comes to eg correctly identifying hot code, so I don't want to make any hard guarantees</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed May 25 2022 13:49:26 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right now we have optimizations for <code>for of</code> and <code>Array.(forEach/some/every/map)</code>.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed May 25 2022 13:52:21 GMT-0700 (Pacific Daylight Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think at the time we decided that <code>filter</code> was big enough that we didn't necessarily want to inline it everywhere it was used, but we could revisit that decision</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed May 25 2022 13:53:30 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell">That makes sense. I think honestly <code>forEach</code> and <code>map</code> would be our most likely use. We also like to sometimes iterate over <code>Map</code> keys/values/entries.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed May 25 2022 13:53:55 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell">On a related note. When using something like <code>forEach</code> with an anonymous function in a raf loop. Are we creating additional garbage with the function itself every frame, or is that likely to get optimized away since the context is always the same?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed May 25 2022 14:06:08 GMT-0700 (Pacific Daylight Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It should generally get optimized away</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed May 25 2022 14:08:01 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Give me a minute to verify in an opt build; we don't optimize it away in debug builds because we generate some verification code that forces us to keep it around)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed May 25 2022 14:13:17 GMT-0700 (Pacific Daylight Time)">21:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Okay, looks like we optimize it away so long as it is small enough that we decide to inline it</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed May 25 2022 14:15:00 GMT-0700 (Pacific Daylight Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell">ok that's good to know</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed May 25 2022 14:15:44 GMT-0700 (Pacific Daylight Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell">Definitely frustrating to have to play this sort of guessing game with perf sensitive code, but I guess thats just what "games in js" is :D</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed May 25 2022 14:16:56 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, JS definitely doesn't make this easy</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed May 25 2022 14:20:39 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I'll repeat for emphasis that if you try any of this out and you're seeing increased allocations, then there's a reasonable chance that we can do something about it if you bring it to our attention</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed May 25 2022 14:21:14 GMT-0700 (Pacific Daylight Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's hard to tell from our side of the fence where the best places are to spend our time optimizing performance, so we usually just guess and hope</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed May 25 2022 14:21:31 GMT-0700 (Pacific Daylight Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So having a concrete use case is helpful</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed May 25 2022 14:21:46 GMT-0700 (Pacific Daylight Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell">Yeah if you have tips on how best to analyze this stuff that would be helpful. I forget what we did last time we looked into this since its been a few years.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed May 25 2022 14:22:15 GMT-0700 (Pacific Daylight Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@dom:mozilla.org">Dom</span>&gt;</div></td><td class="msg-cell">Also I assume most of the above points are "probably similar in v8" yeah?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed May 25 2022 14:22:58 GMT-0700 (Pacific Daylight Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, something along those lines</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed May 25 2022 14:25:18 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Not sure what the best way to analyze performance would be. Maybe just comparing the rate of nursery GCs before/after rewriting code to use iterators?</td></tr>

</tbody></table></div></div></div>
</body></html>