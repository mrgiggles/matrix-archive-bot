<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-09-04</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-09-04<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-09-03" class="nav-link"><span>prev</span></a>
<a href="2024-09-05" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Sep 03 2024 17:00:14 GMT-0700 (Pacific Daylight Time)">00:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: what kind of example are you looking for?  or, what are you going to use it for?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Sep 03 2024 17:20:54 GMT-0700 (Pacific Daylight Time)">00:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">given <code>frontend::*Stencil</code> are all internal classes, only the actual consumers (parser, bytecode compiler, instantiation, and XDR) are the existing examples</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Sep 04 2024 01:44:14 GMT-0700 (Pacific Daylight Time)">08:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">jseward</span>: thanks for your tests and insights. those wasm are produced by the onnx project, not us. stupid question: since it takes 10 minutes to compile the wasm, is it possible to provide a compiled version to our users so they don't have to do that?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Sep 04 2024 01:46:06 GMT-0700 (Pacific Daylight Time)">08:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">also: is it possible as a temporary fix to bypass ion for this specific wasm in case the right fix takes time to happen</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Sep 04 2024 02:13:57 GMT-0700 (Pacific Daylight Time)">09:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span>: not a stupid question.  But no, we have no (simple, at least) way to pre-compile wasm</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Sep 04 2024 02:14:22 GMT-0700 (Pacific Daylight Time)">09:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell">We could introduce some logic to cause it to not get Ion compiled; that's imaginable</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Sep 04 2024 02:15:18 GMT-0700 (Pacific Daylight Time)">09:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span>: as a meta-point, would it be possible to keep the discussion on the bug?  That way other participants (and future ones) will be able to see the discussion</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Sep 04 2024 02:16:37 GMT-0700 (Pacific Daylight Time)">09:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell">oh, I see you did</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Sep 04 2024 02:22:37 GMT-0700 (Pacific Daylight Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell"><code>JS_ExecuteScript</code> [1] is not annotated as <code>MOZ_CAN_RUN_SCRIPT</code>. Is that intended? [1] <a href="https://searchfox.org/mozilla-central/rev/82ce14a9dc278584b868b2b9c252ba0871a7782b/js/public/CompilationAndEvaluation.h#74">https://searchfox.org/mozilla-central/rev/82ce14a9dc278584b868b2b9c252ba0871a7782b/js/public/CompilationAndEvaluation.h#74</a></td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Sep 04 2024 02:29:52 GMT-0700 (Pacific Daylight Time)">09:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><code>MOZ_CAN_RUN_SCRIPT</code> is currently not used at all in SpiderMonkey. I'm not sure if that should be changed. A lot of JSAPIs can run script (through getters/setters for example)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Sep 04 2024 02:30:57 GMT-0700 (Pacific Daylight Time)">09:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: it could help to correct callers of Gecko</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Sep 04 2024 02:33:12 GMT-0700 (Pacific Daylight Time)">09:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it might be better just tweak the clang plugin to treat all JSAPIs (<code>JS</code>/<code>js</code> namespaces and <code>JS_</code> prefix) as "can run script" by default</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Sep 04 2024 02:33:52 GMT-0700 (Pacific Daylight Time)">09:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">we've also discussed using the static hazard analysis to do something similar without having to annotate explicitly</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Sep 04 2024 02:34:36 GMT-0700 (Pacific Daylight Time)">09:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell">Ok.. leaving that topic to you, was just wondering</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Sep 04 2024 02:39:46 GMT-0700 (Pacific Daylight Time)">09:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">oh wow, bugzilla now supports emoji reactions for comments</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Sep 04 2024 02:47:39 GMT-0700 (Pacific Daylight Time)">09:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell">Are <code>javascript:someCode</code> executions more limited than other script executions? Wondering if <code>MOZ_CAN_RUN_SCRIPT</code> annotations makes sense there</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Sep 04 2024 02:53:25 GMT-0700 (Pacific Daylight Time)">09:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">according to <a href="https://searchfox.org/mozilla-central/source/mfbt/Attributes.h#556-561">the comment</a>, the purpose of the annotation is to enforce the strong reference.  I don't see any notable difference between <code>javascript:someCode</code> vs others in term of it</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Sep 04 2024 03:08:15 GMT-0700 (Pacific Daylight Time)">10:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">mbrodesser (offline on Fridays)</span>: fyi, adding <code>MOZ_CAN_RUN_SCRIPT</code>-type annotations often balloons very quickly. I have WIP patches to add it to various things that can load URIs (amongst others because of <code>javascript:</code>), but they're adding a lot of annotations</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Sep 04 2024 03:49:36 GMT-0700 (Pacific Daylight Time)">10:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span>: re  <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1916442#c13">https://bugzilla.mozilla.org/show_bug.cgi?id=1916442#c13</a>, did you also want instructions for building <code>/path/to/dist/bin/js</code>?  I can add those easily</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Sep 04 2024 03:50:01 GMT-0700 (Pacific Daylight Time)">10:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">yeah for sure thanks</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Sep 04 2024 03:50:20 GMT-0700 (Pacific Daylight Time)">10:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">I wonder how chrome deals with this</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Sep 04 2024 03:50:52 GMT-0700 (Pacific Daylight Time)">10:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">also a bit worried if we need to wait for upstream to fix it :/</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Sep 04 2024 03:53:41 GMT-0700 (Pacific Daylight Time)">10:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> also a bit worried if we need to wait for upstream to fix it :/</blockquote></mx-reply>Yes, exactly.  That's why I wanted this stuff to get written down in the bug, so others can look at it too.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Sep 04 2024 03:57:31 GMT-0700 (Pacific Daylight Time)">10:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">in the meantime maybe we can add a workaround to deactivate ion for those. even if it's 70% it's still better than the current state I guess</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Sep 04 2024 03:57:58 GMT-0700 (Pacific Daylight Time)">10:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell">I added to the bug, build instructions.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Sep 04 2024 03:58:50 GMT-0700 (Pacific Daylight Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell">Can you write down in the bug (if you are happy for it to be public), what sort of timelines / constraints you have for shipping this feature?  So that we have some reference point for discussion in the wasm team.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Sep 04 2024 03:58:59 GMT-0700 (Pacific Daylight Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell">But only if you are happy for that info to be public</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Sep 04 2024 03:59:48 GMT-0700 (Pacific Daylight Time)">10:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">yeah I will for sure. Everything is public</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Sep 04 2024 04:00:52 GMT-0700 (Pacific Daylight Time)">11:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jseward:mozilla.org">jseward</span>&gt;</div></td><td class="msg-cell">Also, if you get perf stats for chrome/d8 compiling it, please add those too</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Sep 04 2024 06:26:30 GMT-0700 (Pacific Daylight Time)">13:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span>: last time I looked into this library, there is a way to change backends, e.g. SIMD, Float32, Int8, etc. Is it available for Transformers.js lib?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Sep 04 2024 06:27:31 GMT-0700 (Pacific Daylight Time)">13:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">if this is the case, my question will be: is the issue exist for one or all backends?</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Sep 04 2024 06:59:58 GMT-0700 (Pacific Daylight Time)">13:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: float32, int8 etc is the quantization level for the model you are loading, it's unrelated to the wasm runtime. The new version now assumes simd support for all browsers, they don't provide non-simd builds anymore. Transformers.js is the JS wrapper on the top of onnx-runtime so it just uses the backend that works in your environment. For us it's JSEP or non-JSEP. So the issue is going to be the same in both cases</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Sep 04 2024 07:03:43 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-14">yury</span>: float32, int8 etc is the quantization level for the model you are loading, it's unrelated to the wasm runtime. The new version now assumes simd support for all browsers, they don't provide non-simd builds anymore. Transformers.js is the JS wrapper on the top of onnx-runtime so it just uses the backend that works in your environment. For us it's JSEP or non-JSEP. So the issue is going to be the same in both cases</blockquote></mx-reply>I'm looking at <a href="https://huggingface.co/spaces/Xenova/webgpu-embedding-benchmark">https://huggingface.co/spaces/Xenova/webgpu-embedding-benchmark</a> and it says WASM + choices of int8,fp16,fp32</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Sep 04 2024 07:04:27 GMT-0700 (Pacific Daylight Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">yes, so if you picjk int8, it gets the model that was quantized at int8 level, fp32: no quantization, fp16: half precision etc</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Sep 04 2024 07:04:42 GMT-0700 (Pacific Daylight Time)">14:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">which is unrelated to the wasm runtime it runs</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Sep 04 2024 07:05:25 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> yes, so if you picjk int8, it gets the model that was quantized at int8 level, fp32: no quantization, fp16: half precision etc</blockquote></mx-reply>correct, my question is if you tried other quantization model (context is bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1887312">https://bugzilla.mozilla.org/show_bug.cgi?id=1887312</a>)</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Sep 04 2024 07:05:28 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">for example, it picks one of them here <a href="https://huggingface.co/Mozilla/distilvit/tree/main/onnx">https://huggingface.co/Mozilla/distilvit/tree/main/onnx</a> using the suffix</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Sep 04 2024 07:06:58 GMT-0700 (Pacific Daylight Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">I tried q8, q4, fp16 and fp32 and had the same issue for the JS stuff</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Sep 04 2024 07:07:19 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">that does not occur for earlier versions (ONNX 1.14) in our current nightly</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Sep 04 2024 07:07:55 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">thanks for pointing that bug though, that's interesting to know!</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Sep 04 2024 07:08:50 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> that does not occur for earlier versions (ONNX 1.14) in our current nightly</blockquote></mx-reply>that's interesting, maybe when onnx wasm is compiled it inlined too much (thus creating huge functions). I wonder if we will rebuild runtime with our options</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Sep 04 2024 07:10:00 GMT-0700 (Pacific Daylight Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">yeah I use the wasm they provide in their dist</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Sep 04 2024 07:10:16 GMT-0700 (Pacific Daylight Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">I pinged someone at microsoft to get some feedbacl</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Sep 04 2024 07:10:33 GMT-0700 (Pacific Daylight Time)">14:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">Can you completely rebuild transformers/onnx lib yourself -- just as experiment</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Sep 04 2024 07:13:29 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">I can try to build the onnx lib but I have no idea how to avoid agressive inlining. </td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Sep 04 2024 07:14:54 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I can try to build the onnx lib but I have no idea how to avoid agressive inlining. </blockquote></mx-reply>it they use clang, there are options you can play with (and <span class="nick-1">jseward</span> can tell all about them :) ). clang is part of emscripten</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Sep 04 2024 07:15:36 GMT-0700 (Pacific Daylight Time)">14:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">I think thing happen here <a href="https://github.com/microsoft/onnxruntime/blob/main/cmake/onnxruntime_webassembly.cmake">https://github.com/microsoft/onnxruntime/blob/main/cmake/onnxruntime_webassembly.cmake</a></td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Sep 04 2024 07:18:11 GMT-0700 (Pacific Daylight Time)">14:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-7">mbrodesser (offline on Fridays)</span>: fyi, adding <code>MOZ_CAN_RUN_SCRIPT</code>-type annotations often balloons very quickly. I have WIP patches to add it to various things that can load URIs (amongst others because of <code>javascript:</code>), but they're adding a lot of annotations</blockquote></mx-reply><span class="nick-3">peterv</span>: is it clear when those patches will land?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Sep 04 2024 07:33:09 GMT-0700 (Pacific Daylight Time)">14:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@mbrodesser:igalia.com">mbrodesser (offline on Fridays)</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">peterv</span>: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1745214#c3">https://bugzilla.mozilla.org/show_bug.cgi?id=1745214#c3</a> would allow smaller steps forward.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Sep 04 2024 13:16:46 GMT-0700 (Pacific Daylight Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>I'm running</p>
<pre><code class="language-c++">    JS::SourceText&lt;mozilla::Utf8Unit&gt; source;
    if (!source.init(ctx, scriptSource.c_str(), scriptSource.size(), JS::SourceOwnership::Borrowed)) {
        return nullptr;
    }
    RefPtr&lt;JS::Stencil&gt; stencil = JS::CompileGlobalScriptToStencil(ctx, opts, source);
</code></pre>
<p>on botched JS code like <code>{ asdf; }}</code>, it seems to be crashing mozjs. Shouldn't it at the very most just return a <code>nullptr</code>?</p>
</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Sep 04 2024 13:21:28 GMT-0700 (Pacific Daylight Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">That's what I would expect, unless <code>scriptSource</code> or <code>scriptSource.c_str()</code> were nullptr, maybe? Do you have a crash stack?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Sep 04 2024 13:21:46 GMT-0700 (Pacific Daylight Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I'll have to check the coredump</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Sep 04 2024 13:25:16 GMT-0700 (Pacific Daylight Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">really, I would expect <code>stencil</code> to be a nullptr <code>RefPtr</code>. Do you bool-check <code>if (!stencil)</code> after the above code?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Sep 04 2024 13:26:39 GMT-0700 (Pacific Daylight Time)">20:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Sep 04 2024 14:01:11 GMT-0700 (Pacific Daylight Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> That's what I would expect, unless <code>scriptSource</code> or <code>scriptSource.c_str()</code> were nullptr, maybe? Do you have a crash stack?</blockquote></mx-reply><p>found the stack trace</p>
<pre><code>#0  0x00007f965c76048e in JSLinearString* JSLinearString::newValidLength&lt;(js::AllowGC)1, unsigned char&gt;(JSContext*, mozilla::UniquePtr&lt;unsigned char [], JS::FreePolicy&gt;, unsigned long, js::gc::InitialHeap) () from /tmp/lib/libmozjs-102.so
#1  0x00007f965c7603b2 in JSLinearString* js::NewStringCopyNDontDeflateNonStaticValidLength&lt;(js::AllowGC)1, unsigned char&gt;(JSContext*, unsigned char const*, unsigned long, js::gc::InitialHeap) () from /tmp/lib/libmozjs-102.so
#2  0x00007f965c762285 in js::NewStringCopyUTF8N(JSContext*, JS::UTF8Chars, js::gc::InitialHeap) () from /tmp/lib/libmozjs-102.so
#3  0x00007f965c8f5a95 in JS_NewStringCopyUTF8Z(JSContext*, JS::ConstUTF8CharsZ) () from /tmp/lib/libmozjs-102.so
#4  0x00007f965c909128 in js::ErrorToException(JSContext*, JSErrorReport*, JSErrorFormatString const* (*)(void*, unsigned int), void*)
    () from /tmp/lib/libmozjs-102.so
#5  0x00007f965c53b59d in ReportCompileErrorImpl(JSContext*, js::ErrorMetadata&amp;&amp;, mozilla::UniquePtr&lt;JSErrorNotes, JS::DeletePolicy&lt;JSErrorNotes&gt; &gt;, unsigned int, __va_list_tag (*) [1], js::ErrorArgumentsType) () from /tmp/lib/libmozjs-102.so
#6  0x00007f965c53b393 in js::ReportCompileErrorLatin1(JSContext*, js::ErrorMetadata&amp;&amp;, mozilla::UniquePtr&lt;JSErrorNotes, JS::DeletePolicy&lt;JSErrorNotes&gt; &gt;, unsigned int, __va_list_tag (*) [1]) () from /tmp/lib/libmozjs-102.so
#7  0x00007f965ca3b107 in js::frontend::ErrorReportMixin::error(unsigned int, ...) () from /tmp/lib/libmozjs-102.so
#8  0x00007f965caa7b84 in js::frontend::Parser&lt;js::frontend::FullParseHandler, mozilla::Utf8Unit&gt;::globalBody(js::frontend::GlobalSharedContext*) () from /tmp/lib/libmozjs-102.so
#9  0x00007f965caf3593 in ScriptCompiler&lt;mozilla::Utf8Unit&gt;::compile(JSContext*, js::frontend::SharedContext*) ()
   from /tmp/lib/libmozjs-102.so
#10 0x00007f965caf3024 in bool CompileGlobalScriptToStencilAndMaybeInstantiate&lt;mozilla::Utf8Unit&gt;(JSContext*, js::frontend::CompilationInput&amp;, JS::SourceText&lt;mozilla::Utf8Unit&gt;&amp;, js::ScopeKind, mozilla::Variant&lt;mozilla::UniquePtr&lt;js::frontend::ExtensibleCompilationStencil, JS::DeletePolicy&lt;js::frontend::ExtensibleCompilationStencil&gt; &gt;, RefPtr&lt;js::frontend::CompilationStencil&gt;, js::frontend::CompilationGCOutput*&gt;&amp;) () from /tmp/lib/libmozjs-102.so
#11 0x00007f965cabc8e9 in js::frontend::CompileGlobalScriptToStencil(JSContext*, js::frontend::CompilationInput&amp;, JS::SourceText&lt;mozilla::Utf8Unit&gt;&amp;, js::ScopeKind) () from /tmp/lib/libmozjs-102.so
#12 0x00007f965cb52320 in JS::CompileGlobalScriptToStencil(JSContext*, JS::ReadOnlyCompileOptions const&amp;, JS::SourceText&lt;mozilla::Utf8Unit&gt;&amp;) () from /tmp/lib/libmozjs-102.so
</code></pre>
</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Sep 04 2024 15:33:48 GMT-0700 (Pacific Daylight Time)">22:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">is the <a href="https://searchfox.org/mozilla-esr102/source/js/src/jsexn.cpp#326">filename not set</a>, I wonder?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Sep 04 2024 15:54:20 GMT-0700 (Pacific Daylight Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I set it via <code>setFileAndLine</code>, even tried with a hardcoded <code>"noname"</code>. stencil compilation works on JS code with no syntax errors, just segfaults on badly formatted JS code</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Sep 04 2024 16:03:23 GMT-0700 (Pacific Daylight Time)">23:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-c++">    JS::CompileOptions opts(ctx);
    opts.setFileAndLine("noname", 1);
    JS::SourceText&lt;mozilla::Utf8Unit&gt; source;
    if (!source.init(ctx, scriptSource.c_str(), scriptSource.length(), JS::SourceOwnership::Borrowed)) {
        return nullptr;
    }
    RefPtr&lt;JS::Stencil&gt; stencil = JS::CompileGlobalScriptToStencil(ctx, opts, source);
    return stencil;
</code></pre>
</td></tr>

</tbody></table></div></div></div>
</body></html>