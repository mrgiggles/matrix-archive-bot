<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-09-17</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-09-17<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-09-16" class="nav-link"><span>prev</span></a>
<a href="2021-09-18" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Sep 16 2021 17:04:57 GMT-0700 (Pacific Daylight Time)">00:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Alright. If you can't figure it out soon, you should back out the patch until you do, as it is a big regression.</blockquote></mx-reply>agreed.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Sep 16 2021 17:08:33 GMT-0700 (Pacific Daylight Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: <span class="nick-12">sfink</span> have either of you uploaded a profile so I can take a short cut to where you're at?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Sep 16 2021 17:08:53 GMT-0700 (Pacific Daylight Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">pbone</span>: I think I posted on bug</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Sep 16 2021 17:09:07 GMT-0700 (Pacific Daylight Time)">00:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(marker-only, missing first 200s)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Sep 16 2021 17:09:13 GMT-0700 (Pacific Daylight Time)">00:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">Okay thanks (I only just sat down for my work day, I hadn't read that yet, sorry)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Sep 16 2021 17:09:39 GMT-0700 (Pacific Daylight Time)">00:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">Oh.  Interesting, because I suspect something may happen at around ~60s because that's when the first inactive GC timer will fire.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Sep 16 2021 17:09:40 GMT-0700 (Pacific Daylight Time)">00:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">No worries. Looks like scheduling issue, but not sure if it lies near your scheduling work or steves</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Sep 16 2021 17:11:17 GMT-0700 (Pacific Daylight Time)">00:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">After you mentioned DMD crashes, mine started crashing and I don't know what I did different before. Though I stand by the excess memory being PHttpChannelParent in parent process</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Sep 16 2021 17:12:19 GMT-0700 (Pacific Daylight Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">In the marker-chart, steve notice there is a lot of "<strong>delete</strong>" messages for them, so we are confused why the memory isn't reclaimed yet. Thus the question of if we lost of CC's and that previously cleaned up</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Sep 16 2021 17:13:15 GMT-0700 (Pacific Daylight Time)">00:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I think that is where we landed, so maybe you'll find a bit more reason why we don't have CCSlices after your patch until the tabs all close.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Sep 16 2021 17:14:25 GMT-0700 (Pacific Daylight Time)">00:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">My suspicion is that now that the inactive GC is a full GC it somehow does something causing the cycle collector not to collect enough stuff.  But I don't know why.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Sep 16 2021 17:15:00 GMT-0700 (Pacific Daylight Time)">00:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yeah, I don't have any theories why those are connected either</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Sep 16 2021 17:15:22 GMT-0700 (Pacific Daylight Time)">00:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">in the profiles it is clear that the CCs before are partial (1/3 zone)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Sep 16 2021 17:15:37 GMT-0700 (Pacific Daylight Time)">00:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">yeah, I can think of theories but they're too vague to mention at this point.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Sep 16 2021 17:15:46 GMT-0700 (Pacific Daylight Time)">00:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">so might be some pre-existing weakness of our scheduling that we exacerbated</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Sep 16 2021 17:15:55 GMT-0700 (Pacific Daylight Time)">00:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">CCs can be zonal?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Sep 16 2021 17:16:11 GMT-0700 (Pacific Daylight Time)">00:16</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span></div></td><td class="msg-cell">checks his terminology</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Sep 16 2021 17:17:02 GMT-0700 (Pacific Daylight Time)">00:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">sorry, the GCMajor is 1/3 zone</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Sep 16 2021 17:17:06 GMT-0700 (Pacific Daylight Time)">00:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">that makes more sense..</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Sep 16 2021 17:20:53 GMT-0700 (Pacific Daylight Time)">00:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">pbone</span>: if you re-run it, I think <code>MOZ_PROFILER_STARTUP_ENTRIES</code> is the env variable you need. the default is 4million so 10mil might cover you. Also I think <code>--iterations=1</code> is the command line option for the awsy script to get one pass through the list. I was manually editting python files which is silly</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Sep 16 2021 17:22:42 GMT-0700 (Pacific Daylight Time)">00:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">I also found <code>--quick</code> which got me through an awsy without crashing.  I havn't tested if it still reproduces the problem though.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Sep 16 2021 17:23:14 GMT-0700 (Pacific Daylight Time)">00:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I expect it does. I didn't see anything too fancy needed to repro this issue</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Sep 16 2021 17:23:53 GMT-0700 (Pacific Daylight Time)">00:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">since it generates memory reports, I just load into a browser and use about:memory load-and-compare mode</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Sep 16 2021 17:26:50 GMT-0700 (Pacific Daylight Time)">00:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">I think that 60s timer might be needed. but I'm not certain.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Sep 16 2021 17:32:51 GMT-0700 (Pacific Daylight Time)">00:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">Um, this might be cheating but what if we don't run the USER_INACTIVE GC timer during a benchmark.  It's supposed to run only if the user has stepped away (and, recent patch, when the browser is not animating).  It looks like that 2nd part doesn't work for the parent process, at least when the parent process is loading more tabs / facilitating active stuff for tabs.  It seems like a good idea anyway to just make the USER_INACTIVE GCs more conditional.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Sep 16 2021 17:33:37 GMT-0700 (Pacific Daylight Time)">00:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">maybe cheating because it doesn't actually tell us why we're getting the current problem.  But maybe not, because it looks like this is only a problem for benchmarks in CI.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Sep 16 2021 17:34:09 GMT-0700 (Pacific Daylight Time)">00:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">FWIW AWSY tries to fake interactivity by doing some clicks.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Sep 16 2021 17:34:23 GMT-0700 (Pacific Daylight Time)">00:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">oh.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Sep 16 2021 17:34:34 GMT-0700 (Pacific Daylight Time)">00:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">I wonder if the parent detects them or just the content process.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Sep 16 2021 17:34:56 GMT-0700 (Pacific Daylight Time)">00:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/testing/awsy/awsy/awsy_test_case.py#365">https://searchfox.org/mozilla-central/source/testing/awsy/awsy/awsy_test_case.py#365</a></td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Sep 16 2021 17:35:08 GMT-0700 (Pacific Daylight Time)">00:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">I noticed when I was testing the interactivity thing that the parent seemed to be quick to say "User is inactive"</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Sep 16 2021 17:35:54 GMT-0700 (Pacific Daylight Time)">00:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: is that used by the motionmark benchmark, which I think is in talos?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Sep 16 2021 17:35:59 GMT-0700 (Pacific Daylight Time)">00:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I was surprised too that this went to inactive since it was loading a new tab every few seconds</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Sep 16 2021 17:36:18 GMT-0700 (Pacific Daylight Time)">00:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">I saw the problems there first.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Sep 16 2021 17:36:23 GMT-0700 (Pacific Daylight Time)">00:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">pbone</span>: I have no idea. That's from AWSY.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Sep 16 2021 17:36:39 GMT-0700 (Pacific Daylight Time)">00:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@pbone:mozilla.org">pbone</span>&gt;</div></td><td class="msg-cell">okay.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Sep 16 2021 23:35:34 GMT-0700 (Pacific Daylight Time)">06:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@lth:mozilla.org">lth</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> ProcessChild::QuickExit() is the method that does the exit.</blockquote></mx-reply>Thank you!</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Sep 17 2021 08:58:18 GMT-0700 (Pacific Daylight Time)">15:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: Oops, sorry about that.  I'll post a patch.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Sep 17 2021 10:43:47 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">confession: Posted <a href="https://phabricator.services.mozilla.com/D126002">my <code>ReadableStream.tee</code></a> patch</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Sep 17 2021 10:43:50 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Sep 17 2021 13:25:34 GMT-0700 (Pacific Daylight Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Hi! I have a question: when implementing a new function, is it better to define it as self-hosted or in C++ code?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Sep 17 2021 13:33:33 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">nicolo-ribaudo</span>: The unsatisfying answer is "it depends on the new function"</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Sep 17 2021 13:33:48 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There are some things that it's easier to do in self-hosted code, and some things that it's easier to do in C++</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Sep 17 2021 13:34:21 GMT-0700 (Pacific Daylight Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@tjc:igalia.com">Tim</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> There are some things that it's easier to do in self-hosted code, and some things that it's easier to do in C++</blockquote></mx-reply>Ah ok. We're asking because we were told that self-hosted methods were going to be removed</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Sep 17 2021 13:37:14 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We've talked about coming up with a replacement for self-hosted code, but AFAIK (<span class="nick-15">tcampbell</span>?) we're still very much at the "wouldn't it be nice if?" phase on that</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Sep 17 2021 13:38:13 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Self-hosted isn't being removed (any time soon). We changed how it works under the covers, but things can still be written in it. That change is already landed. </td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Sep 17 2021 13:38:43 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And it's likely that any replacement would be designed to be good at similar sorts of things, so if it's currently easiest to implement a new function as self-hosted code, we would probably choose to implement it in the replacement too</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Sep 17 2021 13:39:26 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But to say anything more precise I would need a better sense of what you want to implement</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Sep 17 2021 13:43:06 GMT-0700 (Pacific Daylight Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">As part of the implementation for the Stage 2 proposal, we need to implement all the tuple prototype methods (which are similar to array methods), and we were wondering where to implement them</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Sep 17 2021 13:43:58 GMT-0700 (Pacific Daylight Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">We started with self-hosted methods, and then decided that it was better to ask if it's ok</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Sep 17 2021 13:44:12 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Self-hosting is still probably reasonable for that case</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Sep 17 2021 13:44:30 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Ok thank you 👍</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Sep 17 2021 13:44:57 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">(The changes to self-hosting have removed some of the negative attributes of it which is nice :)</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Sep 17 2021 13:46:31 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">I probably don't know the SM code enough to understand exactly the changes, but I'm slowly getting a more comprehensive view 😄</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Sep 17 2021 13:47:38 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">main impact is that writing things in self-hosting use less memory than before :)</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Sep 17 2021 13:48:00 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">so if you add 20 methods, I won't be sad anymore</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Sep 17 2021 13:48:33 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Oh that's _perfect_ for this proposal, even if we recently reduced the number of methods it introduces</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Sep 17 2021 13:48:51 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-9">nicolo-ribaudo</span>: So, speaking of R+T since you're here.</p>
<p>I just finished a skim-level review of your R+T-as-objects patches. The big place I need feedback from others is on JIT integration (intentionally disabled in the <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1730843">stack</a>). Overall though: I think it is a very credible approach.</p>
<p>Now, the question I had for you specifically was: You've written this feature twice (amazing, thank you by the way.): What was your feeling about the two approaches? Having implemented them as special objects, does our concern about new primitives types make more sense, or do you still feel like a new primative type is going to be the more elegant way to go about this.</p>
</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Sep 17 2021 13:50:30 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">While people who know about things are here: how does R+T-as-objects deal with equality? Does it mean that we need an additional check to decide that two objects are not equal to each other (which could previously be determined purely by pointer identity)?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Sep 17 2021 13:53:36 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">iain: in the object model, yes, I think we're going to have a second check. In the primitive type implmentation, I think its no in the general case, a maybe for R+T depending on implementation strategy</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Sep 17 2021 13:54:05 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Having said that, we <em>might</em> I think be able to get back to single check for equality on objects if the interning machinery is built</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Sep 17 2021 13:54:25 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Oh, wait: that's not true with boxing anymore</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Sep 17 2021 13:55:17 GMT-0700 (Pacific Daylight Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">nicolo-ribaudo</span>: (If you wanted to expand this into a document for more perusal, that's fine too. Sorry for ambushing you a bit here :P)</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Sep 17 2021 13:56:06 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">(I'm writing a long-ish message here, maybe I'll copy-paste it somewhere to refer to it in the future 😛)</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Sep 17 2021 14:08:07 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><p>Implementing them as object was <em>way easier</em>.</p>
<ul>
<li>I didn't have to change some bit patterns of the other primitives to make room for three new ones. I felt like there is a limit of how many primitives we can have (unless we do a big refactoring), but with R/T/B I still didn't hit this limit and it's hard for me to predict what it is.</li>
<li>Most of the logic was already there, and probably it's already faster: for example, accessing record fields is (I think) O(1) rather than O(n) - at least for small records.</li>
<li>The JIT in the object-based stack is disabled because I didn't check yet how it works with equality, but I expect it to already work "for free" for record property access. On the other hand, the jit for primitive-based R&amp;T must probably be written from scratch.</li>
</ul>
<p>However, I think that the primitives version can be optimized in R&amp;T-specific ways that it might be harder or impossible.</p>
<ul>
<li>One example is interning: with boxes and with the <code>+0</code>/<code>-0</code> equality we can <em>still</em> intern, but we need to intern different parts of the immutable strucure separately. Specifically, we can track "normal values" separately from boxes and zeroes, and only intern the "normal values" part. I tried thinking about how it could work at <a href="https://excalidraw.com/#json=5321061461655552,XTvh_y9dGjsgVeJR0PNKsA">https://excalidraw.com/#json=5321061461655552,XTvh_y9dGjsgVeJR0PNKsA</a>, but I didn't actually experiment with an implementation yet.</li>
<li>I <em>think</em> it might be easier in the future to share R&amp;T without boxes accross threads if we use primitives, but this is just a speculation I'm making since they don't have all the special cases that objects have</li>
</ul>
<p>Also, with object-based R/T/B we must be careful about the dinstinction between ""primitives"" and their box objects. There are many places in the spec where primitives should be wrapped (for example, <code>Object.prototype.valueOf(#{})</code> should return an object). When using primitives this is easy: any C++ function that expects an object will refuse anything with a type which is not <code>JSObject*</code>. When using object-based primitives, the C++ type-checker doesn't help and we must "manually" verify that we don't accidentally forget wrapping the R/T/B somewhere.</p>
<p><span class="nick-4">iain</span>: Yes, I needed to add an extra check. However, this is similar to how we already have to check the type of a value to determine that it's an object, before comparing its pointer. You can see it at <a href="https://phabricator.services.mozilla.com/D125649#change-k4u2kzSwvSjZ">https://phabricator.services.mozilla.com/D125649#change-k4u2kzSwvSjZ</a></p>
</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Sep 17 2021 14:10:08 GMT-0700 (Pacific Daylight Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">(<span class="nick-2">mgaudet</span> I'll reply to your comments on phabricator on Monday, it's 11pm here now)</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Sep 17 2021 14:10:24 GMT-0700 (Pacific Daylight Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">nicolo-ribaudo</span>: No worries! Thanks so much for the detailed thinking</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Sep 17 2021 14:23:57 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">tripping on Hazard stuff again but it is something that landed yesterday.. Something connected with JSFunction or Stencil....</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Sep 17 2021 14:24:25 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell"><pre><code>Function '_ZL25CompileStandaloneFunctionP9JSContextRKN2JS22ReadOnlyCompileOptionsERNS1_10SourceTextIDsEERKN7mozilla5MaybeIjEEN2js8frontend18FunctionSyntaxKindENSD_13GeneratorKindENSD_17FunctionAsyncKindENS1_6HandleIPNSD_5ScopeEEE$BytecodeCompiler.cpp:JSFunction* CompileStandaloneFunction(JSContext*, JS::ReadOnlyCompileOptions*, JS::SourceText&lt;char16_t&gt;*, mozilla::Maybe&lt;unsigned int&gt;*, uint8, uint8, uint8, JS::Handle&lt;js::Scope*&gt;)' has unrooted '&lt;returnvalue&gt;' of type 'JSFunction*' live across GC call '_ZN2JS6RootedIN2js8frontend16CompilationInputEED1Ev$JS::Rooted&lt;T&gt;::~Rooted() [with T = js::frontend::CompilationInput]' at js/src/frontend/BytecodeCompiler.cpp:1225
    BytecodeCompiler.cpp:1225: Assign(112,113, return := __temp_35**)
    BytecodeCompiler.cpp:1225: Call(113,114, source.~__dt_comp ())
    BytecodeCompiler.cpp:1225: Call(114,115, gcOutput.~__dt_comp ())
    BytecodeCompiler.cpp:1225: Call(115,116, compiler.~__dt_comp ())
    BytecodeCompiler.cpp:1225: Call(116,117, parserAllocScope.~__dt_comp ())
    BytecodeCompiler.cpp:1225: Call(117,118, input.~__dt_comp ()) [[GC call]]
    BytecodeCompiler.cpp:1225: Call(118,119, assertException.~__dt_comp ())
    BytecodeCompiler.cpp:1226:  [[end of function]]
GC Function: _ZN2JS6RootedIN2js8frontend16CompilationInputEED1Ev$JS::Rooted&lt;T&gt;::~Rooted() [with T = js::frontend::CompilationInput]
    JS::Rooted&lt;T&gt;::~Rooted() [with T = js::frontend::CompilationInput] [[base_dtor]]
    virtual js::RootedTraceable&lt;js::frontend::CompilationInput&gt;::~RootedTraceable() [[complete_dtor]]
    virtual js::RootedTraceable&lt;js::frontend::CompilationInput&gt;::~RootedTraceable() [[base_dtor]]
    void js::frontend::CompilationInput::~CompilationInput() [[complete_dtor]]
    void js::frontend::CompilationInput::~CompilationInput() [[base_dtor]]
    RefPtr&lt;T&gt;::~RefPtr() [with T = js::ScriptSource] [[complete_dtor]]
    RefPtr&lt;T&gt;::~RefPtr() [with T = js::ScriptSource] [[base_dtor]]
    static void RefPtr&lt;T&gt;::ConstRemovingRefPtrTraits&lt;U&gt;::Release(U*) [with U = js::ScriptSource; T = js::ScriptSource]
    static void mozilla::RefPtrTraits&lt;U&gt;::Release(U*) [with U = js::ScriptSource]
    void js::ScriptSource::Release()
    Utility.h:void js_delete(js::ScriptSource*) [with T = js::ScriptSource]
    void js::ScriptSource::~ScriptSource()
    void js::ScriptSource::~ScriptSource() [[base_dtor]]
    mozilla::UniquePtr&lt;T, D&gt;::~UniquePtr() [with T = js::XDRIncrementalStencilEncoder; D = JS::DeletePolicy&lt;js::XDRIncrementalStencilEncoder&gt;]
    mozilla::UniquePtr&lt;T, D&gt;::~UniquePtr() [with T = js::XDRIncrementalStencilEncoder; D = JS::DeletePolicy&lt;js::XDRIncrementalStencilEncoder&gt;] [[base_dtor]]
    void mozilla::UniquePtr&lt;T, D&gt;::reset(mozilla::UniquePtr&lt;T, D&gt;::Pointer) [with T = js::XDRIncrementalStencilEncoder; D = JS::DeletePolicy&lt;js::XDRIncrementalStencilEncoder&gt;; mozilla::UniquePtr&lt;T, D&gt;::Pointer = js::XDRIncrementalStencilEncoder*]
    void JS::DeletePolicy&lt;T&gt;::operator()(const T*) [with T = js::XDRIncrementalStencilEncoder]
    Utility.h:void js_delete(js::XDRIncrementalStencilEncoder*) [with T = js::XDRIncrementalStencilEncoder]
    void js::XDRIncrementalStencilEncoder::~XDRIncrementalStencilEncoder()
    void js::XDRIncrementalStencilEncoder::~XDRIncrementalStencilEncoder() [[base_dtor]]
    Utility.h:void js_delete(js::frontend::CompilationStencilMerger*) [with T = js::frontend::CompilationStencilMerger]
    void js::frontend::CompilationStencilMerger::~CompilationStencilMerger() [[complete_dtor]]
    void js::frontend::CompilationStencilMerger::~CompilationStencilMerger() [[base_dtor]]
    mozilla::UniquePtr&lt;T, D&gt;::~UniquePtr() [with T = js::frontend::ExtensibleCompilationStencil; D = JS::DeletePolicy&lt;js::frontend::ExtensibleCompilationStencil&gt;]
    mozilla::UniquePtr&lt;T, D&gt;::~UniquePtr() [with T = js::frontend::ExtensibleCompilationStencil; D = JS::DeletePolicy&lt;js::frontend::ExtensibleCompilationStencil&gt;] [[base_dtor]]
    void mozilla::UniquePtr&lt;T, D&gt;::reset(mozilla::UniquePtr&lt;T, D&gt;::Pointer) [with T = js::frontend::ExtensibleCompilationStencil; D = JS::DeletePolicy&lt;js::frontend::ExtensibleCompilationStencil&gt;; mozilla::UniquePtr&lt;T, D&gt;::Pointer = js::frontend::ExtensibleCompilationStencil*]
    void JS::DeletePolicy&lt;T&gt;::operator()(const T*) [with T = js::frontend::ExtensibleCompilationStencil]
    Utility.h:void js_delete(js::frontend::ExtensibleCompilationStencil*) [with T = js::frontend::ExtensibleCompilationStencil]
    void js::frontend::ExtensibleCompilationStencil::~ExtensibleCompilationStencil() [[complete_dtor]]
    void js::frontend::ExtensibleCompilationStencil::~ExtensibleCompilationStencil() [[base_dtor]]
    RefPtr&lt;T&gt;::~RefPtr() [with T = js::frontend::StencilAsmJSContainer] [[complete_dtor]]
    RefPtr&lt;T&gt;::~RefPtr() [with T = js::frontend::StencilAsmJSContainer] [[base_dtor]]
    static void RefPtr&lt;T&gt;::ConstRemovingRefPtrTraits&lt;U&gt;::Release(U*) [with U = js::frontend::StencilAsmJSContainer; T = js::frontend::StencilAsmJSContainer]
    static void mozilla::RefPtrTraits&lt;U&gt;::Release(U*) [with U = js::frontend::StencilAsmJSContainer]
    void js::AtomicRefCounted&lt;T&gt;::Release() const [with T = js::frontend::StencilAsmJSContainer]
    Utility.h:void js_delete(js::frontend::StencilAsmJSContainer*) [with T = js::frontend::StencilAsmJSContainer]
    void js::frontend::StencilAsmJSContainer::~StencilAsmJSContainer() [[complete_dtor]]
    void js::frontend::StencilAsmJSContainer::~StencilAsmJSContainer() [[base_dtor]]
    mozilla::HashMap&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt;, mozilla::DefaultHasher&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt; &gt;, js::SystemAllocPolicy&gt;::~HashMap() [[complete_dtor]]
    mozilla::HashMap&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt;, mozilla::DefaultHasher&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt; &gt;, js::SystemAllocPolicy&gt;::~HashMap() [[base_dtor]]
    mozilla::detail::HashTable&lt;T, HashPolicy, AllocPolicy&gt;::~HashTable() [with T = mozilla::HashMapEntry&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt; &gt;; HashPolicy = mozilla::HashMap&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt;, mozilla::DefaultHasher&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt; &gt;, js::SystemAllocPolicy&gt;::MapHashPolicy; AllocPolicy = js::SystemAllocPolicy]
    mozilla::detail::HashTable&lt;T, HashPolicy, AllocPolicy&gt;::~HashTable() [with T = mozilla::HashMapEntry&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt; &gt;; HashPolicy = mozilla::HashMap&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt;, mozilla::DefaultHasher&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt; &gt;, js::SystemAllocPolicy&gt;::MapHashPolicy; AllocPolicy = js::SystemAllocPolicy] [[base_dtor]]
    static void mozilla::detail::HashTable&lt;T, HashPolicy, AllocPolicy&gt;::destroyTable(AllocPolicy&amp;, char*, uint32_t) [with T = mozilla::HashMapEntry&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt; &gt;; HashPolicy = mozilla::HashMap&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt;, mozilla::DefaultHasher&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt; &gt;, js::SystemAllocPolicy&gt;::MapHashPolicy; AllocPolicy = js::SystemAllocPolicy; uint32_t = unsigned int]
    static void mozilla::detail::HashTable&lt;T, HashPolicy, AllocPolicy&gt;::forEachSlot(char*, uint32_t, F&amp;&amp;) [with F = mozilla::detail::HashTable&lt;T, HashPolicy, AllocPolicy&gt;::destroyTable(AllocPolicy&amp;, char*, uint32_t) [with T = mozilla::HashMapEntry&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt; &gt;; HashPolicy = mozilla::HashMap&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt;, mozilla::DefaultHasher&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt; &gt;, js::SystemAllocPolicy&gt;::MapHashPolicy; AllocPolicy = js::SystemAllocPolicy; uint32_t = unsigned int]::&lt;lambda(const Slot&amp;)&gt;; T = mozilla::HashMapEntry&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt; &gt;; HashPolicy = mozilla::HashMap&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt;, mozilla::DefaultHasher&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt; &gt;, js::SystemAllocPolicy&gt;::MapHashPolicy; AllocPolicy = js::SystemAllocPolicy; uint32_t = unsigned int]
    mozilla::detail::HashTable&lt;T, HashPolicy, AllocPolicy&gt;::destroyTable(AllocPolicy&amp;, char*, uint32_t) [with T = mozilla::HashMapEntry&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt; &gt;; HashPolicy = mozilla::HashMap&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt;, mozilla::DefaultHasher&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt; &gt;, js::SystemAllocPolicy&gt;::MapHashPolicy; AllocPolicy = js::SystemAllocPolicy; uint32_t = unsigned int]::&lt;lambda(const Slot&amp;)&gt;
    void mozilla::detail::HashTableEntry&lt;T&gt;::destroyStoredT() [with T = mozilla::HashMapEntry&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt; &gt;]
    mozilla::HashMapEntry&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt; &gt;::~HashMapEntry() [[complete_dtor]]
    mozilla::HashMapEntry&lt;js::frontend::TypedIndex&lt;js::frontend::ScriptStencil&gt;, RefPtr&lt;const JS::WasmModule&gt; &gt;::~HashMapEntry() [[base_dtor]]
    RefPtr&lt;T&gt;::~RefPtr() [with T = const JS::WasmModule]
    RefPtr&lt;T&gt;::~RefPtr() [with T = const JS::WasmModule] [[base_dtor]]
    static void RefPtr&lt;T&gt;::ConstRemovingRefPtrTraits&lt;const U&gt;::Release(const U*) [with U = JS::WasmModule; T = const JS::WasmModule]
    static void mozilla::RefPtrTraits&lt;U&gt;::Release(U*) [with U = JS::WasmModule]
    void js::AtomicRefCounted&lt;T&gt;::Release() const [with T = JS::WasmModule]
    Utility.h:void js_delete(JS::WasmModule*) [with T = JS::WasmModule]
    JS::WasmModule.__dt_comp 
    void js::wasm::Module::~Module()
    void js::wasm::Module::~Module() [[base_dtor]]
    RefPtr&lt;T&gt;::~RefPtr() [with T = JS::OptimizedEncodingListener] [[complete_dtor]]
    RefPtr&lt;T&gt;::~RefPtr() [with T = JS::OptimizedEncodingListener] [[base_dtor]]
    static void RefPtr&lt;T&gt;::ConstRemovingRefPtrTraits&lt;U&gt;::Release(U*) [with U = JS::OptimizedEncodingListener; T = JS::OptimizedEncodingListener]
    static void mozilla::RefPtrTraits&lt;U&gt;::Release(U*) [with U = JS::OptimizedEncodingListener]
    JS::OptimizedEncodingListener.Release
    uint32 mozilla::dom::JSStreamConsumer::Release()
    void mozilla::dom::JSStreamConsumer::~JSStreamConsumer() [[deleting_dtor]]
    void mozilla::dom::JSStreamConsumer::~JSStreamConsumer() [[complete_dtor]]
    void mozilla::dom::JSStreamConsumer::~JSStreamConsumer() [[base_dtor]]
    nsIEventTarget.Dispatch
    unresolved nsIEventTarget.Dispatch
</code></pre>
</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Sep 17 2021 14:25:28 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell"><code>JSStreamConsumer</code> has my  new changes -- looking for help and info, again</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Sep 17 2021 14:48:42 GMT-0700 (Pacific Daylight Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-9">nicolo-ribaudo</span>: IIUC, this is the code that we have to call to check whether an object is a record:</p>
<pre><code> static inline bool isRecord(const Value&amp; v) {
    return v.isObject() &amp;&amp; v.toObject().is&lt;RecordObject&gt;();
  }
</code></pre>
<p>Checking whether a Value is an object is very cheap, because the tag is embedded in the Value. <code>is&lt;RecordObject&gt;()</code> has to look at the object's class pointer, which means we have to dereference the object pointer to get the shape, and dereference the shape pointer to get the class. I am a little bit concerned about requiring two additional memory loads every time we compare objects.</p>
</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Sep 17 2021 14:49:46 GMT-0700 (Pacific Daylight Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: the above hazard is rather unpleasant. Basically, <code>Rooted&lt;CompilationInput&gt;</code> is freaking out because <code>CompilationInput</code> has a <code>RefPtr&lt;ScriptSource&gt;</code>. If you happened to make a rooted input, then dropped the other last reference within its scope, you could end up deleting the <code>ScriptSource</code> and that does lots of scary stuff.</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Sep 17 2021 14:50:21 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Record/Tuple as a new primitive type has downsides, but it does avoid this problem.)</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Sep 17 2021 14:50:29 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I guess I'm surprised that dropping a WasmModule calls arbitrary dispatch code</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Sep 17 2021 14:52:30 GMT-0700 (Pacific Daylight Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm. It's claiming <code>~Module</code> could decrement <code>RefPtr&lt;OptimizedEncodingListener&gt;</code>. Is that true?</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Sep 17 2021 14:53:51 GMT-0700 (Pacific Daylight Time)">21:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">er, I guess it's specifically claiming that to be true in that patch stack</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Sep 17 2021 14:54:03 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(which might be why my searchfox queries aren't turning up anything)</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Sep 17 2021 14:55:18 GMT-0700 (Pacific Daylight Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">relevant change is at <a href="https://hg.mozilla.org/integration/autoland/rev/5b7fe5d564aa5432e31228e79de103139e351bf5">https://hg.mozilla.org/integration/autoland/rev/5b7fe5d564aa5432e31228e79de103139e351bf5</a></td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Sep 17 2021 14:56:46 GMT-0700 (Pacific Daylight Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah, JSStreamConsumer inherits from OptimizedEncodingListener</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Sep 17 2021 14:58:48 GMT-0700 (Pacific Daylight Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">...why does the hg.m.o diff page break Ctrl-F (find in page)?...</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Sep 17 2021 14:59:07 GMT-0700 (Pacific Daylight Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah, it doesn't</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Sep 17 2021 14:59:16 GMT-0700 (Pacific Daylight Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">somehow "Whole Words" got turned on. Bizarro.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Sep 17 2021 15:02:51 GMT-0700 (Pacific Daylight Time)">22:02</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-14" title="@yury:mozilla.org">yury</span></div></td><td class="msg-cell">curios what (change) happened to get this hazzard</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Sep 17 2021 15:03:45 GMT-0700 (Pacific Daylight Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: I believe it's because ~JSStreamConsumer explicitly dispatches a runnable, which is rather terrifying</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Sep 17 2021 15:03:54 GMT-0700 (Pacific Daylight Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">can this be deferred?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Sep 17 2021 15:04:51 GMT-0700 (Pacific Daylight Time)">22:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(I recall there's some mechanism for deferring things like this; I'm searching to try to find it)</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Sep 17 2021 15:05:22 GMT-0700 (Pacific Daylight Time)">22:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess I'm thinking of DeferredFinalize</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Fri Sep 17 2021 15:06:57 GMT-0700 (Pacific Daylight Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm, but that ~JSStreamConsumer stuff is the case in existing code already. Did something add a RefPtr&lt;JSStreamConsumer&gt; to something?</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Fri Sep 17 2021 15:09:13 GMT-0700 (Pacific Daylight Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe the destructor could call <code>delayedDispatch</code> instead? (I don't really know what I'm talking about)</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Fri Sep 17 2021 15:09:46 GMT-0700 (Pacific Daylight Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">FetchUtil::StreamResponseToJS starts JSStreamConsumer::Start, which holds JSStreamConsumer</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Fri Sep 17 2021 15:12:20 GMT-0700 (Pacific Daylight Time)">22:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">as before the change, though now OptimizedEncodingListener in play</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Fri Sep 17 2021 15:14:34 GMT-0700 (Pacific Daylight Time)">22:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it looks like asyncStream holds that reference</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Fri Sep 17 2021 15:15:25 GMT-0700 (Pacific Daylight Time)">22:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm doubtful that <code>delayedDispatch</code> would help; it looks like it sometimes runs immediately</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Fri Sep 17 2021 15:31:35 GMT-0700 (Pacific Daylight Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell"><del>what's JSStreamConsumer/OptimizedEncodingListener::Release?</del></td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Fri Sep 17 2021 15:32:19 GMT-0700 (Pacific Daylight Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess the dispatch code isn't really arbitrary -- at least, I don't <em>think</em> Dispatch will execute other things in the queue first or anything. So there's probably a way of telling the analysis we really only need to care about WindowStreamOwner::Destroyer, which means RefPtr&lt;WIndowStreamOwner&gt;::~RefPtr. But that ends up calling <code>obs-&gt;RemoveObserver(this, DOM_WINDOW_DESTROYED_TOPIC);</code> and I'm guessing the analysis will find a way for that to GC too.</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Fri Sep 17 2021 15:48:05 GMT-0700 (Pacific Daylight Time)">22:48</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-14" title="@yury:mozilla.org">yury</span></div></td><td class="msg-cell">needs some reading then... till monday</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Fri Sep 17 2021 15:48:10 GMT-0700 (Pacific Daylight Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">thanks</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Fri Sep 17 2021 15:50:10 GMT-0700 (Pacific Daylight Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">yury</span>: I don't know that much about how this stuff is all supposed to work, but I put a needinfo on the bug in hopes that peterv or somebody can save us here.</td></tr>

</tbody></table></div></div></div>
</body></html>