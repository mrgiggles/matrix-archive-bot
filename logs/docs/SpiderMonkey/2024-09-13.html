<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-09-13</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-09-13<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-09-12" class="nav-link"><span>prev</span></a>
<a href="2024-09-14" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Sep 12 2024 23:58:34 GMT-0700 (Pacific Daylight Time)">06:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">Hi folks, we got <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1918506">https://bugzilla.mozilla.org/show_bug.cgi?id=1918506</a> filed, and I have no idea how to fix it. In a sentence: recursive calls in an AudioWorkletGlobalScope don't do the "too much recursion" error, they crash instead. What are we doing wrong, or not doing?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Sep 13 2024 00:32:50 GMT-0700 (Pacific Daylight Time)">07:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">padenot</span>: looks like worklets set the JS stack quota <a href="https://searchfox.org/mozilla-central/rev/ab8043ccefe85c30ef78b97193918934d6aa93d1/dom/worklet/WorkletThread.cpp#383-384">here</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Sep 13 2024 00:33:22 GMT-0700 (Pacific Daylight Time)">07:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">what's the actual stack size passed when the thread is created?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Sep 13 2024 00:33:34 GMT-0700 (Pacific Daylight Time)">07:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">let me check</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Sep 13 2024 00:34:25 GMT-0700 (Pacific Daylight Time)">07:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/__GENERATED__/dist/include/nsIThreadManager.h#83">https://searchfox.org/mozilla-central/source/__GENERATED__/dist/include/nsIThreadManager.h#83</a></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Sep 13 2024 00:34:56 GMT-0700 (Pacific Daylight Time)">07:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">we're using the default for this thread</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Sep 13 2024 00:35:34 GMT-0700 (Pacific Daylight Time)">07:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">hm did that change at some point? I thought it was higher before when we added that set-native-stack-quota call</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Sep 13 2024 00:35:56 GMT-0700 (Pacific Daylight Time)">07:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I haven't kept track, but based on those numbers I can see there's a problem</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Sep 13 2024 00:36:24 GMT-0700 (Pacific Daylight Time)">07:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah it should be much higher. I suggest using the same stack size we use for JS worker threads</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Sep 13 2024 00:36:35 GMT-0700 (Pacific Daylight Time)">07:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">yeah for sure, thanks a lot for the quick answer!</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Sep 13 2024 10:01:34 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Sorry, I meant to follow up on this: <span class="nick-4">jonco</span> / <span class="nick-10">jandem</span> -- How is the lifetime of a zone related to the lifetime of a runtime, and the navigation of a tab?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Sep 13 2024 10:15:10 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">The runtime lives longer than a zone. I'm not sure exactly what a zone corresponds to in the browser. </td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Sep 13 2024 10:16:12 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I think a zone is a "web page" or at least the same site parts of it. Or all of Chrome JS is a zone, maybe.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Sep 13 2024 10:16:16 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Cool :) I have a research project then :P </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Sep 13 2024 10:17:01 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">IIRC Jan is the one who changed how zones work most recently, as part of his effort to get rid of CCWs on gdocs.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Sep 13 2024 10:17:03 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: One other Q: Do we do a full trace only for a major GC, or do we end up calling all the tracing functions even on minor GC? (my ental odel says no, but wanted to touch in too)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Sep 13 2024 10:17:43 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">minor vs major is about nursery vs heap. There's also zonal vs full GC. I think is the nomenclature.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Sep 13 2024 10:18:24 GMT-0700 (Pacific Daylight Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Kinda less relevant in the Fission world, but very important before that.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Sep 13 2024 10:19:48 GMT-0700 (Pacific Daylight Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">yeah we only do a full trace for major GC</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Sep 13 2024 10:20:17 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">minor GC relies on store buffer buffer entries, except for the stack which is traced</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Sep 13 2024 10:20:38 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><p>(to stop asking XY questions: Thinking about <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1894940">https://bugzilla.mozilla.org/show_bug.cgi?id=1894940</a>, I wonder if whenever we walk the stack we ought to mark a bit on jit code to say it's been used recently. Then, the heuristic would be</p>
<ol>
<li>So long as we're not compacting (because it asserts we are preserving no jit code) only toss jit code that has not been marked)</li>
<li>On a heursitically determined full GC, clear all the "touched" bits</li>
</ol>
</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Sep 13 2024 10:21:32 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">The idea is that over the course of a number of stack walks, we largely will populate the set of 'active' jit codes, which allows us to relatively cleanly separate the set of jit code we want gone from the set we want to preserve) </td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Sep 13 2024 10:21:59 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">If we tweak FrameIter, we'd also <del>capture</del> set bits at points like error stack captures, etc</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Sep 13 2024 10:24:24 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">the drawback is that GC is relatively infrequent so you may not mark all your active code</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Sep 13 2024 10:25:16 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">another way of saying that is that it's very biased against code that does not cause GC</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Sep 13 2024 10:25:19 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">100% (hence me verifying minor GC doesn't help here) </td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Sep 13 2024 10:25:46 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">But if we're not running code that's causing GC then we should just be keeping it in general shouldn't we?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Sep 13 2024 10:26:16 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Like we need to have enough allocation pressure to want to toss JIT code... or are there other reasons we want to toss all jit code I'm not thinking of?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Sep 13 2024 10:28:08 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">(Bear with me -- I've been rolling this problem around in my head for less than an hour so far :P ) </td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Sep 13 2024 10:30:44 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I mean that looking at what's on the stack when we GC is going to bias you to code that allocates; code that doesn't allocate may not be seen on the stack no matter how hot it is</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Sep 13 2024 10:33:24 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Oh that's true. Ok. 

it seems like maybe we don't need a trampoline? Like, can't we just set a bit on the IonScript/JitScript as part of the generated code prologue, then similarly unset the bits on a regular basis to describe the set of invoked code? 

I think we could bake all the addresses in so it would be ~1 store per call. I suppose that could be impactful on hot hot hot code... but I don't get the impression we'd notice this in general</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Sep 13 2024 10:34:57 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">yes it sounds like that would work - I don't know enough to say what the performance impact would be</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Sep 13 2024 10:36:41 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">I can probably prototype that part not too slowly; I see the big "preservingJitCode" switch on GC -- we'd have to add another mechanism to make sure JitCode is incrementally cleaned up too right? </td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Sep 13 2024 10:41:41 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I guess preservingJitCode would get set in a more restricted set of circumstances and we'd rely on this usage instead if it was not</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Sep 13 2024 10:45:04 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Ok. I'll see what I can do :) </td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Sep 13 2024 12:00:34 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Generally we have three main zones in a process: System, Content, Atoms. Certain navigations will create little orphan zones that are not interesting (eg start a tab at about:blank before navigating to a real site will make an about:blank zone that is different than the content zone)</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Sep 13 2024 12:02:07 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">oh no, don't bring up about:blank. 😄</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Sep 13 2024 12:02:59 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Generally we have three main zones in a process: System, Content, Atoms. Certain navigations will create little orphan zones that are not interesting (eg start a tab at about:blank before navigating to a real site will make an about:blank zone that is different than the content zone)</blockquote></mx-reply>If windows from multiple tabs are in a single process, do they all get put in the same Content zone?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Sep 13 2024 12:05:29 GMT-0700 (Pacific Daylight Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Good point, different tabs in same process get different zones. I guess it is each "top level" (which I don't know the precise definiton of)
</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Sep 13 2024 12:06:05 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Workers get zones too by their different runtime (as stated above somewhere)</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Sep 13 2024 12:07:31 GMT-0700 (Pacific Daylight Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yeah.. I don't have a simple intuitive explaination for when they happen, but generally seems to happen in very reasonable cases</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Sep 13 2024 12:08:29 GMT-0700 (Pacific Daylight Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">This seems to be the primary logic
<a href="https://searchfox.org/mozilla-central/rev/ab8043ccefe85c30ef78b97193918934d6aa93d1/dom/base/nsGlobalWindowOuter.cpp#1968-2008">https://searchfox.org/mozilla-central/rev/ab8043ccefe85c30ef78b97193918934d6aa93d1/dom/base/nsGlobalWindowOuter.cpp#1968-2008</a></td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Sep 13 2024 12:08:56 GMT-0700 (Pacific Daylight Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Ah, nice! It is that simple.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Sep 13 2024 12:10:24 GMT-0700 (Pacific Daylight Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Each content tab gets a zone per unique site in its iframe-nesting-horror-show</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Sep 13 2024 12:11:27 GMT-0700 (Pacific Daylight Time)">19:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">In addition to same tab, maybe things with an opener relationship get put in the same zone if they are same site? I'm not sure how exactly that goes.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Sep 13 2024 12:14:10 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Is BC::mParentWindow set in an opener relationship? I'm not quite clear on how that field is defined</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Sep 13 2024 12:14:54 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I'm not sure.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Sep 13 2024 12:17:41 GMT-0700 (Pacific Daylight Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Looks like new tabs still get different zones even in opener relationship</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Sep 13 2024 12:18:05 GMT-0700 (Pacific Daylight Time)">19:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Ah, cool.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Sep 13 2024 12:18:23 GMT-0700 (Pacific Daylight Time)">19:18</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span></div></td><td class="msg-cell">feels like he slept through some Fission lectures over the years...</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Sep 13 2024 12:18:50 GMT-0700 (Pacific Daylight Time)">19:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I guess they have to be same process, but are likely to have different lifetimes so we want them in separate zones?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Sep 13 2024 12:19:14 GMT-0700 (Pacific Daylight Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">and I guess navigate differently too which seems to be a common motivation</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Sep 13 2024 12:21:30 GMT-0700 (Pacific Daylight Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Lemme tell you: Googling opener relationship -does not help you- here :P </td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Sep 13 2024 12:21:46 GMT-0700 (Pacific Daylight Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">This is <code><a href="http://window.open">window.open</a></code> right?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Sep 13 2024 12:22:02 GMT-0700 (Pacific Daylight Time)">19:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">and how same-origin windows can communicate</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Sep 13 2024 12:23:50 GMT-0700 (Pacific Daylight Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">One of the comments on that SelectZone function implies navigations get different zones too... which makes sense to me at least </td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Sep 13 2024 12:31:57 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">hey, there's just one open question on the embedders migration guide for esr128, that I could use some help with: <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/85/files#r1694013596">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/pull/85/files#r1694013596</a><br>is it intentional that <code>GCPolicy&lt;Heap&lt;T&gt;&gt;</code> now doesn't implement <code>needsSweep</code> or is that an oversight that I should send a patch for?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Sep 13 2024 12:48:12 GMT-0700 (Pacific Daylight Time)">19:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>:  ^</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Sep 13 2024 13:00:12 GMT-0700 (Pacific Daylight Time)">20:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Speaking of docs: <a href="https://firefox-source-docs.mozilla.org/dom/scriptSecurity/index.html">https://firefox-source-docs.mozilla.org/dom/scriptSecurity/index.html</a> needs updating because transparent wrappers are no longer a thing I think</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Sep 13 2024 13:20:33 GMT-0700 (Pacific Daylight Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Hm. This is confusing. We mostly switched over from <code>needsSweep</code> -&gt; <code>traceWeak</code>, but <code>needsSweep</code> was left in place for maps and sets, except that the current implementation of <code>WeakCache&lt;Map|Set&gt;</code> looks to me like it uses <code>traceWeak</code>. I think I may have to delete a bunch of <code>needsSweep</code> declarations and see what breaks.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Sep 13 2024 13:38:21 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Speaking of docs: <a href="https://firefox-source-docs.mozilla.org/dom/scriptSecurity/index.html">https://firefox-source-docs.mozilla.org/dom/scriptSecurity/index.html</a> needs updating because transparent wrappers are no longer a thing I think</blockquote></mx-reply>I don't see many uses of that term, but I think they are just plain CCWs. <a href="https://searchfox.org/mozilla-central/rev/181e5bb2645236a617d42e3740420098097f7a0f/js/xpconnect/wrappers/WrapperFactory.cpp#423">https://searchfox.org/mozilla-central/rev/181e5bb2645236a617d42e3740420098097f7a0f/js/xpconnect/wrappers/WrapperFactory.cpp#423</a><br>This would come up in that same-origin window-opener case we talked about earlier where there are different zones and so different compartmnets</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Sep 13 2024 13:38:33 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span></div></td><td class="msg-cell">is only 70% confident in that..</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Sep 13 2024 13:57:33 GMT-0700 (Pacific Daylight Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Would it be ok to return a <code>std::shared_ptr&lt;JS::PersistentRootedObject&gt;</code>?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Sep 13 2024 13:58:46 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I don't see a lot of mention of smart pointers for JS types</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Sep 13 2024 13:58:59 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><code>WeakCache&lt;GCHashMap&lt;..., Heap&lt;T&gt;&gt;&gt;</code> is definitely broken in esr128</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Sep 13 2024 14:01:28 GMT-0700 (Pacific Daylight Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">so the use case would be to hold on to a JSObject from C++, but when no owners of the shared_ptr are left, go back to behaving like a normal JSObject, collected when it's not reachable from JS?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Sep 13 2024 14:02:40 GMT-0700 (Pacific Daylight Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">it's meant to hold the Global and it's mostly C++ interacting with it</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Sep 13 2024 14:11:34 GMT-0700 (Pacific Daylight Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">we don't use the standard library's smart pointers.  there are similar things in <a href="https://searchfox.org/mozilla-central/source/mfbt">https://searchfox.org/mozilla-central/source/mfbt</a> , such as <a href="https://searchfox.org/mozilla-central/rev/181e5bb2645236a617d42e3740420098097f7a0f/mfbt/UniquePtr.h#190">mozilla::UniquePtr</a> and <a href="https://searchfox.org/mozilla-central/rev/181e5bb2645236a617d42e3740420098097f7a0f/mfbt/RefPtr.h#55">RefPtr</a>, and there are some examples that holds <code>PersistentRooted</code> field in a struct and using it with RefPtr</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Sep 13 2024 14:12:51 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">e.g. <a href="https://searchfox.org/mozilla-central/rev/181e5bb2645236a617d42e3740420098097f7a0f/dom/streams/ReadableStreamTee.cpp#77">mozilla::dom::ReadableStreamDefaultTeeReadRequest::ChunkSteps::ReadableStreamDefaultTeeReadRequestChunkSteps::mChunk</a> field is <code>PersistentRooted</code>, where the struct is used with RefPtr (<a href="https://searchfox.org/mozilla-central/search?q=symbol:T_ReadableStreamDefaultTeeReadRequestChunkSteps&amp;redirect=false">https://searchfox.org/mozilla-central/search?q=symbol:T_ReadableStreamDefaultTeeReadRequestChunkSteps&amp;redirect=false</a>)</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Sep 13 2024 15:52:39 GMT-0700 (Pacific Daylight Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>JS::WeakCache&lt;GCHashMap&lt;JS::Heap&lt;Value&gt;, JS::Heap&lt;JSObject*&gt;&gt;&gt;</code> compiles on central. I'll try esr128.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Sep 13 2024 15:56:14 GMT-0700 (Pacific Daylight Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I would guess that <code>shared_ptr&lt;PersistentRooted&gt;</code> would work fine. <code>shared_ptr&lt;Rooted&gt;</code> would not. (But yeah, you won't find examples in the firefox code because as arai says we mostly don't use the standard library containers.)</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Sep 13 2024 15:56:38 GMT-0700 (Pacific Daylight Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">er, wait, it compiled there too. Maybe I need to do something with it?</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Sep 13 2024 15:57:46 GMT-0700 (Pacific Daylight Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or is there an internal header that provides something needed? I guess I should try it with mozjs.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Sep 13 2024 16:04:40 GMT-0700 (Pacific Daylight Time)">23:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">well, it works with my mozjs-115. Which proves nothing, it's just what I had lying around. On to mozjs-128...</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Sep 13 2024 16:24:09 GMT-0700 (Pacific Daylight Time)">23:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><p>Ok, me no unnerstand. It still seems to be compiling with esr128. My test is:</p>
<pre><code>diff --git a/examples/tracing.cpp b/examples/tracing.cpp
--- a/examples/tracing.cpp
+++ b/examples/tracing.cpp
@@ -1,7 +1,9 @@
 #include &lt;memory&gt;
 #include &lt;vector&gt;
 
+#include &lt;js/GCHashTable.h&gt;
 #include &lt;js/Object.h&gt;
+#include &lt;js/SweepingAPI.h&gt;
 #include &lt;jsapi.h&gt;
 
 #include "boilerplate.h"
@@ -50,6 +52,9 @@
   // rooting bare non-GC pointers then both JS::MapTypeToRootKind and
   // JS::GCPolicy need to be defined for SafeBox*. This should be avoided in
   // favor of using a smart-pointer when possible.
+  JS::WeakCache&lt;JS::GCHashMap&lt;JS::Heap&lt;JS::Value&gt;, JS::Heap&lt;JSObject*&gt;&gt;&gt; cache(
+      JS_GetRuntime(cx), cx);
+  
 
   return true;
 }
</code></pre>
</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Sep 13 2024 16:38:41 GMT-0700 (Pacific Daylight Time)">23:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">huh! what about <code>JS::WeakCache&lt;JS::GCHashMap&lt;void*, JS::Heap&lt;JSObject*&gt;, js::DefaultHasher&lt;void*&gt;, js::SystemAllocPolicy&gt;</code>? that is specifically what broke in GJS when we migrated to esr128</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Sep 13 2024 16:40:51 GMT-0700 (Pacific Daylight Time)">23:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">also, try calling <code>lookup()</code> on the hash table? the compile error happens when instantiating the templated <code>lookup()</code> method</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Sep 13 2024 16:52:56 GMT-0700 (Pacific Daylight Time)">23:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, I'm getting an error now when I call <code>put</code>, though the error is on not having a specialization of <code>mozilla::DefaultHasher</code> for <code>Heap</code>.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Sep 13 2024 16:53:49 GMT-0700 (Pacific Daylight Time)">23:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">I guess we didn't need that because the <code>Heap</code> was the value, not the key</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Sep 13 2024 16:54:10 GMT-0700 (Pacific Daylight Time)">23:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess Gecko doesn't use <code>JS::Heap</code> in hash-based containers anywhere. SpiderMonkey always uses <code>HeapPtr</code> instead.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Sep 13 2024 16:54:53 GMT-0700 (Pacific Daylight Time)">23:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but I'll switch to getting the one you need to work first.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Sep 13 2024 16:54:54 GMT-0700 (Pacific Daylight Time)">23:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">I guess that explains why it didn't get migrated to <code>needsSweep</code></td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Sep 13 2024 16:59:45 GMT-0700 (Pacific Daylight Time)">23:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">do you have a <code>GCPolicy&lt;void*&gt;</code> specialization? That's where it barfs for me.</td></tr>

</tbody></table></div></div></div>
</body></html>