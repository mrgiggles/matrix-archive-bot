<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-10-19</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-10-19<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-10-18" class="nav-link"><span>prev</span></a>
<a href="2022-10-20" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Oct 18 2022 17:00:16 GMT-0700 (Pacific Daylight Time)">00:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Looks like there's work on standardizing <code>wait_for_any</code>: <a href="https://www.boost.org/doc/libs/1_64_0/doc/html/thread/synchronization.html#thread.synchronization.futures.reference.wait_for_any">https://www.boost.org/doc/libs/1_64_0/doc/html/thread/synchronization.html#thread.synchronization.futures.reference.wait_for_any</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Oct 18 2022 17:00:20 GMT-0700 (Pacific Daylight Time)">00:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">if the interface designed to be used with a particular event loop, I'd say use that event loop. but if it's generic, i.e. you still have to bring your own event loop in C++, then you might have to expose a JS binding for a function(s) that lets you supply that event loop</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Oct 18 2022 17:01:25 GMT-0700 (Pacific Daylight Time)">00:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://en.cppreference.com/w/cpp/experimental/when_any">when_any</a> also looks relevant</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Oct 18 2022 17:01:53 GMT-0700 (Pacific Daylight Time)">00:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">unfortunately, I'm limited to c++ 14 -_-</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Oct 18 2022 17:02:32 GMT-0700 (Pacific Daylight Time)">00:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">well, this will all be doable somehow. Whatever you're integrating with will necessarily have figured out the hard parts of doing this, since it's necessary even if you're only using C++.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Oct 18 2022 17:03:00 GMT-0700 (Pacific Daylight Time)">00:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but it's definitely not as straightforward as running some synchronous code!</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Oct 18 2022 17:04:39 GMT-0700 (Pacific Daylight Time)">00:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you may want to decide whether you really need the capability of waiting for some amount of time from within JS. If you drop that, you might be able to say that any JS stuff will run to completion, which could <em>include draining the job queue</em>. Then from C++'s perspective, all JS stuff is synchronous.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Oct 18 2022 17:05:51 GMT-0700 (Pacific Daylight Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(and then your current implementation of <code>ReturnStringInMilliseconds</code> is fine, it just means the JS thread won't do anything while it's waiting.)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Oct 18 2022 17:06:22 GMT-0700 (Pacific Daylight Time)">00:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">it's a lot to conisder.  Thanks again</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Oct 18 2022 17:06:48 GMT-0700 (Pacific Daylight Time)">00:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I'm going to log off for now.  Bye</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Oct 18 2022 19:33:43 GMT-0700 (Pacific Daylight Time)">02:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><p>For me, I'm using the tokio runtime for rust futures (it's agnostic, but that's not relevant), but basically the way it works is:</p>
<ol>
<li>Run futures that are ready, then yield</li>
<li>Run microtask (promise) queue to completion</li>
<li>Run macrotasks that are complete (yes, I know that's different from the whatwg spec)</li>
</ol>
</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Oct 19 2022 07:11:14 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">what does .sys stands for in *.sys.mjs files?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Oct 19 2022 07:20:59 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"system", to clarify it's not for web content but browser internal</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Oct 19 2022 07:27:10 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">but we don't have such naming convention for random .js files</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Oct 19 2022 07:32:40 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">one reasons to use special extension is that, ".jsm" extension has been helping clarifying it's not regular JS but special thing (purpose, environment, etc), both for developers and linter. and we wanted the same for system ESMs.  <code>.mjs</code> has been used also for non-system ones and just <code>.mjs</code> wasn't sufficient</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Oct 19 2022 08:03:22 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I think this was also related to special lint rules we need for esms run on the system, for example dynamic import is currently disallowed</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Oct 19 2022 08:03:26 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">discussion happened in <a href="https://docs.google.com/document/d/1U4-38pElj7FTbm5Rj098XdFCzTixBmUiESlEVO1toRo/edit#heading=h.j95o5dbw9adv">https://docs.google.com/document/d/1U4-38pElj7FTbm5Rj098XdFCzTixBmUiESlEVO1toRo/edit#heading=h.j95o5dbw9adv</a></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Oct 19 2022 09:55:02 GMT-0700 (Pacific Daylight Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: Your name came up in a discussion about the job queue yesterday.  I'm currently having an issue where I get a segmentation fault if I add Promise objects to the queue and call RunJobs.  Do you know why this might be?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Oct 19 2022 09:57:39 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Specifically, I'm wondering if there's anything beyond calling UseInternalJobQueues that I have to do to properly set up the job queue</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Oct 19 2022 09:58:12 GMT-0700 (Pacific Daylight Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: do you have backtrace of the crash?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Oct 19 2022 09:58:39 GMT-0700 (Pacific Daylight Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, if you're not using debug build of the library, I'd suggest using debug build.  that will add many runtime assertions and some of them might catch the issue</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Oct 19 2022 09:58:44 GMT-0700 (Pacific Daylight Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">kfjvj</span>: do you have backtrace of the crash?</blockquote></mx-reply>Not at the moment, and that might be complicated to get.  Mostly, I'm just looking to make sure that I used the API correctly.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Oct 19 2022 09:59:35 GMT-0700 (Pacific Daylight Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what API and how do you use them?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Oct 19 2022 10:00:19 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">If I call UseInternalJobQueues, and it succeeds, is that enough to ensure that the job queue is properly set up for use?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Oct 19 2022 10:00:47 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, the queue is ready</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Oct 19 2022 10:01:01 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, what do you mean by "add Promise objects to the queue" ?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Oct 19 2022 10:01:23 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the queue is for job, not Promise object</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Oct 19 2022 10:02:32 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">When I call EnqueueJob, the JS::HandleObject I pass in is something I created with JS::NewPromiseObject</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Oct 19 2022 10:02:39 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, what is a "job" in this context?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Oct 19 2022 10:02:58 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">a function that corresponds to a promise reaction</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Oct 19 2022 10:03:27 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">usually, you don't have to enqueue job manually</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Oct 19 2022 10:03:47 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the job is internally created for each Promise handling, and queued there</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Oct 19 2022 10:04:12 GMT-0700 (Pacific Daylight Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if you use internal queue, what you need to do is just call <code>js::RunJobs</code></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Oct 19 2022 10:04:58 GMT-0700 (Pacific Daylight Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Is it possible that calling runJobs will result in other jobs being enqueued, and then I'd have to run again?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Oct 19 2022 10:05:58 GMT-0700 (Pacific Daylight Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>RunJobs</code> runs all jobs until the queue gets empty</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Oct 19 2022 10:06:38 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, tgood to know</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Oct 19 2022 10:06:46 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, calling it once after running the target code should be sufficient</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Oct 19 2022 10:06:55 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I'll try it.  THanks</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Oct 19 2022 10:08:47 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>js::EnqueueJob</code> is only for testing the engine internal</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Oct 19 2022 10:09:01 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Well that's very good to know</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Oct 19 2022 10:20:40 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: I got distracted yesterday, but I suspect that part of your problem is that <code>RunJobs</code> runs promise tasks that have resolved, but you want to wait for an unresolved promise</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Oct 19 2022 10:20:52 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">kfjvj</span>: I got distracted yesterday, but I suspect that part of your problem is that <code>RunJobs</code> runs promise tasks that have resolved, but you want to wait for an unresolved promise</blockquote></mx-reply>That is correct</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Oct 19 2022 10:22:10 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In general, it's totally valid to create promises that will never resolve, so the engine can't block waiting for unresolved promises</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Oct 19 2022 10:22:53 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So if you need to wait for a particular promise, you need to do something special with it</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Oct 19 2022 10:23:16 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It sounds like <code>EnqueueJob</code> is not that special thing</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Oct 19 2022 10:23:38 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, sorry for the misinformation</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Oct 19 2022 10:23:52 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It seemed very plausible to me too!</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Oct 19 2022 10:24:18 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Oh, OK, yes.  If I delay enough time for the promise to complete, I can confirm that RunJobs <em>does</em> in fact work properly</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Oct 19 2022 10:24:36 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, the picture is becoming much more clear now.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Oct 19 2022 10:26:05 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I haven't looked at the code enough to verify, but I suspect that your segfaults were because RunJobs expects the enqueued promises to already be resolved, and you were enqueueing pending promises</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Oct 19 2022 10:26:54 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, so I need to implement my own system to keep track of unresolved promises and call RunJobs when they're ready</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Oct 19 2022 10:27:40 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, something like that sounds right</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Oct 19 2022 10:27:47 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it expects the enqueued things to be a function, not a promise object</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Oct 19 2022 10:28:03 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">and it only gets enqueued when the promise is resolved</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Oct 19 2022 10:28:15 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Oct 19 2022 10:28:48 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, that really helps.  Thanks so much.  I think I can solve this problem now.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Oct 19 2022 10:30:28 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I guess, you don't have to track unresolved promises.  you need to call <code>RunJobs</code> after 1. run JS code, or 2. you resolve promise from C++ code</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Oct 19 2022 10:30:48 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, I hadn't actually noticed until now that the InternalJobQueue implementation of <code>enqueuePromiseJob</code> completely ignores the <code>promise</code> argument</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Oct 19 2022 10:31:11 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I guess, you don't have to track unresolved promises.  you need to call <code>RunJobs</code> after 1. run JS code, or 2. you resolve promise from C++ code</blockquote></mx-reply>Yes, I was referring to tracking the unresolved promises from the C++ side.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Oct 19 2022 10:31:47 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if your promise is resolved by JS code, always calling <code>RunJobs</code> after running any JS code should be sufficient</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Oct 19 2022 10:32:15 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if your promise is resolved by C++ code, you need to call <code>RunJobs</code> at some point after that</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Oct 19 2022 10:32:25 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> if your promise is resolved by C++ code, you need to call <code>RunJobs</code> at some point after that</blockquote></mx-reply>That is exactly what I'm doing.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Oct 19 2022 10:33:12 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: While you're here: do you know anything about top-level await in the shell?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Oct 19 2022 10:33:25 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p>I have this testcase:</p>
<pre><code>let p = new Promise((resolve, reject) =&gt; { /* This promise is never resolved. */});

async function foo() {
  let a = await p;
  print("continued");
}

await foo();
</code></pre>
</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Oct 19 2022 10:34:23 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">devtools transforms it into a async IIFE</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Oct 19 2022 10:34:24 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In theory it seems like it should hang. In d8 (v8's shell) it prints "Error: Top-level await promise never resolved"</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Oct 19 2022 10:35:03 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But if I run it in the shell, we just create the promise, shrug, and terminate</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Oct 19 2022 10:39:17 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">let me check</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Oct 19 2022 10:41:02 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">This is a problem for some waitAsync tests that do an await in a worker thread. I had them working at a point where the existence of a live waitAsync promise prevented the runtime from shutting down, but when I added code to make those OffthreadPromiseTasks cancellable, the tests started failing because the worker terminated before we had a chance to notify it and resolve the promise.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Oct 19 2022 10:41:32 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It seems like at least top-level await should block worker shutdown?</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Oct 19 2022 10:41:53 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">how do you evaluate the code?</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Oct 19 2022 10:42:13 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">in <code>-m</code> option, I guess, we just throw away the root module's promise capability?</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Oct 19 2022 10:42:32 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, I'm using <code>./mach run -m module1.js</code></td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Oct 19 2022 10:43:01 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there seems to be no code that blocks on the module's promise</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Oct 19 2022 10:43:18 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, I couldn't find any either</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Oct 19 2022 10:43:47 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Do you think it would be reasonable to add code to do that?</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Oct 19 2022 10:44:36 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">maybe I'm missing something.  are you going to add it for <code>-m</code> option?</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Oct 19 2022 10:44:55 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or something related to worker thread?</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Oct 19 2022 10:45:29 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is the <code>waitAsync</code> test available somewhere?</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Oct 19 2022 10:45:54 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/tests/test262/built-ins/Atomics/waitAsync/nan-for-timeout-agent.js">https://searchfox.org/mozilla-central/source/js/src/tests/test262/built-ins/Atomics/waitAsync/nan-for-timeout-agent.js</a></td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Oct 19 2022 10:46:17 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Specifically line 31</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Oct 19 2022 10:46:53 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think we need it for workers, and I'm not sure if it would be good for modules or not</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Oct 19 2022 10:47:24 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, for worker case, it's not about module, right?</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Oct 19 2022 10:47:39 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's just async function?</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Oct 19 2022 10:48:13 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think so</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Oct 19 2022 10:49:19 GMT-0700 (Pacific Daylight Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I believe under the covers it's using <code>evalInWorker</code></td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Wed Oct 19 2022 10:49:40 GMT-0700 (Pacific Daylight Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">hmm, I got confused</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Wed Oct 19 2022 10:49:43 GMT-0700 (Pacific Daylight Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So maybe this isn't TLA-specific</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Wed Oct 19 2022 10:50:26 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it sounds like there's already some code that blocks on pending promise?</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Wed Oct 19 2022 10:51:14 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Where?</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Wed Oct 19 2022 10:51:33 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"the existence of a live waitAsync promise prevented the runtime from shutting down"</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Wed Oct 19 2022 10:51:51 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, sorry, poorly worded</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Wed Oct 19 2022 10:51:58 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It's the existence of an OffThreadPromiseTask</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Wed Oct 19 2022 10:52:31 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/vm/OffThreadPromiseRuntimeState.cpp#211-215">https://searchfox.org/mozilla-central/source/js/src/vm/OffThreadPromiseRuntimeState.cpp#211-215</a></td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Wed Oct 19 2022 10:53:25 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I haven't touched <code>OffThreadPromiseTask</code></td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Wed Oct 19 2022 10:54:08 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe wrong. the blame says I reviewed :P</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Wed Oct 19 2022 10:54:13 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">:P</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Wed Oct 19 2022 10:54:35 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't think it's important here</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Wed Oct 19 2022 10:55:11 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I changed it so that we can create OffThreadPromiseTasks that will be deleted when we start shutting down the runtime, instead of waiting for them to be resolved</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Wed Oct 19 2022 10:55:29 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And that exposed the problem with not blocking on the worker's promise</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Wed Oct 19 2022 10:59:03 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think what we want is for <code>evalInWorker</code> to block if it actually awaits something</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Wed Oct 19 2022 10:59:12 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But I don't know where/how to do that</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Wed Oct 19 2022 11:03:13 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Maybe here? <a href="https://searchfox.org/mozilla-central/source/js/src/shell/js.cpp#4148-4149">https://searchfox.org/mozilla-central/source/js/src/shell/js.cpp#4148-4149</a></td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Wed Oct 19 2022 11:03:30 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I need to figure out how the OffThreadPromiseTask and this code is related, before thinking about whether "block on awaiting" is reasonable or not</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Wed Oct 19 2022 11:04:05 GMT-0700 (Pacific Daylight Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">at least, just "block the worker if there's pending promise" doesn't sound right</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Wed Oct 19 2022 11:06:45 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">OffThreadPromiseTask is currently only used for some wasm stuff that we can be confident will eventually resolve</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Wed Oct 19 2022 11:08:19 GMT-0700 (Pacific Daylight Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So in the internal job queue, we just always wait</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Wed Oct 19 2022 11:09:12 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and that's unrelated to worker, right?</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Wed Oct 19 2022 11:09:54 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and also to <code>waitAsync</code> testcase</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Wed Oct 19 2022 11:15:18 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, maybe I misunderstood</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Wed Oct 19 2022 11:15:46 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you're using <code>OffThreadPromiseTask</code> in your patch?</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Wed Oct 19 2022 11:17:22 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yes</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Wed Oct 19 2022 11:17:24 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@arai:mozilla.org">arai</span></div></td><td class="msg-cell">looks into bug 1467846 patches</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Wed Oct 19 2022 11:17:50 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, the patches currently up are Caroline's old WIP patches</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Wed Oct 19 2022 11:17:54 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I've rewritten almost all of them</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Wed Oct 19 2022 11:18:00 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Wed Oct 19 2022 11:18:31 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Give me a minute to push a WIP to phabricator</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Wed Oct 19 2022 11:21:00 GMT-0700 (Pacific Daylight Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think, "whether you're awaiting or not on the <code>waitAsync</code> promise" cannot be used as the condition whether to block the worker.  <code>await</code> just adds promise reaction, and that's not something worker itself is aware of</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Wed Oct 19 2022 11:22:11 GMT-0700 (Pacific Daylight Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://phabricator.services.mozilla.com/D159745">https://phabricator.services.mozilla.com/D159745</a></td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Wed Oct 19 2022 11:22:27 GMT-0700 (Pacific Daylight Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"whether there's a <code>OffThreadPromiseTask</code> created by <code>waitAsync</code> or not" could be used, but that doesn't mean you're awaiting on it, and also it won't work if the promise never resolves (if that can happen)</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Wed Oct 19 2022 11:22:33 GMT-0700 (Pacific Daylight Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think patches 3, 4, 6, and 13 may be the most relevant</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Wed Oct 19 2022 11:23:14 GMT-0700 (Pacific Daylight Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't want this blocking to be something specific to waitAsync</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Wed Oct 19 2022 11:23:35 GMT-0700 (Pacific Daylight Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Right now <code>evalInWorker</code> doesn't actually support <code>await</code> in workers at all</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Wed Oct 19 2022 11:23:55 GMT-0700 (Pacific Daylight Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Even if you await something that's already resolved, the worker doesn't drain the job queue</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Wed Oct 19 2022 11:23:57 GMT-0700 (Pacific Daylight Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That's patch 13</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Wed Oct 19 2022 11:25:12 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I was thinking that we should block the worker if the top-level script returns an unresolved promise</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Wed Oct 19 2022 11:27:01 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if the worker script is <code>new Promise(() =&gt; {});</code>, the worker hangs?</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Wed Oct 19 2022 11:27:57 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Er, maybe "returns an unresolved promise" is wrong</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Wed Oct 19 2022 11:28:25 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I would expect the worker to hang on <code>var p = new Promise(() =&gt; {}); await p</code></td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Wed Oct 19 2022 11:28:51 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't know what that looks like after being desugared</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Wed Oct 19 2022 11:29:04 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is it module ?</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Wed Oct 19 2022 11:29:32 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">iiuc worker is regular script and it cannot have <code>await</code> there</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Wed Oct 19 2022 11:30:40 GMT-0700 (Pacific Daylight Time)">18:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Huh. Somehow it works for me?</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Wed Oct 19 2022 11:31:10 GMT-0700 (Pacific Daylight Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">can you provide testcase?</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Wed Oct 19 2022 11:31:34 GMT-0700 (Pacific Daylight Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh wait, it doesn't work</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Wed Oct 19 2022 11:32:01 GMT-0700 (Pacific Daylight Time)">18:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Maybe the test262 code is swallowing the error somewhere?</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Wed Oct 19 2022 11:35:42 GMT-0700 (Pacific Daylight Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, I guess in the test262 case, the await is inside an async arrow function: <a href="https://searchfox.org/mozilla-central/source/js/src/tests/test262/built-ins/Atomics/waitAsync/nan-for-timeout-agent.js#27,31">https://searchfox.org/mozilla-central/source/js/src/tests/test262/built-ins/Atomics/waitAsync/nan-for-timeout-agent.js#27,31</a></td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Wed Oct 19 2022 11:35:53 GMT-0700 (Pacific Daylight Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">anyway, I think, the requirement here is that, the worker needs to be alive until the other thread (can be main thread) resolves a promise, and then the worker needs to call <code>RunJobs</code> after that.  but the worker shouldn't block shutdown if the promise isn't resolved by any thread</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Wed Oct 19 2022 11:36:10 GMT-0700 (Pacific Daylight Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes, it's inside async function and worker doesn't know anything about <code>await</code> inside it</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Wed Oct 19 2022 11:36:28 GMT-0700 (Pacific Daylight Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, possible solution I can think of is to keep all workers alive until shutdown, and call <code>RunJobs</code> on all threads every time any thread finishes evaluating code</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Wed Oct 19 2022 11:36:58 GMT-0700 (Pacific Daylight Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, I think I'm starting to understand the problem here</td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Wed Oct 19 2022 11:36:59 GMT-0700 (Pacific Daylight Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or something along that line</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Wed Oct 19 2022 11:38:13 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you have an async IIFE, then it will run until it reaches the first await, and then suspend, so you don't need to have an explicit await on it at the top level</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Wed Oct 19 2022 11:39:01 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or maybe add special type of worker that waits until shutdown</td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Wed Oct 19 2022 11:39:01 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So there's no connection between the worker and the await</td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Wed Oct 19 2022 11:39:09 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Wed Oct 19 2022 11:39:42 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Blech</td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Wed Oct 19 2022 11:41:09 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or, maybe we don't support the test262 functions properly?</td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Wed Oct 19 2022 11:41:40 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">"agent.leaving" says "a function that signals that the agent is done and may be terminated" in <a href="https://github.com/tc39/test262/blob/main/INTERPRETING.md">https://github.com/tc39/test262/blob/main/INTERPRETING.md</a></td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Wed Oct 19 2022 11:42:40 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">that sounds like, otherwise it shouldn't be terminated?</td></tr>
  <tr class="msg" id="L150"><td class="ts-cell"><a class="ts" href="#L150" alt="Wed Oct 19 2022 11:42:56 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, interesting</td></tr>
  <tr class="msg" id="L151"><td class="ts-cell"><a class="ts" href="#L151" alt="Wed Oct 19 2022 11:43:09 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So maybe we should be rewriting this code? <a href="https://searchfox.org/mozilla-central/source/js/src/tests/test262-host.js#181-188">https://searchfox.org/mozilla-central/source/js/src/tests/test262-host.js#181-188</a></td></tr>
  <tr class="msg" id="L152"><td class="ts-cell"><a class="ts" href="#L152" alt="Wed Oct 19 2022 11:46:28 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, if test262 requires the agent to keep alive until the function is called, <code>start</code> needs to wrap the passed code with a code that explicitly blocks until <code>leaving</code> is called, and promise handling would be somewhere there</td></tr>
  <tr class="msg" id="L153"><td class="ts-cell"><a class="ts" href="#L153" alt="Wed Oct 19 2022 11:53:53 GMT-0700 (Pacific Daylight Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Okay, this seems doable</td></tr>
  <tr class="msg" id="L154"><td class="ts-cell"><a class="ts" href="#L154" alt="Wed Oct 19 2022 11:54:03 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Thanks! This has been very helpful</td></tr>
  <tr class="msg" id="L155"><td class="ts-cell"><a class="ts" href="#L155" alt="Wed Oct 19 2022 11:54:16 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">:)</td></tr>
  <tr class="msg" id="L156"><td class="ts-cell"><a class="ts" href="#L156" alt="Wed Oct 19 2022 12:00:29 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">are you not able to std::move stuff like JS::RootedObject?</td></tr>
  <tr class="msg" id="L157"><td class="ts-cell"><a class="ts" href="#L157" alt="Wed Oct 19 2022 12:02:28 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">when do you need to move <code>JS::Rooted</code> ?</td></tr>
  <tr class="msg" id="L158"><td class="ts-cell"><a class="ts" href="#L158" alt="Wed Oct 19 2022 12:02:53 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">it's more of the fact that i was trying to use a struct to share a bunch of global vars between tests</td></tr>
  <tr class="msg" id="L159"><td class="ts-cell"><a class="ts" href="#L159" alt="Wed Oct 19 2022 12:03:10 GMT-0700 (Pacific Daylight Time)">19:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">JS::RootedObject being one of them as you cannot declare that ahead of time</td></tr>
  <tr class="msg" id="L160"><td class="ts-cell"><a class="ts" href="#L160" alt="Wed Oct 19 2022 12:03:17 GMT-0700 (Pacific Daylight Time)">19:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">but I think i'll just use a c-pointer for now...</td></tr>
  <tr class="msg" id="L161"><td class="ts-cell"><a class="ts" href="#L161" alt="Wed Oct 19 2022 12:03:19 GMT-0700 (Pacific Daylight Time)">19:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I have used PersistentRooted.  I think that's the only one that is valid if stored on the heap.</td></tr>
  <tr class="msg" id="L162"><td class="ts-cell"><a class="ts" href="#L162" alt="Wed Oct 19 2022 12:04:57 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JS::Rooted</code> should be allocated on stack</td></tr>
  <tr class="msg" id="L163"><td class="ts-cell"><a class="ts" href="#L163" alt="Wed Oct 19 2022 13:48:48 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">am I not able to hand off to <code>PersistentRootedObject</code> another <code>JSObject*</code>?</td></tr>
  <tr class="msg" id="L164"><td class="ts-cell"><a class="ts" href="#L164" alt="Wed Oct 19 2022 14:41:36 GMT-0700 (Pacific Daylight Time)">21:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">you can change which object it's rooting, yes</td></tr>
  <tr class="msg" id="L165"><td class="ts-cell"><a class="ts" href="#L165" alt="Wed Oct 19 2022 14:44:06 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>root.set(newObj)</code></td></tr>
  <tr class="msg" id="L166"><td class="ts-cell"><a class="ts" href="#L166" alt="Wed Oct 19 2022 14:57:24 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>For any who are wondering, I believe I found a solution to my problem of converting C++ futures to JS promises, and it's surprisingly simple.</p>
<p>We just use a global queue of void futures</p>
<pre><code>class FutureWaitList {
 public:
    static void Enqueue(Future&lt;void&gt; &amp;&amp;f){
       if (!s_waitQueue) {
          s_waitQueue = make_unique&lt;deque&lt;Future&lt;void&gt;&gt;&gt;();
        }
       s_waitQueue-&gt;emplace_back(std::move(f));
    }
    static void WaitForAll() {
        if (!s_waitQueue) {
            return;
        }

        while (!s_waitQueue-&gt;empty()) {
            s_waitQueue-&gt;front().wait();
            s_waitQueue-&gt;pop_front();
        }
}
 private:
    static thread_local std::unique_ptr&lt;std::deque&lt;Future&lt;void&gt;&gt;&gt; s_waitQueue;
};
</code></pre>
<p>Then, whenever we convert a future to JS, we enqueue a void future created with Future::then:</p>
<pre><code>template&lt;typename T&gt;
struct JsPartialConverter&lt;Future&lt;T&gt;&gt; {
    static JS::Value ToJsImpl(JSContext * ctx, Future&lt;T&gt;&amp;&amp; orig) {
        
        auto prom = std::make_shared&lt;JS::PersistentRootedObject&gt;(ctx, JS::NewPromiseObject(ctx,nullptr));

        FutureWaitList::Enqueue(
            orig.then([ctx, prom] (auto &amp;&amp;f) {
                JS::RootedValue retVal(ctx, ToJs&lt;T&gt;(ctx, f.GetResult().Value()));
                JS::ResolvePromise(ctx, *prom, retVal);
            }));

        return JS::ObjectOrNullValue(*prom);
    }
};
</code></pre>
<p>And we just wait for them to complete before running jobs:</p>
<pre><code>bool TestFutures(JSContext* ctx, JS::HandleObject global) {

    char testCode[] = R"js(
        print("Before defining function");
        async function testFn(prom) {
            print("Before waiting for promise.");
            var s = await prom;
            print(`Received promise value: ${s}`);
        }
        testFn;
    )js";

    JS::RootedValue testFn(ctx);
    if (!ExecuteCode(ctx, testCode, &amp;testFn)) {
        return false;
    }

    JS::RootedValueVector args(ctx);
    JS::RootedValue retVal(ctx);

    JS::RootedValue jsPromise(ctx, ToJs(ctx, Demo_JS::ReturnStringInMilliseconds("Hello", 10000)));

    if (!args.append(jsPromise) || !JS_CallFunctionValue(ctx, global, testFn, args, &amp;retVal)){
        return false;
    }

    conversions::FutureWaitList::WaitForAll();
    js::RunJobs(ctx);

    return true;
}
</code></pre>
</td></tr>

</tbody></table></div></div></div>
</body></html>