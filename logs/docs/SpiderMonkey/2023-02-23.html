<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-02-23</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-02-23<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-02-22" class="nav-link"><span>prev</span></a>
<a href="2023-02-24" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Feb 23 2023 04:47:40 GMT-0800 (Pacific Standard Time)">12:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">We just published the first blog post in a series of two from <span class="nick-13">@allstarschh</span> <a href="https://mastodon.social/@SpiderMonkey/109914096703899848">https://mastodon.social/@SpiderMonkey/109914096703899848</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Feb 23 2023 07:46:58 GMT-0800 (Pacific Standard Time)">15:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><p>I'm running into a rooting hazard that I think is a false positive:</p>
<pre><code>    bool js::frontend::TokenStreamSpecific&lt;Unit, AnyCharsAccess&gt;::matchIntegerAfterFirstDigit(js::frontend::TokenStreamSpecific&lt;Unit, AnyCharsAccess&gt;::IsIntegerUnit, int32_t*) [with Unit = char16_t; AnyCharsAccess = js::frontend::ParserAnyCharsAccess&lt;js::frontend::GeneralParser&lt;js::frontend::FullParseHandler, char16_t&gt; &gt;; js::frontend::TokenStreamSpecific&lt;Unit, AnyCharsAccess&gt;::IsIntegerUnit = bool (*)(int); int32_t = int]
    IndirectCall: isIntegerUnit
    (any-function)
    (GC)
</code></pre>
<p>Theoretically, yes <code>matchIntegerAfterFirstDigit()</code> could be called with a function pointer that triggers a GC, but <a href="https://searchfox.org/mozilla-central/search?path=&amp;q=matchIntegerAfterFirstDigit">right now it is not</a>.</p>
<p>I do not want to root the object that is live across this so-called GC call, because this is for bug 1773319 and rooting would require having a <code>JSContext</code> which I cannot expect the caller to have.</p>
<p>Is there a way to ignore this case, or a way to avoid the hazard other than rooting?</p>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Feb 23 2023 07:47:00 GMT-0800 (Pacific Standard Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1773319">https://bugzil.la/1773319</a> — ASSIGNED (bthrall) — Add public Stencil APIs to compile without JSContext</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Feb 23 2023 08:13:31 GMT-0800 (Pacific Standard Time)">16:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: yes, the standard way to do this is to your function type take a |const AutoRequireNoGC&amp;| and pass it a AutoAssertNoGC from the stack</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Feb 23 2023 08:15:18 GMT-0800 (Pacific Standard Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: Also, how come you've got a JSObject without a context?  How do you know this won't get collected?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Feb 23 2023 08:19:44 GMT-0800 (Pacific Standard Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: Thanks!<br>I don't think I have a JSObject, though; I am creating JSAPI functions to compile a script to Stencil without needing a JSContext, so there should be no way to create a JSObject, but there is also nothing for the GC to collect.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Feb 23 2023 08:20:41 GMT-0800 (Pacific Standard Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">oh, you said 'object that is live' in your previous message and I was going off that</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Feb 23 2023 08:22:39 GMT-0800 (Pacific Standard Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Maybe "variable" would have been a better word to use, then? I have a <code>UniquePtr&lt;CompilationInput&gt;</code> that is live across the so-called GC call</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Feb 23 2023 08:23:34 GMT-0800 (Pacific Standard Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">can that contain GC pointers?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Feb 23 2023 08:24:53 GMT-0800 (Pacific Standard Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I guess this needs to be rooted on the main thread for the duration of the compilation</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Feb 23 2023 08:42:21 GMT-0800 (Pacific Standard Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">It looks like <code>CompilationInput</code> might contain GC pointers, but I would not expect it to in this use case, since the Stencil has not been instantiated yet. Sounds like something I should verify, though</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Feb 23 2023 08:50:46 GMT-0800 (Pacific Standard Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell">Is there an easy way to get a count of the number objects allocated in js shell?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Feb 23 2023 10:26:14 GMT-0800 (Pacific Standard Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><code>dumpGCArenaInfo()</code> seems to dump a bunch of interesting things</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Feb 23 2023 10:34:38 GMT-0800 (Pacific Standard Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It looks like <code>CompilationInput</code> might contain GC pointers, but I would not expect it to in this use case, since the Stencil has not been instantiated yet. Sounds like something I should verify, though</blockquote></mx-reply>CompilationInput GC pointers are for things like 'eval' which can only occur on the main thread. All off-thread cases do not use those pointers. It is admitted still a bit messy</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Feb 23 2023 10:36:36 GMT-0800 (Pacific Standard Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <code>dumpGCArenaInfo()</code> seems to dump a bunch of interesting things</blockquote></mx-reply>or maybe not. dumpGCArenaInfo() just seems to be static/const stuff</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Feb 23 2023 10:46:24 GMT-0800 (Pacific Standard Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">you could look at <a href="https://mozilla-spidermonkey.github.io/sm-wasi-demo/?branch=mozilla-central&amp;source=print(gcparam(%22gcBytes%22))">gcBytes</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Feb 23 2023 10:50:44 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Neat.. I didn't realize the WASI demo had enough of a file system to use dumpHeap  <a href="https://mozilla-spidermonkey.github.io/sm-wasi-demo/?branch=mozilla-central&amp;source=dumpHeap(%22foo%22)%0D%0Ax%20%3D%20os.file.readFile(%22foo%22)%0D%0Aprint(x)%0D%0A%2F%2F">https://mozilla-spidermonkey.github.io/sm-wasi-demo/?branch=mozilla-central&amp;source=dumpHeap(%22foo%22)%0D%0Ax%20%3D%20os.file.readFile(%22foo%22)%0D%0Aprint(x)%0D%0A%2F%2F</a></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Feb 23 2023 11:07:26 GMT-0800 (Pacific Standard Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: yeah, I'm looking at dumpHeap now</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Feb 23 2023 11:07:37 GMT-0800 (Pacific Standard Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: do you know if there are tools that consume it's output?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Feb 23 2023 11:08:00 GMT-0800 (Pacific Standard Time)">19:08</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span></div></td><td class="msg-cell">looks towards <span class="nick-12">sfink</span></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Feb 23 2023 11:11:51 GMT-0800 (Pacific Standard Time)">19:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-15">tcampbell</span>: do you know if there are tools that consume it's output?</blockquote></mx-reply>I have some scripts for the GC logs. I think that's the same format the browser uses. <a href="https://github.com/amccreight/heapgraph/tree/master/g">https://github.com/amccreight/heapgraph/tree/master/g</a></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Feb 23 2023 11:13:01 GMT-0800 (Pacific Standard Time)">19:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: I'll take a look thanks</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Feb 23 2023 11:23:20 GMT-0800 (Pacific Standard Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, mccr8's tools are the only ones I know of.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Feb 23 2023 11:26:54 GMT-0800 (Pacific Standard Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I have some scripts for the GC logs. I think that's the same format the browser uses. <a href="https://github.com/amccreight/heapgraph/tree/master/g">https://github.com/amccreight/heapgraph/tree/master/g</a></blockquote></mx-reply>find_roots, dom_tree, census and stringify are probably the most useful. parse_gc_graph is a "library" that will parse a file and give you a basic Python graph.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Feb 23 2023 11:27:57 GMT-0800 (Pacific Standard Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">there's recently been a fork of the IANA time zone database that restores one identifier per country so that e.g. Europe/Stockholm is no longer merged into Europe/Berlin. I know Firefox has previously done some customization of its time zone identifiers, has there been any discussion about Firefox using either the original or the fork? I didn't find one in bugzilla but maybe I'm not searching for the right terms</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Feb 23 2023 11:40:18 GMT-0800 (Pacific Standard Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe ask in <a href="https://matrix.to/#/#i18n:mozilla.org">#i18n:mozilla.org</a> ?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Feb 23 2023 11:41:12 GMT-0800 (Pacific Standard Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Feb 23 2023 12:35:23 GMT-0800 (Pacific Standard Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-7">Bryan Thrall [:bthrall]</span>: yes, the standard way to do this is to your function type take a |const AutoRequireNoGC&amp;| and pass it a AutoAssertNoGC from the stack</blockquote></mx-reply>actually, I think you'll need to create and pass an instance of <code>AutoSuppressGCAnalysis</code> to the <code>const AutoRequireNoGC&amp;</code> param. The hazard analysis will still complain if you have a call through a function pointer within an <code>AutoAssertNoGC</code> scope. <code>AutoAssertNoGC</code> will just add a dynamic assert if you lie and call a function pointer that ends up GCing after all. (Sorry for the tangle of types. I should make a chart.)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Feb 23 2023 12:42:53 GMT-0800 (Pacific Standard Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">Does JavaScript have an equivalent data structure of <code>std::map</code>? I don't believe maps are sorted <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map</a></td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Feb 23 2023 12:44:02 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">no, all of JS language's map-like things are sorted. Well, mostly sorted. Numeric indexes get a little weird.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Feb 23 2023 12:44:44 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">("sorted" meaning in definition order)</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Feb 23 2023 12:44:44 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">So a JS map is sorted by its keys too? Where if you iterate through the JS map and insert while iterating then the iterator won't be invalid?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Feb 23 2023 12:45:44 GMT-0800 (Pacific Standard Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I would need to look up the iterator invalidation rules, but given that the sort order is definition order, my guess is that insertion would be fine.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Feb 23 2023 13:51:48 GMT-0800 (Pacific Standard Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I have a JS::Value that contains a normal JS array.  What's the best way to convert this into a RootedValueVector or RootedValueArray ?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Feb 23 2023 14:04:04 GMT-0800 (Pacific Standard Time)">22:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>Currently, I'm doing this:</p>
<pre><code> JS::RootedValue retVal(ctx());
    JS::RootedValueVector argv(ctx());

    ASSERT_TRUE(
        argv.reserve(3)
        &amp;&amp; argv.append(ToJs(ctx(), cbHandler))
        &amp;&amp; argv.append(JS::Int32Value(period))
        &amp;&amp; argv.append(JS::Int32Value(iterations)));
ASSERT_TRUE(JS_CallFunctionName(ctx(), global(), "testFn", argv, &amp;retVal));
</code></pre>
<p>But I have a function that can convert std::tuples to normal JS arrays, and I want to see if it's easy to put that array into a value vector using less code.</p>
<p>So I could do something more like this:<br><code>ASSERT_TRUE(JS_CallFunctionName(ctx(), global, "testFn", MakeValueVector(ToJs(ctx(), std::tuple{cbkHandler, period, iterations})), &amp;retVal);</code></p>
<p>In the above case, "MakeValueVector" is just a stand in for some hypothetical function that could do the conversion.</p>
<p>ToJs for std::tuple returns a JS::Value that contains a normal JS array.</p>
</td></tr>

</tbody></table></div></div></div>
</body></html>