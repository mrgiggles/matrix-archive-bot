<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-11-09</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-11-09<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-11-08" class="nav-link"><span>prev</span></a>
<a href="2022-11-10" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Nov 08 2022 21:29:58 GMT-0800 (Pacific Standard Time)">05:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><p>Having the same issue with <code>GetPromiseResult</code> as I've had before:</p>
<pre><code class="language-rs">std::_Atomic_storage::load(memory_order) atomic:1045
mozilla::detail::IntrinsicMemoryOps::load(const std::atomic&lt;â€¦&gt; &amp;) Atomics.h:191
mozilla::detail::AtomicBaseIncDec::operator unsigned long long() Atomics.h:336
js::gc::Cell::flags() Cell.h:156
js::gc::TenuredCellWithNonGCPointer::headerPtr() Cell.h:729
js::BaseShape::clasp() Shape.h:671
js::Shape::getObjectClass() Shape.h:1050
JSObject::getClass() JSObject.h:101
JSObject::is&lt;â€¦&gt;() JSObject.h:445
JSObject::as&lt;â€¦&gt;() JSObject.h:450
JS::GetPromiseResult(Handle&lt;â€¦&gt;) jsapi.cpp:3817
ion::objects::promise::Promise::result(ion::context::Context *) promise.rs:146
ion::format::promise::format_promise(ion::context::Context *,Config,ion::objects::promise::Promise *) promise.rs:17
ion::format::object::format_object(ion::context::Context *,Config,Object) object.rs:41
ion::format::format_value(ion::context::Context *,Config,ion::value::Value *) mod.rs:32
cli::evaluate::eval_inline::async_fn$0(Pin&lt;ref_mut$&lt;enum2$&lt;cli::evaluate::eval_inline::async_fn_env$0&gt; &gt; &gt;,ResumeTy) evaluate.rs:32
core::future::from_generator::impl$1::poll&lt;enum2$&lt;cli::evaluate::eval_inline::async_fn_env$0&gt; &gt;(Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::evaluate::eval_inline::async_fn_env$0&gt; &gt; &gt; &gt;,core::task::wake::Context *) mod.rs:91
cli::commands::eval::eval_source::async_fn$0(Pin&lt;ref_mut$&lt;enum2$&lt;cli::commands::eval::eval_source::async_fn_env$0&gt; &gt; &gt;,ResumeTy) eval.rs:26
core::future::from_generator::impl$1::poll&lt;enum2$&lt;cli::commands::eval::eval_source::async_fn_env$0&gt; &gt;(Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::commands::eval::eval_source::async_fn_env$0&gt; &gt; &gt; &gt;,core::task::wake::Context *) mod.rs:91
cli::commands::handle_command::async_fn$0(Pin&lt;ref_mut$&lt;enum2$&lt;cli::commands::handle_command::async_fn_env$0&gt; &gt; &gt;,ResumeTy) mod.rs:31
core::future::from_generator::impl$1::poll&lt;enum2$&lt;cli::commands::handle_command::async_fn_env$0&gt; &gt;(Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::commands::handle_command::async_fn_env$0&gt; &gt; &gt; &gt;,core::task::wake::Context *) mod.rs:91
cli::main::async_block$0(Pin&lt;ref_mut$&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt;,ResumeTy) main.rs:64
core::future::from_generator::impl$1::poll&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt;(Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt;,core::task::wake::Context *) mod.rs:91
core::future::future::impl$1::poll&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt;(Pin&lt;ref_mut$&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt; &gt;,core::task::wake::Context *) future.rs:124
tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0::closure$0::closure$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;(closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;) current_thread.rs:525
tokio::coop::with_budget::closure$0&lt;enum2$&lt;core::task::poll::Poll&lt;tuple$&lt;&gt; &gt; &gt;,tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0::closure$0::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt; &gt;(closure_env$0&lt;enum2$&lt;core::task::poll::Poll&lt;tuple$&lt;&gt; &gt; &gt;,tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0::closure$0::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt; &gt;,core::cell::Cell&lt;tokio::coop::Budget&gt; *) coop.rs:102
std::thread::local::LocalKey&lt;core::cell::Cell&lt;tokio::coop::Budget&gt; &gt;::try_with&lt;core::cell::Cell&lt;tokio::coop::Budget&gt;,tokio::coop::with_budget::closure_env$0&lt;enum2$&lt;core::task::poll::Poll&lt;tuple$&lt;&gt; &gt; &gt;,tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0::closure$0::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt; &gt;,enum2$&lt;core::task::poll::Poll&lt;tuple$&lt;&gt; &gt; &gt; &gt;(closure_env$0&lt;enum2$&lt;core::task::poll::Poll&lt;tuple$&lt;&gt; &gt; &gt;,tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0::closure$0::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt; &gt;) local.rs:445
std::thread::local::LocalKey&lt;core::cell::Cell&lt;tokio::coop::Budget&gt; &gt;::with&lt;core::cell::Cell&lt;tokio::coop::Budget&gt;,tokio::coop::with_budget::closure_env$0&lt;enum2$&lt;core::task::poll::Poll&lt;tuple$&lt;&gt; &gt; &gt;,tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0::closure$0::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt; &gt;,enum2$&lt;core::task::poll::Poll&lt;tuple$&lt;&gt; &gt; &gt; &gt;(closure_env$0&lt;enum2$&lt;core::task::poll::Poll&lt;tuple$&lt;&gt; &gt; &gt;,tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0::closure$0::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt; &gt;) local.rs:421
[Inlined] tokio::coop::with_budget(Budget,closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;) coop.rs:95
[Inlined] tokio::coop::budget(closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;) coop.rs:72
tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0::closure$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;(closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;) current_thread.rs:525
tokio::runtime::scheduler::current_thread::Context::enter&lt;enum2$&lt;core::task::poll::Poll&lt;tuple$&lt;&gt; &gt; &gt;,tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt; &gt;(tokio::runtime::scheduler::current_thread::Core *,closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;) current_thread.rs:349
tokio::runtime::scheduler::current_thread::impl$9::block_on::closure$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;(closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;,tokio::runtime::scheduler::current_thread::Core *,tokio::runtime::scheduler::current_thread::Context *) current_thread.rs:524
tokio::runtime::scheduler::current_thread::impl$9::enter::closure$0&lt;tokio::runtime::scheduler::current_thread::impl$9::block_on::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;,enum2$&lt;core::option::Option&lt;tuple$&lt;&gt; &gt; &gt; &gt;(closure_env$0&lt;tokio::runtime::scheduler::current_thread::impl$9::block_on::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;,enum2$&lt;core::option::Option&lt;tuple$&lt;&gt; &gt; &gt; &gt;) current_thread.rs:595
tokio::macros::scoped_tls::ScopedKey&lt;tokio::runtime::scheduler::current_thread::Context&gt;::set&lt;tokio::runtime::scheduler::current_thread::Context,tokio::runtime::scheduler::current_thread::impl$9::enter::closure_env$0&lt;tokio::runtime::scheduler::current_thread::impl$9::block_on::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;,enum2$&lt;core::option::Option&lt;tuple$&lt;&gt; &gt; &gt; &gt;,tuple$&lt;alloc::boxed::Box&lt;tokio::runtime::scheduler::current_thread::Core,alloc::alloc::Global&gt;,enum2$&lt;core::option::Option&lt;tuple$&lt;&gt; &gt; &gt; &gt; &gt;(tokio::runtime::scheduler::current_thread::Context *,closure_env$0&lt;tokio::runtime::scheduler::current_thread::impl$9::block_on::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;,enum2$&lt;core::option::Option&lt;tuple$&lt;&gt; &gt; &gt; &gt;) scoped_tls.rs:61
tokio::runtime::scheduler::current_thread::CoreGuard::enter&lt;tokio::runtime::scheduler::current_thread::impl$9::block_on::closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;,enum2$&lt;core::option::Option&lt;tuple$&lt;&gt; &gt; &gt; &gt;(CoreGuard,closure_env$0&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;) current_thread.rs:595
tokio::runtime::scheduler::current_thread::CoreGuard::block_on&lt;core::pin::Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt; &gt;(CoreGuard,Pin&lt;ref_mut$&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt; &gt;,core::panic::location::Location *) current_thread.rs:515
tokio::runtime::scheduler::current_thread::CurrentThread::block_on&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt;(GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt;,core::panic::location::Location *) current_thread.rs:161
tokio::runtime::Runtime::block_on&lt;core::future::from_generator::GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt; &gt;(GenFuture&lt;enum2$&lt;cli::main::async_block_env$0&gt; &gt;,core::panic::location::Location *) mod.rs:490
cli::main() main.rs:64
core::ops::function::FnOnce::call_once&lt;void (*)(),tuple$&lt;&gt; &gt;(void (*)()) function.rs:248
[Inlined] core::hint::black_box(tuple$&lt;&gt;) hint.rs:223
std::rt::lang_start::closure$0&lt;tuple$&lt;&gt; &gt;(std::rt::lang_start::closure_env$0&lt;tuple$&lt;&gt; &gt; *) rt.rs:166
[Inlined] core::ops::function::impls::impl$2::call_once() function.rs:283
[Inlined] std::panicking::try::do_call() panicking.rs:492
[Inlined] std::panicking::try() panicking.rs:456
[Inlined] std::panic::catch_unwind() panic.rs:137
[Inlined] std::rt::lang_start_internal::closure$2() rt.rs:148
[Inlined] std::panicking::try::do_call() panicking.rs:492
[Inlined] std::panicking::try() panicking.rs:456
[Inlined] std::panic::catch_unwind() panic.rs:137
std::rt::lang_start_internal() rt.rs:148
std::rt::lang_start&lt;tuple$&lt;&gt; &gt;(void (*)(),long long,unsigned char **,unsigned char) rt.rs:165
main 0x00007ff6b74773bc
[Inlined] invoke_main() 0x00007ff6b9a6a7b0
__scrt_common_main_seh() 0x00007ff6b9a6a78e
&lt;unknown&gt; 0x00007ffd13787034
&lt;unknown&gt; 0x00007ffd138c26a1
</code></pre>
<p>Promise comes from the result of a script with <code>(async () =&gt; 3)()</code><br>Psuedocode Flow:</p>
<ol>
<li>root promise value (via being rval)</li>
<li>root promise object</li>
<li>get PromiseState (succeeds)</li>
<li>get promise result (fails)</li>
</ol></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Nov 08 2022 21:30:44 GMT-0800 (Pacific Standard Time)">05:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">Right before I run <code>GetPromiseResult</code>, <code>IsPromiseObject(promise.handle().into()) = true</code></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Nov 08 2022 21:49:28 GMT-0800 (Pacific Standard Time)">05:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">It seems the <code>headerPtr_</code> is somehow pointing to null? I have no idea.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Nov 08 2022 22:34:16 GMT-0800 (Pacific Standard Time)">06:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">* The issue may just be the use of `&amp;promise-&gt;as&lt;...&gt;()` instead of `promise-&gt;as&lt;...&gt;()`, but I can't confirm that yet, I'll test that out</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Nov 08 2022 23:13:14 GMT-0800 (Pacific Standard Time)">07:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell"><p>I think the issue may be the use of <code>&amp;promise-&gt;as&lt;...&gt;()</code> instead of <code>promise-&gt;as&lt;...&gt;()</code> because <code>as()</code> already returns a reference</p>
<p>Edit: Definitely not it</p>
</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Nov 09 2022 07:49:00 GMT-0800 (Pacific Standard Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">ðŸ‘€https://<a href="http://mastodon.social/@SpiderMonkey">mastodon.social/@SpiderMonkey</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Nov 09 2022 08:20:37 GMT-0800 (Pacific Standard Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">we're a bit behind on posts but it should be up to date from now on</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Nov 09 2022 08:22:05 GMT-0800 (Pacific Standard Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ohhh we should verify our link</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Nov 09 2022 08:23:17 GMT-0800 (Pacific Standard Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@redfire75369:mozilla.org">Redfire</span>&gt;</div></td><td class="msg-cell">You just need a link with <code>rel="me"</code> that links to the mastodon page</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Nov 09 2022 08:25:56 GMT-0800 (Pacific Standard Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">yep, on it!</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Nov 09 2022 08:28:08 GMT-0800 (Pacific Standard Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">should be there maybe tomorrow.. i think everything is a little slow right now</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Nov 09 2022 08:28:46 GMT-0800 (Pacific Standard Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but yes, this is our "official" SM account, we might move instances at some point. Though the migration looks pretty simple to do, so if folks follow that one they should be transferred if we move</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Nov 09 2022 08:48:40 GMT-0800 (Pacific Standard Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: ping</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Nov 09 2022 09:52:18 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@slavaz:mozilla.org">slavaz</span>&gt;</div></td><td class="msg-cell">There is something I do not understand with rooting and GC. Use case. I have one JSContext cx and I would like to run in with multiple Globals gl1, gl2, gl3.  Initially, I want gl1, gl2, gl3 not to be garbage collected. At some point, I no longer need gl2. Now, I call  JS_NewGlobalObject and got gl1, gl2, gl3. The I can do AutoRealm in them in arbitrary order. But I want them not to be GC-ed, so,  what I need to do? JS::RootedObject g1{gl1}, etc? My concern that  JS::RootedObject is described as object on stack. I am allowed to create JS::RootedObject in one order and destroy them in different order? If not, what mechanism I can use to preven objects from GC-ing and remove that prevention in arbitrary order? </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Nov 09 2022 10:02:57 GMT-0800 (Pacific Standard Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">slavaz</span>: One option is to have a <code>GCVector&lt;...&gt;</code> (<a href="https://searchfox.org/mozilla-central/source/js/public/GCVector.h#27">https://searchfox.org/mozilla-central/source/js/public/GCVector.h#27</a>) that contains gl1, gl2, etc. Then you can root the GCVector, instead of each individual global</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Nov 09 2022 10:04:09 GMT-0800 (Pacific Standard Time)">18:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Not sure this will answer your question, but we have <code>AddPersistentRoot</code>: <a href="https://searchfox.org/mozilla-central/source/js/public/RootingAPI.h#1347-1348">https://searchfox.org/mozilla-central/source/js/public/RootingAPI.h#1347-1348</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Nov 09 2022 10:48:37 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that's more an internal function used by <code>PersistentRooted</code>.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Nov 09 2022 10:50:06 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">slavaz</span>: if you happen to only be running code that uses gl1,gl2,gl3 within one static scope, then <code>Rooted&lt;JSObject*&gt;</code> is fine. To let go of <code>gl2</code>, reassign the Rooted to nullptr.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Nov 09 2022 10:50:36 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">because you are correct in thinking that you can't destroy <code>RootedObject</code> in a different order.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Nov 09 2022 10:55:27 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but if they're not all under one scope, then <code>PersistentRooted</code> is the easiest way to go. (Again, set it to nullptr to release it.) Though if you want to keep them in some other struct on the heap, then <code>PersistentRooted</code> makes it surprisingly easy to create memory leaks. In that case, you'd be better off <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr91/docs/GC%20Rooting%20Guide.md#gc-thing-pointers-on-the-heap">using <code>Heap</code> and setting it up to be traced</a></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Nov 09 2022 11:33:53 GMT-0800 (Pacific Standard Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@slavaz:mozilla.org">slavaz</span>&gt;</div></td><td class="msg-cell">They are not under one scope, so, JS::PersistentRooted&lt;T&gt; seems like way to go.  so I am saying JS::PersistentRooted&lt;JSObject *) glx{cx, JS_NewGlobalObject(whatever) }. So, what I need to do to remove all tracing and all allocated memory, including one by JsObject? glx just goes out of scope? I found glx.reset() before going out of scope? Anything to delete JSObject ?anything else?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Nov 09 2022 12:04:04 GMT-0800 (Pacific Standard Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>glx = nullptr</code> will prevent it from keeping your global alive. You can't actively delete or finalize a <code>JSObject</code>, and it won't be deleted if there's anything else keeping it alive, but that should be fine. <code>glx.reset()</code> will have nearly the same effect as <code>glx = nullptr</code>.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Nov 09 2022 12:04:24 GMT-0800 (Pacific Standard Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>glx just goes out of scope?</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Nov 09 2022 12:04:56 GMT-0800 (Pacific Standard Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">since you don't have a single scope, that doesn't seem possible for your situation.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Nov 09 2022 12:06:02 GMT-0800 (Pacific Standard Time)">20:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but if it's a member of some struct that you delete, that works too (as in, it's fine for <code>PersistentRooted</code> objects to be deleted. That'll also stop them from keeping things alive, and it's safe to do.)</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Nov 09 2022 12:07:12 GMT-0800 (Pacific Standard Time)">20:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">after <code>glx = nullptr</code>, the actual freeing of JSObject memory won't happen until the next GC.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Nov 09 2022 13:57:29 GMT-0800 (Pacific Standard Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Is there an easy way to pass a RootedValue as a HandleObject?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Nov 09 2022 15:27:47 GMT-0800 (Pacific Standard Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: No, you have to convert it to an object and root it separately. A HandleObject is a pointer to a rooted object. A value and an object don't have the same representation (there are <a href="https://searchfox.org/mozilla-central/source/js/public/Value.h#31">tag bits set in the value</a>), so you can't take a pointer to a value and convert it to a pointer to an object.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Nov 09 2022 15:29:36 GMT-0800 (Pacific Standard Time)">23:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So <code>RootedObj obj(cx, &amp;val.toObject());</code> is the idiomatic way to do it. You'll see it all over the SM source code.</td></tr>

</tbody></table></div></div></div>
</body></html>