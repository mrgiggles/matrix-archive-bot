<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-05-16</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-05-16<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-05-15" class="nav-link"><span>prev</span></a>
<a href="2024-05-17" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu May 16 2024 07:36:02 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Dumb question: why does wasm use float registers and why do we not handle them the same way as general registers? (my problem is masm.printf, of course. callWithABI is involved)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu May 16 2024 07:44:43 GMT-0700 (Pacific Daylight Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><code>MIRType::Double</code> values are put in float registers for JS and Wasm. <code>ToFloatRegister</code> must be used  in codegen instead of <code>ToRegister</code> to get the <code>FloatRegister</code> that holds the double value</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu May 16 2024 07:47:21 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><code>callWithABI</code> can handle double arguments with <code>masm.passABIArg(floatRegister, ABIType::Float64)</code></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu May 16 2024 08:53:54 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Hardware distinguish between float registers and general purpose registers, with instructions which are specific for each type of register.<br>My guess is that this was a cheap way to double the number of indexable register without requiring more bytes to encode instructions.<br>We do have an <a href="https://searchfox.org/mozilla-central/source/js/src/jit/RegisterSets.h#25,41-42"><code>AnyRegister</code> type</a>, as well as a <code>ToAnyRegister</code>, in which case we do store a flag to distinguish the type of the register.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu May 16 2024 10:30:25 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">Where does <code>eval()</code> live in?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu May 16 2024 10:31:52 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">emilio</span>: In what sense?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu May 16 2024 10:32:10 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: I just want to printf out stuff passed to eval()</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu May 16 2024 10:32:29 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: wanted to do some quick debugging of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1897150#c9">https://bugzilla.mozilla.org/show_bug.cgi?id=1897150#c9</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu May 16 2024 10:32:43 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: which seems like a regression in 126 with the Array.prototype.sort() changes</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu May 16 2024 10:33:08 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: ^ fyi, hopefully you can see that private comment with the login info from the reporter</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu May 16 2024 10:33:30 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Maybe try <a href="https://searchfox.org/mozilla-central/source/js/src/builtin/Eval.cpp#235">here</a>?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu May 16 2024 10:37:33 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">thanks! That looks exactly it :)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu May 16 2024 10:48:00 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">emilio</span>: that's weird, I'll take a look</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu May 16 2024 10:48:28 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I can see your comment</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu May 16 2024 10:56:01 GMT-0700 (Pacific Daylight Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I'm taking a quick look. It seems to maybe be some sort of problem with how <code>this</code> gets bound?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu May 16 2024 10:57:03 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it could be something with the JitEntry mechanism that we now also use for non-Wasm natives</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu May 16 2024 11:06:17 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If I hover over <code>this</code> in the debugger, <code>this</code> is somehow a window with the Number prototype</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu May 16 2024 11:28:16 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: <span class="nick-4">iain</span>: I attached a standalone test-case to the bug</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu May 16 2024 11:55:11 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">Ok I reduced it as much as I could, gotta go now</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu May 16 2024 11:55:15 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">Hopefully it's helpful</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu May 16 2024 11:55:32 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">That code is kinda horrific tbh</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu May 16 2024 11:55:41 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">But I guess I get what it's trying to do</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu May 16 2024 11:57:43 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">Ah, eval() is a red herring</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu May 16 2024 12:07:39 GMT-0700 (Pacific Daylight Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">seems to do with the comparator <code>this</code> value, but I don't know where's the spec for that, the behavior is quite bizarre tbh :)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu May 16 2024 12:09:56 GMT-0700 (Pacific Daylight Time)">19:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I think <code>this</code> is supposed to be hardcoded to <code>undefined</code> <a href="https://tc39.es/ecma262/#sec-comparearrayelements">here</a></td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu May 16 2024 12:10:18 GMT-0700 (Pacific Daylight Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In which case IIRC inside the function, <code>this</code> is the global</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu May 16 2024 12:10:29 GMT-0700 (Pacific Daylight Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But we seem to be accidentally passing a non-undefined value there</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu May 16 2024 12:10:32 GMT-0700 (Pacific Daylight Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which is probably the bug</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu May 16 2024 12:12:15 GMT-0700 (Pacific Daylight Time)">19:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">But even if <code>this</code> was undefined, then it ought to still throw?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu May 16 2024 12:12:48 GMT-0700 (Pacific Daylight Time)">19:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell">I guess "this" being undefined might be some magic or something</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu May 16 2024 12:13:52 GMT-0700 (Pacific Daylight Time)">19:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, see <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Interpreter.cpp#106-112">here</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu May 16 2024 12:14:14 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In sloppy mode, undefined or null <code>this</code> is replaced with the global</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu May 16 2024 12:17:01 GMT-0700 (Pacific Daylight Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: <a href="https://searchfox.org/mozilla-central/rev/a18a7c526cf3c531f2fc24db4f0dffbc16290a7e/js/src/jit/VMFunctions.cpp#576-577">https://searchfox.org/mozilla-central/rev/a18a7c526cf3c531f2fc24db4f0dffbc16290a7e/js/src/jit/VMFunctions.cpp#576-577</a> :)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu May 16 2024 12:17:32 GMT-0700 (Pacific Daylight Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@emilio:mozilla.org">emilio</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: so, it seems we forget to reset the <code>this</code> value, and the second time we call the comparator, we still have the result from the previous iteration</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu May 16 2024 12:17:49 GMT-0700 (Pacific Daylight Time)">19:17</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-13" title="@emilio:mozilla.org">emilio</span></div></td><td class="msg-cell"><mx-reply><blockquote> Ok I reduced it as much as I could, gotta go now</blockquote></mx-reply>not being great at going, whoops</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu May 16 2024 12:21:38 GMT-0700 (Pacific Daylight Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">emilio</span>: I can take it from here. I know exactly where the bug is.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu May 16 2024 12:25:53 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-13" title="@emilio:mozilla.org">emilio</span></div></td><td class="msg-cell">bets around <a href="https://searchfox.org/mozilla-central/rev/a18a7c526cf3c531f2fc24db4f0dffbc16290a7e/js/src/jit/TrampolineNatives.cpp#160">here</a>, but will happily let <span class="nick-4">iain</span> take it from here since he's lost in jit code :)</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu May 16 2024 12:29:16 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You would win your bet</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu May 16 2024 13:31:19 GMT-0700 (Pacific Daylight Time)">20:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@zombie:mozilla.org">zombie</span>&gt;</div></td><td class="msg-cell">gutcheck question, if I have a small "lookup" object <code>const table = { a: 13, b: 42... }</code> nested in some 3-4 levels of methods+lambdas, is there a perf benefit of moving that to a global const, or can I assume a modern engine uplifts that constant automatically, and a new object is not created every time that code is executed?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu May 16 2024 13:35:26 GMT-0700 (Pacific Daylight Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">zombie</span>: <code>const</code> gives weak guarantees in JS. For example, <code>const a = { x: 1 }; a.x = 2;</code> is perfectly legal.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu May 16 2024 13:36:24 GMT-0700 (Pacific Daylight Time)">20:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@zombie:mozilla.org">zombie</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: understand that, but if the const is never modified (it's a static lookup table), does that unlock some optimizations in engines?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu May 16 2024 13:37:15 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If the lookup object is being used entirely inside the function where you create it, and we can prove that it doesn't escape and we know every use, then we can do scalar replacement on it.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu May 16 2024 13:37:54 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If not, then in general we have to assume when compiling each function that some other function could be modifying it.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu May 16 2024 13:39:05 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell"><p>Hi all,</p>
<p>I'm hitting an assert in <code>ChunkPool::verify()</code> , specifically this one:</p>
<pre><code>`MOZ_ASSERT_IF(cursor-&gt;info.next, cursor-&gt;info.next-&gt;info.prev == cursor);`. My stack trace looks like this:
</code></pre>
<pre><code>#0  in raise () from /lib64/libpthread.so.0
#1  in (anonymous namespace)::endProcessWithSignal (signalNum=signalNum@entry=11) at  /signal_handlers_synchronous.cpp:136
#2  in (anonymous namespace)::abruptQuitWithAddrSignal (signalNum=11, siginfo=0x308036849bf0, ucontext_erased=&lt;optimized out&gt;) at  /signal_handlers_synchronous.cpp:351
#3  &lt;signal handler called&gt;
#4  in js::gc::ChunkPool::verify (this=this@entry=0x3080058297d0) at  extract/js/src/gc/Heap.cpp:601
#5  in js::gc::ChunkPool::contains (this=0x3080058297d0, chunk=chunk@entry=0x1551fbf00000) at  extract/js/src/gc/Heap.cpp:586
#6  in js::gc::GCRuntime::pickChunk (this=this@entry=0x308005828728, lock=...) at  extract/js/src/gc/Allocator.cpp:576
#7  in js::gc::ArenaLists::refillFreeListAndAllocate (this=this@entry=0x30820e378270, thingKind=thingKind@entry=js::gc::AllocKind::STRING, checkThresholds=checkThresholds@entry=js::gc::ShouldCheckThresholds::DontCheckThresholds) at  include/mozilla/Maybe.h:799
#8  in js::gc::GCRuntime::refillFreeListInGC (zone=zone@entry=0x30820e378000, thingKind=thingKind@entry=js::gc::AllocKind::STRING) at  extract/js/src/gc/Allocator.cpp:324
#9  in js::gc::AllocateCellInGC (zone=0x30820e378000, zone@entry=0x7ff996f20370, thingKind=thingKind@entry=js::gc::AllocKind::STRING) at  extract/js/src/gc/Allocator.cpp:284
#10 in js::gc::TenuringTracer::allocTenured&lt;JSString&gt; (kind=&lt;optimized out&gt;, zone=0x7ff996f20370, this=0x7ff996f20370) at  extract/js/src/gc/Tenuring.cpp:483
#11 js::gc::TenuringTracer::allocTenuredString (this=this@entry=0x7ff996f20370, src=0xd2dc29ed8, zone=zone@entry=0x30820e378000, dstKind=dstKind@entry=js::gc::AllocKind::STRING) at  extract/js/src/gc/Tenuring.cpp:489
#12 in js::gc::TenuringTracer::moveToTenured (this=this@entry=0x7ff996f20370, src=&lt;optimized out&gt;, src@entry=0xd2dc29ed8) at  extract/js/src/gc/Tenuring.cpp:774
#13 in js::gc::TenuringTracer::onStringEdge (this=this@entry=0x7ff996f20370, strp=strp@entry=0x2287c23ffff0, name=name@entry=0x7ff9d8e49352 "left child") at  extract/js/src/gc/Tenuring.cpp:102
#14 in js::gc::TraceEdgeInternal (String=0x7ff9d8e49352 "left child", thingp=0x2287c23ffff0, trc=0x7ff996f20370) at  extract/js/src/gc/Tracer.h:106
#15 js::TraceManuallyBarrieredEdge&lt;JSString*&gt; (name=0x7ff9d8e49352 "left child", thingp=0x2287c23ffff0, trc=0x7ff996f20370) at  extract/js/src/gc/Tracer.h:248
#16 JSRope::traceChildren (trc=0x7ff996f20370, this=0x2287c23fffe8) at  extract/js/src/gc/TraceMethods-inl.h:120
#17 JSString::traceChildren (trc=0x7ff996f20370, this=0x2287c23fffe8) at  extract/js/src/gc/TraceMethods-inl.h:76
#18 JSString::traceChildren (trc=0x7ff996f20370, trc@entry=0x2287c23fffe8, this=this@entry=0x2287c23fffe8) at  extract/js/src/gc/TraceMethods-inl.h:72
#19 js::gc::TenuringTracer::traceString (this=this@entry=0x7ff996f20370, str=str@entry=0x2287c23fffe8) at  extract/js/src/gc/Tenuring.cpp:459
#20 in js::gc::TenuringTracer::collectToStringFixedPoint (this=this@entry=0x7ff996f20370) at  extract/js/src/gc/Tenuring.cpp:910
#21 in js::Nursery::doCollection (this=this@entry=0x30800582b238, session=..., options=options@entry=JS::GCOptions::Normal, reason=reason@entry=JS::GCReason::OUT_OF_NURSERY) at  extract/js/src/gc/Nursery.cpp:1423
#22 in js::Nursery::collect (this=this@entry=0x30800582b238, options=options@entry=JS::GCOptions::Normal, reason=reason@entry=JS::GCReason::OUT_OF_NURSERY) at  extract/js/src/gc/Nursery.cpp:1186
#23 in js::gc::GCRuntime::collectNursery (this=this@entry=0x308005828728, options=options@entry=JS::GCOptions::Normal, reason=reason@entry=JS::GCReason::OUT_OF_NURSERY, phase=phase@entry=js::gcstats::PhaseKind::MINOR_GC) at  extract/js/src/gc/GC.cpp:4605
#24 in js::gc::GCRuntime::minorGC (this=0x308005828728, reason=reason@entry=JS::GCReason::OUT_OF_NURSERY, phase=phase@entry=js::gcstats::PhaseKind::MINOR_GC) at  extract/js/src/gc/GC.cpp:4577
#25 in js::gc::GCRuntime::tryNewNurseryCell&lt;(JS::TraceKind)2, (js::AllowGC)1&gt; (this=&lt;optimized out&gt;, site=0x30820e378a10, thingSize=&lt;optimized out&gt;, cx=0x3080350de000) at  extract/js/src/gc/Allocator.cpp:129
#26 js::gc::CellAllocator::AllocNurseryOrTenuredCell&lt;(JS::TraceKind)2, (js::AllowGC)1&gt; (cx=cx@entry=0x3080350de000, allocKind=allocKind@entry=js::gc::AllocKind::STRING, heap=heap@entry=js::gc::Heap::Default, site=0x30820e378a10, site@entry=0x0) at  extract/js/src/gc/Allocator.cpp:82
#27 in js::gc::CellAllocator::NewString&lt;JSRope, (js::AllowGC)1, JS::Handle&lt;JSString*&gt;&amp;, JS::Handle&lt;JSString*&gt;&amp;, unsigned long&amp;&gt; (heap=&lt;optimized out&gt;, cx=0x3080350de000) at  extract/js/src/gc/Allocator.h:82
#28 js::gc::CellAllocator::NewCell&lt;JSRope, (js::AllowGC)1, js::gc::Heap&amp;, JS::Handle&lt;JSString*&gt;&amp;, JS::Handle&lt;JSString*&gt;&amp;, unsigned long&amp;&gt; (cx=0x3080350de000) at  extract/js/src/gc/Allocator.h:160
#29 JSContext::newCell&lt;JSRope, (js::AllowGC)1, js::gc::Heap&amp;, JS::Handle&lt;JSString*&gt;&amp;, JS::Handle&lt;JSString*&gt;&amp;, unsigned long&amp;&gt; (this=0x3080350de000) at  extract/js/src/vm/JSContext.h:259
#30 JSRope::new_&lt;(js::AllowGC)1&gt; (heap=&lt;optimized out&gt;, length=224749, right=..., left=..., cx=0x3080350de000) at  extract/js/src/vm/StringType-inl.h:188
#31 js::ConcatStrings&lt;(js::AllowGC)1&gt; (cx=cx@entry=0x3080350de000, left=left@entry=..., right=right@entry=..., heap=heap@entry=js::gc::Heap::Default) at  extract/js/src/vm/StringType.cpp:990
#32 in AddOperation (cx=cx@entry=0x3080350de000, lhs=..., rhs=..., res=...) at  extract/js/src/vm/Interpreter.cpp:1487
#33 in js::Interpret (cx=cx@entry=0x3080350de000, state=...) at  extract/js/src/vm/Interpreter.cpp:2851
#34 in MaybeEnterInterpreterTrampoline (state=..., cx=0x3080350de000) at  extract/js/src/vm/Interpreter.cpp:400
#35 js::RunScript (cx=cx@entry=0x3080350de000, state=...) at  extract/js/src/vm/Interpreter.cpp:458
#36 in js::InternalCallOrConstruct (cx=&lt;optimized out&gt;, cx@entry=0x3080350de000, args=..., construct=construct@entry=js::NO_CONSTRUCT, reason=reason@entry=js::CallReason::Call) at  extract/js/src/vm/Interpreter.cpp:612
#37 in InternalCall (cx=cx@entry=0x3080350de000, args=..., reason=reason@entry=js::CallReason::Call) at  extract/js/src/vm/Interpreter.cpp:647
#38 in js::Call (cx=0x3080350de000, fval=fval@entry=..., thisv=..., thisv@entry=..., args=..., rval=rval@entry=..., reason=reason@entry=js::CallReason::Call) at  extract/js/src/vm/Interpreter.cpp:679
#39 in JS_CallFunctionValue (cx=&lt;optimized out&gt;, obj=..., obj@entry=..., fval=..., fval@entry=..., args=..., rval=..., rval@entry=...) at  extract/js/src/vm/CallAndConstruct.cpp:53
#40 in JS::Call (rval=..., args=..., fun=..., thisObj=..., cx=&lt;optimized out&gt;) at  include/js/CallAndConstruct.h:92
</code></pre>
</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu May 16 2024 13:39:45 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">any idea what the implications of the cursor not being in the expected state here is, and what could have caused it?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu May 16 2024 13:40:44 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">There are some potential optimizations that can be done where we speculate that it's constant, optimize as if that's true, and then deoptimize if anybody ever modifies it. I believe V8 does something along those lines, but we currently don't. </td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu May 16 2024 13:41:57 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">One issue being that you need to be very certain that you have identified every single place where a speculated-constant object could be modified, because if you miss one then you've got correctness bugs and potentially security bugs.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu May 16 2024 13:45:08 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">santiroche</span>: The assertion is checking that the next pointer of this chunk and the prev pointer of the next chunk agree on the state of the list. If you're failing that assertion, something has gone badly wrong in the GC's internal bookkeeping.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu May 16 2024 13:45:45 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't remember seeing that failure before. <span class="nick-12">sfink</span>, does that stack trace ring any bells?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu May 16 2024 13:48:15 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">zombie</span>: The short answer to your question is: if the lifetime of your lookup object is contained entirely within one function, then we already do a good job of eliminating the allocation. If not, then hoisting it to the global scope will avoid allocating a new copy each time.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu May 16 2024 13:49:39 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I feel like I've seen the chunk list pointers be off before, but it was a long time ago. Heap corruption? </td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu May 16 2024 13:50:27 GMT-0700 (Pacific Daylight Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Note that the definition of "contained entirely within one function" is a little fuzzy: we do this on a per-compilation scope, so returning the object from a function would count as an escape, but passing it as an argument / using it inside a nested function <em>might</em> be okay if we inlined the call. In general, though, we don't inline very aggressively, so unless you are only using it inside very small lambdas, I wouldn't rely on inlining.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu May 16 2024 13:56:39 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@zombie:mozilla.org">zombie</span>&gt;</div></td><td class="msg-cell">yeah, this was about a really simple "static" lookup, map an argument string to a return value string, all in the same lambda, no modifications/escapes.  thanks for the detailed explanation, i had an intuition this wouldn't allocate on every call, but wanted to confirm before stating so in a review comment :)</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu May 16 2024 14:00:42 GMT-0700 (Pacific Daylight Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">will try to repro with the address sanitizer enabled to see if it helps here. Any other guidance on how to try to track down the cause of the corruption?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu May 16 2024 14:08:13 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><a href="https://rr-project.org/">rr is magic</a></td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu May 16 2024 14:16:15 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">thanks! I think it will be tricky. The failure is sporadic. The workload that reproduced it (sporadically) is in a multithreaded fashion (20 jobs), each with large arrays in the functions being executed, and so far only when linked dynamically instead of statically.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu May 16 2024 14:35:41 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@santiroche:mozilla.org">santiroche</span>&gt;</div></td><td class="msg-cell">Just to add some context, the failure started popping up after upgrading to ESR115.7 (from 91.3), not sure if it just happened to coincide with some changes with the GC </td></tr>

</tbody></table></div></div></div>
</body></html>