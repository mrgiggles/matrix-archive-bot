<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-04-29</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-04-29<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-04-28" class="nav-link"><span>prev</span></a>
<a href="2022-04-30" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Apr 29 2022 03:51:29 GMT-0700 (Pacific Daylight Time)">10:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">What is the underlying reason that we are using a source buffer in the case of workers for evaluating the script? <a href="https://searchfox.org/mozilla-central/search?q=symbol:_ZN2JS8EvaluateEP9JSContextRKNS_22ReadOnlyCompileOptionsERNS_10SourceTextIDsEENS_13MutableHandleINS_5ValueEEE&amp;redirect=false">https://searchfox.org/mozilla-central/search?q=symbol:_ZN2JS8EvaluateEP9JSContextRKNS_22ReadOnlyCompileOptionsERNS_10SourceTextIDsEENS_13MutableHandleINS_5ValueEEE&amp;redirect=false</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Apr 29 2022 03:58:27 GMT-0700 (Pacific Daylight Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">yulia</span>: do you mean <code>JS::SourceText&lt;char16_t&gt;</code> type?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Apr 29 2022 03:58:32 GMT-0700 (Pacific Daylight Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Apr 29 2022 03:59:11 GMT-0700 (Pacific Daylight Time)">10:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">We have the JS ExecutionContext in the dom -- and since I am doing quite a bit of work to  bring the DOM and workers close together, I am wondering if this is historical or if there is a reason why we want to work with buffers?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Apr 29 2022 03:59:27 GMT-0700 (Pacific Daylight Time)">10:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Otherwise, this is possibly something that can be in a base ScriptLoader class</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Apr 29 2022 03:59:37 GMT-0700 (Pacific Daylight Time)">10:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what else do you think is suitable there?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Apr 29 2022 04:00:02 GMT-0700 (Pacific Daylight Time)">11:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think I still don't understand the question</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Apr 29 2022 04:00:20 GMT-0700 (Pacific Daylight Time)">11:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">possibly this: <a href="https://searchfox.org/mozilla-central/source/dom/script/ScriptLoader.cpp#2049-2063">https://searchfox.org/mozilla-central/source/dom/script/ScriptLoader.cpp#2049-2063</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Apr 29 2022 04:01:31 GMT-0700 (Pacific Daylight Time)">11:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's for the case the script is already compiled, and during compiling (<code>JS::Compie</code> or variant), the same type of source buffer is used for passing the data</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Apr 29 2022 04:02:24 GMT-0700 (Pacific Daylight Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I see, and we don't want to precompile in the case of workers</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Apr 29 2022 04:03:02 GMT-0700 (Pacific Daylight Time)">11:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, for non-worker case, the script can be precompiled off-main-thread</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Apr 29 2022 04:03:22 GMT-0700 (Pacific Daylight Time)">11:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I haven't checked details for worker case tho</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Apr 29 2022 04:04:17 GMT-0700 (Pacific Daylight Time)">11:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I see, ok that makes sense.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Apr 29 2022 04:04:22 GMT-0700 (Pacific Daylight Time)">11:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I will add a comment</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Apr 29 2022 04:05:32 GMT-0700 (Pacific Daylight Time)">11:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the worker's script URL becomes known only when the worker is created, so there's not much chance that the script is prefetched and precompiled, I think?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Apr 29 2022 04:06:13 GMT-0700 (Pacific Daylight Time)">11:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Apr 29 2022 04:07:04 GMT-0700 (Pacific Daylight Time)">11:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, wait.  I think I'm misunderstanding the context for the function</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Apr 29 2022 04:07:50 GMT-0700 (Pacific Daylight Time)">11:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">we do a late compile as well on the DOM: <a href="https://searchfox.org/mozilla-central/source/dom/script/ScriptLoader.cpp#2300">https://searchfox.org/mozilla-central/source/dom/script/ScriptLoader.cpp#2300</a></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Apr 29 2022 04:08:20 GMT-0700 (Pacific Daylight Time)">11:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but, if I understood you right, the worker shouldn't be changed to work this same way as we don't have a potential precompile, so we can just use this separate function instead to do both steps an that should be ok</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Apr 29 2022 04:08:33 GMT-0700 (Pacific Daylight Time)">11:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the class is for <code>setTimeout</code> or something?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Apr 29 2022 04:08:46 GMT-0700 (Pacific Daylight Time)">11:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I mean, <code>WorkerScriptTimeoutHandler</code></td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Apr 29 2022 04:09:13 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/ecd91b104714a8b2584a4c03175be50ccb3a7c67/dom/base/TimeoutHandler.h#75-77">https://searchfox.org/mozilla-central/rev/ecd91b104714a8b2584a4c03175be50ccb3a7c67/dom/base/TimeoutHandler.h#75-77</a></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Apr 29 2022 04:09:46 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so it sounds like it's for the case <code>setTimouet("JS code here", ...)</code></td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Apr 29 2022 04:09:55 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">er</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Apr 29 2022 04:09:57 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">i meant</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Apr 29 2022 04:09:58 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/dom/workers/ScriptLoader.cpp#2101">https://searchfox.org/mozilla-central/source/dom/workers/ScriptLoader.cpp#2101</a></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Apr 29 2022 04:10:40 GMT-0700 (Pacific Daylight Time)">11:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I wonder why that doesn't link in searchfox..</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Apr 29 2022 04:11:14 GMT-0700 (Pacific Daylight Time)">11:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(sorry, I'm still thinking about the first case)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Apr 29 2022 04:12:13 GMT-0700 (Pacific Daylight Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">for the first case above, it's a string passed by JS code, and it's not pre-compiled simply because there's no other suitable place to compile the code.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Apr 29 2022 04:12:18 GMT-0700 (Pacific Daylight Time)">11:12</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@arai:mozilla.org">arai</span></div></td><td class="msg-cell">looks the second URL</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Apr 29 2022 04:13:14 GMT-0700 (Pacific Daylight Time)">11:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ok, that makes sense (my question was generic actually, so that answers it. Maybe we want something different for the worker script loader, but this answer made sense to me)</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Apr 29 2022 04:14:47 GMT-0700 (Pacific Daylight Time)">11:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, I realized what I said above about worker's script URL is wrong</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Apr 29 2022 04:15:21 GMT-0700 (Pacific Daylight Time)">11:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's only for the case the script is not cached</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Apr 29 2022 04:17:34 GMT-0700 (Pacific Daylight Time)">11:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">hmmm</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Apr 29 2022 04:17:49 GMT-0700 (Pacific Daylight Time)">11:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">does worker use JSBC ?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Apr 29 2022 04:17:59 GMT-0700 (Pacific Daylight Time)">11:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">JS Bytecode Cache? I think no</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Apr 29 2022 04:18:05 GMT-0700 (Pacific Daylight Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I have'nt seen any code related to it</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Apr 29 2022 04:18:10 GMT-0700 (Pacific Daylight Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Apr 29 2022 04:18:14 GMT-0700 (Pacific Daylight Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">we have the service worker cache</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Apr 29 2022 04:18:32 GMT-0700 (Pacific Daylight Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">the service worker loader and worker loader are layered on eachother (or, maybe intertwined is a better word?)</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Apr 29 2022 04:18:42 GMT-0700 (Pacific Daylight Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">if we have a service worker, we will run through the cache path</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Apr 29 2022 04:18:47 GMT-0700 (Pacific Daylight Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but on a regular worker we wont</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Apr 29 2022 04:19:11 GMT-0700 (Pacific Daylight Time)">11:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I am trying to make that relationship a bit clearer in this patch queue: <a href="https://phabricator.services.mozilla.com/D145063">https://phabricator.services.mozilla.com/D145063</a> (this patch is probably better to look at)</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Apr 29 2022 04:19:40 GMT-0700 (Pacific Daylight Time)">11:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">So, I don't know if the bytecode cache is necessary in the worker script loader, but maybe it would be? it might be useful for both worker and service worker?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Apr 29 2022 04:20:49 GMT-0700 (Pacific Daylight Time)">11:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">First load is from the network loader, second is from the cache, for service workers</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Apr 29 2022 04:21:21 GMT-0700 (Pacific Daylight Time)">11:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I don't think service worker needs JSBC integration if it has its own cache system</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Apr 29 2022 04:21:52 GMT-0700 (Pacific Daylight Time)">11:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and for regular worker, I'm not sure if it's necessarily be JSBC, but having some kind of bytecode cache might help</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Apr 29 2022 04:22:40 GMT-0700 (Pacific Daylight Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">It sounds like it can be done as a task later, if the dom team determines that it is valuable? for now I'll leave it as is</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Apr 29 2022 04:23:08 GMT-0700 (Pacific Daylight Time)">11:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">sounds reasonable</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Apr 29 2022 04:23:21 GMT-0700 (Pacific Daylight Time)">11:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Figuring out where to make the right cuts 😵‍💫</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Apr 29 2022 04:26:23 GMT-0700 (Pacific Daylight Time)">11:26</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@arai:mozilla.org">arai</span></div></td><td class="msg-cell">goes back to the second URL and question for it</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Apr 29 2022 04:31:29 GMT-0700 (Pacific Daylight Time)">11:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, the question is that, what kind of types "the part that executes the script" needs to support, in "Source text", "Stencil XDR", "Stencil", and "JSScript".  and whether (or what part) to share between worker and other cases, right?</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Apr 29 2022 04:34:49 GMT-0700 (Pacific Daylight Time)">11:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Apr 29 2022 04:34:58 GMT-0700 (Pacific Daylight Time)">11:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">thats right -- what makes sense in terms of shared functionality</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Apr 29 2022 04:35:16 GMT-0700 (Pacific Daylight Time)">11:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">And what should be hooks for customized behaviors (and if script execution should be a hook)</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Apr 29 2022 04:35:44 GMT-0700 (Pacific Daylight Time)">11:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">In the case of modules, right now, that is going to be shared via <a href="https://searchfox.org/mozilla-central/source/js/loader/ModuleLoaderBase.cpp#995">https://searchfox.org/mozilla-central/source/js/loader/ModuleLoaderBase.cpp#995</a></td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Apr 29 2022 04:37:45 GMT-0700 (Pacific Daylight Time)">11:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">am I correct that this is the current code that evaluates the worker's JS file?  <a href="https://searchfox.org/mozilla-central/rev/ecd91b104714a8b2584a4c03175be50ccb3a7c67/dom/workers/ScriptLoader.cpp#2150-2155">https://searchfox.org/mozilla-central/rev/ecd91b104714a8b2584a4c03175be50ccb3a7c67/dom/workers/ScriptLoader.cpp#2150-2155</a></td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Apr 29 2022 04:38:03 GMT-0700 (Pacific Daylight Time)">11:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">yes, this passes it to the JS::Evaluate eventually</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Apr 29 2022 04:54:53 GMT-0700 (Pacific Daylight Time)">11:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if using <code>JS::Evaluate</code> is special case for worker and it makes the code sharing complicated, I think it makes sense to stop using <code>JS::Evaluate</code> and instead use <code>JS::Compile</code> + <code>JS_ExecuteScript</code></td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Apr 29 2022 04:56:38 GMT-0700 (Pacific Daylight Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ok</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Apr 29 2022 04:56:53 GMT-0700 (Pacific Daylight Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">that would make it like the module case </td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Apr 29 2022 04:57:06 GMT-0700 (Pacific Daylight Time)">11:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Then, I'll do that when i wrap this up</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Apr 29 2022 05:24:02 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: <span class="nick-10">yulia</span>: My understanding is that the JSBC (added in the ScriptLoader) is now shared between workers and dom/base, right?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Apr 29 2022 05:24:13 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">not yet</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Apr 29 2022 05:24:26 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I though I saw the patches go by.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Apr 29 2022 05:24:49 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">hm... </td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Apr 29 2022 05:24:56 GMT-0700 (Pacific Daylight Time)">12:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">maybe it is somewhere i haven't been looking?</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Apr 29 2022 05:25:20 GMT-0700 (Pacific Daylight Time)">12:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">ok … I would have guess you had made the patches for it.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Apr 29 2022 05:25:28 GMT-0700 (Pacific Daylight Time)">12:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Module loader base has bytecode cache integrated </td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Apr 29 2022 05:25:33 GMT-0700 (Pacific Daylight Time)">12:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">and that will be shared with workers</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Apr 29 2022 05:25:40 GMT-0700 (Pacific Daylight Time)">12:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but it can be turned off if it isn't present</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Apr 29 2022 05:26:11 GMT-0700 (Pacific Daylight Time)">12:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">we can do the same with workers if they bytecode cache isn't necessary -- it would be nice to share all of this so we have a consistent loading scheme</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Apr 29 2022 05:26:34 GMT-0700 (Pacific Daylight Time)">12:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">The service worker is a different story which is unrelated to the script loader, as this is the channel resolution which delegates to the service worker when one is registered.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Apr 29 2022 05:26:34 GMT-0700 (Pacific Daylight Time)">12:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">But, unlike modules, workers have historical way of loading scripts, so I wasn't sure how much depended on what workers was doing</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Apr 29 2022 05:27:21 GMT-0700 (Pacific Daylight Time)">12:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Service worker is unfortunately interleaved with the main worker -- We do a switch in LoadScript, so if we have a classic worker script we do a network load, if we have a service worker we go into the cache that then calls into the network loader (if it is first load)</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Apr 29 2022 05:27:29 GMT-0700 (Pacific Daylight Time)">12:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I think these should be separated, its hard to make sense of it</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Apr 29 2022 05:27:49 GMT-0700 (Pacific Daylight Time)">12:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">with service worker as a child class of the worker loader, and the worker loader inherits the script loader interface</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Apr 29 2022 05:28:31 GMT-0700 (Pacific Daylight Time)">12:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">But, i'm not touching this yet, as its really deeply intertwined and I don't know how much of the cache behavior is necessary for standard classic workers</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Apr 29 2022 05:29:23 GMT-0700 (Pacific Daylight Time)">12:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Also, service workers has another layer on top which I haven't dug into</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Apr 29 2022 05:30:18 GMT-0700 (Pacific Daylight Time)">12:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">In the past the plan for service workers was to make a passthrough when the fetch function is used, such that the alternate data stream can be used across the service worker.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Apr 29 2022 05:31:30 GMT-0700 (Pacific Daylight Time)">12:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">At one point this was a requirement for WASM. Maybe <span class="nick-14">yury</span> would know.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Apr 29 2022 05:36:27 GMT-0700 (Pacific Daylight Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@yury:mozilla.org">yury</span>&gt;</div></td><td class="msg-cell">At this moment service workers don't participate in fetch() for wasm caching. At this moment alternative stream is used to cache JIT'ed code.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Apr 29 2022 05:48:06 GMT-0700 (Pacific Daylight Time)">12:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">ok, so workers would only get the alternate data stream if they are making request to necko, and without intermediate uses of the service worker.</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Apr 29 2022 05:52:38 GMT-0700 (Pacific Daylight Time)">12:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I suspect we'll revisit some of these questions as we build in-memory cache for stencils, so whatever the simplest approach to getting script-loader refactor landed makes sense. I agree with arai that we should be moving away from using evaluate in general and move more to a point with ScriptLoader works with Stencil structures since they can be parsed/deserialized with far more flexibility</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Apr 29 2022 05:55:33 GMT-0700 (Pacific Daylight Time)">12:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Yes, this was why I was asking, in case there was a reason why we shouldn't share the structures from the DOM loader. Ideally, we can implement the stencil structures in one place and it will be available everywhere</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Apr 29 2022 05:56:44 GMT-0700 (Pacific Daylight Time)">12:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">But, it does look like we still need evaluate in some places, such as setTimeout in workers as arai pointed out</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Apr 29 2022 05:57:28 GMT-0700 (Pacific Daylight Time)">12:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Possibly, we could rename Evaluate and Execute -- its hard to tell what the difference between these two are. Maybe ExecuteJSScript (or execute stencil?) and ExecuteFromSourceBuffer ... not sure</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Fri Apr 29 2022 05:57:53 GMT-0700 (Pacific Daylight Time)">12:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">It may help asking "do we want to really do this from the source buffer in this case" when we come across it during a refactoring</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Fri Apr 29 2022 06:02:34 GMT-0700 (Pacific Daylight Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Or maybe "ParseAndExecute"?</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Fri Apr 29 2022 06:02:46 GMT-0700 (Pacific Daylight Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">to be clear there is an extra step</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Fri Apr 29 2022 06:02:51 GMT-0700 (Pacific Daylight Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">just to make sure, <code>JS::Evaluate</code> is a composite function of <code>CompileToStencil</code> + <code>InstantiateStencil</code> + <code>ExecuteScript</code>.  so during refactoring, it's better thinking with those 3 separate functions</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Fri Apr 29 2022 06:03:17 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Maybe <code>CompileAndExecute</code>? (i think i vaguely remember we have something like this....)</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Fri Apr 29 2022 06:03:26 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yeah, that is better</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Fri Apr 29 2022 06:03:33 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">i guess we can bikeshed the name in a pr</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Fri Apr 29 2022 06:04:11 GMT-0700 (Pacific Daylight Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Ill look into it early next week</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Fri Apr 29 2022 06:04:41 GMT-0700 (Pacific Daylight Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">CompileAndExecute I think is clear enough that we don't need to point out the instantiate step. In general though, I agree with arai that in each place we manage scripts we need to think about what time/thread we want each of Compile, Instantiate, Execute to happen.</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Fri Apr 29 2022 06:06:02 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">right, this is something I am thinking about in the worker case: need a rubber duck moment for a sec..</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Fri Apr 29 2022 06:06:29 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">So, the way workers work is we used to bounce between two runnables: ScriptLoaderRunnable and ScriptExecutorRunnable</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Fri Apr 29 2022 06:06:39 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">In this world, we do compilation on the worker, in ScriptExecutorRunnable</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Fri Apr 29 2022 06:06:46 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">We do the load on ScriptLoaderRunnable</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Fri Apr 29 2022 06:06:52 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ok, so modules. </td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Fri Apr 29 2022 06:07:01 GMT-0700 (Pacific Daylight Time)">13:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Modules need to parse before doing the next request</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Fri Apr 29 2022 06:07:15 GMT-0700 (Pacific Daylight Time)">13:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">My intuition is -- push this to the worker. there is no point in doing this on the main thread</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Fri Apr 29 2022 06:07:37 GMT-0700 (Pacific Daylight Time)">13:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">If the modules are for the worker, that sounds quite reasonable</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Fri Apr 29 2022 06:07:38 GMT-0700 (Pacific Daylight Time)">13:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">don't do it in one pass on the main thread. This has a bunch of implications like who owns requests etc</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Fri Apr 29 2022 06:08:07 GMT-0700 (Pacific Daylight Time)">13:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> If the modules are for the worker, that sounds quite reasonable</blockquote></mx-reply>Ok, good -- I have sometimes gone back and forth on this, because this deviates from what we do on the DOM</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Fri Apr 29 2022 06:08:27 GMT-0700 (Pacific Daylight Time)">13:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I think it makes sense to push this to the worker, maybe we would also do this in the dom and push to an available thread</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Fri Apr 29 2022 06:08:30 GMT-0700 (Pacific Daylight Time)">13:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">or maybe not?</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Fri Apr 29 2022 06:09:10 GMT-0700 (Pacific Daylight Time)">13:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">we <em>do</em> do the async compile step on a worker in the DOM anyway..</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Fri Apr 29 2022 06:09:15 GMT-0700 (Pacific Daylight Time)">13:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">actually that makes sense</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Fri Apr 29 2022 06:09:21 GMT-0700 (Pacific Daylight Time)">13:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">(sorry, rubber duck moment as mentioned)</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Fri Apr 29 2022 06:09:28 GMT-0700 (Pacific Daylight Time)">13:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ok, thanks for the sanity check</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Fri Apr 29 2022 06:09:59 GMT-0700 (Pacific Daylight Time)">13:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">It would be cool if we could reuse that machinery, but for now ill do something simpler</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Fri Apr 29 2022 06:10:00 GMT-0700 (Pacific Daylight Time)">13:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I feel some of the oddities from Workers come from the fact that we can just block the world if we are too lazy</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Fri Apr 29 2022 06:10:23 GMT-0700 (Pacific Daylight Time)">13:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yeah, cache work will almost certainly be back in this area soon</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Fri Apr 29 2022 06:11:10 GMT-0700 (Pacific Daylight Time)">13:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I'm almost done with the worekr ScriptLoader refactor, it will closely follow the DOM scriptloader, with the exception of dispatches that push work from one thread to another</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Fri Apr 29 2022 06:11:26 GMT-0700 (Pacific Daylight Time)">13:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">so, hopefully that will make it easier</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Fri Apr 29 2022 06:19:07 GMT-0700 (Pacific Daylight Time)">13:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">:D</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Fri Apr 29 2022 08:01:08 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">What would be nice is to have a unified way, in the JS API, for handling the state related to the compilation and execution of a source.
Whether this is a module, a script, that we want to parse on the main thread or off-thread, or that we delazify on-demand or concurrently.
The CompileOption carry some of this information today, but it only holds the configuration space, not the state linked to handling the execution of it.</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Fri Apr 29 2022 08:02:28 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Then having a state machine, which is either a single function call, or a multi-steps with callers and callbacks … would depend on the consumer, but the compilation state would be handled by this single class.</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Fri Apr 29 2022 11:35:42 GMT-0700 (Pacific Daylight Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">When chaining promises and resolving earlier with a new promise but then rejecting the first promise before resolving the latter one, how does JS engine keep track whether the first promise was already resolved (with a pending promise)?</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Fri Apr 29 2022 11:36:24 GMT-0700 (Pacific Daylight Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">(I'm trying to figure out why there is a difference here when dealing with promises on Gecko side)</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Fri Apr 29 2022 11:40:27 GMT-0700 (Pacific Daylight Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><a href="http://mozilla.pettay.fi/scheduler.html">http://mozilla.pettay.fi/scheduler.html</a> is the testcase</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Fri Apr 29 2022 12:24:35 GMT-0700 (Pacific Daylight Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: it sounds like a bug around optimization.  <a href="https://tc39.es/ecma262/#sec-promise-resolve-functions">Promise Resolve Function</a> steps 4-6 tracks the whether the promise is already resolved or not (even with pending promise).  we <a href="https://searchfox.org/mozilla-central/rev/6d3bc9da27904dbf6f6defda81019916235b8dd5/js/src/builtin/Promise.cpp#1168-1187">do that in the resolve function</a>, but we have <a href="https://searchfox.org/mozilla-central/rev/6d3bc9da27904dbf6f6defda81019916235b8dd5/js/src/builtin/Promise.cpp#1613">an optimization not to create the function</a>, and in that case, we <a href="https://searchfox.org/mozilla-central/rev/6d3bc9da27904dbf6f6defda81019916235b8dd5/js/src/builtin/Promise.cpp#6058-6059">skip some steps of resolve function</a></td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Fri Apr 29 2022 12:27:32 GMT-0700 (Pacific Daylight Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, in that case, <code>B.then(resolve_for_A, reject_for_A)</code> is <a href="https://searchfox.org/mozilla-central/rev/6d3bc9da27904dbf6f6defda81019916235b8dd5/js/src/builtin/Promise.cpp#2202-2212">called in a promise reaction job</a>, and <code>A</code> is left pending until <code>B</code> is resolved</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Fri Apr 29 2022 12:29:18 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and <code>A</code> can be resolved with different value until that point</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Fri Apr 29 2022 12:32:04 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or maybe it's hitting similar issue by directly calling <a href="https://searchfox.org/mozilla-central/rev/6d3bc9da27904dbf6f6defda81019916235b8dd5/js/src/builtin/Promise.cpp#1047"><code>ResolvePromiseInternal</code></a></td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Fri Apr 29 2022 12:33:30 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">smaug</span>: if you've already filed a bug, CC me</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Fri Apr 29 2022 14:24:34 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: ah, yes, I was just running and while doing that I thought that perhaps this is an optimization issue 🙂  Haven't filed a bug yet.</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Fri Apr 29 2022 14:25:40 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: not sure about the component. Is this on JS engine side or should Gecko pass some flag to spidermonkey to disable the optimization?</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Fri Apr 29 2022 14:25:44 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">I'll cc you anyhow</td></tr>

</tbody></table></div></div></div>
</body></html>