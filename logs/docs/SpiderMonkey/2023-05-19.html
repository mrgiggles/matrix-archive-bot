<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-05-19</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-05-19<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-05-18" class="nav-link"><span>prev</span></a>
<a href="2023-05-22" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri May 19 2023 06:33:45 GMT-0700 (Pacific Daylight Time)">13:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I have a class which overrides BaseProxyBandler, and I'm a bit confused about when the various virtual functions are called for getting and setting properties. Right now, I'm overriding <code>getOwnPropertyDescriptor()</code>, and all of the get and set functions seem to go through that. So far so good. But now I want some extra flexibility with setting properties, so I am overriding <code>set()</code>, but this function never gets called. It's the same with <code>defineProperty()</code>. Why is that?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri May 19 2023 06:34:27 GMT-0700 (Pacific Daylight Time)">13:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I have made sure that <code>hasPrototype</code> is false.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri May 19 2023 07:16:53 GMT-0700 (Pacific Daylight Time)">14:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: so e.g. <code>proxy.a = 1</code> doesn't invoke the set hook?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri May 19 2023 07:24:08 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">That's right. It goes through getOwnPropertyDescriptor(), but not through set()</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri May 19 2023 07:25:58 GMT-0700 (Pacific Daylight Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Show your code</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri May 19 2023 07:26:55 GMT-0700 (Pacific Daylight Time)">14:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">oof, there's a lot of it.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri May 19 2023 07:27:19 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">just a sec</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri May 19 2023 07:27:21 GMT-0700 (Pacific Daylight Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">otherwise just step through Proxy::set</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri May 19 2023 07:29:32 GMT-0700 (Pacific Daylight Time)">14:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Here's the code: <a href="https://pastebin.mozilla.org/ZgvasStW">https://pastebin.mozilla.org/ZgvasStW</a></td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri May 19 2023 07:30:48 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> otherwise just step through Proxy::set</blockquote></mx-reply>I have trouble with that because Visual Studio will only let me set a breakpoint in my own code. I can step into Spidermonkey code, but I can't set a breakpoint there.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri May 19 2023 07:33:33 GMT-0700 (Pacific Daylight Time)">14:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">Not sure why it doesn't work. You probably want to invest in getting a working debugger</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri May 19 2023 08:01:19 GMT-0700 (Pacific Daylight Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">I thought it was normal that Visual studio couldn't set a breakpoint inside a dll. If anyone knows how, I'd love to hear it.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri May 19 2023 08:02:42 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">But i think I'm just getting caught up here with some the wrong settings or overrides of the BaseProxyHandler class. There are so many virtual functions and optimisations. In particular, the hasPrototype argument says that it will bypass the set() methods. I've switched that off, but it still doesn't seem to work. I must be missing something.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri May 19 2023 10:30:33 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-10">jandem</span>: <span class="nick-2">mgaudet</span>: <span class="nick-4">iain</span>: Looking around, I think what makes sense would be to reserve a region as large as the code region where we can allocate constant pages as needed. Thus the code would still use RIP but all the constants would be shove into these constant regions which would be flagged as read-only while the code is X-only.</p>
<p>Looking at ARM64, this might also be applicable if we wanted to remove constant pools, which sounds highly appealing to me! The cost is an extra <code>ADRP</code> instruction per constant load.</p>
<p>Allocating these constant regions would add a bit more complexity to our JIT code allocations, but this sounds manageable. There might be corner cases due to the signess of relative offset, implying that we might have constant before and after our code region on x64 if we want to avoid fragmentation cases (when the JIT area is full, or we could just discard this case)</p>
</td></tr>

</tbody></table></div></div></div>
</body></html>