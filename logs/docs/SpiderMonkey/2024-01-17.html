<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-01-17</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-01-17<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-01-16" class="nav-link"><span>prev</span></a>
<a href="2024-01-18" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Jan 17 2024 01:24:28 GMT-0800 (Pacific Standard Time)">09:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gkw:mozilla.org">gkw</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1875032">https://bugzilla.mozilla.org/show_bug.cgi?id=1875032</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Jan 17 2024 01:24:45 GMT-0800 (Pacific Standard Time)">09:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gkw:mozilla.org">gkw</span>&gt;</div></td><td class="msg-cell">not sure how to start, but it's late here and I'll see what I can do</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Jan 17 2024 01:36:27 GMT-0800 (Pacific Standard Time)">09:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">gkw</span>: I'll take a look. I might be able to figure this out from the stack trace</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Jan 17 2024 07:04:52 GMT-0800 (Pacific Standard Time)">15:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@caleb.distributive:mozilla.org">caleb.distributive</span>&gt;</div></td><td class="msg-cell">Hey folks, I'm embedding SpiderMonkey, and was wondering how I might go about running code when an arbitrary object is finalized. I have some object that depends on a resource I control, and all I want to do is decrement a counter when the object finalizes.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Jan 17 2024 07:08:34 GMT-0800 (Pacific Standard Time)">15:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">you can use <a href="https://searchfox.org/mozilla-central/rev/1aa61dcd48e128a8cbfbe59b7ba43d31bd3c248a/js/public/Class.h#593,601">JSClassOps::finalize</a>, (<a href="https://searchfox.org/mozilla-central/rev/1aa61dcd48e128a8cbfbe59b7ba43d31bd3c248a/js/public/Class.h#293-298">JSFinalizeOp</a>)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Jan 17 2024 07:09:15 GMT-0800 (Pacific Standard Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, to be clear, it's not actually for "arbitrary object".  but for objects that has your own <code>JSClass</code></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Jan 17 2024 07:09:44 GMT-0800 (Pacific Standard Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@caleb.distributive:mozilla.org">caleb.distributive</span>&gt;</div></td><td class="msg-cell">yeah I'd like to be able to do this even for JSClasses that are not my own, ideally</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jan 17 2024 07:13:38 GMT-0800 (Pacific Standard Time)">15:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@caleb.distributive:mozilla.org">caleb.distributive</span>&gt;</div></td><td class="msg-cell">is there a way to tell in a JSFinalizeCallback or a JSGCCallback when a given object is about to be finalized?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jan 17 2024 07:17:50 GMT-0800 (Pacific Standard Time)">15:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">how about putting an object with your JSClass into the "given object"'s property?  so that your object will also be finalized at almost same time as the "given object"</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jan 17 2024 07:20:48 GMT-0800 (Pacific Standard Time)">15:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@caleb.distributive:mozilla.org">caleb.distributive</span>&gt;</div></td><td class="msg-cell">ah, yes that could work</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jan 17 2024 07:20:55 GMT-0800 (Pacific Standard Time)">15:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@caleb.distributive:mozilla.org">caleb.distributive</span>&gt;</div></td><td class="msg-cell">thats clever, thanks!</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jan 17 2024 07:29:15 GMT-0800 (Pacific Standard Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">There's also <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry</a> </td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jan 17 2024 09:54:18 GMT-0800 (Pacific Standard Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@sonarshroom:mozilla.org">sonarshroom</span>&gt;</div></td><td class="msg-cell">My issue from yesterday was fully resolved, so thanks again for all the help! I do have another question now though. In our old version of SM, 36 we had in our JSClass a function to destroy some private data associated to the object when it was destroyed called JSDestructor mapped to it's finalize member. In the newer versions is this the finalize member of the js::ObjectOps class?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jan 17 2024 09:58:24 GMT-0800 (Pacific Standard Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@sonarshroom:mozilla.org">sonarshroom</span>&gt;</div></td><td class="msg-cell">Oh I think it is, just saw that finalize message :D</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jan 17 2024 12:01:34 GMT-0800 (Pacific Standard Time)">20:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> how about putting an object with your JSClass into the "given object"'s property?  so that your object will also be finalized at almost same time as the "given object"</blockquote></mx-reply>yeah, you have roughly 3 options. I would order them by preference: first is to use a plain property as arai said, probably a non-enumerable property. If that isn't possible or desired, use a <code>WeakMap</code> to map from your random object to your finalizable object. That's <code>WeakMap</code>'s usual usage: a way to decorate an object with information that can go away if the key goes away. Only if that is problematic for some reason would I reach for <code>FinalizationRegistry</code>. It has some weird timing, exposes internal details, and is relatively easy to mess up and end up making things uncollectable.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jan 17 2024 12:02:25 GMT-0800 (Pacific Standard Time)">20:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(note that if the plain property's name could collide with something else in the property, you can always key it off of a <code>Symbol</code> instead.)</td></tr>

</tbody></table></div></div></div>
</body></html>