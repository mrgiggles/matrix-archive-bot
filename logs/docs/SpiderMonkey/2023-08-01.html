<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-08-01</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-08-01<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-07-31" class="nav-link"><span>prev</span></a>
<a href="2023-08-02" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Aug 01 2023 02:31:57 GMT-0700 (Pacific Daylight Time)">09:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">I've now followed the build local process for the js shell, but using the MOZCONFIG <span class="nick-10">jandem</span> provided, I get the following error: <a href="https://paste.mozilla.org/bvymMdab">https://paste.mozilla.org/bvymMdab</a><br>My guess is that it can't find wasm as the target. What do I have to do to fix this?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Aug 01 2023 02:36:46 GMT-0700 (Pacific Daylight Time)">09:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">can you pastebin your mozconfig file? there seems to be a syntax issue</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Aug 01 2023 02:37:16 GMT-0700 (Pacific Daylight Time)">09:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell"><a href="https://paste.mozilla.org/rKrOqzko">https://paste.mozilla.org/rKrOqzko</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Aug 01 2023 02:38:49 GMT-0700 (Pacific Daylight Time)">09:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">and that's in C:/mozilla-source/MOZCONFIG ?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Aug 01 2023 02:42:01 GMT-0700 (Pacific Daylight Time)">09:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the error is <code>C:/mozilla-source/MOZCONFIG: Zeile 3: $'\342\200\213': Kommando nicht gefunden.</code>. Maybe a file encoding issue?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Aug 01 2023 02:43:13 GMT-0700 (Pacific Daylight Time)">09:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">The file is encoded in UTF-8. I guess that's correct?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Aug 01 2023 02:44:26 GMT-0700 (Pacific Daylight Time)">09:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">Ah wait, was editing the file with notepad++ before but when editing with VS Code, it shows me there are invisible characters. ðŸ˜‚</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Aug 01 2023 02:44:54 GMT-0700 (Pacific Daylight Time)">09:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">ah that explains it</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Aug 01 2023 02:45:33 GMT-0700 (Pacific Daylight Time)">09:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">Now, I get this error: <a href="https://paste.mozilla.org/YvnTwyDK">https://paste.mozilla.org/YvnTwyDK</a></td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Aug 01 2023 02:47:46 GMT-0700 (Pacific Daylight Time)">09:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">you could try removing that flag. I just tested the mozconfig I pasted yesterday and it's building now though</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Aug 01 2023 02:48:05 GMT-0700 (Pacific Daylight Time)">09:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I'm not sure if the wasi build will work on windows. I've only tested it on Linux and our CI build runs on linux too</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Aug 01 2023 02:49:44 GMT-0700 (Pacific Daylight Time)">09:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">Will have to see, otherwise I guess I have to switch to wsl. Got this error now: ERROR: Cannot find a Visual C++ install for e.g. ATL headers.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Aug 01 2023 03:34:52 GMT-0700 (Pacific Daylight Time)">10:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell"><p>Hello folks, we are seeing crashes when pausing in the Browser Toolbox debugger, when inspecting a regular DevTools toolbox (pausing in <a href="https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/devtools/server/actors/page-style.js#523">page-style.js</a>)<br>Here's the crash information:</p>
<pre><code>Crashed Thread:        0  MainThread  Dispatch queue: com.apple.main-thread

Exception Type:        EXC_BAD_ACCESS (SIGSEGV)
Exception Codes:       KERN_INVALID_ADDRESS at 0x0000000000000008
Exception Codes:       0x0000000000000001, 0x0000000000000008

Termination Reason:    Namespace SIGNAL, Code 11 Segmentation fault: 11
Terminating Process:   exc handler [73419]

VM Region Info: 0x8 is not in any region.  Bytes before following region: 105553518919672
      REGION TYPE                    START - END         [ VSIZE] PRT/MAX SHRMOD  REGION DETAIL
      UNUSED SPACE AT START
---&gt;  
      MALLOC_NANO (reserved)   600018000000-600020000000 [128.0M] rw-/rwx SM=NUL  ...(unallocated)

Kernel Triage:
VM - (arg = 0x0) pmap_enter retried due to resource shortage
VM - (arg = 0x0) pmap_enter retried due to resource shortage
VM - (arg = 0x0) pmap_enter retried due to resource shortage
VM - (arg = 0x0) pmap_enter retried due to resource shortage
VM - (arg = 0x0) pmap_enter retried due to resource shortage


Thread 0 Crashed:: MainThread Dispatch queue: com.apple.main-thread
0   XUL                           	       0x11ae76760 js::Scope::firstFrameSlot() const + 8
1   XUL                           	       0x11e882984 (anonymous namespace)::DebugEnvironmentProxyHandler::handleUnaliasedAccess(JSContext*, JS::Handle&lt;js::DebugEnvironmentProxy*&gt;, JS::Handle&lt;js::EnvironmentObject*&gt;, JS::Handle&lt;JS::PropertyKey&gt;, (anonymous namespace)::DebugEnvironmentProxyHandler::Action, JS::MutableHandle&lt;JS::Value&gt;, (anonymous namespace)::DebugEnvironmentProxyHandler::AccessResult*) const + 1012
2   XUL                           	       0x11e87d110 js::DebugEnvironmentProxy::getMaybeSentinelValue(JSContext*, JS::Handle&lt;js::DebugEnvironmentProxy*&gt;, JS::Handle&lt;JS::PropertyKey&gt;, JS::MutableHandle&lt;JS::Value&gt;) + 440
3   XUL                           	       0x11e95ec44 js::DebuggerEnvironment::getVariable(JSContext*, JS::Handle&lt;js::DebuggerEnvironment*&gt;, JS::Handle&lt;JS::PropertyKey&gt;, JS::MutableHandle&lt;JS::Value&gt;) + 312
4   XUL                           	       0x11e95eae8 js::DebuggerEnvironment::CallData::getVariableMethod() + 244
5   XUL                           	       0x11e95fb30 bool js::DebuggerEnvironment::CallData::ToNative&lt;&amp;js::DebuggerEnvironment::CallData::getVariableMethod()&gt;(JSContext*, unsigned int, JS::Value*) + 196
6   XUL                           	       0x11ad3ca98 js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&amp;, js::MaybeConstruct, js::CallReason) + 3872
7   XUL                           	       0x11ad4d578 js::Interpret(JSContext*, js::RunState&amp;) + 30244
8   XUL                           	       0x11ad3df24 js::Call(JSContext*, JS::Handle&lt;JS::Value&gt;, JS::Handle&lt;JS::Value&gt;, js::AnyInvokeArgs const&amp;, JS::MutableHandle&lt;JS::Value&gt;, js::CallReason) + 1420
9   XUL                           	       0x11adf3b9c js::fun_apply(JSContext*, unsigned int, JS::Value*) + 576
10  XUL                           	       0x11ad3ca98 js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&amp;, js::MaybeConstruct, js::CallReason) + 3872
11  XUL                           	       0x11b0fffe4 js::jit::DoCallFallback(JSContext*, js::jit::BaselineFrame*, js::jit::ICFallbackStub*, unsigned int, JS::Value*, JS::MutableHandle&lt;JS::Value&gt;) + 1028
</code></pre>
<p>does this look familiar to someone?<br>I tried to run mozregression and the app crash is not consistent (got some tab crash too), but it seems to be within this range: <a href="https://hg.mozilla.org/integration/autoland/pushloghtml?fromchange=0a238650aa096b0da883226d02d11fc5178541f3&amp;tochange=195161a06a7a71dbce0ee5e8ddb8c84f3cb03df7">https://hg.mozilla.org/integration/autoland/pushloghtml?fromchange=0a238650aa096b0da883226d02d11fc5178541f3&amp;tochange=195161a06a7a71dbce0ee5e8ddb8c84f3cb03df7</a></p>
</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Aug 01 2023 03:39:52 GMT-0700 (Pacific Daylight Time)">10:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">okay, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1845270">https://bugzilla.mozilla.org/show_bug.cgi?id=1845270</a> looks like the regressor, I'll file a bug</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Aug 01 2023 03:41:47 GMT-0700 (Pacific Daylight Time)">10:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: Okay, so I was able to build it on windows. Problem is that after looking into the js.cpp and getting stunned by 12k lines, I think implementing wasm imports for wasm is way out of my skillset. I still would love to see this feature so could you guide me on where to create a feature request for this so the idea can be discussed further?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Aug 01 2023 03:45:20 GMT-0700 (Pacific Daylight Time)">10:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> okay, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1845270">https://bugzilla.mozilla.org/show_bug.cgi?id=1845270</a> looks like the regressor, I'll file a bug</blockquote></mx-reply><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1846487">https://bugzilla.mozilla.org/show_bug.cgi?id=1846487</a></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Aug 01 2023 03:46:39 GMT-0700 (Pacific Daylight Time)">10:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-11">nitwel</span>: filing a new bug either <a href="https://github.com/mozilla-spidermonkey/sm-wasi-demo">here</a> or <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Core&amp;component=JavaScript%20Engine">here</a> would work</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Aug 01 2023 03:56:14 GMT-0700 (Pacific Daylight Time)">10:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@nitwel:mozilla.org">nitwel</span>&gt;</div></td><td class="msg-cell">Thanks for all the help, submitted an issue to the github repo.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Aug 01 2023 09:01:44 GMT-0700 (Pacific Daylight Time)">16:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I'm trying to get the resolve hook to be called, but I'm not seeing it in the logs.  What exactly am I doing wrong. (I know that I'm returning the wrong value from testResolveHook.  I just want to verify that it is run when I attempt an import)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Aug 01 2023 09:25:15 GMT-0700 (Pacific Daylight Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> sent an image.</blockquote></mx-reply>Our util::ExecuteCode function sets some compile options.  Maybe it has something to do with that.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Aug 01 2023 10:02:55 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what function do you call to compile the code?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Aug 01 2023 10:03:24 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">JS::Evaluate</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Aug 01 2023 10:10:54 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it compiles given source as global script. the import declaration is available only in module.  module and global script are different compile target</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Aug 01 2023 10:11:24 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> it compiles given source as global script. the import declaration is available only in module.  module and global script are different compile target</blockquote></mx-reply>Oh.  Then what happens when an import statement is executed in a global script?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Aug 01 2023 10:11:35 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">It's just not there at all?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Aug 01 2023 10:11:36 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's simply a syntax error</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Aug 01 2023 10:12:12 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">That seems really strange.  How else can you get functionality from modules?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Aug 01 2023 10:13:25 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p><a href="https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/public/Modules.h#168-174">https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/public/Modules.h#168-174</a></p>
<pre><code class="language-cpp">/**
 * Parse the given source buffer as a module in the scope of the current global
 * of cx and return a source text module record.
 */
extern JS_PUBLIC_API JSObject* CompileModule(
    JSContext* cx, const ReadOnlyCompileOptions&amp; options,
    SourceText&lt;char16_t&gt;&amp; srcBuf);
</code></pre>
</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Aug 01 2023 10:13:32 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p><a href="https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/public/Modules.h#203-211">https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/public/Modules.h#203-211</a></p>
<pre><code class="language-cpp">/*
 * Perform the ModuleLink operation on the given source text module record.
 *
 * This transitively resolves all module dependencies (calling the
 * HostResolveImportedModule hook) and initializes the environment record for
 * the module.
 */
extern JS_PUBLIC_API bool ModuleLink(JSContext* cx,
                                     Handle&lt;JSObject*&gt; moduleRecord);
</code></pre>
</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Aug 01 2023 10:13:38 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p><a href="https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/public/Modules.h#213-226">https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/public/Modules.h#213-226</a></p>
<pre><code class="language-cpp">/*
 * Perform the ModuleEvaluate operation on the given source text module record
 * and returns a bool. A result value is returned in result and is either
 * undefined (and ignored) or a promise (if Top Level Await is enabled).
 *
 * If this module has already been evaluated, it returns the evaluation
 * promise. Otherwise, it transitively evaluates all dependences of this module
 * and then evaluates this module.
 *
 * ModuleLink must have completed prior to calling this.
 */
extern JS_PUBLIC_API bool ModuleEvaluate(JSContext* cx,
                                         Handle&lt;JSObject*&gt; moduleRecord,
                                         MutableHandleValue rval);
</code></pre>
</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Aug 01 2023 10:13:52 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, I see.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Aug 01 2023 10:14:16 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>example in <a href="https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/src/shell/ModuleLoader.cpp#485">https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/src/shell/ModuleLoader.cpp#485</a></p>
<pre><code class="language-cpp">module = JS::CompileModule(cx, options, srcBuf);
</code></pre>
<p><a href="https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/src/shell/ModuleLoader.cpp#186,190">https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/src/shell/ModuleLoader.cpp#186,190</a></p>
<pre><code class="language-cpp">if (!JS::ModuleLink(cx, module)) {
...
return JS::ModuleEvaluate(cx, module, rval);
</code></pre>
</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Aug 01 2023 11:46:07 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>example in <a href="https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/src/shell/ModuleLoader.cpp#485">https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/src/shell/ModuleLoader.cpp#485</a></p>
<pre><code class="language-cpp">module = JS::CompileModule(cx, options, srcBuf);
</code></pre>
<p><a href="https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/src/shell/ModuleLoader.cpp#186,190">https://searchfox.org/mozilla-central/rev/4044c34031d035fadb588143297ba5421419d44b/js/src/shell/ModuleLoader.cpp#186,190</a></p>
<pre><code class="language-cpp">if (!JS::ModuleLink(cx, module)) {
...
return JS::ModuleEvaluate(cx, module, rval);
</code></pre>
</blockquote></mx-reply><p>I have some Questions:</p>
<ol>
<li>Is ModuleInstantiate the old name for ModuleLink?  That's the closest I can find in my mozjs version.</li>
<li>What is the purpose of the second parameter in the resolve hook?</li>
</ol>
</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Aug 01 2023 12:00:20 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-15">arai</span>:  I'm still failing to properly load a module with this code.  What am I doing wrong?</p>
<pre><code>JSObject* testResolveHook(JSContext* ctx, JS::HandleValue referencingPrivate, JS::HandleObject requestArg) {

    JS::RootedValue jsModName{ctx};
    jsModName.setString(JS::GetModuleRequestSpecifier(ctx, requestArg));
    std::string modName;
    if (conversions::FromJs(ctx, jsModName, modName)) {
        LogInfo() &lt;&lt; "Loading module with name: " &lt;&lt; modName;
    }

    JS::CompileOptions options{ctx};
    options.topLevelAwait = false;

    const std::string modSrc {R"js(
        let a = 1;
        let b = "b";

        export {a,b};
    )js"};

    JS::SourceText&lt;mozilla::Utf8Unit&gt; source;
    if (!source.init(ctx, modSrc.c_str(), modSrc.size(), JS::SourceOwnership::Borrowed)) {
        LogError() &lt;&lt; "Could not initialize source buffer.";
        return nullptr;
    }

    return JS::CompileModule(ctx, options, source);
}


TEST_F(TestModules, resolveHook) {

    JS::SetModuleResolveHook(JS_GetRuntime(ctx()), testResolveHook);

    const std::string testSrc {
        R"js(
            import {a, b} from "fhtagn";
            print(`Got values a: ${a} and b: ${b}`);
        )js" 
    };

    JS::CompileOptions options{ctx()};
    options.topLevelAwait = false;
    JS::SourceText&lt;mozilla::Utf8Unit&gt; source;
    ASSERT_TRUE(source.init(ctx(), testSrc.c_str(), testSrc.size(), JS::SourceOwnership::Borrowed));
    JS::RootedObject modRec{ctx(), JS::CompileModule(ctx(), options, source)};
    ASSERT_NE(modRec.get(), nullptr);
    LogInfo() &lt;&lt; "Mark 1";

    ASSERT_TRUE(JS::ModuleInstantiate(ctx(), modRec));
    LogInfo() &lt;&lt; "Mark 2";

    JS::RootedValue rVal{ctx()};
    ASSERT_TRUE(JS::ModuleEvaluate(ctx(), modRec, &amp;rVal));  // This is where it fails (line 90 in the original file)

    LogInfo() &lt;&lt; "Mark 3";
}
</code></pre>
<p>I get this output:</p>
<pre><code> [ RUN      ] TestModules.resolveHook
1: 79814.1057   000 UT   DFLT 12993 info    [Mark 1]
1: 79814.1568   001 UT   DFLT 12993 info    [Loading module with name:  fhtagn]
1: 79814.1923   003 UT   DFLT 12993 info    [Loading module with name:  fhtagn]
1: /home/kwheel28-local/host_workspace/JsBindings/jsbindings/impl/test/src/Test_Modules.cpp:90: Failure
</code></pre>
<p>For some reason, it tries to load it twice.</p>
</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Aug 01 2023 12:05:08 GMT-0700 (Pacific Daylight Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what happens if you don't use import declaration?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Aug 01 2023 12:06:17 GMT-0700 (Pacific Daylight Time)">19:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> what happens if you don't use import declaration?</blockquote></mx-reply>Let me try it.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Aug 01 2023 12:08:51 GMT-0700 (Pacific Daylight Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> what happens if you don't use import declaration?</blockquote></mx-reply>It works fine.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Aug 01 2023 12:15:01 GMT-0700 (Pacific Daylight Time)">19:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It works fine.</blockquote></mx-reply>Of course, I changed the code not to reference a and b, which are exported from "fhtagn".  But other than that, it works fine.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Aug 01 2023 13:21:29 GMT-0700 (Pacific Daylight Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Does anyone know what step I may be missing in the module-loading code I pasted earlier?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Aug 01 2023 13:24:31 GMT-0700 (Pacific Daylight Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Does anyone know what step I may be missing in the module-loading code I pasted earlier?</blockquote></mx-reply><span class="nick-15">arai</span>:   Sorry to bother you again, but I'm really stumped here.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Aug 01 2023 14:31:11 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I have some Questions:</p>
<ol>
<li>Is ModuleInstantiate the old name for ModuleLink?  That's the closest I can find in my mozjs version.</li>
<li>What is the purpose of the second parameter in the resolve hook?</li>
</ol>
</blockquote></mx-reply><ol>
<li>Yes,  2. the value you can set with <a href="https://searchfox.org/mozilla-central/rev/7a642b487e4b93309285e2eb235f87a0d4b86518/js/public/Modules.h#188">JS::SetModulePrivate</a>, which can be used to associate embedding-specific data to the importer module</li>
</ol>
</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Aug 01 2023 14:56:03 GMT-0700 (Pacific Daylight Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">if JSAPI fails, you can get the error details and print it. example in <a href="https://searchfox.org/mozilla-central/rev/7a642b487e4b93309285e2eb235f87a0d4b86518/js/src/shell/js.cpp#9900">AutoReportException</a></td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Aug 01 2023 15:10:41 GMT-0700 (Pacific Daylight Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>then, about the issue, it's because of the <code>testResolveHook</code> doesn't follow the restriction:  <a href="https://searchfox.org/mozilla-central/rev/7a642b487e4b93309285e2eb235f87a0d4b86518/js/public/Modules.h#53,69-71">https://searchfox.org/mozilla-central/rev/7a642b487e4b93309285e2eb235f87a0d4b86518/js/public/Modules.h#53,69-71</a></p>
<pre><code class="language-cpp">* The HostResolveImportedModule hook.
...
* This hook must obey the restrictions defined in the spec:
*  - Each time the hook is called with the same arguemnts, the same module must
*    be returned.
</code></pre>
</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Aug 01 2023 15:11:08 GMT-0700 (Pacific Daylight Time)">22:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>per spec, the hook is called twice <a href="https://searchfox.org/mozilla-central/rev/7a642b487e4b93309285e2eb235f87a0d4b86518/js/src/vm/Modules.cpp#1154-1157">https://searchfox.org/mozilla-central/rev/7a642b487e4b93309285e2eb235f87a0d4b86518/js/src/vm/Modules.cpp#1154-1157</a></p>
<pre><code class="language-cpp">// Step 9.a. Let requiredModule be ? HostResolveImportedModule(module,
//           required).
requiredModule = HostResolveImportedModule(cx, module, moduleRequest,
                                           ModuleStatus::Unlinked);
</code></pre>
<p><a href="https://searchfox.org/mozilla-central/rev/7a642b487e4b93309285e2eb235f87a0d4b86518/js/src/vm/Modules.cpp#954-958">https://searchfox.org/mozilla-central/rev/7a642b487e4b93309285e2eb235f87a0d4b86518/js/src/vm/Modules.cpp#954-958</a></p>
<pre><code class="language-cpp">// Step 7.a. Let importedModule be ! HostResolveImportedModule(module,
//           in.[[ModuleRequest]]).
moduleRequest = in.moduleRequest();
importedModule = HostResolveImportedModule(cx, module, moduleRequest,
                                           ModuleStatus::Linking);
</code></pre>
</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Aug 01 2023 15:11:25 GMT-0700 (Pacific Daylight Time)">22:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and the hook must return the same object for those 2 calls</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Aug 01 2023 15:12:01 GMT-0700 (Pacific Daylight Time)">22:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, you need to have a map from the request to the module, and return the same one if the request is already handled</td></tr>

</tbody></table></div></div></div>
</body></html>