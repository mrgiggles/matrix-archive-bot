<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-06-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-06-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-06-06" class="nav-link"><span>prev</span></a>
<a href="2023-06-08" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jun 06 2023 19:58:28 GMT-0700 (Pacific Daylight Time)">02:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@luyahan:mozilla.org">luyahan</span>&gt;</div></td><td class="msg-cell">Hi all I open a patch a month Ago <a href="https://phabricator.services.mozilla.com/D175022">https://phabricator.services.mozilla.com/D175022</a>. But the patch doesn't be landed. What I miss?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jun 06 2023 20:28:53 GMT-0700 (Pacific Daylight Time)">03:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">luyahan</span>: Sorry, most of us are used to reviewing patches from people who have Lando access and can land their own patches once they've been approved. If your reviewer has approved the patch but forgotten to land it, please leave a comment on Phabricator or in this channel, and somebody can land it for you.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jun 06 2023 20:29:07 GMT-0700 (Pacific Daylight Time)">03:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I queued your patch for landing.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Jun 07 2023 12:37:01 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: <a href="https://phabricator.services.mozilla.com/D180244">https://phabricator.services.mozilla.com/D180244</a> The review request there is more an f? than an r?  (So feel free to sit on it for a while)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Jun 07 2023 12:37:54 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I skimmed it already. Looks a lot better than my initial stab at it.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Jun 07 2023 12:38:19 GMT-0700 (Pacific Daylight Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">tiny bit of unnecessary rooting for the TryGeneric return value</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Jun 07 2023 12:39:00 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess I should be saying that on the patch. I wasn't sure if you wanted comments yet.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jun 07 2023 12:40:19 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but yeah, I'm doing my last-minute self-review right now, so I'll come back to your patch a bit later</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jun 07 2023 12:40:30 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(or when I need a larger chunk of procrastination time)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jun 07 2023 12:47:03 GMT-0700 (Pacific Daylight Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">Sound good :) </td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jun 07 2023 13:52:44 GMT-0700 (Pacific Daylight Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><p>hey everyone!<br>Is it possible to somehow remove queued promises? Or maybe add a custom check before their execution?<br>Context:</p>
<ul>
<li>Script is executed within a context and associated global.</li>
<li>During execution script enqueues promises.</li>
<li>During the same execution mentioned global dies.</li>
<li>Promises are then processed via <code>RunJobs()</code>. (i.e. <code>UseInternalJobQueues</code> was initialized)</li>
<li>Promise handler invokes methods that point to the dead global and everything explodes.</li>
</ul>
</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jun 07 2023 13:56:24 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">PS: I'm really surprised that I've discovered this bug only now, despite my program being (somewhat) actively used for several years already...</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jun 07 2023 14:34:10 GMT-0700 (Pacific Daylight Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I don't know enough about Promises to answer, but I would have expected a Promise with a handler that can reach a global to keep that global alive.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jun 07 2023 15:16:04 GMT-0700 (Pacific Daylight Time)">22:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><p>well, original JS global is alive, but all the native things associated with this global are unusable, so when Promise's handler invokes something that depends on those, everything breaks.</p>
<p>Ideally, I want to do smth like <code>ShutdownJsExecutionAssociatedWithGlobal</code>, but AFAIK there's nothing like that available.</p>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jun 07 2023 15:16:44 GMT-0700 (Pacific Daylight Time)">22:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">Of course, there is JS_Shutdown, but it just kills everything xD</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jun 07 2023 15:18:24 GMT-0700 (Pacific Daylight Time)">22:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">One way would be to wrap all native methods and props with some check like <code>IsMyGlobalStillAlive</code>, but that is a huge amount of boilerplate that I'd really like to avoid</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Jun 07 2023 15:19:06 GMT-0700 (Pacific Daylight Time)">22:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">especially since Promises are the only thing that can trigger such scenario</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Jun 07 2023 15:27:11 GMT-0700 (Pacific Daylight Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">maybe you could call <code>interrupt()</code> on the job queue when shutting stuff down? The <a href="https://searchfox.org/mozilla-central/rev/887d4b5da89a11920ed0fd96b7b7f066927a67db/js/src/vm/JSContext.h#94-96">comment</a> sounds promising.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jun 07 2023 15:27:48 GMT-0700 (Pacific Daylight Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hm, I guess you only want to stop jobs for that global</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jun 07 2023 15:27:59 GMT-0700 (Pacific Daylight Time)">22:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jun 07 2023 15:28:54 GMT-0700 (Pacific Daylight Time)">22:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">and InternalJobQueue is not exposed anyway</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jun 07 2023 15:30:40 GMT-0700 (Pacific Daylight Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess the spec specifcally made promises non-cancellable, so I doubt there's going to be some built-in mechanism.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jun 07 2023 15:32:05 GMT-0700 (Pacific Daylight Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">also, our globals can typically access each other, so there's no easy way to test "could this Promise job ever access global X?"</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jun 07 2023 15:32:41 GMT-0700 (Pacific Daylight Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(well, we can nuke a compartment, so actually that wouldn't be too difficult)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jun 07 2023 15:36:58 GMT-0700 (Pacific Daylight Time)">22:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">scenario is really simple tho: there is a window executing the script, user refreshes the window, everything associated with old JS execution should (magically) disappear</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jun 07 2023 15:40:36 GMT-0700 (Pacific Daylight Time)">22:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think we <a href="https://searchfox.org/mozilla-central/source/xpcom/threads/nsThread.cpp#1274">drain the task queue</a> before unloading.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jun 07 2023 15:42:02 GMT-0700 (Pacific Daylight Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess that doesn't explain it</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jun 07 2023 15:43:54 GMT-0700 (Pacific Daylight Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I actually don't know how Firefox deals with it. Probably leaks the global and nulls out any global -&gt; C++ pointers?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Jun 07 2023 15:45:18 GMT-0700 (Pacific Daylight Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">arai would probably know.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Jun 07 2023 15:45:32 GMT-0700 (Pacific Daylight Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">firefox might not have to deal with it at all, since every window is a separate context, iirc</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Jun 07 2023 15:46:05 GMT-0700 (Pacific Daylight Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">every tab*</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Jun 07 2023 15:47:58 GMT-0700 (Pacific Daylight Time)">22:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">is this about the embedding case?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Jun 07 2023 15:48:03 GMT-0700 (Pacific Daylight Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">or Firefox's case</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Jun 07 2023 15:48:21 GMT-0700 (Pacific Daylight Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">embedding</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Jun 07 2023 15:49:28 GMT-0700 (Pacific Daylight Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, your code calls the queued promise reaction jobs, right?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Jun 07 2023 15:50:49 GMT-0700 (Pacific Daylight Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, I misread</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Jun 07 2023 15:51:20 GMT-0700 (Pacific Daylight Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">well, my native code calls <code>RunJobs</code>, which resolves promises, which calls js promise handlers, which calls native code again =) (crashing everything on the way)</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Jun 07 2023 15:51:41 GMT-0700 (Pacific Daylight Time)">22:51</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@arai:mozilla.org">arai</span></div></td><td class="msg-cell">reads the backlog</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Jun 07 2023 15:53:43 GMT-0700 (Pacific Daylight Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">While wrestling with Atomics.waitAsync I spent a lot of time looking at this code: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/OffThreadPromiseRuntimeState.h#30">https://searchfox.org/mozilla-central/source/js/src/vm/OffThreadPromiseRuntimeState.h#30</a></td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Jun 07 2023 15:55:02 GMT-0700 (Pacific Daylight Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Which implements promises resolved from offthread which don't get confused if the context is shutting down</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Jun 07 2023 15:55:49 GMT-0700 (Pacific Daylight Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">context is alive in my case (since it's shared between all windows)</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Jun 07 2023 15:55:55 GMT-0700 (Pacific Daylight Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">TheQwertiest</span>: what does "global dies" actually mean?  what operation is it and which part of it causes "everything explodes"  ?</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Jun 07 2023 15:56:29 GMT-0700 (Pacific Daylight Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">some private data is freed there?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Jun 07 2023 15:56:57 GMT-0700 (Pacific Daylight Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The global is a GC'd object. It shouldn't be collected if there are still references to it.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Jun 07 2023 15:58:58 GMT-0700 (Pacific Daylight Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the global is still alive, it just points to embedding stuff that has been torn down. The request is for an easy way to prevent Promise jobs from running without needing to wrap all global -&gt; C++ accesses. (iiuc)</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Jun 07 2023 15:59:50 GMT-0700 (Pacific Daylight Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell"><ul>
<li>there is a window executing the script</li>
<li>during script execution a lot of native objects are created</li>
<li>user refreshes the window</li>
<li>window refresh makes some old native things become unavailable</li>
<li>old promises invoke handlers from old JS execution, which points to old native things</li>
<li>since those native things are not available anymore, it causes fun stuff like UB, nullptr dereferencing and etc</li>
</ul>
</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Jun 07 2023 16:00:01 GMT-0700 (Pacific Daylight Time)">23:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">yea, this is exactly what I mean</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Jun 07 2023 16:02:27 GMT-0700 (Pacific Daylight Time)">23:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess I should say "to remove the need to wrap all global -&gt; C++ accesses in case the embedding stuff has been torn down"</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Jun 07 2023 16:02:29 GMT-0700 (Pacific Daylight Time)">23:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">simple way is to create your on job queue, instead of internal job queue.  and add a check for the global there.  that's what browser does with Step 2.1 in <a href="https://html.spec.whatwg.org/#hostenqueuepromisejob">https://html.spec.whatwg.org/#hostenqueuepromisejob</a></td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Jun 07 2023 16:02:30 GMT-0700 (Pacific Daylight Time)">23:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>If job settings is not null, then check if we can run script with job settings. If this returns "do not run" then return.</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Jun 07 2023 16:03:23 GMT-0700 (Pacific Daylight Time)">23:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that seems like a good idea to me</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Jun 07 2023 16:05:43 GMT-0700 (Pacific Daylight Time)">23:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>it's done here in browser: <a href="https://searchfox.org/mozilla-central/rev/887d4b5da89a11920ed0fd96b7b7f066927a67db/xpcom/base/CycleCollectedJSContext.cpp#203">https://searchfox.org/mozilla-central/rev/887d4b5da89a11920ed0fd96b7b7f066927a67db/xpcom/base/CycleCollectedJSContext.cpp#203</a></p>
<pre><code class="language-cpp">if (global &amp;&amp; !global-&gt;IsDying()) {
</code></pre>
</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Jun 07 2023 16:06:33 GMT-0700 (Pacific Daylight Time)">23:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">guess this is the only way, thanks for the links =)</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Jun 07 2023 16:06:46 GMT-0700 (Pacific Daylight Time)">23:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@theqwertiest:mozilla.org">TheQwertiest</span>&gt;</div></td><td class="msg-cell">... another DOM thing to replicate ... le sigh ...</td></tr>

</tbody></table></div></div></div>
</body></html>