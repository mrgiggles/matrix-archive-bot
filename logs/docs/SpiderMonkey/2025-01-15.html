<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2025-01-15</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2025-01-15<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-01-14" class="nav-link"><span>prev</span></a>
<a href="2025-01-16" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jan 14 2025 17:16:44 GMT-0800 (Pacific Standard Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">They do indeed do it, you can see it in perfetto.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jan 14 2025 17:39:00 GMT-0800 (Pacific Standard Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><p>So, it turns out the following code behaves differently between the classic script and the module script, due to the characteristics of the global <code>var</code>s, where the classic script's global <code>var</code>s are properties of global object, but the module's global <code>var</code>s are stored into the frame slot by default and has shorter lifetime.</p>
<pre><code class="language-js">var obj = { value: "hello" };
var ref = new WeakRef(obj);
Promise.resolve().then(() =&gt; {
  clearKeptObjects();
  gc();
  console.log(ref.deref()); // classic script shows the object, module shows undefined
});
</code></pre>
<p>Then, if we close over the variable <code>obj</code>, the variable is now stored into the module environment object and now has the longer lifetime.</p>
<pre><code class="language-js">var obj = { value: "hello" };
var ref = new WeakRef(obj);
Promise.resolve().then(() =&gt; {
  clearKeptObjects();
  gc();
  console.log(ref.deref()); // both show the object
});
function f() { obj; }  // mark `obj` closed over, and put it into env obj
</code></pre>
<p>Should we consider this as a problem?  Have we had any bug report with <code>WeakRef</code> and module?</p>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jan 14 2025 17:43:42 GMT-0800 (Pacific Standard Time)">01:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the original context is bug 1940741, where we bumped into something similar to this with XPCOM's weak ref</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jan 14 2025 17:43:43 GMT-0800 (Pacific Standard Time)">01:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1940741">https://bugzil.la/1940741</a> â€” ASSIGNED (arai) â€” DownloadLastDir.sys.mjs should use a strong ref for the observer</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jan 14 2025 19:15:06 GMT-0800 (Pacific Standard Time)">03:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I think this wasn't a problem until <code>WeakRef</code>, because <code>WeakMap</code> and <code>WeakSet</code> don't allow converting weak ref to strong ref, and it always requires strong ref to be preserved to observe the existence of weak ref,  but <code>WeakRef</code> allows this, and the closed-over-ness is now observable</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jan 14 2025 22:01:36 GMT-0800 (Pacific Standard Time)">06:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p>My first instinct is to say that this is covered by <a href="https://tc39.es/ecma262/#sec-weakref-invariants">section 9.9.1 of the spec</a>:</p>
<pre><code>This specification does not make any guarantees that any object or symbol will be garbage collected. Objects or symbols which are not live may be released after long periods of time, or never at all. For this reason, this specification uses the term "may" when describing behaviour triggered by garbage collection.
</code></pre>
<p>The object is otherwise unreachable, and we've cleared kept objects (which IIUC normally requires returning to the event loop), so collecting it should be allowed. And we're always allowed to <em>not</em> collect it. So spec-wise, I think we're okay, unless there's something about global variables in a module script that I'm missing.</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jan 14 2025 22:17:50 GMT-0800 (Pacific Standard Time)">06:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">thx</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jan 15 2025 00:02:48 GMT-0800 (Pacific Standard Time)">08:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">so if I need to run threads, should I call <code>JS::RunHelperThreadTask</code> ?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jan 15 2025 00:05:36 GMT-0800 (Pacific Standard Time)">08:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">I am doing a very localized thing that looks like this right now: <a href="https://pastebin.mozilla.org/uyAGuosQ">https://pastebin.mozilla.org/uyAGuosQ</a>
I suppose it's a bad idea to add this code in a WASM built in like this :)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jan 15 2025 00:31:25 GMT-0800 (Pacific Standard Time)">08:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">Tarek</span>: would bugs 1922194 and 1922223 help?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jan 15 2025 00:39:54 GMT-0800 (Pacific Standard Time)">08:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">haha excellent, thanks <span class="nick-10">jandem</span></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jan 15 2025 00:45:14 GMT-0800 (Pacific Standard Time)">08:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">@sergesanspaille <span class="nick-14">gregtatum</span> <span class="nick-5">marco</span>  nit: when I'll push the work for onnx, this intra-operation thread pool is something I will also want to use outside the context of gemmology (e.g. non-int8 specific operations, pure C++ operations like this DequantizeLinear etc) I wonder if it would be more suited to have it as an utility outside the gemmology namespace.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jan 15 2025 00:46:19 GMT-0800 (Pacific Standard Time)">08:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">I'm glad it helps. I thought you were working in the same area but wasn't sure</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jan 15 2025 00:47:31 GMT-0800 (Pacific Standard Time)">08:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">I am, and I knew Serge was working on adding threading in gemmology eventually, but I did not know there were that patch already. </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jan 15 2025 00:49:22 GMT-0800 (Pacific Standard Time)">08:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>:   by the way, do you know where I could add some performance.marker calls to measure the overhead of calling WASM built ins ? I am experimening a 30 to 40% overhead in round trips, when the op is under 10ms. I am trying to see if something's wrong or if there are ways to improve this part.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jan 15 2025 00:52:03 GMT-0800 (Pacific Standard Time)">08:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">do you have a minimal example that runs in the JS shell? would make it easier to step through it</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Jan 15 2025 00:56:42 GMT-0800 (Pacific Standard Time)">08:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">I do yeah, I also measured it and have some profiles. I have a patch that includes the wasm that calls the new builtin here <a href="https://phabricator.services.mozilla.com/D231910">https://phabricator.services.mozilla.com/D231910</a> it does not have the debug info so you only get the wasm functions address when profiling -- <a href="https://phabricator.services.mozilla.com/D231910">https://phabricator.services.mozilla.com/D231910</a> but I can see a few redirections between my extern call in the WASM and the built-in on our side. I was not sure where to look to understand where it goes.
I also don't know if it's related to the data passed and doing some copies maybe?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Jan 15 2025 00:57:36 GMT-0800 (Pacific Standard Time)">08:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">that makes some of our calls useless because unfortunately ONNX is doing skinny matrix calls that I cannot batch:</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jan 15 2025 01:13:44 GMT-0800 (Pacific Standard Time)">09:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@tarek:mozilla.org">Tarek</span>&gt;</div></td><td class="msg-cell">from a discussion with <span class="nick-10">jandem</span> : I will try to change <a href="https://searchfox.org/mozilla-central/source/js/src/wasm/WasmBuiltins.cpp#1718">https://searchfox.org/mozilla-central/source/js/src/wasm/WasmBuiltins.cpp#1718</a> when I do my calls to see how that changes the overhead -- thx</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jan 15 2025 01:57:58 GMT-0800 (Pacific Standard Time)">09:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">thanks. yeah, it makes sense that it's allowed by the spec.  the remaining concern is that if people are aware of the behavior.  at least with Firefox-internal specific case with JSM, the global <code>var</code>s seem to be used to make the lifetime of the variable match the module lifetime, while using global lexical for others.   .sys.mjs preserved the behavior (partially accidentally.  it was for different purpose), and now I'm about to drop the behavior, and hitting issues with weak refs</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jan 15 2025 01:59:12 GMT-0800 (Pacific Standard Time)">09:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so I wonder similar thing has been happening outside of Firefox-internal, such as common JS to ES module migration</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jan 15 2025 01:59:50 GMT-0800 (Pacific Standard Time)">09:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">(not sure how much WeakRef is widely used tho)</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jan 15 2025 02:14:15 GMT-0800 (Pacific Standard Time)">10:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: , <span class="nick-12">denispal</span>, thanks for confirming -- SM still beats V8 in speed when unrolling manually though, heh</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jan 15 2025 02:14:24 GMT-0800 (Pacific Standard Time)">10:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">16x unroll</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jan 15 2025 04:32:39 GMT-0800 (Pacific Standard Time)">12:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">What's a fast way to extend an existing array in JS? I'm writing a test to grow an array to very large sizes. array.push(0) takes too long and array.push(...other) doesn't seem that much better.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jan 15 2025 04:36:57 GMT-0800 (Pacific Standard Time)">12:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">and jsc completely smokes SM by 2x, that itself beats Chrome by 30% when manually unrolling by 16x, they must do some simd stuff or other magic</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jan 15 2025 04:46:00 GMT-0800 (Pacific Standard Time)">12:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@mayankleoboy1:mozilla.org">mayankleoboy1</span>&gt;</div></td><td class="msg-cell">Somebody in mozilla once said that JSC devs are "ASM Wizards" </td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jan 15 2025 05:04:53 GMT-0800 (Pacific Standard Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Do they still use LLVM as the last stage of compilation (FTL)?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Jan 15 2025 05:09:45 GMT-0800 (Pacific Standard Time)">13:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">they replaced it with B3 (Bare Bones Backend)</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Jan 15 2025 05:11:23 GMT-0800 (Pacific Standard Time)">13:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">anyway, if we can get a memcpy function in regular js, all this would be moot</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Jan 15 2025 07:13:31 GMT-0800 (Pacific Standard Time)">15:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">I'm getting very weird results from trying some simple benchmarking, it shows memory not decreasing after each compartment/global falls off from stack from <code>StencilIteration</code>. Are compartments not supposed to clean up from memory if the main global is still alive?<br><a href="https://paste.mozilla.org/jBoWpgWt">https://paste.mozilla.org/jBoWpgWt</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Jan 15 2025 07:21:28 GMT-0800 (Pacific Standard Time)">15:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it would depend on when the gc is performed.  try explicitly running gc after each call</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Jan 15 2025 07:22:25 GMT-0800 (Pacific Standard Time)">15:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">reference-counted objects are immediately freed when the last reference goes away, but GC objects are not freed immediately</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Jan 15 2025 07:50:25 GMT-0800 (Pacific Standard Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: fwiw, you can also see the LifoAlloc improvement <a href="https://glam.telemetry.mozilla.org/fenix/probe/javascript_ion_compile_time/explore?aggType=avg&amp;ref=2024120912&amp;timeHorizon=ALL&amp;visiblePercentiles=%5B99.9%2C99%2C95%2C75%2C50%2C25%2C5%5D">in telemetry ~10-15%</a> which is quite nice.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Jan 15 2025 07:53:33 GMT-0800 (Pacific Standard Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I would not be surprised if other browsers already had the shorter lifetimes, since that's what the spec implies. If so, there's probably no webcompat issues, because those would already have caused problems in other browsers.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Jan 15 2025 08:15:43 GMT-0800 (Pacific Standard Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">denispal</span>: nice! thanks for checking that</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Jan 15 2025 08:22:25 GMT-0800 (Pacific Standard Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">good point. yes, the shorter lifetime is the default, and having unexpectedly longer lifetime won't be much prominent (except for the case where the "leak"-ish behavior causes extra ram usage), and having unexpectedly shorter lifetime (compared to classic script) should be tested by all engines and envs</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Jan 15 2025 08:23:07 GMT-0800 (Pacific Standard Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I'll focus on the xpcom case and leave the standard case</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Jan 15 2025 10:39:41 GMT-0800 (Pacific Standard Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">is there any example of bytecode being emitted right at the end of a block as in the bytecode emitter knows the closing brace of the block and emits code right before that? iiuc <a href="https://searchfox.org/mozilla-central/source/js/src/frontend/EmitterScope.cpp#1027">EmitterScope::leave()</a> is called at points such as 'return' statement etc etc</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Jan 15 2025 10:40:30 GMT-0800 (Pacific Standard Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@debadree25:mozilla.org">debadree25</span>&gt;</div></td><td class="msg-cell">sorry if the question is not very clear i still havent been able to articulate it clearly in my mind can try providing examples if wanted</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Jan 15 2025 10:42:29 GMT-0800 (Pacific Standard Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">Do we have anything to inspect the generated bytecode or asm for a particular workload at a particular point in time, e.g. after having reached the latest JIT tier? Still related to the memcpy thing</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Jan 15 2025 10:47:29 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">padenot</span>: Shell or browser?</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Jan 15 2025 10:47:57 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">We've been doing experiments in the browser, but I'm not too picky</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Jan 15 2025 10:48:19 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In the shell <code>disnative(fn)</code> will dump the current jit code for <code>fn</code></td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Jan 15 2025 10:48:21 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">just a simple standalone web page that is able to draw some graphs, as things stand, and to repeat a workload</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Jan 15 2025 10:48:41 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">but I can strip the html I suppose</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Jan 15 2025 10:50:01 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In the browser I would consider using <a href="https://gist.github.com/mstange/a8a0943f16f388e3ddc9e726d68c436a">samply</a></td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Jan 15 2025 10:51:38 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">of course samply can do it, heh</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Jan 15 2025 10:51:45 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: thanks!</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Jan 15 2025 10:53:03 GMT-0800 (Pacific Standard Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Note that samply has a known issue where it gives a single version of assembly for each tier, so if you bail out from Ion and recompile then you will not see subsequent versions</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Jan 15 2025 10:53:23 GMT-0800 (Pacific Standard Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But that hopefully won't be a problem if your function is well-behaved</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Jan 15 2025 10:54:10 GMT-0800 (Pacific Standard Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">our particular code here is an example in monomorphism and simplicity</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Jan 15 2025 10:54:40 GMT-0800 (Pacific Standard Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">takes two arrays, copy from one to the other, always the same type, always the same size</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Jan 15 2025 10:54:59 GMT-0800 (Pacific Standard Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">typed array that is</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Jan 15 2025 10:55:16 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">How big are the arrays?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Jan 15 2025 10:55:50 GMT-0800 (Pacific Standard Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">128 elements to a lot more, a few dozen thousands, we've tried a few things</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Jan 15 2025 10:57:07 GMT-0800 (Pacific Standard Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">OSR could cause minor issues if the loop is long enough that we tier up at the loop head, because then we won't have run any code after the loop, so we might bail out at that point</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Jan 15 2025 10:57:16 GMT-0800 (Pacific Standard Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But if there's no code after the loop it should be fine</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Jan 15 2025 10:58:08 GMT-0800 (Pacific Standard Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Anyway, try it out and see what you get. No need to debug problems you don't have</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Jan 15 2025 10:58:09 GMT-0800 (Pacific Standard Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">the loop body is just an unrolled copy of the source array to the dest array, unrolled by <code>n</code>, 16 being the sweet spot. there is a postamble as usual when doing unrolling</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Jan 15 2025 10:58:32 GMT-0800 (Pacific Standard Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">but yeah</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Jan 15 2025 14:58:30 GMT-0800 (Pacific Standard Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><p>There is a specific jsapi-test that's failing for me in a mysterious way: <code>./mach jsapi-tests testSinglyLinkedList</code> is failing on jsapi-tests/testSinglyLinkedList.cpp:36 because the value is 0 instead of 1.<br>However, in Treeherder, this test appears to be passing, even though I have the exact same commit checked out. I've disabled the unified build and sccache with the same failure. It happens in a debug build but not release. If I enable optimizations, it passes. (MOZCONFIG file causing the failing test is attached).</p>
<p>There must be something in my environment that's causing this failure, but I could use some suggestions what it might be.</p>
</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Jan 15 2025 14:59:10 GMT-0800 (Pacific Standard Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Have you done a clobber build?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Jan 15 2025 14:59:39 GMT-0800 (Pacific Standard Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Yes</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Jan 15 2025 15:05:16 GMT-0800 (Pacific Standard Time)">23:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Wild shot in the dark: if you recompile after editing <code>testSinglyLinkedList.cpp</code> in some irrelevant way, does it change anything? My best hypothesis is that something in the build system is causing that test to not be rebuilt.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Jan 15 2025 15:05:20 GMT-0800 (Pacific Standard Time)">23:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Otherwise I have no idea.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Jan 15 2025 15:15:11 GMT-0800 (Pacific Standard Time)">23:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Yeah, I can change the expected value value on that line and see the failure report show the new failure.</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Jan 15 2025 15:15:35 GMT-0800 (Pacific Standard Time)">23:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Blech. Have you checked to see if you were cursed by a witch?</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Jan 15 2025 15:41:40 GMT-0800 (Pacific Standard Time)">23:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">ðŸ¤·</td></tr>

</tbody></table></div></div></div>
</body></html>