<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-06-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-06-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-06-13" class="nav-link"><span>prev</span></a>
<a href="2023-06-15" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jun 13 2023 19:06:08 GMT-0700 (Pacific Daylight Time)">02:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">You're probably right. Sounds like you should update the comment. I suggest prefixing it with "It'll be fun if you write code as if".</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jun 13 2023 19:12:48 GMT-0700 (Pacific Daylight Time)">02:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@twisniewski:mozilla.org">twisniewski</span>&gt;</div></td><td class="msg-cell">Hi folks, I've been looking at Safari release notes lately to uncover web API and other platform gaps, and in the process I have made a list of commits the JSC team has made which include performance optimizations/fixes. Would the SM team be interested in that list, in case it helps uncover anything worth implementing in SM as well?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jun 13 2023 19:16:32 GMT-0700 (Pacific Daylight Time)">02:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">twisniewski</span>: bgrins might be interested in comparing his list with yours, he's scavenged commit messages for speedometer improvements</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jun 13 2023 19:16:58 GMT-0700 (Pacific Daylight Time)">02:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@twisniewski:mozilla.org">twisniewski</span>&gt;</div></td><td class="msg-cell">ok, i'll chat with him, thanks</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jun 13 2023 20:51:23 GMT-0700 (Pacific Daylight Time)">03:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">twisniewski</span>: We would indeed be interested!</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jun 13 2023 20:57:48 GMT-0700 (Pacific Daylight Time)">03:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@twisniewski:mozilla.org">twisniewski</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: alright then :) I'll make a small gDocs spreadsheet with the info after i get some sleep, and we can go from there</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Jun 14 2023 06:41:02 GMT-0700 (Pacific Daylight Time)">13:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">This detailed writeup of a v8 parser zero day that was patched last December might be of interest to people. <a href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-4262.html">https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-4262.html</a></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jun 14 2023 08:37:31 GMT-0700 (Pacific Daylight Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Huh. This seems like a weird way to design a parser: "When such a recompilation happens, the parsing logic can take some shortcuts. For example, when parsing the code (a = 42) =&gt; a + 1; for the first time, when reaching the “=”, the parse cannot yet know whether it will parse a variable assignment or an arrow function with a default argument. However, during the second (and third, etc.) parsing, it knows that it is parsing an arrow function. As such, the logic for the initial parsing differs slightly from the logic for any subsequent parsing." Does the ambiguity really slow parsing down enough that storing hints for delazification is worth it?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jun 14 2023 08:43:55 GMT-0700 (Pacific Daylight Time)">15:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Yeah, kind of interesting that they thought that was worth making their parser more complex for.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jun 14 2023 08:47:15 GMT-0700 (Pacific Daylight Time)">15:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: ping</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jun 14 2023 08:48:23 GMT-0700 (Pacific Daylight Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">sorry was on leadership meeting</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jun 14 2023 08:48:24 GMT-0700 (Pacific Daylight Time)">15:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">coming in now</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jun 14 2023 08:49:08 GMT-0700 (Pacific Daylight Time)">15:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or trying to</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jun 14 2023 09:22:31 GMT-0700 (Pacific Daylight Time)">16:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">heh, replaying branches in the parser. It's like a parse branch predictor oracle that you have to believe. It does seem a bit complicated and risky.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jun 14 2023 09:38:45 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">SpiderMonkey does similar for arrow function.  On the 1st parse, we parse the parameter part as ParenthesizedExpression, and once we found the arrow token follows, roll back the parsing state to the beginning of ParenthesizedExpression and re-parse as ArrowFormalParameters for ArrowFunction.  On the 2nd parse during delazification, we use ArrowFunction as the parsing goal (instead of Expression), so we don't take ParenthesizedExpression pass, and start from ArrowFormalParameters.  so, "storing hint and taking shortcuts" is natural choice for delazification for arrow function</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jun 14 2023 09:40:15 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Ah, interesting</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Jun 14 2023 09:40:42 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">I haven't checked V8's parser, but unless they use single pass for CoverParenthesizedExpressionAndArrowParameterList production, the 1st and 2nd parse should be different</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Jun 14 2023 09:40:43 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Shows how much I know about the parser 😳</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jun 14 2023 10:28:40 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@silonp:matrix.org">silonp</span>&gt;</div></td><td class="msg-cell">Guys, does SpiderMonkey support custom allocators? Or is there a way to track memory utilization associated with single JSContext?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jun 14 2023 10:39:16 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">silonp</span>: We jump through some hoops to support custom allocators. See <a href="https://searchfox.org/mozilla-central/source/config/check_vanilla_allocations.py#7">here</a> and <a href="https://searchfox.org/mozilla-central/source/js/public/Utility.h#42-44">here</a>. I'm not sure if there's any documentation describing what you need to implement for a custom allocator; you might have to dig around in the source code.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jun 14 2023 10:44:01 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We also have a variety of mechanisms for tracking memory owned by the GC. Is something like <a href="https://searchfox.org/mozilla-central/source/js/src/jsfriendapi.cpp#786">this</a> what you're looking for?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jun 14 2023 10:46:11 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">status: I have determined that an optimistic fast version of JSON.stringify() is <em>much</em> faster.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jun 14 2023 10:46:19 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"> if it crashes immediately before it looks at most of the input</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jun 14 2023 10:51:04 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and a mere 4x slower than the slow path once I fix that</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jun 14 2023 10:53:14 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Does the spec explicitly say that we can't crash there? Seems like a promising approach.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jun 14 2023 10:59:09 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@twisniewski:mozilla.org">twisniewski</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>:  speaking of optimizing json.stringify, this might be interesting: <a href="https://github.com/WebKit/WebKit/commit/3fa658700239c8e7cbe8fa20793a6314274560cd">https://github.com/WebKit/WebKit/commit/3fa658700239c8e7cbe8fa20793a6314274560cd</a></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jun 14 2023 11:00:21 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, thanks, someone else noticed that one and I was going to try it out after I was done, uh, slowing things down this other way (which is taking inspiration from another JSC commit)</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jun 14 2023 11:02:48 GMT-0700 (Pacific Daylight Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@twisniewski:mozilla.org">twisniewski</span>&gt;</div></td><td class="msg-cell">was that other one <a href="https://github.com/WebKit/WebKit/commit/f6ec77d6554e5282dd6a264cdc59ab4076baa9e9">https://github.com/WebKit/WebKit/commit/f6ec77d6554e5282dd6a264cdc59ab4076baa9e9</a> ? :)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Jun 14 2023 11:03:10 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@twisniewski:mozilla.org">twisniewski</span>&gt;</div></td><td class="msg-cell">(actually i'll bet it was <a href="https://github.com/WebKit/WebKit/commit/3a9af61361977e1f775f847136d0cf239182c526">https://github.com/WebKit/WebKit/commit/3a9af61361977e1f775f847136d0cf239182c526</a> )</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Jun 14 2023 11:12:02 GMT-0700 (Pacific Daylight Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes it was the second one, except that it really just pointed me at the pre-existing fast path that I am now trying to mimic, in some ways in the reverse way as that second commit does.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Jun 14 2023 11:12:20 GMT-0700 (Pacific Daylight Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(but so far mine is slower, so I may have it backwards!)</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Jun 14 2023 11:13:28 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">they're saying that the code that avoids recursion with an explicit stack is more compilcated and slower, which seems odd to me. Ok, slightly more complicated maybe, but an explicit stack really ought to be faster and still pretty simple.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Jun 14 2023 11:13:42 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">reality is (hopefully temporarily) disagreeing with me at the moment</td></tr>

</tbody></table></div></div></div>
</body></html>