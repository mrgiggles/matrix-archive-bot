<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-03-24</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-03-24<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-03-23" class="nav-link"><span>prev</span></a>
<a href="2023-03-27" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Mar 23 2023 19:54:20 GMT-0700 (Pacific Daylight Time)">02:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Is it possible to set a reserve slot in a promise object?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Mar 24 2023 01:03:33 GMT-0700 (Pacific Daylight Time)">08:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: you mean to store additional data?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Mar 24 2023 03:19:30 GMT-0700 (Pacific Daylight Time)">10:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell"><p>Hello friends, sorry for the lengthy message :)</p>
<p>I'm tracking a DevTools debugger intermittent and I'm outside of what I can figure out from myself :)<br>Basically, we have an HTML file with multiple inline script, one of them having a <code>module</code> type.<br>In this module, we're doing a <code>console.log</code>, which means that when DevTools start, we get those message, look their <code>sourceId</code> (<a href="https://searchfox.org/mozilla-central/rev/6fc2f6d5335fb6f70f780b5fea5ed77b0719c3b5/devtools/server/actors/resources/console-messages.js#223">console-messages.js</a>), call <code>Debugger.findSources</code> (<a href="https://searchfox.org/mozilla-central/rev/6fc2f6d5335fb6f70f780b5fea5ed77b0719c3b5/devtools/server/actors/utils/sources-manager.js#158-159,161">sources-manager.js</a>)which allow us to get the source, store it in some Map, and create some DevTools specifics from it (let's say it's <strong>step 1</strong>).</p>
<p>Then a few second later, when actually starting the debugger, we want to track all sources that existed in the page, so we call <code>Debugger.findSourceURLs</code>, and <code>Debugger.findSources</code> to see if sources might have been GCed (<a href="https://searchfox.org/mozilla-central/rev/6fc2f6d5335fb6f70f780b5fea5ed77b0719c3b5/devtools/server/actors/thread.js#1441,1447,1449,1453,1471-1476">thread.js</a>), and if so, call <code>DebuggerObject.createSource</code> for each of the missing ones (<a href="https://searchfox.org/mozilla-central/rev/6fc2f6d5335fb6f70f780b5fea5ed77b0719c3b5/devtools/server/actors/thread.js#2190-2196">thread.js</a>).</p>
<p>The issue that I face is that <code>findSources</code> does not return the source we got from <strong>step 1</strong> , and so we create another source, which creates some problem down the line.<br>Since we're keeping reference of the source in step 1, I would expect it prevents a source from being GCed (or "missing", whatever that might be).</p>
<p>With some printf, I can see that in the second call to <code>findSources</code>, we don't get the source in <code>DoScriptCallback</code> (<a href="https://searchfox.org/mozilla-central/rev/6fc2f6d5335fb6f70f780b5fea5ed77b0719c3b5/js/src/gc/PublicIterators.cpp#139">PublicIterators.cpp</a>), meaning the script isn't retrieved from <a href="https://searchfox.org/mozilla-central/rev/6fc2f6d5335fb6f70f780b5fea5ed77b0719c3b5/js/src/gc/PublicIterators.cpp#170-171">PublicIterators.cpp</a> , but that's pretty much as far as I can't get with my skills.</p>
<p>Since it only does that for this inline script module, I'm wondering if there's some kind of edge case we don't cover here? Does that ring a bell to anyone?</p>
</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Mar 24 2023 03:47:00 GMT-0700 (Pacific Daylight Time)">10:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Do you know if we are exiting PublicIterators because there isn't bytecode? I am guessing we don't call <a href="https://searchfox.org/mozilla-central/source/js/src/gc/PublicIterators.cpp#93">https://searchfox.org/mozilla-central/source/js/src/gc/PublicIterators.cpp#93</a></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Mar 24 2023 03:50:17 GMT-0700 (Pacific Daylight Time)">10:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">no, we don't call <code>TraverseInnerLazyScriptsForLazyScript</code> , we're not hitting those lines <a href="https://searchfox.org/mozilla-central/rev/6fc2f6d5335fb6f70f780b5fea5ed77b0719c3b5/js/src/gc/PublicIterators.cpp#150,159">https://searchfox.org/mozilla-central/rev/6fc2f6d5335fb6f70f780b5fea5ed77b0719c3b5/js/src/gc/PublicIterators.cpp#150,159</a></td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Mar 24 2023 03:51:46 GMT-0700 (Pacific Daylight Time)">10:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">not sure if relevant, but the failure occurs mostly on osx (and osx debug) and linux tsan jobs (might be just something about the hardware that runs the test). I'm not able to reproduce locally</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Mar 24 2023 03:52:31 GMT-0700 (Pacific Daylight Time)">10:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ok, so we do have bytecode</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Mar 24 2023 03:52:38 GMT-0700 (Pacific Daylight Time)">10:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">do you have a link to the intermittent?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Mar 24 2023 03:53:09 GMT-0700 (Pacific Daylight Time)">10:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">might be easier to see what is going on from pernosco </td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Mar 24 2023 03:54:48 GMT-0700 (Pacific Daylight Time)">10:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">sure: <a href="https://treeherder.mozilla.org/jobs?repo=try&amp;revision=cd77d28eaa3bac1cd99c063b538da3e29153a1e1&amp;selectedTaskRun=BofWDFGjSWOBB5Ztqals5w.0">https://treeherder.mozilla.org/jobs?repo=try&amp;revision=cd77d28eaa3bac1cd99c063b538da3e29153a1e1&amp;selectedTaskRun=BofWDFGjSWOBB5Ztqals5w.0</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Mar 24 2023 03:55:22 GMT-0700 (Pacific Daylight Time)">10:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">I sprinkled dump and printf calls a bit everywhere ^^ </td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Mar 24 2023 03:57:26 GMT-0700 (Pacific Daylight Time)">10:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><code>findSources</code> works by iterating over scripts (this includes functions and top-level code) and then looks at their underlying script source.. I wonder if in this case the script source is still alive (through step 1) but the module script gets GCd in the meantime, so <code>findSources</code> is no longer able to find it</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Mar 24 2023 03:58:35 GMT-0700 (Pacific Daylight Time)">10:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">yeah, that's my guess too, but I thought that once we "handled" a source in DevTools we were guaranteed that it would not get GCd</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Mar 24 2023 04:00:39 GMT-0700 (Pacific Daylight Time)">11:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">i looked through the module inline loading code to see if i could get an idea what we are doing differently from the classic scripts and so far i haven't found an obvious culprit</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Mar 24 2023 04:00:56 GMT-0700 (Pacific Daylight Time)">11:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but that may be where the issue is</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Mar 24 2023 04:01:34 GMT-0700 (Pacific Daylight Time)">11:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">I could check if the issue remains if I remove the module type to the script maybe</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Mar 24 2023 04:02:04 GMT-0700 (Pacific Daylight Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">do you have a link for the test?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Mar 24 2023 04:02:18 GMT-0700 (Pacific Daylight Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell"><a href="https://treeherder.mozilla.org/jobs?repo=try&amp;revision=cd77d28eaa3bac1cd99c063b538da3e29153a1e1&amp;selectedTaskRun=BofWDFGjSWOBB5Ztqals5w.0">https://treeherder.mozilla.org/jobs?repo=try&amp;revision=cd77d28eaa3bac1cd99c063b538da3e29153a1e1&amp;selectedTaskRun=BofWDFGjSWOBB5Ztqals5w.0</a></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Mar 24 2023 04:02:48 GMT-0700 (Pacific Daylight Time)">11:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">or the source maybe? <a href="https://searchfox.org/mozilla-central/source/devtools/client/debugger/test/mochitest/browser_dbg-pretty-print-inline-scripts.js">https://searchfox.org/mozilla-central/source/devtools/client/debugger/test/mochitest/browser_dbg-pretty-print-inline-scripts.js</a></td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Mar 24 2023 04:03:06 GMT-0700 (Pacific Daylight Time)">11:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">page is <a href="https://searchfox.org/mozilla-central/source/devtools/client/debugger/test/mochitest/examples/doc-pretty-print-inline-scripts.html">https://searchfox.org/mozilla-central/source/devtools/client/debugger/test/mochitest/examples/doc-pretty-print-inline-scripts.html</a></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Mar 24 2023 04:05:09 GMT-0700 (Pacific Daylight Time)">11:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">you could also try assigning a function inside the module to some global variable, like <code><a href="http://globalThis.foo">globalThis.foo</a> = function() {}</code>. That should keep at least one script alive which will let us find the script source</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Mar 24 2023 04:06:08 GMT-0700 (Pacific Daylight Time)">11:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I'm not seeing anything obvious in the module loader unfortunately...</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Mar 24 2023 04:09:04 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yeah it might reproduce with a non-module script too? I <em>think</em> the problem is this mismatch between scripts and script sources, where you need at least one live script for <code>findSources</code> to find the script source. Ideally we'd have a weak map of script sources <code>findSources</code> would look at and then this would go away</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Mar 24 2023 04:09:30 GMT-0700 (Pacific Daylight Time)">11:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">you mentioned it causes problems later on -- what kind of failure do we have? </td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Mar 24 2023 04:10:10 GMT-0700 (Pacific Daylight Time)">11:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">in this case, we get a duplicate SourceActor, and so for the HTML pretty printing, we're handling the same inline script twice, which throws off the offsets we're keeping track of</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Mar 24 2023 04:10:59 GMT-0700 (Pacific Daylight Time)">11:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">this is easy to fix from that point, but I wanted to see if there's a bigger issue in how we handle inline script, where we would get duplicated breakpoints, maybe zombie breakpoints too?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Mar 24 2023 04:12:34 GMT-0700 (Pacific Daylight Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">from the <code>resurrectSources</code> , I can check if we already created a SourceActor for this url/file/line location and  not create it again, but since the debugger can't find the source, it will probably lead to weird behavior if you try to interact with it?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Mar 24 2023 04:12:34 GMT-0700 (Pacific Daylight Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">the cause may be what jandem pointed out: modules encapsulate their data unlike classic scripts, so you cannot access top level variables on the global. if the approach he mentioned, with assigning to global this, addresses the problem, then that is probably what is happening</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Mar 24 2023 04:18:06 GMT-0700 (Pacific Daylight Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><a href="https://mozilla-spidermonkey.github.io/sm-wasi-demo/?branch=mozilla-central&amp;source=var%20g%20%3D%20newGlobal(%7BnewCompartment%3A%20true%7D)%3B%0Avar%20dbg%20%3D%20new%20Debugger(g)%3B%0A%0Ag.evaluate(%60%0A%2F%2F%20workaround%3A%20globalThis.f%20%3D%20function()%20%7B%7D%3B%0A%60)%3B%0A%0Avar%20sources%20%3D%20dbg.findSources()%3B%0AassertEq(sources.length%2C%201)%3B%0A%0Agc()%3B%0A%0AassertEq(dbg.findSources().length%2C%201)%3B">here</a> is a shell test</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Mar 24 2023 04:19:12 GMT-0700 (Pacific Daylight Time)">11:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ahh i had no idea we had access to the debugger in the js shell!</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Mar 24 2023 04:20:31 GMT-0700 (Pacific Daylight Time)">11:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">the debugger API is great :) Fuzzers love using it too...</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Mar 24 2023 04:20:32 GMT-0700 (Pacific Daylight Time)">11:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">oh that's a really nice app</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Mar 24 2023 04:21:31 GMT-0700 (Pacific Daylight Time)">11:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">it looks like the way to solve this might be what jandem mentioned -- a weakmap that will release the source if it is gc'd, so that you don't have two copies of it and get the right offset</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Mar 24 2023 04:22:45 GMT-0700 (Pacific Daylight Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">it's a good find; this can probably result in really weird behavior for devtools users</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Mar 24 2023 04:26:11 GMT-0700 (Pacific Daylight Time)">11:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">alright, I'll see what I can do to fix this, thanks a lot for the help</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Mar 24 2023 04:29:04 GMT-0700 (Pacific Daylight Time)">11:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-14">nchevobbe</span>: can you file a JS engine bug for this? I think we should fix <code>findSources</code></td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Mar 24 2023 04:30:12 GMT-0700 (Pacific Daylight Time)">11:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell">sure, will do after lunch</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Mar 24 2023 05:45:55 GMT-0700 (Pacific Daylight Time)">12:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@nchevobbe:mozilla.org">nchevobbe</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-14">nchevobbe</span>: can you file a JS engine bug for this? I think we should fix <code>findSources</code></blockquote></mx-reply><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1824354">https://bugzilla.mozilla.org/show_bug.cgi?id=1824354</a></td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Mar 24 2023 06:37:45 GMT-0700 (Pacific Daylight Time)">13:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-12">liam_g</span>: you mean to store additional data?</blockquote></mx-reply>Late response. Yes, that's what I mean.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Mar 24 2023 07:03:52 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: most robust would be to define a JS property on the promise object, or use a map to associate data with it</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Mar 24 2023 07:18:46 GMT-0700 (Pacific Daylight Time)">14:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Yeah that's what I'm doing. I was just wondering if there was another option.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Mar 24 2023 07:30:16 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Maybe I can spell the problem out a little more. I have a function which queries a Promise object hundreds of times per second to see if it's ready. It has to do a property lookup every time, which is a bit inefficient. I was wondering if it is possible to cash the value somehow, and just update it if the value changes (which won't happen very often). I was thinking of using a reserve slot to hold a Boolean to tell if the value needs to be updated. But I'm not sure if this is really any better than just loading the value each time.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Mar 24 2023 07:30:49 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@lgoodacre:matrix.org">liam_g</span>&gt;</div></td><td class="msg-cell">Perhaps I'm just micro-optimizing though...</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Mar 24 2023 07:54:36 GMT-0700 (Pacific Daylight Time)">14:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <a href="https://mozilla-spidermonkey.github.io/sm-wasi-demo/?branch=mozilla-central&amp;source=var%20g%20%3D%20newGlobal(%7BnewCompartment%3A%20true%7D)%3B%0Avar%20dbg%20%3D%20new%20Debugger(g)%3B%0A%0Ag.evaluate(%60%0A%2F%2F%20workaround%3A%20globalThis.f%20%3D%20function()%20%7B%7D%3B%0A%60)%3B%0A%0Avar%20sources%20%3D%20dbg.findSources()%3B%0AassertEq(sources.length%2C%201)%3B%0A%0Agc()%3B%0A%0AassertEq(dbg.findSources().length%2C%201)%3B">here</a> is a shell test</blockquote></mx-reply>I still love these live wasi jsshell demos. ðŸª„</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Mar 24 2023 07:56:30 GMT-0700 (Pacific Daylight Time)">14:56</a></td><td class="nick-cell"><div class="m-ov"><span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span></div></td><td class="msg-cell">wonders about pointing <a href="http://shell.spidermonkey.dev">shell.spidermonkey.dev</a> to that..</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Mar 24 2023 07:56:51 GMT-0700 (Pacific Daylight Time)">14:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">ðŸ¤” could we bake samply into these live wasi jsshell demo?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Mar 24 2023 08:08:53 GMT-0700 (Pacific Daylight Time)">15:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I don't know how realistic that would be, but it would certainly be super cool</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Mar 24 2023 08:27:15 GMT-0700 (Pacific Daylight Time)">15:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">yeah I'm not sure how that would work, but it would certainly be cool</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Mar 24 2023 08:27:39 GMT-0700 (Pacific Daylight Time)">15:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">it might be more realistic to run actual spidermonkey on a linux server and profile there</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Mar 24 2023 08:27:49 GMT-0700 (Pacific Daylight Time)">15:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">I'm sure the wasi performance characteristics are completely different</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Mar 24 2023 08:28:10 GMT-0700 (Pacific Daylight Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@mstange:mozilla.org">mstange</span>&gt;</div></td><td class="msg-cell">oh, but I guess you're not always interested in realistic perf numbers, sometimes you just want to debug</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Mar 24 2023 11:08:43 GMT-0700 (Pacific Daylight Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">denispal</span>: <span class="nick-4">iain</span>: Seeing the patch go by on <code>LAllocation::toString</code> â€¦ I just went over the <code>JitDumpFilePtr</code> to convert it to a <code>Fprinter</code>. This sounds like this would be a valuable change for most of these in order to avoid allocating temporary strings.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Mar 24 2023 11:10:09 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">i.e. use more <code>GenericPrinter&amp; out</code> when possible, the dispatch cost is most likely less costly than the allocation cost of the string.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Mar 24 2023 11:12:21 GMT-0700 (Pacific Daylight Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The perf integration code is full of string allocation. We've talked about improving it, but so far <span class="nick-12">denispal</span> has prioritized getting something working first.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Mar 24 2023 11:13:00 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">yeah there is a lot when we emit the operands</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Mar 24 2023 11:13:48 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">not sure how often <span class="nick-14">jrmuizel</span> or <span class="nick-1">mstange</span> are using the operand info, though</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Mar 24 2023 11:14:28 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">denispal</span>: I have a patch for Getting the JSON spewer into the PerfSpewer, the patch would on for review at the beginning of next week ðŸ¤ž</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Mar 24 2023 11:14:43 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: how does Fprinter help us though?</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Mar 24 2023 11:15:05 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Fprinter let all of these functions write directly to the dedicated file.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Mar 24 2023 11:15:35 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Thus instead of allocating a string to later use "%s" to get the context around it, you just write each string directly to the file.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Mar 24 2023 11:15:54 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">Ok.  I think eventually we will want to keep the operand strings so we can emit them into the gecko profile, however.  That's kind of why we keep them atm,  even though we don't use them. </td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Mar 24 2023 11:16:16 GMT-0700 (Pacific Daylight Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Well you can do that as well, by using the Sprinter.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Mar 24 2023 11:16:46 GMT-0700 (Pacific Daylight Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">the GenericPrinter is just an abstract way to get something into a buffer.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Mar 24 2023 11:17:06 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">however the buffer is managed.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Mar 24 2023 11:17:38 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">What are you trying to get into the Gecko profiler?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Mar 24 2023 11:18:30 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">longer term goal is to move the assembly annotation from jitdump &amp; perf into the profiler</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Mar 24 2023 11:19:27 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">first step I need to do is add line numbers and some missing symbols for trampolines though</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Mar 24 2023 11:24:46 GMT-0700 (Pacific Daylight Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@jrmuizel:mozilla.org">jrmuizel</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> not sure how often <span class="nick-14">jrmuizel</span> or <span class="nick-1">mstange</span> are using the operand info, though</blockquote></mx-reply>I used it today</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Mar 24 2023 11:25:31 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I do not understand the relation between the LAllocation and trampolines :/</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Mar 24 2023 11:26:36 GMT-0700 (Pacific Daylight Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Are you trying to map registers to actual JavaScript names?</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Mar 24 2023 11:27:02 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">there is no relation, we just don't have symbols for trampolines in our gecko profiles</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Mar 24 2023 13:17:42 GMT-0700 (Pacific Daylight Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell">Hello. How to get the current JSContext of JSObject in mozjs102?</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Mar 24 2023 13:18:53 GMT-0700 (Pacific Daylight Time)">20:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">ewang21</span>: There is only one JSContext per thread.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Mar 24 2023 13:34:59 GMT-0700 (Pacific Daylight Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@ewang21:mozilla.org">ewang21</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-7">ewang21</span>: There is only one JSContext per thread.</blockquote></mx-reply>Does this mean that the context pointer has to be saved, cannot be obtained from an object that has been generated through the context?</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Mar 24 2023 13:35:55 GMT-0700 (Pacific Daylight Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">ewang21</span>: Yes. You can put it in thread-local storage, if you want to.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Mar 24 2023 13:38:21 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">We do so internally in the engine, but I don't see it exposed anywhere.</td></tr>

</tbody></table></div></div></div>
</body></html>