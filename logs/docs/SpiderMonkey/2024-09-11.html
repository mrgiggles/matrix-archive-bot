<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-09-11</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-09-11<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-09-10" class="nav-link"><span>prev</span></a>
<a href="2024-09-12" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search SpiderMonkey">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Sep 11 2024 01:15:14 GMT-0700 (Pacific Daylight Time)">08:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Is there a way of finding the hash value of a <code>JSString</code> or <code>PropertyKey</code> from within C++?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Sep 11 2024 01:17:24 GMT-0700 (Pacific Daylight Time)">08:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">liam_g</span>: if the <code>JSString</code> is <code>JSAtom</code>, <a href="https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/js/src/vm/StringType.h#1568">JSAtom::hash</a> works.  Same for <code>PropertyKey</code></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Sep 11 2024 01:19:42 GMT-0700 (Pacific Daylight Time)">08:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Can I force a <code>JSString</code> to be a <code>JSAtom</code>?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Sep 11 2024 01:19:55 GMT-0700 (Pacific Daylight Time)">08:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">for <code>PropertyKey</code>, <a href="https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/js/src/vm/PropertyKey.h#21">js::HashPropertyKey</a> would work for all cases</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Sep 11 2024 01:20:49 GMT-0700 (Pacific Daylight Time)">08:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, maybe I'm misunderstanding your question.   do you want to get a hash of arbitrary JSString?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Sep 11 2024 01:21:26 GMT-0700 (Pacific Daylight Time)">08:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">JSString can be atomized, but that will be overfill if you just want a hash</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Sep 11 2024 01:22:42 GMT-0700 (Pacific Daylight Time)">08:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I don't think that you are misunderstanding, it's me who doesn't understand <code>JSAtom</code> very well.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Sep 11 2024 01:24:11 GMT-0700 (Pacific Daylight Time)">08:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/js/src/vm/StringType.h#2037">js::HashStringChars</a> works for all linear strings.  it's still a subset tho, <a href="https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/js/src/vm/StringType.h#1071">JSLinearString::ensureLinear</a> is more lightweight than atomizing</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Sep 11 2024 01:27:13 GMT-0700 (Pacific Daylight Time)">08:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">OK, so if I want to hash a <code>PropertyKey</code>, I can use <code>js::HashPropertyKey</code>, and if I want to hash a <code>JSString</code> I can run <code>JSLinearString::ensureLinear</code> followed by <code>js::HashStringChars</code>. Is that right?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Sep 11 2024 01:29:51 GMT-0700 (Pacific Daylight Time)">08:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">for <code>PropertyKey</code>, yes.  For <code>JSString</code>, it depends.  you might want to handle <code>JSAtom</code> case before that for performance reason</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Sep 11 2024 01:30:25 GMT-0700 (Pacific Daylight Time)">08:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">also, looks like rope has <code>hash</code> function, according to <a href="https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/js/src/vm/MemoryMetrics.cpp#55-59">MemoryMetrics.cpp</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Sep 11 2024 01:31:00 GMT-0700 (Pacific Daylight Time)">08:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">OK, I understand. Am I right in thinking that mostly keywords will already be atomized, and mostly other words won't be?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Sep 11 2024 01:31:20 GMT-0700 (Pacific Daylight Time)">08:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">oh, I think I should've asked this first.  are you looking for public API, or are you modifying the SpiderMonkey internal?  the most of the above is available only in internal</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Sep 11 2024 01:31:52 GMT-0700 (Pacific Daylight Time)">08:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I was just about to ask about this. I'm working in the public API. Is it safe to include those header files? </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Sep 11 2024 01:32:46 GMT-0700 (Pacific Daylight Time)">08:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">All keywords are atomized.  <a href="https://searchfox.org/mozilla-central/source/js/src/vm/CommonPropertyNames.h">https://searchfox.org/mozilla-central/source/js/src/vm/CommonPropertyNames.h</a> and built-in classes, type names, symbols are also atomized</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Sep 11 2024 01:33:07 GMT-0700 (Pacific Daylight Time)">08:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">uh, I'm not aware of any way to directly get the hash with public API</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Sep 11 2024 01:34:55 GMT-0700 (Pacific Daylight Time)">08:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">what are you going to use the hash for?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Sep 11 2024 01:37:09 GMT-0700 (Pacific Daylight Time)">08:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I was looking to create a <code>std::unordered_map</code> or something similar so that I could speed up conversions between <code>JSString</code>, <code>PropertyKey</code> and a 3rd party type that I'm using, <code>juce::Identifier</code>.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Sep 11 2024 01:38:33 GMT-0700 (Pacific Daylight Time)">08:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">If the API doesn't support this then I'll find another way around. I could probably use a normal <code>JSObject</code> as a container, or a JS Map.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Sep 11 2024 01:42:27 GMT-0700 (Pacific Daylight Time)">08:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">For identifiers, atomizing those strings and using the pointer value can be an option</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Sep 11 2024 01:43:18 GMT-0700 (Pacific Daylight Time)">08:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">If the PropertyKey is known to be string, then it's actually an atom, and you can use the same technique</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Sep 11 2024 01:44:48 GMT-0700 (Pacific Daylight Time)">08:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Oh, that's interesting. Pointers to atoms remain constant, do they?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Sep 11 2024 01:44:50 GMT-0700 (Pacific Daylight Time)">08:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"> Can I atomize a string from within the API?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Sep 11 2024 01:47:02 GMT-0700 (Pacific Daylight Time)">08:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote>  Can I atomize a string from within the API?</blockquote></mx-reply>I found <code>JS_AtomizeString</code> in the String.h header. Looks like that's the right one.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Sep 11 2024 01:50:11 GMT-0700 (Pacific Daylight Time)">08:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">I am assuming that atomizing a string is a heavy one-time operation, and you don't want to atomize everything. But in a program which repeatedly uses the same strings or IDs over and over again, it might make sense to pay this cost of atomizing once and then use the caching technique to speed things up. Is this correct?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Sep 11 2024 01:54:43 GMT-0700 (Pacific Daylight Time)">08:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">iiuc, Atom's pointer is constant as long as it doesn't get collected.  maybe I'm misunderstanding around permanent flag vs pinned flag etc.  let's wait for others who knows better</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Sep 11 2024 02:01:34 GMT-0700 (Pacific Daylight Time)">09:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">then, yes, atomization is slightly heavy operation.  it calculates hash and it's added to a map, in order to get unique instance.  Atoms can be compared by pointers.  So, for identifiers usage, where the same identifier can appear multiple times and also comparisons can frequently happen, this would fit very well.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Sep 11 2024 02:02:14 GMT-0700 (Pacific Daylight Time)">09:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">identifiers appears in JS code are all atomized</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Sep 11 2024 02:16:21 GMT-0700 (Pacific Daylight Time)">09:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">This makes sense. Does it follow that any time I write <code>x.prop</code> or <code>x["prop"]</code> in Javascript, "prop" is going to be atomized by the compiler?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Sep 11 2024 02:22:05 GMT-0700 (Pacific Daylight Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">for properties, it's not guaranteed.  for simple cases, they're atomized, but if it's a long strong appears outside of the property context, it's not atomized</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Sep 11 2024 02:22:47 GMT-0700 (Pacific Daylight Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">e.g. <code>const key = "some long string"; x[key];</code></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Sep 11 2024 02:24:24 GMT-0700 (Pacific Daylight Time)">09:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, that applies only inside the compiler.  in runtime, string property keys are atomized</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Sep 11 2024 02:26:43 GMT-0700 (Pacific Daylight Time)">09:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">Thanks for the clarification. It looks like this should be a good way for me to optimize my code. Unless there are any doubts about atoms being garbage collected, as you mentioned above?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Sep 11 2024 02:27:14 GMT-0700 (Pacific Daylight Time)">09:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">(In any case, even if this happens, it just means a bit more construction time and a bit more memory, not undefined behavior).</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Sep 11 2024 02:29:11 GMT-0700 (Pacific Daylight Time)">09:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">yes atoms can be garbage collected if they're no longer used anywhere. Exception are pinned atoms, these are kept alive, but it's probably better to not rely on that</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Sep 11 2024 02:32:22 GMT-0700 (Pacific Daylight Time)">09:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@liam_g:mozilla.org">liam_g</span>&gt;</div></td><td class="msg-cell">This makes things a bit more complicated. But if I were to store raw pointers to <code>PropertyKey</code> and then trace them somehow, I would then prevent those atoms from being garbage collected. I could then use the raw pointers in a <code>std::unordered_map</code>. Does this seem right?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Sep 11 2024 02:51:27 GMT-0700 (Pacific Daylight Time)">09:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gkw:mozilla.org">gkw</span>&gt;</div></td><td class="msg-cell">jonco: Both bug 1851579 and bug 1917561 involve <code>enqueueMark("set-color-gray");</code> - are they related?</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Sep 11 2024 02:51:28 GMT-0700 (Pacific Daylight Time)">09:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1851579">https://bugzil.la/1851579</a> — NEW (nobody) — Assertion failure: ok (Incremental marking verification failed), at js/src/gc/Verifier.cpp:759</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Sep 11 2024 02:51:28 GMT-0700 (Pacific Daylight Time)">09:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1917561">https://bugzil.la/1917561</a> — NEW (jonco) — Assertion failure: ok (Incremental marking verification failed), at js/src/gc/Verifier.cpp:768</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Sep 11 2024 03:05:31 GMT-0700 (Pacific Daylight Time)">10:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">gkw</span>: I'm not sure that the testcase in that bug calls enqueueMark after we've started incremental GC which is the problem here.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Sep 11 2024 03:15:52 GMT-0700 (Pacific Daylight Time)">10:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@gkw:mozilla.org">gkw</span>&gt;</div></td><td class="msg-cell">I see, well just fyi</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Sep 11 2024 04:01:45 GMT-0700 (Pacific Daylight Time)">11:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@wes:mozilla.org">wes</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-12">liam_g</span>: If you're just atomizing one set of strings, like common API parameters or something, you could do them all at program start and just create GC roots for the atomized strings so that they are never GCd.  Another trick I used years ago was to store my pre-computed strings in a JS Array and then I would just keep the Array referenced with a GC root.</p>
<p>The advantage I sought from atomized strings years ago was similar to yours, I wanted to compare them by address instead of JS strcmp().</p>
</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Sep 11 2024 07:14:21 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@bvisness:mozilla.org">bvisness</span>&gt;</div></td><td class="msg-cell">I've got a <code>pbl</code> <a href="https://treeherder.mozilla.org/jobs?repo=try&amp;author=bvisness%40mozilla.com&amp;selectedTaskRun=baDq02jcRi-8zP96_rmRXA.0">try failure</a>, how do I build and run that locally? (Also why would changing only the test runner cause a failure there...?)</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Sep 11 2024 07:14:53 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@bvisness:mozilla.org">bvisness</span>&gt;</div></td><td class="msg-cell">ha, just saw the message about the same in our internal channel</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Sep 11 2024 07:15:12 GMT-0700 (Pacific Daylight Time)">14:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@bvisness:mozilla.org">bvisness</span>&gt;</div></td><td class="msg-cell">never mind</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Sep 11 2024 08:05:47 GMT-0700 (Pacific Daylight Time)">15:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">jonco</span>: There are some <a href="https://glam.telemetry.mozilla.org/firefox/probe/gc_ms/explore?normalizationType=non_normalized&amp;os=Windows&amp;ref=20240827213859&amp;visiblePercentiles=%5B99%2C95%2C50%5D">significant improvements</a> in <code>gc_ms</code> over the past week.  (-30-40%).  Do you happen to know changes could have caused them?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Sep 11 2024 08:57:21 GMT-0700 (Pacific Daylight Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://firefox-source-docs.mozilla.org/performance/memory/gc_and_cc_logs.html">https://firefox-source-docs.mozilla.org/performance/memory/gc_and_cc_logs.html</a></td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Sep 11 2024 09:16:37 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/dom/base/CCGCScheduler.cpp#860-863">https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/dom/base/CCGCScheduler.cpp#860-863</a></td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Sep 11 2024 09:26:32 GMT-0700 (Pacific Daylight Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-4">jonco</span>: There are some <a href="https://glam.telemetry.mozilla.org/firefox/probe/gc_ms/explore?normalizationType=non_normalized&amp;os=Windows&amp;ref=20240827213859&amp;visiblePercentiles=%5B99%2C95%2C50%5D">significant improvements</a> in <code>gc_ms</code> over the past week.  (-30-40%).  Do you happen to know changes could have caused them?</blockquote></mx-reply>There have been a couple of minor changes but nothing I would have expected to make a large improvement. It sometimes takes a while for telemetry to settle down as people update their nightlies so this may change.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Sep 11 2024 09:27:49 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: when a CC is "started", it'll do some number of ForgetSkippable slices, but then it <a href="https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/dom/base/CCGCScheduler.cpp#836-841">checks to see if the CC is still needed</a> and cancels it if not.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Sep 11 2024 09:28:12 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">ah thanks. that makes sense</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Sep 11 2024 09:28:24 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(though I think there's a synchronous CC path as well, and I'm not sure it does the same thing)</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Sep 11 2024 09:37:57 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-4">jonco</span>: There are some <a href="https://glam.telemetry.mozilla.org/firefox/probe/gc_ms/explore?normalizationType=non_normalized&amp;os=Windows&amp;ref=20240827213859&amp;visiblePercentiles=%5B99%2C95%2C50%5D">significant improvements</a> in <code>gc_ms</code> over the past week.  (-30-40%).  Do you happen to know changes could have caused them?</blockquote></mx-reply>Like Jon said, newer build IDs always have better GC times. Their sessions are not as long, so you have to keep that in mind.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Sep 11 2024 09:38:14 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">(So they have less stuff loaded, usually.)</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Sep 11 2024 09:40:29 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">Ah ok, makes sense.  Thanks</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Sep 11 2024 09:41:42 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">We probably have telemetry for JS heap size and I'd expect that'll be correlated. </td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Sep 11 2024 09:44:50 GMT-0700 (Pacific Daylight Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: Yes, it <a href="https://glam.telemetry.mozilla.org/firefox/probe/memory_js_gc_heap/explore?normalizationType=non_normalized&amp;os=Windows&amp;visiblePercentiles=%5B99%2C95%2C50%5D">does seem to be correlated</a>.</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Sep 11 2024 09:45:47 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Also I think generally max pause is more important than the difference in time between when we  finish a GC and when we start it, and I think this is the latter.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Sep 11 2024 09:47:50 GMT-0700 (Pacific Daylight Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">mccr8</span>: Actually, I think I don't fully understand the build id argument though.  What makes the build id's between Sept. 6th-9th special here?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Sep 11 2024 09:48:27 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">or is it just a coincidence that it's this low at the moment</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Sep 11 2024 09:49:42 GMT-0700 (Pacific Daylight Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">oh might be weekend effect too</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Sep 11 2024 09:50:11 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-16">mccr8</span>: Actually, I think I don't fully understand the build id argument though.  What makes the build id's between Sept. 6th-9th special here?</blockquote></mx-reply>The basic idea is that the older your session is, the more tabs you tend to have open. The more tabs you have, the larger the GC heap will be (though with Fission maybe that's less of a thing now.) The serious tab hoarders might only update their browser every week or two. So only some percentage of tab hoarders can possibly have builds from the last few days.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Sep 11 2024 09:50:49 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">With a Sept 9th build, none of them can have a session longer than 3 days because it has only been 3 days. Vs an older build.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Sep 11 2024 09:50:52 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">Ok, that makes sense</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Sep 11 2024 09:51:02 GMT-0700 (Pacific Daylight Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@denispal:mozilla.org">denispal</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Sep 11 2024 09:51:39 GMT-0700 (Pacific Daylight Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Definitely a weird effect, but it has been pretty consistent, going back two or three cycles of different telemetry systems.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Sep 11 2024 10:07:49 GMT-0700 (Pacific Daylight Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell"><p>Is this even okay to do? Because I'm not sure if this even allocates space for <code>TranscodeBuffer</code></p>
<pre><code class="language-c++">    JS::TranscodeBuffer buffer;
    // Determine the file size
    fb.pubseekoff(0, std::ios::end);
    std::streamsize size = fb.pubseekoff(0, std::ios::beg);
    // Read the data
    fb.sgetn(static_cast&lt;char*&gt;(static_cast&lt;void*&gt;(buffer.begin())), size);
    fb.close();
</code></pre>
</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Sep 11 2024 10:11:05 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">guess I need to call <code>buffer.growBy(size)</code></td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Sep 11 2024 10:14:54 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, you need <a href="https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/mfbt/Vector.h#713">growBy</a> or <a href="https://searchfox.org/mozilla-central/rev/3b59c739df66574d94022a684596845cd05e7c65/mfbt/Vector.h#716">resize</a></td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Sep 11 2024 10:35:47 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@davidj361:matrix.org">davidj361</span>&gt;</div></td><td class="msg-cell">And a stencil has to be decoded to run? Can it not just run while being encoded already?</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Sep 11 2024 11:03:28 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the buffer first needs to be decoded to <code>JS::Stencil</code>, and then instantiated into <code>JSScript</code>, and then you can run it</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Sep 11 2024 14:32:11 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">When calling DecodeStencil, you can set options.borrowBuffer if the memory you decode from will live as long as the JS::Stencil does. This will make the decode process mostly just point to the existing data instead of allocating a copy. As arai says though, you still need to instantiate it to convert to a format that the js engine can run. The conversions are all pretty fast and largely the formats differ between if something is a pointer vs an index into an array you would have to know about</td></tr>

</tbody></table></div></div></div>
</body></html>