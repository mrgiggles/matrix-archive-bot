<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-10-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-10-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-10-06" class="nav-link"><span>prev</span></a>
<a href="2024-10-08" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Oct 07 2024 02:51:46 GMT-0700 (Pacific Daylight Time)">09:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/whatwg/html/pull/10528">https://github.com/whatwg/html/pull/10528</a> might land relatively soon, unless we have still something to say about it</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Oct 07 2024 03:11:07 GMT-0700 (Pacific Daylight Time)">10:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@zihco:mozilla.org">zihco</span>&gt;</div></td><td class="msg-cell">[Outreachy]  I had accidentally run <code>hg strip &lt;current working directory parent's changeset-id&gt;</code>, I have push my commit, the issue is that my commit is showing as new files rather than the changes i made. Please, what is the easiest way to fix this. Thanks</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Oct 07 2024 03:40:30 GMT-0700 (Pacific Daylight Time)">10:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <a href="https://github.com/whatwg/html/pull/10528">https://github.com/whatwg/html/pull/10528</a> might land relatively soon, unless we have still something to say about it</blockquote></mx-reply>I'm OK with this although I haven't reviewed the latest changes</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Oct 07 2024 03:50:58 GMT-0700 (Pacific Daylight Time)">10:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell">want to comment in the spec issue?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Oct 07 2024 04:33:14 GMT-0700 (Pacific Daylight Time)">11:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">zihco</span>: are you still having the problem?  easiest way would be to discard your commit, pull from the remote, and apply the same change again and commit it as a new one.   if you want to keep your previous change, the way to recover totally depends on what you've modified.  so please provide more details</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Oct 07 2024 06:56:14 GMT-0700 (Pacific Daylight Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">I did comment a couple of weeks ago</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Oct 07 2024 06:56:37 GMT-0700 (Pacific Daylight Time)">13:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">There have been a lot of changes since then so I was waiting for the spec to settle down again to give it another look</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Oct 07 2024 07:17:42 GMT-0700 (Pacific Daylight Time)">14:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">anba</span>: I wonder how the async parts of <a href="https://searchfox.org/mozilla-central/source/js/src/tests/non262/Promise/any-stack.js">https://searchfox.org/mozilla-central/source/js/src/tests/non262/Promise/any-stack.js</a> work. Shouldn't there be a drainJobQueue call?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Oct 07 2024 07:20:20 GMT-0700 (Pacific Daylight Time)">14:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the job queue is drained after executing the top-level script</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Oct 07 2024 07:21:04 GMT-0700 (Pacific Daylight Time)">14:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>drainJobQueue</code> is for draining the job queue before proceeding to the remaining part of the testcase</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Oct 07 2024 07:36:24 GMT-0700 (Pacific Daylight Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">so should the <code>state</code> be something like<code>class SchedulingState : public NativeObject {}</code>?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Oct 07 2024 07:38:12 GMT-0700 (Pacific Daylight Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it would depend on how much we implement the "HostDefined" things in SpiderMonkey (or make it customizable on the embedding side)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Oct 07 2024 07:39:45 GMT-0700 (Pacific Daylight Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">oh right okay, so it'll be like class <code>HostDefined : public NativeObject {}</code></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Oct 07 2024 07:39:58 GMT-0700 (Pacific Daylight Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">and I can store the state on that object directly? </td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Oct 07 2024 07:40:08 GMT-0700 (Pacific Daylight Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">If we make everything being outside of SpiderMonkey, we won't have dedicate C++ class</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Oct 07 2024 07:41:26 GMT-0700 (Pacific Daylight Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">er, I don't understand what that means. </td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Oct 07 2024 07:41:32 GMT-0700 (Pacific Daylight Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">which do we prefer..?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Oct 07 2024 07:41:46 GMT-0700 (Pacific Daylight Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the consumer defines its own <a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/js/public/Class.h#616">JSClass</a>, with reserved slots for each field (state,  incumbentGlobal, etc), and have the <a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/js/public/Class.h#604">JSClassOps::finalize</a> function to manage the lifetime of the pointed things</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Oct 07 2024 07:43:42 GMT-0700 (Pacific Daylight Time)">14:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yeah, that's the question. if we expect the "HostDefined" being extended more and more, or if the "state" handling is something more complicated than the current "incumbentglobal" handling, we would want to make the "HostDefined" handling being outside of SpiderMonkey</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Oct 07 2024 07:44:53 GMT-0700 (Pacific Daylight Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">there would be some kind of tradeoff (implementing inside SpiderMonkey might be simpler/faster, but putting more and more will complicate things unnecessarily), so it would depend on the needs</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Oct 07 2024 07:47:08 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">I see, I prefer we make the "HostDefined" handling being outside of SpiderMonday. seems more "correct" to me. </td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Oct 07 2024 07:48:03 GMT-0700 (Pacific Daylight Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">I still don't understand what you meant by "outside of spidermoneky", is <code>making the customer defines its own JSClass...</code> approach outside of spidermonkey?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Oct 07 2024 07:48:47 GMT-0700 (Pacific Daylight Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">(due to my lack of understanding of SpiderMonkey)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Oct 07 2024 07:49:10 GMT-0700 (Pacific Daylight Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>NativeObject</code> is SpiderMonkey-internal class.  Outside of SpiderMonkey, all JS objects are represented as an opaque <code>JSObject*</code> pointer</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Oct 07 2024 07:49:37 GMT-0700 (Pacific Daylight Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">and all operations are done with JSAPI, such as <a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/js/public/Object.h#68">JS::GetReservedSlot</a> for accessing slots</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Oct 07 2024 07:50:37 GMT-0700 (Pacific Daylight Time)">14:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the slots is for storing data, such as a pointer for native (non-GC) objects</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Oct 07 2024 07:50:59 GMT-0700 (Pacific Daylight Time)">14:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">the number of slots and some more details about how the object behaves are defined by <code>JSClass</code> above</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Oct 07 2024 07:51:25 GMT-0700 (Pacific Daylight Time)">14:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">let me find simple example</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Oct 07 2024 07:52:03 GMT-0700 (Pacific Daylight Time)">14:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/dom/bindings/SimpleGlobalObject.cpp#60-86">mozilla::dom::SimpleGlobalClass</a></td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Oct 07 2024 07:52:07 GMT-0700 (Pacific Daylight Time)">14:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">it makes sense now, still create the "NativeObject" to define slots etc, but the handling of it is done with JSAPIs</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Oct 07 2024 07:52:49 GMT-0700 (Pacific Daylight Time)">14:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Oct 07 2024 07:53:07 GMT-0700 (Pacific Daylight Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, that example isn't appropriate.  it's a global object which has special behavior</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Oct 07 2024 07:57:28 GMT-0700 (Pacific Daylight Time)">14:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/toolkit/components/finalizationwitness/FinalizationWitnessService.cpp#110-124">mozilla::sWitnessClassOps</a></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Oct 07 2024 07:58:15 GMT-0700 (Pacific Daylight Time)">14:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it has reserved slots with ref-counted pointer, has finalize hook</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Oct 07 2024 07:59:40 GMT-0700 (Pacific Daylight Time)">14:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">it's created with <a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/toolkit/components/finalizationwitness/FinalizationWitnessService.cpp#185">JS_NewObject</a>, and the reserved slot is set by <a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/toolkit/components/finalizationwitness/FinalizationWitnessService.cpp#196-197">JS_SetReservedSlot</a>, and the pointer is released by <a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/toolkit/components/finalizationwitness/FinalizationWitnessService.cpp#93-94">the finalize hook</a></td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Oct 07 2024 08:02:13 GMT-0700 (Pacific Daylight Time)">15:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, in the same way, you can store all <code>HostDefined</code> data into an JSObject, and the JobQueue can pass it from/to SpiderMonkey when creating or running job callback, and the SpiderMonkey side doesn't have to touch the details of the <code>HostDefined</code> data</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Oct 07 2024 08:03:48 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">sounds good, thanks. will get back later! </td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Oct 07 2024 10:17:18 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">I am not sure how to get the fixed slot from the JSObject* </td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Oct 07 2024 10:18:23 GMT-0700 (Pacific Daylight Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><p>In <code>EnqueuePromiseReactionJob</code>, I wrote</p>
<pre><code>  Rooted&lt;GlobalObject*&gt; global(cx);
  Rooted&lt;JSObject*&gt; webTasSchedulingState(cx);
  if (JSObject* hostDefinedJobCallbackRecord =
          reaction-&gt;getAndClearHostDefinedJobCakkbackRecord()) {
    JSObject* objectFromIncumbentGlobal =
        hostDefinedJobCallbackRecord
            -&gt;getFixedSlot(mozilla::INCUMENT_SETTING_SLOT)
            .toObjectOrNull();

    if (objectFromIncumbentGlobal) {
      objectFromIncumbentGlobal =
          CheckedUnwrapStatic(objectFromIncumbentGlobal);
      MOZ_ASSERT(objectFromIncumbentGlobal);
      global = &amp;objectFromIncumbentGlobal-&gt;nonCCWGlobal();
    }
  }

</code></pre>
<p>and this doesn't compile because <code>JSObject</code> doesn't have <code>getFixedSlot</code></p>
</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Oct 07 2024 11:37:16 GMT-0700 (Pacific Daylight Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: ping ^, given I seem to have you around :)</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon Oct 07 2024 11:38:41 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/js/public/Object.h#68">JS::GetReservedSlot</a> and <a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/js/public/Object.h#87">JS::SetReservedSlot</a></td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon Oct 07 2024 11:39:11 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><code>JSObject</code> is opaque type outside of SpiderMonkey, and you need to use function-based JSAPI for all operations</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon Oct 07 2024 11:39:27 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">err, is the code inside SpiderMonkey ?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Mon Oct 07 2024 11:40:40 GMT-0700 (Pacific Daylight Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">this is <a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/js/src/builtin/Promise.cpp#1553">https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/js/src/builtin/Promise.cpp#1553</a></td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Mon Oct 07 2024 11:41:26 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, if we're to move the HostDefined things to the embedding, the existing incumbentGlobal handling should also be moved to the embedding</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Mon Oct 07 2024 11:42:11 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, instead of extracting the slot inside SpiderMonkey, just pass the <code>HostDefined</code> JSObject to the job queue methods</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Mon Oct 07 2024 11:42:58 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">ah okay, I thought I should extract them there</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Mon Oct 07 2024 11:43:49 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">afaik the incumbentGlobal object is just passed through without actually touching it inside SpiderMonkey, and wrapping it into the HostDefined object should work</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Mon Oct 07 2024 11:43:59 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">so..where should I extract them again?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Mon Oct 07 2024 11:44:16 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">when the host wants the data</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Mon Oct 07 2024 11:44:57 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">somewhere around <a href="https://searchfox.org/mozilla-central/rev/b546e74055186bb387ed7db9079374e1e7e0b88e/xpcom/base/CycleCollectedJSContext.cpp#239,241,245-247">mozilla::CycleCollectedJSContext::enqueuePromiseJob</a></td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Mon Oct 07 2024 11:45:58 GMT-0700 (Pacific Daylight Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@sefeng:mozilla.org">sefeng</span>&gt;</div></td><td class="msg-cell">ok, makes sense, thanks! </td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Mon Oct 07 2024 13:33:55 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: do you happen to have some high level description somewhere for the worker GC stuff?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Mon Oct 07 2024 13:45:52 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@smaug:mozilla.org">smaug</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1822411">https://bugzilla.mozilla.org/show_bug.cgi?id=1822411</a> <span class="nick-16">mccr8</span></td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Mon Oct 07 2024 13:47:17 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Thanks. Yeah I looked at one of the patches a tiny bit. I think I'm monitoring phabricator changes to nsCycleCollector.cpp or something. There's a lot more patches, looks like!</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Mon Oct 07 2024 14:17:41 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><p>The short comment in WorkerPrivate.cpp describes the basic approach. The final version of it is:</p>
<pre><code>  // Set up timers to implement the Worker GC scheduling scheme:
  //
  //   (1) run a non-shrinking GC whenever eager limits are reached while the
  //   worker is running.
  //
  //   (2) if the worker goes idle and stays idle for IDLE_GC_DELAY_SEC, run a
  //   compacting GC.
  //
  //   (3) run a fallback GC occasionally while the worker is running.
  //
  // All of these GCs are incremental. Internally-triggered GCs from hitting a
  // hard threshold or due to zeal modes (for testing) are non-incremental.

</code></pre>
</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Mon Oct 07 2024 14:18:03 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(note that I'm not sure we really need the fallback GC)</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Mon Oct 07 2024 14:25:31 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Also, I've moved more towards never cancelling the timers when changing states, because in my test scenarios the states change way too often. So everything works by checking worker private state in the timeout callbacks and deciding whether to do something or kill the timer or whatever. So eg when going from Busy -&gt; Idle, it'll set a member variable saying that we want an idle GC after now+5seconds. Then the timer callbacks will check that and see if it's time to GC. If there's a lot of Busy-&gt;Idle-&gt;Busy-&gt;..., then that trigger time will keep getting pushed out, but we won't repeatedly cancel and restart the timer; we'll just let it run, then when it fires decide whether to (1) run a GC, (2) reschedule it for a future time, or (3) just let it die. (1) is mIdleGCTime &lt; now, (2) is mIdleGCTime &gt; now, (3) is mIdleGCTime is null.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Mon Oct 07 2024 15:11:31 GMT-0700 (Pacific Daylight Time)">22:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I have a question about interrupt callbacks.  Under what circumstances are they called other than API requests?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Mon Oct 07 2024 15:21:36 GMT-0700 (Pacific Daylight Time)">22:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I have a question about interrupt callbacks.  Under what circumstances are they called other than API requests?</blockquote></mx-reply><p>I'm using an interrupt handler in my code, and I decided to count how many times it is called.  Strangely, it only seems to be called after I call JS_RequestInterruptCallback.</p>
<p>I expected that it would be called a number of times for other reasons, like garbage collection.</p>
</td></tr>

</tbody></table></div></div></div>
</body></html>