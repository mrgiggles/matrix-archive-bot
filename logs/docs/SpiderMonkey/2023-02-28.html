<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2023-02-28</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2023-02-28<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-02-27" class="nav-link"><span>prev</span></a>
<a href="2023-03-01" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Feb 28 2023 00:49:30 GMT-0800 (Pacific Standard Time)">08:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">It is a bit contentious but we are repeating the pattern right now for symbol <a href="https://github.com/tc39/proposal-symbol-predicates">https://github.com/tc39/proposal-symbol-predicates</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Feb 28 2023 00:50:01 GMT-0800 (Pacific Standard Time)">08:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">So i wouldn't say that it is impossible for more &lt;X&gt;.is&lt;X&gt; pattern checks in the language. </td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Feb 28 2023 00:55:00 GMT-0800 (Pacific Standard Time)">08:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">There was such a proposal for error.isError: <a href="https://github.com/ljharb/proposal-is-error">https://github.com/ljharb/proposal-is-error</a> --  but it was withdrawn in favor of error.stacks <a href="https://github.com/tc39/proposal-error-stacks">https://github.com/tc39/proposal-error-stacks</a> -- Notes here: <a href="https://github.com/tc39/notes/blob/main/meetings/2016-03/march-29.md#erroriserror">https://github.com/tc39/notes/blob/main/meetings/2016-03/march-29.md#erroriserror</a> -- looks like the reason was that error.isError is polyfillable and there was some discussion about the name, but ultimately being able to check the error stack was seen as more useful at the time.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Feb 28 2023 00:56:10 GMT-0800 (Pacific Standard Time)">08:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">gijs</span>: ^</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Feb 28 2023 02:09:13 GMT-0800 (Pacific Standard Time)">10:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">One of the potentially problematic things with Array.isArray is that also returns true for ES6 proxies wrapping arrays</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Feb 28 2023 03:10:59 GMT-0800 (Pacific Standard Time)">11:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">yulia</span>: thanks for the context. Those notes are... a bit tricky to read. I'm a little puzzled that we have <code>isInstance</code> for pretty much every DOM type, to deal with x-realm issues with <code>instanceof</code>. Is this "just" a case of TC39 and DOM spec folks making different decisions? Some of the language in the notes seems to suggest that those kinds of checks are categorically wrong / unnecessary or something.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Feb 28 2023 03:11:56 GMT-0800 (Pacific Standard Time)">11:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell">(1819134 happened because we wanted decent stringification of non-Error objects, for which someone chose <code>JSON.stringify</code>, which is not useful for <code>Error</code> because all the props are on the proto so the stringification is <code>{}</code>. Coupled with checking <code>instanceof Error</code> meant reporting of x-realm errors got worse)</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Feb 28 2023 03:12:36 GMT-0800 (Pacific Standard Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell">It sounds like the TC39 folks are suggesting we should "just" check for <code>error.stack</code> to determine if something is an Error?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Feb 28 2023 03:12:42 GMT-0800 (Pacific Standard Time)">11:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell">But maybe I'm misreading the notes.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Feb 28 2023 03:13:31 GMT-0800 (Pacific Standard Time)">11:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell"><p>(in particular, I struggle to parse:</p>
<blockquote>
<p>DH: I don't like paternalistic arguments. I'm not making a paternalistic argument. Language has a normative role.</p>
</blockquote>
<p>Not entirely clear to me what that's referring to.)</p>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Feb 28 2023 03:16:29 GMT-0800 (Pacific Standard Time)">11:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I don't think that particular comment added very much in terms of context for the decision</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Feb 28 2023 03:17:17 GMT-0800 (Pacific Standard Time)">11:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">regarding what the suggestion is -- the committee was proposing to correctly check for an error stack, as errors (which are ordinary objects aside from the stack) will always have them</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Feb 28 2023 03:18:32 GMT-0800 (Pacific Standard Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell">I mean that is certainly less ugly than my use of <code>Cu.getGlobalForObject()</code> followed by <code>instanceof</code> :)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Feb 28 2023 03:19:43 GMT-0800 (Pacific Standard Time)">11:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">the argument against Array.isArray style calls in this case is, as far as I understand the conversation is that Array is a special case because it is an exotic, but generally we shouldn't have is&lt;x&gt; as a pattern as we don't want to make brand checking common place in JS. I would need to find the notes on brand checking, i believe that was in 2015 -- since then we have introduced a way to ergonomically check a brand via <a href="https://github.com/tc39/proposal-private-fields-in-in">https://github.com/tc39/proposal-private-fields-in-in</a> -- so there may be some shift in committee regarding this</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Feb 28 2023 03:20:30 GMT-0800 (Pacific Standard Time)">11:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but digging into why or why not committee would not want this pattern doesn't help your case unfortunately, so we can focus on the error.stack suggestion</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Feb 28 2023 03:20:47 GMT-0800 (Pacific Standard Time)">11:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">the error.stack version, I think, might work in your cross realm case?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Feb 28 2023 03:21:49 GMT-0800 (Pacific Standard Time)">11:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">yulia</span>: yes, I think so. Out of interest, what would checking "correctly" specifically look like? Just falsy-checking <code>err.stack</code>, or something more elaborate like seeing if <code>Object.getOwnPropertyDescriptor(Object.getPrototypeOf(err), "stack")</code> was non-null?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Feb 28 2023 03:22:05 GMT-0800 (Pacific Standard Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell">(whatever I do only has to work with spidermonkey)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Feb 28 2023 03:22:32 GMT-0800 (Pacific Standard Time)">11:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">regarding "don't do brand checking" -&gt; <a href="https://github.com/tc39/notes/blob/c7fa95d3f2d0af68eaba9d388d5f79f2e166a4cc/meetings/2015-11/nov-19.md?plain=1#L470">https://github.com/tc39/notes/blob/c7fa95d3f2d0af68eaba9d388d5f79f2e166a4cc/meetings/2015-11/nov-19.md?plain=1#L470</a> we didn't get a reason in the notes unfortunately</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Feb 28 2023 03:23:29 GMT-0800 (Pacific Standard Time)">11:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-10">yulia</span>: yes, I think so. Out of interest, what would checking "correctly" specifically look like? Just falsy-checking <code>err.stack</code>, or something more elaborate like seeing if <code>Object.getOwnPropertyDescriptor(Object.getPrototypeOf(err), "stack")</code> was non-null?</blockquote></mx-reply>I think this wouldn't work in the case that you just create an ordinary object with a stack property. So you need some way to know that the error was actually thrown</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Feb 28 2023 03:25:43 GMT-0800 (Pacific Standard Time)">11:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Since it is chrome code you are working with it is technically possible for us to do something custom. The error object itself is one of the least specified parts of the spec (in part, intentionally). But I am not sure we currently have capacity for it. I will need to take some more time to look at it</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Feb 28 2023 03:25:55 GMT-0800 (Pacific Standard Time)">11:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> regarding "don't do brand checking" -&gt; <a href="https://github.com/tc39/notes/blob/c7fa95d3f2d0af68eaba9d388d5f79f2e166a4cc/meetings/2015-11/nov-19.md?plain=1#L470">https://github.com/tc39/notes/blob/c7fa95d3f2d0af68eaba9d388d5f79f2e166a4cc/meetings/2015-11/nov-19.md?plain=1#L470</a> we didn't get a reason in the notes unfortunately</blockquote></mx-reply><p>This is also interesting. Especially:</p>
<blockquote>
<p>DD: A cross-realm Error won't work. Why do you want to check whether it's a real error?</p>
</blockquote>
<p>I mean, that's not really true in our world... I don't know if that's just because of how we deal with things or if <code>realm</code> doesn't map cleanly to our concepts around principals and windows...</p>
</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Feb 28 2023 03:27:20 GMT-0800 (Pacific Standard Time)">11:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think this wouldn't work in the case that you just create an ordinary object with a stack property. So you need some way to know that the error was actually thrown</blockquote></mx-reply>Yeah I don't think we care about the hostile code case here particularly, we're just concerned about error reporting in our own automated tests and wanting log files that have useful information as opposed to "an error got thrown: {}" which I'm sure you'd agree is... not helpful :)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Feb 28 2023 03:28:12 GMT-0800 (Pacific Standard Time)">11:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell">I suppose the code for error logging cares about "real" Errors particularly because of the custom stringification</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Feb 28 2023 03:28:38 GMT-0800 (Pacific Standard Time)">11:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell">that is, <code>String(realError)</code> is useful and <code>String(someOtherObject)</code> produces <code>[object Object]</code> which is also less useful ("also" - as in, just as useful as <code>JSON.stringify(realError)</code> producing <code>{}</code>).</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Feb 28 2023 03:28:58 GMT-0800 (Pacific Standard Time)">11:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell">I don't know that there is a good way to effectively "feature check" specifically for that part of the <code>Error</code> behaviour</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Feb 28 2023 03:30:31 GMT-0800 (Pacific Standard Time)">11:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Since it is chrome code you are working with it is technically possible for us to do something custom. The error object itself is one of the least specified parts of the spec (in part, intentionally). But I am not sure we currently have capacity for it. I will need to take some more time to look at it</blockquote></mx-reply>To be clear, definitely not asking you to spend extra time on this. The patch I have up at the moment works, it's just ugly, so I was curious if something more ergonomic was on the horizon and/or why not. :)</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Feb 28 2023 03:32:02 GMT-0800 (Pacific Standard Time)">11:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">Looking at your current patch, it seems to be the right approach for now. Regarding if this will be solved at a committee level: the proposal has stalled for a few years, but it may be picked up at some point. It may be worth commenting on the proposal with the usecase you came across. While principles do not map to realms, globals do and it seems like  the problem you are trying to solve is very similar to the one jordan brought up.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Feb 28 2023 03:32:38 GMT-0800 (Pacific Standard Time)">11:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">So: the short version would be : it looks like the solution you have right now in chrome code is good. Unclear if committee will move on this but your experience / the use case you encountered is a valid one and may help the proposal along. </td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Feb 28 2023 03:36:13 GMT-0800 (Pacific Standard Time)">11:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">yes... and it looks like it was intentional at the time so it is a bit weird that it returns true in that case given that it is used as the canonical example for brand checks. </td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Feb 28 2023 05:23:42 GMT-0800 (Pacific Standard Time)">13:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-10">yulia</span>: thanks for the context. Those notes are... a bit tricky to read. I'm a little puzzled that we have <code>isInstance</code> for pretty much every DOM type, to deal with x-realm issues with <code>instanceof</code>. Is this "just" a case of TC39 and DOM spec folks making different decisions? Some of the language in the notes seems to suggest that those kinds of checks are categorically wrong / unnecessary or something.</blockquote></mx-reply>Just to clarify something: isIstance is not something provided by the DOM. It's a non standard feature for Gecko chrome code.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Feb 28 2023 07:01:25 GMT-0800 (Pacific Standard Time)">15:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@ms2ger:igalia.com">Ms2ger</span>&gt;</div></td><td class="msg-cell">Is there a shortcut to build just the jsapi tests?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Feb 28 2023 08:23:07 GMT-0800 (Pacific Standard Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>mach build js/src/jsapi-tests</code> ? (If you already have a full compile, shell or browser.)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Feb 28 2023 08:52:31 GMT-0800 (Pacific Standard Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">hm, im a bit stuck on a leak</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Feb 28 2023 08:52:40 GMT-0800 (Pacific Standard Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><p>I have the following objects leaking:</p>
<pre><code>1:12.92 INFO      |&lt;----------------Class---------------&gt;|&lt;-----Bytes------&gt;|&lt;----Objects----&gt;|
 1:12.92 INFO      |                                      | Per-Inst   Leaked|   Total      Rem|
 1:12.92 INFO    0 |TOTAL                                 |       63      536|   38908        6|
 1:12.92 INFO  211 |LoadedScript                          |       48       48|      27        1|
 1:12.92 INFO  237 |ModuleScript                          |       80       80|      23        1|
 1:12.92 INFO  444 |ScriptFetchOptions                    |       40       40|      55        1|
 1:12.92 INFO  623 |nsAuthURLParser                       |       24       24|       2        1|
 1:12.92 INFO  802 |nsStandardURL                         |      336      336|     593        1|
 1:12.92 INFO  808 |nsStringBuffer                        |        8        8|   12071        1|
</code></pre>
</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Feb 28 2023 08:52:56 GMT-0800 (Pacific Standard Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">This occurs when a script is running forever and is abruptly terminated</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Feb 28 2023 08:53:28 GMT-0800 (Pacific Standard Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">and i cannot figure out what is keeping these objects alive -- I also tried clearing the mFetchedModules hashtable for the module loader, but still no luck</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Feb 28 2023 08:53:48 GMT-0800 (Pacific Standard Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">any suggestions on how to go about figuring out what is keeping this alive? it is the containing script (the child that runs forever is cleaned up)</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Feb 28 2023 08:56:17 GMT-0800 (Pacific Standard Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> any suggestions on how to go about figuring out what is keeping this alive? it is the containing script (the child that runs forever is cleaned up)</blockquote></mx-reply>One approach would be to look for errors in the log that might be related. A common cause of leaks like this is something is happening after some kind of shutdown has started, so the operation fails (like dispatching a runnable).</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Feb 28 2023 08:57:31 GMT-0800 (Pacific Standard Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">The "big hammer" approach is DMD heap scan mode which will log the contents of memory and do conservative scanning to let you find references in the heap to other heap objects. That can help in some situations, but it is a bit annoying to set up. <a href="https://firefox-source-docs.mozilla.org/performance/memory/heap_scan_mode.html">https://firefox-source-docs.mozilla.org/performance/memory/heap_scan_mode.html</a></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Feb 28 2023 08:57:42 GMT-0800 (Pacific Standard Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">The error that initially lead to this is that the global scope is still alive in the worker, which was also difficult to determine why it was failing -- but removing the assert for that (<a href="https://searchfox.org/mozilla-central/source/dom/workers/RuntimeService.cpp#2107">https://searchfox.org/mozilla-central/source/dom/workers/RuntimeService.cpp#2107</a>) revealed the leak...</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Feb 28 2023 08:58:01 GMT-0800 (Pacific Standard Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Another possibility is that there's a refcounting error somewhere, but that's less likely if you aren't doing manual refcounting.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Feb 28 2023 08:58:07 GMT-0800 (Pacific Standard Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The "big hammer" approach is DMD heap scan mode which will log the contents of memory and do conservative scanning to let you find references in the heap to other heap objects. That can help in some situations, but it is a bit annoying to set up. <a href="https://firefox-source-docs.mozilla.org/performance/memory/heap_scan_mode.html">https://firefox-source-docs.mozilla.org/performance/memory/heap_scan_mode.html</a></blockquote></mx-reply>ok, looks like i have some reading to do...</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Feb 28 2023 08:58:35 GMT-0800 (Pacific Standard Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">no manual refcounting... and it only happens for this infinitely running case, so its definitely something with shutdown..</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Feb 28 2023 09:00:08 GMT-0800 (Pacific Standard Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Maybe a cycle is getting made into garbage after that last worker CC is happening or something.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Feb 28 2023 09:01:34 GMT-0800 (Pacific Standard Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">ok, thanks for the pointers. I'll try to give it another go tomorrow</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Feb 28 2023 09:04:33 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">You'll have to tweak some of the options a bit (or maybe just one) because you want CC logs for worker threads and not the main thread.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Feb 28 2023 09:05:19 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Just looking at the CC logs first might be useful, before you get into the whole mess of DMD logs.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Feb 28 2023 09:09:20 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@gijs:mozilla.org">gijs</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Looking at your current patch, it seems to be the right approach for now. Regarding if this will be solved at a committee level: the proposal has stalled for a few years, but it may be picked up at some point. It may be worth commenting on the proposal with the usecase you came across. While principles do not map to realms, globals do and it seems like  the problem you are trying to solve is very similar to the one jordan brought up.</blockquote></mx-reply>Sorry, getting back to this - which proposal would this be? I looked at <a href="https://github.com/ljharb/proposal-is-error">https://github.com/ljharb/proposal-is-error</a> and that repo was archived because the proposal was withdrawn, so I'm not sure where best to comment...</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Feb 28 2023 11:26:21 GMT-0800 (Pacific Standard Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: would you like to talk through the hazards you're running into in bug 1773319? I think they should be straightforward to resolve, but I'd need to understand what's going on a little better to know the right mechanism to use.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Feb 28 2023 11:26:22 GMT-0800 (Pacific Standard Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1773319">https://bugzil.la/1773319</a> — ASSIGNED (bthrall) — Add public Stencil APIs to compile without JSContext</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Feb 28 2023 11:29:52 GMT-0800 (Pacific Standard Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Yes, that would be very helpful</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Feb 28 2023 11:30:58 GMT-0800 (Pacific Standard Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I could zoom right now.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Feb 28 2023 12:44:03 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">My computer just crashed?!</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Feb 28 2023 12:44:30 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">It seems to be plugged in. Usually this means the battery died </td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Feb 28 2023 14:36:23 GMT-0800 (Pacific Standard Time)">22:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: ok, uploaded patch to bug 1819470.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Feb 28 2023 14:36:25 GMT-0800 (Pacific Standard Time)">22:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1819470">https://bugzil.la/1819470</a> — ASSIGNED (sfink) — Implement annotation for marking a specific variable as always containing GC safe data</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Feb 28 2023 14:39:13 GMT-0800 (Pacific Standard Time)">22:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@bthrall:mozilla.org">Bryan Thrall [:bthrall]</span>&gt;</div></td><td class="msg-cell">Thanks!</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Feb 28 2023 14:41:40 GMT-0800 (Pacific Standard Time)">22:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">tcampbell</span>: is it the case that a <code>CompilationInput</code> for a <code>FrontendContext</code> will never have any GC  pointers in it anywhere? It looks like there are a few <code>Variant&lt;GC pointer, StencilThang&gt;</code> members. So can we depend on those variants always being the stencil variant?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Feb 28 2023 14:42:54 GMT-0800 (Pacific Standard Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">CompilationInput GC-pointers should only be used on main thread. For Bryan's work, it probably makes sense to assert they are null and add the gc annotation.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Feb 28 2023 14:43:59 GMT-0800 (Pacific Standard Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The cases where we use the CompilationInput meaningfully are generally all synchronous things like <code>eval</code>, while the work Bryan is doing is for top-level global scripts or modules scripts where we want the freedom to schedule them on mainthread or worker threads</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Feb 28 2023 14:48:45 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Oh right, main-thread delazification is the other tricky case, but I think they uses special internal APIs already since it is doing some sort of JSScript surgery</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Feb 28 2023 14:49:08 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Hopefully this is distinguishable from the top-level entry point?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Feb 28 2023 14:49:17 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">yep</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue Feb 28 2023 14:49:31 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, good. So yeah, it seems like this annotation should be ok.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue Feb 28 2023 14:49:45 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/frontend/CompilationStencil.h#579-585">https://searchfox.org/mozilla-central/source/js/src/frontend/CompilationStencil.h#579-585</a></td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue Feb 28 2023 14:50:31 GMT-0800 (Pacific Standard Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">I believe only <code>Global</code> and <code>Module</code> should use this gc-free parse-wherever-you-want stuff</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue Feb 28 2023 14:54:55 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The objective is to remove the explicit off-thread parse APIs which were actually disallowed on main-thread and allow scheduling of parses to be more dynamic rather than winding up stuck in work queues until they cleared.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue Feb 28 2023 15:01:21 GMT-0800 (Pacific Standard Time)">23:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: maybe you can add some sort of <code>assertSafeForAnyThread</code> method to the <code>CompilationInput</code>? Checking the InputScope, InputScript, atomcache, etc.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue Feb 28 2023 15:02:16 GMT-0800 (Pacific Standard Time)">23:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">This question came up a few times and I don't think we make it very obvious. (Originally my fault for not polishing this up as we built the apis)</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue Feb 28 2023 15:03:02 GMT-0800 (Pacific Standard Time)">23:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">The <code>CompilationInput::trace</code> method is place to cross-check you covered the right conditions too :)</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue Feb 28 2023 15:05:02 GMT-0800 (Pacific Standard Time)">23:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@tcampbell:mozilla.org">tcampbell</span>&gt;</div></td><td class="msg-cell">Asserting the mode is also Global/Module might be good just as a form of documentation.</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue Feb 28 2023 15:41:32 GMT-0800 (Pacific Standard Time)">23:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Bryan Thrall [:bthrall]</span>: thinking about it, that annotation may not magically solve all the problems. The <code>CompilationInput</code> will be passed down into other functions, and those could still have hazards (unless it is re-annotated in each function in which it is live across a GC call. Not that any of them will be GC calls in practice.)</td></tr>

</tbody></table></div></div></div>
</body></html>