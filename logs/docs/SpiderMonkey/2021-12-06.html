<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-12-06</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-12-06<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-12-05" class="nav-link"><span>prev</span></a>
<a href="2021-12-07" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Dec 06 2021 06:30:19 GMT-0800 (Pacific Standard Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@saulecabrera:mozilla.org">saulecabrera</span>&gt;</div></td><td class="msg-cell">Hey everyone, I’m working on Rust bindings for SpiderMonkey (exclusively for the wasm32-wasi target <a href="https://github.com/bytecodealliance/spidermonkey-wasm-rs">https://github.com/bytecodealliance/spidermonkey-wasm-rs</a>) and I have a question regarding interacting with the Rooting API. To be able to safely use <code>Rooted&lt;T&gt;</code> is the recommended/best approach in this case to keep a vector of rooted elements in Rust’s side (similar to what’s done by mozjs)? Or is there any other approach worth considering?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Dec 06 2021 06:36:55 GMT-0800 (Pacific Standard Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">saulecabrera</span>: The way <code>Rooted&lt;…&gt;</code> works is by appending the stack element in a list of thread-local elements of the same type. <code>mozjs</code> predates the introduction of <code>Pin</code> type, which, IIRC, would offer a similar behavior.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Dec 06 2021 06:38:25 GMT-0800 (Pacific Standard Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><a href="https://doc.rust-lang.org/std/pin/index.html">https://doc.rust-lang.org/std/pin/index.html</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Dec 06 2021 07:16:22 GMT-0800 (Pacific Standard Time)">15:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Q: What does it mean that <code>flags()</code> of a <code>Cell</code> is <code>1</code>?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Dec 06 2021 07:16:49 GMT-0800 (Pacific Standard Time)">15:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">I can see that it's reserved for GC, but I don't find for what exactly</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Dec 06 2021 07:18:07 GMT-0800 (Pacific Standard Time)">15:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">nicolo-ribaudo</span>: does this help? <a href="https://searchfox.org/mozilla-central/source/js/src/gc/Cell.h#146">https://searchfox.org/mozilla-central/source/js/src/gc/Cell.h#146</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Dec 06 2021 07:19:21 GMT-0800 (Pacific Standard Time)">15:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@evilpie:mozilla.org">evilpie</span>&gt;</div></td><td class="msg-cell">sry wrong paste buffer</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Dec 06 2021 07:20:27 GMT-0800 (Pacific Standard Time)">15:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Uh yes, and it was a few lines above from what I was looking at 🙃 Thanks!</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Dec 06 2021 07:22:39 GMT-0800 (Pacific Standard Time)">15:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">This brings to the question: "is it normal that the GC tracer traces the edges of an already forwarded cell?" - EDIT: Nevermind, I found the method that solves my problem (<code>MaybeForwardedObjectIs</code>)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Dec 06 2021 07:59:06 GMT-0800 (Pacific Standard Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">nbp: That <code>Pin</code> type looks like it's for preventing things from moving via that specific <code>Pin&lt;T&gt;</code> value, not that the underlying value can't itself move. And the SM GC doesn't really offer a way to prevent a Cell from moving, other than suppressing GC entirely.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Dec 06 2021 08:01:11 GMT-0800 (Pacific Standard Time)">16:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">nicolo-ribaudo</span>: It is normal to trace new edges to already-forwarded cells. It should be rare to trace the same edge multiple times, but iirc it can happen. (I think one way is if the mark stack gets too big halfway through doing some marking, we'll fall back to marking the entire page or arena, which can re-mark some stuff. But there are probably simpler ways.)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Dec 06 2021 08:01:56 GMT-0800 (Pacific Standard Time)">16:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Thanks!</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Dec 06 2021 08:51:49 GMT-0800 (Pacific Standard Time)">16:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: My understanding is that the Pin type is used to hold some memory, indendently of where it is located, like the Rooted type is used to hold space on the stack.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Dec 06 2021 09:00:18 GMT-0800 (Pacific Standard Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I guess the semantic of <code>Pin</code> is not as obvious, as it applies to the wrappee, and not the wrapper.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Dec 06 2021 09:01:44 GMT-0800 (Pacific Standard Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@saulecabrera:mozilla.org">saulecabrera</span>&gt;</div></td><td class="msg-cell">Thanks for the input <span class="nick-2">nbp</span>  and <span class="nick-12">sfink</span> , I appreciate it. I haven’t used Pin extensively, but my question here would be, would using Pin cause any sort of friction/unexpected behaviour if the GC tries to perform any moves?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Dec 06 2021 09:02:37 GMT-0800 (Pacific Standard Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">saulecabrera</span>: What is expected by the GC is to have a single-linked list of rooted. What matters is the order in which things are added and remove from this list.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Dec 06 2021 09:03:16 GMT-0800 (Pacific Standard Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">as I read it, <code>Pin</code> is <em>not</em> used to prevent something from moving. I'll paste a quote:</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Dec 06 2021 09:03:21 GMT-0800 (Pacific Standard Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">"It is worth reiterating that Pin&lt;P&gt; does not change the fact that a Rust compiler considers all types movable. mem::swap remains callable for any T. Instead, Pin&lt;P&gt; prevents certain values (pointed to by pointers wrapped in Pin&lt;P&gt;) from being moved by making it impossible to call methods that require &amp;mut T on them (like mem::swap)."</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Dec 06 2021 09:04:03 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">at least, my interpretation of that is that <code>Pin&lt;T&gt;</code> is just a type that guarantees that the <code>T</code> won't be moved by someone who only has access to the <code>Pin&lt;T&gt;</code>.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Dec 06 2021 09:04:10 GMT-0800 (Pacific Standard Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I suggested <code>Pin</code> as a way to ensure that Rooted addresses are not changed, thus can be used in a linked list, assuming the drop are following RAII rules.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Dec 06 2021 09:05:22 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>Rooted</code> doesn't really say anything about whether something can be moved. It just makes sure it stays alive, and that if the contained pointer <em>is</em> moved, that the <code>Rooted</code> copy of it will get updated correctly.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Dec 06 2021 09:06:51 GMT-0800 (Pacific Standard Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">What does not move, is the <code>Rooted</code> address which is on the stack, and which is expected to remain constant as it is part of the single linked list used to iterate over <code>Rooted</code> elements which are on the stack.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Dec 06 2021 09:06:53 GMT-0800 (Pacific Standard Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ah, sorry. I think you're telling me that you want <code>Pin</code> to enable the implementation of <code>Rooted</code> to work</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Dec 06 2021 09:07:08 GMT-0800 (Pacific Standard Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, I agree with that. Sorry.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Dec 06 2021 09:08:16 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">I have no clue how to write that in Rust … <code>Pin</code> is the only Rust construct I know which provide a piece of the puzzle.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Dec 06 2021 09:10:10 GMT-0800 (Pacific Standard Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I don't know the Rust setup with respect to GC pointers either. In C++, we basically handle this sort of thing with an added pointer indirection -- you pass around pointers to movable pointers, and make sure not to hang onto the movable pointer when you're calling something that might invalidate it (by moving what it points to).</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Dec 06 2021 09:12:07 GMT-0800 (Pacific Standard Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">as long as you (1) re-fetch the pointed-to pointer every time it might have changed, and (2) make sure something gets called that updates the pointer if its target <code>Cell</code> moves during a GC, you're good. (<code>Rooted</code> is used for the latter for stack values. Tracing is used for heap values.)</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Dec 06 2021 09:14:14 GMT-0800 (Pacific Standard Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">well, I guess I left out (3) if this might be the last surviving reference to the Cell, then make sure it gets traced during a GC so it doesn't die and get collected. <code>Rooted</code> and tracing do both 2 &amp; 3 for stack and heap values, respectively.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Dec 06 2021 09:26:38 GMT-0800 (Pacific Standard Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Hum … I wonder if using a vector for Rooted might be sensible in Spidermonkey as well.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Dec 06 2021 09:26:58 GMT-0800 (Pacific Standard Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">This would avoid chasing pointers on the stack.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Dec 06 2021 09:35:49 GMT-0800 (Pacific Standard Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">Would it? I'm trying to think through the relevant operations, and I'm not sure it would change anything. In either case, the <code>Rooted</code> constructor needs to look up the root list. Right now it stores a pointer to a <code>Rooted</code>, but it could be a <code>Vector</code> header. Then you write into the <code>Rooted</code> space, which is on the C stack and so free-ish. Then you update the root list. In either implementation, you look up a predictable address and read and write it, plus do some manipulation that is very local on the C stack.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Dec 06 2021 09:37:10 GMT-0800 (Pacific Standard Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in <code>~Rooted</code>, the current implementation doesn't have to re-lookup the root list, since it stored a pointer to it in the ctor. So again, it's local C stack manipulation plus a write into the root list memory. It would be the same with a vector.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Dec 06 2021 09:37:12 GMT-0800 (Pacific Standard Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Dec 06 2021 09:37:47 GMT-0800 (Pacific Standard Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but the vector would need to potentially realloc memory, whereas the linked list doesn't.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Dec 06 2021 09:39:07 GMT-0800 (Pacific Standard Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">True, the vector only makes sense performance wise, while marking the rooted, while the stacked linked list is more local when creating these.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Dec 06 2021 09:39:38 GMT-0800 (Pacific Standard Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">And we likely create/destroy more than we traverse the full list.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Dec 06 2021 09:39:39 GMT-0800 (Pacific Standard Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, I think marking is a 1% case. The vector version would be faster.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Dec 06 2021 09:41:15 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><code>PersistentRooted</code> might have different tradeoffs, but it's relatively uncommon.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Dec 06 2021 09:55:17 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For what it's worth, I believe V8 uses segmented vectors for stack rooting</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Dec 06 2021 09:55:27 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I ran into it while porting irregexp</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon Dec 06 2021 09:58:19 GMT-0800 (Pacific Standard Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I think they have auto-rooting for new allocations and stuff. I wonder if that incurs more space pressure? I've looked at their setup, but I'm not sure I ever fully understood what's going on there. They don't require a static analysis like we do, which is very nice.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon Dec 06 2021 09:59:28 GMT-0800 (Pacific Standard Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Oilpan also has some kind of conservative stack scanning.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon Dec 06 2021 09:59:42 GMT-0800 (Pacific Standard Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">(They try to run it when the stack is empty, but they can't always.)</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Mon Dec 06 2021 10:00:43 GMT-0800 (Pacific Standard Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The other big difference I remember is that because roots aren't stored in stack frames, they don't have to free them at function granularity</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Mon Dec 06 2021 10:01:19 GMT-0800 (Pacific Standard Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that's a good point</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Mon Dec 06 2021 10:01:59 GMT-0800 (Pacific Standard Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or said otherwise: because they aren't stored in stack frames, they require a separate data structure. ;-)</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Mon Dec 06 2021 10:02:04 GMT-0800 (Pacific Standard Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So when you allocate something it just goes into the current handle scope, and will be rooted until you exit that scope</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Mon Dec 06 2021 10:03:04 GMT-0800 (Pacific Standard Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I'm not sure how far that gets them in not needing a hazard analysis</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Mon Dec 06 2021 10:03:32 GMT-0800 (Pacific Standard Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I remember being a bit spooked by the whole situation, but I could definitely have been missing something</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Mon Dec 06 2021 10:06:08 GMT-0800 (Pacific Standard Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">given what mccr8 said about oilpan needing a conservative scan, you're probably right to be spooked</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Mon Dec 06 2021 10:06:41 GMT-0800 (Pacific Standard Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">but it still seems like their setup is much safer for an embedding than ours</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Mon Dec 06 2021 10:07:02 GMT-0800 (Pacific Standard Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(for an embedding that isn't using the hazard analysis, I mean)</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Mon Dec 06 2021 10:16:24 GMT-0800 (Pacific Standard Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Oilpan also has some kind of conservative stack scanning.</blockquote></mx-reply>“Reference handling for heap objects is precise, and conservative for the native stack.” — <a href="https://v8.dev/blog/oilpan-library">https://v8.dev/blog/oilpan-library</a></td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Mon Dec 06 2021 10:18:41 GMT-0800 (Pacific Standard Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Whoa … 😲 🤮 … When you know all the trouble reported against SpiderMonkey because of the conservative GC … This is an unexpected move.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Mon Dec 06 2021 10:23:47 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Also, they are now using 32 bits pointers in v8, IIRC, which is even better to create false positive while using a conservative GC.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Mon Dec 06 2021 10:31:47 GMT-0800 (Pacific Standard Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Well, like I said, they try to run it only when the stack is empty, so it'll mostly affect them when there is a nested eventloop or the like.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Mon Dec 06 2021 10:32:14 GMT-0800 (Pacific Standard Time)">18:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">The interaction with their pointer compression stuff is a good point. I hadn't thought about that part of it.</td></tr>

</tbody></table></div></div></div>
</body></html>