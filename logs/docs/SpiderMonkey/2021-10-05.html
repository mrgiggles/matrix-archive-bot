<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2021-10-05</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2021-10-05<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-10-04" class="nav-link"><span>prev</span></a>
<a href="2021-10-06" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Oct 05 2021 03:57:09 GMT-0700 (Pacific Daylight Time)">10:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1733899#c4">https://bugzilla.mozilla.org/show_bug.cgi?id=1733899#c4</a> What?! This sounds wrong to me, as RInstruction can potentially delay objects mutations which might happen before an exception is raised. Thus making the out-of-order induce by the optimizing JIT visible within JavaScript, which can lead to differential behaviour.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Oct 05 2021 05:25:06 GMT-0700 (Pacific Daylight Time)">12:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">yulia</span>: how were you using the spec comment's revision hash?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Oct 05 2021 06:02:07 GMT-0700 (Pacific Daylight Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: there were name changes to how modules were initialized, so i wasn't sure from which revision we had the name from</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Oct 05 2021 06:02:58 GMT-0700 (Pacific Daylight Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">but, i don't think the way we do it now is good, fwiw -- it might be better to include the commit hash of the spec in the commit message or something?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Oct 05 2021 06:03:35 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I found the change by a best guess and bisecting, since the commit hash wasn't there -- it took a bit of time but wasn't a huge issue</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Oct 05 2021 06:19:00 GMT-0700 (Pacific Daylight Time)">13:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">yulia: if there's hash, do you build the spec for given hash, or is there static history?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Oct 05 2021 06:19:50 GMT-0700 (Pacific Daylight Time)">13:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ecma262-compare provides partial history, but less than 2 years</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Oct 05 2021 06:20:10 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">arai</span>: I use the github repo to track the spec back</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Oct 05 2021 06:20:23 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">oh, and this is also why we introduced the searchfox view of the spec actually</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Oct 05 2021 06:20:31 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">ah</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Oct 05 2021 06:20:45 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/ecma262/rev/eb84feeb87e20865178af81ea575fa801c740212/spec.html#796">https://searchfox.org/ecma262/rev/eb84feeb87e20865178af81ea575fa801c740212/spec.html#796</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Oct 05 2021 06:20:49 GMT-0700 (Pacific Daylight Time)">13:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">for example</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Oct 05 2021 06:21:11 GMT-0700 (Pacific Daylight Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">can't remember why i was looking at that, its from my history</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Oct 05 2021 06:21:31 GMT-0700 (Pacific Daylight Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">okay, then I'll add the hash to spec comment</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Oct 05 2021 06:21:59 GMT-0700 (Pacific Daylight Time)">13:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">It probably shoudn't be for every one, though I am unsure what a good system here would be</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Oct 05 2021 06:22:12 GMT-0700 (Pacific Daylight Time)">13:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@yulia:mozilla.org">yulia</span>&gt;</div></td><td class="msg-cell">I really like the changes you made to the comments</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Oct 05 2021 07:11:14 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">commit message works only when the section comment is updated at the latest change I think.  unless we introduce some system that collects all spec comment for the function and find the latest commit's message</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Oct 05 2021 07:12:49 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@arai:mozilla.org">arai</span>&gt;</div></td><td class="msg-cell">so, having hash in each section comment would be simpler solution for now</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Oct 05 2021 08:23:50 GMT-0700 (Pacific Daylight Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: It's <a href="https://phabricator.services.mozilla.com/D125360">this patch</a>. We're just saving the exception before running the RInstruction interpreter. There shouldn't be any change in behaviour.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Oct 05 2021 08:26:55 GMT-0700 (Pacific Daylight Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Ok. Nevermind then, thanks for the pointer. </td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Oct 05 2021 09:21:54 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell"><p>I'm bit stuck on <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1733480">https://bugzilla.mozilla.org/show_bug.cgi?id=1733480</a><br>I'm starting to think that storing <code>SavedFrame</code>'s into an <code>ObjectWeakMap</code> as a value<br>introduces some hazardry in GC rules.<br>Could there be some very special GC rule that gets in the way here?<br>Where using a random JS Object as a key and a SavedFrame as a value in a  ObjectWeakMap<br>ends up forcing either the key or the value to be kept in memory.</p>
<ul>
<li>Note that there is cross references between the key (a JS object) and the value (the SavedFrame)<br>The SavedFrame (value) comes from the same global as the JSObject (key), which is a global attribute.<br>So that keeping the SavedFrame in memory keeps the JSObject and the other way around, via the weakmap.</li>
</ul>
</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Oct 05 2021 09:26:37 GMT-0700 (Pacific Daylight Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">jonco: you around? I'd like to discuss bug 1717553</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Oct 05 2021 09:26:40 GMT-0700 (Pacific Daylight Time)">16:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1717553">https://bugzil.la/1717553</a> — NEW (jonco) — On YouTube, some of the memory of previous pages is not cleared</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Oct 05 2021 09:30:10 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ochameau</span>: I'm not sure if I fully follow, but if this ObjectWeakMap is alive (marked black / reachable from a regular root), then the reachability rules are the same as if it were a Map. And thus there is a strong reference from the key to the SavedFrame value.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Oct 05 2021 09:31:02 GMT-0700 (Pacific Daylight Time)">16:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so yes, if the key is reachable from the value, then there's a cycle between them such that they'll keep each other alive</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Oct 05 2021 09:32:37 GMT-0700 (Pacific Daylight Time)">16:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Oh. Then, it makes perfect sense. This is this precise weakmap: <a href="https://searchfox.org/mozilla-central/source/js/src/vm/Realm.h#250-252">https://searchfox.org/mozilla-central/source/js/src/vm/Realm.h#250-252</a></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Oct 05 2021 09:33:19 GMT-0700 (Pacific Daylight Time)">16:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">But then... is ObjectsWeakMap a lie? It shouldn't be named this way? Or is it broken because of the actual key and values I'm using?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Oct 05 2021 09:34:05 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">By lie I mean... it isn't quite the behavior I would expect of a "weak map" ;)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Oct 05 2021 09:34:14 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I guess I'm not sure whether that weakmap should be marked black in your case.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Oct 05 2021 09:34:50 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">"weak map" <em>is</em> a bit of a misnomer. The correct term would be "ephemeron table", but that's a mouthful of jargon.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Oct 05 2021 09:36:08 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">where a regular map has edges from the map to each key, and from each key to its corresponding value, a weakmap has an edge from the <em>conjunction</em> of the (map, key) -&gt; value. As in, both the map and key have to be reachable in order for that edge to keep the value alive.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Oct 05 2021 09:36:48 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">that's different from the usual usage of "weak" in eg weak references, where the weak edge simply does not participate in keeping something alive</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Oct 05 2021 09:38:05 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">for your problem, it seems like either (1) you want the ObjectWeakMap to only be reachable from the corresponding global, or (2) to have a weak reference from the SavedFrame value to its global.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Oct 05 2021 09:38:39 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">the latter sounds kind of tricky, since I would imagine SavedFrames could have all sorts of references to things in that realm.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Oct 05 2021 09:39:59 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so I guess my question would be: why is that ObjectRealm getting traced? (I assume the ObjectRealm traces the objectMetadataTable uncondtionally.)</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Oct 05 2021 09:40:22 GMT-0700 (Pacific Daylight Time)">16:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, it is</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Oct 05 2021 09:41:00 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it's called from Realm::traceRoots</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Oct 05 2021 09:42:09 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">All what you just said make sense except the very last about ObjectRealm. And also, I'm bit confused about why cycles ends up keeping both key and value alive ? In theory, we no longer have anything justifying the key to be alive. That, except the value itself. Does that mean the weakmap holds strong reference to all keys?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Oct 05 2021 09:42:09 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm wondering if it could also be guarded by <code>shouldTraceGlobal()</code>?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Oct 05 2021 09:42:53 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">sorry, cycles don't keep themselves alive by themselves.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Oct 05 2021 09:43:15 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">in this case, it seems like the key is reachable from the global</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Oct 05 2021 09:43:27 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and so is the map</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Oct 05 2021 09:43:36 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(via Realm::traceRoots)</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Oct 05 2021 09:43:48 GMT-0700 (Pacific Daylight Time)">16:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Oct 05 2021 09:44:18 GMT-0700 (Pacific Daylight Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">but the global is only kept alive because of the SavedFrame</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Oct 05 2021 09:44:24 GMT-0700 (Pacific Daylight Time)">16:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">so... the cycle</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Oct 05 2021 09:45:15 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">if I stop recording SavedFrame in this weakmap, the realm and the global get freed</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Oct 05 2021 09:45:47 GMT-0700 (Pacific Daylight Time)">16:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">and so the key/JSObject which is a global attribute</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Oct 05 2021 09:46:20 GMT-0700 (Pacific Daylight Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yeah, I'm trying to think through what else could be reaching the global. Because I agree, it seems like just making the weakmap reachable should not be doing this.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Oct 05 2021 09:47:59 GMT-0700 (Pacific Daylight Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">I may be missing lots of knowlege on how the GC really work. But your suggestions seem to make sense in order to try to get rid of the cycle. </td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Oct 05 2021 09:49:12 GMT-0700 (Pacific Daylight Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Also... I was wondering if we could have a (3) option: Have a real weak map here? Have a really weak reference between each JSObject and their allocation site?</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Oct 05 2021 09:49:27 GMT-0700 (Pacific Daylight Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">allocation site being the SavedFrame</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Oct 05 2021 09:50:10 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I do agree with your point that nothing seems to be marking the global, so that part is still a mystery </td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Oct 05 2021 09:50:27 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">if that were a weak reference, what would keep the SavedFrame from just getting tossed out immediately?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Oct 05 2021 09:50:53 GMT-0700 (Pacific Daylight Time)">16:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">yes... sorry... I keep thinking about this while it is obviously wrong</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Oct 05 2021 09:52:31 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">do you have this in rr or Pernosco? Or an easy way to reproduce? I'd like to see what is marking the global.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Oct 05 2021 09:52:35 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">so... I'm looking into this because I'm trying to build some tool to detect and debug leaks. And these tools actually tell me the edge names of why the objects are being kept alive. </td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Oct 05 2021 09:52:54 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Here is the two typical path of why my transient globals are being kept alive:</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Oct 05 2021 09:53:09 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell"><pre><code>0:38.87 GECKO(175125) - other@no-stack:undefined.vm_stack[2]
 0:38.87 GECKO(175125)  \--&gt; Proxy@no-stack:undefined.proxy target
 0:38.88 GECKO(175125)  \--&gt; Debugger@no-stack:undefined.WeakMap entry value
 0:38.88 GECKO(175125)  \--&gt; Object@no-stack:undefined.Debugger.Object referent
 0:38.88 GECKO(175125)  \--&gt; Sandbox@no-stack:undefined
 0:38.88 GECKO(175125) - other@no-stack:undefined.script
 0:38.88 GECKO(175125)  \--&gt; other@no-stack:undefined.cacheir-object
 0:38.88 GECKO(175125)  \--&gt; Function@no-stack:undefined.shape
 0:38.88 GECKO(175125)  \--&gt; other@no-stack:undefined.base
 0:38.89 GECKO(175125)  \--&gt; other@no-stack:undefined.baseshape_global
 0:38.89 GECKO(175125)  \--&gt; Sandbox@no-stack:undefined
</code></pre>
</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Oct 05 2021 09:53:55 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">You should look at what the GC log tells you is the reason the stack things are alive.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Oct 05 2021 09:54:23 GMT-0700 (Pacific Daylight Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Well, I guess why the key is alive, as you know why the map is alive.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Oct 05 2021 09:54:31 GMT-0700 (Pacific Daylight Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Unfortunately, I'm not used to use rr/pernosco, so I don't have that. But I wrote a mochitest to easily reproduce the leak and explain everything: <a href="https://phabricator.services.mozilla.com/D127169">https://phabricator.services.mozilla.com/D127169</a></td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Oct 05 2021 09:56:18 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">well, it seems like that 2nd path is the relevant one here. There's a CacheIR thing leading to the global, which means it seems like JIT code is holding onto it.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Oct 05 2021 09:56:46 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">does it go away if you minimize memory usage from about:memory? (I think that'll discard JIT code.)</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue Oct 05 2021 09:57:42 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">I can give it a try. Is that enought to call <code>gMgr.minimizeMemoryUsage()</code> ?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue Oct 05 2021 10:00:06 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Yes... it is enough... OMG. I spent so much time on this and my helpers were actually telling me the truth :o</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue Oct 05 2021 10:00:59 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Calling minimize memory does free everything! Crazy. But why storing things in this weakmap does introduce the leak?</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue Oct 05 2021 10:01:33 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">...I'm still not sure about that. It seems like the JIT code should be enough for it to leak.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue Oct 05 2021 10:01:46 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">If I don't put the SavedFrame in this weakmap.... things do not start to leak.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue Oct 05 2021 10:03:00 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so it doesn't leak the global? I mean, without all the SavedFrame clutter, there wouldn't be as much stuff to leak.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue Oct 05 2021 10:04:40 GMT-0700 (Pacific Daylight Time)">17:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Yes, if I stop recording the SavedFrame in that ObjectWeakMap, the globals and everything related to it (global attributes and their allocation site/SavedFrame) are all freed. </td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue Oct 05 2021 10:05:18 GMT-0700 (Pacific Daylight Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Now, if I record the SavedFrame, everything starts leaking (what I just listed). But if minimizeMemory, everything is freed again.</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue Oct 05 2021 10:05:26 GMT-0700 (Pacific Daylight Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok. I see that in your mochitest too.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Tue Oct 05 2021 10:06:33 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I hope this isn't the allocation site processing getting JITted or something.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Tue Oct 05 2021 10:06:40 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Putting this just before checking the (real) JS weakref (The <code>ok(!!ref.get())</code>) does fix the leak :</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Tue Oct 05 2021 10:06:41 GMT-0700 (Pacific Daylight Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">let gMgr = Cc["@<a href="http://mozilla.org/memory-reporter-manager;1&quot;].getService">mozilla.org/memory-reporter-manager;1"].getService</a>(
    Ci.nsIMemoryReporterManager
  );
  await new Promise(r=&gt;gMgr.minimizeMemoryUsage(r));</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Tue Oct 05 2021 10:08:32 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Well... I'm getting quite some noise in the data of the Memory API. I suspect that I'm seeing the SavedFrame in the output of the Memory API. It actually makes sense as SavedFrame comes from the inspected debuggee... But still I rather sounds like internal data used by the Debugger API.</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Tue Oct 05 2021 10:08:58 GMT-0700 (Pacific Daylight Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">So. I wouldn't be surprised if there is some additional unexpected noise coming from the inspection.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Tue Oct 05 2021 10:09:37 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">jandem</span>: <span class="nick-4">iain</span>: any idea why there would be a CacheIR thing holding onto a global only when allocation site tracking is enabled?</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Tue Oct 05 2021 10:11:13 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell">Is there any reasons why the savedFrame would even be JSObjects?</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Tue Oct 05 2021 10:11:45 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">My tooling currently prints <code>other@no-stack:undefined.cacheir-object</code> it is actually some data that comes from the Memory API. I'd be happy to improve that if there is some more useful information we can leverage from the platform.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Tue Oct 05 2021 10:12:43 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">I'm using the <code>describeNode</code> method of the memory API: <a href="https://searchfox.org/mozilla-central/source/devtools/shared/test-helpers/allocation-tracker.js#499-501">https://searchfox.org/mozilla-central/source/devtools/shared/test-helpers/allocation-tracker.js#499-501</a></td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Tue Oct 05 2021 10:12:51 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">nbp</span>: <code>SavedFrame</code> inherits from <code>NativeObject</code></td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Tue Oct 05 2021 10:13:00 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">i.e. this API: <a href="https://searchfox.org/mozilla-central/source/dom/chrome-webidl/HeapSnapshot.webidl#69">https://searchfox.org/mozilla-central/source/dom/chrome-webidl/HeapSnapshot.webidl#69</a></td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Tue Oct 05 2021 10:13:17 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">or are you asking, should it?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Tue Oct 05 2021 10:13:38 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: CacheIR is linked to its caller, if the code is discarded but still on the stack, it should be able to return to its calling function, which has a callee which is a JSFunction?</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Tue Oct 05 2021 10:13:54 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@nbp:mozilla.org">nbp</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: I was asking why this was necessary.</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Tue Oct 05 2021 10:14:47 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I don't know why SavedFrame is done as an object. Probably makes the implementation easier. They get structured cloned, I know. And we want them as values in a weakmap for Debugger.</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Tue Oct 05 2021 10:15:24 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">and yes, it's not surprising to me that CacheIR would be able to reach a global, it's more about why there would be CacheIR in one case and not the other</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Tue Oct 05 2021 10:15:25 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">sfink</span>: Is this allocation site tracking distinct from the allocation site tracking we do for pretenuring?</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Tue Oct 05 2021 10:15:46 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes, they're different</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Tue Oct 05 2021 10:16:03 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">this is a heavyweight thing that grabs a stack when you allocate an object</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Tue Oct 05 2021 10:16:18 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Is this AllocationMetadataBuilder?</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Tue Oct 05 2021 10:16:22 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Tue Oct 05 2021 10:18:46 GMT-0700 (Pacific Daylight Time)">17:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So, the NewObject and NewArray ICs have to guard to make sure that there's no AllocationMetadataBuilder (<a href="https://searchfox.org/mozilla-central/source/js/src/jit/CacheIR.cpp#11347-11353">eg</a>) because the stub doesn't support it, but it seems like that would go the other way: we would hold onto the global only when tracking is <em>disabled</em></td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Tue Oct 05 2021 10:19:19 GMT-0700 (Pacific Daylight Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">hah!</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Tue Oct 05 2021 10:20:04 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">(though this is a failure of imagination on my part; I hadn't considered that the ICs would be different in the two cases)</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Tue Oct 05 2021 10:20:27 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">IIRC they're not different; we just don't attach if there's a builder</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Tue Oct 05 2021 10:20:43 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Although I guess that is a difference of sorts</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Tue Oct 05 2021 10:22:06 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">it's <em>the</em> important difference, just... backwards. :-(</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Tue Oct 05 2021 10:22:14 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Tue Oct 05 2021 10:22:58 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That's the only kind of stub we support for both of those operations, so if we don't attach that we won't attach anything, and we'll just end up calling the fallback a lot</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Tue Oct 05 2021 10:23:37 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Note that the leak isn't really tied to having an AllocationMetadataBuilder or not. It is really down to collecting the frame within it</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Tue Oct 05 2021 10:23:42 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">See this comment <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1733480#c7">https://bugzilla.mozilla.org/show_bug.cgi?id=1733480#c7</a></td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Tue Oct 05 2021 10:24:17 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">I got rid of the leak when only removing the weakmap population, while keeping the allocationMetadataBuilder around</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Tue Oct 05 2021 10:25:41 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">so like if you just comment out <a href="https://searchfox.org/mozilla-central/rev/75e9d727ce5ba2c14653cf8fb0f1367f085271b7/js/src/vm/Realm.cpp#470">https://searchfox.org/mozilla-central/rev/75e9d727ce5ba2c14653cf8fb0f1367f085271b7/js/src/vm/Realm.cpp#470</a> then the leak goes away?</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Tue Oct 05 2021 10:27:11 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">hum, that's not quite what I did, but I can try and tell you what happens.</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Tue Oct 05 2021 10:27:37 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">What I did is to comment out the call to saveCurrentStack over there: <a href="https://searchfox.org/mozilla-central/rev/75e9d727ce5ba2c14653cf8fb0f1367f085271b7/js/src/vm/SavedStacks.cpp#1894-1897">https://searchfox.org/mozilla-central/rev/75e9d727ce5ba2c14653cf8fb0f1367f085271b7/js/src/vm/SavedStacks.cpp#1894-1897</a></td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Tue Oct 05 2021 10:27:42 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I saw where you removed the whole <code>saveCurrentStack</code> call... yeah</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Tue Oct 05 2021 10:29:11 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'll be back in a bit</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Tue Oct 05 2021 10:43:11 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Oh! So. If I only remove <code>objects_.objectMetadataTable-&gt;add(cx, obj, metadata)</code>, the leak still reproduces. And it is still fixed if I minimizeMemory. So... at the end, it has nothing to do with this ObjectWeakMap!</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Tue Oct 05 2021 10:44:01 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Then, if I restore this code and only comment out <code>stacks.saveCurrentStack(cx, &amp;frame)</code>, the leak not longer reproduce, and I don't need to call minimizeMemory to fix the leak.</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Tue Oct 05 2021 10:45:13 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">I have no clue what "Cache IR" means. But could <code>saveCurrentStack</code> trigger some "Cache IR"-related code?</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Tue Oct 05 2021 10:45:13 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell"><a href="https://searchfox.org/mozilla-central/source/js/src/vm/SavedStacks.cpp#1296">https://searchfox.org/mozilla-central/source/js/src/vm/SavedStacks.cpp#1296</a></td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Tue Oct 05 2021 11:10:41 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Trying to stay out of the weeds: CacheIR is one of the ways that we generate code. The code that we generate can have edges to all sorts of things; as sfink said above, it's not surprising that CacheIR can reach a global. If we call the generated code, and it's still on the stack, then it's reachable and we can't free anything it reaches. We're generally pretty conservative about freeing CacheIR code; if it's able to make calls, I think we generally wait until we do a compacting GC and discard JIT code.</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Tue Oct 05 2021 11:11:43 GMT-0700 (Pacific Daylight Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">So it seems plausible to me that saving a stack would keep otherwise-dead CacheIR code alive, which would then keep other stuff alive</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Tue Oct 05 2021 11:15:50 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Thanks a lot for the super clear description. Everything suddently makes sense (even to me). And, the icing on the cake is that there is no more leaks!!</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Tue Oct 05 2021 11:16:02 GMT-0700 (Pacific Daylight Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Thanks <span class="nick-4">iain</span> and <span class="nick-12">sfink</span> for all the help!</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Tue Oct 05 2021 11:19:56 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">ochameau</span>: is that an adequate fix? You're ok with doing the <code>minimizeMemoryUsage</code> call? It's kind of heavyweight, and could add a noticeable pause. But given that you're already doing a heap traversal, I'm guessing it's ok. (We could add a lighter-weight API to do a more targeted cleanup if necessary.)</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Tue Oct 05 2021 11:23:46 GMT-0700 (Pacific Daylight Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">These leak scripts are super heavy and I'm still building them up. As we start using them we may try to do some polish like what you just suggested. But for now, it is totally fine!</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Tue Oct 05 2021 11:24:32 GMT-0700 (Pacific Daylight Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Having said that... I'm wondering if we should force some GC/minimizeMemory when closing the DevTools and may be also while they are running.</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Tue Oct 05 2021 11:24:39 GMT-0700 (Pacific Daylight Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">ok, cool. I don't know if you need to incorporate fancy logic around weakmap marking. Your tool showed correct paths, but it doesn't reveal that the first path would not have existed if not for the second path.</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Tue Oct 05 2021 11:25:17 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">Yes, I'll investigate that!</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Tue Oct 05 2021 11:25:40 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I mean, there's nothing incorrect now. It's more a question of whether it would be helpful to know the additional detail.</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Tue Oct 05 2021 11:26:42 GMT-0700 (Pacific Daylight Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">It actually makes sense, it would have helped me ignore the weakmap scenario and rather focus on the cache ir thing</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Tue Oct 05 2021 11:28:25 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">as for forcing a cleanup -- we have similar logic in the scheduling code for things like when you're running a series of tests. (We want to force a certain type of GC in between tests, again because a particular type of garbage tends to accumulate.) Optimally, these would all be notifications to the scheduler that something relevant to garbage quantities happened, and the scheduler would be super smart and do the right thing based on that. In practice, we can continue adding these types of manual cleanups where they're relevant.</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Tue Oct 05 2021 11:29:44 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">I'll keep that in mind, we are fixing many leaks in devtools. But in real world, the leaks may still be pending a GC that doesn't necessarily happen so frequently in production.</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Tue Oct 05 2021 11:30:01 GMT-0700 (Pacific Daylight Time)">18:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">right</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Tue Oct 05 2021 11:30:26 GMT-0700 (Pacific Daylight Time)">18:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@ochameau:mozilla.org">ochameau</span>&gt;</div></td><td class="msg-cell">I gtg, it is a bit late over here, but thanks again for the helpful chat!</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Tue Oct 05 2021 11:31:59 GMT-0700 (Pacific Daylight Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I'm glad it got resolved.</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Tue Oct 05 2021 14:16:55 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mgaudet:mozilla.org">mgaudet</span>&gt;</div></td><td class="msg-cell">confession: Ooof. Big style error in method naming is going to make me working through my patches a bit of a pain. C'est la vie </td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Tue Oct 05 2021 14:16:58 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell">Seen! Your update will eventually appear on <a href="https://robotzilla.github.io/histoire">https://robotzilla.github.io/histoire</a></td></tr>

</tbody></table></div></div></div>
</body></html>