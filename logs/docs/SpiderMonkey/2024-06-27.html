<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2024-06-27</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2024-06-27<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-06-26" class="nav-link"><span>prev</span></a>
<a href="2024-06-28" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Jun 27 2024 09:13:37 GMT-0700 (Pacific Daylight Time)">16:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I have a question about JS::Heap.  Suppose I try to trace a JS::Heap object after it has been garbage collected.  What would happen?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jun 27 2024 09:21:12 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">you mean a JS::Heap that points to an object that has been garbage collected? that's a use-after-free. It could crash or worse</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jun 27 2024 09:21:58 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, that's what I thought</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jun 27 2024 09:28:51 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jonco:mozilla.org">jonco</span>&gt;</div></td><td class="msg-cell">If you trace the JS::Heap its contents wont get garbage collected</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jun 27 2024 09:29:24 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">What if I want it collected eventually?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jun 27 2024 09:29:55 GMT-0700 (Pacific Daylight Time)">16:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@jandem:mozilla.org">jandem</span>&gt;</div></td><td class="msg-cell">you could clear it, set it to nullptr</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jun 27 2024 09:30:16 GMT-0700 (Pacific Daylight Time)">16:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK.  I also have a more general question: How is tracing different from rooting?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jun 27 2024 09:38:18 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">a rooted object cannot be collected. a traced object can be collected if no other live object traces it</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jun 27 2024 09:39:37 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> OK.  I also have a more general question: How is tracing different from rooting?</blockquote></mx-reply>Tracing starts from the set of rooted objects.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jun 27 2024 09:47:00 GMT-0700 (Pacific Daylight Time)">16:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">So a traced object is safe to use as long as it's somehow reachable from a root.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jun 27 2024 09:48:10 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So a traced object is safe to use as long as it's somehow reachable from a root.</blockquote></mx-reply>Yes. As long as the reference you have is something the GC knows about. The GC can move objects if you just have a random Foo* the GC doesn't know about.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jun 27 2024 09:49:26 GMT-0700 (Pacific Daylight Time)">16:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I suppose I'm wondering, if I have some data structure with a JS::Heap object that is traced, are there any guarantees on that object's lifetime?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jun 27 2024 09:52:22 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">if you have a data structure with a JS::Heap object, your data structure should trace the object somehow - that's how you guarantee its lifetime</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jun 27 2024 09:53:26 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">But the lifetime is only guaranteed as long as I maintain some roots, right?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jun 27 2024 09:53:27 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">in some exceptional cases, if your data structure doesn't trace the object and instead treats it as a weak pointer, you should be using <code>JS_UpdateWeakPointerAfterGC</code></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jun 27 2024 09:55:30 GMT-0700 (Pacific Daylight Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> But the lifetime is only guaranteed as long as I maintain some roots, right?</blockquote></mx-reply>well, if your data structure is itself traced from some other JS object, you'll know that it's reachable from a root. so normally, if you are accessing your <code>JS::Heap</code> member in a method of your data structure, you know it's live</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Jun 27 2024 09:56:24 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">if the lifetime of your data structure <em>isn't</em> tied to some JS object that can trace your data structure and through it your <code>JS::Heap</code> member, then you should probably be using <code>JS::PersistentRooted</code> instead</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Jun 27 2024 09:59:18 GMT-0700 (Pacific Daylight Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I'm trying to avoid cycles between persistent rooted objects</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Jun 27 2024 10:01:30 GMT-0700 (Pacific Daylight Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Suppose I have an object like the safebox in this example: <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr115/examples/tracing.cpp">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr115/examples/tracing.cpp</a></td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Jun 27 2024 10:02:53 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">This example only shows how to trace things indirectly by creating instances of Rooted.

Is there another way to trace objects starting at a different root?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Jun 27 2024 10:07:27 GMT-0700 (Pacific Daylight Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">not sure I understand the question - do you mean tie an object's or data structure's lifetime to that of another arbitrary object?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Jun 27 2024 10:09:23 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><p>If we look at this example, what is the lifetime of stackSafe after the function returns?</p>
<pre><code>static bool CustomTypeExample(JSContext* cx) {
  // If we use SafeBox as a stack object, then a JS::Rooted is enough.
  JS::Rooted&lt;SafeBox&gt; stackSafe(cx);

  // We can also use js::UniquePtr if SafeBox should be allocated on heap.
  JS::Rooted&lt;js::UniquePtr&lt;SafeBox&gt;&gt; heapSafe(cx, js::MakeUnique&lt;SafeBox&gt;());

  // NOTE: A JS::Rooted&lt;SafeBox*&gt; is a compile error. If one wanted to support
  // rooting bare non-GC pointers then both JS::MapTypeToRootKind and
  // JS::GCPolicy need to be defined for SafeBox*. This should be avoided in
  // favor of using a smart-pointer when possible.

  return true;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Jun 27 2024 10:10:30 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> not sure I understand the question - do you mean tie an object's or data structure's lifetime to that of another arbitrary object?</blockquote></mx-reply>Wait, yes.  I want to make sure that my object is alive as long as my global object is still alive.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Jun 27 2024 10:12:29 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>If we look at this example, what is the lifetime of stackSafe after the function returns?</p>
<pre><code>static bool CustomTypeExample(JSContext* cx) {
  // If we use SafeBox as a stack object, then a JS::Rooted is enough.
  JS::Rooted&lt;SafeBox&gt; stackSafe(cx);

  // We can also use js::UniquePtr if SafeBox should be allocated on heap.
  JS::Rooted&lt;js::UniquePtr&lt;SafeBox&gt;&gt; heapSafe(cx, js::MakeUnique&lt;SafeBox&gt;());

  // NOTE: A JS::Rooted&lt;SafeBox*&gt; is a compile error. If one wanted to support
  // rooting bare non-GC pointers then both JS::MapTypeToRootKind and
  // JS::GCPolicy need to be defined for SafeBox*. This should be avoided in
  // favor of using a smart-pointer when possible.

  return true;
}
</code></pre>
</blockquote></mx-reply>after the function returns, <code>stackSafe</code> is destructed, and its <code>JS::Heap</code> members are no longer traced, so they are eligible for collection</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Jun 27 2024 10:14:14 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">So is there a way to trace something without rooting it?  </td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Jun 27 2024 10:15:03 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Wait, yes.  I want to make sure that my object is alive as long as my global object is still alive.</blockquote></mx-reply>if you want to tie its lifetime to the global object, why not use <code>JS::PersistentRooted</code> and just tear down the PersistentRooted right before tearing down the global?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Jun 27 2024 10:16:16 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> if you want to tie its lifetime to the global object, why not use <code>JS::PersistentRooted</code> and just tear down the PersistentRooted right before tearing down the global?</blockquote></mx-reply>We end up in a situation where there are cycles between roots, and neither of them gets cleaned up.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Jun 27 2024 10:17:25 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">maybe you are looking for <code>JS_AddExtraGCRootsTracer</code> and <code>JS_RemoveExtraGCRootsTracer</code>? (this is pretty much equivalent to <code>JS::PersistentRooted</code> though)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Jun 27 2024 10:24:17 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you're adding a GC edge from A to B, and A's lifetime is managed by the GC, then you shouldn't use <code>PersistentRooted&lt;T&gt;</code> for the A-&gt;B edge. You should use <code>Heap&lt;T&gt;</code>, and then make sure that A has a <code>trace</code> method that traces the Heap.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Jun 27 2024 10:24:54 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> If you're adding a GC edge from A to B, and A's lifetime is managed by the GC, then you shouldn't use <code>PersistentRooted&lt;T&gt;</code> for the A-&gt;B edge. You should use <code>Heap&lt;T&gt;</code>, and then make sure that A has a <code>trace</code> method that traces the Heap.</blockquote></mx-reply>That's good.  But how do I go about calling trace?  Where do I get the JSTracer* ?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Jun 27 2024 10:25:21 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">How is A being kept alive in the first place?</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Jun 27 2024 10:26:19 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">In our case, A is kept alive by being captured in a lambda.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Jun 27 2024 10:27:39 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Okay, so you have an edge from some lambda L to A. Is L's lifetime also dependent on the GC?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Jun 27 2024 10:28:24 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I'm not sure about L's lifetime</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Jun 27 2024 10:29:01 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">The main question is: If I have A and I have B, how do I trace from A to B.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Jun 27 2024 10:32:48 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you can guarantee that L's lifetime doesn't depend on the GC, then you can store a PersistentRooted in L (or in some object associated with L). As long as that PersistentRooted stays alive, the object that it points at (A, in our running example) will be kept alive. When the PersistentRooted goes away, if there are no other paths from the outside world to A, then A will eventually be collected, even if there's an edge from B to A. Note that if there's a path from the outside world to B, then there's a path from the outside world to A that passes through B, so neither one would be collected.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Jun 27 2024 10:33:40 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If L's lifetime depends on the GC in some way, then you have a similar situation to A-&gt;B: you need to add a trace method to L, and you need to call that trace method from whatever owns L.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Jun 27 2024 10:34:00 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">OK, that's what I'm asking about.  How do I call a trace method?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Jun 27 2024 10:34:52 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You don't call a trace method directly. The GC calls it.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Jun 27 2024 10:35:27 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">in other words, you only call trace methods from inside other trace methods</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Jun 27 2024 10:35:35 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">like this <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr115/examples/tracing.cpp#L28-L35">https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/esr115/examples/tracing.cpp#L28-L35</a></td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Jun 27 2024 10:35:41 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, maybe that's a better way of putting it.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Jun 27 2024 10:36:21 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">or maybe not quite ðŸ˜„ you don't literally call <code>obj.trace()</code>, instead you call <code>JS::TraceEdge</code></td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Jun 27 2024 10:38:04 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Oh, so if I have some traced object, do I have to do all my tracing when the initial trace gets called?  I can't add stuff onto it later? </td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Jun 27 2024 10:39:02 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you have a Rooted or a PersistentRooted pointing at some object O, you are telling the GC that O is alive for as long as the Rooted is alive. If you have a trace method on O, you are telling the GC that <em>if</em> it determines O is alive, <em>then</em> here are some other things that are also alive.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Jun 27 2024 10:39:47 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The GC will call <code>trace</code> on an object each time it does a collection.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Jun 27 2024 10:41:55 GMT-0700 (Pacific Daylight Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For your purposes, you can pretend that all tracing happens at once, so there's no point after you have called <code>trace</code> on an object, but before the GC frees things. That's not technically true because of incremental tracing, but the GC goes to great lengths to pretend that it's true; that's part of what <code>Heap&lt;T&gt;</code> is doing for you.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Jun 27 2024 10:42:36 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">So let me get this right.  Tracing is called during the collection.  And it's like when the maintenance guy comes onto my patio and says "I'm gonna throw all this stuff away.  Just take the stuff that's yours and put it over there if you want to keep it."</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Jun 27 2024 10:43:17 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">excellent, I finally understand</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Jun 27 2024 10:44:18 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Assume that on your patio, there are strings between the things that you own. You can put a sticker on something to say "please don't throw this away, or anything that is connected to it via string". The stickers are roots. The trace method for each object tells you how to find the strings attached to that object.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Jun 27 2024 10:45:08 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:matrix.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Beautiful.  Excellent.  I understand now.</td></tr>

</tbody></table></div></div></div>
</body></html>