<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>SpiderMonkey on 2022-10-13</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "SpiderMonkey";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">SpiderMonkey<br>2022-10-13<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-10-12" class="nav-link"><span>prev</span></a>
<a href="2022-10-14" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Oct 12 2022 23:55:18 GMT-0700 (Pacific Daylight Time)">06:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">peterv</span>, <span class="nick-13">chunmin</span>, I'd have preferred a non-deep copy, this is what (currently) the spec says should happen, right? We can flag this to Chromium folks</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Oct 12 2022 23:55:49 GMT-0700 (Pacific Daylight Time)">06:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">then again maybe it isn't possible, and we'll have to adjust the text, I'll have to think more</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Oct 12 2022 23:57:15 GMT-0700 (Pacific Daylight Time)">06:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">padenot</span>: yeah, non-deep is how I read it ('assign the value of config[m] to clone[m]' isn't copying I think)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Oct 12 2022 23:57:30 GMT-0700 (Pacific Daylight Time)">06:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">padenot</span>: well, deep for dictionaries, but non-deep for BufferSource</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Oct 12 2022 23:57:59 GMT-0700 (Pacific Daylight Time)">06:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">right, the actual backing storage is merely referenced </td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Oct 12 2022 23:58:39 GMT-0700 (Pacific Daylight Time)">06:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">I'll open an issue on the spec and we'll chat, maybe there's a good reason they did it this way. the buffer isn't bit (a few dozen bytes maybe), but it's always nice to save a malloc/copy</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Oct 12 2022 23:59:29 GMT-0700 (Pacific Daylight Time)">06:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">padenot</span>: note that if that BufferSource is exposed later then it might be possible to mutate those BufferSources, I don't know if that's possible but it might be weird if so</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Oct 13 2022 00:00:06 GMT-0700 (Pacific Daylight Time)">07:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">either way, opening an issue seems best, since test and spec are not in sync</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Oct 13 2022 00:00:23 GMT-0700 (Pacific Daylight Time)">07:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@padenot:mozilla.org">padenot</span>&gt;</div></td><td class="msg-cell">yeah, it is exposed later, but really a developer shouldn't mutate it. it's one of those case where we really need non-mutable arraybuffers in js</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Oct 13 2022 00:01:15 GMT-0700 (Pacific Daylight Time)">07:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">ðŸ™‚</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Oct 13 2022 00:01:44 GMT-0700 (Pacific Daylight Time)">07:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">FrozenArrayBuffer</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Oct 13 2022 10:02:08 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@chunmin:mozilla.org">chunmin</span>&gt;</div></td><td class="msg-cell">Is it possible to cast a BufferSource to a FrozenArray&lt;Byte&gt;? FrozenArray&lt;Byte&gt; might be a better type to be exposed later. It should be immutable: <a href="https://webidl.spec.whatwg.org/#idl-frozen-array">https://webidl.spec.whatwg.org/#idl-frozen-array</a></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Oct 13 2022 10:09:56 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@sfink:mozilla.org">sfink</span>&gt;</div></td><td class="msg-cell">I don't think that exists. See bug 1236777.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Oct 13 2022 10:09:58 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@botzilla:mozilla.org">botzilla</span>&gt;</div></td><td class="msg-cell"><a href="https://bugzil.la/1236777">https://bugzil.la/1236777</a> â€” NEW (nobody) â€” Implement FrozenArray in webidl</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Oct 13 2022 10:15:50 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">yeah, but we have workarounds for now</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Oct 13 2022 10:16:14 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">but "casting" one to the other isn't possible</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Oct 13 2022 10:16:39 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">you can copy</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Oct 13 2022 10:16:57 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@chunmin:mozilla.org">chunmin</span>&gt;</div></td><td class="msg-cell">We can use [Frozen] flag, but it seems it only works for attribute, not a dictionary member: <a href="https://firefox-source-docs.mozilla.org/dom/webIdlBindings/index.html#frozen">https://firefox-source-docs.mozilla.org/dom/webIdlBindings/index.html#frozen</a></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Oct 13 2022 10:17:23 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">which spec is this?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Oct 13 2022 10:17:24 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@chunmin:mozilla.org">chunmin</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> you can copy</blockquote></mx-reply>Then we still have a copy</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Oct 13 2022 10:17:36 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@chunmin:mozilla.org">chunmin</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-webidl">dictionary VideoDecoderConfig {
  ...
  BufferSource description;
  ...
};
</code></pre>
<p><a href="https://w3c.github.io/webcodecs/#dictdef-videodecoderconfig">https://w3c.github.io/webcodecs/#dictdef-videodecoderconfig</a></p>
</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Oct 13 2022 10:17:53 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@pvanderbeken:mozilla.org">peterv</span>&gt;</div></td><td class="msg-cell">well, if the incoming is an ArrayBuffer and you want an immutable version of it you have to copy</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Oct 13 2022 11:21:48 GMT-0700 (Pacific Daylight Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">What's the best practice when passing JS objects/values to a lambda?  IO know we use Rooted for stack local variables, and Handles for function parameters.  How should I go about capturing one in a lambda?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Oct 13 2022 11:26:46 GMT-0700 (Pacific Daylight Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">btw, This lambda will be invoked asynchronously at some later time</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Oct 13 2022 11:27:01 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Is it even possible to get a reference to a JS object that could persist in this way?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Oct 13 2022 11:49:51 GMT-0700 (Pacific Daylight Time)">18:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">kfjvj</span>: Like a C++ lambda? My first instinct is that it sounds like a bad idea.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Oct 13 2022 11:51:14 GMT-0700 (Pacific Daylight Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you want something allocated on the heap, you should be using <a href="https://searchfox.org/mozilla-central/source/js/public/RootingAPI.h#302">Heap&lt;T&gt;</a> instead</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Oct 13 2022 11:52:19 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">But <code>Heap&lt;T&gt;</code> needs to be traced when the containing object is traced, which means that you'd need a trace method on your lambda</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Oct 13 2022 11:53:57 GMT-0700 (Pacific Daylight Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">And I'm not aware of a way to do that in C++</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Oct 13 2022 11:55:02 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Basically, there needs to be some path from a root to the <code>Heap&lt;T&gt;</code> that the GC can trace to determine that the object you're holding is still alive (and update your pointer if the GC moves it)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Oct 13 2022 11:56:29 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">If you have lambdas floating around with arbitrary lifetimes, that's hard to manage.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Oct 13 2022 12:01:16 GMT-0700 (Pacific Daylight Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I suppose I'll have to find some other way to do it</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Oct 13 2022 12:01:52 GMT-0700 (Pacific Daylight Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">I dunno if it is a "good idea" but there's at least one place we use PersistentRooted on the heap. <a href="https://searchfox.org/mozilla-central/rev/76ccfc801e6b736c844cde3fddeab7a748fc8515/xpcom/base/JSObjectHolder.h#37">https://searchfox.org/mozilla-central/rev/76ccfc801e6b736c844cde3fddeab7a748fc8515/xpcom/base/JSObjectHolder.h#37</a></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Oct 13 2022 12:02:29 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">It does look like that is used in a number of places on the heap, judging by the mFoo names. <a href="https://searchfox.org/mozilla-central/search?q=symbol:T_JS%3A%3APersistentRooted&amp;redirect=false">https://searchfox.org/mozilla-central/search?q=symbol:T_JS%3A%3APersistentRooted&amp;redirect=false</a></td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Oct 13 2022 12:02:55 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">Thanks.  I'll look into those.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Oct 13 2022 12:03:39 GMT-0700 (Pacific Daylight Time)">19:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">the comment does say "These roots can be used in heap-allocated data structures"</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Oct 13 2022 12:04:13 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@mccr8:mozilla.org">mccr8</span>&gt;</div></td><td class="msg-cell">Just be careful not to create a cycle by indirectly keeping the lambda alive from JS.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Oct 13 2022 12:04:37 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">ok, I'll keep that in mind</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Oct 13 2022 12:18:56 GMT-0700 (Pacific Daylight Time)">19:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: I'm looking into Heap&lt;T&gt;, and the documentation references tracing, but I'm not sure how tracing is supposed to work.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Oct 13 2022 12:23:08 GMT-0700 (Pacific Daylight Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell">I suppose I could still use PersistentRooted, but somehow I'm scared of it</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Oct 13 2022 12:27:37 GMT-0700 (Pacific Daylight Time)">19:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@kfjvj:mozilla.org">kfjvj</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-4">iain</span>: I'm looking into Heap&lt;T&gt;, and the documentation references tracing, but I'm not sure how tracing is supposed to work.</blockquote></mx-reply>Never mind, I found some info about it in the rooting guide.</td></tr>

</tbody></table></div></div></div>
</body></html>